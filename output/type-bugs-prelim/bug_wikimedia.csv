change filter to the actual real name: bot_passwords	" plural		bug: t135074	change-id: ifb894a24cd5803304b8b972f8d93cf80d44b9f8e	|add bot_password as a private table		bug: t135074	change-id: i0a0e3a331c2ed0c810cfb73ad8a4882e24535ecf	|set oathauth_users as a private table		bug: t130700	change-id: i70398cc6bedddead06477d091e5855ffca9d75c6	|remove $site_tier"	" no longer used		bug: t127481	change-id: i4ec5c26bf701d03eb397fcd0523b9997c6995057	|add echo tables to the list of private tables		bug: t125591	change-id: iaad18d570c4386bacfe5f5e9fc473eb6bb82a4c1	|allow hiera to override $::labsproject		previously $::labsproject came directly from a fact.  now	we check hiera first"	" and if it's undefined fall back	on a fact"	" now named $::labsprojectfrommetadata		bug: t95185	change-id: i2811d2ba6a7263ac2b380c6f2bc355501f753fcc	|labs: set realm in hiera		this allows us to get rid of it from ldap variable lists		bug: t101447	change-id: i176a97bf74252a55037a5a575c0572f08410eb0a	|exim: add and use $::other_site to provide ldap fallback		exim supports a list as an argument to the ldap_default_servers	argument. we use this to provide a fallback for when the dc-local corp	ldap mirror fails. for this to work"	" we need a mapping though of dcs to	their fallbacks. introduce the $other_site variable to provide this	functionality		bug: t82662	change-id: i68d77bf4bf17dbf782a36aad382f13f601c7d50f	|replicate pt-heartbeat table to labs. stop replicating msg_resource		the heartbeat database was filtered on sanitarium. i have applied	manually this changes to allow the pt-heartbeat table (heartbeat.	heartbeat) to reach sanitarium. i have also allowed it on labs.		i have changed other configuration changes"	" like increasing the	max_allowed_package"	 activating the buffer_pool dump feature	"	and i have set msg_resource as a private table.		this requires a followup change on labs to fix the script that	creates the views on labs- creating a custom view for heartbeat	and deleting the one for msg_resource.		bug: t116720	bug: t71463	change-id: idd65d4cc18f43a35c6d2bfa24560f3d271279724	references: t114752	|add labs-recursor1 as a secondary nameserver for labs instances.		bug: t106142	change-id: i23bc2283027632bd7cbf2c0d9c6719b530832a9c	|switch codfw to tier2		bug: t110065	change-id: i46a9eb856dda3523c3a78c8e7a7f170ad8576434	|add a labsproject fact that doesn't rely on ldap config.		bug: t93684	change-id: if6815494038a4c5173ca1d484f68c7e5c3c5ecd2	|fix incorrect beta mx hostname		bug: t75736	change-id: i9081ce7eabfe1b25c6bd4e91a45615d4fab6920a	|prepare to replicate additional tables to labsdb (with legal ok):		user_daily_contribs bug 61300	user_properties     bug 64115 (filtered)	filearchive         bug 57697 58993 (anonymized)		change-id: i1ffc55e05c6e8ed59a48111ce5f7f5c43f5c71b2	|"																																																																																																																																																																																																																																																																																																																																																											
"apertium: remove jenkins_access class		apertium is deployed as deb packages"	" not via jenkins		bug: t86644	change-id: i0887da03725fbfb829e7189d633379fbd2246e1f	|apertium: unify production and beta roles		also remove sudo rule to let jenkins-deploy restart apertium.	this can be handled in wikitech now		bug: t86633	change-id: i0b5dcc76b002b7e9fad6add180ddde1a8102b8d7	|beta: drop log_dir for apertium		drop $log_dir as it is not needed. also fixed reference to old bugzilla.		change-id: i2d3b857cdaa8de86dc93dbe438d4c2fc798ef30a	|add apertium role for production		create the apertium role for production similar to beta for apertium.		in addition this role has"	"	* added monitoring for port 2737"	"	* removed jenkins-deploy reload part"	"	* dropped log_dir in production.		bug: t78629	change-id: ic7419a9cb99e4436db96117a803f94d578e79f32	|"																																																																																																																																																																																																																																																																																																																																																															
"move the include of cassandra/aqs passwords up to solve a priority issue		bug: t142073	change-id: i925cc4564023d6cdd69b4ba6288a762e7236a0d8	|include the password::aqs namespace in the aqs role		bug: t142073	change-id: i0d84b01b51c04d7eb03596adfbfa84f5eb465ee9	|include a cassandra::instance::monitoring class		in order to follow the single responsability	principle"	" it could be great to externalize the	monitoring setup from the general cassandra	setup. this is the next step to include the	monitoring setup in all the calls to ::cassandra		bug: t137422		change-id: i9177f9797bfb5a13696fa3ad2b9af5264def5513	|remove old and redundant aqs specific alarms.		from https://gerrit.wikimedia.org/r/#/c/250439 it seems that	cassandra already offers basic cql checks/alerts	(that are multi-instance aware). i don't see a huge value in having	java process checks since cql ones should be already enough for	alarming.		bug: t135145	change-id: i97fc114c7968f338f2d2f162e7090f8549607145	|aqs: separate aqs off of restbase		for a first deploy"	 we tied aqs to use restbase's class. however	" now	that the restbase class simply uses service::node"	" there is no need to	have aqq point to restbase.		add analytics/aqs/deploy to trebuchet's deployment.yaml to bootstrap	aqs/deploy clone on tin		bug: t126294	change-id: i65758cf23926a0463e058f118e3192411d120dec	|restbase: make the port fully configurable and change for aqs to 7232		there are some places where we make the assumption of restbase running	on port 7231. however"	 with the introduction of aqs	" we need to be able	to fully configure it"	" as they both can't have the same port due to lvs.		also: conftool-data/services/services.yaml defined zotero's port as 7231	for some reason. this patch changes it to 1969.		bug: t116245	change-id: ibaecb8f6ee5491362100fe32be2b65d755032b27	|aqs: allow cql access from analytics		allow analytics machines to push data to aqs cassandra		bug: t107056	change-id: i222fe054a3bd1d2750eb06484726782534c358be	|"																																																																																																																																																																																																																																																																																																																																																												
"set up https with archiva certificate for archiva.wikmedia.org		- this adds a simple generic nginx site to force all non https traffic on port 80 to https.	- this also points our maven module archiva urls at https://archiva.wikimedia.org		bug: t88139	change-id: i3bfff6e632e0d5c26d710d8ab69dcc4d1ee8f3a1	|"																																																																																																																																																																																																																																																																																																																																																																			
"add an authdns module & associated role classes		this adds an authdns module. the module is an uncommon for our tree	mixture of a role module"	" a package replacement (scripts) and internal	logic to handle the configuration of the authdns cluster. it serves as a	replacement to both dns.pp's authdns parts and the	wikimedia-task-dns-auth package"	" although both are significantly	rewritten.		a gdnsd module is not provided here"	" as the software is simple enough to	not warrant it (a single package & service definition).		this also adds role classes for each of ns0/ns1/ns2 (with their current	ips) and a testns class for playing with in labs. these are all unused	for now.		this is the initial work. pending work includes adding ipv6 addresses"	"	switching to the commercial geoip databases and providing scripts for ci	integration. plus"	" bug fixes :)		change-id: ice119ead68bd7cb5a232f31c778b03791a917012	|"																																																																																																																																																																																																																																																																																																																																																														
"configurable `vm.dirty_background_bytes` parameter		creates a cassandra-specific mechanism for assigning a value to	`vm.dirty_background_bytes`"	" and sets the parameter to 24mb on the restbase	cassandra clusters.		since this is essentially a host-wide way of accomplishing what `trickle_fsync`	does"	" this changeset also disables `trickle_fsync` for the restbase cassandra	clusters.		bug: t140825	change-id: i1c47ac91e6e3c3edf99a5b65228804c8836f11c3	|include a cassandra::instance::monitoring class		in order to follow the single responsability	principle"	" it could be great to externalize the	monitoring setup from the general cassandra	setup. this is the next step to include the	monitoring setup in all the calls to ::cassandra		bug: t137422		change-id: i9177f9797bfb5a13696fa3ad2b9af5264def5513	|cassandra: multi-instance aware cql checks		install multiple check_tcp checks"	" one for each cassandra instance		bug: t93886	change-id: if41939c44a51d3d603d0058c26598e7e3a2b14d3	|cassandra: provision restbase user/password		bug: t92590	change-id: i6a1a294a270c768d0daf8825785fc91e2fcaa111	|cassandra: enable ssl_storage_port (7001) in ferm		bug: t108953	change-id: i8875c25c0cab5b5e2060caf732906f1d5da95ba7	|cassandra: remove obsolete diamond collector		the collector has been obsoleted by an alternative metrics collectors using jmx		bug: t78514	change-id: i086ee6950a48025445e373099006c4f13389c11e	|cassandra logstash setup		- sets up a logstash udp input that uses the json codec on port 11514	- deploys logstash-logback-encoder artifacts on cassandra hosts	- configures cassandra to use udp appender		bug: t100970	change-id: idc5cfc8c5b53e8dac88dbed9e506eee79568903e	|cassandra: add team-services for cql failure		bug: t104467	change-id: i149d6c601f3e15b5d4025fb2cba5caca278d4a56	|cassandra: enable diamond collector		bug: t78514	change-id: i7c6981a1c6d5b79cdeac94cc6a95c06e916bc4ef	|cassandra: add ferm rules using hiera data 		adding ferm rules for the cassandra ports to allow connections	only from (other) restbase servers.		gets the list of cassandra host names from hiera"	" then uses @resolve in ferm	to perform a dns lookup and convert them to ips for use in the srange.		bug:t92680	change-id: i7d077c92641f356d51f59c5749427e53ab1ef453	|cassandra: add monitoring for cql interface		use icinga to check if port 9042/tcp is open.	this is cassandra's cql query interface.		bug:t93886	change-id: ia96346a8974e4a30b1d299340cd3aaca38e4263a	|cassandra: add cassandra::metrics class and deps		see also related commits in cassandra submodule		bug: t78514	change-id: i6600609237a4e5635409fb2a944a7572691bcc69	|"																																																																																																																																																																																																																																																																																																																																																														
"kafka config: add config functions		up until now"	" kafka configuration has been held in	role::kafka::(main|analytics)::config"	" which are mostly copy/pastes of	each other. this patch consolidates them by introducing two functions:	kafka_config and kafka_cluster_name"	" the former using the latter. this	allows us to elegantly get the config by simply using the cluster prefix	we are interested in:		  $analytics_conf = kafka_config('analytics')	  $main_conf      = kafka_config('main')		bug: t130371	change-id: i206b54d10e8188e7775d3f6621c8d4cc60e0d269	|introducing changeprop role and puppet module		bug: t128463	change-id: ib61a839fb670bda3dc27b4499e48a9eb452f4d0f	|"																																																																																																																																																																																																																																																																																																																																																																
"add a generic node service module		service::node is a generic puppet resource that allows node.js services to be	easily set up on the sca cluster. since all such services are set up in	the exact same way"	" most of the code can be shared between them. the	only specific parameters are a service's port and own configuration	directives. the other parameters of service are controlled by	role::sca's hiera.		as an example"	" role::citoid has been converted to using service::node	instead of its own citoid module.		bug: t95533	change-id: ic6c9d4f8d0b086b94d167fd9449377a87734456b	|citoid: unify production and beta roles		bug: t86633	change-id: i6fabdcc58c2fd80c7215a68f311ba4d23c31d650	|"																																																																																																																																																																																																																																																																																																																																																																	
"remove (almost) all references to db1058 on puppet		only leaving coredb.pp"	 marked as deprecated	" because it will be	soon deleted completelly.		bug: t134360	change-id: ia6e99a869dfdb1e0bad1a3064e1fb37e85538689	|db: expose puppet ssl certs and generate ca cert		- updated reference to the mariadb submodule	- expose puppet ssl certs for old coredb::common role still in use		bug: t111654	change-id: i6b3592250fe1bf99278a3a446df3088b0d451535	|lint: indentation fixes in roles		all of these fix a:		warning: indentation of => is not properly aligned		one more step towards being able to re-enable that check again.		bug:t93645	change-id: i6a49e08dfe220eefc24096b0da201eb214caddf1	|"																																																																																																																																																																																																																																																																																																																																																																	
"service-runner migration for cxserver		bug: t117657	depends: ia5e0950b314f54e10e50230af9a3761be6a8ee0a	change-id: i72f84ec489686cd38f22dbfc150ec12f1d8dcf87	|cxserver: add jwt token support		bug: t116134	change-id: i338070364e5b723274c9627bfae42a1975011a9a	|cxserver: add yandex support		* added yandex proxy support.	* yandex support conditional based on value of yandex_url	* proxy support conditional	* english - russian mt with yandex provider	* do not enable in production"	" but rather only on beta		bug: t88512	change-id: i6e76d289fd85adcb396361b07a8dd4d2c1b6eb5b	|cxserver: use different registry for beta and production		we need ""stable"" environment for user testing of new language pairs"	" which is	beta cluster. configuration need to be different for it from production for	language pairs registry (languages"	" mt and dictionary providers).		registry format will be quite simple in future"	" and also diff between beta	cluster and production will be kept minimum as possible.		bug: t88793	change-id: i98b13b3f484271ae613324960b87e8188b4ec69c	|cxserver: unify production and beta roles		bug: t86633	change-id: i74ee57e9e10aac2f7df7c3c09052afbaf901e4d0	|add cxserver role for production		create the cxserver role for production similar to beta for cxserver and	mostly based on mathoid. in addition this role has"	"		* log_dir is /var/log/cxserver"	"	* no jenkins/contint includes"	"	* added monitoring for port 8080"	"	* fixed description.		bug: t78629	change-id: if30737aa255ef8eeb7b51a865abef405086a9c97	|"																																																																																																																																																																																																																																																																																																																																																											
"manifests/role/dns: fix indentation of =>		bug: t93645	change-id: i3ad66a427f3c4e5bcaa6545eba032ac8fe8df585	|purge labs dns/ldap code		we aren't using this anymore; everything is in pdns/mysql/designate.		bug:  t126758	change-id: ic184b8561fd4ae1aa1f22ee3469e3f2eacbae9c5	|lint: indentation fixes in roles		all of these fix a:		warning: indentation of => is not properly aligned		one more step towards being able to re-enable that check again.		bug:t93645	change-id: i6a49e08dfe220eefc24096b0da201eb214caddf1	|"																																																																																																																																																																																																																																																																																																																																																																			
"dumps: add cert expiry check		adds an icinga check for certificate expiry	of dumps.wikimedia.org.		bug:t114059	change-id: iac6b7533e87664e1966afdea03a387e2a079a1eb	|add missing ferm rules		bug: 105040	change-id: ia009343eb2c727629a43fac877cb4cdde19dd9e4	|zim: add missing ferm rule		bug: t105040		the nginx configuration /etc/nginx/sites-available/dumps listens on	80 and 443.		change-id: ia620e4e8f6edca3c004df829c8df11a61b4cc3c6	|dumps::zim: open port 80 for http connections		node 'francium' has base::firewall and connections to port 80	must be allowed"	 at least from the dumps hosts	" who proxy to this.		it has a private ip though so external clients already can't access it.	want me to limit it to _only_ dataset1001 nevertheless?		bug:t94457	change-id: ic5e12fd3fcb130df9186823c1a1144d820e928bb	|dumps: add classes for zim dumps"	" add imagemagick		from t94457 we already now that zim dumps will require imagemagick and	other things.		start with creating the role class and a new manifest that installs imagemagick.		bug:t94457	change-id: ibf58366c3e6e25f21184d9fa60b84b739bd0ce03	|"																																																																																																																																																																																																																																																																																																																																																																
etcd: perform backups to /srv/backups/etcd	" bacula		bug: t135129	change-id: id38d91317213c764183ae901414fad6b5cc875db	|etcd: create puppet module		this also creates the puppet role so that it is directly usable in production		bug: t97973	change-id: ib80e3d3c3e46f9ff0b81c5dd675ce79184324576	|"																																																																																																																																																																																																																																																																																																																																																																		
"add the logrotate delaycompress setting everywhere		this is a proposal to fix the annoying daily cronspam:		/etc/cron.daily/logrotate:	gzip: stdin: file size changed while zipping		from the man of delaycompress:		""postpone the compression of the previous log file to the next rotation cycle.	 this only has effect when used in combination with compress.	 it can be used when some program cannot be told to close its logfile	 and thus might continue writing to the previous log file for some time.""		it seems to be a non invasive solution"	" but i am open to suggestions.	a better and more elegant step would be to refactor all the classes to	use the proper logrotate class"	" in order to have only one single template	for logrotation"	" but it could be difficult as first step. the solution	proposed should solve the immediate problem setting a baseline also for	future copy/paste of the logrotate files.		i have also added ""compress"" where it was present only ""delaycompress"".		bug: t132324	change-id: ib9ae51989d8de215072539d45034d83b3a68b540	|increase retries for eventlogging analytics processor kafka producers		bug: t141285	change-id: iedf0d8664a2c438899043f573daf072b4d86cf87	|hieraize kafka handler for eventlogging analytics"	" select appropriate auto_offset_reset		bug: t133779	change-id: ic747dfe8ea06fecfd08054ec1301add160489ed0	|kafka config: add config functions		up until now"	" kafka configuration has been held in	role::kafka::(main|analytics)::config"	" which are mostly copy/pastes of	each other. this patch consolidates them by introducing two functions:	kafka_config and kafka_cluster_name"	" the former using the latter. this	allows us to elegantly get the config by simply using the cluster prefix	we are interested in:		  $analytics_conf = kafka_config('analytics')	  $main_conf      = kafka_config('main')		bug: t130371	change-id: i206b54d10e8188e7775d3f6621c8d4cc60e0d269	|eventlogging::service::* classes now depend but don't include eventlogging::server		this is so the path to eventlogging source code can be configured per deployment	target.  this should be a no-op on eventlog1001.		bug: t118772	change-id: i55600577a534161781833b6fa7fc51a423066482	|create new eventlogging::analytics role in modules/role"	" use scap for deployment		this is only the deployment of a new cloned repo to eventlog1001"	" it does not affect	the running deployment or daemons.		bug: t118772	change-id: ib37ec5a3aba1a9e018a700d4271b4930d4dc5472	|eventlogging: remove server-side udp to kafka forwarder		bug: t129402	change-id: i0db636c30cd1354a04c2ab8550db5f236df49f9b	|remove etcd usage from eventlogging processor		this is no longer supported"	" clientips are no longer collected so they don't need hashed		bug: t128407	change-id: ia6dae7c81c63dc54b61f35e97f1aab3ff0c63834	|logrotate: convert eventlogging-files to logrotate::conf		bug: t127025	change-id: ibaa1fb91a0421cc6b68fe74c7dde01ef8bd9ae21	|add ferm rules for eventlogging udp receiver		bug: t113343	change-id: ie398a659af307728a67b44875a0c231007411798	|temporarily disable eventlogging mysql consumers and burrow monitoring for them		bug: t120187	change-id: i1b36fa55f39d5c44d7aa40247d96aa3d45666ade	|eventlogging role now uses new kafka analytics role		bug: t121659	change-id: i91df946dd59d49f4d0a3242d993e12a486f60d12	|puppetize eventlogging-service with systemd in role::eventbus		deployment via scap3.		this patch works in beta.  there is still work to be done"	"	but the patch is getting too large.  further work	will proceeed in new changes.		no changes on eventlog1001 according to	https://integration.wikimedia.org/ci/job/operations-puppet-catalog-compiler/1506/		todo: move role::eventbus::eventbus back to role::eventbus when t119042 works.	todo: use role::kafka::* to get kafka config.		bug: t118780	change-id: i621de844ed7a5bd1ac532b52058925350d9e5337	|eventlogging: use the system-wide puppet ca		bug: t114638	change-id: i63908eb3d9fc2d639e38c07a4716faabd59f1593	|use ca_cert for etcd client in eventlogging processor		bug: t112688	change-id: i01e285a2065083857d68c3163f56d7746b34e938	|fix eventlogging ssl paths for etcd		bug: t112688	change-id: iea496d11ceab4fdcc0aceaf4f91abee00b47fd1c	|parameterize owner"	" group and modes for etcd::ssl::base files		this allows places that do not have the etcd package installed to	use this class.		bug: t112688	change-id: id95d69c86ca482916d6a40aa0642bdec2eec1880	|puppetize etcd use for eventlogging processor		this will allow eventlogging to consistently hash client ips even	when parallelized.		requires that https://gerrit.wikimedia.org/r/#/c/238854/ is deployed.		this change also adds a provide_private parameter to etcd::ssl so that	the class can be used for etcd clients"	" not just etcd servers.		bug: t112688	change-id: i8ba49df87b4edb080d3e4786b4f884a61ef003e6	|rsync:  unquote booleans		bug: t113783	change-id: i80362002e2f665daac829bfef959714f09c5c3e8	|set replace=true for eventlogging mysql consumer		duplicate key errors are more likely now that consumers can start from	previously committed offsets in kafka.  this will make mysql	ignore duplicate key errors while inserting.		bug: t112265	change-id: i56ce55b4d5295dc21321de11a739b172ff641be3	|parallelize 12 eventlogging client side processors on eventlog1001		bug: t104228	change-id: i16b8ad57baca9f6c0899e57dc33c165c6434a68a	|turn off varnishncsa udp logging for eventlogging		bug: t106260	change-id: ic2ed59f60fe6885d79998fe4a0ef1a7c970d1f29	|remove eventlogging multiplexer"	" forward kafka eventlogging events to zmq port 8600		this consumes from kafka eventlogging-valid-mixed and forwards all events there	to the zmq port 8600 for backwards compatiblity.  once all perf teams use kafka"	"	we can turn off this service.		bug: t106260	bug: t110903	change-id: i55a9014fa360e6ac83a764254bd2e65eacd17677	|make eventlogging mysql consumer consume from kafka instead of zmq		bug: t106260	change-id: i6d52963ce4c837ed46e4e018fef462e18aafc7b3	|make eventlogging files consumer consume from kafka instead of zmq		bug: t106260	change-id: ic49259856175d506547799a0a323caee2c88ca49	|remove eventlogging zmq based monitoring		all metrics are now obtainable via kafka jmx		bug: t106254	change-id: iebab33c929cbb769a3133143702040586e3ce231	|make eventlogging server side processor consume from and produce to kafka		this keeps the 0mq server side valid stream in place for now.		bug: t106260	change-id: i94e769c3f8fd5b39bc353da9b869e7b167672d50	|puppetize eventlogging on kafka server-side-forwarder on eventlog1001		remove this forwarder from analytics1010		bug: t106260	change-id: iacb8e92b846b3414589d57ba55b1bf88eaae3808	|set up varnishkafka instance on cache servers to log raw client side events to kafka		this will soon fully deprecate the udp based varnishncsa instance"	" allow us	to turn off the eventlogging client side udp -> zmq forwarder.		bug: t106255		change-id: i470e37575fae87cd85665af88c7212229e68b16b	|puppetize multiple kafka eventlogging processors on analytics1010		bug: t104228	change-id: i9c9514e5461e3c34c608fb0543b1a3f7a21df836	|make statsd host configurable via hiera		bug: t110462	change-id: i68c7546e8298646abad844a26c341176f75eb8d6	|[wip] eventlogging: add statsd_host param to the mysql consumer url		see https://gerrit.wikimedia.org/r/#/c/229631/ for details.		bug: t105935	change-id: ic1bb3599e6e567f4a6bd181ea2cbdd6ca4d3cdf0	|configure eventlogging kafka forwarder and processor		these are still in separate classes and will not affect eventlog1001		also fix forwarder and processor erb templates to work with	https://gerrit.wikimedia.org/r/#/c/221155		bug: t102831	change-id: i002776bb39c98757bc0ad478939ee96a268af4dd	|set up disk full alerts for eventlogging that will notify the analytics contact group		bug: t95154	change-id: i5e8a03e1b360b5f69420fa5600e7e7fc90514285	|use eventlog1001 as main eventlogging host instead of vanadium		for this most part"	" this patch just does s/vanadium/eventlog1001/g.	it also configures a new varnishncsa instance on bits caches called	'eventlogging'"	" rather than 'vanadium'.  i have ensured that the	vanadium instnaces will be stopped"	" and the new eventlogging instances	will send to eventlog1001.  once this is applied"	" i will	manually remove the vanadium named instances and puppet configs.		bug: t90363	change-id: i2d0fc3d0a629f2bc75ef209ff2a51324893a9677	|make role::eventlogging realm-aware		the server-side eventlogging setup is currently running on labs instance	'deployment-eventlogging'"	" but it is not completely puppetized. this patch	changes several hard-coded addresses to variables which are assigned a value on	the basis of realm.		some acknowledged quirks:		- the value of $mongo_host is assigned on the basis of realm"	" but the values	  for production and labs are the same. this was done in anticipation of the	  mongodb instance on vanadium eventually moving to a different server.	- when that happens"	" i'll also move the mongodb class instantiation elsewhere.	- $::realm selectors do not specify a default case. i don't see the point in	  littering the repo with fail()s over 'realm' being set to something other	  than labs / production / fundraising. custom errors are only needed when the	  error is relative to the idiosyncratic expectations / usage of the particular	  class"	" imo.		bug: 49723	change-id: ifc11e5dc39333d70020150b86ba892575f0e39b1	|"																																																																																																																																																																																																																																																																																																																																											
"add extdist module + role for labs		the extdist role sets up a tarball generator for use	with the extension distributor extension on mediawiki.org	running from labs.		the module can"	 in the future	" be potentially used on prod.		bug: 68609	change-id: i63d285612bd30d24b83718c4c8967144d146afeb	|"																																																																																																																																																																																																																																																																																																																																																																	
"ganeti module/role introduced		a module for handling ganeti clusters. includes code to handle kvm	installation and ksm configuration"	 ganeti node handling	" lvm	configuration"	" drbd installation as well as some useful puppet facts and	scripts. the facts have no actual use right now but are going to be	useful in the near future. tests for the module are provided and are	passing.	role class is included as well providing firewall"	 monitoring	" key handling		bug: t87258	change-id: i337dd68ec404a2e15ea40358436e177a9a168c3e	|"																																																																																																																																																																																																																																																																																																																																																														
"graphoid: service deployment on sca		this patch introduces the role::graphoid and graphoid classes"	"	responsable for deploying graphoid on the sca cluster"	" together with its	configuration. concretely"	" the graphoid class installs the package	dependencies and uses service::node to create the rest. hiera is	configured so that graphoid works both in production and	deployment-prep.		bug: t90487	change-id: i1d3edad9f5df5b3a9ea9443411f228fd24e74ed0	|"																																																																																																																																																																																																																																																																																																																																																																
"fix ferm port 80 for californium/gallium		bug: t137106	change-id: ib09c9ae18d255f3b09714c58c5d6880c891b4fe8	|add wmflabsdotorg credentials to horizon config		bug: t129245	change-id: i9fce4c30d008aaf2361a973036ab279a71244fad	|"																																																																																																																																																																																																																																																																																																																																																																			
elasticsearch - check shards via the service	" not via each individual node		checking cluster state on each node is redundant and generate a lot of noise.	cluster wide checks are now done on the service only.		the logstash cluster is left unchanged as it does not have lvs.		the relforge cluster is at the moment left unmonitored. this will be	fixed once a cleanup of the different elasticsearch roles is done (see	https://gerrit.wikimedia.org/r/#/c/304067/).		bug: t133844	change-id: ica721152c10d777003726e80fa03ed82c69c8a10	|varnish: git.wm.org to iridium"	" remove related config/tests/monitoring		this changes the backend to iridium so that the rewrites from git.w.o to	phabricator.w.o can be on the same host as phabricator.		this is also removing config and tests that was specifically for gitblit and	should not be needed anymore. it removes the monitoring for git.w.o as	phabricator is already monitored.		bug:t137224	depends-on: i67ad308f9e6373e5234cb2d83006457d6f467bf8	change-id: id8dad592e3f16736bc8eb0d6806be1b53feb94fe	|add icinga monitoring for content on commons		add a virtual host for commons.wm.org to icinga.		add a check that"	 besides the https(!) connection	"	also looks at the content"	" hence check_command	'check_https_url_for_string"" is used which translates to:		command_line    $user1$/check_http -h $arg1$ -i $hostaddress$ -s	                -u $arg2$ -s $arg3$		where -s also makes it use https.		check for ""picture of the day"" on the main page.		this is all re: the explanation what happened on t124812.		@neon:/usr/lib/nagios/plugins# ./check_http -h commons.wikimedia.org	-i 198.35.26.96 -s -u ""/wiki/main_page"" -s ""picture of the day""		http ok: http/1.1 200 ok - 132756 bytes in 0.635 second response time	|time=0.634539s;;;0.000000 size=132756b;;;0		@neon:/usr/lib/nagios/plugins# ./check_http -h commons.wikimedia.org	-i 198.35.26.96 -s -u ""/wiki/main_page"" -s ""picture not of the day""		http critical: http/1.1 200 ok - string 'picture not of the day' not	found on 'https://commons.wikimedia.org:443/wiki/main_page'	- 132756 bytes in 0.634 second response time ...		bug:t124812	change-id: ie03fccb3de2e5827600b5a58a8f7de5870411298	|gitblit/icinga: move git.wm.org monitoring to virtual host		this used to be on antimony directly"	" but we don't use apache	there anymore and the check was removed in ie7580d00b6d20a2d.		instead we need to add a virtual host for git.wikimedia.org which	is behind misc-web varnish.		bug:t123718	change-id: i89a4e9e0f39156f9be010425adb5537be608a1a9	|paws: move monitoring to icinga module		move monitoring of this service into the icinga module"	"	along with monitoring of ores and similar things.		that's where it should work to add virtual hosts and	it seems unrelated to the toollabs module besides that paws	happens to run in toollabs.		bug:t129209	change-id: i4da9f4118b81a388b06c5ec50eb7ef24d6e77d39	|icinga cleanup: move gsb monitoring to ./monitor/		move the gsb monitoring class to ./monitor/ along with	the other existing classes doing similar stuff.		use the same naming scheme for classes for general cleanup	of the icinga module.		bug:t110893	change-id: i1efa09d01835fb648b191a3ed34f5dbb7ef24425	|ores: move monitoring to icinga		when this was in the ores module itself	the virtual host never got realized on neon/icinga.		moving this into icinga itself and it works.		bug:t119340	change-id: ic7dd3e355322454bb1ae7081da61fc7248e5a851	|icinga: ssl cert monitoring for external services		adds a virtual host in icinga to add these ssl cert expiry	checks to that are not associated with one of our nodes via	a role class"	" because they live externally.		this way we can still have monitoring"	" just needs to belong to something	in icinga.		adds a new class to icinga and checks for blog.wikimedia.org and policy.wikimedia.org.	other special cases will follow-up when these work.		bug:t114059	change-id: i7f97dda664aedefc391898308cae74ca5fb33f8a	|icinga: add cert expiry check for icinga itself		adds a check for ssl cert expiry on icinga itself.		bug:t114059	change-id: if260112567215bb91f9d403c328a379407375474	|"																																																																																																																																																																																																																																																																																																																																																										
"install_server: move mirrors stuff to own role		move the mirrors things to a separate role"	" like the comment	said to do.		no-op on carbon:		http://puppet-compiler.wmflabs.org/2921/		bug:t132757	change-id: i9beae993d59618ea080314ca67e7457683eff984	|installserver: port squid3 changes for trusty/jessie		unify precise_acls_conf.erb from url_downloader into templates/squid3		bug: t123733	change-id: i81c2f321326988d1ebe0c66518c891e3d868105e	|squid: logrotate for webproxy on carbon		bug:t97119	change-id: i930a8f008a26d518d5ee549c13a789eff2db5831	|"																																																																																																																																																																																																																																																																																																																																																																		
"cache_maps: re-role old mobile servers		bug: t109162	change-id: i7eed33b610e2cacb404df50900626447ceb31f1e	|re-arrange cache ipsec for codfw as a backend		bug: t127481	change-id: ib768c5d7c72ddedacd525224899149e1e5fd5c2a	|cache_mobile decom: 2/2 remove most cache config		after this we can manually stop various daemons on these hosts and	leave them idle (but still configured with ""standard"") for a few	days until they're re-purposed.		bug: t109286	change-id: i51354c8abc76c480146f61210cb4f8f55e889a7d	|apply ipsec associations to kafka brokers		bug: t92602	change-id: i8b25106cbb55dfd7ed596ba8eb037ff118753c00	|bugfix for fff9aca5: s/concat/array_concat/		change-id: i8df41a72bdda082ef2165e5490073e0c820cef5b	|switch codfw to tier2		bug: t110065	change-id: i46a9eb856dda3523c3a78c8e7a7f170ad8576434	|for cert names"	" use the fqdn instead of the ec2id.		this is safe now because fqdn includes project name"	" hence unique.		bug t95480		change-id: ifb387bffcb23c8fa9dcfba3fb602b2c97d8cb263	|various role classes: moar small lint fixes		bug:t93645	change-id: i997f82a6cbd5d0dbbb986358436bc0f2f3c7819f	|"																																																																																																																																																																																																																																																																																																																																																																	
"jobqueue_redis: set up encryption and cross-dc replication		since the topology is slightly different in eqiad and codfw"	" the logic	of cross-dc replication is moved into a data structure. the dc-local	redis masters are then set up for replication and cross-dc encryption	based on it. the local slaves have no ipsec encryption and only need to	know the instances present on their master"	" of which they are an exact	mirror. in case of need"	" a slave can be promoted to be master by	removing the slaveof definition and promoting it into the master-master	data structure.		bug: t124672	change-id: i2bd075501661bb9e9527bb8e1858a1322a4a1535	|"																																																																																																																																																																																																																																																																																																																																																																
"jsbench: add systemd compat for jsbench-browser		adding a unit file and compatibility for systemd"	" now that	the server using this role has been upgraded to jessie.		just tried to translate the existing file for upstart.		the unit as such is recognized"	" the service does not start for	another reason. 		bug:t141023	bug:t132530	change-id: if66250e145211caf674deb189726109e81ec0fd0	|jsbench: chromium-browser on trusty"	" chromium on jessie		on ubuntu trusty this package was ""chromium-browser"""	"	but since the upgrade to jessie it could not be found.		e: package 'chromium-browser' has no installation candidate		it's just ""chromium"" on jessie.		https://wiki.debian.org/chromium		bug:t141023	change-id: ic260c3e7d30a307cc48eca8b7b5dbbec0a6ad6b6	|various role classes: moar small lint fixes		bug:t93645	change-id: i997f82a6cbd5d0dbbb986358436bc0f2f3c7819f	|make vbench more generic		separate ve-specific and osmium-specific parts from	generic js performance benchmark code.		bug: t92701	change-id: i34c13a32300899c7b5cdf98aeb82384bae2ca239	|"																																																																																																																																																																																																																																																																																																																																																															
"add ferm rules for kibana		bug: t104939	change-id: iaac1cd1ce2ebb716f0c1b12f24837b2589f2f88e	|logstash: enable user & group authz modules for kibana		bug: t103804	change-id: i751ad63828e9c7a26bb8b07804310bd3c056ada3	|beta: change kibana password location		move the expected htpasswd data file location off of nfs.		bug: t102962	change-id: i3fadf41674522069637e855aa37c9d39dc1b6a77	|beta: change auth realmmessage for logstash-beta		bug: 69267	change-id: i171f35ddaa45baa802359cf500ab38a0971ab61e	|"																																																																																																																																																																																																																																																																																																																																																																			
"give librenms access to members of ldap group librenms-readers		bug: t131252	change-id: ib0b7d5bbcb3e3b054076aa513c868756612c4f14	|use ldap auth for librenms		bug: t107702	change-id: iaf76eaf0abc08f0e03857abec0e211990532dcfe	|add ferm service for rsyslog instance on netmon1001		bug:t105410	change-id: i3e5c614d8bdf1b9d471afadbdc027f73a6b92787	|librenms: move to apache::site		also move the website from role class to its own class		bug: t118786	change-id: ib40c2c89dfb9e5d8e1af07f7931956f50af65e6d	|librenms: kill old redirect		bug: t118790	bug: t118786	change-id: i7cc1a933cce96a67812009bd397b51bbf1d9710d	|librenms: add ferm rules for http/https		librenms is on netmon1001 which still needs ferm rules.	it has an apache virtual host on 80 and 443.		this is a part of ""ferm rules for netmon1001"".		bug:t105410	change-id: iffb801243056a5e6dd0d4b9f0983d429d19e3ead	|bugfixes for b13b9157 (dependencies)		change-id: i4f50b376a5addfeb2d6f004863963bcc29aac94a	|delete webserver::apache::module		replaced by apache::mod::* hierarchy.		including ::apache::mod::ssl from within webserver::apache would land us with	a parser bug. so as temporary workaround"	" include apache::mod::ssl alongside	the only instantiation of webserver::apache::site for which the if guard would	be true (librenms).		the entire webserver::apache::* hierarchy will be deleted by follow-up commits"	"	so it's ok for now.		change-id: ia6e5ec8ad80f7996b679db327c30b8e1c503a114	|"																																																																																																																																																																																																																																																																																																																																																																	
"use hiera for udp2log-mw logrotate count		for the deployment-prep project"	" there isn't enough diskspace to keep	1000 compressed logfiles.		this creates a hiera variable so that a rotate count can be set on a	per-project basis.		bug: t140313	change-id: i292936c91d539d6791fa63a1d87e282b0350594f	|kafka config: add config functions		up until now"	" kafka configuration has been held in	role::kafka::(main|analytics)::config"	" which are mostly copy/pastes of	each other. this patch consolidates them by introducing two functions:	kafka_config and kafka_cluster_name"	" the former using the latter. this	allows us to elegantly get the config by simply using the cluster prefix	we are interested in:		  $analytics_conf = kafka_config('analytics')	  $main_conf      = kafka_config('main')		bug: t130371	change-id: i206b54d10e8188e7775d3f6621c8d4cc60e0d269	|add ferm rule for eventlogging mediawiki exception/fatal relay		bug: t113343	change-id: iab4f79ae3e13379a0f14aeafbca90f0cf6924db1	|add udp2log module"	" make role::logging::mediawiki use it		bug: t122058	change-id: ie736c25c84fe66e0005a27a93b15c79c8c6ea1c5	|clean up some unused udp2log stuff		bug: t97294	change-id: i02eac9f5172d52732af05fc9a0d91c54b1f5869e	|disable analytics1026 misc (sqstat) udp2log instance"	" remove sqstat and udp2log		cleanup will be done manually.		bug: t117727	change-id: iff1a586eed2fbbba997d4a6ad399c9ae9f009bff	|remove role::logging::udp2log::erbium and friends		fundraising's udp2log is gone now. remove:	- role::logging::udp2log::erbium	- misc::fundraising::udp2log_rotation	- nfs::netapp::fr_archive	- role::logging::kafkatee::webrequest::fundraising (this was for testing)	- statistics erbium rsync cron jobs		needs manual cleanup on erbium.		bug: t84062	bug: t118325	change-id: i8a7884fd72e5bbe11da6643a4d9823fb65ea254c	|remove uid setting from file_mover user.  enforce-users-groups-cleanup was removing this		bug: t115943	change-id: i2b838e143ae0d61c579847b8ce4d8cdae1b8e9d2	|set file_mover primary gid by name rather than number		bug: t115943	change-id: if94751b9e08f07c063cd2ac5f50962ea0196cc5e	|erbium: add a log for beacon/impression		add a log stream"	" matching the configuration of the special:recordimpression	log stream"	" for beacon/impression.		bug: t106624	change-id: ia9a53a6a495970107ce1af47d5e6126385fd6845	|beta: replace deployment-logstash1 with deployment-logstash2		bug: t101541	change-id: iffc3e62439d6bbccf7f5e215c1bfb56eab6f33c0	|logging: transition to ssh::userkey		bug: t92475	change-id: i9a1afae7081212c2f4fae1b2237c2d01b3514680	|use udp2log::rsyncd class to set up rsyncd on fluorine		this gives default ferm rules to allow rsyncing of files		bug: t99245	change-id: i564b3b77b07035b15965dcf869a035630a1e2f2e	|fix for stat1002 cirrussearchrequests.log rsync job		bug: t98383	change-id: ia979c9b5b6d9917943ac92ff8e169226ea3a6930	|rsync cirrussearchrequests.log from fluorine to stat1002		bug: t98383	change-id: i11e48d07b00ba36cb510839dd23fd1a14af340bb	|remove oxygen udp2log related code		i will reinstall oxygen (as jessie or trusty) before re-puppetizing.		bug: t97294	change-id: if54b0aaa74636dc79ddceab05eb98032e697e2f3	|turn off oxygen's udp2log instance"	 move 5xx error log to erbium	" turn off some erbium filters		this leaves erbium (and analytics1026) as the only operational webrequest udp2log instances.	oxygen will be used as a kafkatee node"	 and sampled	" and 5xx logs will be moved there.	once that is done"	 sampled and 5xx filters will be removed from oxygen	" and then	i will work with jeff to disable fundraising filters too.		bug: t97294	change-id: i4dcc610ef6094e799474f37d42933fe8c255076e	|logging: update cirrussearch thresholds		adjust thresholds to improve snr		metric history is also available at	https://ganglia.wikimedia.org/latest/graph_all_periods.php?c=miscellaneous%20eqiad&h=fluorine.eqiad.wmnet&r=hour&z=default&jr=&js=&st=1429622767&v=0.0167224080268&m=cirrussearch-slow.log_line_rate&vl=lines%20per%20sec&ti=&z=large		bug: t84163	change-id: i71c527168aa18ffd44e386fa59e159612944cb20	|use eventlog1001 as main eventlogging host instead of vanadium		for this most part"	" this patch just does s/vanadium/eventlog1001/g.	it also configures a new varnishncsa instance on bits caches called	'eventlogging'"	" rather than 'vanadium'.  i have ensured that the	vanadium instnaces will be stopped"	" and the new eventlogging instances	will send to eventlog1001.  once this is applied"	" i will	manually remove the vanadium named instances and puppet configs.		bug: t90363	change-id: i2d0fc3d0a629f2bc75ef209ff2a51324893a9677	|remove unused udp2log::nginx and relay configs from gadolinium and protactinium		i will remove the files and configs manually"	" as well as delete stored configs.		bug: t92337	change-id: i02a269ccc0b7c9b49bdb5966d01f9d58b11a65ac	|remove final referneces to webstatscollector		bug: t87868	change-id: i217336656ed36c2f2174db12ebd88def7f5a61af	|remove webstats puppet references		there is still one left for erbium.  that will be removed in a subsequent commit		bug: t87868	change-id: i9716dedc35ff5af4ef3d7ad81a41ba93a9e6ebdb	|remove dependency on webstatscollector service		bug: t87868	change-id: icf47b36850017b13e6d4e207011f7765772afe41	|decom webstatscollector step 1		step two will remove the remaining puppetization once the services are stopped and packages removed.		bug: t87868	change-id: i25ff1880cb9ff4d5f643bf1c0588ec1d6125cdda	|remove init script for default udp2log instance on fluorine		adds a default_instance parameter to misc::udp2log which"	 if false	"	removes the default init script so it won't conflict with any	misc::udp2log::instance instances.		bug: t87726	change-id: ib7b0a618f221fff982e4683ee378a8300cba8bff	|logging: move fatalmonitor into role::mediawiki::logging		that's the only place where it is used"	" and other helper scripts	are there already		bug: t87221	change-id: ic74ad378f94b7146f34df99a55ddaea5a0a8d980	|beta: kill beta specific mediawiki logging role		bug: t87210	change-id: i5aa9392c2c1f9afd6c6625bbccde70c035eb50be	|lsearchd: remove udp2log configuration		note: this will leave files unmanaged and to be removed:		service udp2log-lucene stop	rm /etc/init.d/udp2log-lucene	update-rc.d -f remove udp2log-lucene	rm /etc/logrotate.d/udp2log-lucene	rm /etc/udp2log/lucene	rm -rf /a/log/lucene/		bug: t85009	change-id: i3e14c8007ebef0fb05eb2e21f502fceb9697dc25	|feed logs from ssl terminators again into webstatscollector's filter		since webstatscollector's filter is on purpose dropping logs of	requests from internal ips"	" webstatscollector is dropping the cache's	logs of the requests the ssl terminators relay to the caches. hence"	"	to have webstatscollector count ssl traffic"	" we need to make sure to	get the logs from the ssl terminators themselves into	webstatscollector's filter.		with the decomissioning of emery"	" erbium had it's udp2log setup	changed [1] and hence was no longer getting logs from the ssl	terminators. as erbium was also running the webstatscollector's	filter"	 we were effectively no longer counting ssl traffic. hence	" we	now move webstatscollector's filter to oxygen"	" which consumes the	whole udp2log multicast stream including logs from ssl	terminators. thereby"	" webstatscollector's filter is reporting ssl	traffic again to the collector on gadolinium.		[1] 79ba1d60b713533740d27728234c4bbb8fe60f8c		bug: 67456	change-id: i6a324ee9c4ef876c203e4944a695938507ed48ad	|"																																																																																																																																																																																																																																																																																																																																					
"elasticsearch - disable cron to clear elasticsearch caches		this cron was put in place for an older elasticsearch version"	" where it	helped reduce gc pauses. we need to validate if it is still needed.		collection of additional metrics is also enabled to give visibility on	the impact of that change.		this change will be rolled back if we see an increase in gc pauses.		bug: t144396	change-id: i6b9136352e87b79efaf57816a94ddb7b33160e2c	|logstash: tag striker messages for indexing		bug: t143172	change-id: i104e02a4bfbc7d7b6a5e660d627a9f90d3035621	|logstash: new input for msgpack over udp		msgpack is a binary serialization format (<http://msgpack.org/>). it can	be used to exchange json like data between systems/languages. uwsgi	includes some nice instructions for logging to a logstash cluster with	msgpack encoded messages:	http://uwsgi-docs.readthedocs.io/en/latest/logencoders.html#the-msgpack-encoder		bug: t143172	change-id: i4d6d912e7d6d77e7cbfa276ad4b7e0c693d920c0	|logstash: enable log4j provider		bug: t141324	change-id: iae69c1909d7bfb22161ba80b53267ce5395cdb78	|logstash: update logstash for sending to es 2.x		adjust index mapping template to be 2.x compatible:	* remove `path: full` from geoip. this is now unsupported.	  full was already the default"	" and is what new versions of	  es always do so no other changes required.	* remove 'index_name: tag' from tags. this was aliasing the	  tag field to tags. it is no longer supported in 2.x. any	  dashboards that query tag must query tags instead now.		post process logs to make them 2.x compatible:		* converts dot's in the properties into underscores. 2.x does not	  allow dots in properties"	" they are used as separators.	* normalizes the pid and line fields into int. some of the log types for	  nodejs services auto-created these as strings.	* drops the extra timestamp field. @timestamp is definitive"	" and this	  timestamp field is seen sometimes as a date"	" sometimes as a string	  in the auto generated mappings depending on the content of the field	  the first time it was seen.		change-id: i46d177ce1218eee6f86fa9468b917dc54b3d55da	bug: t138335	|kafka config: add config functions		up until now"	" kafka configuration has been held in	role::kafka::(main|analytics)::config"	" which are mostly copy/pastes of	each other. this patch consolidates them by introducing two functions:	kafka_config and kafka_cluster_name"	" the former using the latter. this	allows us to elegantly get the config by simply using the cluster prefix	we are interested in:		  $analytics_conf = kafka_config('analytics')	  $main_conf      = kafka_config('main')		bug: t130371	change-id: i206b54d10e8188e7775d3f6621c8d4cc60e0d269	|use new kafka role in role::logstash::eventlogging		bug: t121659		change-id: i4763836fce6ff563be7cba7b00c2ebcba8e37bef	|move the ferm rules for elasticsearch internode traffic into role::logstash::elasticsearch		logstash100[1-3] run all the injectors"	" while logstash100[4-6] only run the	elasticsearch nodes.		bug: t104964	change-id: i0b76f76482aaf3bf25d236b3352b93d66e31b1e6	|logstash: track apache2 syslog error rate in statsd		bug: t81030	change-id: if5e2bea55b7c4685fb0f645dbb5bb923efb1680a	|logstash: access to port 9200 for krypton		bug:t114836	change-id: ib7405bbb3462f275a9892bfd1943bb53656ee296	|consume eventlogging validation logs from logstash		add a new ::role::logstash::eventlogging class that can be used to	configure a logstash server to consume eventlogging error events from	a kafka topic.		bug: t113627	change-id: i4d8ddc877d146fef3fbde850c53bc97e90ebe21a	|logstash: add monitoring for logstash process		* ensure there is a java process owned by logstash with logstash in its	  argument array. emit an alert otherwise.		bug: t112985	change-id: id0521d1978ddcc80eaf163f40541b0cc02978e7d	|add ferm rules for logstash/elasticsearch		bug: t104964	change-id: i50a13427befd33b230416896cc8267bbefdc9a2b	|logstash: count mediawiki log events with statsd		count each mediawiki logstash event by sending an increment command for	the counter ""logstash.rate.mediawiki.$channel.$level"" (eg	""logstash.rate.mediawiki.memcached.error"") to a statsd server.		bug: t100735	change-id: i4771abef68a151d08340b63f95cc556c8010416d	|cassandra logstash setup		- sets up a logstash udp input that uses the json codec on port 11514	- deploys logstash-logback-encoder artifacts on cassandra hosts	- configures cassandra to use udp appender		bug: t100970	change-id: idc5cfc8c5b53e8dac88dbed9e506eee79568903e	|logstash: provision elasticsearch only backend hosts		add logstash100[4-6] to the existing logstash elasticsearch cluster.	these hosts will not run logstash or kibana. they are dedicated to	running elasticsearch exclusively.		bug: t96814	change-id: iaf6fe70aa7a9200e12ef42e3bcff713516fd9181	|standard: include admin wherever needed		we also remove all the ""include admin"" stanzas around the puppet manifests		bug: t86774	change-id: i8977120a3e7109de4c3d23a6fd36a28f75e08703	|logstash: support mediawiki logs via syslog		add support in syslog filter rules for converting messages sent by	mediawiki using the syslog transport and logstash json formatting in the	message payload. adjust prior logic for handling the logstash json	format sent by mediawiki over the redis transport to more generically	handle these messages coming in over any transport.		bug: t88870	change-id: icd6060b7ac5c44c7af6e57878bec600693ee5301	|logstash: split beta role into two composable clearer ones		bug: t86642	change-id: i9001cdd0fb3bf455f4c069de8a0c958c8f1f8054	|move notices to -releng from -qa		also general s/qa/releng/"	" which i hope was done correctly.		bug: t86053	change-id: i094610fb1c6dbde83c62d4a03fb1baab8c30d2ca	|duplicate -qa notifcations to -releng		the releng team would like to unify the -devtools and -qa to a new	channel -releng.		looked for all occurences of #wikimedia-qa to add in #wikimedia-releng	as well.		impacts:	* logstash: hopefully the boolean logic is fine	* icinga/shinken: straightforward"	" the list is expanded by the	  template modules/ircecho/templates/default.erb		bug: t86053	change-id: i60bfb8098b6c5e6dbbb6480f73d190a91090e464	|allow puppetmaster to send reports to logstash		add a puppet report handler for sending data to logstash. each report is	converted to a single log event which is sent as newline delimited json	to logstash over a tcp transport.		on the logstash side"	" the event's ""host"" field is fixed to contain the	hostname of the puppet agent that originated the report rather than the	ip address of the puppetmaster and tags for indexing in elasticsearch.		this results in the full diff of the puppet run being stored in	logstash. as such"	" care should be taken in ensuring that the target	logstash cluster is properly secured for types of sensitive data that	this may reveal.		bug: 60690	change-id: i604582a7faf902ba899985ca7127b95de1fa9b20	|logstash: rules for processing mw input via redis		add a filter to tag mediawiki log events received from redis for storage	in elasticsearch.		bug: t845	change-id: i140e3127a10c6e7561951ad68b6fb2bce2414e0e	|"																																																																																																																																																																																																																																																																																																																																																						
"prometheus exporter: avoid still existing precise hosts		we do not need precise support; the hosts that are still on precise	will be deprecated soon.		bug: t126757	change-id: i592ac63f86dab412e2268b638ecec58c5221085d	|mariadb: install node/mysql exporters in eqiad too		bug: t126757	change-id: if5ce9aa11f1b518efce3326ac4d64be8ac1d62b3	|mariadb: collect prometheus stats in codfw		collect from all dbs jessie/trusty in codfw.		bug: t126757	change-id: i373ca5682a9e732d2b216b0c02628baf5b977f8e	|mariadb: add mysql/node prometheus metrics for db2034		start deploying to trusty hosts too"	" beginning with db2034		bug: t126757	change-id: i8b55b26de07285f59cf1eba35817f98bf8c52adf	|add public logic for grants to m5 db for striker application		bug: t142545	change-id: i597c80a2da74033bf83f04c7becd9c7b7a4e7787	|add prometheus's mysql-exporter to all jessie's production codfw dbs		also"	 export mysql_role	" mysql_group & mysql_shard:		* mysql_group: general usage of the server"	" for example:	  - 'core': production mediawiki servers	  - 'dbstore': servers for backup and analytics	  - 'labs': production and labs replicas of production	  - 'misc': other services	* mysql_shard: for 'core' and 'misc' services"	" vertical slices:	  - 's1': english wikipedia (see dblists on mediawiki-config)	  - 'm1': puppet"	 bacula	" etc.	  - most services are not segmented and will return the empty	    string ('')	* mysql_role:	  - 'master': for the masters of each datacenter (one per shard	    and datacenter). only the one on the active datacenter is	    read-write of all the ones on the same shard.	  - 'slave': for read-only slaves	  - 'standalone': single servers that are not part of replication"	"	    such as read-only 'es1' hosts"	 wikitech	" or tendril		(mysql_dc is just a copy of the local $::site for the node).		to cleanup code"	" a new class has been added (mariadb::groups)	to concentrate prometheus and salt groups"	" applying it to all	hosts"	" not only core ones.		bug: t126757	bug: t104459	change-id: i19f12a893f9da334984dc3cc40d247fbefe58e45	|add datacenter to lag checks		deploy new mariadb alterting; prepare for new heartbeat column	(datacenter).		bug: t114752	bug: t111266		change-id: idfc24364d3c439907ba8a3a99f4b904f2cc2b2a0	|reconfigure m3 servers to use modern mysql configuration		also remove unneeded options now that they are all equally	upgraded.		bug: t138460	change-id: i4d5d9f9be42ce06a30607f7cf6b9bba33c596673	|new user for prometheus monitoring		prerequisites:		* setting a password on the non-public repo (done)	* setting a fake password on the public repo (done)		current grants given are the same as nagios. more can be added	if needed. i will add it manually to a single host in order to	test it first.		bug: t128185	change-id: i85152efcedc70f68ce345aa21b4dcce95663abd6	|remove /a directory from db1048		bug: t138460	change-id: id0627ccd47de743c9b5e7520f15f363ffb309f03	|ensure mariadb service is running on wikitech host.		bug: t125987	change-id: i7a5cbd70be824a4e29192caa0c7482a5bcd2869b	|avoid log spam as 99% of these would be non-errors		bug: t132324	change-id: i9493fda89a2149775ee57c62e9b6555d5128269d	|correct invalid cron definition; add gtid to backups		bug: t131705	bug: t138562	change-id: i548ba5a1a27db81ba00cb7c286df23f11f9be889	|remove otrs backups from dbstore1001"	" create them on es2001 instead		the whole mariadb role (actions that are not part of the mariadb	module iself"	" but deployment-specific) have to be refactored on its	own db_maintenance module"	" but we will keep them here for now.		stop taking backups for otrs on dbstore1001"	" that has no disk space	left. start taking them on es2001"	" which has plenty of space and is	close to m2 slave (db2011). a tarball will be created from that	host and stored temporarily on es2001"	" until the bacula director	gets it and then they are deleted.		this will free up to 1tb of space from dbstore1001"	" while	maintaining the functionality of the backups on a separate host.	this is not ideal"	" but this is supposed to be temporary until	otrs space issues are fixed or disks for dbstore1001 are bought"	"	whatever happens first.		bug: t131705	change-id: i4c352856e391fc7829ab87e77d130eec9f8ebd7e	|mariadb: use 0/1 instead of off/on for read_only		all the other booleans are set with 0/1 and this avoid also issues with	upper/lower case when comparing configurations with pt-config-diff.		bug: t133333	change-id: i1ddbf9f6a0b1d14989c5e73532fadb919a6aee98	|remove unneeded $heartbeat_enabled variables		as per volans suggestion.		bug: t133337	change-id: if4cfaebc92904e7b14d6428b489b1af813a58c37	|enable heartbeat on all masters"	" even on the pasive datacenter		the idea is setting heartbeat as enabled on all masters"	" at half	the previous rate"	 independently if passive or active	" to prevent	a ""monitoring failover"".		this will also allow (eventually) detect link loss between	datacenters.		bug: t133337	change-id: i80f5e2726e78999752b7fb2ff38296371cd4bf64	|mariadb: tune thread-pool to avoid aborted_connects		this tuning is already live on few shards and worked well as a	workaround to avoid the increased aborted_connects under certain loads.	applying it only to masters.		bug: t133333	change-id: i8aa0ae1f04e2c614f3de912de0e6a844eb2b2a39	|mariadb: change mariadb::core parameters		- change default value for the $ssl parameter to 'puppet-cert'	- remove the $p_s parameter"	" enforcing it always to 'on'		this is almost a noop that change to set the default values to the new	standard. only p_s is changed to 'on' for es1 shard in eqiad.		bug: t111654	change-id: i2a5013d39776fbb3c0c0f7bcd41f9adc707ed5e1	|mariadb: set $master true for codfw masters		- allow to set $master = true for all master regardless of the	  datacenter in which they are.	- start pt-heartbeat only for masters in the $::mw_primary datacenter.		bug: t134481	change-id: ic9d0de49c008f4fa740714baaf51b7a96ff6396d	|mariadb: set mysql_role to standalone for es1		bug: t133337	change-id: iff9a47a9dcd9ed206ba4472c6ff92cdb5cbaa884	|mariadb: set additional salt grains for core dbs		change-id: idd88b7a4e892841be1616cbecd8c66a619ce206f	bug: t133337	|mariadb: load and enable semi-sync replication		- load semi-sync replication master or slave or both plugins by default	  for mariadb::core in the production.my.cnf.erb and	  production-es.my.cnf.erb configuration files.	- it could be made cleaner to use two separate plugin_load_add	  lines once t133780 is fixed.		bug: t133333	change-id: i0058aae108776ebdfb294ae811f16b4d420c3dec	|mariadb: allow up to two eventlogging_sync processes		this alarm has been flapping a lot"	" root cause is that we allow max one	process"	" but there could be two during normal operation:		  root     15324  0.0  0.0  43828  1820 ?        s    11:03   0:00 sudo -u root	  /usr/local/bin/eventlogging_sync.sh	  root     15328  1.8  0.0  12628  1600 ?        s    11:03   2:38  \_ /bin/bash	  /usr/local/bin/eventlogging_sync.sh		bug: t123509	change-id: i6b2fa5b5a5d7cd5c0f9a3f6d32304d6ff0021e82	|mariadb: separate external storage my.cnf		- increased max_connection=10000 (was 5000)	- set thread_pool_max_threads=2000 (was the default 500)	- set thread_pool_size=40 (was 32)		bug: t133265	change-id: i56da6dd098106888a5f8832ed975681fb38ac601	|enable the new pt-heartbeat on core production hosts		after performing the schema change"	" enable the new heartbeat	(pt-heartbeat-wikimedia"	" including the shard) on all production	masters. as we only have the new role on s2 and es2/es3"	" and a few	other misc servers"	" it will not apply immediatelly to all servers.		setting s2-master in statement"	" as it is in reality.		bug: t114752	change-id: i73ebdd466c7ca3d04bce6dd773b4cef4c42969ee	|enable pt-heartbeat on all misc masters (except m1)		after testing the heartbeat functionality on m5"	" add it to all	misc shards. this a previous step to enable it fleet-wide.		the reason it is not enabled on m1 is because we require a	master failover there first to remove the legacy class.	it will be run manually there until we can apply the new class.		bug: t114752	change-id: i7334b182f3b14a5dd79c7db6ff6b33a79efbea71	|support totp auth in keystone		bug: t105690	change-id: i5e067bcd326a345616139e307336e44591734aad	|test the new heartbeat functionality on m5-master		bug: t114752	change-id: ic847305ded71d2b59844f5885c391bd9d6f334b1	|fix typo s/admin/admins/ on mariadb's icinga config		bug: t127821	change-id: ie5aea5d91304d92b77061f4de1107bb0c694f050	|add exception to /srv partition for db1043 and db1048		those are old servers and mysql is still installed under /a.	adding explicit exception for those hosts so that datadir continues	being there"	" moves to /srv by default.		this is only a temporal fix until those 2 are reimaged.		bug: t126209	change-id: ibd38da2adc1edc2bfb375778df977f06902bbed2	|upgrading phabricator mysql setting for db2012		while maintaining defaults for other phabricator (m3) databases.		bug: t126209	change-id: i3e899fd1ab691738fdf16fb3a0188068da8c38e4	|add access to m5-master:testreduce* dbs for ssastry on ruthenium		ssastry has asked for command line access to testreduce_vd and	testreduce_0715 databases. i am adding a new mysql account	with limited access to those databases"	" visible for all parsoid-	test-roots. this will be accesible from ruthenium only.		referencing this access on the access module to note that this	provides extra grants to parsoid-test-roots group.		bug: t125435	change-id: i6259a89f6c0c477fc4550c11e5c24b520ec1d843	|add testreduce account and grants from ruthenium on m5-master		this is horrible puppet and the whole grant system needs to be	reafactored"	" but this will work for now.		bug: t124704		change-id: id6142da12b360149c6a76fa329821f633a264490	|enable tls by default on all core mysql hosts		requires restarting and upgrading to 10.0.22 to take effect.		bug: t111654	change-id: i40ecec4507c88987e2e6bd8a667becc430e8f32f	|add ferm rules for role::mariadb::misc::eventlogging		only the standard mysql db ports are in use.		bug: t104699	change-id: i90425ae32f4419e53f119e5ec13aafbf1ecb5e5d	|fixing bug with init.d script content		it was a string"	" not a source		change-id: i6cd2edb9f7b2c7f120560f31ca352cc5bd73f62a	|monitor x1 replication on dbstore hosts		x1 is only needed for dbstore1002 (analytics-store) but it has	been configured on all dbstore hosts for redundancy.		bug: t75047	change-id: ib84dac84f9bdd547e0022515abb07818def89feb	|enabling performance schema experimentally on db1022		db1022 is currently depooled. solify its configuration to	enable performance_schema running on it.		if the test works successfuly"	" we will enable performance_schema	by default on all hosts"	" but we need to measure (performance)	regressions first.		bug: t99485	change-id: i068dd8181f991dd5cb90a232f46595645fe086d9	|enabling performance schema experimentally on db1018		db1018 is currently depooled. solify its configuration to	enable performance_schema running on it.		if the test works successfuly"	" we will enable performance_schema	by default on all hosts"	" but we need to measure (performance)	regressions first.		bug: t99485	change-id: i0e3e36efb8338209717ffaadd8b46d945017d94a	|update a couple of firewall rules to include mira alongside tin		and update a comment.		bug: t113351	change-id: i6c0143f9c1dbf854915f970c261366181e7249a1	|add ferm rules for mariadb sanitarium		bug: t104699	change-id: i43469f8d233a58a6deff111e5b6201f9305e243e	|add nodepooldb mysql database to m5 and grants from libnodepool1001		add account for accessing the nodepooldb database on db1009 from	libnodepool1001.		this commit depends on the right password being added to the	private respository.		bug: t110693	change-id: i75ad21ec9bb101c4611643c15089e0337b29328d	|silver/wikitech: also allow mysql from terbium		besides allowing mysql connections from tin"	" also allow	them from terbium"	" because that's where maintenance scripts run.		bug:t98682	bug:t107547	change-id: i546028884025f0f94e4efd27a801e72a3e576b8a	|add extra grants for labswiki from tin		a wikiadmin user will be created so that it can query from tin.		i do not like the current grants model"	" but i will continue	using the current standard until i can refactor it.		bug: t98682	change-id: i1055a8a388a088012b57637995e20b3ac7fd102c	|silver/wikitech: allow mysql connection from tin		t98682 says tin needs to be able to make mysql connections to silver.		we should do that instead of suggested work arounds on t107547 i think.		bug:t98682	change-id: i727877c7f94435b57d1b42a6bcfa13fb1ba27167	|add ferm rules for role::mariadb::misc::phabricator		bug: t104699	change-id: id7a03eb6976d81fb3d0e426a4bbb5c5f8840ca3f	|add ferm rules for role::mariadb::misc		bug: t104699	change-id: i02adf82332a10fdfb5e6474b09a4764bbab1594a	|add ferm rules for role::mariadb::proxy		bug: t104699	change-id: i9695306108d4303959af6d9b298d6ba5f0bb1125	|enable ferm rules for role::mariadb::dbstore		bug: t104699	change-id: ie1e72628c521395c4fb916f8ce27205ef61095ae	|create a common ferm base class for the database hosts and move the existing	labsdb slave definition over to it		bug: t104699	change-id: i39ca592fe9d6f27f7c672c5d6203e55eaa6bd777	|add ferm rules for mariadb labsdb		bug: t104699	change-id: ib729303ef25da9c427618bbd6fa2fef88c656c8a	|resolving grant issue on parsercache		bug: t101182	change-id: i39155c421b1e6c17ec22314ff8eebbc11315ef61	|labsdb: disable transaprent huge pages		bug: t102484	change-id: id21f0c3d442792d608ce04bc73abe152a3ee04e6	|small configuration fix for pc1001 database		tmpdir is now /a/tmp	added load and dump of buffer pool on start/stop	bug: t100301		change-id: ife7da8febcf7898b4daba22f83348d3cd1e84bb5	|script used for non-replicated dbstore backups		bug: t95835	change-id: i90ee834c2157783e79bb4118f3fe1603ec1646ca	|mariadb: lint fixes in role class		23 x warning: indentation of => is not properly aligned	puppet-lint 1.1.0		bug:t93645	change-id: if06b2d26ecfa57c2621c1089c01b7611996cd853	|promote db1046 to m4 master		- eventlogging isn't ready for strict_all_tables due to an old bug	- start in writable mode		change-id: i2266b7416609b6887ff66b21ca077e73e7352d2e	|"																																																																																																																																																																																																																																																																																																																					
"mathoid to service::node		have mathoid use the service::node paradigm		bug: t97124	change-id: i06f06cf1f516a536b82b286551eda011c02e3a6c	|various role classes: moar small lint fixes		bug:t93645	change-id: i997f82a6cbd5d0dbbb986358436bc0f2f3c7819f	|mathoid: unify mathoid production and beta roles		bug: t86633	change-id: i10463938bac5afdd75e10b7cf8f2574fd809391f	|mathoid role for production		create the mathoid role for production similar to	i77f412fc202c187fa37710c6e2c004c7ca94f6c6	which defines the role for beta.		the production role is different regarding the	following aspects:		* no jenkins/contint includes		in addition		* the monitoring group mathoid_eqiad is created"	"	* the ferm service is renamed from 'http'	  to 'mathoid'"	"	* and monitoring for port 10042 is set up		bug: 69989	rt: 6077	change-id: iadc5e539b92d0628d022b481756534613dc78ef6	|"																																																																																																																																																																																																																																																																																																																																																																	
"restore mc1007 memcached growth factor to 1.05 as the rest of the cluster.		memcached on mc1007 has been running with growth factor 1.15 for a while	to test differences between 1.4.21 and 1.4.25 (the latter requiring 1.15	to work properly). mc1007 shows a stunning hit rate but we don't have	precise metrics of what it was before the 1.15 value change"	" since we	enabled diamond/graphite only afterwards. i want to double check if this	great performance is due to a lucky shard or if the growth factor is	playing a role. in any case"	" mc1007 will be restore to the current	default value of the cluster (1.05).		bug: t129963	change-id: ia2d4d35f211adce07370cdb2886e0653fa061f64	|deploy memcached 1.4.25 to mc1010 as part of a performance experiment.		bug: t129963	change-id: iaa47685d681fe17cdc7bc2db02ac2c2c59176e08	|add new suggested memcached settings to mc1009 as part of perf experiment.		mc1009 runs memcached 1.4.25 that offers a new set of features to increase	performance. the ones that this change adds are the minimum suggested block	by the memcached devs.		bug: t129963	change-id: i6c5e99159cee3102b95878dca3cd14c71de1fb95	|raise the memcached chunk growth factor on mc1007 as part of a perf experiment.		bug: t129963	change-id: idb22ebea22dd39b36629381cad2c23a1ad8d7c08	|add the possibility to specify memcached's chunk growth factor.		memcached's -f command line option specifies the chunk size growth factor"	"	namely the value used to create slab classes. we use also the -n value set to	5"	" meaning that slab classes will start from 5 bytes and grow multipling each	time by 1.05 and rounding the value to the first one divisible by 8.		bug: t129963	change-id: i5579ce1ce57615feac1d432845b59488d5e93fec	|remove testing parameters/settings from mc1009's memcached.		mc1009 is currently running a testing version of memcached and we noticed	a regression in evictions and slab size distribution after enabling the	latest suggested features. this change will remove all of them ""downgrading""	mc1009's memcached to the current settings of the cluster.		bug: t129963	change-id: i92152b0942587d552a3e45ea7e8dd758cf029bae	|remove duplicate of 'lru_crawler' in the mc[12]009 memcached configs.		bug: t129963	change-id: i2c1714d9c0f32604300b30194ee21bcbb174476e	|update memcached version on mc1009 as part of a performance test.		bug: t129963	change-id: i7126d9834e4715b2c72bf2465c63c3de47baecc3	|memcached: on mc2010"	 set 'maxconns_fast'	 'hash_algorithm=murmur3'	" 'lru_crawler'		as a first step toward the modernization of our memcached configuration"	" enable	'maxconns_fast'"	" 'hash_algorithm=murmur3' and 'lru_crawler' on mc2010. these	configuration options are available in 1.4.21"	" the version we have installed.		bug: t129963	change-id: ic6ca8ca73bce35b7b67932afd54276f4d7dd2c18	|role::memcached: create cross-dc replication for sessions		in order to have all the defined shards (that we already use for ipsec	cross-connections) being replicated from the master dc to all the	others"	" we do the following:		* add a ""map"" parameter to redis::instance"	" allowing to add variable	  settings for different instances on the same node"	" much alike what we	  do with varnish::instance		* add a redis::multidc::instances function that"	" given the ip address of	  the server we're on"	" will extract which instances should be present on	  the machine and which host/port they must replicate from if the	  datacenter is not currently the primary.		bug: t126470	change-id: ibdcf252f8b0e6490db5998a57d83e578d8a1338a	|role::memcached: add cross-dc ipsec for the various shards		a new class redis::multidc::ipsec is introduced; it is able to set up	ipsec appropriately between specific redis machines in multiple	datacenters so that replication is supported. specifically for sessions"	"	we defined 1:1 shards between codfw and eqiad in nutcracker"	" so we can	expect the shards to be equally distributed in the two dcs. activating	replication will allow to have a disaster recovery option; however a	precondition to that is having an encrypted communications channel	between the dcs.		bug: t126470	change-id: i0a32f938baefa276d0346af06f97644c6ceaa2ce	|role::memcached: explicitly bind redis to 0.0.0.0		bug: t126395	change-id: ifaa43e3ee637d62c091aa2262d22f165b842af52	|base: move mysterious_sysctl from webserver		also webserver module is dead!		bug: t118786	bug: t118812	change-id: i53743262fd1413fae79cd6e2b3d7cc1f3d4e3628	|tweak memcached limit on beta (89gb -> 15gb)		the memcached instances in the beta cluster have 16gb of memory but are	still allowed to grow up to 89gb.  i am not sure what will happen once	the ram is filled up"	" i guess it would swap and eventually send the	instance to death / oom kill.		i have limited the beta instances to roughly 15gb which should prevents	them from diyng.		bug: 52378	change-id: ifcef51fd4592c02e2d8a3a01a16930f23541554c	|"																																																																																																																																																																																																																																																																																																																																																	
"introducing mobileapps role and puppet module		bug: t105538	change-id: i4cbc5a3bc1b96332d06db4b8a7b7e1f1f9ed95f6	|"																																																																																																																																																																																																																																																																																																																																																																			
"irc.wikimedia.org - remove apache		the only reason this had apache is to redirect	http://irc.wikimedia.org to docs on meta"	" afaict.		it's not configured for https"	" which gets us t130981.		so we can either decline that bug or remove apache entirely"	"	which solves that but means people who type irc.wikimedia.org	in their browser will get an error instead of the redirect.		bug:t130981	change-id: ie062ac06d5280d171fa654f9a290abeb10a8c961	|"																																																																																																																																																																																																																																																																																																																																																																
"fix random ntp startup failures		after rebooting the 17 mc2* servers in codfw"	" on two instances	ntpd didn't restart properly:		systemctl status ntp.service:	[..]	jan 27 08:38:20 mc2009 ntpd[850]: ntpd 4.2.6p5@1.2349-o wed oct 28	20:16:08 utc 2015 (1)	jan 27 08:38:20 mc2009 ntp[834]: starting ntp server: ntpd.	jan 27 08:38:20 mc2009 ntpd[874]: proto: precision = 0.267 usec	jan 27 08:38:20 mc2009 ntpd[874]: unable to bind to wildcard address	0.0.0.0 - another process may be running - exiting		this is https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=436029	and fixed in all distros we use. the reason we're still seeing	this is that the fix requires lockfile-progs to be installed	which is ""recommended:"" by ntpdate and we don't install recommended	packages by default.		fix this by adding an explicit require_package to the ntp role.		change-id: i232374c9aa17ddb1f8aec0f2b24103c2ee8d25f0	|"																																																																																																																																																																																																																																																																																																																																																																		
"ocg: skip ganglia when it is unwanted		on labs ganglia is no more available.  drop it from hhvm::monitoring	when it is known to not be here ( $::standard::has_ganglia ).		see also change to the apache module:	    https://gerrit.wikimedia.org/r/287695		bug: t134808	change-id: i27aba3cc3e393ee99c1ffb676787bf42badb2803	|exempt ocg service from connection tracking		bug: t104976	change-id: i1766b88686b0c184e1dc5e14f0414ee215d7f1ba	|lint: indentation fixes in roles		all of these fix a:		warning: indentation of => is not properly aligned		one more step towards being able to re-enable that check again.		bug:t93645	change-id: i6a49e08dfe220eefc24096b0da201eb214caddf1	|standard: include admin wherever needed		we also remove all the ""include admin"" stanzas around the puppet manifests		bug: t86774	change-id: i8977120a3e7109de4c3d23a6fd36a28f75e08703	|fix another 28 puppet linter warnings		just fixing another 28 warning: indentation of => is not properly	aligned.		just one way to get closer to not failing all the lint checks.		bug: t87132	change-id: i78c5e66da95930b80c5465ec062ba6ecc817c2df	|increase ocg warning/critical space thresholds.		we're working on tracking down a space leak here.  but in the interim"	"	there's no reason to have these thresholds so low: the machines in	question have 500g disk"	" of which 453g is currently free.  (and 32g ram	disk.)		bug: 71341	bug: 71260	change-id: i094fcd5d46a1a97acafd75484d0b5959c08448e7	|"																																																																																																																																																																																																																																																																																																																																																																	
parsoid: add role based on service::node	" apply to two hosts		add a new parsoid class and role that use service::node to install	parsoid and run it from the service-runner based deployment		this is part of i3f4a5 that is being splitted in multiple commits		bug: t90668	change-id: i9236292664abaa649c8748ce3cf8d9ea237ffd1c	|fixing small bug in template instancing for ruthenium		the content is in a template"	" not a file. fix syntax.		bug: t125435	change-id: ic81f449c2f81cfdd51fcdc28161a26178905770f	|add access to m5-master:testreduce* dbs for ssastry on ruthenium		ssastry has asked for command line access to testreduce_vd and	testreduce_0715 databases. i am adding a new mysql account	with limited access to those databases"	" visible for all parsoid-	test-roots. this will be accesible from ruthenium only.		referencing this access on the access module to note that this	provides extra grants to parsoid-test-roots group.		bug: t125435	change-id: i6259a89f6c0c477fc4550c11e5c24b520ec1d843	|beta: parsoid now uses modules defined in source		for a long time parsoid on beta cluster has been using the node modules	from the /deploy repository.  there is now support for shrinkwrap which	pins dependencies to a specific versions.		point parsoid node_path to the source repo /node_modules/ which will be	populated by jenkins using 'npm install'.		bug: t92871	change-id: i84a6d2ba8e5dcec6528daac89d3711369695ab8c	|beta: point parsoid back to source code		24586a2 from october 2014"	" made parsoid service to use the source code	from the deploy repository.  after discussion on t92871"	" it is more	convenient to use the tip of master on beta cluster.		the node modules are still provided by the deploy repo though.  that	means whenever dependencies are changed"	" there will be a bit of breakage	until deploy is updated.		next things will be to install dependencies that are locked in	the source repo (via npm shrinkwrap).		bug: t92871	change-id: ic0134a10b8aaf9c07a691f0499f4c0a005552b58	|standard: include admin wherever needed		we also remove all the ""include admin"" stanzas around the puppet manifests		bug: t86774	change-id: i8977120a3e7109de4c3d23a6fd36a28f75e08703	|parsoid: open port 8000 with ferm rule		since https://gerrit.wikimedia.org/r/185429 sca* hosts have	base::firewall enabled. betalabs hosts also have it enabled	(via role::ci::slave::labs::common) - for both sca* services	and parsoid. parsoid in production *doesn't* have	base::firewall enabled"	" but we perhaps should at some point	to unify parsoid with other *oids (or remove them from	everywhere). for now"	" add a ferm rule to open pup port 8000	so betalabs parsoid works fine.		bug: t86951	change-id: ia312a73d1ab329a22aae26ee851ed584363017b3	|parsoid: systemuser is only for production		on labs/beta"	" the parsoid user has been added to ldap with uid/gid 605	(bug 63329).  hence move the generic system user creation under the	production role.		change-id: ifa32751a52be96f3749b6a5d8694251a5aec3369	|bug 60694: make the config file path configurable		this is a stop-gap solution to get bug 60694 fixed by supporting a different	config file path in beta vs. production.		in the longer term we should probably puppetize /etc/parsoid/settings.js	differently"	" and use the debian package as developed in	https://gerrit.wikimedia.org/r/#/c/110666/ for installs.		change-id: i51b26c0aed75f8a8614c560c45b98320b74c31e0	|role::parsoid::beta must allow port 8000		when adding role::beta:natfixup on parsoid2 instance"	" it started	refusing connection on port 8000. the reason being that the ferm rules	come with a default policy of drop.		bug: 45868	change-id: i36f2bcbeacedf24aa6deaa9739669ca86cd8820c	|beta: let jenkins-deploy restart parsoid		on the beta cluster"	" the parsoid daemon runs on a dedicated instance	deployment-parsoid2.pmtpa.wmflabs.  the code is updated on	deployment-bastion using the jenkins-deploy user"	" we then need to	restart the parsoid daemon"	" that is going to be done via ssh from the	bastion to parsoid2 as user jenkins-deploy.		the sequence is roughly:		 script on deployment-bastion as jenkins-deploy	 ssh jenkins-deploy2@deployment-parsoid2	 > sudo -u parsoid /etc/init.d/parsoid restart		the deployment-parsoid2 already has the role::parsoid::beta class.		bug: 57233	change-id: ie1d4c35a12fbc30b622f0754bf2956f55598844c	|rename misc::parsoid to role::parsoid::production		i am going to need a role class to deploy parsoid on the beta cluster.	the deployment-parsoid2 instance currently uses the same class as the	production one but need some further tweaks.		bug: 57233	change-id: ide6f136c66aebd77f62ec35589c311a8ada9a83f	|"																																																																																																																																																																																																																																																																																																																																																					
"fix the usual stupid puppet include loop bug		change-id: i014bd6a2b46e7fff58034082db23863020862362	|"																																																																																																																																																																																																																																																																																																																																																																			
"add ferm service for poolcounterd		tcp        0      0 0.0.0.0:7531 .. 19590/poolcounterd		eqiad poolservers don't include base::firewall yet (so noop there)"	"	but i would like to on new codfw servers. (iea291978649db8dddc729).		bug:t93261	change-id: iae2bca2f24823701e61e2aad9d63b2c06c0c6d55	|"																																																																																																																																																																																																																																																																																																																																																																		
"added filtertags to labs role descriptions.		this is an experiment to spruce up role filtering	for the new labs puppet gui		bug: t91990	change-id: ic25662a110068969240083f6f4f9986628388898	|get rid of the ldap+yaml enc		it was a terrible idea		bug: t114063	change-id: i99642edfe438d1d49e151fc3915d5a27a8085b88	|puppetmaster: enable autosigning puppet certs for labs		bug: t102504	change-id: i3e121cb4cd034f37393b244c56ac34c4dfd0a98a	|puppet: temporarily disable the labsstatus reporter		it's buggy.		change-id: i6388661895e57e12bd1b13ddf9b8f33d1c547c36	|ldap+yaml file puppet enc for self hosted puppetmasters		- allows reproducible cluster setups for a particular project -	  just specify roles in the enc and hiera appropriately"	" and	  with autosigning / etc"	" you can delete and re-create instances	  much more easily	- documents which instances have which roles - no need to hunt	  around in wikitech and guess which roles are really required	- makes it possible to version control which roles apply where	- can be re-used when horizon hits	- this only applies for self-hosted puppetmasters atm"	" due to	  performance considerations		bug: t85279	change-id: ic7c6c4492488f559ce00480c6cfc3e8710be1033	|parameterize roles for labs		parameterize role::puppet::self and role::salt::minions. allow for	project-wide puppetmaster and salt master.		bug: t90592	change-id: i9d3160362f3c7ed73091f8c6ad0d5af632cdeeb8	|"																																																																																																																																																																																																																																																																																																																																																																
"puppet_compiler: refresh module/role		since we rebuilt the puppet compiler"	" we refresh the puppet module as	well.		bug: t96802	change-id: ie3fc79eec44667f3bee4f5cbb9130f3826e94964	|"																																																																																																																																																																																																																																																																																																																																																																		
"role::rcstream: move redis settings from legacy config file		we have a series of settings that are still in the old"	" now unmanaged	redis.conf file that are not in the default file and are not in the	instance-specific file. this means those settings are now	practically-speaking unpuppetized.		bug: t134400	change-id: i4224237629ddd3f496b49e836cc2c4ffe1cda165	|rcstream: remove internal tls listener		this was used to provide public tls for stream.wikimedia.org"	" back	when that was a direct lvs service to the rcstream hosts.  that's	now handled by cache_misc.  it's true that in the future we'll	want internal tls on these for varnish (and/or other internal	consumers)"	" but the structure of that would be entirely different	and it would be abstracted in a different way...		bug: t134871	change-id: i5a776ea4f3c2c08756bf4a0e2e38a48c379c2def	|remove rcstream lvs::realserver config		bug: t134871	change-id: i734c7fb2b8d524d79c39c06cae19027cf5211fba	|remove old rcstream public lvs config		dns was moved off of these ip addresses a couple of weeks ago"	" and	no clients are shown connecting to these ips in live lvs data	anymore.		followup commit removes conftool-data"	" for after pybal has been	restarted.		bug: t134871	change-id: i31e9f1ef5034634ecdca72590dd2abf0c660442f	|rcstream: let wikitech connect to redis via ipv6		bug: t136245	change-id: ife634e6797fdf03793096e96188338f2a66a0e86	|wrap lvs class in has_lvs hiera variable		bug: t91560	change-id: ie0327e1fbe5504e9cbeaa857b80304cd2d683e1d	|add ferm rules for rcstream		the rcstream instances only bind to local host but redis needs to	be accessible from mediawiki hosts.		bug: t104981	change-id: i599a6de4650dd9c0b3f2adc5d59524095f274c72	|various role classes: moar small lint fixes		bug:t93645	change-id: i997f82a6cbd5d0dbbb986358436bc0f2f3c7819f	|standard: include admin wherever needed		we also remove all the ""include admin"" stanzas around the puppet manifests		bug: t86774	change-id: i8977120a3e7109de4c3d23a6fd36a28f75e08703	|"																																																																																																																																																																																																																																																																																																																																																														
"restbase: allow pooling/depooling programmatically		bug: t140895	change-id: if4ee45b0bb490850c9fc00e2a034d5d7803b18d8	|disable restbase highest max sstables per read threshold		with instance sizes in-flux"	 and expansions taking place	" it is proving	difficult to provide meaningful thresholds that are entirely immune from	false positives.  hopefully we can re-enable this in the near future when	things have settled a bit"	" (or if an alternative form of alerting can be	found).		bug: t133091	change-id: i20d0e731beeada8cebd151e63455a18acbf277e1	|restbase: switch to service::node		there are many shared features between the restbase (w/	restbase::monitoring) class and the service::node define. so"	" instead of	duplicating work to keep all service-runner-based services updated"	" make	restbase use the service::node define as well.		bug: t118401	change-id: ica246d4e4a2c551ddf47334762a821536eccb307	|restbase: raise threshold for pending compactions		alarm tweaking after switching to date-tiered compaction strategy		bug: t118976	change-id: ie9a506cb36b15b1314de7fcae9fe5726e66818be	|restbase: higher sstable per read threshold		following dtcs switch"	" the 99percentile went up		bug: t118976	change-id: i26a0697dc2bc9c109157d769006afb95309612b3	|restbase: add cassandra password for test cluster		bug: t92590	change-id: i6183de7f3b9aa2cb34dd122c1b7fa2a92cc05870	|restbase: drop illegal characters from alarm description		apparently this is the default:		illegal_object_name_chars=`~!$%^&*""|'<>?"	"()=		see also t101799		bug: t101764	change-id: iaf4a32a82dd9f8fd5eed759123c95bd9c940d6f4	|configure additional cassandra metric alerts		bug: t101764	change-id: i400e7e6a93fcb91872ff396cba7fc3471645e6bf	|restbase: use transformnull for graphite metrics		this tricks check_graphite_threshold into thinking there's always data	(movingmedian already takes care of that)		bug: t78514	change-id: i8f383ae87a6b846c557a7fcdbad9b4ddfe86f88c	|restbase: fix graphite description		icinga/nagios don't like commas in descriptions		bug: t78514	change-id: id234d710e4bf8252dcc16551636314ea1c21cf91	|restbase: add error rates and storage latencies alerts		similar to 5d04bd78d but only add the alerts to the graphite host"	" this avoid	having equal alerts that would fire at the same time for each and every	restbase host		bug: t78514	change-id: i580dd8ac60d0ab1ebf0a5abd52f304f36f509754	|restbase: add ferm service for 7231/tcp		t92680 says ""allow tcp port 22"	5666	 and 7231 (ssh	 npre	" and restbase web) from all sources""		22 and 5666 would already be covered by base::firewall.		bug:t92680	change-id: i91f9369afbd7320d75c9b34d4417b789909c723c	|restbase: add internal lvs configuration		note: as a followup to this we'll need a role or variable not to deploy lvs	realserver during testing		bug: t89636	change-id: i85d70c5b2aded256ab808789e9ec0e6b8ca3bd8b	|"																																																																																																																																																																																																																																																																																																																																																							
"cleanup sca from *oid services		remove:	* citoid	* graphoid	* mathoid		clean up conftool data"	 admins	" and remove them from the role		bug: t125029	change-id: icf50766d4091cbc165d2eaba6f15e9796522c64e|graphoid: service deployment on sca		this patch introduces the role::graphoid and graphoid classes"	"	responsable for deploying graphoid on the sca cluster"	" together with its	configuration. concretely"	" the graphoid class installs the package	dependencies and uses service::node to create the rest. hiera is	configured so that graphoid works both in production and	deployment-prep.		bug: t90487	change-id: i1d3edad9f5df5b3a9ea9443411f228fd24e74ed0	|standard: include admin wherever needed		we also remove all the ""include admin"" stanzas around the puppet manifests		bug: t86774	change-id: i8977120a3e7109de4c3d23a6fd36a28f75e08703	|sca: don't include admin in labs		bug: t91554	change-id: i5c48249a118102c0b9c5148b1f71524b9917582d	|include the zotero role in the sca role		thus assigning zotero to run on the sca (service cluster a) cluster	update the realserver ips for the role as well.		bug: t89869	change-id: ie7adfc80ec6f6553bd0cdcbc83b3122642b470b4	|"																																																																																																																																																																																																																																																																																																																																																														
assign roles::ores::web	" roles::ores::worker to scb		bug: t124201	change-id: i1df756cf1dbd29cc0a620d213b8964911796b902	|assign changeprop service to scb cluster		bug: t128463	change-id: ide5a6c7f938d9160a28ed88236cb5e5499ac8899	|"																																																																																																																																																																																																																																																																																																																																																																		
"basic role for sentry		depends on i7a0ce9e087dee1b95f916288785470b1423f5435	and i2cfacb4544f99df9f5e6c30dc2824e8b153e27b2		bug: t84956	change-id: i1207235f0ee97c253b1a1e9e2bfa89eb79665290	|"																																																																																																																																																																																																																																																																																																																																																																			
"added filtertags to labs role descriptions.		this is an experiment to spruce up role filtering	for the new labs puppet gui		bug: t91990	change-id: ic25662a110068969240083f6f4f9986628388898	|simplelamp: allow overriding mysql datadir path		for backwards compat with role::labs::lamp		bug: t118784	change-id: i61b52063f5340a30e8d09b9e507fd4079ac89cc6	|"																																																																																																																																																																																																																																																																																																																																																																			
"apache: add role to serve static sites on multiple hosts using apache		bug: t120891	change-id: i1319883fbe6fc7162c148cd584503eeb83506158	|"																																																																																																																																																																																																																																																																																																																																																																			
"smokeping: add ferm rules for http to role		smokeping runs on netmon1001"	" which still needs ferm rules.	smokeping has an apache virtual host.		bug:t105410	change-id: i9efaff01e9cfe942a9e942cae343c29178ea8469	|"																																																																																																																																																																																																																																																																																																																																																																		
"discovery stats module		based on statistics::wmde. while the current code can be run from	anywhere on the cluster that has access to graphite"	" it might in the	future need access to db replicas and/or hadoop"	" so it should be placed	on a stat* host.		bug: t143048	change-id: ibac3173b941dbee9ac6ffe72aaa5c3dd8dcdb144	|reportupdater should rsync to ::srv module instead of :www		i've moved limn-public-data into /srv for disk space reasons.	/var/www/limn-public-data is now a symlink"	" which is messing with the rsync.		bug: t144278		change-id: ie1dc348f115dd5ae6c5ec2f80e19843770d448fc	|role::statistics: fix lookup of statistics classes		bug: t141242	change-id: ie220872fd6a5020120806bfbe18f0db1d1d5e938	|statistics::wmde puppetization		bug: t125989	change-id: ie6c865a01e5ec00decf82ecaab221e7fa76a95b8	|set up analytics.wikimedia.org site on stat1001		bug: t132407	change-id: i27cb2da9382a49c27bc8d9c3067ede1ab6c5a228	|stat1001: setup to rsync /srv/ and /var/www		per the comments on t76348#2199488 ff"	" also	copy /var/www/ and /srv/ from stat1001.		but beware"	 the size is huge	" we still need to find a host	to put this on.		bug:t76348	change-id: i1468d247301a9efb66c4b41ba619fabef6f534f2	|rsync home directories for stat1001 upgrade		temp. setup rsyncd on fluorine to copy home dirs from	stat1001 to upgrade that server and then copy data back		bug:t76348	change-id: i44ddac9bdfb6776910f08fc83ab843b33fa39399	|correct destination dir in browser reports rsync		bug: t127326	change-id: i1c83135d656267d2f0dd612c113b3f615153e85e	|rsync browser reports to datasets.wikimedia.org		bug: t127326	change-id: i4600d451cff30e94a7c42eb0248870806a49e652	|run reportupdater on stat1002 as the hdfs user		bug: t129551	change-id: ib7ecc52190d19e1064d16408c0e7f378020baa9c	|set umask to 0002 for wikidev users on stat boxes		bug: t111956	change-id: ia1823d3284feb45cc8187af3bb160006e4fcc82e	|labs: setup /srv/statistics for rsync from stats hosts		is a writeable rsync module that researchers on stat*	boxes can put data into that'll show up on a separate	mount in labs instances that opt into it		bug: t107576	change-id: ief9bec2cc9b80203f3462619237e3da744884021	|enable the mobile data crunching job		we fixed the performance problems with the old set of queries"	" and the	job should be much easier for stat1003 to manage.  see the referenced	task for details.		bug: t104379	change-id: ie7b95a40ed58a5b12111c0850a65a306aaf291b3	|add a new limn datafile generator: extdist		this will create datafiles that will be consumed by	extdist-reportcard.wmflabs.org		bug: t101194	change-id: i32e843f809fe4a55d310a3e4ebaedab7dfea40c4	|rsync cirrussearchrequests.log from fluorine to stat1002		bug: t98383	change-id: i11e48d07b00ba36cb510839dd23fd1a14af340bb	|statistics: remove 2 utf-8 characters		fixing one more ""invalid byte sequence in us-ascii""	that only happens with ruby > 1.9.x		bug:t91453		https://tickets.puppetlabs.com/browse/pup-1031		change-id: i46112fcd51877ccd340e0141cfc8fd32a6d24c31	|decom webstatscollector step 1		step two will remove the remaining puppetization once the services are stopped and packages removed.		bug: t87868	change-id: i25ff1880cb9ff4d5f643bf1c0588ec1d6125cdda	|add jobs for aggregating hourly projectcount files to daily per wiki csvs		bug: 72740	change-id: id1a4a9cd2d6a401636ac844ce102d6ee61771e55	|fixing stat1001.wikimedia.org website		bug: 66781	change-id: ieff4567832da05abae9dc0ca49608356f259a8b0	|redirect metrics.wikimedia.org to wikimetrics		while the domain has been removed in	59eab3e4b248405d7a08dc3d7e5a35a7fa21d470"	" search engines and some old	documentation still refer to it. so we redirect any requests to those	domains to the replacement service wikimetrics.		since the certificate for metrics.wikimedia.org has not been upgraded	since the heartbleed vulnerability"	" we cannot reuse the old	certificate"	" and hence only redirect http traffic for now.		bug: 64276	change-id: i43f978ad3db8076951523a247a12a06a10a3f73e	|"																																																																																																																																																																																																																																																																																																																																																									
"add a new statsd_proxy module and replace statsdlb		statslb is a trivial program that is"	 thus	" not very performant (it's a	single-threaded loop that calls recv()"	" hashes and sends ). i started	hacking on it to improve its performance"	" by for example adding multiple	threads or multiple processes (via so_reuseport) to it"	" or using epoll()	or recvmmsg(). while doing that"	" i felt a bit nih and started googling a	little bit"	" until i discovered statsd-proxy: a statsd proxy that someone	else wrote"	 that uses multiple threads with so_reuseports	" hashes using	a consistently hashing algorithm (ketana)"	" supports weights etc.		so"	 a debian package	 systemd unit	" upstart job and puppet module later	(all trivial): replace statsdlb with a drop-in statsd_proxy replacement"	"	statically configured to use 4 threads for now. this should be a no-op	from the infrastructure pov"	" just faster.		bug: t126447	change-id: ic0cbdf30f2785b6a0097089e3e9762178222cbb9	|"																																																																																																																																																																																																																																																																																																																																																				
"statsite: replace ::txstatsd class and role calls		bug: t90111	change-id: ifd79edad4bb0a56517dcd5458b6675ecbb03547a	|"																																																																																																																																																																																																																																																																																																																																																																			
"tcpircbot: add v6 addresses of terbium/wasat to ferm rule		bug:t141619	change-id: i2a3ebb86b83eb475d9d6946263648e6dd3a7aaa1	|tcpircbot: allow ipv6 addresses for terbium"	" wasat		besides the v4 addresses"	" we also need to allow the v6 addresses	to let the maintenance hosts talk to logmsgbot on neon.		follow-up to i73d0d6bc7d6087a25a		note how these are not the nice ""mapped"" addresses yet.		bug:t141619	change-id: i94169ff5efb3a0a6ba74249494ae58b0d136506c	|tcpircbot: allow connections from terbium and wasat		allow inbound connections from terbium and wasat"	"	the maintenance servers.		clarify comments for what server is doing what and	sort them a bit.		bug:t141619	change-id: i73d0d6bc7d6087a25a8ed7c5553b44021f766cd4	|tcpircbot: allow connections from terbium"	" wasat		allow connections from terbium and wasat"	"	the maintenance hosts"	" so that dologmsg can work	from there as requested on ticket.		will go together with i73d0d6bc7d6087a.		bug:t141619	change-id: i269df0af667867fbc598d7131f3c5ad3b0839917	|tcpircbot: allow connections from mira		on top of ferm rules (i8df023c1a789c) we also need to allow	mira to connect in tcpircbot config itself so we can let the bot	report deployments from codfw.			bug:t95436	change-id: i722e91a9b21f60e4c57e0d3ee1c6ac9c71ddd180	|allow mira to connect to tcpircbot on neon		when deploying"	" the deployment server connects to tcpircbot on neon	to announce the sync.		this was allowed for tin and we want it to work for mira in codfw.		add v4 and v6 address.		bug:t95436	change-id: i8df023c1a789c9a9f521211fa856759246c978a8	|remove references to vanadium in order to decomission		bug: t95566	change-id: i705e948e602145414b2e5fab74e8ccbf7df282fa	|use eventlog1001 as main eventlogging host instead of vanadium		for this most part"	" this patch just does s/vanadium/eventlog1001/g.	it also configures a new varnishncsa instance on bits caches called	'eventlogging'"	" rather than 'vanadium'.  i have ensured that the	vanadium instnaces will be stopped"	" and the new eventlogging instances	will send to eventlog1001.  once this is applied"	" i will	manually remove the vanadium named instances and puppet configs.		bug: t90363	change-id: i2d0fc3d0a629f2bc75ef209ff2a51324893a9677	|"																																																																																																																																																																																																																																																																																																																																																								
"switch everything to the new openldap ldap servers.		bug: t101299	change-id: i5d5b20ac2ba857df12f448ba4060d50fcf077ba6	|tendril: add cert expiry check		adding one more check for ssl cert expiry	for bug t114059.		change-id: i5b3f8763b348400bc989f25415131a53142a1a21	|tendril - increase hsts max-age to 1 year		if4f89e34 enabled hsts one week ago. let's raise	the max-age to 1 year now.		bug: t40516	change-id: i7373124fd2e098f147582ccbde97a87716b1efc6	|enable hsts on tendril with max-age=7days		https://tendril.wikimedia.org is https only"	"	so let's enable hsts on tendril.		bug: t40516	change-id: if4f89e34e2a7dd2b4141194e675a085c73d8de66|fix another 28 puppet linter warnings		just fixing another 28 warning: indentation of => is not properly	aligned.		just one way to get closer to not failing all the lint checks.		bug: t87132	change-id: i78c5e66da95930b80c5465ec062ba6ecc817c2df	|"																																																																																																																																																																																																																																																																																																																																																																		
remove nas1001-a.eqiad.wmnet	" nas1001-b.eqiad.wmnet		remove references to nas1001-a.eqiad.wmnet and nas1001-b.eqiad.wmnet	from the puppet tree. that's torrus and monitoring		bug: t124156	change-id: if70b01675709c239479d7511763ffc886e95d3dc	|torrus: fix http(s) monitoring		we have existing monitoring at:		https://icinga.wikimedia.org/cgi-bin/icinga/extinfo.cgi?type=2&host=netmon1001&service=torrus.wikimedia.org+http		this connects via https and checks for a string to appear	on the /torrus url. this was needed because when torrus	breaks there will still be a 200 returned but with an error message.		since i moved torrus behind misc-web varnish this check broke"	"	because now https ends at misc-web-lb.eqiad and not netmon1001	which is now just a http backend.		had to add a slightly different check command to be able to check	for services like this while they are behind misc-web (and still	use https).		bug:t119582	change-id: i34e754ff7ab14234b8e8308b5f006842850f0c45	|torrus: move icinga check to https		torrus was moved behind misc-web plus protocol redirect"	" adjust the check too		bug: t119582	change-id: idd88f83de8dd287937dd43bd6570224cfdb87507	|torrus: add http monitoring		adds an icinga check to see if torrus is up because it breaks often.	checks for string 'torrus top: wikimedia' on:		http://torrus.wikimedia.org/torrus		bug: t87817	change-id: if83f4cd45d550e07037426c35ae9d5a2fee59e90	|"																																																																																																																																																																																																																																																																																																																																																																
"installserver: port squid3 changes for trusty/jessie		unify precise_acls_conf.erb from url_downloader into templates/squid3		bug: t123733	change-id: i81c2f321326988d1ebe0c66518c891e3d868105e	|"																																																																																																																																																																																																																																																																																																																																																																			
"rename mediawiki::web::sites to mediawiki::web::prod_sites to make room for a new generic sites.pp		bug: t86644	change-id: i2978b697e3c0145b2d331802532b2bd3ee43bbd5	|standard: include admin wherever needed		we also remove all the ""include admin"" stanzas around the puppet manifests		bug: t86774	change-id: i8977120a3e7109de4c3d23a6fd36a28f75e08703	|make vbench more generic		separate ve-specific and osmium-specific parts from	generic js performance benchmark code.		bug: t92701	change-id: i34c13a32300899c7b5cdf98aeb82384bae2ca239	|"																																																																																																																																																																																																																																																																																																																																																																			
"set wdqs 5min expiry for internal access port:8888		bug: t119941	change-id: id452324e485dbe2595eb75ad2d6a32b18334f284	|wdqs: set icinga contact groups"	" add wdqs-admins		set the icinga contact group to admins(member irc) and the new	wdqs-admins.		bug:t111243	change-id: i48561517d0b79800d4e75ba6ad5f3ee578f38df3	|add icinga monitoring for wdqs services		bug: t103911	change-id: ifff8ed2009d159a2be0a69296dc46e9c692dad6b	|"																																																																																																																																																																																																																																																																																																																																																																		
"use eventlog1001 as main eventlogging host instead of vanadium		for this most part"	" this patch just does s/vanadium/eventlog1001/g.	it also configures a new varnishncsa instance on bits caches called	'eventlogging'"	" rather than 'vanadium'.  i have ensured that the	vanadium instnaces will be stopped"	" and the new eventlogging instances	will send to eventlog1001.  once this is applied"	" i will	manually remove the vanadium named instances and puppet configs.		bug: t90363	change-id: i2d0fc3d0a629f2bc75ef209ff2a51324893a9677	|"																																																																																																																																																																																																																																																																																																																																																															
"wikilabels: puppetize wikilabels infrastructure		 - add session class that uses memcached (for now)	 - add web class that sets up uwsgi and wsgi config	 - add hosts entry for wikilabels-database	 - add role for staging and deploy	 - set up roles to use the central postgres server		wikilabels code: https://github.com/wiki-ai/wikilabels	wikilabels config: https://github.com/wiki-ai/wikilabels-wikimedia-config	bug: t106218		change-id: i49ea516b0ee177f706be289a7b73be07995e73c7	|"																																																																																																																																																																																																																																																																																																																																																																			
"wikimania_scholarships: don't manage open/close dates		open/close dates are now controlled in the database		bug: t92358	change-id: i38cc9f819990400f076e733b1f6a2e3fa8dc1c0a	|update scholarships configuration for deploy		sean suggested using db1048.eqiad.wmnet instead of db1001.eqiad.wmnet	for the database. ellie set start/end dates for the 2014 application	cycle. security review is complete so vhost can be enabled.		this changeset requires new variables in the private repo:	* passwords::mysql::wikimania_scholarships::app_user	* passwords::mysql::wikimania_scholarships::app_password	see ibbd1bfd for related update in labs.		bug: 57870	change-id: i8064c49f42c46b9ef953480fb7838d2540a7fdd1	|add configuration for wikimania scholarships		add configuration for the wikimania scholarships application. this is	a stand-alone php application hosted in an apache vhost with code	deployed via trebuchet. data will be stored in the misc mysql shard. ssl	termination and caching will be provided by the misc varnish cluster.	logs will be forwarded to fluorine via the udp2log protocol.		needs dns update.		bug: 57870		change-id: ie568f268b1df21bd3bd6681436f6bac444f82132	|"																																																																																																																																																																																																																																																																																																																																																																			
"fix another 28 puppet linter warnings		just fixing another 28 warning: indentation of => is not properly	aligned.		just one way to get closer to not failing all the lint checks.		bug: t87132	change-id: i78c5e66da95930b80c5465ec062ba6ecc817c2df	|xenon: add ferm rule for redis too		now that we have a default policy drop on fluorine"	" the xenon	connections from appservers to redis fail. the original xenon manifest	did account for a firewall and added a ferm::service for port 80"	" but	failed to do so for 6379 (redis). add a new rule.		bug: t86872	change-id: ifdcc178d5d3bedb065b9abfe9d55be86a7ef44af	|"																																																																																																																																																																																																																																																																																																																																																																	
"zotero: fix ""invalid byte sequence in us-ascii""		these characters caused ""invalid byte sequence in us-ascii"" in puppet	on labs.		and they were also ""illegal input sequence"" when trying to convert	them with iconv.		bug:t91453	change-id: i69afc52564601547d5ba6f7c13f86ce22e539616	|add zotero role class skeleton		add skeleton role class for zotero"	" including monitoring groups	and description. comment the part that actually uses the module	until we have one. modeled after existing restbase role.		bug:t89867	change-id: i1e718275da8d2a9c7a20faaf42ea9ec5c1d0457a	|"																																																																																																																																																																																																																																																																																																																																																																		
"introduce puppetmaster100[12] to the fleet		assign respectively roles"	" add partman and dhcp configs		bug: t143219	change-id: idfadc2c29dc8331200aa0717a43e905c9eb61ffa	|sites.pp: rename contint1001 and drop role		server has been reimaged and moved to the public network. remove the	role classes from it.  we do not want to have puppet magically spawn	jenkins and zuul lacking a proper configuration.		leave contint::firewall which is base::firewall + custom ferm rules.	will let us verify the network flows with other servers work fine.		bug: t140257	change-id: i477a135993bc4ded6273d03ace9f77da2feca6fb	|wdqs - initial configuration of wdqs servers in codfw		this also cleans up the `nagios_contact_group` node variable which does	not seem to be used anywhere.		bug: t144380		change-id: i316d0b3504b4aca45a4e6cfd7c907a39e26e5819	|remove decommissioned host rubidium from site.pp		rubidium was recently decomed"	 but was still in site.pp	" remove it as well.		bug: t118213	change-id: i370e066f491cf01b44b4ba0f4a52b6d2152124b2	|install labs::openstack::nova::network on labnet1001		bug: t142567	bug: t136562	change-id: i8855cf2c0cd5e50f09a47dfb0895650bf14d3277	|archiva: migration class to rsync data to new host		add temporary rsync setup and ferm rule to copy data	from titanium to meitnerium to replace archiva with a	jessie server.		copy directly from and into /var/lib/archiva. applied	on target server. so this allows pushing to the new	server and does not influence the old server.		bug:t123725	change-id: i5cae60e20f2f92e3af5ee55c99f4a207dd22c5ca	|set up zookeeper cluster for druid		druid (in test mode) was originally configured to use the production zookeeper clusters.	we would prefer to isolate those clusters from this more analytics type usage"	" so	this patch installs a zookeeper cluster on each of the 3 druid nodes.	this cluster is colocated with the other druid services.		bug: t138263	change-id: i7970af9664222287e1aa86ce00cb1d7b554c5908	|prometheus: add to lvs		also deploy service ip on prometheus eqiad/codfw.		note that lvs::realserver is applied to the hosts individually"	" not the	""prometheus server"" role. many such roles can coexist on the same host"	"	irrespectively of lvs"	" also not every prometheus server is behind lvs.		bug: t126785	change-id: ibf89504a06a69aca62af3f200d93dc4615e05023	|es2001-4: add node exporter to this standalones hosts		these are not really databases"	" but they are still part of the	mysql cluster"	" until they are decommed in aproximately 1 year.		bug: t126757	change-id: i110ad51ad4c33901ead7ddee52f027411a014aed	|puppetmaster: add puppetmaster::web_frontend		this substitutes for now the class puppetmaster::web_test"	" but will be	then used elsewhere too. it also allows to define a ca server different	from the local host"	" so that remote puppetmaster frontends will be able	to use it too.		bug: t143869	change-id: i6f263620beb48ba051c2f85e487787649f9a3cc2	|provision tool labs admin console (striker) on californium		bug: t136256	depends-on: i855f9484f799a6847590b5d1196abf903114fa34	change-id: idb8074b97e7c3bd62fc9928eedf451d1713740b5	|put installserver::dhcp on install1001"	" install2001		after splitting installserver::dhcp into a seperate role"	"	add dhcp servers on install1001 and install2001.		bug: t132757	change-id: id9ff2442d13b0a1da9ea02707f7daa04d6f89a8b	|mirror all topics in main-eqiad topics into analytics-eqiad		bug: t134184	change-id: ib1a88008cce0477cdacdc3f5516aaf43987407be	|mirror codfw* topics from kafka main-codfw to main-eqiad		bug: t134184	change-id: i56b0ec60195baa9ac009da237c9c396ac7ab74e4	|enable mirrormaker from main-eqiad to main-codfw		bug: t134184	change-id: i0cc642905a4b42fbb8014304af0a3e42def27877	|removing kafka mirror from main codfw hosts.		cross dc zookeeper_hosts hiera lookups are not currently possible.	mirrormaker cannot work until we fix this.		bug: t134184	change-id: idc8b8e5d4a7d7d935a8a93245ce08cc4eb929669	|mirror main-eqiad into main-codfw		this will only set up mirroring eqiad -> codfw.  we will	make sure this works first"	" and then also set up codfw -> eqiad mirroring.		note that this is the first patch in gerrit change https://gerrit.wikimedia.org/r/#/c/304928/1.	future patches to that change were attempts to make main cluster mirroring much more	flexible and testable in labs using a new puppet function kafka_mirror_instances().		due to time constraints and difficulty getting tests to work"	" we are going	with this simple prod-only version for now.		this also fixes a bug in kafka_cluster_name that would return inverted	site/prefix if given both arguments.		bug: t134184	change-id: ibc1818ef287cc37f4048ac86cfb609fa121c3e92	|introduce aluminium.wikimedia.org		assign url_downloader role		bug: t134496	change-id: i058f73da0acdbf2db62e9945a6711f394b58ec89	|url-downloader: remove the role from chromium/hydrogen		removing the url-downloader role from hydrogen/chromium. actually	hydrogen was by mistake set as a url-downloader. also remove the	$url_downloader_ip stuff to allow the ip to be reused in aluminium		bug: t134496	change-id: i3aaeb41391106297c9cecb98e0242206cf02354e	|remove nobelium from puppet and install-server		remove nobelium from puppet site.pp"	" partman	and dhcp config.		decom as requested in ticket.		bug:t142581	change-id: i8eac30d19e35ecd4e3e166e0488bcc662ec6bcbc	|maps - categorize maps1002 in site.pp		bug: t138092	change-id: ic384da75d806f4ab5dc4aa53a12f1adeb6e7ce6a	|puppetmaster: add role for puppetdb		bug: t142363	change-id: i5358e28edfa3cb448540f9b42e210829c0b35947	|retire db2008 and db2009 as x1 nodes		bug: t125827	change-id: id0fcce39379a327e85fd930cb1b692cc1f814edc	|maps - categorizing new eqiad slaves		note: maps1002 is having networking issues"	" let's fix those before adding	anything else on that server.		bug: t138092	change-id: i4e1a0fcb352b485b02d235d4ddd1ff8b92992a5a	|install_server: add dhcp entries for the puppetdb vms		bug: t142365	change-id: i9b08643651401cebfc7a9df2bfa353c8a2e60599	|add prometheus's mysql-exporter to all jessie's production codfw dbs		also"	 export mysql_role	" mysql_group & mysql_shard:		* mysql_group: general usage of the server"	" for example:	  - 'core': production mediawiki servers	  - 'dbstore': servers for backup and analytics	  - 'labs': production and labs replicas of production	  - 'misc': other services	* mysql_shard: for 'core' and 'misc' services"	" vertical slices:	  - 's1': english wikipedia (see dblists on mediawiki-config)	  - 'm1': puppet"	 bacula	" etc.	  - most services are not segmented and will return the empty	    string ('')	* mysql_role:	  - 'master': for the masters of each datacenter (one per shard	    and datacenter). only the one on the active datacenter is	    read-write of all the ones on the same shard.	  - 'slave': for read-only slaves	  - 'standalone': single servers that are not part of replication"	"	    such as read-only 'es1' hosts"	 wikitech	" or tendril		(mysql_dc is just a copy of the local $::site for the node).		to cleanup code"	" a new class has been added (mariadb::groups)	to concentrate prometheus and salt groups"	" applying it to all	hosts"	" not only core ones.		bug: t126757	bug: t104459	change-id: i19f12a893f9da334984dc3cc40d247fbefe58e45	|puppetise script to manage labs floating ip ptr records		relies on existence of a '128-25.155.80.208.in-addr.arpa.' zone under the wmflabsdotorg project.		has been tested both in labtest and had an initial run on silver.		bug: t104521	change-id: ibe5a64ea472f230f5c959baa75b8cbb6883d7cbb	|site: add prometheus::node_exporter to more machines		selected set of machines not serving production traffic.		bug: t140646	change-id: i2768e5ad866f901d26808f12e5173a75bde50310	|site: add thumbor100[12]		bug: t139606	change-id: icb4fa7ad4ef1f0e308fc8c8974a5857eb9771a3a	|add prometheus mysql exporter to db2069		this is a first ad-hoc test.		bug: t126757	change-id: i30aaeca00e78737d4c2cb12e42ce56bb985723d9	|remove references of decom api servers mw1114->mw1148		bug: t139353	change-id: if442a9dc0febf876503ca78fb865d79394027bcc	|temporary hack:  add access_new_install to iron		this continues to be a thing that i need"	" until the	attached bug is addressed.		bug: t138509	change-id: iff7c0c1b14ce5d7e3a8cdc0835d456345a06eece	|remove references of mw1018->1025 decom appservers		bug: t139353	change-id: ia953a301db6c59b06045cad16251567b53cff25a	|parsoid: clean up the manifests and files		there are a lot of unused parsoid roles and files after the transition	to service::node. this patch cleans them up.		note that the transition_cleanup role is being removed too"	" since the	transition is complete and the role has been applied to all of the wtp*	hosts.		bug: t90668	bug: t86633	change-id: i7b3c4167d6e447e40b931c69b14eea9b1a80bbe6	|claim mw129[12] for thumbor		bug: t139606	change-id: ie7f2508b3d192f33a618c63f4e4ee5b8519afbf3	|setup the new labsdb hosts with a new role		bug: t140452	change-id: i2c0b24dc34048439b44548b317182b4ee7ceb9ff	|enable generation of media lists per project on snapshot1007		bug: t133694	change-id: i3b38fd93b8fc648e8f3d34c6d3374ee155a0e87f	|add dbproxy1006-10 to production as redundant instances of 1-5		this requires first reimaging of those servers.		we will think later how to coordinate them to provide full ha.		bug: t140983	change-id: i4f41736e289184d241e09ea59d4e19482efaaf07	|reconfigure m3 servers to use modern mysql configuration		also remove unneeded options now that they are all equally	upgraded.		bug: t138460	change-id: i4d5d9f9be42ce06a30607f7cf6b9bba33c596673	|set db1048 as the new phabricator master on config		this will fix current heartbeat (replication) alerts.		bug: t138460	change-id: i89a646da79bc0b0fe16adf76f3f7b7b023082fe8	|configure new relevance forge servers		* adding basic hiera configuration	* changing partition scheme to align with similar elasticsearch servers	* assigning servers to correct roles in site.pp		bug: t137256	change-id: i88e905fa4d28389195c03b0f68087ce06a9c49dd	|grafana: add and provision labs grafana role		bug: t120295	change-id: i24036bd3298f3e6f679d37ee9ed1a69ce39fa1ad	|grafana: mark role explicitly as production		bug: t120295	change-id: i245e877a68540eb61fe35b37bd1c9329c8213a88	|parsoid: move to role::parsoid for all production nodes		this is part of i3f4a5 that is being splitted in multiple commits		bug: t90668	change-id: ie97015083ba56a7acaf5d40043dc04fcd0c33f3a	|osmium: copy data back from hafnium after upgrade		bug:t132530	change-id: ibd53ed831bbe3ac06f42fc85679dc55d53ef820e	|osmium: rsync home dirs to hafnium for migration		bug:t132530	change-id: i1ac35a7ac273191e4421a4df8efcb7a900b91607	|correct ip for db1043: 10.64.16.32"	" not 10.64.16.33		bug: t138460	change-id: i6f88554163bf69d542a48328f4ac7f2a2ef2f42f	|set db1048 as the primary master on the m3 proxy (not yet in use)		set db1043 as the backup primary. dbproxy1003 is not yet in use"	"	but it will be when the dns for m3-master is updated.		bug: t138460	change-id: i52b146c9d5fb524f1bf65e638a8cbe9c911f27b1	|parsoid: add role based on service::node"	" apply to two hosts		add a new parsoid class and role that use service::node to install	parsoid and run it from the service-runner based deployment		this is part of i3f4a5 that is being splitted in multiple commits		bug: t90668	change-id: i9236292664abaa649c8748ce3cf8d9ea237ffd1c	|site: use 'include' for role::prometheus::node_exporter		apparently using 'role' did nothing (no errors"	" no actions)		bug: t140646	change-id: i4b12917a664e43d32bb94f7a708dd8c478eb983b	|repool db1001 as m1 secondary (passive) host		bug: t125027	change-id: iec35f3307fc05eb87c58e785131de38221f0c33e	|site: add node_exporter for prometheus machines		bug: t140646	change-id: ie1d0a87ea9d23fc7346d1ee4df7eaaab29c0c51e	|puppetmaster: add test site to palladium		the easiest way to validate that a puppet master works as expected is to	compare catalogs generated from it and from the other backends; we thus	create a 'puppet.test' virtualhost that points all its traffic to	rhodium"	" the new puppetmaster we want to test right now.		this will allow to run catalog compilations against the standard	backends and against rhodium and check for errors/differences.		bug: t98173	change-id: ie40e9608047cc834528cffe7f7b861c1f7a62085	|stop kafka mirror maker on kafka100[12]"	" it is not doing anything anyway		this is in prep for confluent kafka 0.9 upgrade.  mirror maker puppetization	will need refactored for this to work.		bug: t138265	change-id: if1613473a9deafe6e4cff393bb4eb04b5b8d49df	|prepare hosts for labsdb1009"	" -10 and -11		bug: t140452	change-id: ie0b5d12680131c83e3d720d325bcc23b8a25e83d	|add ms-be102[2-7]		bug: t136631	change-id: i1161031db301af069f36656554d46182cd3008a7	|decommission old elasticsearch servers		old elasticsearch servers have been removed from lvs. all traffic and data	is off those servers.		this change remove the last traces of them from puppet by removing them	from the list used to configure ferm rules"	 site.pp	" regex.yaml and	various files in install_server.		bug: t139758	change-id: i8c1bdc1011a2bc656c7ba0fcf4c51ee58d71f08d	|gerrit: install gerrit on lead (pointing at slave instance for testing)		bug:t125018	change-id: id93970e08240f1fc3c0235bd7bc74cbd6939d1f8	|make labvirt1012-1014 nova compute nodes.		bug: t138509	change-id: i094b0fabd1bde825e0d23e551d2c265ed199d35e	|puppet: remove all references to the decommissioned appservers		bug: t139353	change-id: i7c53b5dbcf4cfa225dc5dbc2ef8ac0aa25b64745	|gerrit: setup rsync between old and new machines		setup rsyncd on the new server"	 lead	" to copy from the	old server"	 ytterbium	" and push gerrit data.		note how i changed the actual rsync command in the cron"	"	switched the order of source and destination"	" since we are	pushing.		bug:t125018	change-id: id9d3020a3be0f848e9a39b878664758a5a2b6cfd	|spec fix for aptrepo and installserver		align installserver to use puppetlabs_spec_helper.		install server had the apt_repository class moved to the module	'aptrepo' but the spec hasn't been migrated. do so and elevate aptrepo	with the puppetlabs_spec_helper bits (.fixtures.yml"	 rakefile	" .rspec).		adjust installserver/install_server_apt_repository_spec and split it in	two bits:	- aptrepo_spec	- distributio_spec (for apt::distribution)		inject some facts to please the wmflib os_version() function.		for installserver"	" remove our custom fixtures setup in the rakefile and	just replace it with the puppetlabs_spec_helper + .fixtures.yml		add some ""it { should compile }"" except for the	installserver::web_server that has a non trivial compile issue.		bug: t78342	change-id: ica92f23e8cb6421c76bd4e12d5702f23da674dd0	|preparing db1048 for jessie install		set db1043 and db1048 as installing jessie by default.		changing puppet to use mariadb 10 on db1048.		bug: t138460	change-id: i260e9c83cb00625805d44473d9f23d4dbd9274c3	|promote db1040 to be the new s4 master		bug: t139346	change-id: i0a775ef12d016b377741e8954b16981b498a82ed	|remove otrs backups from dbstore1001"	" create them on es2001 instead		the whole mariadb role (actions that are not part of the mariadb	module iself"	" but deployment-specific) have to be refactored on its	own db_maintenance module"	" but we will keep them here for now.		stop taking backups for otrs on dbstore1001"	" that has no disk space	left. start taking them on es2001"	" which has plenty of space and is	close to m2 slave (db2011). a tarball will be created from that	host and stored temporarily on es2001"	" until the bacula director	gets it and then they are deleted.		this will free up to 1tb of space from dbstore1001"	" while	maintaining the functionality of the backups on a separate host.	this is not ideal"	" but this is supposed to be temporary until	otrs space issues are fixed or disks for dbstore1001 are bought"	"	whatever happens first.		bug: t131705	change-id: i4c352856e391fc7829ab87e77d130eec9f8ebd7e	|remove antimony		bug:t123718	change-id: i39483a392127820cfd375df502fbf1eb22c6e888	|site: add prometheus[12]00[12]		note not all vms are online yet"	" though eventually the role will apply to all.		bug: t126785	change-id: i5929ad76c3057b2ce1228965d3a08e75cd0b60b4	|introduce zosma.codfw.wmnet		add new ganeti vm for security tools to	site.pp"	" add a stub role to ensure we have a firewall	and hieradata for debdeploy so we are getting security	upgrades. finally add to installserver to set a partman recipe	for ganeti vms.		bug:t138650	change-id: i533148e843365bd5411f2d0383706bd94eddf03b	|let phab2001 use same role classes as iridium		bug:t137928	change-id: i5caa35df02cbef14a912a9a017392bab2633801b	|promote db1016 as the m1 shard master"	" set db1001 as a m1 slave		bug: t106312	change-id: icfa6e473e30b2f5d1087702979627de91338cc86	|set temporarily m1 haproxy to failover to itself (db1016)		the current setup forces haproxy to always have a primary and a	backup node. as db1001 is only temporarily down"	" and will return	as the backup node"	" set both primary and backup nodes pointing to	db1016.		in the future"	" proxy configuration should allow between 0 and n	arbitrary number of hosts.		bug: t106312	change-id: i48703e8bc6a4a7a389e3c81897fa194ef9ac66b1	|configuring new elastic1043-1047 servers		bug: t138329	change-id: i244ab839945e1aec63b758a1f1741124a233dff7	|enable backup for gallium		hardware is potentially still flaky and but migrating it to labs will take	more time.		bug: t80385	change-id: i64d47247bf49fd7f6ede42a2c8b0c81031b1a000	|configuring new elastic1038-1042 servers		bug: t138329	change-id: i4463385b41e9b29b02fee17630b7c28f0fcd47f6	|configuring new elastic1033-1037 servers		bug: t138329	change-id: i3734402bacb11e36f3f0ae3e9ed37b4509783676	|swift: add ms-be202[2-7]		bug: t136630	change-id: i1ca8fad1fcd95fb854bed3f91c8118a4fe75efc1	|move labspuppetbackend to port 8100; open firewall		previously this was 8080 which is used for a surprisingly	large number of other things.		bug: t133412	change-id: ie3b4c2a9659e05fb15d567ebdaaa3bee83052569	|mysql backend for storing roles / hiera data for labs		todo:	  - more error validation	  - a name that is clearer	  - icinga checks		bug: t133412	change-id: i49fd45c47e5f756a77b3429a6e5a671e328285d2	|mediawiki: correctly assign the new codfw appservers in puppet		bug: t135466	change-id: ia041416144d6ebefbe2085b293510f6c420bdd98	|rm cp1043"	cp1044 from site	" installserver & torrus		these servers were already marked for decom for a while.		this removes them from puppet"	" installserver and also	the torrus config which still had them for a test cdn setup.		bug:t133614	change-id: i71c398ee2595321bef392a45cbc03f81db2513be	|contint1001: add zuul		bug: t137265	change-id: i5e8cc9cc8e2682699edc02ac9f09306c2dedca44	|contint1001: add role::ci::master		bug: t137265	change-id: i489b0dd1d1d449c351dddfbf00eefe92ec02e9d6	|contint: add contint1001 as gallium replacement		bug: t137265	change-id: i6cf8901bdc076403f63d5e051a5fca6268f94274	|remove furud from site.pp"	dhcp	"installserver		furud was meant to be a 'gitblit on jessie' replacement	for precise host antimony.		but only until diffusion takes over and now its not	going to be replaced"	" instead urls are going to be	rewritten to diffusion.		gerrit replication was turned off in ib64d4eaf5744caf5e		bug:t123718	change-id: iffd2f44cf2de4954059b8aeb29432c211eb854b0	|mariadb: add new coredb servers		bug: t133398	change-id: i1a067be2e3f593f5bdbffce8c7f3aa7d9c8385e4	|add new s6 core database servers		bug: t133398	change-id: i0ecfc5b55c9fb4c7448adf6d4fefc12da00bebc4	|add new s5 database core servers		bug: t133398	change-id: i41c5a191e17c263b886948310b8c8366e6c8498d	|assign labs::nfs::secondary to labstore100[45]		bug: t126083	change-id: i7f07cbbc6075972789a4c109d911aa3aa4cb9890	|add 3 new s4 shard core db servers		bug: t133398	change-id: i64a742deb78fbceaaa457222d0130ec47f3b37f1	|add extra new core database server to s2 shard		bug: t133398	change-id: iebbd3a7f2e13597411b9eca4202eeaf9afe714af	|remove magnesium from site.pp"	" dhcp/netboot		magnesium used to have multiple services but the last one	running was rt which was migrated to ununpentium in t119112.		now the server can be decom'ed.		bug:t123713	change-id: i320075268020032b32bf3859c84c7668497f3fdb	|remove db2007 from site.pp"	" done with testing		this was used temp. to test the rt upgrade and schema	change. not needed anymore now.		bug:t125827	change-id: i63c29d31518e9ad98fd1d55d57906483476bbf74	|puppetize new shard s1 db servers		- db1080	- db1083	- db1089		bug: t133398	change-id: i007b02e40de627326ed0241eb92e1ae9aa3c73a7	|add puppet code for endowment.wm.org site		add minimal puppet module and role to setup	endowment.wikimedia.org like we do for annual.wm.org.		bug:t136735	change-id: iebea9ee1c5d2d3b9b6657b5087dd447465163fe1	|add a new backup set to backup openldap databases and enable on serpens		run slapcat on to create a snapshot of the ldap data in the pre-run script	and a cleanup script after the backup run.		bug: t120919	change-id: i2ba5436a356b729b22dd8d7dcb5c64f11cb36e1f	|add analytics_cluster::hadoop::client to druid workers so cdh is installed		bug: t131974	change-id: i75aff2609829571380b3aa30b78631578ce94fe4	|apply druid roles in production with initial (guesswork) configuration		bug: t131974	change-id: i76e37089896bfc6f3b8db875dc53a03b306b662f	|add druid100[123] with just standard and base::firewall		bug: t134275	change-id: i632c0b7d4008d1965a51533e5e1f39ab05efe38f	|mediawiki: assign new eqiad appservers"	" install with jessie		bug: t133798"	" t134309	change-id: i87486d84527cd2a0aea35d19756f7f6e3d46b5b8	|apply firewall to db1016		bug: t135973	change-id: ic07187eed3a791bd2c906a31b798fa1c6a4a04d9	|mediawiki: decommission old codfw appservers		bug: t135468	change-id: i975893030d684081fc3ae23e2f49790aba54afa1	|rename holmium to labservices1002		depends-on: i88d74bcc13d0cf6fb765f1332bd59addf596302e	bug: t106303	change-id: i8e43e6a9c050d630c4e7e90913e7117ae95ee523	|prepare db1016 and db2010 for jessie reimage; db misc puppet review		db1016 and db2010 now install on jessie. they are going to be	reimaged soon.		cosmetic changes on site.pp for misc hosts: using quoted names"	"	as the number of nodes per roles is small.		db2030 was incorrectly assigned to shard m1- it has been moved to	m5.		bug: t135973	change-id: if97591fbe8b6ac69addec5cabf8de075757670de	|temp. setup to use db2007 for rt upgrade test		this is a temp. setup to use db2007 with a copy	of the rt database to test changes during a version	upgrade. the server is in the process of being decom'ed	and this will be removed again.		bug:t119112	bug:t125827	change-id: iebdbebd7aacb07051785afcb795a652c505e19ba	|mariadb: reimage db1029 to jessie and mariadb 10		bug: t112079	change-id: i58b06fed34ff939b5a8d3065d14491e3af3c3058	|upgrade db1033 to jessie and mariadb10		bug: t134555	change-id: iab1337f26748354be7d79ae65abc42ea285d1c1e	|mariadb: remove special ssl option multiple-ca		it was needed only for codfw s2 master to be able to replicate with ssl	with eqiad s2 master before the codfw switchover. not needed anymore.		bug: t111654	change-id: i0179dd84e102bdda0c0eec19e3a6294b934501ff	|planet: node regex to cover 2001 in codfw as well		in preparation of installing the equivalent of planet1001	in codfw"	 planet2001	" adjust which nodes are covered in site.pp.		same for the installserver setting and hiera cluster.		bug:t134507	change-id: i1b738883505e27c4fbee184b55db0cb779e9e2f4	|remove (almost) all references to db1027 on production puppet		bug: t135253	change-id: i1e1de9c8f4938d2f134016ec67e6938cb399bbf5	|notebook: introduce stub role		to make access control easier to provide		bug: t134716	change-id: i369f27db3ab3888c75515aa17fbbe98b1b206be7	|mariadb: change mariadb::core parameters		- change default value for the $ssl parameter to 'puppet-cert'	- remove the $p_s parameter"	" enforcing it always to 'on'		this is almost a noop that change to set the default values to the new	standard. only p_s is changed to 'on' for es1 shard in eqiad.		bug: t111654	change-id: i2a5013d39776fbb3c0c0f7bcd41f9adc707ed5e1	|mariadb: set $master true for codfw masters		- allow to set $master = true for all master regardless of the	  datacenter in which they are.	- start pt-heartbeat only for masters in the $::mw_primary datacenter.		bug: t134481	change-id: ic9d0de49c008f4fa740714baaf51b7a96ff6396d	|preparing configuration for new maps servers		some configuration has been dulipcated for each node. we will be able to move	those configuration back to hieradata/role/codfw/maps/*.yaml once the	maps-test* nodes have been decommisssioned.		bug: t134901	change-id: ic1d444b254761a5841bcd3ab83fe84e5f9510426	|purge labs dns/ldap code		we aren't using this anymore; everything is in pdns/mysql/designate.		bug:  t126758	change-id: ic184b8561fd4ae1aa1f22ee3469e3f2eacbae9c5	|remove argon from site.pp and install_server		argon has been replaced by kraz"	" removing from	puppet"	 icinga	 salt	" dhcp/netboot.		bug:t134223	change-id: i0bfec79d91e0cb7c170d97dcac6d053bc5c51438	|remove ldap/dns services from labcontrol1001 and labcontrol1002		bug: t126758	change-id: ia527ffb7b3c2d390beb6873e4ddada946827559c	|remove es2001-es2010 from production puppet		bug: t134755	change-id: i0385b6ff0bbdb781463e4bbf63af0257bc223c5f	|remove (almost) all references to db1058 on puppet		only leaving coredb.pp"	 marked as deprecated	" because it will be	soon deleted completelly.		bug: t134360	change-id: ia6e99a869dfdb1e0bad1a3064e1fb37e85538689	|prepare db1023 for reimage		bug: t125028	change-id: i9f661c4181f56eac41d252637106df15a5ec7be0	|remove base::firewall from stat1002 and stat1004 analytics cluster clients		when spark runs in yarn client mode"	" it will start up the spark	driver running locally.  this process will open up a random port	to listen on.  the yarn application master that gets launched	then communicates with the driver running locally on these ports.		i'm not sure how we can enable base firewall and still have this work.		see: https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/util/utils.scala#l1987		bug: t134422	change-id: i4368c69c116e55be381039aeab05e774fcea6754	|prepare db1058 for jessie reimage		bug: t125028	change-id: iccd5f0022dc9400a07610b268bc95b0249a004f0	|cassandra: add restbase200[789]		bug: t132976	change-id: i0c3294c16287daf5b73990ff80cacabbd4dacb8a	|add sinistra.codfw to site.pp		sinistra showed up in icinga with raid failure but wasn't in	site.pp yet. to clarify what it was installed for and to add	base::firewall and standard"	" putting it in there now.		service is not implemented yet.		bug:t128796	change-id: i847a9f66d067961c9f00ec98cc6fdfa70c9a0859	|enable kafka200[12] to host kafka and eventbus.		bug: t121558	change-id: ic6fb82300c38b81faf42c8000fa6362a328079d5	|config changes for db1038 (old s3 master) reimaging		- db1038 installer to jessie	- db1038 puppet to mariadb 10		bug: t125028	change-id: i0675517232ca9ee4558858e3bed2109b2d2f4fea	|add conf200[123] zookeeper service nodes in codfw.		we need to set up the new conf200[123] zk service nodes in codfw"	"	to the hiera variables should be specified in dc specific config files.	this changes should be a no-op for the services currently using zk	in eqiad"	" namely hadoop and kafka. the etcd role and config will be	added on a later stage.	the zookeeper_url hiera variable is also removed since not used anymore.		bug: t131959	change-id: i0374e492cb5ba22141b527ca5f832c7b5c073058	|rt: include standard in ununpentium		standard needs to be included on the node"	" it doesn't	come from the role"	" and we want icinga and all the things		bug:t123713	change-id: i353251eae2de42350d28591ade16f8def9cf0e53	|rt: add role on ununpentium"	 disable acme	" add ipv6		add the rt role on new vm ununpentium on jessie.		disable acme/letsencrypt setup until actual switch-over.	(see ib74ff6100d6c3e)		add mapped ipv6 address to interface.		bug:t123713	change-id: i7eece5e7fd872f7b699b4e716d77f5bf0941e7aa	|mediawiki: remove decommissioned appservers		bug: t126242	change-id: i8742579e8894ca226d2966dce8c22785d9b6f163	|cache_maps: remove cp104[34] test caches		bug: t109162	change-id: id1ecd23083330d080a5d8b178e7797a60590d6e2	|cache_maps: re-role old mobile servers		bug: t109162	change-id: i7eed33b610e2cacb404df50900626447ceb31f1e	|upgrade db1052 to new puppet core class + mariadb10 + jessie		bug: t125028	change-id: ie1ae8f7613bae2452f3f2f2946b848ee3e898344	|add install_server::tftp role on install1001		bug:t132757	change-id: i0c517fa1a880c97b64817c1e6e238079c355e8a4	|switchover: switch (s1-s7"	" x1) master role to eqiad		bug: t133205	change-id: ic8a0fa51450b7669efbc57ad867463793304bd65	|set db1031 as the local eqiad master and set it to row binlog		bug: t120122	change-id: i090db65562894e0889c5e8335f86f0e3a9646db1	|analytics1015 -> analytics1003 migration		bug: t130840	change-id: if1f3334f23170e1f5c9603e292d332086bc01549	|mariadb: complete tls and master configuration		- set master=false for eqiad masters (s1-s7)	- set binlog_format=statement for eqiad designated masters (s1-s7)	- use performance_schema on all mariadb 10 core dbs (s1-s7)	- use puppet certs on all remaining mariadb 10 core dbs (s1-s7)		bug: t111654	change-id: i951dd3f09ff79e851784e3a82e7a66adacdf334a	|add tegmen and einsteinium to site.pp		these 2 are neon-like monitoring hosts to run icinga at some point.	they were already installed and running puppet but not in site.pp yet.		bug:t125023	change-id: ie266ca34c5eb4427416b75879b82e016184f9acd	|include analytics_cluster::client and analytics_cluster::database::meta roles on analytics1003		bug: t130840	change-id: iac10d24a3edb6c071e30a66ec17864c5748aef3c	|add analytics1003 in netboot.cfg and site.pp		use raid10-gpt-srv-lvm-ext4.cfg for analytics1003.	it has 4 2tb drives"	 use raid 10 for redundancy and a little perf boost	"	lvm for mysql backups.		bug: t130840	change-id: ifc4163f081c174a512d11d66e62d73a3c946e6a5	|kraz.codfw.wmnet -> kraz.wm.org"	" needs public ip		this vm needs a public ip to replace argon.wikimedia.org"	"	running irc.wikimedia.org.		bug:t123729	change-id: if856dd6141499d41d33c2590eba22ad89600d3a7	|mariadb: fix pt-heartbeat for x1 codfw master		bug: t124699	change-id: ia64c04df70f9692b188ff6c612685489dd30b578	|statistics: rsync on stat1004 for stat1001 migration		add the existing class for migrating stat1001 on stat1004"	"	a new server with 7t of space"	" after talking with elukey.		bug:t76348	change-id: i43ab34f12da5ae79400d046b49e2a9429dfa3fa1	|mariadb: set codfw local masters as masters (s1-s7)		- set master=true and binlog_format=statement for s1-s7 codfw local	  masters to  become masters		bug: t124699	change-id: i4a07204323b0ffd5cbffb02e44587c4b61b2b49f	|mariadb: use puppet cert for s3 cross-dc replica		bug: t111654	change-id: ie7375d71a7c7e9f7b5bd50479c07a4f083b7174d	|mariadb: use puppet cert for s4 cross-dc replica		bug: t111654	change-id: ife31f36a914d106e0cfdc92fb3bbde2407477eb5	|bast1001: reorder includes"	" rm ganglia_aggregator		bug:t123721	change-id: i06130b07d6356d8c7ff0f6e4246cf6b92b44ed86	|bast1001: remove temp rsync for migration		bug:t123721	change-id: ib3313abef680ca5db79f707e9b068495ef8f256d	|bast1001: rsync home dirs back from tungsten		bug:t123721	change-id: ic9ac09b7578279b3de1dcf258a889d476c27e070	|mariadb: use puppet cert for s1 cross-dc replica		bug: t111654	change-id: iaecedea737ebd5d055ae3081810375da6c586c13	|add stat1004 configuration to site.pp		bug: t131877	change-id: i0c638dc8361ecadac34619d7ecf27f12fe974df1	|mariadb: use puppet certs for s2		use puppet certs for cross-dc replica for shard s2"	" with the optional	generated ca with multiple pems to validate the legacy certificate of	eqiad master.		bug: t111654	change-id: i11d9af0a19f797b2694e8b8df97ba60d7a5e3f8f	|mariadb: use puppet certs for tls		use puppet certs for cross-dc tls replica for shards s6 and s7		bug: t111654	change-id: ic438a9742c1b3e339eb024131683248ee868f2d2	|use tungsten"	" not osmium to copy bast home dirs		can't use osmium because the rsync module doesn't	work on trusty (created 2 tickets"	" one to fix rsync	and one to upgrade that server).		using tungsten on jessie instead.		bug:t123721	change-id: i9f441de76cf43d6f6c5e12b6f3c4bb524c6a4d45	|rsync bast1001 home dirs to osmium"	" temp for upgrade		bug:t123721	change-id: ia45622f073e593416bd3d91a778948b9e9eb11f8	|site/install_server: add kraz.codfw.wmnet		bug:t123729	change-id: i9326a350ba5bfad4d4efaf0c2262b78fd8a3063d	|don't use fluorine for rsyncd"	" conflicts		fluorine is already a rsyncd from another role"	" causing	puppet conflicts. we will use another host for this temp. thing.		bug:t76348	change-id: id8495744c131b051a99242e7a5c7f4b1777bfd0f	|rsync home directories for stat1001 upgrade		temp. setup rsyncd on fluorine to copy home dirs from	stat1001 to upgrade that server and then copy data back		bug:t76348	change-id: i44ddac9bdfb6776910f08fc83ab843b33fa39399	|site/install/dhcp: add furud.codfw.wmnet		setup a new jessie vm to run gitblit until it has been	replaced by diffusion.		so we can start by shutting down the physical server with precise"	"	antimony and get rid of that.		we put it on a separate vm rather than krypton because it doesn't use	apache and instead misc-web varnish directly talks to gitblit on 8080.		using codfw instead of eqiad for no particular reason besides balancing	usage of the ganeti hosts.		""furud"" (or ""phurud"" :) is the traditional name of zeta canis majoris.		https://en.wikipedia.org/wiki/zeta_canis_majoris		bug:t123718	change-id: id21376649365ebee3faa6589359eb146fd4f30cd	|mariadb: use puppet certs for s5 cross-dc replica		bug: t111654	change-id: i95ccfab1bb0abbe79938dfab7f15e77fc9f9c7f8	|introduce meitnerium.wikimedia.org		the titanium replacement"	" hosting archiva		bug: 131358	change-id: i0d7686ffc7438d049022cd5733fa6eb44a818751	|create new eventlogging::analytics role in modules/role"	" use scap for deployment		this is only the deployment of a new cloned repo to eventlog1001"	" it does not affect	the running deployment or daemons.		bug: t118772	change-id: ib37ec5a3aba1a9e018a700d4271b4930d4dc5472	|site.pp: remove hooft from puppet		bug:t123712	change-id: i97777920b37021f76ec4c21fb06c0feb43aed35f	|ganglia: leave aggregator on hooft until bast3001 works		amslvs1 doesn't boot into pxe.. sigh :/ leave the aggregator	for esams on hooft until bast3001 actually works"	" we don't want	ganglia to be broken for so long.		bug:t123712	change-id: i5c3bf03efc2c850b01d1df867be5cf2536ea9eb6	|site.pp: temp add hooft back as install-server		bug:t123712	change-id: i5457d5d5a27a280940d5996a26e8cd76ecebf929	|enable base::firewall on rcs1002		- port 80 is covered by ferm service 'rcstream'	- port 443 is covered by ferm service 'rcstream_ssl'	- port 6379 is covered by ferm service 'rcstream_redis'		the other services are only listening on localhost or are	covered by standard ferm rules.		bug: t104981		change-id: i358edbe4a1a14618de016c30b9be193042da44a0	|hostgroups: add missing dbs into the mysql cluster		- moved codfw db cluster configuration to hiera	- explicitely skipping es2001-es2010 because are queued for	decommissioning.	- removed unused cluster for external storage in eqiad		bug: t130819	change-id: ibed7cb42665e23a88e16cf15d6e35b39ac6add7b	|site.pp/hiera: rename hooft to bast3001		bug:t123712	change-id: ia5306686ae5a478330da1218686de4198c14e599	|mw:maintenance: also move mariadb maintenance class		the mariadb::maintenance class also moves from mw2090 over to wasat"	"	just like mediawiki::maintenance.		bug:t129930	change-id: idbee3dcba19ce3a2b3a150e26da2e8c2cfaea77b	|mw:maintenance: add role to wasat		add the mediawiki::maintenance role to new host wasat	to replace mw2090.		the backup things have been included in the role"	"	so they are not removed by this.		bug:t129930	change-id: i2ad3ece58f7435966beb7e6082a0e671a266b831	|mw:maintenance: move eventlogging from node to role		instead of directly including this in site.pp on the	node-level"	 move it to the mw maintenance role class	"	so that it gets installed on all mw maint servers"	"	also the new terbium-equivalent in codfw.		bug:t112660	bug:t129930	change-id: i373153770e0a61a34c155065fbd9cb4a6c496401	|mw:maintenance: move python-mysqldb from nodes to role		instead of installing packages directly on the node level (meh)"	"	and repeating it for the equivalent in codfw"	" move this package	install into the role class for mw maintenance hosts.		also reopened t84075 to check if we still need this at all since	it was called a temporary solution. not a problem to keep though	if we use it.		bug:t84075	bug:129930	change-id: i3529298c4427d8ba72dc36688e17237b2182c00f	|site.pp - introduce wasat"	" backup home dirs		add the new mw maintenance host for codfw"	" wasat.	make sure home dirs are backed up in bacula like	we do for its equivalent terbium in eqiad.		bug:t129930	change-id: i807aac9cb5560428f7db70ae49b449d089e3476a	|cp3019-22: decom from cache_misc		bug: t125485	change-id: i25598c480059cc5ea8ff8800b63f2df68943c0f0	|apply the role::ores::redis class to oresdb100{1"	"2}		introduce oresdb1001"	 oresdb1002	" assigning the roles::ores::redis class	to them and set via hiera oresdb1002 to be a slaveof oresdb1001		bug: t125562	change-id: i6a34ac7c176309475ca193294abe443836153121	|configure labsdb1008 for the first time		bug: t126946	change-id: i3aa483d9d2c7d4f3188346972757f9b4e379bf05	|add mysql_wmf::mylvmbackup define"	" use this for backups of analytics-meta mysql instance		mylvmbackup's prebackup hook allows us to define our own backup method.  this hook runs after	the lvm snapshot has been taken and mounted at $mountdir.  we rsync $mountdir to $dest at this	time.		bug: t127991	change-id: i6b0c6e0b819c837b8dbffc97be0c08ee4f66a452	|db: add db2008 to the x1 shard group		bug: t130098	change-id: i90c7d6e02b0afa60fb449fe92f3364c5405faf10	|add labstore200[3-4] to site.pp"	" like existing [1-2]		add labstore200[3-4] to site.pp"	" simply by extending	the existing regex.		i assume all servers are just ""role labs::nfs::fileserver"" like	before"	" but adding rush to confirm that.		bug:t128764	change-id: i8f40b73f32a5aa474c6d2093c9efc619bdf906ce	|mediawiki::maintenance: add codfw host"	" multidc support		as we need to run jobs within codfw after switching over mediawiki"	" we	need an host there. pick one large-sized appserver (mw2090) for the	duty; also make the cronjob presence depend on the local datacenter	being the primary.		bug: t126987	change-id: i004a15094b494bbe451dd0f17358645e04d1265f	|set rdb200[56] as part of codfw's job queues (rdb2005 master"	" rdb2006 slave).		bug: t129178	change-id: iccd2b8fd614929e0f2790c205b1e6411d27b3f2b	|remove vms cygnus and technetium		these 2 vms were just used temporary and are not needed anymore (soon).		bug:t118763	bug:t126012	change-id: ieb3128706fe7aa05fad56182704661aa92849b2a	|introduce the sc[ab] clusters in codfw		* add conftool configuration for services and nodes in codfw	* add monitoring configuration	* split the sca/scb dc-specific parts in their respective hiera configs	* mention codfw hosts in site.pp		bug: t129234	change-id: ia48bcb3c07a606e4949dbcb444ccb40de4a08f25	|enable base::firewall on eventlog1001		various ferm rules have been added"	" which should cover all incoming	traffic"	" namely:		- ferm::service 'eventlogging_rsyncd' for rsyncd	- ferm::service 'eventlogging-receive' for udp/8421	- ferm::service 'eventlogging-zmq-legacy-stream' for	  the zmq legacy stream	- ferm::service 'mediawiki-exceptions-logging' for tcp/8423		bug: t113343	change-id: id2c92b0138ad6c838b6d1c9adaa17913909f9f7e	|gerrit: install standard base on new server lead		also give gerrit-roots access now"	" since we're not ready for the	role to go here yet.		bug: t126794	change-id: if046ee0bf5171e92c7944cdeeb8449e809c912bb	|introduce hassaleh"	" hassium		bug: t129003	change-id: i4c6cdc2902d59637828eff00c15680e3f012feea	|mediawiki: convert mw2153-62 to be jobrunners		bug: t129062	change-id: id6fb181515e97f88ad710b0d1c2c19c9716ae492	|rt: add role to krypton		move rt to krypton. talked with robh	once"	" we agreed to just move it to vm	for archival purposes but stop running it on	physical hardware. same for the other service	on this server"	" racktables.		then magnesium can be repurposed for something else.		bug:t119112	change-id: ic616d4ca41ee69bf79c22f1ec1f08d13adb45d4c	|enable the new pt-heartbeat on core production hosts		after performing the schema change"	" enable the new heartbeat	(pt-heartbeat-wikimedia"	" including the shard) on all production	masters. as we only have the new role on s2 and es2/es3"	" and a few	other misc servers"	" it will not apply immediatelly to all servers.		setting s2-master in statement"	" as it is in reality.		bug: t114752	change-id: i73ebdd466c7ca3d04bce6dd773b4cef4c42969ee	|enable pt-heartbeat on all misc masters (except m1)		after testing the heartbeat functionality on m5"	" add it to all	misc shards. this a previous step to enable it fleet-wide.		the reason it is not enabled on m1 is because we require a	master failover there first to remove the legacy class.	it will be run manually there until we can apply the new class.		bug: t114752	change-id: i7334b182f3b14a5dd79c7db6ff6b33a79efbea71	|decom berkelium/curium		bug: t125962		change-id: i0880652e991d7760946464fb9e0c24f9919d16f1	|decommision db100[123] 1/2		minumum patch to make them dissapear from our infrastructure.		followup: https://gerrit.wikimedia.org/r/274076		bug: t124962	change-id: id2fcb6bb57ebf48e5908ec1b8da6ea5aa33e7047	|standard: move to own module		bug: t119042	change-id: i83015837c1db244126640c1716c103af600a7d82	|cassandra: add restbase1010-restbase1015 to site/install_server		bug: t128107	change-id: i4feb733e8388b4a4ddbba135674b4ba2f0e9cc6d	|ship elasticsearch logs to logstash		introduce gelf4j as a log4j appender to send logs to logstash. sending log	to logstash is disabled by default and is activated if	$elasticsearch::graylog_hosts is not `undef`.		* deploy necessary packages (liblogstash-gelf-java"	" libjson-simple-java)	* create symlinks from jars to /usr/share/elasticsearch/lib	* add necessary configuration to /etc/elasticsearch/logging.yml	* hiera config to activate this in labs (deployment-prep)	* hiera config to activate in prod/codfw		bug: t109101	change-id: i683bcb75c91e6c2f4dd648517435a477ab23c2a7	|set up dbproxy1005 for m5 load balancing/failover		it will default to db1009 (current m5-master)"	" failovering to db2030.		bug: t126251	change-id: i5194de4a346fa347d4c594e3452dfe2a7331097e	|cache_misc: remove cp1057"	" cp1070		bug: t125486	change-id: i2a2e2f8e90f71a35359799397e9b50a9e792ca3b	|cp10[56]1: upload->misc		bug: t125486	change-id: i93d871288a519b3939746b2af217c5379705c617	|move hive and oozie to analytics1015		bug: t110090	change-id: ifcabdcfe9d2d4213d28baa9ed16f35bd0f150c3c	|cache_misc: remove cp1056"	" cp1069		bug: t125486	change-id: ife86260a4bacd3e7dc1e30a3ecb50a4b1410ef72	|decom cache_parsoid		this removes all of the cache_parsoid configuration from our repo"	"	and moves the 2x eqiad cache_parsoid machines to the misc cluster	as part of the eqiad cache cluster rearrangements.		bug: t110472	bug: t125486	change-id: ie30f04f256831617f13bcd4b0ecba7af8727945e	|gdash: decom		https://gdash.wikimedia.org/ is a static mirror of the dashboarding webapp	previously hosted at that address. in october 2015"	" we deprecated gdash in	favor of grafana. gdash has carried a deprecation notice on the top of each	page since then. we can now remove it.		/var/www/gdash.wikimedia.org will need to be wiped manually on graphite2001	& krypton		bug: t104365	change-id: i48150a5c906299a6d0c51d661dbde62d201ef25a	|codfw: move cache_parsoid nodes to cache_upload		we've never actually configured cache_parsoid in codfw for real	use"	 and now with its impending decomission	" we can reallocate	these nodes to the upload cluster where they're more-useful.		bug: t110472	change-id: ic176fb5d9b118b6c2357e76fe30aebc285a00a0c	|mariadb: add new es2011-2019 servers		add new external store servers in codfw:	- es1: es2011-2013	- es2: es2014-2016	- es3: es2017-2019		bug: t127330	change-id: i5166154dbcfbd14673bda16e9cccaed5ac37643a	|move burrow role to kafka/analytics		note that this commit removes the last manifests/role/analytics/* file		bug: t109859		change-id: id19308159659c84d480fe5aa02356438d6c50da1	|remove unused anayltics role from analytics kafka brokers		bug: t109859	change-id: ife8577ec2310aa82ebbb66b546b69dfecc630c29	|remove some unsed role::analytics::* classes"	" more to come		bug: t109859	change-id: i5b5cb1bcb42062fe0d124403ac3033ae6edad2f9	|apply new analytics_cluster role to analytics1027		bug: t109859	change-id: id7294fd7ffd076e7a44f6e8695cd4d5be6b85b12	|create refinery classes in analytics_cluster role"	" apply them to stat1002		also move the analytics::users class to the analytics_cluster::users class"	" this	is applied on stat1002 and analytics100[12]		bug: t109859	change-id: i4e8278e6efe1f7515f149a62f55330586a92a50a	|s2: bye bye coredb; hello mariadb 10 with jessie		bug: t123525 t120122	change-id: ife1ff8781cd948b9c4ebd9a604eccca023db2709	|use new analytics_cluster::hadoop::worker role on all hadoop workers		bug: t109859	change-id: i915b60edb2e36e5c061eb96904d915ff410531be	|use new analytics_cluster::hadoop::master role on analytics1001		bug: t109859	change-id: i444a5b1b44deafa73efa8e748fa44db5f5cd88f2	|apply new analytics_cluster::hadoop::standby role on analytics1002		bug: t109859	change-id: i9341cce2107657434e7de40a0068a98cb16dac4a	|include new analytics_cluster::hadoop::worker for testing on analytics1057		bug: t109859	change-id: i8c7d041002553e74a5e4011c85f9f053a7a18936	|include analytics_cluster::client role on analytics1026 for testing		bug: t109859	change-id: id1653f1fc58d1f76818551d4dfd3d429c5b18fe1	|otrs: update site.pp"	 mendelevium	" remove iodine		bug:t105125	bug:t126483	change-id: i00c9f4de4ae1f04e9c069cc1b180814e91089240	|upgrading phabricator mysql setting for db2012		while maintaining defaults for other phabricator (m3) databases.		bug: t126209	change-id: i3e899fd1ab691738fdf16fb3a0188068da8c38e4	|cache_mobile decom: 2/2 remove most cache config		after this we can manually stop various daemons on these hosts and	leave them idle (but still configured with ""standard"") for a few	days until they're re-purposed.		bug: t109286	change-id: i51354c8abc76c480146f61210cb4f8f55e889a7d	|cygnus/technetium: install nmap"	" include standard		cygnus and technetium are vms for pentesting frack.	sets up a stub class to install the requested nmap.	includes standard on these instances.		bug:t126012	bug:t118763	change-id: iaff5d643680ecc04ecb0fed03d0ca3e81fa9283e	|decom: remove rsync_caesium role from site.pp	bug:t125165		change-id: ie190021d7acd7e159816349f5c161dff11b898a3	|unpuppetize impala in analytics cluster		bug: t125141	change-id: i6c53af2944a100073fb1e18c5d7b355ad2e7fdc3	|decom: remove caesium from site.pp		bug:t125165	change-id: i4750c27d4852d56ea020e582912104e46b5d7d92	|fix for analytics-search-user changes		can't include admin::groups in multiple roles		bug: t122620	change-id: i486a11dba9100595474d8ab5c28121e6a25c3bce	|include role::elasticsearch::analytics on hadoop namenodes and stat1002		bug: t122620	change-id: i582fa9243e4c59fcc140669d3116ec9640190c2a	|create new puppet group analytics-search-users		creates a new puppet group for deploying search related analytics	tasks to the hadoop cluster. sets up trebuchet to handle deployment	of the repository to stat1002 and sets up a user for use on stat1002	to deploy into hdfs.		bug: t122620	change-id: i3cca84f0b8066a4ba2c941c1edf8afc264b36b64	|releases: setup rsyncd to copy release files		temporarily set up an rsyncd on bromine to copy	release files over from caesium for migration.		bug:t124261	change-id: ieba88211506dcdf9d313542f5d4a7b02664f2841	|add alert for elasticsearch 50th percentile prefix search time		typically prefix search is around 10-30ms. if it hits 75 or 150ms	there is almost certainly something wrong that should be addressed.		requires adding discovery-alerts@lists.wikimedia.org to the private	puppet repo containing alerting email addresses (contacts.cfg)		bug: t124542	change-id: i9c7b79f7af221c0d32ba1c6baa39c55f1bc92d8d	|releases: add role on bromine		adds the role for releases.wikimedia.org to	bromine"	" ganeti vm for misc. static sites.		replaces physical server caesium.		bug:t124261	bug:t123714	change-id: i5b72d5f75ed6c2989eff279433b502b76e7b01de	|decommission:remove nitrogen from puppet		bug:t123732		change-id: i231e508807b2d8b585b00d65fe1fc09d41d34e46	|ruthenium: remove rsyncd"	" was for upgrade only		the rsyncd was just here temp."	" to copy data back	and forth during the server upgrade to jessie.		bug:t122328	change-id: ibf1201839e2f11340c90c7db40438bacd55adc86	|parsoid-testing: rename classes with dashes		puppet classes should not have dashes in their names per	style guide and lint. it just doesn't show up as a jenkins	warning currently because we disabled that check in the global	puppet-lint.rc.		recently we renamed all the remaining classes	using - and replaced it with _.		these classes are a one-off now.		bug:t93645	change-id: i481156af14595872117f933e320574fa7d2a3213	|ruthenium: switch rsyncd setup over from osmium		after having copied data from ruthenium to osmium	and reinstalling ruthenium"	" now we need to copy it back	where it came from.		bug:t122328	change-id: ia84d168baa97a5ba740805d2b07bfbb77146c520	|adding new parsercache machines (pc[12]00[4-6])		bug: t121879	bug: t121888	change-id: i9f0cf2bb065f985a0c7e8ebb86cafb8edc9bc3ea	|add url-downloader in codfw on alsafi		bug:t122134	change-id: icf6e5eb339bd34a80751c457d96634842fcbdf0b	|rename labcontrol2001 to labtestweb2001		there were some stale refs to  labcontrol2001 in heira; they	aren't used but i pointed them to the (existing) labcontrol1001	anyway.		bug: t123790	change-id: iee342f8939ede559c6405443a8efad03fb5f98c6	|remove gadolinium"	" erbium from site/installserver		bug:t123029	change-id: i4e1dd35f7f4ea5b6b3f48b79a3d2a0c059363535	|make testreduce generic and instantiate parsoid-rt services		* testreduce is used both for parsoid-rt testing and parsoid	  visual diff testing. in the future"	" it will be used for	  other visual diff testing.		* define instantiable testreduce::server and testreduce::client	  services.		* create a parsoid-rt-server and parsoid-rt-client roles.	  right now"	 ruthenium runs both	" but this is not going to be	  the case for long. we are going to move them to different	  nodes.		  copied over some of the files from ruthenium into the	  puppet repo. later patches can improve on this and	  make some of these hardcoded files templates.	  but"	" good enough for now.		* later patches will create generic visual diffing modules and	  use the visual diff and testreduce modules to instantiate the	  parsoid visual diffing services.		bug: t118778	change-id: i4af27c21f31c9ab5b4fd351dd948866cc3604433	|site.pp: add alsafi.wikimedia.org		this is a ganeti vm and going to be an url-downloader	for codfw.		bug:t123386	change-id: ic4cedc439d25a2735daaf7ea3cc44bd869ddd7e8	|reconfiguring db1050 after cloning		bug: t105879	change-id: icf3e1145aea4f806351bdcc0a369f4cea5e1c246	|add piwik role		* provision behind misc-varnish as piwik.wikimedia.org.	* restrict access at apache level by using mod_authnz_ldap.		there is no piwik module yet"	" because piwik is not configurable from the	command line. going through the web installer is a requirement for setting up	the database. the only alternative is to make puppet import a dump of an empty	(but fully initialized) piwik database"	" and we don't have good abstractions for	that.		bug: t103577	change-id: i136ab0a38339544f461a73154d1e4ad5a0679b0e	|bohrium: set up dhcp/pxe and site.pp parameters		bug: t116312	change-id: id2869300152eaa151aa117baa08c1c9f81526c71	|using more generic roles for kafka classes"	" configuring new main brokers kafka[12]00[12]		this will eventually also deprecate role::analytics::kafka::* in favor of role::kafka::analytics::*	role::kafka::analytics::* is not yet included anywhere"	" but will be after this puppetization	is applied and verified to work on the new brokers.		bug: t120957	bug: t121553	bug: t121558		change-id: ifec423daa5d9b2a3d3e6e4b0bd12dda5639b8594	|convert mw1162-1169 to job runners		follow-up to i37797dd69"	" which speculatively converted mw1161. that went well	(see task)"	" so i'm going ahead with the rest.		bug: t121549	change-id: ie5a79a8c17df6e5af72c60d32b4dab39052f4988	|convert mw1161 to a job runner		converting an app server to a job runner should be seamless and not require	re-imaging the server. test that by converting mw1161. if that goes well"	" i'll	proceed to convert mw1162-69 as well.		bug: t121549	change-id: i37797dd692565a1a1b2f2d7e74d61df6bde6117c	|apply ipsec associations to kafka brokers		bug: t92602	change-id: i8b25106cbb55dfd7ed596ba8eb037ff118753c00	|openldap/labs: make serpens/seaborgium backup hosts		to enable backups on these hosts"	 as requested in t120919	"	add backup::host to the nodes first"	" which installs bacula.		after this"	" backup::set's can be added to backup specific paths.		bug:t120919	change-id: i5be0f97bd325f9195dffb808b524bbd9b6ad57fd	|remove gadolinium related udp2log and varnishncsa stuff		bug: t84062	bug: t118325	bug: t97294	change-id: i85c32f7e88c02ce5848028b8e68611660de62989	|disable analytics1026 misc (sqstat) udp2log instance"	" remove sqstat and udp2log		cleanup will be done manually.		bug: t117727	change-id: iff1a586eed2fbbba997d4a6ad399c9ae9f009bff	|site: introduce cygnus.codfw.wmnet		this is a ganeti vm in codfw for t118763	along with technetium in eqiad.		bug:t118763	change-id: i164fbbc9008b437c64be379ed7d58aec3e7f1ddd	|site: add technetium.eqiad.wmnet		adds new ganeti vm as technetium.eqiad.wmnet	with role spare which includes standard and base	firewall and makes sure we use the role keyword for debdeploy.		bug:t118763	change-id: i2b939596a1ad53cf4641f9f5af036a65ce86b89e	|add ipv6 for argon (irc"	"mw-rc streams)		bug:t105422	change-id: i99a3ed941804c981c8c3da4cd57f04456bba104b	|turn off services on labcontrol2001		dns has been moved to labcontrol1002.	this was configured as a salt master but never had any working clients.		bug: t118591	change-id: i6f52cb27e99a7a7e89e5963b78c01b46e7c3d0e0	|ores: move monitoring to icinga		when this was in the ores module itself	the virtual host never got realized on neon/icinga.		moving this into icinga itself and it works.		bug:t119340	change-id: ic7dd3e355322454bb1ae7081da61fc7248e5a851	|phabricator: make iridium a backup host		bug:t120045	change-id: id02010fa3441922f5ff4ad61e207569d3c27a25b	|ores: add paging icinga check for home page		bug: t119340	change-id: ie6bf0aafd70f882ef0b2c6750f657349050b063e	|labcontrol1002:  consolidate role lines		bug: t119762	change-id: if6e177bcfd37b0755cacf98bdfff4bfb387950d7	|put an ldap-based dns server on labcontrol1002.		this will be temporarily named labs-ns1placeholder"	" but soon will	become the new labs-ns1.		bug: t119762	change-id: ida1011eed93cdee8cc53affa09956f32a22d7456	|misc-cluster 2layer refactor"	" step 2/3		this adds the misc role to the intended machines at other	dataceters"	 adds ipsec connectivity between them all	" configures	the tier-two backends to use the tier-one backends"	" and strips the	backend vcl of frontend-only code.  at this point the backends at	all tiers should function correctly"	" but the frontends still	aren't making use of it.		bug: t119394	change-id: i56eb2b93307089a4547e255534fd41d4cbd5f97b	|remove role::logging::udp2log::erbium and friends		fundraising's udp2log is gone now. remove:	- role::logging::udp2log::erbium	- misc::fundraising::udp2log_rotation	- nfs::netapp::fr_archive	- role::logging::kafkatee::webrequest::fundraising (this was for testing)	- statistics erbium rsync cron jobs		needs manual cleanup on erbium.		bug: t84062	bug: t118325	change-id: i8a7884fd72e5bbe11da6643a4d9823fb65ea254c	|switch primary designate host to labservices1001		for now"	" use holmium as the secondary for dns.		bug: t106303	change-id: i9e1a29d4a70379f056eeb8a0c7e6fe4c33deb556	|racktables: remove role from magnesium		racktables has been moved to krypton.eqiad.wmnet		bug:t105555	change-id: ife746678a99de0b35b2906f9e302bc8a9f0eab79	|removing all entries regarding analytics1003/4/10 bug: task tt118572		change-id: i8056938d8dc99e1f24ab446f2f078ed6b2e9075f	|introduce seaborgium and serpens		2 ganeti vm hosts meant to replace neptunium and nembus	also collapse the neptunium/nembus entries into one		bug: t118726	change-id: i1c0cfc04bf3543e30081a2b93b58168148e6c162	|remove reference to eventlogging/eventlogging for deployment		eventlogging python code is now deployed from eventlogging/eventlogging"	"	which does not include the mw php  extension.		bug: t118863	change-id: i18f5269b4c81b75afbd4c6c4259d19f0327a717e	|include role::labs::instance in labs via puppet		this allows us to get rid of this from ldap / wikitech list	of options		bug: t101447	change-id: ibda5b81bfb7ce3c82399057d4a0ba4b61f3eff7c	|netmon: remowe webserver::apache		none of the services use webservice::apache::site anymore		bug: t118786	change-id: id275bc20d2996b0e4f70c3a41925f3accd5621a5	|remove plutonium from infrastructure		going for reclaiming to spares"	" removed from:	* site.pp	* netboot	* dhcp	* ferm rules		bug: t118586	change-id: icf8b4fbc835787db59507ce5c2c96242779f3355	|add redis::instance		round off a series of patches to make the redis module capable of provisioning	multiple instances by finally a redis::instance resource"	" which uses systemd	unit template files to provide a concise and integrated mechanism for	provisioning and managing multiple redis instances.		temporarily provision two redis instances on pybal-test2003 in ganeti to test	this.		bug: t100714	change-id: i3419de0efd4123cb5e5a41e90d27b9f340383496	|introduce dubnium.wikimedia.org		as a vm and a replacement for plutonium.wikimedia.org. assign same role	for now		bug: 117183	change-id: i6f0a4cbce85e3cb835c5195275431d5d89b872de	|tungsten: re-add to puppet"	"install as testsystem		tungsten has been used for graphite in the past"	" then	got removed"	" reclaimed and re-reclaimed as a test system	for the performance team.		bug:t117888	change-id: i00d7c76368ba9b4174ec4939a3c9f2d47ae3a626	|removing all lead polonium entries: site.pp entry role is spare but removing all together"	" updated smtp hosts to mx1001.wikimedia.org for hierdata and analytics.  bug: task t113962	change-id: i5f75d11723ecdf00734a1f876f82eb12ae7d8b34	|peopleweb: remove role from terbium		this role is now on rutherfordium.		the backup::set is set in the role now instead	of the node.		bug:t116992	change-id: ie7702f43f23dac70dac61152ffbd0340b9a81c55	|peopleweb: backup home directories		/home directories should be backed up by bacula	on servers that serve public_html for all users.		set the backup::set in the role"	" while backup::host	still needs to be on the node in site.pp		bug:t116992	change-id: icdd9c67e54da45f2a82f0214e37f5642d3a585ce	|deploy the new db20xx databases with the actual shards provisioned		this is the final distribution:		s7	======	db2029 (m) b6	db2040     c6	db2047     c6	db2054     d6	db2061     d6	db2068     d6		s6	======	db2028 (m) b6	db2039     c6	db2046     c6	db2053     d6	db2060     d6	db2067     d6		s5	======	db2023 (m) b6	db2038     c6	db2045     c6	db2052     d6	db2059     d6	db2066     d6		s4	======	db2019 (m) b6	db2037     c6	db2044     c6	db2051     c6	db2058     d6	db2065     d6		s3	======	db2018 (m) b6	db2036     c6	db2043     c6	db2050     c6	db2057     d6		s2	======	db2017 (m) b6	db2035     c6	db2041     c6	db2049     c6	db2056     d6	db2063     d6	db2064     d6		s1	======	db2016 (m) b6	db2034     c6	db2042     c6	db2048     c6	db2055     d6	db2062     d6	db2069     d6	db2070     d6		bug: t84428	change-id: ieae74a18437b6fe8b4b4b05a77a3e7114ab9d316	|redis: install two additional redis servers		these are old lsearchd boxes we're repurposing temporarily"	" while we	wait for the new hardware.		bug: t117916	change-id: i7c2263aeae2dd38f3066b8dedeaca944cf64d2c4	|fully deprovision tungsten		bug: t97274	change-id: i5dbec26cae171799f944231c915daa8f595ce57a	|terbium: move mediawiki monitoring		bug: t116728	change-id: i299e49da8b5563a44c989928c4c47697ef7eb614	|peopleweb: add migration class to rsync homes		adding a migration class to add an rsyncd on rutherfordium"	"	which we can copy the terbium home dirs to.		bug:t116992	change-id: i953dd86d95ba6028e2335995c0d8e94b4adcd4a9	|rutherfordium: include peopleweb role		include the ""peopleweb"" (people.wm.org) role on	new vm rutherfordium.		the ""standard"" include has moved into the role itself.		bug:t116992	change-id: ic8494ffaf1ac6d8e19903f3e3f3621cbd7979b98	|introduce rutherfordium.eqiad.wmnet		bug:t117517	change-id: i5ef4f7a68959d1c43499fed0cb4f7b2f98347366	|hafnium: switch from public to private ip		along with the dns changes to switch hafnium to a private ip.		needs to go in the right order to switch the service / reinstall the server.		bug:t117449	change-id: i72b62bb5269f173b4c50fd5a68bb1bb7a530c116	|swift: add new ms-be machines to eqiad/codfw		also restrict the node definition in codfw to cover only known machines		bug: t114500	change-id: iae76a273cc49203fd040baeedd9da91c7e3560de	|use one node definition for both tin and mira		both deployment servers should be identical		bug: t95436	change-id: id4de0e218945b7cf5444c5d05713fb076d295448	|burrow: add new module for burrow		burrow(https://github.com/linkedin/burrow) is a consumer lag	monitoring tool for kafka"	" it will monitor the consumer groups on our	kafka clusters and send emails on their status.		this patch installs and runs burrow on krytpon.		bug: t115669	change-id: iaf6b2ee804df8f5e951fc7ced770b2565e3adb65	|enabling performance schema experimentally on db1022		db1022 is currently depooled. solify its configuration to	enable performance_schema running on it.		if the test works successfuly"	" we will enable performance_schema	by default on all hosts"	" but we need to measure (performance)	regressions first.		bug: t99485	change-id: i068dd8181f991dd5cb90a232f46595645fe086d9	|mw1152: convert to be the hat maintenance host		bug: t116728	change-id: id61a7310de5c1e878414ad5d689c183b67aab7b8	|r::mw::maintenance: include role::mediawiki::common		bug: t116728	change-id: i080e553373cc23f71af7637987f2839c2a60cadb	|tools: make main page check in icinga		can be made paging after testing to make sure it works		also move the nfs check to a more appropriate place		bug: t116925	change-id: i35c5bfe8941a509a2c92283e82208868e19e0e87	|replace dynamic gdash.wikimedia.org with static mirror		we migrated from gdash to grafana (https://grafana.wikimedia.org)"	" but gdash	continues to receive some traffic"	" so keep it around as a static mirror.	i will manually remove remnants of the old class from graphite1001.		bug: t104365	change-id: iac5d238ca9a06b8029e9f4187fbb3a63a6acbdfa	|adding new installed servers to the mariadb::core role		as we have not decided yet its shard"	" setting temporely to shard 1.	removing previous placeholder definition.		bug: t84428	change-id: i065613c5b5221e0b115c811a0d381c975985584a	|enabling performance schema experimentally on db1018		db1018 is currently depooled. solify its configuration to	enable performance_schema running on it.		if the test works successfuly"	" we will enable performance_schema	by default on all hosts"	" but we need to measure (performance)	regressions first.		bug: t99485	change-id: i0e3e36efb8338209717ffaadd8b46d945017d94a	|analytics1017 is now also a spare		i will remove hadoop related packages manually now.  this node will be reinstalled	before its reuse anyway.		bug: t112113	change-id: ice829ee412ab7236ac55da9cc584a07b8fe1054d	|mark old mxes as spares		bug: t115489	change-id: id47d9ed2ffea6860700e649bdeec5e109452168c	|migrate initial manually configured debdeploy grains to values read from hiera		bug: t111006	change-id: i6a933ddf02722d555736fe4104f2707efe0c0d7d	|consume eventlogging validation logs from logstash		add a new ::role::logstash::eventlogging class that can be used to	configure a logstash server to consume eventlogging error events from	a kafka topic.		bug: t113627	change-id: i4d8ddc877d146fef3fbde850c53bc97e90ebe21a	|ishmael: remove module"	" decom service		the service 'ishmael' is broken and not really used.		i asked the dba(s) per ticket. we can remove it completely.		bug:t109777	change-id: id1ecdf8dfbf12aab853389192c9e327750eb814a	|mark salt grain bool values with # lint:ignore:quoted_booleans		it looks like we need these quote marks"	" alas.		bug: t113783	change-id: i71aacede537d14d71ea9ae25a262378382476d3f	|videoscaler: reimage and rename tmh1002 as mw1260"	" upgrade to hat		bug: t104747	change-id: i7380629a165190509b86fbf6cf59936971503a41	|populate labsdb1004 with mariadb		labsdb1004 intends to be a replica of labsdb1005 in order to	provide at least hardware redundancy.		labsdb1005 and labsdb1004 will be populated with a very similar-	to-production puppet template for mariadb"	" including software	installation"	" dependencies an minimal configuration files.		toolsmaster.my.cnf has been renamed as the configuration will be	the same on both hosts"	 except for the role	" prompt and read-only	status (labsdb1004) will be in read-only mode.		data and replication topology is on purpose not done in puppet as	that would risk data integrity.		replication monitoring is not enabled yet.		bug: t88718	change-id: i643de5d9fcca2e6f68987821e068ad63fe55298f	|deploy eventlogging to terbium		bug: t112660	change-id: i0407791185910b6c8f74ed3cc698118227ee4db5	|remove home_pmtpa and svn client from bast1001		both of these need to be manually cleaned up.		bug: t113265	change-id: id393ad19fbfabc9ddf486f8f788c807a596aaa55	|add ipv6 for ytterbium (gerrit)		adds a mapped ipv6 address to the first interface on server ytterbium (gerrit).		ia871b6ff4f363a99b adds the aaaa record		bug:t37540	change-id: i5190f79d89fd114033edfa08e682374164b64506	|elasticsearch: new role for labsearch cluster		bug: t113282	change-id: i6955a2131d3aa1e425d1ced7ca481263f457ba1a	|elasticsearch: actually provision nobelium		bug: t113282	change-id: ia48db169dfca9b669a93532c3725a538ad9b6933	|elasticsearch: setup nobelium with standard roles		allows standard user logins and such		bug: t113282	change-id: id4a22502d14b03e8e9fc71aefd1cf4b8da80b5e3	|cassandra: add codfw production hosts		bug: t108613	change-id: ib778e9ec74e6cb7634d56f6bdb711b7a0d9f577b	|enable ferm on oxygen		the logging::kafkatee::webrequest::ops role doesn't need any ports covered	in rules"	" so we're fine with the standard ports as provided by base::firewall.		bug: t83597	change-id: i6ba2ae1c7cce2f1861a2c1305acb73c82344f9f0	|enable ferm on remaining snapshot hosts		move the base::firewall include directly into the role now.		bug: t104991	change-id: i280dc1ddc98ba489af3eb52b66089654d197d79b	|remove sodium from puppet (spare/decom)		bug: t110142	change-id: i6f04b2bcd86519921edf3ed3c4d452fbedaaf2ff	|add mx1001/mx2001 as role mail::mx		bug: t113211	change-id: ia6d3a5676eabbedc8239b1a0201ac43b447c6aa5	|fixup lvs1007-12 eth0 netmasks		bug: t104458	change-id: ia2b55d1f47d8734614438759e914e99140265ccf	|fixup lvs1007-12 eth0 vlan ids		bug: t104458	change-id: i1a25511a16230a36e74d30b5b7b50559e8f77429	|rename analytics1011"	1016	 and 1019 to aqs1001	1002	" 1003		remove cassandrahosts-12hdd.cfg"	" this didn't work.		bug: t111053	change-id: ic6c18797e1c196c4bb2dd0dc8bc6e1727b3dc718	|videoscaler: reimage tmh1001 as mw1259		bug: t104747	change-id: i118cefb17e2cebcd282e8d9c2b6250a34adf0fd9	|deploy eventlogging code to stat1002		bug: t112660	change-id: i16db6b739bcda45c49892cd0a14d4bcac4d9b638	|include standard temporarily for new eqiad lvs		bug: t104458	change-id: i9d85e6dcf5d17fd734aa3aa3c07bda4175ab54cf	|disable lvs::balancer on new eqiad lvs for now		bug: t104458	change-id: iff11a715d35e8e339c170ae820586b1c51c79b87	|lvs1007-12 basic puppetization		note this doesn't place them in any traffic class or assign them	any production service ips.		bug: t104458	change-id: i340b18a6afb5c5ab1dfde7734fb48e5cc8e2e60e	|move mediawiki maintenance scripts to module		- delete misc/maintenance.pp because we want to get rid of the entire	misc/ if possible.		- rename it to mediawiki because all these are mw maintenance scripts.		- move it into the mediawiki module in separate files.		- instead of all the inclusions in site.pp put it in a small role		- move files from files/scripts and other random locations into module.		bug:t88597		change-id: ie13bd7a80d8dd850cc93103aee174c15e5de469d	|puppetize mysql/mariadb server on analytics1015 in prep for moving hive and oozie		bug: t110090	change-id: i8fb17717aa8fcc3c8f3e93d28f0e46a8fdffc051	|remove analytics1011"	1016	" and 1019 as hadoop workers		bug: t112113	change-id: i0449d9ca684626f946a7fe099d5ddab84a16e024	|turn off varnishncsa udp logging for eventlogging		bug: t106260	change-id: ic2ed59f60fe6885d79998fe4a0ef1a7c970d1f29	|remove eventlogging multiplexer"	" forward kafka eventlogging events to zmq port 8600		this consumes from kafka eventlogging-valid-mixed and forwards all events there	to the zmq port 8600 for backwards compatiblity.  once all perf teams use kafka"	"	we can turn off this service.		bug: t106260	bug: t110903	change-id: i55a9014fa360e6ac83a764254bd2e65eacd17677	|cassandra: add restbase-test200[1-3] spares		bug: t111382	change-id: i02a1a487487912ca57cb632d733f75fa83d6b763	|remove eventlogging zmq based monitoring		all metrics are now obtainable via kafka jmx		bug: t106254	change-id: iebab33c929cbb769a3133143702040586e3ce231	|puppetize eventlogging on kafka server-side-forwarder on eventlog1001		remove this forwarder from analytics1010		bug: t106260	change-id: iacb8e92b846b3414589d57ba55b1bf88eaae3808	|introduce mendelevium to the cluster		bug: t111532	change-id: i213a17c126b2f6e437a4adf6a7349d68e4fb682b	|document bug t111586 in a comment in site.pp		change-id: i53871edfa179af852188c50314f6e0fe08be74ce	|remove etcd100x from manifests		shutdown for some time now"	" unused		bug: t110030	change-id: iaa4f21e247690bcb52d60f86899f121e36e40c74	|policy.wikimedia: remove puppetization		this site is hosted at wordpress.com instead of our own	servers now. so the puppet config is not actually used.		bug:t110203	bug:t97329	change-id: i7df25c323669a30af34293f52eb444eafe51bd31	|enable ferm on initial appservers		these two systems in codfw don't serve user-facing traffic"	" but we will	still be able to spot potential omissions in iptables rules during	deployment"	 logging	" analytics etc.		bug: t104968	change-id: ib37005b78bb3fc67d1650dbdaeef33e3b18a5ea6	|puppetize multiple kafka eventlogging processors on analytics1010		bug: t104228	change-id: i9c9514e5461e3c34c608fb0543b1a3f7a21df836	|mailman: use role-based hiera lookup on fermium		we need to use the special ""role"" keyword here not a	regular include or role-based hiera lookup won't work	and we are getting ""could not find data item mailman::lists_servername"".		also compare to sodium.		bug:t109925	change-id: iad3d8901168100d8a0ac5e6892d79700c04c7a1e	|mailman: apply list role on fermium		bug:t109925	change-id: icee8d71cc6bbc0cf70409ebec4db5d86bd364d65	|decom analytics1021 as a kafka broker		it will be repurposed later.		bug: t106581	change-id: i753b0d85c10535cb5c75b469f8d90bf4c0b02dc8	|reorganization of new external storage nodes		this is needed because i only had the location of 4 of these	on my first commit. with this arrangement (see	https://phabricator.wikimedia.org/t105843#1578897 )"	" we should	maximize ha within each shard and for each master.	only es1011 is fully installed (not moved)"	" so it won't affect	them.		bug: t105843	change-id: i9b34fe275526e6b5cb1ceb6fed52bc34d23ddbf7	|adding new external storage nodes as mariadb::core		4 new machines have been installed.	es1011 and es1012 are on a2.	es1017 and es1018 are on d1.		es1011 and es1017 will go to shard es2.	es1012 and es1018 will go to shard es3.		bug: t105843	change-id: iae0ef8330ff8b2f15fe80ffbc58e04e6bd0d7099	|add ipv6 for antimony (git web)		adds ipv6 address to node antimony which hosts git.wm.org (gitblit)		i8556322526c1e5 adds the aaaa record		bug:t37540	change-id: if43d868ad6f508902f1b0e276225bc55a3ece3af	|dhcp/puppet changes for fermium's public ip		fermium gets a public ip. fix dhcp and puppet		bug: t109923	change-id: i268ff6be75ce88c94bcf0a82b67f4d999eca5bc5	|repuppetize kafka1018 as a broker		bug: t106581	change-id: i35857cfe3e822fd5fbcf6ccfbf5bdd9d2c3b0ca3	|rename analytics1022 -> kafka1022		bug: t106581	change-id: i3ec4da5d917ad01ae944d9118c344b9dfb5f73b1	|videoscaler: reimage mw1152 as an experimental videoscaler		this will be running on trusty and hhvm"	" with the jobrunner service	initially disabled.		bug: t104747	change-id: id371e7c193ca369b6e6b2841aadd73ae0a665548	|puppetize kafka1012 as kafka broker in analytics kafka cluster		bug: t106581	change-id: i152d9fcfe012295bac46323e7607b2f93c91fab5	|rename analytics1012 to kafka1012"	" site.pp puppetization coming in separate commit		bug: t106581	change-id: i4810665bd1691b0a6dc78c17ecccad13a0907c7e	|zirconium: decom"	 rm from site.pp	dhcp	"netboot		zirconium can be decom'ed/reclaimed"	" all services have been moved		bug:t105510	change-id: i6eeb808e5894928976520d9721a2129ca986ccb4	|grafana: remove role from zirconium		bug:t104946	change-id: i539193caaf0fca2d9bc6a9ffb367d795109b18e4	|add cache_maps and related lvs config"	" using cp104[34]		bug: t105076	change-id: if05c07a32e89c8c5ec73716281cf4526943f5b7e	|introduce scb100{1"	"2}.eqiad.wmnet		have scb1001"	 scb1002 install as jessie and an exact copy of sca1001	"	sca1002		bug: t107287	change-id: i599daa51b2b2e4078786dcf5a3d9e758973ff277	|fermium: enable in site.pp"	" include admin		bug:t108070	change-id: ic4272748d3a066f8bc38d6c3d2fa068dd7ae325e	|fermium: comment from site.pp"	" just defaults for now		we just want the base defaults on first puppet run on a vm"	"	not add firewalling initially.		bug:t108070	change-id: i3921143b577722bc26c7975f3ae8e7f48fefe540	|fermium: add to site.pp"	" add firewalling		bug:t108070	change-id: i361c9387eb7109b8f8299bfd5041d4682c34b330	|rename analytics1013"	1014	1020 to kafka1013	1014	"1020		the other analytics kafka brokers will be renamed during reinstall next week.	i am keeping the original numbers here because some brokers are already	assigned broker_ids based on their node numbers"	" and i cannot change	broker ids.		bug: t106581	change-id: i35c76e3690672b114f41169dc3ca05ae23708d71	|bacula: enable firewall on helium		bug:t104996	change-id: i0f143812fa72617ac6da0d2a738359a1947224db	|old eqiad bits hosts -> cache::misc role		bug: t86718	change-id: i68f027f25d3adc53ad0f57579a1e9cc3d92a2da7	|remove cache::bits role from bits-cluster hosts		move them back to standard for now - they'll be reused in a	different cache role fairly soon		bug: t95448	change-id: i7a8d9a54792ae4a15eec3356a4f7cecc569ca87e	|labs: setup /srv/statistics for rsync from stats hosts		is a writeable rsync module that researchers on stat*	boxes can put data into that'll show up on a separate	mount in labs instances that opt into it		bug: t107576	change-id: ief9bec2cc9b80203f3462619237e3da744884021	|all running services are now ferm-enabled"	" so turn enable base::firewall	on analytics1027.		bug: t83597	change-id: i338041ba5ef94f46fa988f48b74b428198e554f5	|imagescalers: convert the last two servers to hat		bug: t84842	change-id: ib675a13465407f20f5604e2c20fee8530b3b41f0	|remove analytics1012 1013 1020 from list of kafka brokers in site.pp		will have to revisit this later		bug: t106581	change-id: iffd8ce8045e23b896cbf9bed8f8fe47a97f541dd	|provision analytics1014 and analytics1020 as kafka brokers		bug: t106581	change-id: ic55d74c863772d369d8b080372117abd447bd639	|provisioning analytics1013 as kafka broker in analytics cluster		analytics1014 and analytics1020 will come in a separate commit after this	is sure to be working ok.		bug: t106581	change-id: iebabd54424cdd3625984f62a2408b3cbe0873acb	|enable ipsec for all upload caches		bug: t92604	change-id: iaa799786599a90e508126abd5edb6a910ffa60b6	|removing analytics1013"	"1014 and 1018 from hadoop worker list in site.pp		bug: t106581	change-id: i9398dfe7fbbd812a3fcd469c6c0282414a72ac48	|enable base::firewall on dataset1001		bug: t104991	change-id: ia13fd5eda3dd5698c6bbd124b55f82293426f95e	|enable upload ipsec for eqiad + cp3034 for upload-reload testing		bug: t92604	change-id: ia57bd1047d8299a1f8a30844edb23517218ddce8	|provision analytics1046-1049 as hadoop worker nodes		bug: t104463	change-id: i934698c670d42b138f92e53e552d752329365d98	|enable base::firewall on ms1001		bug: t104991	change-id: icceabdf24cc014df8b320edfff2b77677ed3bce3	|enable ipsec for mobile and bits clusters		these are simpler and lower traffic than text"	" and give us more	hosts to look at for more probability of seeing low-rate issues	via monitoring.		still holding off on the upload cluster a bit until we've got more	runtime experience with these clusters...		bug: t92604	change-id: ib66687b55ebbd6978ca6bba922b6e8b20ce1511d	|enable ipsec on ulsfo text cluster		bug: t92604	change-id: ibcce4c2fb2a714ba7e37546601b99cb750f94172	|enable ipsec on all remaining esams text		bug: t92604	change-id: i52a84c5730bd39c5a4dddf6f015e92f41c5656fa	|enable ipsec on cp3031"	40	"41		bug: t92604	change-id: iff52c4be60179d5712b03ab262428dcaff5a0a72	|enable ipsec for all eqiad text caches		bug: t81543	change-id: ibdd028c0243893e474fd3853071a01fccde9d2e4	|enable ipsec for half eqiad text caches		bug: t81543	change-id: idc5efae06f885135f5336752b9d8715b3622c57f	|enable ipsec for all codfw caches		bug: t81543	change-id: ib3eaf06670600335dcaabfd67f7c0c5c7f42207c	|enable ferm for polonium		bug: t104979		while there will be a brief window while ferm is enabled"	" where	smtp will be blocked"	" mail servers will retry mail delivery	later.		change-id: i52bdc3c35f98d434116efab713092bdcc58b4937	|enable ferm on lead		bug: t104979		while there will be a brief window while ferm is enabled"	" where	smtp will be blocked"	" mail servers will retry mail delivery	later.		change-id: idd6f83d59f03db1f703d76ed22ebac5a000733f0	|add admin group 'wikidata query service deployers'		as explained by joe in the ticket"	" we need a new	admin group for wikidata query service deployers and	grant it sudo rights to start/stop/restart the wqds service.		per smalyshev there will be two services"	" wdqs-blazegraph and	wdqs-update are the suggested names.		we are also adding journalctl for access to logs.		bug:t105185	change-id: i4c19134e652f71e4da6df92bb75d235725d9ac24	|enable packet filter for stat1001		all existing roles/services are covered; role::abacist only requires access	to redis on localhost		bug: t104992	change-id: i09f134915999bf8145fdceb2006ce5fdf753542a	|stop labsdb1004 replication to labsdb1005		upgrading labsdb1004 to jessie for postgres 9.4 means that labsdb1005	will not be able to replicate. remove replication until we get	labsdb1005 updated as well		bug: t101233	change-id: i5bbf14fed7677237de98ba9700164a77827c0245	|wdqs: install info"	" site.pp for wdqs100*		bug: t95679	change-id: icbb89b7e6badc3434e7f17b6b3d8f8828be4e6a5	|imagescalers: re-image mw115[6-8] to trusty"	" hhvm		bug: t84842	change-id: i75eac68f4d4011fc1692e2939e8d7b00c1b848b1	|iegreview: remove role from zirconium		bug:t105007	change-id: i11f05c29f599e5027020a61ef8004218d1e6c6e7	|iegreview: add role to node krypton		and this is one more misc. php app we are moving to a vm (krypton).	after this _only_ grafana will be left on zirconium.		bug:t105007	change-id: ib42f5fa8c0fdc47933aad478d5245cb04bf84fd1	|wikimania scholarships: remove role from zirconium		we need to make changes to the apache config for it to work	on 2.4 and jessie. so removing it from zirconium already or it	would cause breakage there.		bug:t105003	change-id: ic95bec8cea71b5834da8f39f7a8a8ebc4083d438	|wikimania scholarships app: apply role on krypton		bug:t105003	change-id: i1e79e50f7f870b040932b9616b9ba48d738c5fb6	|add krypton to site.pp with base::firewall		bug:t105507	change-id: i888158eeee099fa88c94d7da0952ad004e56ba18	|imagescalers: reimage mw1154"	" mw1155 to hat		bug: t84842	change-id: iab5f098cb42586a9588554867b4ddee07efd48fe	|reclaim lanthanum: remove related puppet conf		the machine is no more used by ci. it can be reclaimed.		remove left over configuration snippets.	remove node entry from site.pp		dns clean up is https://gerrit.wikimedia.org/r/#/c/223167/		bug: t86658	change-id: ib1e6df7a1e7cef7821248eb5f7890828f6fdc85d	|switch policysite role from zircon to bromine		bug:t105006	change-id: i5d9bd33092bbcfed265e1cfb05b8a6209d705c2f	|nodepool: preliminary role and config file		bug: t89143	change-id: icb2f9b9fe7dbef60f293870e223edfa849cf0951	|ganglia: add aggregator for ulsfo on bast4001		bug:t93776	change-id: ifbe21e29609ac610e783b322f08feba2d80fe8df	|transparency: remove role from zirconium		bug:t104937	change-id: i586a3da91f44811e91b59bbc5178ebfdcfaf73c6	|logstash: switch to ganglia_new		bug:t93776	change-id: ide188eb050bb579b8bcd8757994305a2bbc95a27	|transparency: add role on bromine		bug:t104937	change-id: i31231caf064ec2e9579435fc4bcbbbc24cf0b729	|add firewall to neptunium.		bug: t102481	change-id: idd5201be10c967b8288729855d47f8415aec5ee5	|imagescalers: reimage mw1153 with hat		since ori fixed the 404 bug we had in i977387bf3e039"	" we should be	finally good to go with the conversion.		bug: t84842	change-id: i1598646351c7f63781ffd8f0cfa8e7ddd4a0abcd	|annualreport: remove role from zirconium		bug:t104936	change-id: i12fd4f064be3cc9b9358ad70eb5de05150b89da0	|annualreport: add role on bromine		bug:t104936	change-id: i493d8ec4dd5f079eac7eda475749e6a2cb192e0b	|static-bugzilla: remove role from zirconium		bug:t101734	change-id: i48c25926b172740acb0c2a28ab700397b2f4121c	|add new node bromine"	" add bz-static role		add new node ""bromine"""	" a ganeti vm for static misc. services.	apply the bugzilla-static role and base::firewall.		bug:t101734	change-id: i4731b5a5551d966d59ac03073c0f16cb093978b0	|use overridden direct dns for all lvs		bug: t103921	change-id: i473170f4171531ca256b20c73d1cc3225d1a8081	|update db1022 to mariadb 10		after reinstall"	" upgrade the puppet role to use mariadb 10.		bug: t101516	change-id: ibf5f21a5269ec789127e30664e63c2deafa2c191	|configure eventlogging kafka forwarder and processor		these are still in separate classes and will not affect eventlog1001		also fix forwarder and processor erb templates to work with	https://gerrit.wikimedia.org/r/#/c/221155		bug: t102831	change-id: i002776bb39c98757bc0ad478939ee96a268af4dd	|planet: remove role from zirconium		it is moving to planet1001 on ganeti instead.		bug:t101730	change-id: i743b252298116a0860e91fe12f596d3015b60f90	|dev.wikimedia.org: delete puppet module		this is just a redirect into mediawiki.org now as opposed	to a stand-alone site on misc-web.		so the puppet module and role can be deleted again.		bug:t305	change-id: i0320fcff48ed7d945daa8acb9ff85f86d26bd469	|remove puppet defs for virt1000; add them for labcontrol1002.		bug: t103722	change-id: i86c882561a0d8c5b836ab663c58eacc1a41a6c6b	|bugzilla: remove module"	" keep static version		bug:t103193	change-id: ie462d2fcb20f50cad81a4c81c0a8623a3141fed5	|planet1001: add to site"	" apply planet role		a new virtual machine on ganeti has been created to	host planet and move it away from zirconium.		add the new instance and apply firewall and planet role.		bug:t101730	change-id: i68478f336588aac8903f14aaa439b705d7912e03	|remove site.pp references to analytics102[345]  they have been renamed conf100[123]		bug: t101713	change-id: if9de2ae0657907a6d47c0755d47f7f764111ff6a	|analytics1023 -> conf1001		bug: t101713	change-id: iec2719c19194c1815f1ce42d8ee8f228d84f9d4e	|prep for reinstall and rename of analytics zookeeper hosts		bug: t101713	change-id: id25ecc7c573a22f246bf5c36d794ccc109cbd76f	|move labs-ns0 to labcontrol1001		and		explicitly move the pdns listen ip on labcontrol1001.		this requires some dns changes"	" mentioned in the associated bug.	the hiera change should be removed after the dns change		bug: t102411	change-id: ic0dd95bee1d622c81915ec29bcb35735cb4efb6b	|restbase: add restbase100[789] to manifest and hieradata		bug: t102015	change-id: ie120c812b0ad1d23ba634e50627ee4461862663f	|restbase: add error rates and storage latencies alerts		similar to 5d04bd78d but only add the alerts to the graphite host"	" this avoid	having equal alerts that would fire at the same time for each and every	restbase host		bug: t78514	change-id: i580dd8ac60d0ab1ebf0a5abd52f304f36f509754	|add ipv6 for silver (wikitech web)		adds a ""mapped"" ipv6 address (mapped to the v4 address) on silver.		bug:t73218	change-id: i4559014d8caa06e51b12044b701f44399696bbf9	|site.pp for cp20xx		bug: t101204	change-id: i75b4fbcb0708d39895703ed21948da52e6dd37e2	|add deployment server role to mira		new codfw deployment server.		bug: t95436	change-id: ic8f1b3472fb48e20c8736173726f474b1715ea9c	|adding a new mariadb master node"	" part of a new shard (m5) for miscelaneous services in labs	bug: t92693		change-id: i3afc0d9a475c932c625d8c5f287e51b44e8cf311	|add ipv6 to codfw deployment server		adding a mapped ipv6 address to mira"	 future codfw deployment server	"	just like we do on tin.		bug:t95436	change-id: if1ef41ccfebd5ded2ee6dfe0d7e57422068ff1e4	|backup home dirs on codfw deployment host		add bacula backups for the home directories on mira"	" the future	deployment server in codfw. because we also do so on tin.		bug: t95436	change-id: i3cb51d52c2f5ed5a200058361e67e1cc69446457	|return db1054 to s2		bug: t89801	change-id: i9f4ae5f690b5d7d37428a29f5706ac5a0612c516	|assign role::puppetmaster::backend to rhodium		bug: t98173	change-id: i86b7d16d0a0c2a9a29fe432332c0d26f3e26b1dc	|graphite: split alerts role		bug: t97754	change-id: ie6cc01b44e467be3ef4d88ec2825d20d42ab5906	|move db1021 to s2 and db1054 to sideline		bug: t89801	change-id: i9d554411688b4021bd6f1b54892ec67976a3b5f0	|assign the parsoid::production role to codfw wtps		bug: t90271	change-id: id0f5c95ecfe38ec249ca67fac9528aa1dfe8ddd8	|add codfw db servers to site.pp		bug:t96383	change-id: ib877a738db75f248498ed4baa40ac63f4dd6c585	|change bz references to phabricator tickets		except in the mediawiki module		bug: t96431	change-id: i6b36e500635537e28520bf5bd61585ff00a41755	|add codfw wtp parsoid servers to site.pp		add the codfw wtp servers with just the standard role for now	to add them to puppet.		bug:t90271	change-id: i0fb7b874f83c5aae1d6bb512240a93f8ca123baa	|site.pp: add labcontrol1001		bug:t96048	change-id: i9b409f47a14d453e3a9ba26e30ae63e36a9535de	|contacts: remove role from node and delete it		this service has been retired.		bug:t90679	change-id: i12141eff2e675068b099862e7b6df9bde8dbd8b5	|add policy microsite on zirconium		adds the role for the policy microsite to zirconium. this is very much	like the transparency or annual report sites.		bug:t97329	change-id: idf4fb54be11ea0b266364a622dac1d1bcf17d746	|reclaim tungsten		remove tungsten from site.pp only as this will be reclaimed as a	spare. leave the hardware ands netboot definitions.		bug: t97274	bug: t90591	change-id: i70217c7493dfd97f7e17387e503b30f80b1a4a94	|remove oxygen udp2log related code		i will reinstall oxygen (as jessie or trusty) before re-puppetizing.		bug: t97294	change-id: if54b0aaa74636dc79ddceab05eb98032e697e2f3	|reinstall oxygen as jessie and .eqiad.wmnet		bug: t96616	change-id: i3db243eb5d13dbb401864790e6905411efc0b44c	|open more ports for impala"	" include impalad on hadoop worker nodes		bug: t96329	change-id: id72184bac0de070336d00deda0430c146dba2ada	|logstash: provision elasticsearch only backend hosts		add logstash100[4-6] to the existing logstash elasticsearch cluster.	these hosts will not run logstash or kibana. they are dedicated to	running elasticsearch exclusively.		bug: t96814	change-id: iaf6fe70aa7a9200e12ef42e3bcff713516fd9181	|htmldumps: include admins on francium		need to include admins and the role class in the right	way to get the admin group defined in hiera.		bug:t94093	change-id: i81fdeb7d13489ca385297429e64288621a581b34	|dumps::zim: include role in hiera-friendly way		we need to include the role on the node in this way to be able to	use hiera role-based lookup. otherwise the admin groups	won't be realized.		per https://wikitech.wikimedia.org/wiki/puppet_hiera#role-based_lookup		bug:t94093	change-id: i6874db5017a1e4f6b111f904dabaf9c5f1b704ef	|make carbon a ganglia_new aggregator for eqiad		in codfw we are using the install server install2001 for this.		after talking with robh he said one day in the future carbon	should technically become install1001 and that it'd be overkill to	have separate hardware just for this.		so just using the install server like we do elsewhere.		bug:t93776	change-id: i44309f6db50140a0e9054b0702a1dd429932ee5c	|dumps::zim: add role and firewall to francium		basic role for zim/html dumps and base::firewall per default.	holes for services will have to be added.		bug:t94457	bug:t93113	change-id: ia3a50d6601e3c530956150db113f988cba0b0ce9	|site.pp: add node francium.eqiad.wmnet		adding francium back to puppet for html/zim dumps.	it existed in dns from the past and has been reclaimed from spares.		bug:t94457	bug:t93113	change-id: ib120d37eb823d9739ace5b110178828f3c5ceb03	|labs: puppetize labsdb1005's mysql setup		this mostly replicates the current config"	" but brings it in	to the standard for passwords"	" etc.		bug: t88234	change-id: i8ce32a37aa517baa9d21ef9bb9d03f50ea9917ef	|releases: install unzip in module"	" not on node level		do not install packages directly on nodes.		put it in reprepo::upload instead because role::releases::upload 	is on tin and the reason reedy asked for zip back then was for releases:		class role::releases::upload {	    class { '::releases::reprepro::upload': }	}		also"	" update rt ticket number to imported phab ticket.		bug:t83213	change-id: i4ec2a9e8ed237f061969faeeaced69772d4b5172	|labnodepool1001: standard + add ci admins		the server is on labs"	" i guess it should include 'standard'.  adjust	hieradata to grant access to the continuous integration people.		note: this include granting root access to hashar which is pending	discussion via t95303.		bug: t95303	change-id: ie58ef69cf77d3d18ad2896be04d31e01417a7ea1	|standard: include admin wherever needed		we also remove all the ""include admin"" stanzas around the puppet manifests		bug: t86774	change-id: i8977120a3e7109de4c3d23a6fd36a28f75e08703	|remove references to vanadium in order to decomission		bug: t95566	change-id: i705e948e602145414b2e5fab74e8ccbf7df282fa	|tungsten: deprovision roles		bug: t90591	change-id: i1f8d91b9675809e605986126b49b565174c10173	|add site.pp cache roles for cp30[34]x		bug: t86663		change-id: i04d33e9e125b45f1db7e85798cdce2bbbc7e8a4b	|phabricator: re-include standard		bug: t92879	change-id: iaf501bb652743726173aa9497a516aaf868a802e	|phabricator: use hiera for admin		this is the last place in site.pp where we have the class being	explicitly declared.		bug: t86774	change-id: i2bd91c3e1cdab4eedcd9deab6ab8dd7a34d12938	|analytics: use role"	" hiera		this is the second-to-last commit in a series that allowed removing a	lot of unuseful cruft from site.pp and will in the end allow to move the	inclusion of the admin class into standard		bug:t86774	change-id: i4c1dc543e2867150968be6fa626f9b60ad813345	|repurpose rhenium"	" format as jessie		bug: t95243	change-id: i365416d05fbf059278aa5e03e34b5a95f4e577e7	|decom rbf[1-2]00[1-2]		remove from puppet site.pp as they are no	longer going to be used and can be decomed.		bug: t95153	change-id: i149457921f056b4eefc16cf99e48db51158edc7b	|haedus / capella: remove from site.pp		as they are also going back for allocation as spare	servers"	" the need to keep these in site.pp is non	existent.		bug: t94474	change-id: iea97957c18049adcf77922e82d138d77a2863883	|remove radon from site.pp		radon is being put into the spare pool for	allocation so there is no need to keep it	in site.pp anymore.		bug:t88818	change-id: iae7870cba84fa955616a7c3a916269cc82bfa692	|use eventlog1001 as main eventlogging host instead of vanadium		for this most part"	" this patch just does s/vanadium/eventlog1001/g.	it also configures a new varnishncsa instance on bits caches called	'eventlogging'"	" rather than 'vanadium'.  i have ensured that the	vanadium instnaces will be stopped"	" and the new eventlogging instances	will send to eventlog1001.  once this is applied"	" i will	manually remove the vanadium named instances and puppet configs.		bug: t90363	change-id: i2d0fc3d0a629f2bc75ef209ff2a51324893a9677	|puppetize eventlog1001		this will only set up eventlogging on eventlog1001"	" it does not yet send any data	to this node.  sending data to eventlog1001 instead of vanadium will happen in a	subsequent change.		bug: t90363	change-id: ica26e8d83129764e50cc0c38a18ac76207e579e4	|cassandra: add firewalling  on prod		compare this to the staging servers"	" xenon/cerium etc.	they include the same roles and already have this as well.		the needed firewall holes are in the role. this would activate	it to be like on staging.		bug:t92680	change-id: i76287f33422b893373a9b285561898cae9e7f0eb	|remove orientdb role from haedus and capella		these have been used for testing orientdb but that	test is over now.		bug:t94474	change-id: i6ae1da4eaaec9cae4ee13b75bf086ae23981d778	|labs: monitor network staturation on labstores		first pass; may need sensitivity tuning.  appears to work	since the current 5m spiky behaviour gives us a warning (as	expected)		bug: t92629	change-id: i27d67739ef9501f9ecc55e7210abd3b6b9027c68	|have base::firewall on codfw poolcounters		bug:t93261	change-id: iea291978649db8dddc72929381757bf552ec5643	|add subra/suhail to site.pp as codfw poolcounters		just copying roles used by potassium and helium in eqiad.		bug:t93261	change-id: iedc0ef51e3d3669577eea85db0d018be0f6449e2	|swift: provision ms-be101[678]		hp machines have different disk ordering unfortunately as discovered in t90922"	"	thus duplicate/split site.pp entries and d-i preseed to accomodate that. the	swift ring will be also changed accordingly.		bug: t90922	change-id: i45ad8699bf5f6b7cd17e646137c4e0bb3ff57bb2	|add base::firewall on cassandra test hosts		base::firewall will add a default drop policy but allow	some defaults like ssh from bastions and icmp from monitoring hosts.		additional holes for the service would be added with ferm rules	in the role class		bug:t92680	change-id: i265d3c3c75c7cb6e47ec5a38047c4175f8ffdb81	|remove unused udp2log::nginx and relay configs from gadolinium and protactinium		i will remove the files and configs manually"	" as well as delete stored configs.		bug: t92337	change-id: i02a269ccc0b7c9b49bdb5966d01f9d58b11a65ac	|apply role::db::redis on rbf200[1-2]		after they are installed and running put the same roles	on rbf2xxx as on existing rbf1xxx.		bug:t86898	change-id: i8553d8e10a944807509334fabf5f0fb47025a147	|put base::firewall on calcium		bug:t83044	change-id: id99498380c3d93ddb2adea2e1f2f2e96f6009de6	|move californium to a public ip"	" part two		bug:t84772	change-id: i9d054a8fe769a707b66261a288762f53ffc00064	|rm module apachesync		this module was once made to move several scripts related to apache	config deployment away from the old deployment host fenari. among the	scripts were:		sync-apache - has already been deleted		apache-graceful-all - is being deleted in this patch		apache-fast-test - we want to keep and this moves it into	the apache module		remainders like ""include rsync::server"" are moved over to the deployment role	to minimize the diff here.		bug:t83880 (related)		change-id: i4c7db8319c1158e64b6ebd05099d2a4c17a9df08	|promote db1046 to m4 master		- eventlogging isn't ready for strict_all_tables due to an old bug	- start in writable mode		change-id: i2266b7416609b6887ff66b21ca077e73e7352d2e	|remove non production ganglia aggregator analytics1010		bug: t90035	change-id: ic230dfa820e4063e50850480908c258ab0580711	|restbase: provision restbase/cassandra role		provision the cassandra/restbase role on production hosts and change the seed	list accordingly. also switch the test cluster to keep the same seed list as	before.		bug: t76986	change-id: ic34336ace248942a8d65f2c2a0bcf5b36176b770	|add chromium-admins to visual editor role		add the newly created chromium-admin group (i96d07556ecaafd)	to the visual editor role class"	" so that it gets applied on osmium	and resolves the access request for roan in t89038.		bug:t89038	change-id: i4b1c4625b335dbef6cba4c1fab6091b71142c625	|allow ""hoo"" to sudo into datasets		needed to keep and eye on and restart the wikidata json	dumps (and the future rdf and property dumps).		this is done by introducing a new group snapshot-admin	which allows me to sudo into the ""datasets"" user.		rt: 8286		bug: t86808		change-id: i1863679d72aeb4ab9aa527ec24bcbda290a8849f	|labstore: do not explicitly declare the apache user existence		we don't really need this to be defined at all"	" as we are not doing name	mapping on the labs nfs.		bug: t78076	change-id: ibb7b3cc3019535f8343e68909466ac98915a6f7f	signed-off-by: giuseppe lavagetto <glavagetto@wikimedia.org>	|add rbf2001/2002 to site.pp		add rbf2001/2002 in codfw"	" just like existing 1001/1002.	they have been added to dhcp in i2e6a2e2025104812.	just adding them as servers for right now to get puppet going"	"	adding roles later.		bug: t86887	bug: t86898		change-id: i06808bbbf149a0b20ba1271c671cd41e287d49ec	|actually run misc::maintenance::update_article_count		followup to 6051955d8339dff67e02f172288c5634cb157ef7		bug: t68867	change-id: ib6c606c0ef84574c639886ade0ab2a29c2ccb28f	|deployment: unify salt_masters role for prod / labs		bug: t86885	change-id: id088ab43f6b4cba58552c75a74eb70361faaaff1	|decom cp1037"	cp1038	cp1039	"cp1040		bug: t87800	change-id: ib4e0ec73cb4a0a22f582e9d1a3326863bdcb0297	|provision graphite[12]001		bug: t85909	change-id: i56f0b166310d804bf6cfac9a8cf2fda1aaef4724	|remove webstats puppet references		there is still one left for erbium.  that will be removed in a subsequent commit		bug: t87868	change-id: i9716dedc35ff5af4ef3d7ad81a41ba93a9e6ebdb	|make standard class's exim including behavior configurable		because some of the instances have their own exim classes	and labs includes 'standard' everywhere.		also kill standard-noexim"	" and setup role based lookups for	all current users of standard-noexim (except for	beryllium"	" which doesn't seem to have any roles at all)		bug: t86575	change-id: ibfa6e218735b5fa233ea50b2c1e2f641d712f9ca	|add basic apache site and docroot for dev.wm.org		add a basic apache site and docroot for the upcoming developer portal	page at dev.wikimedia.org. for now just a placeholder but already	doing what we will need anyways and avoiding to show an error page.		bug:t308	bug:t372	change-id: ifef09d4fc29828823dca640095ba1dafff0ad941	|logging: move fatalmonitor into role::mediawiki::logging		that's the only place where it is used"	" and other helper scripts	are there already		bug: t87221	change-id: ic74ad378f94b7146f34df99a55ddaea5a0a8d980	|scap: move l10nupdate into module		bug: t87221	change-id: id8f5086d78fd8952aef3bcddce987614f80e2161	|scap: move scap master code into own class		- create a role class for a scap master	- scap needs dsh from what i understand"	" so it should be	  in scap::master	- remove some layers of indirection that seem unnecessary.		bug: t87221	change-id: ib96af2cb7a7f84c4f023479312555add37d7c22a	|scap: move 'common_scripts' into scripts class		a mechanical move		bug: t87221	change-id: icba39e8e70680b7bbb2b47646f88f54ea9c52781	|decom amslvs1-4		see icinga - these are in scheduled downtime and in site.pp	they have comments that they are to be decom'ed		bug:t87729		change-id: if9cb61acc6b589a499ac5f8d8022a802442e8fbd	|parsoid: include base::firewall on parsoid hosts		beta has base::firewall included on all *oid hosts (see t86951)	and sca* has base::firewall included for all *oid services	(see i13f8e75dd0ba61671bf9f8acd075333c497b4435). this adds	base::firewall to parsoid hosts as well so that everything	is consistent (prod vs beta as well as *oid hosts).		a ferm rule for parsoid's port has been added in	ia312a73d1ab329a22aae26ee851ed584363017b3		bug: t87105		change-id: i5d32c8f3c60d4903d58e850e3507fffb959e4245	|apache microsite for the wmf annual report		set up a mini role/module/apache template to run on zirconium and	host the wmf annual report.		used to be at http://wikimediafoundation.org/wiki/annual_report		bug: t599	bug: t746	change-id: i4dbb1fa696139793f6ae7bcdbda4d0c171141500	|mathoid: unify mathoid production and beta roles		bug: t86633	change-id: i10463938bac5afdd75e10b7cf8f2574fd809391f	|citoid: unify production and beta roles		bug: t86633	change-id: i6fabdcc58c2fd80c7215a68f311ba4d23c31d650	|cxserver: unify production and beta roles		bug: t86633	change-id: i74ee57e9e10aac2f7df7c3c09052afbaf901e4d0	|apertium: unify production and beta roles		also remove sudo rule to let jenkins-deploy restart apertium.	this can be handled in wikitech now		bug: t86633	change-id: i0b5dcc76b002b7e9fad6add180ddde1a8102b8d7	|lsearchd: remove lucene role and class		bug: t86150	change-id: i0054c6c026b8c01e885e464d00a44177f731e83e	|lsearchd: remove udp2log configuration		note: this will leave files unmanaged and to be removed:		service udp2log-lucene stop	rm /etc/init.d/udp2log-lucene	update-rc.d -f remove udp2log-lucene	rm /etc/logrotate.d/udp2log-lucene	rm /etc/udp2log/lucene	rm -rf /a/log/lucene/		bug: t85009	change-id: i3e14c8007ebef0fb05eb2e21f502fceb9697dc25	|map ipv6 on dataset1001		add a mapped ipv6 address on dataset1001 for	dumps.wikimedia.org to use		bug: t68996	change-id: id7071adc574813837684a2e7eec9a54f69e825ce	|add an 'apache' user to eqiad labstores.		apache isn't installed on the labstores"	" but the 'apache' user	in beta wants access to shared storage.		bug t76086		change-id: id72f727e6feddccc779214918d346702802068c1	|disable kafaktee on analytics1003 (at least tempoarily)		analytics1003 has been having kernel hiccups that causes it to halt:		149325] bug: unable to handle kernel null pointer dereference at 00000000000001be		change-id: iaa9f634d52bc1093cf7c23692558410398480f99	|increase ocg warning/critical space thresholds.		we're working on tracking down a space leak here.  but in the interim"	"	there's no reason to have these thresholds so low: the machines in	question have 500g disk"	" of which 453g is currently free.  (and 32g ram	disk.)		bug: 71341	bug: 71260	change-id: i094fcd5d46a1a97acafd75484d0b5959c08448e7	|moved ::mediawiki::sync to the openstack manager class.		less host-specific is better"	" plus this makes for a clearer	definition of /a		bug: 68751	bug: 62496	change-id: i6b175b49c448c1979117d62ec07a50f6902848e6	|add ::mediawiki::sync to virt1000.		bug: 68751	bug: 62496	change-id: ie05c0044d3f80ae711785932b9a028d8f718d094	|feed logs from ssl terminators again into webstatscollector's filter		since webstatscollector's filter is on purpose dropping logs of	requests from internal ips"	" webstatscollector is dropping the cache's	logs of the requests the ssl terminators relay to the caches. hence"	"	to have webstatscollector count ssl traffic"	" we need to make sure to	get the logs from the ssl terminators themselves into	webstatscollector's filter.		with the decomissioning of emery"	" erbium had it's udp2log setup	changed [1] and hence was no longer getting logs from the ssl	terminators. as erbium was also running the webstatscollector's	filter"	 we were effectively no longer counting ssl traffic. hence	" we	now move webstatscollector's filter to oxygen"	" which consumes the	whole udp2log multicast stream including logs from ssl	terminators. thereby"	" webstatscollector's filter is reporting ssl	traffic again to the collector on gadolinium.		[1] 79ba1d60b713533740d27728234c4bbb8fe60f8c		bug: 67456	change-id: i6a324ee9c4ef876c203e4944a695938507ed48ad	|mail: move backup includes in the role class		move backup includes in the role class"	" instead of mail.pp. introduce a	new empty role class for imap for this purpose.		this also fixes a bug in which /var/vmail was backed up everywhere	(although no box but sanger has it)"	" but sanger itself wasn't actually	being backed up as it has no exim classes applied.		change-id: iaee4f8939e66d991dcca58e9bd43cbbce32b4996	|puppet: upgrade labs puppetmasters to version 3		this change will install puppet 3 on the labs puppet masters.		some config changes are needed in puppet 3 due to a long standing bug"	"	see http://docs.puppetlabs.com/guides/file_serving.html#ip-addresses		change-id: i7df5d8c4bf86cd24772cca02218d311bc6f72c0d	signed-off-by: giuseppe lavagetto <glavagetto@wikimedia.org>	|rename role::mediawiki::job_runner -> role::mediawiki::jobrunner		it used to be 'jobrunner'"	" but i renamed it to resolve an ambiguity with	::mediawiki::jobrunner caused by a puppet parser bug. it can be renamed back	now.		change-id: i629781260b62e8719b61ab70b9fcf1fa835146ae	|fix the use of $nagios_group.		this is again needed for puppet 3 migration"	" as definitions of	$nagios_group deep down in classes will not work there. also"	" i fixed an	apparent bug where in general we did not set the correct	hostgroup.		the logic now is:		- if $group is explicitly declared in the resource definition"	" use that	- else if $nagios_group is explicitly defined at node level"	" use that	- else if $cluster is defined at node level and is not 'misc'"	" use	  ${cluster}_$::{site} (es cache_bits_eqiad). this does not apply to	  servicegroups for individual services that have no default value	- else"	" leave this undefined.		this should not only retain the definitions as is almost everywhere"	" but	also define the servicegroup/hostgroup in a few places where it's	currently undefined.		change-id: i50c8d5c96b2541b1b926a98c8006ccdc665665e6	signed-off-by: giuseppe lavagetto <glavagetto@wikimedia.org>	|mention ms-fe servers need to be xff trusted by mw		swift is originating rendering (imagescaling) requests by mean of our	own rewrite/404 handler middleware and is copying the originating xff	header to its own request. hence"	" add swift frontends to the ""squid""	server list"	" which essentially is the ""trust xff headers"" list.	this has always been broken"	" but we were never doing anything with those	ips until ie95fdf"	" which added a per ip rate limit to image scaling	requests. that limit is was essentially applied per swift frontend ip	and breaking thumb generation for many users.		bug: 64622	change-id: ica9086dcd32428f7229a4e48e3f210ba0825fc18	|make puppet cronjob to run securepoll/cli/purgeprivatevotedata.php		bug: 51574	change-id: iab860b8a5d800c24a5501a16d9f78408c0c55cd5	|properly puppeti[sz]e purge-checkuser		bug: 51572	rt #4792	change-id: iaed6e910fb9c154ad56b0b31dae3f7009ba50df1	|create roles for syslog-ng		introduce role::syslog::centralserver{"	"::beta} to vary the path were	syslog-ng ends up writing logs to.		should not change anything on production servers nfs1/nfs2.		the class should be applied on both beta cluster bastion (pmtpa and	eqiad).		the syslog-ng creates files with gid 500 which is the 'wikidev' ldap	group.		bug: 62757	change-id: i91f29d02448acf9168ce8830d0ddbb049dcc5da3	|make syslog-ng basepath a parameter		for beta we will have to write syslog on a different path than	/home/wikipedia/syslog.  this patch removes the hardcoded value from the	syslog-ng configuration and explicitly pass the class parameter on the	nfs1 and nfs2 production hosts.		bug: 62757	change-id: i4ec49ba38634adbe9156dcdd82c73a91987fd607	|fix bug introduced in 68e354d		it broke puppet on terbium		change-id: i6b2ed821d090ef01ec50012567d4855e47cbd6d3	|osm module		module to handle installation of osm2pgsql"	 osmosis	" and population and	syncing with from planet.osm		while at it enabled the hstore extension in postgres module	also upload the already populated grants for osmosis and fix a couple of	bugs in the postgresql module while at it		change-id: id3db056ace7a073831e90ebdaf47f6d9b2596ec5	|make puppet cronjob to run abusefilter/maintenance/purgeoldlogipdata.php		bug: 51573	change-id: i936b8c4051efaba3da292ae81ad5c7510bd0ae6e	|remove old bugzilla puppet class/role		delete entire misc/bugzilla.pp	replaced by module		delete bugzilla::old role		remove role from kaulen		change-id: i40227865ed951f65f2e713e61e06b4f60e4c484e	|split exim stats to own class and add it to mchenry		bug: 57890	change-id: ia24fc244c7201e96ff045b88786a895be718dfea	|contint: invoke gerrit-sync-ve-push.sh as jenkins		gerrit-sync-ve-push.sh needs to be run as 'jenkins' user to be able to	use the ssh credentials of gerrit 'jenkins-bot' user.  that is used by	the script to push an update of mediawiki/extensions.git to workaround	visualeditor no more updating in gerrit.		i have made the sudo_user at the host level since that is where all of	them are made already.		bug: 49846	change-id: ib0c260667803e75586eca5e19a6466496c0f7510	|add configuration for wikimania scholarships		add configuration for the wikimania scholarships application. this is	a stand-alone php application hosted in an apache vhost with code	deployed via trebuchet. data will be stored in the misc mysql shard. ssl	termination and caching will be provided by the misc varnish cluster.	logs will be forwarded to fluorine via the udp2log protocol.		needs dns update.		bug: 57870		change-id: ie568f268b1df21bd3bd6681436f6bac444f82132	|rename misc::parsoid to role::parsoid::production		i am going to need a role class to deploy parsoid on the beta cluster.	the deployment-parsoid2 instance currently uses the same class as the	production one but need some further tweaks.		bug: 57233	change-id: ide6f136c66aebd77f62ec35589c311a8ada9a83f	|move irc server to module		but leave wikibugs/ircecho alone"	" they actually are	not related to the ircd besides being irc"	" so should	be their own module.		renamed this from ""irc"" to ""ircd""		change-id: i9992a36a254e42c60b016c7115de77c99bbe3058	|removed pstack package since bug 48025 is resolved.		change-id: ic33fe60baa8791ded1dd38aace4570b12d5b6be5	|rt#5011 bugzilla to use own certificate		change-id: i3e163570feecab48809d86b5c8c7ddaa629babbe	|(bug 15434) periodical run of currently disabled special pages		stole mutante's refreshlinks class used for bug 16112.	the idea would be to update only one page per cluster at a time"	" two times per year.		* 1 utc: servers less busy; doesn't overlap with any deployment window but is not too far from time used for some. https://wikitech.wikimedia.org/view/deployments	* same cluster/monthday syntax as per refreshlink"	" +10 days to avoid overlap.	* each query page has its defined months.	** list from $wgdisablequerypageupdate"	" restored camelcase in case updatespecialpages.php cares.	** we're lucky because the disabled pages are 6 globally and 12 for en.wiki (since years ago).	** the 6 pages disabled only on en.wiki are left behind for now.		ideally"	" i guess we should use tuesday and thursday of each week in each month.	s1 in the first tue"	 s2 in the first thu	" s3 in the second tue etc.	this way it would always be in worktime and never same day as mw bi-weekly deploy.	i've no idea how to do it"	" though. http://docs.puppetlabs.com/references/latest/type.html#cron		change-id: ia5bd4c90f8be3d047f0752536170783eb6817072	|remove misc::download-mediawiki from kaulen because it's either	supposed to be on swift or on a new download host in eqiad"	" but not	on the bugzilla server and not in tampa and it wasn't used anyways.	just added download.mediawiki.org to apache conf so that at least	it wasn't just showing an empty directory on kaulen but redirects	to mediawiki.org		change-id: idb8b6f90cb5400ee2227b9ed3b5c1ed97d176bd4	|move all misc::bugzilla::* to role/bugzilla.pp"	" less includes in site.pp		change-id: i8803700f765e928a881b0a88818fb58a9cc49f52	|add misc::bugzilla::auditlog to kaulen		change-id: ifad8d259cf8156f8e44379f8200880e8a9c08666	|tool labs: bump max_user_connections to 512		some tools hitting into the 10 limit really easy.  512 is a lot	but should allow the occasional peak use (which is needed for	a number of tools with incoming links from the projects)		bug: 49872		change-id: i5bf9c67b162764d4f3da011ff36391c0e714a804	|finish puppetizing wikibugs bot		when deploying to mchenry"	" you'll need to update the filter from:	 wikibugs-irc: |/usr/local/bin/wikibugs.pl	to	 wikibugs-irc: |/var/lib/wikibugs/bin/wikibugs		ps4: (dz) - manual rebase / fix path conflict	            switch #mediawiki-feed to #wikimedia-dev		ps5: (dz) - don't use the -infile variable anymore		change-id: i1bb72bee199d3bf24750460c298f96392d8a1818	|allow jenkins admins to manage replicated git repos		we replicate all repositories from manganese to gallium"	" and if	a repository becomes corrupted (or renamed"	" or has other maintenance)	we currently have to bug a root user to handle this.		the gerritslave user only has access to these repos in /var/lib/git/*"	"	so there's no other files or services we could use.		change-id: i71837aa8cd6759a03fac3619a1e366b8fe16246c	|turn manage-volumes into a daemon		- only create volumes if they are requested via ldap"	" for example	  as info:use_volume=home		- if a project doesn't request a volume but the volume exists"	"	  disable access to that volume		- log volumes that exist but aren't requested"	" volumes that belong	  to instanceless projects"	" and volumes that no longer have a	  project at all.		- fix a bug that was causing us to reset access permissions	  on every run even when nothing had changed.		- track volumes that need stopping and then actually stop them	  after an hour if nothing has happened in the meantime.		change-id: if3b639726a667b4d70f59a1b3ec49a80961d1478	|need git-core installed on mchenry to deploy wikibugs changes		change-id: i5a399e579055ceb26aa4d175d273e3dc726c202e	|puppetize bugzilla_report.php"	"	replace change i19d5da64: clarify weekly report ""top resolvers""		change-id: ieb8aa27d2e6973352e043ff07a180fe41b793228	|(bug 43339) deployment roles for beta		i have abstracted the common to beta and production configuration to	avoid code duplication. this should let us use deploy on the	deployment-bastion instance which is the working machine for the 'beta'	cluster.		change-id: ia7bb843e48a81206f5dded9bd77f23571b0e4231	|puppetize bugzilla community metrics ""active users"" stats script	rt-3962		change-id: i49383432f57336e5d6a4dd5f4de60541b83e4b38	|deploy zuul on gallium		this apply the role::zuul::production class on the continuous	integration server ""gallium"". also add a nagios monitor to ensure the	zuul-server process is running.		rt: https://rt.wikimedia.org/ticket/display.html?id=3958	bug: https://bugzilla.wikimedia.org/show_bug.cgi?id=40681		change-id: iad87640188ca35815bbc32db4d65faeb75843974	|do not run jobs on precise"	" due to bug 40462		change-id: id30e5cf8afed5e72cb5f16c1598f798495842c4f	|(bug 38084) uses /data/project instead of nfs instance		historically"	" the beta project has been using its own nfs server:	deployment-nfs-memc which holded the apache directory as well as the	thumbnails and files.		this patch switch to use the /data/project shared directory which will	thus remove a layer of file abstraction and is definitely cleaner and	easier to understand.		using symbolic links since we cannot mount a subdirectory of guster	volume.		change-id: i0e4c5a819bcb3edd0859977825278625ed064958	|+geoip for applicationserver::labs		we have tested geoip on a lucid labs instance (bug 38027) so that is	safe to enable it there :)		change-id: i8ad8f1964729989bf5c25dd9231fd5d48fbb8ea8	|adding bugzilla server class to kaulen		change-id: ib24afcd99c052c5d1924263884f4ef990e51b3c8	|(bug 37048) labs jobrunner needs a large tmp directory		timed media handler uses a temporary directory to rescale videos. we	will need a large one to be able to handle the various videos being	transcoded simultaneously.		change-id: i2c0e475d69ebc4d5c86e1190b525de6fd8847cff	|moving gitweb config to its own class"	" adding blame support (bug 36234)		patch set 2: fixing syntax error and trailing whitespace	patch set 3: adjusting permissions to 0444 and owner to root:root	             the ownership on all this gerrit stuff is a hodge-podge	             anyway"	" but that's beyond the scope of this commit.		change-id: i024289f6d8d44d553036f17e0b2c7eceabed3b22	|bug 33301"	" bad ssl cert at integration.mediawiki.org		patchset2: remove star.wikimedia.org		change-id: i7e0b13506a6c104a7cd8544f54b54eef55b7d681	|work around puppet 2.7 bug with hashes defined in selectors		change-id: i80677984ac7705cd750015ca65ff16e41eab4ebf	|work around puppet 2.7 bug with hashes defined in selectors		change-id: i80677984ac7705cd750015ca65ff16e41eab4ebf	|rename bugzilla crons class to use colons		change-id: idd9c9ad7034bfa4c43aff6bd6cb239c5717b8b18	misc::bugzilla_crons -> misc::bugzilla::crons	|add hashar account to kaulen (bugzilla)		change-id: i65b67860966fb101ada2aadd3c8d62dd865704b3	|"
"admin: transition to ssh::userkey		bug: t92475	change-id: i64b3ec8ec22bbda4b6edae3bf26f04f86513ee21	|"																																																																																																																																																																																																																																																																																																																																																																			
"contint: use slave-scripts/bin/php wrapper script		set up /usr/bin/php as a wrapper shell script that chooses the proper	php version to use based on the $php_bin environment variable that is	set by zuul.		since this is a non-standard alternative"	" we need to use	`update-alternatives install`.		bug: t126211	change-id: i9758c8577164d4e528a028ab402020c4c592d1be	|"																																																																																																																																																																																																																																																																																																																																																																		
"annualreport: add apache site for 15.wp.org		add apache site on bromine along with annual report 2014	to make 15.wikipedia.org work for annual report 2015.		bug:t599	change-id: i73a9ec635cea179bff0f01efe0b8ce6b64c01265	|annualreport: remove duplicate dir declaration		/srv/org and /srv/org/wikimedia are already declared in another role	on this node. doing it again causes duplicate declaration puppet error.		bug: t746	change-id: ie54714c1bd854268a2cfd3c0a45b312ef1b7fa94	|apache microsite for the wmf annual report		set up a mini role/module/apache template to run on zirconium and	host the wmf annual report.		used to be at http://wikimediafoundation.org/wiki/annual_report		bug: t599	bug: t746	change-id: i4dbb1fa696139793f6ae7bcdbda4d0c171141500	|"																																																																																																																																																																																																																																																																																																																																																																			
"apache: reload when config changes (bugfix)		apparently the apache module's intention is to reload apache when config	changes. however"	" right now there is a notify => service only on the	$conf-enabled path"	" which is actually the symlink; while this works for	an initial provisioning"	 it does not work for config *contents* changes	"	as the symlink does not get modified at all. add a notify to the	$conf-available path as well to address this.		change-id: i7cd7f306161b8d92e1c22825be9a81c87333c77c	|"																																																																																																																																																																																																																																																																																																																																																															
"mediawiki: allow using a different web user than apache		at the moment the user:group for all web-related software in mediawiki	is the non-standard apache user. so"	 as a transitional helper	" we are	making the user configurable so that the transition can happen over time.		bug: t78076	change-id: idf7d1f9185aec9aec889ef5f1141bd0263909281	signed-off-by: giuseppe lavagetto <glavagetto@wikimedia.org>	|"																																																																																																																																																																																																																																																																																																																																																																	
"rm module apachesync		this module was once made to move several scripts related to apache	config deployment away from the old deployment host fenari. among the	scripts were:		sync-apache - has already been deleted		apache-graceful-all - is being deleted in this patch		apache-fast-test - we want to keep and this moves it into	the apache module		remainders like ""include rsync::server"" are moved over to the deployment role	to minimize the diff here.		bug:t83880 (related)		change-id: i4c7db8319c1158e64b6ebd05099d2a4c17a9df08	|"																																																																																																																																																																																																																																																																																																																																																																			
"apache: logrotate augeas rule needs apache2 package		when bootstrapping a new image"	" the apache::logrotate class fails	because augeas tries to deal with /etc/logrotate.d/apache2 which might	not be existing yet.		ensure the apache2 package is realized before tweaking the logrotate	file it ships.		bug: t136301	change-id: i5b27bf38b8297c35724514894c49783f9626ee60	|apache: perform the hard restart before refreshing the service		at the moment"	" whenever we do a config change and apache must be	restarted"	" we first issue a refresh of apache (which is a graceful	reload)"	" then we issue an hard restart shortly after that. this leads to	a race condition (due to some bad logic in the apache init script"	" but	still...) that makes the hard restart fail and leaves apache turned	off. this is an attempt (albeit sub-optimal) to solve the issue. bug: t86652		change-id: i2bb44cf6a2c9bece7e4d4396327bad8b826439ce	|"																																																																																																																																																																																																																																																																																																																																																														
"add apache::mod::security		needed for customizing the value of the 'server' header emitted by apache	(beyond the limited set of choices provided by the servertokens directive).	we need this so we can emit the app server hostname as the server header.		bug: t132599	change-id: i09c08953d620a52d08d1c4e981cc2f74857375e8	|logstash: enable user & group authz modules for kibana		bug: t103804	change-id: i751ad63828e9c7a26bb8b07804310bd3c056ada3	|bugzilla apache: enable required modules for caching		the caching directives in the apache configuration for bugzilla are	currently inactive because at least one of the required apache modules	is not loaded.		bug: 49720	change-id: i8e616d3ca006776bf6d450863f62af785171d4a9	|mediawiki: small clean-ups		* instead of a fake sync to start apache on beta (bug 38996)"	" call	  ""/etc/init.d/apache2 start"".	* to avoid having the beta apaches attempt to sync the apache configs"	"	  create file['/usr/local/apache/conf'] before sync_apache_config has had	  a chance to run.	* tidy up whitespace"	 parameter order	" etc.	* avoid redundant dependencies when puppet already orders resources.	* declare apache::mod::cgi		change-id: i1b8a617c260bb68ec475656aa56a500a6ab0ad5d	|"																																																																																																																																																																																																																																																																																																																																																															
"apache::mod_conf: jessie compatibility		on debian jessie"	" removing some fundamental apache modules like deflate	or negotiation will cause a2dismod to present a warning to users.		while it's a neat feature for users"	" it needs to be circumvented on	the appservers where we don't need those modules.		bug: t131749	change-id: i6005f78fe6aa7f5da3244a94d5c825aca6f6e512	|"																																																																																																																																																																																																																																																																																																																																																																	
"apache: skip ganglia when it is unwanted		on ci slaves"	" we are using apache::site to create a virtual host. that	in turns invoke:		  apache::init	  apache::monitoring	  ganglia		but on labs ganglia is not installed via a hiera switch apparently. that	causes puppet to fail with:		notice: ganglia::monitor::packages/file[/etc/ganglia/conf.d]/ensure: created	error: cannot create /usr/lib/ganglia/python_modules;	       parent directory /usr/lib/ganglia does not exist		in apache::monitoring"	" skip ganglia installation entirely whenever hiera	indicates: $::standard::has_ganglia = false.		bug: t134808	change-id: i8af072005de3fe750a227861722a9411dc45eb7f	|apache: disable diamond collector		the diamond collector apparently fetches 1 bit at a	time (http://bugs.python.org/issue2576) and left a large number of	connections to localhost:80 in time_wait status. disabling while we	reimplement this on our own in a saner way.		change-id: ifc1ef4c4a143c485c06015a7fa54550b7431e3f3	signed-off-by: giuseppe lavagetto <glavagetto@wikimedia.org>	|"																																																																																																																																																																																																																																																																																																																																																																	
"apertium: move logs to /srv/log		on sc(a|b)"	 the /srv partition is much bigger than /	" so move apertium's	logs there.		note: instead of hard-coding the path"	" this patch leverages the	configuration set for ::service::configuration (which for both sca and	scb is set to /srv/log).		bug: t107900	change-id: i388f2392dd0d99b7a9e3252fec7575540d68937e	|apertium: add missing apertium-br-fr		bug: t102101	change-id: i0d22b7106ef6843a3b97e8ef8fdb64673e420819	|apertium: add apertium-isl and apertium-isl-eng packages		bug: t114988	change-id: ia7e7358c961c6187039ef78dba720c95978cd1b8	|apertium: add new language pairs for apertium mt		bug: t111902	change-id: ifce882eaa5c9a61bc3c02058d5940169a523597d	|cx: add support for urdu<->hindi apertium mt		bug: t101811	change-id: ia1397c70abb3b89f2cfc0c63db5ed27b1c232c2d	|add apertium module tests		while at it fix 2 bugs with bad dependencies		change-id: i2d4c6b526cbdda64e35598871dff36a250e8e43c	|"																																																																																																																																																																																																																																																																																																																																																																
"add apertium module tests		while at it fix 2 bugs with bad dependencies		change-id: i2d4c6b526cbdda64e35598871dff36a250e8e43c	|"																																																																																																																																																																																																																																																																																																																																																																			
"apt: minor syntax/whitespace fixes		run a newer version of puppet-lint and fix a few whitespace errors and	syntax warnings. besides the style aspect of this"	 this fixes actual	"	real bugs (quoting variables and naming a class with a dash).		change-id: icb7320ed7b28ff154502f0ad32c44609364c083c	|"																																																																																																																																																																																																																																																																																																																																																																	
"don't install apt-show-versions		apt-show-versions is responsible for frequent cronspam and does not seem	to be in use.		bug: t132324	change-id: i72f424c34ce8dcfee538edb28bc19c769922fbeb	|apt: enable backports on debian systems		this enables backports across the fleet and relies on the default debian	policy for the apt priority for the repository (i.e.	notautomatic/butautomaticupgrades).		suffice to say"	 packages from jessie-backports should be used with care	"	as they may change to a newer version at any point.		bug: t107507	change-id: i8dceea1e42f33056133d3a1315bc32dd8b78dcb8	|ensure that apt preferences are named *.pref		currently"	" apt::pin does not append an extension to the given name	parameter when creating the file resource in /etc/apt/preferences.d	(apt accepts any file with no extension or the extension "".pref"").  in	this aspect"	" apt::pin behaves differently than apt::repository that	appends "".list"" to the files it creates"	" and is also used	inconsistently as some callers use an (explicit) "".pref"" extension	while others do not.		in addition"	" on labs instances both the file	/etc/apt/preferences.d/wikimedia and the file	/etc/apt/preferences.d/wikimedia.pref are created with equal content"	"	but only the former is managed by puppet.		this change ensures that files created by apt::pin or the install	scripts have "".pref"" appended to their names and that all callers are	amended accordingly.		bug: t60681	change-id: i1ebf184ccd7d4bf8575ca12d9fa51064147479c9	|apt: minor syntax/whitespace fixes		run a newer version of puppet-lint and fix a few whitespace errors and	syntax warnings. besides the style aspect of this"	 this fixes actual	"	real bugs (quoting variables and naming a class with a dash).		change-id: icb7320ed7b28ff154502f0ad32c44609364c083c	|"																																																																																																																																																																																																																																																																																																																																																										
"ensure that apt preferences are named *.pref		currently"	" apt::pin does not append an extension to the given name	parameter when creating the file resource in /etc/apt/preferences.d	(apt accepts any file with no extension or the extension "".pref"").  in	this aspect"	" apt::pin behaves differently than apt::repository that	appends "".list"" to the files it creates"	" and is also used	inconsistently as some callers use an (explicit) "".pref"" extension	while others do not.		in addition"	" on labs instances both the file	/etc/apt/preferences.d/wikimedia and the file	/etc/apt/preferences.d/wikimedia.pref are created with equal content"	"	but only the former is managed by puppet.		this change ensures that files created by apt::pin or the install	scripts have "".pref"" appended to their names and that all callers are	amended accordingly.		bug: t60681	change-id: i1ebf184ccd7d4bf8575ca12d9fa51064147479c9	|apt: minor syntax/whitespace fixes		run a newer version of puppet-lint and fix a few whitespace errors and	syntax warnings. besides the style aspect of this"	 this fixes actual	"	real bugs (quoting variables and naming a class with a dash).		change-id: icb7320ed7b28ff154502f0ad32c44609364c083c	|"																																																																																																																																																																																																																																																																																																																																																												
"aptly: add ability to mark a repo as trusted		useful for local repos"	" specifically the aptly repo in	labs. those are available only to project roots and hence	can be trusted		bug: t112699	change-id: ieb42901289c2b600d241b6a796085d7d9a5dd5bf	|apt: minor syntax/whitespace fixes		run a newer version of puppet-lint and fix a few whitespace errors and	syntax warnings. besides the style aspect of this"	 this fixes actual	"	real bugs (quoting variables and naming a class with a dash).		change-id: icb7320ed7b28ff154502f0ad32c44609364c083c	|"																																																																																																																																																																																																																																																																																																																																																																
"apt: minor syntax/whitespace fixes		run a newer version of puppet-lint and fix a few whitespace errors and	syntax warnings. besides the style aspect of this"	 this fixes actual	"	real bugs (quoting variables and naming a class with a dash).		change-id: icb7320ed7b28ff154502f0ad32c44609364c083c	|"																																																																																																																																																																																																																																																																																																																																																																	
"aptly: mark aptly repo as trusted		bug: t112699	change-id: i737e7df179de03ad1f2e2276c8e77d52b904fc8f	|aptly: force remove multiarch support in precise		bug: t111760	change-id: i5c9fac2224affae4edc47fb698ba30de465679e8	|"																																																																																																																																																																																																																																																																																																																																																																			
"aptly: add module + simple role		bug: t104194	change-id: if8683243afac2720f48e94ff053c1f0b43ba8bad	|"																																																																																																																																																																																																																																																																																																																																																																			
"aptrepo: make owners of incoming dir configurable		for different uses (apt.wm vs. releases.wm) we have	different users/groups owning the incoming directory.		now that we use the same module for them we need to make	it configurable too"	" for uploads to work like before.		this is not changing the actual owner/group from how it was	before"	" it's restoring carbon and bromine as they were.		bug:t132757	change-id: i62ecadc06c98b0a4e9e8b755a930e6c5cb38a206	|aptrepo: make conf/incoming configurable parameter		because we have 2 use cases for aptrepo"	" carbon (apt.wm) and bromine	(releases.wm) with different config for incoming uploads"	" we need	to make this configurable.		adds a parameter incomingconf to set to a template name	that will have the content of ./reprepro/conf/incoming.		bug:t132757	change-id: ibaf755e1e92f8cf3907665ea86bf054bc96d0da1	|aptrepo: mv wikimedia-specific distributions file to role		this file is specific to wikimedia and should be realized in the role	class not the module itself.		when"	 like on bromine	 aptrepo::distribution is used	" this creates a	conflict and puppet error.		it could also be replaced with aptrepo::distribution instead but	some options are missing for now.		bug:t132757	bug:t136793	change-id: ib98634da6745278ab0948ddb14aaf69434fc93a4	|install/aptrepo: move distributions file		move the distributions file from reprepro over to aptrepo.	remove the unused template instead.		on the other hand"	" the incoming file is replaced by template.		follow-up fixes for ie259b93997 which could not find the file		bug:t132757	change-id: ie574b0c8a7f69c8e439cb8c084ec23b9ecf84501	|"																																																																																																																																																																																																																																																																																																																																																											
"aqs: separate aqs off of restbase		for a first deploy"	 we tied aqs to use restbase's class. however	" now	that the restbase class simply uses service::node"	" there is no need to	have aqq point to restbase.		add analytics/aqs/deploy to trebuchet's deployment.yaml to bootstrap	aqs/deploy clone on tin		bug: t126294	change-id: i65758cf23926a0463e058f118e3192411d120dec	|"																																																																																																																																																																																																																																																																																																																																																																
"aqs: separate aqs off of restbase		for a first deploy"	 we tied aqs to use restbase's class. however	" now	that the restbase class simply uses service::node"	" there is no need to	have aqq point to restbase.		add analytics/aqs/deploy to trebuchet's deployment.yaml to bootstrap	aqs/deploy clone on tin		bug: t126294	change-id: i65758cf23926a0463e058f118e3192411d120dec	|"																																																																																																																																																																																																																																																																																																																																																																
"rsync:  unquote booleans		bug: t113783	change-id: i80362002e2f665daac829bfef959714f09c5c3e8	|"																																																																																																																																																																																																																																																																																																																																																																			
"add hsts=1y to several one-off public services		this adds hsts=1y headers to the following services:		archiva.wikimedia.org	dumps.wikimedia.org	ganglia.wikimedia.org	librenms.wikimedia.org	rcstream.wikimedia.org		note this does not imply any redirects"	" or force a client which is	not https-capable to use https.  what it accomplishes is that if	an hsts-honoring user agent successfully reaches the service over	https once"	" the sts header will lock their future access from that	client onto https going forward.		bug: t132521	change-id: idb40ad1bfc5db93989713a68d1bf3eef2e8c4843	|archiva: fix ssl certificate filename bug		the archiva nginx config had some faulty logic referencing the	non-existent $ca_name variable"	" which resulted into the production	config not using the proper chained certificate. simplify the logic and	fix.		change-id: i7c14755fe9d1a4acd5faaa929571803c03d0f52b	|set up https with archiva certificate for archiva.wikmedia.org		- this adds a simple generic nginx site to force all non https traffic on port 80 to https.	- this also points our maven module archiva urls at https://archiva.wikimedia.org		bug: t88139	change-id: i3bfff6e632e0d5c26d710d8ab69dcc4d1ee8f3a1	|"																																																																																																																																																																																																																																																																																																																																																																
"authdns: transition to ssh::userkey		bug: t92475	change-id: i8185344eb66c7f547fede44691dfb8225b41d9bf	|add an authdns module & associated role classes		this adds an authdns module. the module is an uncommon for our tree	mixture of a role module"	" a package replacement (scripts) and internal	logic to handle the configuration of the authdns cluster. it serves as a	replacement to both dns.pp's authdns parts and the	wikimedia-task-dns-auth package"	" although both are significantly	rewritten.		a gdnsd module is not provided here"	" as the software is simple enough to	not warrant it (a single package & service definition).		this also adds role classes for each of ns0/ns1/ns2 (with their current	ips) and a testns class for playing with in labs. these are all unused	for now.		this is the initial work. pending work includes adding ipv6 addresses"	"	switching to the commercial geoip databases and providing scripts for ci	integration. plus"	" bug fixes :)		change-id: ice119ead68bd7cb5a232f31c778b03791a917012	|"																																																																																																																																																																																																																																																																																																																																																														
"s/config-head/config/ bugfix for 69f3b4ec		change-id: i33efde5ccf752d80ea81b4cba128bde9d2885c34	|add an authdns module & associated role classes		this adds an authdns module. the module is an uncommon for our tree	mixture of a role module"	" a package replacement (scripts) and internal	logic to handle the configuration of the authdns cluster. it serves as a	replacement to both dns.pp's authdns parts and the	wikimedia-task-dns-auth package"	" although both are significantly	rewritten.		a gdnsd module is not provided here"	" as the software is simple enough to	not warrant it (a single package & service definition).		this also adds role classes for each of ns0/ns1/ns2 (with their current	ips) and a testns class for playing with in labs. these are all unused	for now.		this is the initial work. pending work includes adding ipv6 addresses"	"	switching to the commercial geoip databases and providing scripts for ci	integration. plus"	" bug fixes :)		change-id: ice119ead68bd7cb5a232f31c778b03791a917012	|"																																																																																																																																																																																																																																																																																																																																																														
"add an authdns module & associated role classes		this adds an authdns module. the module is an uncommon for our tree	mixture of a role module"	" a package replacement (scripts) and internal	logic to handle the configuration of the authdns cluster. it serves as a	replacement to both dns.pp's authdns parts and the	wikimedia-task-dns-auth package"	" although both are significantly	rewritten.		a gdnsd module is not provided here"	" as the software is simple enough to	not warrant it (a single package & service definition).		this also adds role classes for each of ns0/ns1/ns2 (with their current	ips) and a testns class for playing with in labs. these are all unused	for now.		this is the initial work. pending work includes adding ipv6 addresses"	"	switching to the commercial geoip databases and providing scripts for ci	integration. plus"	" bug fixes :)		change-id: ice119ead68bd7cb5a232f31c778b03791a917012	|"																																																																																																																																																																																																																																																																																																																																																														
"fix duplicate package[git-core] declaration		not using ensure_packages since standard-packages prefers latest. so	that on nodes not using java::tools"	" it will still keep that behaviour.		bug: t94921	change-id: i5a7f6bd12c02387b2b9c8f722ae0f1175ba65a01	|add an authdns module & associated role classes		this adds an authdns module. the module is an uncommon for our tree	mixture of a role module"	" a package replacement (scripts) and internal	logic to handle the configuration of the authdns cluster. it serves as a	replacement to both dns.pp's authdns parts and the	wikimedia-task-dns-auth package"	" although both are significantly	rewritten.		a gdnsd module is not provided here"	" as the software is simple enough to	not warrant it (a single package & service definition).		this also adds role classes for each of ns0/ns1/ns2 (with their current	ips) and a testns class for playing with in labs. these are all unused	for now.		this is the initial work. pending work includes adding ipv6 addresses"	"	switching to the commercial geoip databases and providing scripts for ci	integration. plus"	" bug fixes :)		change-id: ice119ead68bd7cb5a232f31c778b03791a917012	|"																																																																																																																																																																																																																																																																																																																																																													
"backup: resource attributes quoting		bug: t91908	change-id: i0729bcceb71322b99e33b7ed4af2af9d7c10a46f	|"																																																																																																																																																																																																																																																																																																																																																																			
"add a new backup set to backup openldap databases and enable on serpens		run slapcat on to create a snapshot of the ldap data in the pre-run script	and a cleanup script after the backup run.		bug: t120919	change-id: i2ba5436a356b729b22dd8d7dcb5c64f11cb36e1f	|"																																																																																																																																																																																																																																																																																																																																																																			
"backup: resource attributes quoting		bug: t91908	change-id: i0729bcceb71322b99e33b7ed4af2af9d7c10a46f	|"																																																																																																																																																																																																																																																																																																																																																																			
"base::certificates: add puppet's ca to the trusted store		also"	" add a puppet_ssldir() function to unify the logic to pick the	puppet ssl dir everywhere. actually apply it only where it will be	needed in the future.		bug: t114638	change-id: i40e6673811b76aad4ea85d8e7b257e078baa7a8a	|base::certificates: add puppet's ca to the trusted store		also"	" add a puppet_ssldir() function to unify the logic to pick the	puppet ssl dir everywhere. actually apply it only where it will be	needed in the future.		bug: t114638	change-id: i9e3fafb486c89a291395928f65531ace44c4caa0	|"																																																																																																																																																																																																																																																																																																																																																																	
"only create salt grain for non-empty returns from hiera		bug: t111006	change-id: ibdd1c5e28bf144fc4dfd811fa31393d0518b860d	|hiera-based assignment of grains for debdeploy		also add two initial grains to test with.		bug: t111006	change-id: i83c5bb03e341032a34de44f4108d3e46623554b0	|"																																																																																																																																																																																																																																																																																																																																																																			
"kill references to $::instancename		bug: t101447	change-id: i954ac93e29f80e22bebe73a5804b073388888dd2	|make 'field' / 'fields' shell functions available to everyone		both faidon and aaron have requested that i make these functions more generally	available.		bug: t102793	change-id: i8f1ea341d63af5161aed88bad604835fb54276cd	|"																																																																																																																																																																																																																																																																																																																																																																			
"puppet ssl dir is not the same on production or labs		the `puppet_ssldir` function seems to take care of this difference.		bug: t124444	change-id: ie8186fded68940ce4b164b38a241ec3939adc02e	|factorized code exposing puppet ssl certs		k8s module has been taken as a model for how to expose certificates		the way certificates are exposed has been simplified:		* single directory with all certs	* ca cert is already available at '/etc/ssl/certs/puppet_internal_ca.pem'	  so we do not expose it again		refactoring of the k8s module has been split to another commit as it require	more work than initially planned.		bug: t124444	change-id: i0d6976675f48679cfec78120d4a09cfef73970bd	|"																																																																																																																																																																																																																																																																																																																																																																			
"raise default conntrack table size		the services which are currently using connection tracking usually peak	around 40k connections tracked (several high traffic services also	use notrack).		still"	" since the effects of a filled-up table are rather drastic (no	further connections accepted)"	" let's leave some additional headroom	for situations like ddoss etc.		the additional memory consumption is negligable with modern hardware:	according to /proc/slabinfo one table entry uses 312 bytes of memory"	"	so extending it by a factor of 4 requires an additonal 58 megabytes of	memory.		the sysctl value net.netfilter.nf_conntrack_buckets is read-only"	" it	can only be configured through a modprobe parameter or via echoing to	/sys/module/nf_conntrack/parameters/hashsize		ship a configuration file in /etc/modprobe.d to set that value on reboot	and in addition configure it for existing installations via	""echo 32768 > /sys/module/nf_conntrack/parameters/hashsize"".		when starting nf_conntrack with a hashsize of 32768"	" nf_conntrack_max	is preset to 262144 by the linux kernel"	" so use that as the basis.		ps8 with the onlyif variante which only runs once.		bug: t105307	change-id: iec9c051a7a0a941b21f6a297f974d99d17d5b655	|the argument passing to check_conntrack is incorrect"	" it doesn't provide	getopt-style argument parsing and with the currently passed arguments the	script only displays the usage information.		bug: t105154	change-id: i9b830d34fab97b19852aaa681f231ddac690181f	|monitoring: detect saturation of nf_conntrack table		bug: t105154	change-id: idf21587618d76dc0fb685f17320c4004cd37c05c	|"																																																																																																																																																																																																																																																																																																																																																												
"don't install root password if has_admin = false		if we're not installing accounts or passwords"	" also	don't install the root password.  previously the	root password was getting installed on labs instances	which is not something we want.		bug: t142216	change-id: i5c2ace43e8427c607d0b8754c4c1ac29b891b0f6	|workaround for mdadm boot-time race condition		the boot-time race condition assembling raid devices reported in t131961	can be avoided by sleeping a few seconds in initramfs-tools' local-top	stage"	" after which the root device is expected to be present.		see faq 26. in /usr/share/doc/mdadm/faq.gz.		this patch introduces a new puppet module called initramfs"	" allowing to	define initramfs hooks and scripts.		bug: t131961	change-id: i12db18dee30c67f98f7dd567e7527d43c134c5a7	|blacklist kernel modules		maintain a list of kernel modules blacklisted from autoloading through udev	or other automated loading mechanisms. initially only blacklist overlayfs"	"	but more to follow in a later commit.		bug: t102600	change-id: i3325cf131e9e18078bcdf657e14aab0b4ba27872	|for cert names"	" use the fqdn instead of the ec2id.		this is safe now because fqdn includes project name"	" hence unique.		bug t95480		change-id: ifb387bffcb23c8fa9dcfba3fb602b2c97d8cb263	|cleanup base::remote-syslog		* rename to base::remote_syslog	* add parameters to replace hostname and realm switches	* add hiera config to set default central host to syslog.eqiad.wmnet	* disable globally in labs realm	* enable in deployment-prep project and forward to logstash on custom port		bug: t98289	change-id: i038078fb48a88e1b4bc4fe73f4ac5db8afe9ef8d	|change bz references to phabricator tickets		except in the mediawiki module		bug: t96431	change-id: i6b36e500635537e28520bf5bd61585ff00a41755	|on debian"	" ensure that idmapd is running on labs instances.		(this is weirdly scattered in two places"	" begging for a refactor	of the base labs config.)		bug t87309	change-id: ia643948c738d0dd333674de6f047c9ab5e47654c	|labs: reduce acct archiving retention		in our standard packages we install 'acct' which does user and process	accounting (see commands 'ac' and 'lastcomm').  the log are held in	/var/log/account which"	" on labs is a 2gb partition that ends up filling	quite rapidly on busy instances.		on the beta cluster deployment-bastion instance"	" it takes up to 500mb or	a quarter of the /var instance.  reading the sal i noticed we keep	cleaning up manually to reclaim disk space.		the files are rotated via a daily cron using the 'savelog' command. it	is passed $acct_logging which default to 30 days.  reduce it on all labs	instance to 7 days.		see also	https://wikitech.wikimedia.org/wiki/incident_documentation/20140910-betacluster		bug: 69604	change-id: iae6adb6e5783e6ddbcba11779d204aff8e76f9b9	|don't try to reset $certname		for a minute there i thought that puppet was a real language	with mutable variables.		for bug: 63322		change-id: id515ec4a7303af49f2d17c99da10b7454417f0ec	|labs: prevent ec2id fact from returing errors		if the curl to the master fails"	" return nothing rather than	the 500 body (which destroys the configuration); base will	check of that and fail rather than mangle puppet.conf		bug: 63322	change-id: i24b80009aa54edfe3904e01b01800a5c62853e91	|"																																																																																																																																																																																																																																																																																																																																																								
"mdadm boot-time race condition: sleep in init-premount		the change introduced in ebe9658 does not seem to fix t131961.		as mentioned in https://phabricator.wikimedia.org/t131961#2274674"	" this	is probably due to the fact that systems could attempt mounting root	before the local-top boot stage. sleep in init-premount instead.		bug: t131961	change-id: i08a07d375971bde53b5b621a1712f2031591e4cc	|workaround for mdadm boot-time race condition		the boot-time race condition assembling raid devices reported in t131961	can be avoided by sleeping a few seconds in initramfs-tools' local-top	stage"	" after which the root device is expected to be present.		see faq 26. in /usr/share/doc/mdadm/faq.gz.		this patch introduces a new puppet module called initramfs"	" allowing to	define initramfs hooks and scripts.		bug: t131961	change-id: i12db18dee30c67f98f7dd567e7527d43c134c5a7	|"																																																																																																																																																																																																																																																																																																																																																																
"disable unprivileged user namespaces on trusty systems		by default trusty allows the creation of user namespaces by unprivileged users	(debian defaulted to disallowing these since the feature was introduced for security reasons)	unprivileged user namespaces are not something we need in general (and especially	not in trusty where support for namespaces is incomplete) and was the source for	several local privilege escalation vulnerabilities. fortunately the 3.13.0-91 release	introduced a backport of the debian patch allowing to disable the creation of user	namespaces via a sysctl. there's a few servers we haven't been able to migrate to	that kernel for technical reasons"	" so make the creation of the sysctl dependant on	the kernel release.		this creates the sysctl setting to enable this during boot"	" the existing	trusty fleet will be disabled via salt.		the effectiveness of the backport on current trusty kernels was tested using	the example code from user_namespaces(7).		bug: t142567	change-id: i5136d33d7f1ee112b095bf06b016cc61325348ba	|blacklist kernel modules		maintain a list of kernel modules blacklisted from autoloading through udev	or other automated loading mechanisms. initially only blacklist overlayfs"	"	but more to follow in a later commit.		bug: t102600	change-id: i3325cf131e9e18078bcdf657e14aab0b4ba27872	|"																																																																																																																																																																																																																																																																																																																																																																
"set up a root password for labs instances		this is only done if the current puppetmaster == the official	labs puppet master defined in hiera to avoid hitting up every	random puppet::self master for a root password.		bug: t142531		change-id: i45c2a2e4b87aebc650f7bf5c4926e6b2cf24625c	|labs: generate/store root passwords for instances		each project will have a root password that applies to all	project instances.  the password is stored in	/var/local/instance-root/passwords/$projectname on the labs	puppetmaster.		passwords are automatically regenerated if the file is missing"	"	so removing the password file is an easy way to reset passwords	if needed.		bug: t142216	change-id: ia9eb2bdb5879fe074ecb9e175f57f3849ff52821	|only check puppet freshness once per day"	" not 60 times in a row.		bug: t121773	change-id: ic42cfcbb55ecfd3244f061372053245c1360b96b	|enable memory cgroups for labs debian instances		this won't take effect until reboot"	" but a followup patch will	apply it to the base image as well.		bug: t122734	change-id: i13f1989070e24127a75addeb538c2be58633dd2a	|send email to project admins if puppet runs are failing.		install a daily cron that sends an eail to all project admins if	it has been more than 24 hours since the last puppet run.		this is only enabled in tools for the time being.  if it doesn't	run horribly amok then we'll enable it labs-wide.		bug: t121773	change-id: i20c60008cfc46842cc1b91a2087ccb4b77c7173a	|"																																																																																																																																																																																																																																																																																																																																																																
"create raid module to hold raid monitoring checks		move check-raid.py and associated packages and definitions away from	base::monitoring::host and into a new ""raid"" class"	" init class of the	new ""raid"" module. not much win so far"	" more will follow.		bug: t84050	change-id: ifb3e9dd0ed78cf6fa7b37f576ae0302c668e966a	|icinga: ensure hiera lookups for all contact_group defs		some defs like in base are likely overwriting and acting as global values.	this would mean hiera is either not looked at all or is overwritten.		bug:t111243	change-id: icb3b039a067af656b727fa6b1ebea7d1d9187f65	|fix the use of $nagios_group.		this is again needed for puppet 3 migration"	" as definitions of	$nagios_group deep down in classes will not work there. also"	" i fixed an	apparent bug where in general we did not set the correct	hostgroup.		the logic now is:		- if $group is explicitly declared in the resource definition"	" use that	- else if $nagios_group is explicitly defined at node level"	" use that	- else if $cluster is defined at node level and is not 'misc'"	" use	  ${cluster}_$::{site} (es cache_bits_eqiad). this does not apply to	  servicegroups for individual services that have no default value	- else"	" leave this undefined.		this should not only retain the definitions as is almost everywhere"	" but	also define the servicegroup/hostgroup in a few places where it's	currently undefined.		change-id: i50c8d5c96b2541b1b926a98c8006ccdc665665e6	signed-off-by: giuseppe lavagetto <glavagetto@wikimedia.org>	|fix bug introduced in i4a7a2c71be		obviously base module"	" not nrpe module		change-id: i43e60fe5cc80e29c650df7a48e70cf06cb8c6d19	|"																																																																																																																																																																																																																																																																																																																																																									
"base: move mysterious_sysctl from webserver		also webserver module is dead!		bug: t118786	bug: t118812	change-id: i53743262fd1413fae79cd6e2b3d7cc1f3d4e3628	|"																																																																																																																																																																																																																																																																																																																																																																			
"base: allow adding sans to puppet csrs		setting base::puppet::dns_alt_names to a comma separated	list of alt names will make puppet request a certificate	with that set of names in the san field. this can be	signed on the puppetmaster manually with:		puppet cert --allow-dns-alt-names sign <hostname>		bug: t119814	change-id: i04dfbc90bcb5e8ff65b7bbd10ea4c31051a00574	|puppet: do not 'ensure latest'		do not let puppet automatically upgrade itself.		bug: t115348	change-id: ic4b14952b3d5f3847bf3588539f83c02cde2ce12	|"																																																																																																																																																																																																																																																																																																																																																																			
"base: support for multiple syslog hosts		bug: t138073	change-id: i59113d1d4a19218d6c67fd1f38790fd4eee9ca37	|increase size of programname field in remote syslog template		bug: t120874	change-id: i90dfa48c26ec522d746a473773e97817185e05fd	|beta: replace deployment-logstash1 with deployment-logstash2		bug: t101541	change-id: iffc3e62439d6bbccf7f5e215c1bfb56eab6f33c0	|cleanup base::remote-syslog		* rename to base::remote_syslog	* add parameters to replace hostname and realm switches	* add hiera config to set default central host to syslog.eqiad.wmnet	* disable globally in labs realm	* enable in deployment-prep project and forward to logstash on custom port		bug: t98289	change-id: i038078fb48a88e1b4bc4fe73f4ac5db8afe9ef8d	|"																																																																																																																																																																																																																																																																																																																																																																			
"base: allow hiera to override ldap use_dnsmasq variable		bug: t95240	change-id: iaa38223e57f8ae6e4ebeeeb4115feb8876c2605f	|disable automatic updating of resolv.conf		tested on precise"	 trusty	" jessie.		bug: t93691	change-id: i26b3eb07c98cb09cbe75b80a8c22736a35ac4232	|"																																																																																																																																																																																																																																																																																																																																																																	
"beta: move deployment server		this patch is everything that was cherry-picked on beta's puppetmaster	in order to move the deployment server in beta from deployment-bastion to	deployment-tin.		* retitle git::clones inside beta::autoupdater"	" conflict with	  git::clones in scap::l10nupdate.		* don't mount nfs to deployment-tin since we want to get rid of nfs in	  beta.		* change all instances of ""deployment-bastion"" to ""deployment-tin""		* change all instances of the old ip (10.68.16.58) to the new ip	  (10.68.17.240)		bug: t126377	bug: t126568	bug: t126537	change-id: i5322b68dfe2e34d0a9170abd31a03f3afbda3907	|beta: add script from jenkins beta-update-databases		bug: t96199	bug: t98342	change-id: ie063022b7b4bfc7fa4e1dac2fd15f32bf3a02d3d	|scap: move 'common_scripts' into scripts class		a mechanical move		bug: t87221	change-id: icba39e8e70680b7bbb2b47646f88f54ea9c52781	|beta: clone mediawiki/vendor instead of mediawiki/core/vendor		use mediawiki/vendor instead of mediawiki/core/vendor. it was	requested to rename this repository during rfc discussion.		bug: 68485	change-id: ie9fd0465de5804bc0f334aefd7e50829ac2d261e	|move beta scap source directory off of nfs		change the directory that receives mediawiki code and configuration via	jenkins job updates from the nfs mounted	/data/project/apache/common-local/ to a local directory on	deployment-bastion.		configuration has been added to the beta::autoupdater class to ensure	that a clones of operations/mediawiki-config.git"	" mediawiki/core.git and	mediawiki/extensions.git are present in the new staging directory along	with an l10n cache directory and a localsettings.php file. note that the	wmf-config/privatesettings.php file will still need to be copied or	created by had for the deploy to be fully functional.		also cleanup configuration differences that were needed while scap was	being tested in beta as a parallel deployment process.		bug: 63746	change-id: i4cbd312e19a9b590760bba8e776fa5f816e20e34	|"																																																																																																																																																																																																																																																																																																																																																																	
"beta: move deployment server		this patch is everything that was cherry-picked on beta's puppetmaster	in order to move the deployment server in beta from deployment-bastion to	deployment-tin.		* retitle git::clones inside beta::autoupdater"	" conflict with	  git::clones in scap::l10nupdate.		* don't mount nfs to deployment-tin since we want to get rid of nfs in	  beta.		* change all instances of ""deployment-bastion"" to ""deployment-tin""		* change all instances of the old ip (10.68.16.58) to the new ip	  (10.68.17.240)		bug: t126377	bug: t126568	bug: t126537	change-id: i5322b68dfe2e34d0a9170abd31a03f3afbda3907	|move beta scap source directory off of nfs		change the directory that receives mediawiki code and configuration via	jenkins job updates from the nfs mounted	/data/project/apache/common-local/ to a local directory on	deployment-bastion.		configuration has been added to the beta::autoupdater class to ensure	that a clones of operations/mediawiki-config.git"	" mediawiki/core.git and	mediawiki/extensions.git are present in the new staging directory along	with an l10n cache directory and a localsettings.php file. note that the	wmf-config/privatesettings.php file will still need to be copied or	created by had for the deploy to be fully functional.		also cleanup configuration differences that were needed while scap was	being tested in beta as a parallel deployment process.		bug: 63746	change-id: i4cbd312e19a9b590760bba8e776fa5f816e20e34	|"																																																																																																																																																																																																																																																																																																																																																																	
"add beta-specific access.conf exceptions in scap::target		explicitly allow scap-managed users to log in to targets from the	deployment host. refs t121721		bug: t121721	change-id: i3a5b08b0a9c31d8984aac503d8e94fdab00a75cf	|beta: move deployment server		this patch is everything that was cherry-picked on beta's puppetmaster	in order to move the deployment server in beta from deployment-bastion to	deployment-tin.		* retitle git::clones inside beta::autoupdater"	" conflict with	  git::clones in scap::l10nupdate.		* don't mount nfs to deployment-tin since we want to get rid of nfs in	  beta.		* change all instances of ""deployment-bastion"" to ""deployment-tin""		* change all instances of the old ip (10.68.16.58) to the new ip	  (10.68.17.240)		bug: t126377	bug: t126568	bug: t126537	change-id: i5322b68dfe2e34d0a9170abd31a03f3afbda3907	|puppetize eventlogging-service with systemd in role::eventbus		deployment via scap3.		this patch works in beta.  there is still work to be done"	"	but the patch is getting too large.  further work	will proceeed in new changes.		no changes on eventlog1001 according to	https://integration.wikimedia.org/ci/job/operations-puppet-catalog-compiler/1506/		todo: move role::eventbus::eventbus back to role::eventbus when t119042 works.	todo: use role::kafka::* to get kafka config.		bug: t118780	change-id: i621de844ed7a5bd1ac532b52058925350d9e5337	|add a new security module with ::pam and ::access		this helps clean up security configuration mostly in labs right	now"	" but provides general-use classes and defines to customize	pam configuration cleanly (including access.conf handling)		bug: t120106	change-id: id0183e2bc677c6d4893aeb2956c3e3650b174da6	|"																																																																																																																																																																																																																																																																																																																																																																
"beta: new script to restart apaches		introduce a new utility script that wraps the proper salt command to	send start|stop|restart|graceful messages to the mediawiki apache hosts in the	beta cluster. this script is provisioned by a new	beta::saltmaster::tools puppet class that can be used to deploy	additional scripts of a similar nature as they are found to be needed.		bug: 36422	change-id: ia351ef7e997c3acc4a4d44b1c5e757bfc838a2cb	|"																																																																																																																																																																																																																																																																																																																																																																			
"beta: allow defining the web user.		bug: t78076	change-id: i67f6db4ccc9e190ef49c1159991ab7f275a280df	signed-off-by: giuseppe lavagetto <glavagetto@wikimedia.org>	|"																																																																																																																																																																																																																																																																																																																																																																			
"bugzilla-static: ensure_resource to fix duplicates		use ensure_resource instead of regular file definition	to avoid duplicate declaration puppet errors when combining	multiple roles on one host that all want to ensure /srv/org/wikimedia.		change-id: ib2683860d422ae0991618b979574892adc24607e	|bugzilla: remove module"	" keep static version		bug:t103193	change-id: ie462d2fcb20f50cad81a4c81c0a8623a3141fed5	|"																																																																																																																																																																																																																																																																																																																																																																		
"increase length of lag window to 100		burrow evaluates lag in length window of 10 offsets by default.	we are committing offsets every second so the default frequency would	make us evaluate lag every 10 secs which is too frequent.	trying one order of magnitude higher so lag is evaluated on a 100 second	window.		burrow docs: https://github.com/linkedin/burrow/wiki/configuration#lagcheck		bug: t125916	change-id: i3de44b3f8c4d30af2679656fbe92a7fe37e7012e	|add subscribe config file for kafka's burrow service	bug: t123942		change-id: idb6ee301aefe0050332fef8929f4696c77c8c4c2	signed-off-by: elukey <ltoscano@wikimedia.org>	|burrow: add new module for burrow		burrow(https://github.com/linkedin/burrow) is a consumer lag	monitoring tool for kafka"	" it will monitor the consumer groups on our	kafka clusters and send emails on their status.		this patch installs and runs burrow on krytpon.		bug: t115669	change-id: iaf6b2ee804df8f5e951fc7ced770b2565e3adb65	|"																																																																																																																																																																																																																																																																																																																																																																		
"logrotate camus log files		bug: t110598	change-id: iae8b6af978a99f6607ba000a46e0d93dee1985b6	|add camus module"	" use camus::job to import eventlogging data		i will move the webrequest import job once this is verified to work.		bug: t115114	change-id: i6ce581943d3bcadc2efdb01ef3e13a96cc723e71	|"																																																																																																																																																																																																																																																																																																																																																																		
"update camus job to use new check_jar		refinery packaging has changed. camuspartitionchecker is now in	refinery-camus jar instead of refinery-job jar. this update reflects	that change.		bug: t142717		change-id: ibd8a82b82572fa2539dd369b838f32a5daf6904d	|remove unused analytics role classes		bug: t109859	change-id: i48f7d76255ca0bf04322cd4e6e306e1a60ebf374	|add $check_jar and $camus_jar parameterize to camus::job		this allows us to hardcode specific releases of dependencies	when camus is launched at runtime.  this will avoid unintentional	bugs in new releases from unexpectedly affecting working jobs.		change-id: ic86284fb3da5f7ebdedbadee224bfab2cbdbc036	|update camus runs		add run parameter to match script update	add check parameter to webrequest job		bug: t113252	change-id: i5db0f95859ca52ee2cf4f40ead88f68c66607e5a	|add camus module"	" use camus::job to import eventlogging data		i will move the webrequest import job once this is verified to work.		bug: t115114	change-id: i6ce581943d3bcadc2efdb01ef3e13a96cc723e71	|"																																																																																																																																																																																																																																																																																																																																																																		
"cassandra: new class ca_manager		also rename cassandra-ca-mgr into cassandra-ca-manager"	" introduce a related	class to install it on the node hosting private.git		the ca manager will generate a ca"	" plus all related public/private	material and the related keystores to be used by cassandra. the list of	certificates to generate is supplied to the manager by a yaml manifest"	" both	the manifest and the resulting material are stored in private.git.		bug: t108953	change-id: i33800945788e5f9a81def508b9456d259ad608da	|"																																																																																																																																																																																																																																																																																																																																																																
"configurable trickle_fsync		this changeset makes trickle_fsync in cassandra configurable"	" both enabling	the feature"	" and adjusting the fsync() interval.		the default used here (30240) isn't necessarily the best overall default	(it differs from the one shipped in cassandra)"	" but it's meant to keep this	changeset a no-op on wmf production systems.		bug: t140825	change-id: i5e1a9c4dc82191fc670d511618b21fbf3d7ca132	|ensure base cassandra directory is created.		this introduces a new cassandra::default_data_directory_base parameter"	" used	only for default instances (not multi-instances)"	" which is used to ensure	the base directory is created.		this is fairly ugly as it introduces one more difference between single and	multi instance (note that we already have quite a few parameters following	this pattern).		a probably better alternative would be to remove everything related to	instances from ::cassandra and let the caller manage either single or multi	instance. but that's a bit more than i am willing to risk with my current	understanding of the usage of this module.		better proposal welcomed!		bug: t138092	change-id: if69ef8dfff534d178472527c8c4fc47cffa7df10	|cassandra: default to 2.2.6-wmf1		we are ""past"" 2.2.6 by now with the histogram fixes applied in 2.2.6-wmf1"	"	default to that version instead.		bug: t137952	change-id: i170cc2af61211bd98394d60edaff82a84aa931ce	|cassandra: pin cassandra version		this will need a puppet commit whenever we want to upgrade one host"	" but	it should be easy to manage and will prevent installing a wrong version	because upstream has been upgraded. if you are upgrading the package"	"	you can just override the setting with the cassandra::version hiera	variable.		bug: t135749	change-id: ib3774624da7281a4653ad5ff7481ecdb61c9d0f1	|cassandra 2.2.6 config		this introduces a new variable"	" cassandra::target_version.  valid values for	cassandra::target_version are '2.1' and '2.2' (defaults to '2.1').  the values	correspond with cassandra minor versions (2.1.x and 2.2.x respectively)"	" and	result in a version appropriate configuration.		for systems that are (and should continue to be) cassandra 2.1"	" this changeset	should be a no-op.		bug: t126629	change-id: i24a19f5bae00696d5223327501e615723081c6f3	|disable package-installed initscript		this replaces the initscript (a debian conffile) with a no-op version.		bug: t127365	change-id: id075ca0a0a8166d5c0e18903b66ab977d79b06cf	|cassandra: enable multi-instance		create new cassandra instances as instructed by $instances. default behaviour	is to keep a single instance in the same place as the debian package.		also move handling of logback.xml and logback-tools.xml from cassandra::logging	to cassandra::instance.		bug: t95253	change-id: i925d36e3f331f4b6d79a8ccc54d98e9fd1f2a5e8	|cassandra:  dequote some booleans.		note that in e.g.	https://svn.apache.org/repos/asf/cassandra/trunk/conf/cassandra.yaml	booleans are left naked.  erb should handle that just fine.		bug: t113783	change-id: i7c9363a9546c63b5204998a876a7f117798903f3	|create application users		* adds a cqlshrc template to allow password-less invocations of cqlsh	* adds a user creation script template (to be interpreted by cqlsh)		bug: t92590	change-id: i4372ec4009e9193358ef6443cec901828c7563f9	|cassandra: install certs and ca from private.git		also make server encryption configurable"	" but disabled.		bug: t108953	change-id: i1554b0e2a10338d3e1b5e35f951b975bf9c46b1a	|cassandra logstash setup		- sets up a logstash udp input that uses the json codec on port 11514	- deploys logstash-logback-encoder artifacts on cassandra hosts	- configures cassandra to use udp appender		bug: t100970	change-id: idc5cfc8c5b53e8dac88dbed9e506eee79568903e	|cassandra: restrict data directory permissions		bug: t106133	change-id: i59d8552cf71890154b127b8f847b9e035fb80b69	|cassandra: fix strict puppet-lint warnings		bug: t87132	change-id: i5760bd4c8e32af82d66e25ed07c837f6e6b84e2a	|"																																																																																																																																																																																																																																																																																																																																																							
"ensure base cassandra directory is created.		this introduces a new cassandra::default_data_directory_base parameter"	" used	only for default instances (not multi-instances)"	" which is used to ensure	the base directory is created.		this is fairly ugly as it introduces one more difference between single and	multi instance (note that we already have quite a few parameters following	this pattern).		a probably better alternative would be to remove everything related to	instances from ::cassandra and let the caller manage either single or multi	instance. but that's a bit more than i am willing to risk with my current	understanding of the usage of this module.		better proposal welcomed!		bug: t138092	change-id: if69ef8dfff534d178472527c8c4fc47cffa7df10	|include a cassandra::instance::monitoring class		in order to follow the single responsability	principle"	" it could be great to externalize the	monitoring setup from the general cassandra	setup. this is the next step to include the	monitoring setup in all the calls to ::cassandra		bug: t137422		change-id: i9177f9797bfb5a13696fa3ad2b9af5264def5513	|include a cassandra::instance::monitoring class		in order to follow the single responsability	principle"	" it could be great to externalize the	monitoring setup from the general cassandra	setup		bug: t137422		change-id: i10ad530189eb907f033fc23b28136b6c9e3f76c6	|cassandra 2.2.6 config		this introduces a new variable"	" cassandra::target_version.  valid values for	cassandra::target_version are '2.1' and '2.2' (defaults to '2.1').  the values	correspond with cassandra minor versions (2.1.x and 2.2.x respectively)"	" and	result in a version appropriate configuration.		for systems that are (and should continue to be) cassandra 2.1"	" this changeset	should be a no-op.		bug: t126629	change-id: i24a19f5bae00696d5223327501e615723081c6f3	|add cql interface and port to descriptors		bug: t132958	change-id: iaf845ad9923c52193a499e0017868a2ab663c940	|cassandra: multi-instance aware cql checks		install multiple check_tcp checks"	" one for each cassandra instance		bug: t93886	change-id: if41939c44a51d3d603d0058c26598e7e3a2b14d3	|"																																																																																																																																																																																																																																																																																																																																																											
"cassandra: add ssl monitoring only for ssl-enabled hosts		bug: t120662	change-id: ib9fcf8ce260b08d44585c570138232eb71c88fb2	|cassandra: limit ssl cert monitoring to restbase hosts		the new ssl cert monitoring added in i93d2e34c059ba0155	works fine for restbase* hosts but does not work the same	way on aqs* and maps* hosts which also use this role class.		this is to remove the alerting icinga checks that say this is	a crit on these non-restbase hosts.		maybe there is a better long-term solution though?		bug: t120662	change-id: i4af087c9c23cd7f5fedf0d7f8baf7cc66c60e345	|cassandra: add instance ssl monitoring		bug: t120662	change-id: i93d2e34c059ba0155b48a68c8e6127df8ca32a21	|include a cassandra::instance::monitoring class		in order to follow the single responsability	principle"	" it could be great to externalize the	monitoring setup from the general cassandra	setup		bug: t137422		change-id: i10ad530189eb907f033fc23b28136b6c9e3f76c6	|"																																																																																																																																																																																																																																																																																																																																																																		
"filter statuslogger messages from udp appender		this changeset requires that https://gerrit.wikimedia.org/r/#/c/277264	be applied first (and that the corresponding jars have fully deployed).		bug: t128787	depends-on: i6e2e24f1acc53141168f08f34bc3c77b9692daaa	change-id: i9f65f0de131057d4060c6fabb8fa13b1d17c3288	|cassandra: enable multi-instance		create new cassandra instances as instructed by $instances. default behaviour	is to keep a single instance in the same place as the debian package.		also move handling of logback.xml and logback-tools.xml from cassandra::logging	to cassandra::instance.		bug: t95253	change-id: i925d36e3f331f4b6d79a8ccc54d98e9fd1f2a5e8	|cassandra logstash setup		- sets up a logstash udp input that uses the json codec on port 11514	- deploys logstash-logback-encoder artifacts on cassandra hosts	- configures cassandra to use udp appender		bug: t100970	change-id: idc5cfc8c5b53e8dac88dbed9e506eee79568903e	|"																																																																																																																																																																																																																																																																																																																																																																			
"enable updated cassandra-metrics-collector version		bug: t126629	change-id: i0e652dacc9ed6246537aade68858c5b237681c73	|cassandra 2.2.6 config		this introduces a new variable"	" cassandra::target_version.  valid values for	cassandra::target_version are '2.1' and '2.2' (defaults to '2.1').  the values	correspond with cassandra minor versions (2.1.x and 2.2.x respectively)"	" and	result in a version appropriate configuration.		for systems that are (and should continue to be) cassandra 2.1"	" this changeset	should be a no-op.		bug: t126629	change-id: i24a19f5bae00696d5223327501e615723081c6f3	|update cassandra-metrics-collector version		new version enables whitelisting.		bug: t134016	change-id: i1660788981c8ff64ad58fc9c1b15abe523936cec	|blacklist some meta-table cassandra metrics		whitelists a curated set of metrics"	 mostly related to rate	 latency	" and	size"	" and blacklists the remaining.  requires cassandra-metrics-collector	support for whitelisting"	" found here:		https://github.com/wikimedia/cassandra-metrics-collector/pull/9 and	https://github.com/wikimedia/cassandra-metrics-collector/pull/10		bug: t134016	change-id: i423742774310344395f4009e0447a8ad9e0422bf	|cassandra: new metrics-collector version		deploy a new version of cassandra-metrics-collector"	" featuring:	* daemon mode	* metrics blacklist	* cassandra instance auto-discovery via cassandra.instance-id jvm property		bug: t113733	change-id: ie98a120f4facf48c3a8786002ef9f75881ce2285	|update cassandra-metrics-collector version		this changeset depends on: https://gerrit.wikimedia.org/r/#/c/230582/		bug: t101764	change-id: i41c2b09cd7cb1fadfbdc45871d5458b04f4102fe	|update cassandra-metrics-collector to latest		bug: t97024	change-id: ia88e320d18e50c53a6f99ab7bda1218ef6db5480	|cassandra: use lock file with flock		bug: t104208	change-id: i28f97cf3163dc250e2c014207b717bc025dfd4bc	|cassandra: alternative metrics collector		add a new trebuchet-deployed repository to ship a jmx-based metrics collector	which pushes metrics to graphite. we've found the built-in dropwizard metrics	reporter to be unreliable"	" given that jmx is used in cassandra to be the source	of truth this reporter should provide much more reliable metrics.		bug: t104208	change-id: i370c699222002b62352ddcae3a0e73b72329b4b9	|"																																																																																																																																																																																																																																																																																																																																																									
"configurable `vm.dirty_background_bytes` parameter		creates a cassandra-specific mechanism for assigning a value to	`vm.dirty_background_bytes`"	" and sets the parameter to 24mb on the restbase	cassandra clusters.		since this is essentially a host-wide way of accomplishing what `trickle_fsync`	does"	" this changeset also disables `trickle_fsync` for the restbase cassandra	clusters.		bug: t140825	change-id: i1c47ac91e6e3c3edf99a5b65228804c8836f11c3	|"																																																																																																																																																																																																																																																																																																																																																																	
"cgred changes for toollabs bastions use case		- allow explicit ordering of fragments for cgrules.conf	- purge unmanaged entries for conf and rules	- raise shell memory limits	- use '%' to match across subsystems		bug: t131541	change-id: i5959482c2bdc4cfaf5dd94a9e4082ff21b7d02c4	|labs: setting up to use cgrules engine		bug: t131541	change-id: if0610ebe28d6af7beaa7c99339ed6f1a50b4f1ad	|"																																																																																																																																																																																																																																																																																																																																																																			
"cgred: fix indentation of =>		bug: t93645	change-id: i8fbb3ab38f4eeca703be95928933adffa2c89c18	|cgred changes for toollabs bastions use case		- allow explicit ordering of fragments for cgrules.conf	- purge unmanaged entries for conf and rules	- raise shell memory limits	- use '%' to match across subsystems		bug: t131541	change-id: i5959482c2bdc4cfaf5dd94a9e4082ff21b7d02c4	|toollabs: bastion fixup perms for cgred		bug: t131541	change-id: ic09b7ab529dc2dcd9c2fbb44d676b85d9ab1932c	|labs: setting up to use cgrules engine		bug: t131541	change-id: if0610ebe28d6af7beaa7c99339ed6f1a50b4f1ad	|"																																																																																																																																																																																																																																																																																																																																																																			
"change prop: increase heap limit to 750 mb		with concurrency limiting"	" the service needs to be able to sustain	bursts of messages"	" which needs a temporary increase in the amount of	memory used by the process so it can store in memory extra messages	consumed from kafka before consumption has been paused.		increasing the limit in this instance is safe because"	" unlike other	services"	 change-prop uses only one worker per defined rule	" so the	increase in memory consumption will be seen only on a fraction of	workers"	" not across the board.		bug: t134456	change-id: ie89ef9f601c0668747d01f8ff383b4e8f627f305	|changeprop: set hyperswitch as the start-up module		there was a bug in the service's configuration where the service was	started using src/app.js. alas"	" that file doesn't even exist. change	propagation uses hyperswitch as its load module"	" so use it.		also"	" update the config as v0.2.0's config is not compatible with the	old one.		change-id: iaea347eb56448e36fc7372f839aee41d7bb0f368	|introducing changeprop role and puppet module		bug: t128463	change-id: ib61a839fb670bda3dc27b4499e48a9eb452f4d0f	|"																																																																																																																																																																																																																																																																																																																																																										
"introducing changeprop role and puppet module		bug: t128463	change-id: ib61a839fb670bda3dc27b4499e48a9eb452f4d0f	|"																																																																																																																																																																																																																																																																																																																																																																			
"citoid: switch to the scap3 deployment method		bug: t116337	change-id: ia713a539cb825a2fac667fe9d496fbd11e1302dc	|remove firejail conditional		now that firejail"	" graphoid and mathoid have been migrated to firejail	in production"	" remove the ""firejail"" conditional in service::node and	use firejailed execution for all upcoming services.		bug: t101870	change-id: i0970967a2eb7e8d9b21ef361d6107702f20e15d1	|enable firejail for citoid		enable firejail for citoid (preliminary tests were fine (both using	zotero and citoid making the request itself))"	" more to follow.		bug: t98851	change-id: i67e23692ff1c2d3bbc16f2583fca7a4b9d54ee77	|add a generic node service module		service::node is a generic puppet resource that allows node.js services to be	easily set up on the sca cluster. since all such services are set up in	the exact same way"	" most of the code can be shared between them. the	only specific parameters are a service's port and own configuration	directives. the other parameters of service are controlled by	role::sca's hiera.		as an example"	" role::citoid has been converted to using service::node	instead of its own citoid module.		bug: t95533	change-id: ic6c9d4f8d0b086b94d167fd9449377a87734456b	|puppetise citoid's configuration		localsettings.js is now controlled by puppet with the information from	the citoid class"	 as well as the lvs config	" thus keeping it updated	with any eventual changes there. also"	 because of this change	" the	service now reads its config from /etc/citoid/localsettings.js rather	than the file deployed with the repository.		bug: t89875	change-id: i3ceb235edbabbe48a00633c428c51b0588f98b9b	|"																																																																																																																																																																																																																																																																																																																																																										
"confd: monitor template failures and file removals		bug: t103360	change-id: i75c6a08e16c31d8499a6b8eaba91fd7c85dcf10d	|confd: create module		this module allows to define configuration files to be	monitored/generated via confd.		bug: t97974	change-id: icc0e87e274d2a53a3308f4411a98d16c37314f8e	|"																																																																																																																																																																																																																																																																																																																																																																			
"confd: monitor template failures and file removals		bug: t103360	change-id: i75c6a08e16c31d8499a6b8eaba91fd7c85dcf10d	|confd: create module		this module allows to define configuration files to be	monitored/generated via confd.		bug: t97974	change-id: icc0e87e274d2a53a3308f4411a98d16c37314f8e	|"																																																																																																																																																																																																																																																																																																																																																																			
"add new confluent module and puppetization for using confluent kafka		bug: t132631	change-id: i36d9e6f50da554f1674294e805fe03f1071c5016	|"																																																																																																																																																																																																																																																																																																																																																																			
"add the analytics contact group to hadoop/kafka related nrpe monitors.		the final goal is to raise awareness of kafka/hadoop issues directly on	the analytics irc channel.		bug: t125128	change-id: ifa5da3308225645620da45a8e3e4695ad82b531f	|fix for kafka broker process alert for confluent brokers		bug: t121562	change-id: i7597bd43a08eabe4c4a2a09cec89554baad2ec52	|add new confluent module and puppetization for using confluent kafka		bug: t132631	change-id: i36d9e6f50da554f1674294e805fe03f1071c5016	|"																																																																																																																																																																																																																																																																																																																																																																			
"update zookeeper submodule and configure sending zookeeper jmx stats to statsd		this adds a new hiera variable called 'zookeeper_cluster_name' used to uniquely	id a zookeeper cluster in statsd/graphite.		this patch stops sending zookeeper metrics to ganglia.		bug: t137302	change-id: i1b70b361e7235594c33e39be7858edf7204e59ee	|add new confluent module and puppetization for using confluent kafka		bug: t132631	change-id: i36d9e6f50da554f1674294e805fe03f1071c5016	|"																																																																																																																																																																																																																																																																																																																																																																			
"confluent mirrormaker puppetization		this removes the old analytics mirror role.  it will be recreated in a new patch.		bug: t134184	change-id: i91d8545117119648c5ba4376ada6642751c8206e	|add new confluent module and puppetization for using confluent kafka		bug: t132631	change-id: i36d9e6f50da554f1674294e805fe03f1071c5016	|"																																																																																																																																																																																																																																																																																																																																																																			
"fix dependency cycle in confluent::kafka::mirror::alerts		bug: t134184	change-id: i68579e0c847bd274af88d4b4f9d6a45a66c2baaf	|confluent::kafka::mirror::alerts should require instance define properly		bug: t134184	change-id: i6b257a5b54b358df3086c14f3fdb732e89797650	|confluent mirrormaker puppetization		this removes the old analytics mirror role.  it will be recreated in a new patch.		bug: t134184	change-id: i91d8545117119648c5ba4376ada6642751c8206e	|"																																																																																																																																																																																																																																																																																																																																																																			
"confluent mirrormaker puppetization		this removes the old analytics mirror role.  it will be recreated in a new patch.		bug: t134184	change-id: i91d8545117119648c5ba4376ada6642751c8206e	|"																																																																																																																																																																																																																																																																																																																																																																			
"confluent mirrormaker puppetization		this removes the old analytics mirror role.  it will be recreated in a new patch.		bug: t134184	change-id: i91d8545117119648c5ba4376ada6642751c8206e	|"																																																																																																																																																																																																																																																																																																																																																																			
"confluent mirrormaker puppetization		this removes the old analytics mirror role.  it will be recreated in a new patch.		bug: t134184	change-id: i91d8545117119648c5ba4376ada6642751c8206e	|"																																																																																																																																																																																																																																																																																																																																																																			
"conftool: switch to using system-wide certs		bug: t114638	change-id: i1105aff3881b2a1a44d189e641f4f59676fca6ed	|conftool: create puppet module		this module installs conftool"	 sets up the configuration	" copies the ca	file and also creates a small wrapper script.		bug: t101973	change-id: i54eb9feedc3936b70b89913b30cb59eca101901a	|"																																																																																																																																																																																																																																																																																																																																																																	
"contint: install chromedriver for running mw-selenium tests		bug: t103039	change-id: iea38afbbf93185f5299defd7113cc2269061b251	|contint: update browsers package names for jessie		some packages providing browsers have different names in debian compared	to ubuntu:		firefox -> iceweasel	chromium-browser -> chromium		do not bother installing phantomjs on jessie. it is not available and we	are going to drop its usage entirely.		while at it"	" auto update firefox/iceweasel since jessie receives	updates.		bug: t95000	change-id: i74917f1feace18d560c3c4a96162aa2eb2f01978	|"																																																																																																																																																																																																																																																																																																																																																																		
"move ruby related packages to a separate file		contint::packages::ruby will let us install old ruby related things in	the nodepool disk images.		bug: t110865	change-id: i5d6741a5c83293908a2d5eed01c74bd6400e2d2a	|contint: for jessie s/ruby1.9.3/ruby2.1/		ruby1.9.3 is on ubuntu precise and trusty.	debian jessie has ruby2.1		same for the -dev package.		bug: t103600	change-id: ifa94a2038d47d2976374f7b0790fa6374c742677	|contint: rename 'qunit' localvhost to 'worker'		* remove the unused 'mediawiki' localvhost on port 9414.	* remove the unused 'browsertests' localvhost on port 9413.	* rename the 'qunit' localvhost (port 9412) to 'worker'.	* use /srv/localhost-name instead of /srv/localhost/name to	  avoid an ownership conflict over '/srv/localhost' when multiple	  localhost vhosts exist.		this generic vhost will be the shared document root for a	jenkins slave (or nodepool worker). individual executors of the	worker (e.g. 4 slots) currently mount symlinks here to the	build directories. this will continue to work.		using a generic name to avoid 'qunit' or 'mediawiki' so that it	is appropiate for use by both mediawiki/qunit jobs"	 browser tests	"	and future jobs that mount arbitrary static files	(e.g. standalone frontend libraries).		avoiding 'jenkins' for the name because it's not unthinkable to	have a server for the jenkins slave to communicate with the jenkins	master. and this is kind of a global namespace. and also"	" we won't	be using jenkins for ever"	" either.		bug: t103766	change-id: icec7de01c76400a9bd65990efe999ef04061774d	|contint: sikuli is no longer used anywhere		bug: 54393	change-id: ia1f29ee4c97e98adcd77e77348368a4da53718e4	|contint: install libsikuli-script-java for browser tests		sikuli is a java application test to test input in web browsers. going	to be used by qa to test visualeditor. luckily"	" the software has been	packaged for debian/ubuntu so it is really simple to install.		bug: 54393	change-id: i32e33f00899e77c9eb2bad88e73d718d99d9f8d9	|contint: puppet class to setup browsertests slaves		we are going to run web browser tests against visualeditor in labs	instances.  the new role::ci::slave::browsertests class provides:		* dependencies for the jenkins slave agent. currently that is just the	  openjdk-7-jre-headless package.  i have split it up from the	  role::ci::slave class which is production specific.	* a home dir on /mnt/jenkins-workspace to avoid glusterfs and use	  /dev/vdb where all the disk space is.	* dependencies needed to install qa/browsertests.git which is a ruby	* application providing its own list of gems.	* a localhost vhost listening on 127.0.0.1:9413 and bound to the labs	  directory mnt/localhost-browsertests which has plenty of space.		note that labs provides a jenkins-deploy user"	" so we do not have to set	up that user like we are doing in role::ci::slave.		bug: 54385	change-id: i35f3a9b738fc8f1c594674e63d21e545eca77000	|"																																																																																																																																																																																																																																																																																																																																																													
"contint: fix resource conflict with service::deploy::common		fix fighting over ownership of /srv/deployment between	contint::deployment_dir and service::deploy::common classes by having	the former include the latter. this doesn't fix another potential	conflict with role::deployment::server.		bug: t143065	change-id: ied664c1afbf9d559646c1817c796ecacf0a30c09	|"																																																																																																																																																																																																																																																																																																																																																																			
"contint: remove firewall rule for ytterbium		ytterbium has now been shut down"	" so this is definitely not needed	any longer.		bug: t125018	change-id: i35367b095d3b150a18c3f54f9799b2bac75cdcd9	|contint/gerrit: allow ssh for git on new gerrit server		bug: t125018	bug: t131903	change-id: iff246acef76fd136010e964caa1788b41c93c4f6	|contint: add firewall rule for nodepool to jenkins api		allow the nodepool host (currently labnodepool1001) talk	to port 443/tcp on contint hosts (gallium/contint1001).		per the flow table on the ticket. this is just like the existing	rule above it with the same source but port 8888.		bug:t137323	change-id: i562d75efd65eacbe1462b1d4cf4314b2b8dc0af4	|fix ferm port 80 for californium/gallium		bug: t137106	change-id: ib09c9ae18d255f3b09714c58c5d6880c891b4fe8	|contint:firewall: let phabricator talk to gearman		let phabricator on iridium connect to gearman on gallium	as requested.		bug:t131375	change-id: i6394329a84ae9d6320fd6f30a4c869d72984e49c	|"																																																																																																																																																																																																																																																																																																																																																																		
"contint: allow ssh from contint1001 to labs instance		some labs instances might have ferm enabled. we need the jenkins master	to be able to ssh to them.  add contint1001 in addition to gallium.		bug: t137323	change-id: i067e84ce7d21e58a0a6d1654f0637cda1ca42e5b	|"																																																																																																																																																																																																																																																																																																																																																																			
"contint: disable hhvm background service		ci does not need a hhvm service running in the background. disable the	service entirely on boot and later.		bug: t126594	depends-on: i4bc1ab34093b017329e6c2fe95ae6a4625674e5d	change-id: i2e83287898b7f994d9cfcf10ed8602820d92839b	|contint: use slave-scripts/bin/php wrapper script		set up /usr/bin/php as a wrapper shell script that chooses the proper	php version to use based on the $php_bin environment variable that is	set by zuul.		since this is a non-standard alternative"	" we need to use	`update-alternatives install`.		bug: t126211	change-id: i9758c8577164d4e528a028ab402020c4c592d1be	|contint: provision hhvm on ci slaves		we need some hhvm configuration on the ci trusty slaves so we can run	phpunit tests (t75521).		create a new class contint::hhvm which invokes ::hhvm with settings	appropriate for ci.		do not use a local repo and only rely on central one. its path is made	empty to have hhvm fallback to hhvm_repo_central_path env variable. it	is set in jenkins global configuration to vary per build using	$workspace.		bug: t75356	change-id: i924a42d2001edafa5ab00623b342afd87cfa5334	|"																																																																																																																																																																																																																																																																																																																																																																		
"contint: rename 'qunit' localvhost to 'worker'		* remove the unused 'mediawiki' localvhost on port 9414.	* remove the unused 'browsertests' localvhost on port 9413.	* rename the 'qunit' localvhost (port 9412) to 'worker'.	* use /srv/localhost-name instead of /srv/localhost/name to	  avoid an ownership conflict over '/srv/localhost' when multiple	  localhost vhosts exist.		this generic vhost will be the shared document root for a	jenkins slave (or nodepool worker). individual executors of the	worker (e.g. 4 slots) currently mount symlinks here to the	build directories. this will continue to work.		using a generic name to avoid 'qunit' or 'mediawiki' so that it	is appropiate for use by both mediawiki/qunit jobs"	 browser tests	"	and future jobs that mount arbitrary static files	(e.g. standalone frontend libraries).		avoiding 'jenkins' for the name because it's not unthinkable to	have a server for the jenkins slave to communicate with the jenkins	master. and this is kind of a global namespace. and also"	" we won't	be using jenkins for ever"	" either.		bug: t103766	change-id: icec7de01c76400a9bd65990efe999ef04061774d	|contint: switch localvhost to apache::conf		/etc/apache2/conf.d/ no more exists on trusty.  luckily apache::conf is	a thin wrapper that let us move the definition under conf-available and	conf-enabled.		should fix an error on integration-slave1006-trusty.eqiad.wmflabs	because /etc/apache2/conf.d/ does not exist.		bug: 68256	change-id: i76eaf3661dc7e34d9737892172f76a1e592c34e0	|contint::localvhost easily setup an apache listener		this generalized the qunit vhost listening on localhost.  to run browser	tests"	" i would need as well a vhost listening on localhost and pointing	to some document root.		i simply converted the existing apache conf for qunit to be a template"	"	the class contint::localvhost let us fill the placeholders.		the qunit vhost has been migrated to use the new class.		apache 'listen' statements are under /etc/apache2/conf.d/		bug: 54385	change-id: i3e17c2ab82fbbab5be654f48ca55cca98070ba40	|"																																																																																																																																																																																																																																																																																																																																																													
"package builder: ensure libdistro-info-perl is installed		move the requirement of libdistro-info-perl from the	contint::package_builder to ::package::builder.	the former call the latter so it should ensure backward compatibility.		bug: t142097	change-id: ied35bbf12ec89fc520d999678e54f95c3e6c0760	|contint: jenkins-debian-glue 0.17.0		that version now only has two binary packages. drop the others from our	puppet manifest.		change from 'latest' to 'present'. we have unattended upgrade now and	regardless there are only two slaves doing package building.		bug: t141114	change-id: i314b6b3b076e407d622abf61df77d76be5ffb99b	|"																																																																																																																																																																																																																																																																																																																																																																			
"contint: php5-ldap on all slaves		required by openstackmanager/ldapauthentication plugins"	" else the tests	fails because ldap_list is missing (t124613).		bug: t125158	change-id: i463506823e33ef622b2b22a902db43c9128ea849	|contint: install npm/grunt-cli with npm		we require very specific versions of npm and grunt-cli on the ci slaves	which are not matched by precise/trusty/jessie debian packages.		puppetize the installation described:	https://wikitech.wikimedia.org/wiki/nova_resource:integration/setup		basically get npm from the distribution and use it to install pinned	versions of npm/grunt-cli.	nodejs-legacy has to happen before the pinning.	override the /usr/bin/npm link to point to the newly installed version.		bug: t113903	change-id: i0d58b643ac677cba4b8000fbdaa936ee378263df	|contint: remove pylint/pyflakes packages		we now use tox/pypi and run flake8.		pep8 is still needed by the job operations-puppet-pep8 though.		bug: t114360	change-id: i833a7b57722f49dfc7a9c69fc23d1a3d04365bb2	|move ruby related packages to a separate file		contint::packages::ruby will let us install old ruby related things in	the nodepool disk images.		bug: t110865	change-id: i5d6741a5c83293908a2d5eed01c74bd6400e2d2a	|contint: move some useful packags to a new base class		extract basic utilities needed for all jenkins slaves into a separate	manifest contint::packages::base.		for now only colordiff and curl.	include it from role::ci::slave::labs::common which is applied on all	slaves.		for nodepool instances"	" we will include contint::packages::base when	building the image ( https://gerrit.wikimedia.org/r/#/c/239047/ ).		bug: t112821	change-id: i3834dd4fb43245e34d71739b680f7b5b235265a6	|contint: for jessie s/ruby1.9.3/ruby2.1/		ruby1.9.3 is on ubuntu precise and trusty.	debian jessie has ruby2.1		same for the -dev package.		bug: t103600	change-id: ifa94a2038d47d2976374f7b0790fa6374c742677	|contint: drop jsduck from debian slaves		we had ruby-jsduck as a debian package which was used when we had	production slaves.  nowadays we run everything on labs slaves and can't	install jsduck straight from rubygems.org		stop installing ruby-jsduck on debian slaves. we still keep it for	ubuntu though since jenkins jobs have not been migrated yet.		bug: t95008	change-id: if5a111447024b208e24d3363aa4f61deb2091e2c	|contint: rename 'qunit' localvhost to 'worker'		* remove the unused 'mediawiki' localvhost on port 9414.	* remove the unused 'browsertests' localvhost on port 9413.	* rename the 'qunit' localvhost (port 9412) to 'worker'.	* use /srv/localhost-name instead of /srv/localhost/name to	  avoid an ownership conflict over '/srv/localhost' when multiple	  localhost vhosts exist.		this generic vhost will be the shared document root for a	jenkins slave (or nodepool worker). individual executors of the	worker (e.g. 4 slots) currently mount symlinks here to the	build directories. this will continue to work.		using a generic name to avoid 'qunit' or 'mediawiki' so that it	is appropiate for use by both mediawiki/qunit jobs"	 browser tests	"	and future jobs that mount arbitrary static files	(e.g. standalone frontend libraries).		avoiding 'jenkins' for the name because it's not unthinkable to	have a server for the jenkins slave to communicate with the jenkins	master. and this is kind of a global namespace. and also"	" we won't	be using jenkins for ever"	" either.		bug: t103766	change-id: icec7de01c76400a9bd65990efe999ef04061774d	|contint: no more install openjdk-6		none of the jobs nor the jenkins agents should rely on java 6. get rid	of the package in our puppet manifest.		will clean up the ci machines manually via salt.		bug: t103491	change-id: i84b07797559d55f75d77e475a0a4dd5e02bc4074	|contint: authdns::lint is only now only for jessie labs		operations-dns-lint is the only use case and it has been migrated to	debian jessie.	stop installing gdnsd on ubuntu machines (package is going to be removed	from apt.wikimedia.org).		bug: t98737	change-id: i13ca2f88210968437780090cb7601388b0373ab6	|contint: jessie does not have openjdk-6-jdk		bug: t94999	change-id: i62dae04544e290c31b8aded33f27fc9137ef3df0	|contint: mw multimedia packages on labs slaves		for some reason we are missing the `pnmtojpeg` command on the contint	labs slaves although they are on the production slaves. i am assuming	some refactoring occured between the installation of the prod slave and	the labs slave.		including mediawiki::packages::multimedia gives us the required packaged	(ex: netbpm which provides pnmtojpeg).	we can not use mediawiki::multimedia since it set some paths to be owned	by 'apache' which is not going to work when run using the	'jenkins-deploy' user.		bug: t76661	change-id: i405c2321e0239c1f4bd6ea4cba525f6840a228df	|contint: graphviz on jenkins slaves		we are going to generate documentation using doxygen which can generate	graphs using 'dot' provided by the graphviz package.		graphviz is a pre-existing dependency for the jenkins master gallium	which is also a slave. to avoid duplicate definition"	" make use of	the new require_package().		bug: 72454	change-id: iab7b1288478f1534fd3e34f7e486656d88129ec1	|use scap's embedded linking"	" remove lint script		bug: 68255	change-id: i44d33af1ce8591772ecc1b094ca56b842b0fbc8d	|rm old wikibugs - replaced by pywikibugs		i don't see this being used anymore		wikibugs on freenode is now on labs		wikibugs [~pywikibug@wikimedia/bot/pywikibugs]	ircname  : wikibugs v2.0"	" https://tools.wmflabs.org/wikibugs/		and if this is gone then the only remaining	bot that uses ircecho is icinga-wm (role echoirc)		we once had 4 bots using ircecho and we already deleted	the gerrit (grrrit-wm) and the openstack one (formerly labs-storage-wm)		change-id: i6817cd1e1c9b04b41c6e11e7124ce93506df4246	|contint: libevent-dev on gallium		libevent-dev is required to build the poolcounter c daemon. that is the	only dependency according to its debian/control file.		bug: 46261	change-id: iabaff606898c5257efe19d6a4ab3c953ca9a174c	|"																																																																																																																																																																																																																																																																																																																																																										
"contint: android sdk deps on all slaves		the android sdk is installed automatically by the jenkins android	emulator plugin. it depends on system packages to be installed"	" which	were only made available on trusty slaves. as we are migrating the jobs	to jessie nodes:		* move android dependencies to contint::packages::androidsdk	* get it installed on both jessie and trusty (excluding precise)		bug: t138506	change-id: i402ca9e67e03d545ecca2de8db9094210c08e991	|"																																																																																																																																																																																																																																																																																																																																																																		
"contint: add php 7 packages from packages.sury.org		this uses the packages.sury.org debian repository to provide and install	packages for php 7 on jessie contint machines in labs.		bug: t144872	change-id: i14e1b61f38082c8a0ae859dbb9939682515588ca	|contint: append unattended upgrade allowed-origins		before:		unattended-upgrade::allowed-origins ""wikimedia:${distro_codename}-wikimedia"";	unattended-upgrade::allowed-origins:: ""${distro_id}:${distro_codename}-security"";		after:		unattended-upgrade::allowed-origins """";	unattended-upgrade::allowed-origins:: ""${distro_id}:${distro_codename}-security"";	unattended-upgrade::allowed-origins:: ""wikimedia:${distro_codename}-wikimedia"";		adding '::' at the end of our stanza makes unattended upgrade to	properly recognize the wikimedia origin.		bug: t98885	change-id: ie386cc044e4c5df4cbac50cbb29c9daf3b517be6	|contint: restore unattended upgrade on slaves		originally i tried to get it to run hourly"	" but that did not work. we	also had a broken hhvm package (t98876).  it has been disabled via	https://gerrit.wikimedia.org/r/#/c/210391/		it is a huge trouble to upgrade the package on all the slaves.		restore unattended upgrade on jenkins slaves with the default daily run.		contint::packages::apt is applied on labs slave via	contint::packages::labs.		bug: t98885	change-id: i0b30b75a8c22ddc32b9a43938a491ae639e0d562	|"																																																																																																																																																																																																																																																																																																																																																																		
"contint: move some useful packags to a new base class		extract basic utilities needed for all jenkins slaves into a separate	manifest contint::packages::base.		for now only colordiff and curl.	include it from role::ci::slave::labs::common which is applied on all	slaves.		for nodepool instances"	" we will include contint::packages::base when	building the image ( https://gerrit.wikimedia.org/r/#/c/239047/ ).		bug: t112821	change-id: i3834dd4fb43245e34d71739b680f7b5b235265a6	|"																																																																																																																																																																																																																																																																																																																																																																		
"contint: java 8 on jessie slaves		some android related utilities are now requiring java 8. it is available	in jessie via jessie-backports (8u91-b14-1~bpo8+1).  the trusty version	is most probably stall/unmaintained (8u40~b09-1+wm1).		install java 8 solely on jessie slaves.		bug: t138506	change-id: ifa9a0c8e3bc3b7e4cd45e6268f502f15ff06afe4	|"																																																																																																																																																																																																																																																																																																																																																																			
"contint: upgrade npm to v2.15.2		this week node.js updated the old v0.10 lts release line for the	first time in a while to address various issues with npm.	node 0.10.41 shipped npm v1.4.29. node 0.10.44 ships npm v2.15.1.		* upgrades to npm v2 because npm v1 is deprecated.	* npm released v2.15 to fix a security issue.		release notes:	* https://github.com/npm/npm/releases/tag/v2.14.13	  license fixes.		* https://github.com/npm/npm/releases/tag/v2.14.14	  remove interal non-security use of md5.		* https://github.com/npm/npm/releases/tag/v2.14.15	  bug fixes.		* https://github.com/npm/npm/releases/tag/v2.14.16	  more bug fixes.		* https://github.com/npm/npm/releases/tag/v2.14.17	  better error reporting.		* https://github.com/npm/npm/releases/tag/v2.14.18	* https://github.com/npm/npm/releases/tag/v2.14.19	* https://github.com/npm/npm/releases/tag/v2.14.20	  bug fixes.		* https://github.com/npm/npm/releases/tag/v2.14.21	  bug fixes.		* https://github.com/npm/npm/releases/tag/v2.14.22	* https://github.com/npm/npm/releases/tag/v2.15.0		* https://github.com/npm/npm/releases/tag/v2.15.1	  fixes a security vulnerability.		* https://github.com/npm/npm/releases/tag/v2.15.2		change-id: ic299bbdf24ed8c11ea7e820c6fa162c70df5f20f	|contint: install npm/grunt-cli with npm		we require very specific versions of npm and grunt-cli on the ci slaves	which are not matched by precise/trusty/jessie debian packages.		puppetize the installation described:	https://wikitech.wikimedia.org/wiki/nova_resource:integration/setup		basically get npm from the distribution and use it to install pinned	versions of npm/grunt-cli.	nodejs-legacy has to happen before the pinning.	override the /usr/bin/npm link to point to the newly installed version.		bug: t113903	change-id: i0d58b643ac677cba4b8000fbdaa936ee378263df	|"																																																																																																																																																																																																																																																																																																																																																																			
"contint: android sdk deps on all slaves		the android sdk is installed automatically by the jenkins android	emulator plugin. it depends on system packages to be installed"	" which	were only made available on trusty slaves. as we are migrating the jobs	to jessie nodes:		* move android dependencies to contint::packages::androidsdk	* get it installed on both jessie and trusty (excluding precise)		bug: t138506	change-id: i402ca9e67e03d545ecca2de8db9094210c08e991	|contint: install npm/grunt-cli with npm		we require very specific versions of npm and grunt-cli on the ci slaves	which are not matched by precise/trusty/jessie debian packages.		puppetize the installation described:	https://wikitech.wikimedia.org/wiki/nova_resource:integration/setup		basically get npm from the distribution and use it to install pinned	versions of npm/grunt-cli.	nodejs-legacy has to happen before the pinning.	override the /usr/bin/npm link to point to the newly installed version.		bug: t113903	change-id: i0d58b643ac677cba4b8000fbdaa936ee378263df	|move ruby related packages to a separate file		contint::packages::ruby will let us install old ruby related things in	the nodepool disk images.		bug: t110865	change-id: i5d6741a5c83293908a2d5eed01c74bd6400e2d2a	|contint: bring back libav-tools on slaves		the mwext-mw-selenium job has the ability to record testing session and	uses avconv provided by libav-tools.		https://gerrit.wikimedia.org/r/#/c/234699/ dropped libav-tools in favor	of ffmpeg. as a result newly provisionned jenkins slaves no more comes	with avconv which fails the builds.		make sure libav-tools is provisionned on ci slaves.		bug: t113520	change-id: ifb024c5bab3e67f9df06e259e0b6efb829a94a9e	|contint: drop require to a user in ldap		the puppet requirement upon a user in ldap does not work:		 require => user['jenkins-deploy']		drop the requirement"	" the actual command will just fail if the user can	not be found via ldap.		bug: t62720	change-id: ie29a4572eccdc025def46a5b38e22480ca49cd4e	|contint: fully qualify unix command		54b111324 added some exec commands that missed the full paths causing	puppet error:		failed to apply catalog: parameter unless failed on exec[jenkins-deploy	kvm membership]: 'grep -q 'kvm\s*jenkins-deploy' /etc/group' is not	qualified and no path was specified. please qualify the command or	specify a path. at	/etc/puppet/modules/contint/manifests/packages/labs.pp:158		fully qualify the commands:		    grep    -> /bin/grep	    usermod -> /usr/sbin/usermod		bug: t62720	change-id: i79ab5fc5ca0075ef9f388954c325631d1acd6951	|add android emulation prerequisites		- install emulation package dependency"	" qemu.	- add jenkins runner to kvm group.		change-id: ib21e15df25e733ba2053b5d91f133ffb36fa9096	bug: t62720	|contint: pil 1.1.7 expects libs in /usr/lib		uploadwizard-api* jobs require pil which expect libs to be straight in	/usr/lib when they are in /usr/lib/x86_64-linux-gnu.		add symlinks for libjpeg.so and libz.so.		bug: t101550	change-id: ic22675920121c91d111c0b04636b940bd0e82367	|contint: install python3-tk		pywikibot/core has documentation runs via tox / python3 on trusty	instances.  that requires the python3-tk package installed on our	slaves.		since the package is available on precise"	 trusty and jessie	" install it	everywhere.		bug: t101697	change-id: i9a561239f01fa0ae1b6856ed81633d1fc845534a	|contint: add 'libffi-dev' package		it is a dependency to installing the requests[security] package from pypi.		bug: t103775	change-id: i99b011ddededb2972d34ffa7aecaaf50e9d62e16	|contint: authdns::lint is only now only for jessie labs		operations-dns-lint is the only use case and it has been migrated to	debian jessie.	stop installing gdnsd on ubuntu machines (package is going to be removed	from apt.wikimedia.org).		bug: t98737	change-id: i13ca2f88210968437780090cb7601388b0373ab6	|contint: packages for android sdk		add packages for android sdk. only on trusty since precise is missing	lib32stdc+66.		bug: t88494	change-id: i3b425039ae6880ecd740fb25da40d92fc1abf433	|change bz references to phabricator tickets		except in the mediawiki module		bug: t96431	change-id: i6b36e500635537e28520bf5bd61585ff00a41755	|contint: +libxml2-dev +libxslt1-dev		the dev packages are needed to compile the lxml python module used by	wikimedia/bots/jouncebot.git		bug: t95894	change-id: i1d9540507e21d865613154e6ef04c3c5e97acccf	|contint: hhvm-dev on trusty slaves		we have jobs building php extensions with the hhvm command hphpize. it	is provided by the `hhvm-dev` package which used to be installed via	puppet or packages dependencies but is no more (integration-slave1005	missed it).		add hhvm-dev package to trusty ci slaves.		bug: t89649	change-id: ib851869301c681f3d3d855bf3c9a9dcd1d3517b1	|hhvm: create module + list all dev dependencies		ori requested jenkins to build extensions with hhvm. to do so we need a	bunch of packages dependencies he listed up on bug 63120.		this patch introduces a hhvm module and a single class	hhvm::packages::dev which instruct apt-get to install the build	dependencies for the hhvm package.  that is nicer than attempting to	manually maintain a list of package dependencies.		include it on labs jenkins slaves running trusty.		we might be missing some packages"	" in such a case they probably need to	be added to the hhvm package build-dependency field.		bug: 63120	change-id: i7c271d65a0856c0d21057618e6eb59ad1bdf421e	|contint: labs slaves +mediawiki::packages::fonts		qa has jenkins jobs taking screenshots on a wide range of wikis"	" install	additional fonts on the ci slaves to avoid square boxes in screenshots.		bug: 69535	change-id: i23be62fc8e1f8f32525be0f5a8664b0c862127aa	|contint: on slave labs"	" install tox from pip		puppet supports fetching packages from the python pip repository. the	version of tox in ubuntu precise is way too old and backporting the	packages requires to bring a lot of python dependencies.		the contint::packages::labs is harnessed to prevent its usage on	production servers.  ensure => present to prevent puppet from spamming	pip as well as unwanted upgrades.		bug: 44443	change-id: i714424de4e6c615a7189681efe404d1476a3c3a2	|"																																																																																																																																																																																																																																																																																																																																																											
"contint: add php 7 packages from packages.sury.org		this uses the packages.sury.org debian repository to provide and install	packages for php 7 on jessie contint machines in labs.		bug: t144872	change-id: i14e1b61f38082c8a0ae859dbb9939682515588ca	|contint: drop libcurl4-gnutls-dev		it conflicts with hhvm build dependency libcurl4-openssl-dev.  we have	added the gnutls flavor to build pycurl which nowadays build just fine	with openssl.		the conflict caused the libraries to be uninstalled/installed over and	over again.		ensure libcurl4-gnutls-dev is absent from the contint::packages::php	class which install the hhvm build dependencies.		bug: t134378	change-id: i1e1bcc36bc9e369a4d5861916ea0851c0d9b4eda	|"																																																																																																																																																																																																																																																																																																																																																																			
"include librdkafka-dev in contint::packages::python		this will allow testing using confluent-kafka"	" python bindings for librdkafka		bug: t133779	change-id: i65f691c563ee6da2c074ba3defb82df20ad71b1d|contint: drop libcurl4-gnutls-dev		it conflicts with hhvm build dependency libcurl4-openssl-dev.  we have	added the gnutls flavor to build pycurl which nowadays build just fine	with openssl.		the conflict caused the libraries to be uninstalled/installed over and	over again.		ensure libcurl4-gnutls-dev is absent from the contint::packages::php	class which install the hhvm build dependencies.		bug: t134378	change-id: i1e1bcc36bc9e369a4d5861916ea0851c0d9b4eda	|contint: pypy package for pywikibot		pywikibot developers would like to properly support the pypy python	interpreter. have it installed on the ci slaves.		jessie provides pypy 2.4.0.		bug: t134235	change-id: i891b13c512765ffaa2c62c5c89b6638c412e0c87	|contint: get libgnutls28-dev on jessie		c0c126b2 installed libcurl4-gnutls-dev. on ubuntu it depends on	libgnutls-dev but on debian jessie it is only a suggestion.		explicitly install libgnutls28-dev on jessie.		bug: t117955	change-id: i439b96fa7589f00e16b2356d1e2bbbf41e7bf619	|add libcurl-dev to python jenkins		needed by jenkins for i253a96525d988f835ec2b1df432fd225a6883420		bug: t111005	change-id: i9c513cc9683d8232a3e9cedf359ef620f57686bd	|contint: upgrade setuptools from pypi		on precise"	" setuptools is quite old and does not support dist-info	format.  install it via pypi.		bug: t110506	change-id: i1f8f841db48751c9220f362a8e5a9bce774a9019	|"																																																																																																																																																																																																																																																																																																																																																																	
"contint: fix bundler package name on jessie		the package has different name on ubuntu and jessie:		    ruby-bundler -> bundler		bug: t110865	change-id: i88431a509c8cbbb5297e036d5749773c9d410c04	|move ruby related packages to a separate file		contint::packages::ruby will let us install old ruby related things in	the nodepool disk images.		bug: t110865	change-id: i5d6741a5c83293908a2d5eed01c74bd6400e2d2a	|"																																																																																																																																																																																																																																																																																																																																																																			
"contint: prefer our bin/php alternative		the php7.0 package from packages.sury.org has an alternative priority of	70 which takes precedence over our alternative script:		  $ update-alternatives --display php	  php - manual mode	    link currently points to	  /srv/deployment/integration/slave-scripts/bin/php	  /srv/deployment/integration/slave-scripts/bin/php - priority 60	  /usr/bin/php5 - priority 50	    slave php.1.gz: /usr/share/man/man1/php5.1.gz	  /usr/bin/php7.0 - priority 70	    slave php.1.gz: /usr/share/man/man1/php7.0.1.gz	  current 'best' version is '/usr/bin/php7.0'.		raise our script priority to 100.		bug: t144872	change-id: i5ae1009144bf73dfa71fdaf9e0cff92a4c413c95	|contint: use slave-scripts/bin/php wrapper script		set up /usr/bin/php as a wrapper shell script that chooses the proper	php version to use based on the $php_bin environment variable that is	set by zuul.		since this is a non-standard alternative"	" we need to use	`update-alternatives install`.		bug: t126211	change-id: i9758c8577164d4e528a028ab402020c4c592d1be	|"																																																																																																																																																																																																																																																																																																																																																																		
"contint: stop using webserver::php5		bug: t118786	change-id: i58acf848d55f785cc9c23fd7366c905ff92d2589	|"																																																																																																																																																																																																																																																																																																																																																																			
"contint: stop cloning mediawiki/tools/codesniffer.git		all phpcs jobs have been migrated to use composer instead of relying on	our coding style to be available on local instances.		the `wmf-branch` has been deleted from the gerrit repository.		bug: t66371	change-id: i714516b433097bcbd5d2c9e4eba7d01f4f1d3da2	|"																																																																																																																																																																																																																																																																																																																																																																			
"change bz references to phabricator tickets		except in the mediawiki module		bug: t96431	change-id: i6b36e500635537e28520bf5bd61585ff00a41755	|contint: setup localhost.qunit vhost on lanthanum		simply move the definitions from contint::website (which is only on	gallium) to a new contint::qunit_localhost class applied on all	production slaves (role::ci::slave).		bug: 68529	change-id: i36c02cef4e13b3ee20b2be6f96df0c3ce21790e0	|send vary header on http to http redirect		the doc.wikimedia.org and integration.wikimedia.org hosts are pointing	on the misc-varnish. https connections are terminated there and	forwarded to gallium apache on port 80.		the apache should redirect any request originally made with http to its	https version (that is the case when x-forwarded-proto is not https).		the http and https url thus need to vary in varnish cache.  we achieve	that by always adding a header vary: x-forwarded-proto.  that would	solve redirects loops and should ensure everyone is sent to https.		bug: 60822	change-id: i83cef4b4d1c956ede13b9e124a046015962d7458	|contint::localvhost easily setup an apache listener		this generalized the qunit vhost listening on localhost.  to run browser	tests"	" i would need as well a vhost listening on localhost and pointing	to some document root.		i simply converted the existing apache conf for qunit to be a template"	"	the class contint::localvhost let us fill the placeholders.		the qunit vhost has been migrated to use the new class.		apache 'listen' statements are under /etc/apache2/conf.d/		bug: 54385	change-id: i3e17c2ab82fbbab5be654f48ca55cca98070ba40	|contint: publish zuul git repositories		when running jobs on slaves"	" we need the zuul reference it crafts.  this	can be done by publishing them with git-http-backend bound to the url	http://integration.wikimedia.org/zuul/git/		this is limited to the internal network for now"	" localhost and gallium	public ip address (the server has a jenkins slave). also it is done over	http instead of https to save up a bit of ssl processing.		bug: 50695	change-id: i0248003dc3564d4d2fce63f962517a0220b36300	|contint: python dependency for publish-console.py		publish-console.py is a basic script which is run by the jenkins slave	present on the ci website.  given some arguments"	" it will fetch the	console from the jenkins master setup locally and write down the console	as a flat file to make it available under /logs/.		the script web requests are handled with python-requests.		bug: 51447	change-id: ifd802b47415bd78c8aaad619aa3e390653b5197e	|contint: file perms for qunit jobs		the qunit scripts will run as user jenkins-slave when tied to the	jenkins slaves. that needs us to tweak permissions of	/srv/localhost/qunit.		bug: 50231	change-id: i906908535b13b9cebe3efc11f26915cf17a3b8e9	|contint: move integration site to wikimedia.org		* update main apache conf:	  - integration.wikimedia.org as servername instead of serveralias	  - ssl certificate for star.wikimedia instead of star.mediawiki	* set up redirect from (http"	"https)://integration.mediawiki.org	* set up redirect from http://integration.wikimedia.org		bug: 40697	change-id: i531ea5bcfe31b96e3eafd47fee5080f8aaf86121	|"																																																																																																																																																																																																																																																																																																																																																													
"contint: let us vary localhost vhost unix user		the contint::worker_localhost create an apache document root that needs	to be writable by the user that runs the jenkins jobs. on permanent	slaves that is 'jenkins-deploy' for legacy reasons"	" on nodepool it is	'jenkins'.		make contint::worker_localhost to require a $owner parameter that is	solely used to set the owner of /srv/localhost-worker		adjust the only existing call in this repo which is used by permanent	slaves and thus must use jenkins-deploy.		bug: t136301	change-id: i8f62962c515019bb87fa92937c8c5435e6d53359	|contint: rename 'qunit' localvhost to 'worker'		* remove the unused 'mediawiki' localvhost on port 9414.	* remove the unused 'browsertests' localvhost on port 9413.	* rename the 'qunit' localvhost (port 9412) to 'worker'.	* use /srv/localhost-name instead of /srv/localhost/name to	  avoid an ownership conflict over '/srv/localhost' when multiple	  localhost vhosts exist.		this generic vhost will be the shared document root for a	jenkins slave (or nodepool worker). individual executors of the	worker (e.g. 4 slots) currently mount symlinks here to the	build directories. this will continue to work.		using a generic name to avoid 'qunit' or 'mediawiki' so that it	is appropiate for use by both mediawiki/qunit jobs"	 browser tests	"	and future jobs that mount arbitrary static files	(e.g. standalone frontend libraries).		avoiding 'jenkins' for the name because it's not unthinkable to	have a server for the jenkins slave to communicate with the jenkins	master. and this is kind of a global namespace. and also"	" we won't	be using jenkins for ever"	" either.		bug: t103766	change-id: icec7de01c76400a9bd65990efe999ef04061774d	|"																																																																																																																																																																																																																																																																																																																																																														
"cxserver: scap3 migration		bug: t120104	change-id: i612a2cb9144905993f93206ecb67f8ebaf6e6177	|read config from cxserver		bug: t122498	change-id: i24016fc3a08d1fee448b209d633dcd8a446693c7	|cxserver: use dc-aware urls		we set restbase to point to $::rb_site and apertium to $::site.		bug: t125065	change-id: ie12de964ae85747f4281fc6250660df70e343e4e	|cxserver: set up automatic monitoring		cxserver's swagger spec already contains the monitoring examples to be	used by the automatic monitoring script. this commit only activates it.		bug: t121776	change-id: i2fe8e18fed4c27008465930f44932fba7eb0ce10	|service-runner migration for cxserver		bug: t117657	depends: ia5e0950b314f54e10e50230af9a3761be6a8ee0a	change-id: i72f84ec489686cd38f22dbfc150ec12f1d8dcf87	|cxserver: add jwt token support		bug: t116134	change-id: i338070364e5b723274c9627bfae42a1975011a9a	|cx: log to logstash		depends on: if4cea7fe90d72dedd6420fb0a6d8721b4b7598c3		bug: t89265	bug: t101240	bug: t101378	change-id: i7b9de5b0143a2420b8c2caf4f33d25f978c3fb4f	|cxserver: add yandex support		* added yandex proxy support.	* yandex support conditional based on value of yandex_url	* proxy support conditional	* english - russian mt with yandex provider	* do not enable in production"	" but rather only on beta		bug: t88512	change-id: i6e76d289fd85adcb396361b07a8dd4d2c1b6eb5b	|cxserver: use different registry for beta and production		we need ""stable"" environment for user testing of new language pairs"	" which is	beta cluster. configuration need to be different for it from production for	language pairs registry (languages"	" mt and dictionary providers).		registry format will be quite simple in future"	" and also diff between beta	cluster and production will be kept minimum as possible.		bug: t88793	change-id: i98b13b3f484271ae613324960b87e8188b4ec69c	|cxserver: unify production and beta roles		bug: t86633	change-id: i74ee57e9e10aac2f7df7c3c09052afbaf901e4d0	|"																																																																																																																																																																																																																																																																																																																																																															
"service-runner migration for cxserver		bug: t117657	depends: ia5e0950b314f54e10e50230af9a3761be6a8ee0a	change-id: i72f84ec489686cd38f22dbfc150ec12f1d8dcf87	|"																																																																																																																																																																																																																																																																																																																																																																			
make dumps.wikimedia.org access logs readable on stat1002 dest	" also only rsync *.gz files		bug: t134776	change-id: i322120538cce77f8b512e403cf6d251b6a283be5	|send web server logs from dataset hosts to stat1002		add rsync class for nginx logs"	" add to dataset primary role		bug: t118739		change-id: i18a31bc95c4ac656ea9dcdb3a603344d14036d03	|"																																																																																																																																																																																																																																																																																																																																																																	
"pull down wikitech dumps and serve them in 'other' datasets		bug: t128680	change-id: if98e9c17220915627d67eb7e761e3e82693cb395	|"																																																																																																																																																																																																																																																																																																																																																																			
"add cron job for content translation dumps		bug: t127793	change-id: i77ee28e9e08e365d2044a54eadfcc9d7f30a26d3	|make link in dataset relative		this will fix t112892		bug: t112892	change-id: ife4dcdb80f9a6ac268409589c888604d44120c56	|add new wikidata folders"	" define dataset folders in puppet		initial step for moving the wikibase dumps to the new location	per t72385.		i hope i got the permissions/ owners/ groups right for the	directories that already exist.		bug: t72385	change-id: idc6efba9143734511dc414c34b655f0cd6a83073	|"																																																																																																																																																																																																																																																																																																																																																																		
"remove pagecounts-[raw|all-sites] related code		the new pageviews dataset is available"	" therefore pagecounts-raw	and pagecounts-all-sites are deprecated. data already synced on dumps	server is kept"	 as well as already generated html files	" but code	to rsync new data and re-generate html files is deleted.		bug: t130656	change-id: i7a8da8e1248511c379259bd03474109323c9a7a7	|rsync of phab dumps from iridium to dataset1001		bug: t103028	change-id: i626acd383cef5515c963468491a0fecdaea7dc49	|"																																																																																																																																																																																																																																																																																																																																																																
"add ferm rules for dataset nfs server		bug: t104991	change-id: i4da66cf7f10756f1bef1bef468f0ef3090c9cb31	|use fixed ports for dataset nfs server		bug: t105040		this is a precondition to define ferm rules for the dataset systems		change-id: i6d6a9483e9c5da5205d8ba3c45d64b70ce0cf624	|"																																																																																																																																																																																																																																																																																																																																																																			
"dataset: remove needless quotes around a 'true'		a regular old boolean will suit us fine"	" and the check	in the template as written is broken for a quoted	boolean anyway.		bug: t113783	change-id: i768686f22dd512feafbac0b4de8d18e8064d004a	|rsync:  unquote booleans		bug: t113783	change-id: i80362002e2f665daac829bfef959714f09c5c3e8	|"																																																																																																																																																																																																																																																																																																																																																																		
"remove pagecounts-[raw|all-sites] related code		the new pageviews dataset is available"	" therefore pagecounts-raw	and pagecounts-all-sites are deprecated. data already synced on dumps	server is kept"	 as well as already generated html files	" but code	to rsync new data and re-generate html files is deleted.		bug: t130656	change-id: i7a8da8e1248511c379259bd03474109323c9a7a7	|"																																																																																																																																																																																																																																																																																																																																																																
"rsync of phab dumps from iridium to dataset1001		bug: t103028	change-id: i626acd383cef5515c963468491a0fecdaea7dc49	|"																																																																																																																																																																																																																																																																																																																																																																			
"remove trebuchet user from wikidev group		since user is subsequently removed from the wikidev group by	admin::groupmembers.		bug: t115760	change-id: ia76c63dda9452569002330ce526d39bba7635d55	|deployment group for trebuchet		bug: t97775	change-id: i4486fd5e69a4cbca1a02817f59a12546ad6c9e4b	|create /srv/patches directory on tin		bug: t95375		change-id: iefd889b3e9f9bfc9f5db2e8ca09ba101c486a386	|exec saltutil.sync_all when adding deployment_server grain		follow the pattern of the deployment::target class and ensure that	saltutil.sync_all has been called after setting the deployment_server	grain.		bug: 64348	change-id: i9696d45120d06120795f97d0a9183d116680b0a0	|"																																																																																																																																																																																																																																																																																																																																																																			
"deployment: activate redis replica between the masters		any master that is not the current deployment server will replicate its	data"	" as trebuchet is configured to speak only with the current master.		bug: t124024	change-id: ibe245b5fe0ebf927d55f4843e7dfcd71f1b44b64	|"																																																																																																																																																																																																																																																																																																																																																																		
"deployment: fix optional parameter listed before required parameter		bug: t93645	change-id: i354e638296e67c4c0b7a7225844e639a287b34cd	|mwprof: deprecation		mwprof support has been deprecated in mediawiki and no longer running on any	machine"	" thus remove it		bug: t97509	change-id: i7b74d8bf9ce46a4d4e4e6676bfeebcda47294e9f	|(bug 43339) deployment roles for beta		i have abstracted the common to beta and production configuration to	avoid code duplication. this should let us use deploy on the	deployment-bastion instance which is the working machine for the 'beta'	cluster.		change-id: ia7bb843e48a81206f5dded9bd77f23571b0e4231	|"																																																																																																																																																																																																																																																																																																																																																																		
"add diamond collector_module class		this decouples the installation of custom collectors from their	usage via the diamond::collector class.		bug: t83580	change-id: i7b64baa7659f0bbe97309fbf461eded40a6e63df	|"																																																																																																																																																																																																																																																																																																																																																																			
"diamond:  turn off lint check for quoted bools.		bug: t113783	change-id: i6c802c2ea9d8962bcf31f640c01c170ba76834c8	|tools: extended exim diamond collector for tool labs		 - forked and extended existing exim collector	 - extended queue information	 - added paniclog information	 - moved sudo configuration to collector manifest	 - updated tool labs mail relay for new collector		bug: t96898	change-id: i9010886ecac20c94a3916b908910853e26241318	original-change-id: i1d0517e41d61201e7f6c9b85c116f952658f73a3	|extend exim diamond collector for tool labs		 - forked and extended existing exim collector	 - extended queue information	 - added paniclog information	 - moved sudo configuration to collector manifest	 - updated tool labs mail relay for new collector		bug: t96898	change-id: i1d0517e41d61201e7f6c9b85c116f952658f73a3	|"																																																																																																																																																																																																																																																																																																																																																																			
"diamond:  turn off lint check for quoted bools.		bug: t113783	change-id: i6c802c2ea9d8962bcf31f640c01c170ba76834c8	|add local crontab monitoring		bug: t96472	change-id: i6758673ff611a86ed67af23e599e1945227e97fe	|"																																																																																																																																																																																																																																																																																																																																																																			
"diamond collector for nagios plugin return codes		bug: t111064	change-id: if09d5a34bc99733dc7fd9e13f2756f7975802d50	|"																																																																																																																																																																																																																																																																																																																																																																			
"diamond: service stats puppet integration		provide diamond::collector::servicestats to be used to collect service	statistics"	" likely we'd want to add it to base::service_unit		bug: t108027	change-id: i8dc70cd66d9934519959818c8a827862823f8de4	|"																																																																																																																																																																																																																																																																																																																																																																		
"diamond tcp collector: publish tfo-related metrics as gauges		send tfo-related metrics as gauges instead of counters to work around	what looks like a bug in diamond (t138758).		we added the 'gauges' configuration option to diamond's tcp collector in	version 3.5-6: https://gerrit.wikimedia.org/r/#/c/296380/		change-id: iabc8bec4a61c7793e0a66b6c41cf4321fcc78737	|diamond tcp collector: add tfo-related metrics		the diamond tcp collector exposes a configuration option allowing to	specify additional tcp metrics to be reported.		this commit adds the following tfo-related metrics:		- tcpfastopenactive	- tcpfastopenactivefail	- tcpfastopenpassive	- tcpfastopenpassivefail	- tcpfastopencookiereqd	- tcpfastopenlistenoverflow	- tcpsynretrans	- tcporigdatasent		see https://wikitech.wikimedia.org/wiki/tcp_fast_open for an explanation	of those.		bug: t108827	change-id: i78253380f4dee42085bcb2925b2a281e6cafae34	|diamond: allow setting handlers via hiera		this allows us to set them to null if we want to discard	values"	" and also allows easier experimentaion in the future	if necessary		bug: t137753	change-id: ibc0820648d121cb915656094262cad22a26a288a	|diamond: send statsd metrics in batches		use 'batch' argument to statsdhandler to send multiple metrics per udp packet"	"	see also https://github.com/python-diamond/diamond/pull/327 which will be	shipped in our internal diamond debian package		bug: t116033	change-id: i9730cd2ff364f638377be42aa681ce4c32ba9efe	|diamond: use upstream statsdhandler		since diamond 3.5-3 internally we have been shipping a transitional copy	of upstream diamond stats_d module as dastatsd. explicitly move to it	and away from dastatsd.		bug:t116033	change-id: i8ca4d238be189bcb355c2035f6ba7c32b33d2b67	|diamond:  turn off lint check for quoted bools.		bug: t113783	change-id: i6c802c2ea9d8962bcf31f640c01c170ba76834c8	|diamond: stop collecting disk io stats for partitions		partition statistics roughly take up ~50% of iostat space for little benefit"	"	note md/lvm are unaffected"	" only sd* and x?vd*		bug: t1075	change-id: ia7926fe30e125e74f3d147f47221741730f54860	|"																																																																																																																																																																																																																																																																																																																																																															
"labsdns: stop hardcoding instance ips in puppet		bug: t100990	change-id: i260f219cb477270f5f5b5f59d35c1f1abc7cd930	|labs: move *.labsdb aliases into dns		bug: t63897	change-id: i74fb1dc01a046b5cc2fbe7d96f1c7108379ef21a	|"																																																																																																																																																																																																																																																																																																																																																																			
labsdns: allow returning arbitrary a records	" not cnames		cnames are problematic since if the same dns server is responsible	for the returned cname zone as well clients expect it to internally	resolve and return the a record too. this is too complex for us"	"	so we just fake return an a record directly. this has ttl implications"	"	but right now these are in /etc/hosts managed by puppet so it is	not making the situation worse.		followup to i4c90b8002409f5de9bdc48bc878c27348122ce6c		bug: t139190	change-id: i3480066e89cf825ba278983c35e6a97a95c17e7b	|labs: add support for custom cnames in labs recursor		bug: t118758	change-id: i28b0dfaecd255490e5d60cdec9ff0fd67334b92f	|labsdns: stop hardcoding instance ips in puppet		bug: t100990	change-id: i260f219cb477270f5f5b5f59d35c1f1abc7cd930	|"																																																																																																																																																																																																																																																																																																																																																																
"docker: add a class that facilitates building base images		bug: t118446	change-id: ice8f3220268934d018b5297396f1c4b2327bb38a	|"																																																																																																																																																																																																																																																																																																																																																																			
"k8s: use direct-lvm for docker storage backend		bug: t141126	change-id: i44f0d8486ddca81cf3becc5f66fcc52b8279d163	|"																																																																																																																																																																																																																																																																																																																																																																			
"docker: fix optional parameter listed before required parameter		bug: t93645	change-id: iae18ce2681268be46852ed80f2787f531fc22f32	|tools: add authentication for docker registry		bug: t118758	change-id: i33bb4c1e664d208dddf79fa4739c582554fb6e32	|"																																																																																																																																																																																																																																																																																																																																																																			
drac	icinga	"ipmi: do not ensure => latest		some more remaining cases where we ensure ""latest""	with packages.		bug:t115348	change-id: id310d8128459aeb0f8feeb98e3f30a707cc00c71	|"																																																																																																																																																																																																																																																																																																																																																																	
"druid module and analytics_cluster role class		bug: t131974	change-id: i65cb169ac2701e754cd6a68e31903bcb25644290	|"																																																																																																																																																																																																																																																																																																																																																																			
"druid module and analytics_cluster role class		bug: t131974	change-id: i65cb169ac2701e754cd6a68e31903bcb25644290	|"																																																																																																																																																																																																																																																																																																																																																																			
"druid module and analytics_cluster role class		bug: t131974	change-id: i65cb169ac2701e754cd6a68e31903bcb25644290	|"																																																																																																																																																																																																																																																																																																																																																																			
"druid module and analytics_cluster role class		bug: t131974	change-id: i65cb169ac2701e754cd6a68e31903bcb25644290	|"																																																																																																																																																																																																																																																																																																																																																																			
"apply druid roles in production with initial (guesswork) configuration		bug: t131974	change-id: i76e37089896bfc6f3b8db875dc53a03b306b662f	|druid module and analytics_cluster role class		bug: t131974	change-id: i65cb169ac2701e754cd6a68e31903bcb25644290	|"																																																																																																																																																																																																																																																																																																																																																																			
"use ruby json lib to render arrays as strings in druid runtime.properties.erb		labs uses a different version of ruby"	" and this is not a problem there.		bug: t131974	change-id: i822155973464d05b9127bfdbc88d7af072520417	|druid module and analytics_cluster role class		bug: t131974	change-id: i65cb169ac2701e754cd6a68e31903bcb25644290	|"																																																																																																																																																																																																																																																																																																																																																																		
"druid puppet improvements for prod		bug: t131974	change-id: ieb5d6ff076043df56a94e770a6566634bbf09764	|apply druid roles in production with initial (guesswork) configuration		bug: t131974	change-id: i76e37089896bfc6f3b8db875dc53a03b306b662f	|druid module and analytics_cluster role class		bug: t131974	change-id: i65cb169ac2701e754cd6a68e31903bcb25644290	|"																																																																																																																																																																																																																																																																																																																																																																			
"druid module and analytics_cluster role class		bug: t131974	change-id: i65cb169ac2701e754cd6a68e31903bcb25644290	|"																																																																																																																																																																																																																																																																																																																																																																			
"druid puppet improvements for prod		bug: t131974	change-id: ieb5d6ff076043df56a94e770a6566634bbf09764	|install the druid service package for each service		bug: t131974	change-id: ia80039fd639cbac28a753ca8c55cbf98aa3ed5aa	|druid module and analytics_cluster role class		bug: t131974	change-id: i65cb169ac2701e754cd6a68e31903bcb25644290	|"																																																																																																																																																																																																																																																																																																																																																																			
"add hsts=1y to several one-off public services		this adds hsts=1y headers to the following services:		archiva.wikimedia.org	dumps.wikimedia.org	ganglia.wikimedia.org	librenms.wikimedia.org	rcstream.wikimedia.org		note this does not imply any redirects"	" or force a client which is	not https-capable to use https.  what it accomplishes is that if	an hsts-honoring user agent successfully reaches the service over	https once"	" the sts header will lock their future access from that	client onto https going forward.		bug: t132521	change-id: idb40ad1bfc5db93989713a68d1bf3eef2e8c4843	|keep fewer dataset web server logs"	" add date to filename		this is preparatory to setting up rsync of logs elsewhere	for analysis		bug: t118739	change-id: i10fc7159e46ef6fa61d1704e9c30810073e7e05c	|dumps: strengthen ssl settings		bug: t74072	change-id: i7529dd81d7084bd5dd60ab99ee155c5b88c916a7	|"																																																																																																																																																																																																																																																																																																																																																																
"dumps: let htmldumps-admin own html dumps docroot		let the newly created htmldumps-admin group own	the document root used for html/zim dumps.		bug:t94093	change-id: ia93bc112548915410e8b34f00b103479e8c6ee8f	|dumps::zim: fix template source line		a template needs to be used like:		content => template('dumps/nginx.dumps.conf.erb')"	"		with nginx::site.		bug:t94457	change-id: i101037650bb81d7109eaacfbd2ed80f3e86ef310	|dumps::zim: fix nginx setup / basic site template		add missing nginx site template for zim dumps to fix	puppet run on francium.		could not retrieve information from environment production	source(s) puppet:///modules/dumps/nginx.zim.conf		basic nginx template and fix filename to .erb.		bug:t94457	change-id: i039f147da7773e5a79488489007eea6b5499b568	|dumps::zim: libsqlite3 is actually libsqlite3-0		fix the package name"	 libsqlite3 can't be found	" it's called	libsqlite3-0 here.		bug:t94457	change-id: i0f64f294fb13095c0a9a494722b457c788b2414f	|zim dumps: install nodejs and libsqlite		install nodejs and sqlite packages as listed on:		bug:t94457	change-id: iea35ab941d1a29624f4d91a019ae2313300ecb00	|dumps: add classes for zim dumps"	" add imagemagick		from t94457 we already now that zim dumps will require imagemagick and	other things.		start with creating the role class and a new manifest that installs imagemagick.		bug:t94457	change-id: ibf58366c3e6e25f21184d9fa60b84b739bd0ce03	|"																																																																																																																																																																																																																																																																																																																																																															
"dynamicproxy: resource attributes quote		bug: t91908	change-id: ie610e23d1a1d45e86bea3246d5d1aa4c18fc5f48	|"																																																																																																																																																																																																																																																																																																																																																																			
"tools: track per tool request stats in graphite		bug: t69880	change-id: ie7f35a8946a4ff7cce93396964d2c2042d8017b6	|dynamicproxy: do not override nginx.conf		no reason to"	" and it causes issues elsewhere when you upgrade	nginx packages and they have breaking changes in their nginx.conf.		bug: t134383	change-id: i1de30ed6e8b9f6543753f3bcb582ce724548f1fb	|dynamicproxy: make blocked user agents configurable		untested		bug: t90844	change-id: ia739e81e25873095f47751a57fb7abfd889b5f89	|dynamicproxy: firewall redis more restrictively		bug: t114209	change-id: i880ef010b50815fe53c44cd7f6025f621a135591	|tools: replace references to tools.wmflabs.org		bug: t87387	change-id: i6efa8ffdcf407d98a10baeca7193af1b90e53610	|tools: setup replication from master to all slave proxies		bug: t96334	change-id: if782d1343a760c5e2f91a514eeb3bfa26bb4de35	|dynamicproxy: open firewall for proxymanager		bug: t88216	change-id: ic7bbf3bbd029a9e4fb32718622d12adcef20c1e8	|dynamicproxy: do not bind redis only on localhost		this allows specific opening up of redis to elsewhere for	replication		bug: t96335	change-id: i97a9641678563804881f06c6014d9fc72df8ad67	|dynamicproxy: add ferm rules for http / https		bug: t96335	change-id: i441bb25f91a4436c79d36771d82432d5186f262f	|dynamicproxy: provide list of active proxy entries for urlproxy		this requires 1.3.2 of lua-json at least because 1.3.1 is broken.		bug: t88216	bug: t91484	change-id: if802aa35679ef07153288c9cfb140974b4d79bf7	|dynamicproxy: resource attributes quote		bug: t91908	change-id: ie610e23d1a1d45e86bea3246d5d1aa4c18fc5f48	|"																																																																																																																																																																																																																																																																																																																																																																		
"adding missing dependency in exposing puppet ssl certs on elasticsearch		since those certs are used by nginx and published to /etc/nginx"	" the nginx	package needs to be installed before exposing the certs.		bug: t138329	change-id: if53eedef7de92b726e6e2697f9e6b8a48341b844	|moving elasticsearch::https instatiation to elasticsearch role		this will ensure that other roles requiring elasticsearch do not have any	conflicts with the dependencies that elasticsearch brings.		bug: t131906	change-id: i84bcec99bf0cb9c9515de027240bd685d7a62585	|corrected port number to check for ssl cert on elasticsearch		bug: t130366	change-id: i284510757898235b71c75d3914f1c5fe622a3ce1	|elasticsarch: add icinga check for ssl certificate		this is based on	https://gerrit.wikimedia.org/r/#/c/244610/3/manifests/role/nova.pp	which implements a similar check.		bug: t130366	change-id: i841b26396382411e660629775c99a6a9c031b011	|fixes issues with nginx package on logstash.		as part of t124444"	" nginx has been added to elasticsearch to provide ssl	termination. in the case of logstash"	 we do not need ssl	" so all this should	be deactivated.		the deactivation part was not tested enough (and was broken). this fixes it	by ensuring that nginx is completely removed when not needed.		this change is dependant on https://gerrit.wikimedia.org/r/#/c/277476/		bug: t129934	change-id: ib85e12ef8195058287bd70c9d2bad70e6f8f51c1	|puppet ssl dir is not the same on production or labs		the `puppet_ssldir` function seems to take care of this difference.		bug: t124444	change-id: ie8186fded68940ce4b164b38a241ec3939adc02e	|expose elasticsearch through http		adding nginx to do ssl termination"	" allowing clients to use either http	or https at will. puppet certificates are used here"	" exposed through	base::expose_puppet_certs. this makes this change dependant on	https://gerrit.wikimedia.org/r/#/c/274382/		ssl certificates mush match the service name used to access elasticsearch.	for this we configure base::puppet:dns_alt_names and we need to recreate	puppet ssl certs (recreation of certs is done manually).		bug: t124444	change-id: i347caf322ee17876978ae8c0d94b3e38a6102cdd	|"																																																																																																																																																																																																																																																																																																																																																													
"changed partition scheme for relforge (elasticsearch) servers		with 4x3to disks"	" we need gpt and raid10. there is a standard config for	this"	" but it requires moving elasticsearch data to /srv. this brings us	closer to the standard used on most servers (data stored in /srv)"	" but	further from other elasticsearch servers.		the long term plan is to move all data on all servers to /srv"	" so let's start	now.		bug: t137256	change-id: i440776fcfcca776cac9df5916b1d564a83cb1923	|use unicast instead of multicast for elasticsearch node communication		as an intermediate step"	" both unicast and multicast will be enabled.		testing in labs show that discovery protocols are not hot reloaded. a restart	is required to enable the changes. in this case"	" we will need:		1) activate unicast in configuration	2) restart the cluster to enable the change	3) disable multicast in configuration	4) restart the cluster to enable change		note: ferm::service for multicast discovery will need to be disabled once	multicast is unused.		bug: t110236	change-id: ibc9a352b85524d52945a28fe4da8a2bb3242a558	|moving elasticsearch::https instatiation to elasticsearch role		this will ensure that other roles requiring elasticsearch do not have any	conflicts with the dependencies that elasticsearch brings.		bug: t131906	change-id: i84bcec99bf0cb9c9515de027240bd685d7a62585	|expose elasticsearch through http		adding nginx to do ssl termination"	" allowing clients to use either http	or https at will. puppet certificates are used here"	" exposed through	base::expose_puppet_certs. this makes this change dependant on	https://gerrit.wikimedia.org/r/#/c/274382/		ssl certificates mush match the service name used to access elasticsearch.	for this we configure base::puppet:dns_alt_names and we need to recreate	puppet ssl certs (recreation of certs is done manually).		bug: t124444	change-id: i347caf322ee17876978ae8c0d94b3e38a6102cdd	|ship elasticsearch logs to logstash		introduce gelf4j as a log4j appender to send logs to logstash. sending log	to logstash is disabled by default and is activated if	$elasticsearch::graylog_hosts is not `undef`.		* deploy necessary packages (liblogstash-gelf-java"	" libjson-simple-java)	* create symlinks from jars to /usr/share/elasticsearch/lib	* add necessary configuration to /etc/elasticsearch/logging.yml	* hiera config to activate this in labs (deployment-prep)	* hiera config to activate in prod/codfw		bug: t109101	change-id: i683bcb75c91e6c2f4dd648517435a477ab23c2a7	|make elasticsearch more reliable in beta		in beta multicast isn't reliable so we have to rely on elasticsearch's	unicast discovery to seed the cluster.  this sets that up.		bug: 63571	change-id: i2fc590b7382728e9f2baca62a35601b9f0b1ad51	|"																																																																																																																																																																																																																																																																																																																																																										
elasticsearch - check shards via the service	" not via each individual node		checking cluster state on each node is redundant and generate a lot of noise.	cluster wide checks are now done on the service only.		the logstash cluster is left unchanged as it does not have lvs.		the relforge cluster is at the moment left unmonitored. this will be	fixed once a cleanup of the different elasticsearch roles is done (see	https://gerrit.wikimedia.org/r/#/c/304067/).		bug: t133844	change-id: ica721152c10d777003726e80fa03ed82c69c8a10	|"																																																																																																																																																																																																																																																																																																																																																																		
"ship elasticsearch logs to logstash		introduce gelf4j as a log4j appender to send logs to logstash. sending log	to logstash is disabled by default and is activated if	$elasticsearch::graylog_hosts is not `undef`.		* deploy necessary packages (liblogstash-gelf-java"	" libjson-simple-java)	* create symlinks from jars to /usr/share/elasticsearch/lib	* add necessary configuration to /etc/elasticsearch/logging.yml	* hiera config to activate this in labs (deployment-prep)	* hiera config to activate in prod/codfw		bug: t109101	change-id: i683bcb75c91e6c2f4dd648517435a477ab23c2a7	|allow elasticsearch java version to float again		we used to force 7u25 because the newer version of java had issues with	lucene.  these were bugs in java"	 not lucene.  anyway	" its been fixed and	available in 7u55 which is the newest version.		change-id: i662a0e1fc5e2e3047ef6c00597504a9a35fd62fa	|"																																																																																																																																																																																																																																																																																																																																																																
"ship elasticsearch logs to logstash		introduce gelf4j as a log4j appender to send logs to logstash. sending log	to logstash is disabled by default and is activated if	$elasticsearch::graylog_hosts is not `undef`.		* deploy necessary packages (liblogstash-gelf-java"	" libjson-simple-java)	* create symlinks from jars to /usr/share/elasticsearch/lib	* add necessary configuration to /etc/elasticsearch/logging.yml	* hiera config to activate this in labs (deployment-prep)	* hiera config to activate in prod/codfw		bug: t109101	change-id: i683bcb75c91e6c2f4dd648517435a477ab23c2a7	|"																																																																																																																																																																																																																																																																																																																																																																		
"endowment: remove duplicate apache site definition		""cannot redeclare"""	" should just be a single apache	site"	" happened because of some copy/pasting when	setting it up like existing annual.wm		bug:t136793	change-id: i9a493041a635b100f09826d43816defd1a3d9c6f	|add puppet code for endowment.wm.org site		add minimal puppet module and role to setup	endowment.wikimedia.org like we do for annual.wm.org.		bug:t136735	change-id: iebea9ee1c5d2d3b9b6657b5087dd447465163fe1	|"																																																																																																																																																																																																																																																																																																																																																																	
"etcd: auth puppetization		add basic resources and providers to create and manage users and roles	on etcd; also create a class to enable auth.		bug: t97972	change-id: i84e5c8ef98ccabed9edfdb8bdaf072f74c0adb3e	|"																																																																																																																																																																																																																																																																																																																																																																			
"etcd: auth puppetization		add basic resources and providers to create and manage users and roles	on etcd; also create a class to enable auth.		bug: t97972	change-id: i84e5c8ef98ccabed9edfdb8bdaf072f74c0adb3e	|"																																																																																																																																																																																																																																																																																																																																																																			
"etcd: auth puppetization		add basic resources and providers to create and manage users and roles	on etcd; also create a class to enable auth.		bug: t97972	change-id: i84e5c8ef98ccabed9edfdb8bdaf072f74c0adb3e	|"																																																																																																																																																																																																																																																																																																																																																																			
etcd: perform backups to /srv/backups/etcd	" bacula		bug: t135129	change-id: id38d91317213c764183ae901414fad6b5cc875db	|"																																																																																																																																																																																																																																																																																																																																																																		
"etcd: auth puppetization		add basic resources and providers to create and manage users and roles	on etcd; also create a class to enable auth.		bug: t97972	change-id: i84e5c8ef98ccabed9edfdb8bdaf072f74c0adb3e	|"																																																																																																																																																																																																																																																																																																																																																																			
"etcd: auth puppetization		add basic resources and providers to create and manage users and roles	on etcd; also create a class to enable auth.		bug: t97972	change-id: i84e5c8ef98ccabed9edfdb8bdaf072f74c0adb3e	|"																																																																																																																																																																																																																																																																																																																																																																			
"etcd: auth puppetization		add basic resources and providers to create and manage users and roles	on etcd; also create a class to enable auth.		bug: t97972	change-id: i84e5c8ef98ccabed9edfdb8bdaf072f74c0adb3e	|etcd: remove package etcdctl		while it was needed with our package"	" it's not needed as a separate	package when we backport etcd 2.2 from stretch.		bug: t118830	change-id: i4232258ac370283311e00b9ceba918da9942e3aa	|confd: create module		this module allows to define configuration files to be	monitored/generated via confd.		bug: t97974	change-id: icc0e87e274d2a53a3308f4411a98d16c37314f8e	|etcd: create puppet module		this also creates the puppet role so that it is directly usable in production		bug: t97973	change-id: ib80e3d3c3e46f9ff0b81c5dd675ce79184324576	|"																																																																																																																																																																																																																																																																																																																																																																		
"etcd: create puppet module		this also creates the puppet role so that it is directly usable in production		bug: t97973	change-id: ib80e3d3c3e46f9ff0b81c5dd675ce79184324576	|"																																																																																																																																																																																																																																																																																																																																																																			
"etcd: create puppet module		this also creates the puppet role so that it is directly usable in production		bug: t97973	change-id: ib80e3d3c3e46f9ff0b81c5dd675ce79184324576	|"																																																																																																																																																																																																																																																																																																																																																																			
"etcd: switch to using the system-wide puppet ca		bug: t114638	change-id: i60962e450935ddc09cd215c5e59fbabb059369cf	|puppetize etcd use for eventlogging processor		this will allow eventlogging to consistently hash client ips even	when parallelized.		requires that https://gerrit.wikimedia.org/r/#/c/238854/ is deployed.		this change also adds a provide_private parameter to etcd::ssl so that	the class can be used for etcd clients"	" not just etcd servers.		bug: t112688	change-id: i8ba49df87b4edb080d3e4786b4f884a61ef003e6	|etcd: create puppet module		this also creates the puppet role so that it is directly usable in production		bug: t97973	change-id: ib80e3d3c3e46f9ff0b81c5dd675ce79184324576	|"																																																																																																																																																																																																																																																																																																																																																																		
create new eventlogging::analytics role in modules/role	" use scap for deployment		this is only the deployment of a new cloned repo to eventlog1001"	" it does not affect	the running deployment or daemons.		bug: t118772	change-id: ib37ec5a3aba1a9e018a700d4271b4930d4dc5472	|"																																																																																																																																																																																																																																																																																																																																																																	
"add ssh:userkey for eventlogging scap::targets		needed for scap deployment since the scap::target resource for	eventlogging has `manage_user => false`		also update a comment		bug: t137192	change-id: i93573375df5339a4c880b5d32659c8428e5e1756	|keyholder key cleanup		* clean up the mess that is scap::target and keyholder::agent	* make ssh_agent_proxy look up keys by name instead of fingerprint	** this avoids needing to store fingerprints in puppet manifests	* password-protected key test is now optional and skipped on beta		bug: t132747		change-id: id298a3e0f12e31afd7ea83970e192330ffbd4243	|create new eventlogging::analytics role in modules/role"	" use scap for deployment		this is only the deployment of a new cloned repo to eventlog1001"	" it does not affect	the running deployment or daemons.		bug: t118772	change-id: ib37ec5a3aba1a9e018a700d4271b4930d4dc5472	|add new scap::source define to ease bootstrapping of repositories on deploy servers		scap::source will clone your source repo"	 and if scap_repository is set	" it will	clone that repo at /srv/deployment/$title/scap.	this allows for scap/ directories to be separated from source	repositories"	" and allows scap repos to bootstrap themselves on	deploy servers"	" instead of relying on trebuchet.		'scap::sources' is a hiera variable that contains resource declarations for scap::source	that will be dynamically by scap::server.		eventlogging/eventbus is the guinea pig here"	" so this is applied to it.  it is declared	in hieradata/role/common/deployment/server.yaml to clone from the eventlogging repository.		this shouldn't conflict with trebuchet's deployment.yaml clones"	" as the git::clone	will only execute if .git/config doesn't yet exist.		this also moves scap::server's directy hiera_hash lookups to class parameter	based lookups via hiera classpath.  see scap/server.yaml files.		todo: can we use :expand_path nuyaml config in labs?  ask guiseppe.		bug: t118772	change-id: i32bd25a84b182b52db7db81404734f1259b623e6	|"																																																																																																																																																																																																																																																																																																																																																											
create new eventlogging::analytics role in modules/role	" use scap for deployment		this is only the deployment of a new cloned repo to eventlog1001"	" it does not affect	the running deployment or daemons.		bug: t118772	change-id: ib37ec5a3aba1a9e018a700d4271b4930d4dc5472	|logrotate: convert eventlogging to logrotate::conf		bug: t127025	change-id: i0c55f679c678b37d6ae64ef736cd58ba2414b5e1	|puppetize eventlogging-service with systemd in role::eventbus		deployment via scap3.		this patch works in beta.  there is still work to be done"	"	but the patch is getting too large.  further work	will proceeed in new changes.		no changes on eventlog1001 according to	https://integration.wikimedia.org/ci/job/operations-puppet-catalog-compiler/1506/		todo: move role::eventbus::eventbus back to role::eventbus when t119042 works.	todo: use role::kafka::* to get kafka config.		bug: t118780	change-id: i621de844ed7a5bd1ac532b52058925350d9e5337	|keyholder/eventlogging: replace utf-8 chars		2 more occurences of utf-8 chars in *.pp files and then	that's all. replacing them because of t91453		zeromq is a redirect to mq on wikipedia as well. :p		bug:t91453	change-id: i59e95c76520159bcfaac6a6d371f7e8d9b1ada6f	|"																																																																																																																																																																																																																																																																																																																																																																
"adjust eventlogging icinga alert thresholds		eventlogging_throughput can handle more than 500 / s	eventlogging_overall_inserted_rate is currently less than 100 / s"	" we shouldn't warn at under 100	bring back eventlogging_navigationtiming_throughput alert"	" the metric had just changed in graphite		bug: t132770	change-id: i2e068fe259f68e3fbe1e44cbc55c4e0da4d1cf77	|add the moving average function to the event logging's insert rate alarming metric.	bug: t124204		change-id: i04e52e6a57a124f5c47dad316769c4e61bdc591e	signed-off-by: elukey <ltoscano@wikimedia.org>	|eventlogging"	" varnish: fix last 2 quoting warnings		these are the last 2 lint warnings of the type	""double quoted string containing no variable""	across the entire repo (except submodule cassandra).		for eventlogging i actually replace the quotes"	" for varnish	i just make lint ignore it.		after fixing these we can re-enable that particular lint check.		bug:t93645	change-id: ic834d12574d5d5eb04c9701c83c8250451f7d693	|eventloggging alarm that triggers when sql insertion decreases		bug: t119771	change-id: ic39dfcaa62f79e743bc2336fc79ef1614234a023	|use --until for eventlogging raw vs validated check		bug: t116035	change-id: i5586a1066225221fff3cf49c6ff7c6823b1640d4	|monitoring/graphite: add until time limit argument		add 'until' parameter providing shifted in time monitoring.	useful for metrics 'eventlogging_difference_raw_validated' that raises false	alarms due to graphite data not being up-to-date between (now-5mins) and now.		bug: t116035	change-id: i4b549e23b40bce53833d86b2d4a06206512c8b98	|modify eventlogging graphite alerts so that they are based on kafka metrics		bug: t106254	change-id: i58ceab9179c70c21f62180212fbaaf0bf049bd35	|change percentage in eventlogging validation alert		to avoid false positives for eventlogging_difference_raw_validated"	"	this change raises the number of data points over the threshold	needed to trigger the alert from 3/15 to 4/15.		it also adds the modifier 'absolute' to the alarm's metric"	"	to also raise alerts in the unlikely case the number of valid events	is significantly higher than the number of raw events.		bug: t108339	change-id: i64b2091be24a3b2531586cf5ea2ba775ef668d1a	|"																																																																																																																																																																																																																																																																																																																																																													
create new eventlogging::analytics role in modules/role	" use scap for deployment		this is only the deployment of a new cloned repo to eventlog1001"	" it does not affect	the running deployment or daemons.		bug: t118772	change-id: ib37ec5a3aba1a9e018a700d4271b4930d4dc5472	|"																																																																																																																																																																																																																																																																																																																																																																	
"remove notify from eventlogging::service:* classes to eventlogging/init service.		this never worked anyway"	" and we'd prefer to handle eventlogging service	restarts manually.  this also avoids a circular dependency.		bug: t118772	change-id: ib4dd131f1cd6c842d7cd89e0516a72cbe0baf20e	|eventlogging::service::* classes now depend but don't include eventlogging::server		this is so the path to eventlogging source code can be configured per deployment	target.  this should be a no-op on eventlog1001.		bug: t118772	change-id: i55600577a534161781833b6fa7fc51a423066482	|use eventlog1001 as main eventlogging host instead of vanadium		for this most part"	" this patch just does s/vanadium/eventlog1001/g.	it also configures a new varnishncsa instance on bits caches called	'eventlogging'"	" rather than 'vanadium'.  i have ensured that the	vanadium instnaces will be stopped"	" and the new eventlogging instances	will send to eventlog1001.  once this is applied"	" i will	manually remove the vanadium named instances and puppet configs.		bug: t90363	change-id: i2d0fc3d0a629f2bc75ef209ff2a51324893a9677	|"																																																																																																																																																																																																																																																																																																																																																														
"remove notify from eventlogging::service:* classes to eventlogging/init service.		this never worked anyway"	" and we'd prefer to handle eventlogging service	restarts manually.  this also avoids a circular dependency.		bug: t118772	change-id: ib4dd131f1cd6c842d7cd89e0516a72cbe0baf20e	|eventlogging::service::* classes now depend but don't include eventlogging::server		this is so the path to eventlogging source code can be configured per deployment	target.  this should be a no-op on eventlog1001.		bug: t118772	change-id: i55600577a534161781833b6fa7fc51a423066482	|"																																																																																																																																																																																																																																																																																																																																																																		
"remove notify from eventlogging::service:* classes to eventlogging/init service.		this never worked anyway"	" and we'd prefer to handle eventlogging service	restarts manually.  this also avoids a circular dependency.		bug: t118772	change-id: ib4dd131f1cd6c842d7cd89e0516a72cbe0baf20e	|eventlogging::service::* classes now depend but don't include eventlogging::server		this is so the path to eventlogging source code can be configured per deployment	target.  this should be a no-op on eventlog1001.		bug: t118772	change-id: i55600577a534161781833b6fa7fc51a423066482	|"																																																																																																																																																																																																																																																																																																																																																																		
"remove notify from eventlogging::service:* classes to eventlogging/init service.		this never worked anyway"	" and we'd prefer to handle eventlogging service	restarts manually.  this also avoids a circular dependency.		bug: t118772	change-id: ib4dd131f1cd6c842d7cd89e0516a72cbe0baf20e	|eventlogging::service::* classes now depend but don't include eventlogging::server		this is so the path to eventlogging source code can be configured per deployment	target.  this should be a no-op on eventlog1001.		bug: t118772	change-id: i55600577a534161781833b6fa7fc51a423066482	|remove etcd usage from eventlogging processor		this is no longer supported"	" clientips are no longer collected so they don't need hashed		bug: t128407	change-id: ia6dae7c81c63dc54b61f35e97f1aab3ff0c63834	|puppetize etcd use for eventlogging processor		this will allow eventlogging to consistently hash client ips even	when parallelized.		requires that https://gerrit.wikimedia.org/r/#/c/238854/ is deployed.		this change also adds a provide_private parameter to etcd::ssl so that	the class can be used for etcd clients"	" not just etcd servers.		bug: t112688	change-id: i8ba49df87b4edb080d3e4786b4f884a61ef003e6	|use eventlog1001 as main eventlogging host instead of vanadium		for this most part"	" this patch just does s/vanadium/eventlog1001/g.	it also configures a new varnishncsa instance on bits caches called	'eventlogging'"	" rather than 'vanadium'.  i have ensured that the	vanadium instnaces will be stopped"	" and the new eventlogging instances	will send to eventlog1001.  once this is applied"	" i will	manually remove the vanadium named instances and puppet configs.		bug: t90363	change-id: i2d0fc3d0a629f2bc75ef209ff2a51324893a9677	|"																																																																																																																																																																																																																																																																																																																																																												
"remove notify from eventlogging::service:* classes to eventlogging/init service.		this never worked anyway"	" and we'd prefer to handle eventlogging service	restarts manually.  this also avoids a circular dependency.		bug: t118772	change-id: ib4dd131f1cd6c842d7cd89e0516a72cbe0baf20e	|eventlogging::service::* classes now depend but don't include eventlogging::server		this is so the path to eventlogging source code can be configured per deployment	target.  this should be a no-op on eventlog1001.		bug: t118772	change-id: i55600577a534161781833b6fa7fc51a423066482	|"																																																																																																																																																																																																																																																																																																																																																																		
"eventlogging::service::* classes now depend but don't include eventlogging::server		this is so the path to eventlogging source code can be configured per deployment	target.  this should be a no-op on eventlog1001.		bug: t118772	change-id: i55600577a534161781833b6fa7fc51a423066482	|create eventschemas module"	" use this in eventbus role		add ability for eventlogging-service to reload (sighup) on	puppet resource changes.		bug: t127099	change-id: ibe8670b67cf5c77a6b1fc8bbd340634850a9563f	|puppetize eventlogging-service with systemd in role::eventbus		deployment via scap3.		this patch works in beta.  there is still work to be done"	"	but the patch is getting too large.  further work	will proceeed in new changes.		no changes on eventlog1001 according to	https://integration.wikimedia.org/ci/job/operations-puppet-catalog-compiler/1506/		todo: move role::eventbus::eventbus back to role::eventbus when t119042 works.	todo: use role::kafka::* to get kafka config.		bug: t118780	change-id: i621de844ed7a5bd1ac532b52058925350d9e5337	|"																																																																																																																																																																																																																																																																																																																																																																	
create eventschemas module	" use this in eventbus role		add ability for eventlogging-service to reload (sighup) on	puppet resource changes.		bug: t127099	change-id: ibe8670b67cf5c77a6b1fc8bbd340634850a9563f	|"																																																																																																																																																																																																																																																																																																																																																																		
"exim: fix exim4::dkim's content parameter		it was typo'ed to defining ""content"" to $source.		bug: t113051	change-id: ie18f2d736ef938572eb0980f6c4095a65de0a9e8	|"																																																																																																																																																																																																																																																																																																																																																																			
"extdist: unbreak		after c127ad9f2819a"	" $log_path is no longer defined.		and ensure $log_dir is a directory.		bug: t123090	change-id: i543771522ea0ecf27e3463768600b9849fd8e46d	|extdist: add composer location to config		bug: t70940	change-id: ibb5b6c8649d747e42ee9fb4f9aeaec269500a66c	|extdist: clone composer into /srv/composer		bug: t70940	change-id: i9c4c655eec649019bd40bcd397e9e8a435e448d2	|add extdist module + role for labs		the extdist role sets up a tarball generator for use	with the extension distributor extension on mediawiki.org	running from labs.		the module can"	 in the future	" be potentially used on prod.		bug: 68609	change-id: i63d285612bd30d24b83718c4c8967144d146afeb	|"																																																																																																																																																																																																																																																																																																																																																																
"ferm: resource attributes quoting		bug: t91908	change-id: ic9f2eacb394b93ffc9cf5632b87df44a7f693717	|"																																																																																																																																																																																																																																																																																																																																																																			
"raise default conntrack table size		the services which are currently using connection tracking usually peak	around 40k connections tracked (several high traffic services also	use notrack).		still"	" since the effects of a filled-up table are rather drastic (no	further connections accepted)"	" let's leave some additional headroom	for situations like ddoss etc.		the additional memory consumption is negligable with modern hardware:	according to /proc/slabinfo one table entry uses 312 bytes of memory"	"	so extending it by a factor of 4 requires an additonal 58 megabytes of	memory.		the sysctl value net.netfilter.nf_conntrack_buckets is read-only"	" it	can only be configured through a modprobe parameter or via echoing to	/sys/module/nf_conntrack/parameters/hashsize		ship a configuration file in /etc/modprobe.d to set that value on reboot	and in addition configure it for existing installations via	""echo 32768 > /sys/module/nf_conntrack/parameters/hashsize"".		when starting nf_conntrack with a hashsize of 32768"	" nf_conntrack_max	is preset to 262144 by the linux kernel"	" so use that as the basis.		ps8 with the onlyif variante which only runs once.		bug: t105307	change-id: iec9c051a7a0a941b21f6a297f974d99d17d5b655	|ferm: resource attributes quoting		bug: t91908	change-id: ic9f2eacb394b93ffc9cf5632b87df44a7f693717	|"																																																																																																																																																																																																																																																																																																																																																													
"ferm: resource attributes quoting		bug: t91908	change-id: ic9f2eacb394b93ffc9cf5632b87df44a7f693717	|"																																																																																																																																																																																																																																																																																																																																																																			
"ferm: resource attributes quoting		bug: t91908	change-id: ic9f2eacb394b93ffc9cf5632b87df44a7f693717	|"																																																																																																																																																																																																																																																																																																																																																																			
"ganeti module/role introduced		a module for handling ganeti clusters. includes code to handle kvm	installation and ksm configuration"	 ganeti node handling	" lvm	configuration"	" drbd installation as well as some useful puppet facts and	scripts. the facts have no actual use right now but are going to be	useful in the near future. tests for the module are provided and are	passing.	role class is included as well providing firewall"	 monitoring	" key handling		bug: t87258	change-id: i337dd68ec404a2e15ea40358436e177a9a168c3e	|"																																																																																																																																																																																																																																																																																																																																																														
"ganeti module/role introduced		a module for handling ganeti clusters. includes code to handle kvm	installation and ksm configuration"	 ganeti node handling	" lvm	configuration"	" drbd installation as well as some useful puppet facts and	scripts. the facts have no actual use right now but are going to be	useful in the near future. tests for the module are provided and are	passing.	role class is included as well providing firewall"	 monitoring	" key handling		bug: t87258	change-id: i337dd68ec404a2e15ea40358436e177a9a168c3e	|"																																																																																																																																																																																																																																																																																																																																																														
"ganeti module/role introduced		a module for handling ganeti clusters. includes code to handle kvm	installation and ksm configuration"	 ganeti node handling	" lvm	configuration"	" drbd installation as well as some useful puppet facts and	scripts. the facts have no actual use right now but are going to be	useful in the near future. tests for the module are provided and are	passing.	role class is included as well providing firewall"	 monitoring	" key handling		bug: t87258	change-id: i337dd68ec404a2e15ea40358436e177a9a168c3e	|"																																																																																																																																																																																																																																																																																																																																																														
"ganglia: add ganglia::cluster exported resource		the sole purpose of this resource is to get exported and thus end up in	storedconfigs. from there we can pick it up via sql and export it in other	formats"	" e.g. a mapping from cluster to list of hosts in that cluster.		bug: t119520	change-id: i037108db9ec003b6f54dc386c19ab82093c3f166	|"																																																																																																																																																																																																																																																																																																																																																																		
"ganglia: switch esams aggregator to bast3001		switch the ganglia aggregator for esams from hooft	to newly installed bast3001.		also use ""ipresolve"" now instead of ip like it's done for the	other upgraded hosts.		bug:t123712	change-id: i599b83354d22e354d4751a161a90536aa90ff4b7	|"																																																																																																																																																																																																																																																																																																																																																																			
"cp10[56]1: upload->misc		bug: t125486	change-id: i93d871288a519b3939746b2af217c5379705c617	|"																																																																																																																																																																																																																																																																																																																																																																			
"ganglia: fix optional parameter listed before required parameter		bug: t93645	change-id: icf06eaba5964e34921b03aa90741770b30249656	|"																																																																																																																																																																																																																																																																																																																																																																			
"ganglia: fix optional parameter listed before required parameter		bug: t93645	change-id: icf06eaba5964e34921b03aa90741770b30249656	|"																																																																																																																																																																																																																																																																																																																																																																			
"ganglia: replace reserved characters in cluster name		bug: t128369	change-id: ia51645ce619494b6ee5a47ab083be4c2898d81bb	|ganglia: add ganglia::cluster exported resource		the sole purpose of this resource is to get exported and thus end up in	storedconfigs. from there we can pick it up via sql and export it in other	formats"	" e.g. a mapping from cluster to list of hosts in that cluster.		bug: t119520	change-id: i037108db9ec003b6f54dc386c19ab82093c3f166	|"																																																																																																																																																																																																																																																																																																																																																																		
"ganglia: do not start meta-service on jessie/systemd		when using systemd"	" we start each aggregator instance	separately from a template and each is their own service (i10726144b4f21b3).		so we don't need this 'meta-service' there that we used on upstart	which started all the instances with a script.		bug:t124197	change-id: i91c009c0b814176ad55d71fbd606fb209cde221a	|ganglia: don't install old init scripts if systemd is used		these scripts used to be what starts multiple instances of the	ganglia-monitor-aggregator service on older systems with upstart.		since we are using systemd now/soon"	" we start each instance as separate	service from a unit file template"	" using the proper systemd/puppet	abstraction and this file is not needed and conflicts with puppet	dependencies on the service name.		bug:t124197	change-id: ibdb63a4b900d6dea8723f4eb65b7a66f5503a0cc	|ganglia: don't try to use upstart on jessie		bug:t123674	change-id: i0f6dd718620fd3dd5ed9ac8863c251878ba17d0e	|"																																																																																																																																																																																																																																																																																																																																																																
"ganglia: restrict ganglia aggregation to just production		the following 2 rules are limited on purpose to only allow production	networks to reach the ganglia aggregators. ganglia has been tried in labs	and failed so for now we will be limiting ganglia aggregation to just	production. this closes effectively the hole described in t122396		bug: t122396	change-id: ic1be512030e60c8e2792cf1ab0ef411631daf499	|ganglia: no dependency for old upstart service on systemd		this service dependency is only valid on upstart systems.	when using systemd each aggregator is a separate service and this	one doesn't exist anymore and puppet will fail.		bug:t124197	change-id: ib3278fb515158d4f64337bff99daad1321697b88	|ganglia: fix systemd instance service name		this was the wrong format"	" the puppet systemd provider tries to	exec this as systemctl start ganglia-monitor-aggregator-instance-2027"	"	etc.		the format should be:		systemctl start ganglia-monitor-aggregator@2008.service		to evoke an instance from the @template		bug:t124197	change-id: iaf53dc32838d7c8e3ea74ab4fa819f584df0b8fd	|ganglia: on jessie"	" spawn aggregators with systemd		if on jessie/systemd"	" we are starting each aggregator	instance as a separate service"	" spawned from a single	service template unit file.		(as opposed to upstart where we had one service starting many	aggregators from the init script)		bug:t124197	change-id: i10726144b4f21b3e4b525f94e24b6059b88cd7a0	|ganglia: replace reserved characters in cluster name		bug: t128369	change-id: ia51645ce619494b6ee5a47ab083be4c2898d81bb	|"																																																																																																																																																																																																																																																																																																																																																														
"ganglia: don't run ganglia-monitor in labs		this is a partial fix for the current situation where all instances in labs	default to 'miscellaneous eqiad' cluster in the production ganglia. also"	"	host-level metrics for labs instances are already pushed to graphite by diamond	and grouped by project.		bug: t115330	change-id: i1cb6e53af05ca5ccd22a06f8d565525a970dca60	|"																																																																																																																																																																																																																																																																																																																																																																		
"stop using package->latest in ganglia monitor		bug: t115384	change-id: i9c945395bee14b8aabfa09b5933f3a09baf07808	|"																																																																																																																																																																																																																																																																																																																																																																			
"ganglia: add unit file template for systemd		adds a unit file template for the ganglia-monitor-aggregator service	when using systemd on jessie.		from this template we can then start multiple aggregators"	"	one per server cluster"	 each using their own port number	" like we	did before with upstart"	" but now using systemd.		bug:t123674	change-id: i814ccb2c79b3a5a77b7231e7627a80ca0aa4bb94	|"																																																																																																																																																																																																																																																																																																																																																															
"ganglia: fix optional parameter listed before required parameter		bug: t93645	change-id: icf06eaba5964e34921b03aa90741770b30249656	|add mod_headers to the httpd config to allow the header directive.		a recent email from uranium contained the following error:	""""""	ah00526: syntax error on line 35 of	/etc/apache2/sites-enabled/50-ganglia-wikimedia-org.conf:	invalid command 'header'"	" perhaps misspelled or defined by	a module not included in the server configuration	""""""		bug: t132324	change-id: i80526e19097f60cb774b40c3cdac06b978c04db2	|add hsts=1y to several one-off public services		this adds hsts=1y headers to the following services:		archiva.wikimedia.org	dumps.wikimedia.org	ganglia.wikimedia.org	librenms.wikimedia.org	rcstream.wikimedia.org		note this does not imply any redirects"	" or force a client which is	not https-capable to use https.  what it accomplishes is that if	an hsts-honoring user agent successfully reaches the service over	https once"	" the sts header will lock their future access from that	client onto https going forward.		bug: t132521	change-id: idb40ad1bfc5db93989713a68d1bf3eef2e8c4843	|ganglia: use recursion to tidy /tmp		tidy requires explicit recursion to work		bug: t97637	change-id: i9b1e6a38d0c4e277c264a3f765cddf636e60b915	|ganglia: cleanup old temporary graphs		we've attempted a few fixes in t97637 but sometimes ganglia still won't clean	up after itself"	" so tidy its graphs in /tmp		bug: t97637	change-id: ic415c7e6cd60134c5d3d2c735450f586419af575	|"																																																																																																																																																																																																																																																																																																																																																															
"logrotate: convert geoipupdate to logrotate::conf		bug: t127025	change-id: i49fa5f02899ba066dcfbb106a492a30465873983	|"																																																																																																																																																																																																																																																																																																																																																																			
"geoip: disable show_diff		potentially the same issue we've experienced with puppet failing when the diff	contains invalid utf8 byte sequences		bug: t93614	change-id: i2de2d484b8c4540aa5ea5704e2c254591bd58054	|"																																																																																																																																																																																																																																																																																																																																																																			
"prep varnishd for libmaxminddb-based vcl		splitting this from the actual vcl change makes transition	simpler: we can restart all frontends with the new flags"	" then	selectively test/deploy the actual vcl change while both libs are	enabled.		bug: t99226	change-id: if82dc25425ea754c8fb4d44e3b4a4a32a077799a	|"																																																																																																																																																																																																																																																																																																																																																																		
"gerrit: simplify ssl and hostname management		- don't pass it around the role if we don't need to	- use letsencrypt if we don't have a dedicated cert		bug:t125018	change-id: i830bc1fa60d775236200996425b9c633f435b40c	|"																																																																																																																																																																																																																																																																																																																																																																			
"gerrit: ensure symlink /etc/default/gerritcodereview		when applying the prod role on labs"	" with the latest	deb package as well as the older one"	" puppet said	it could not start the service because:		error: gerrit_site not set		looking at /etc/init.d/gerrit it says:		""configuration variables.  these may be set in /etc/default/gerritcodereview.""		in production we have 2 files /etc/default/gerritcodereview	and /etc/default/gerrit.		they both have the same content"	 just 2 lines	"	one of them setting the gerrit_site.		gerrit_site=""/var/lib/gerrit2/review_site""	gerrit_war=""/var/lib/gerrit2/review_site/bin/gerrit.war""		but on labs"	" we did not get this file automatically.		looking at the package"	" dpkg -l shows it installs /etc/default/gerrit	but not the other missing one.		so we just created it as a symlink to the existing file and this	is puppetizing it.		bug: t141803	change-id: i2fec1de95dc1d96470466662c8b5747f77e5454e	|gerrit: default to no replication		makes labs harder to use otherwise as you'll need to manually set it	to '' all the time.		bug: t141803	change-id: i575a1bbdb694382a6eeb7efbdd9f8ef9fd158f54	|gerrit: remove bugzilla password"	" unused since 4eva		change-id: i9a40938ea1caf7442b3202c6a95a0f78ff55a7f9	|stop using package->latest in gerrit module		bug: t115348	change-id: i27e4b65a8f45b86f7462c2cc1963745ef64dc83e	|gerrit: transition to ssh::userkey		bug: t92475	change-id: i098340b5ff36859897f4c4fefa49730eea2a3dd3	|drop 'phabricator' suffix from gerrit's its actions		it's only phabricator right now. no more bugzilla. so we can now skip	the phabricator suffix.		change-id: i0ace692a6e5d6f469bb8459f6d47439af264f3ce	|remove hooks-bugzilla configuration		the hooks-bugzilla plugin is no longer in use.		we only keep the bugzilla commentlink around to linkify bugzilla	references and as its-phabricator-from-bugzilla currently uses this	commentlink to hook into gerrit.		change-id: i83457c374ee8499f6b53182430f9a33d6636333c	|"																																																																																																																																																																																																																																																																																																																																																												
"gerrit: simplify ssl and hostname management		- don't pass it around the role if we don't need to	- use letsencrypt if we don't have a dedicated cert		bug:t125018	change-id: i830bc1fa60d775236200996425b9c633f435b40c	|"																																																																																																																																																																																																																																																																																																																																																																			
"graphite: port to jessie/systemd		* add carbon-cache@.service"	" one for each carbon-cache instance	* add service files for carbon local/frontend relay	* add carbon.service to manipulate carbon-related services interactively via	  'systemctl stop/start carbon'"	" partially replacing 'carbonctl'	* carbon-cache now logs to /var/log/carbon/<instance>/	* graphite-auth fixes for django 1.7		bug: t132717	change-id: i674b71f145d4b43373d4248882b8b78b6dc63b44	|graphite: introduce carbon-c-relay		the idea behind this change is to have a local carbon-c-relay instance (on port	1903) whose sole task is to forward incoming metrics to the local carbon-cache"	"	in practice replacing carbon-relay's role.		in turn"	" this local carbon-c-relay will receive metrics from a frontend	carbon-c-relay listening on standard port 2003 for line/plaintext protocol	metrics.		bug: t85908		change-id: i61f687237baed6674fcc9813acc9df0ce40d4fbb	|"																																																																																																																																																																																																																																																																																																																																																															
"graphite: port to jessie/systemd		* add carbon-cache@.service"	" one for each carbon-cache instance	* add service files for carbon local/frontend relay	* add carbon.service to manipulate carbon-related services interactively via	  'systemctl stop/start carbon'"	" partially replacing 'carbonctl'	* carbon-cache now logs to /var/log/carbon/<instance>/	* graphite-auth fixes for django 1.7		bug: t132717	change-id: i674b71f145d4b43373d4248882b8b78b6dc63b44	|"																																																																																																																																																																																																																																																																																																																																																																	
"graphite: port to jessie/systemd		* add carbon-cache@.service"	" one for each carbon-cache instance	* add service files for carbon local/frontend relay	* add carbon.service to manipulate carbon-related services interactively via	  'systemctl stop/start carbon'"	" partially replacing 'carbonctl'	* carbon-cache now logs to /var/log/carbon/<instance>/	* graphite-auth fixes for django 1.7		bug: t132717	change-id: i674b71f145d4b43373d4248882b8b78b6dc63b44	|graphite: introduce carbon-c-relay		the idea behind this change is to have a local carbon-c-relay instance (on port	1903) whose sole task is to forward incoming metrics to the local carbon-cache"	"	in practice replacing carbon-relay's role.		in turn"	" this local carbon-c-relay will receive metrics from a frontend	carbon-c-relay listening on standard port 2003 for line/plaintext protocol	metrics.		bug: t85908		change-id: i61f687237baed6674fcc9813acc9df0ce40d4fbb	|graphite: enable locking writes		our graphite clustering plan involves using carbonate while carbon-cache is	running"	" this can potentially lead to corrupted whisper files if locking isn't	used"	" see also https://github.com/jssjr/carbonate/issues/19		bug: t86316	change-id: i76b064acf3b7ccad17313a4f05c3b72b3b01b798	|graphite: explicit install python-twisted-core		bug: t85909	change-id: ib8b50bfc1b06537f05ebb9977d26002bf128b914	|"																																																																																																																																																																																																																																																																																																																																																													
"graphite: run archive-instance once a day		instances are not deleted frequently anyways"	" also somewhat lessen the impact	of t120377		bug: t120377	change-id: i990e5af18297395b241f852ee49cf35f2d01d925	|"																																																																																																																																																																																																																																																																																																																																																																		
"graphite: add error alerts		provide alerts for error situations"	 e.g. queue dropping datapoints	" too many	metric creations"	" file write errors		bug: t92965	change-id: i0d3816e922bb749f0750d49299c56d0d2e34034c	|"																																																																																																																																																																																																																																																																																																																																																																
"graphite: add cluster_servers graphite-web setting		moving to multiple graphite machines means instructing graphite-web to ask	other servers for metrics when queried		bug: t85451	change-id: i71697f084f40c1bbdb0217f5136b34d01170c0dd	|add logrotate fragment for graphite-web		(currrently"	" no rotation is active)		bug: t92406	change-id: idc20ce6a3f5c577160c2529ecc939b20dc555570	|"																																																																																																																																																																																																																																																																																																																																																																		
"graphoid: do not use the proxy for the allowed domains		bug: t134241	change-id: id6148a680dbcf311629d15d66f762a9cb0945880	|set graphoid result headers		in production"	" set caching headers to 1hr. in betacluster - 10min.	on error"	" 5 min and 30 seconds.		bug: t134542	change-id: i4b473b9821ac4bd8fa4ac8f50e32ae9d849d1553	|services: introduce service::packages		some services"	 like mathoid and graphoid	" need extra debian packages to	be present on the system during run time. additionally"	" they also have	compile-time dependencies (mostly header files packaged in -dev	packages). service::packages provides a way for us to specify and	install the complete list of such dependencies for each service. by	default"	 service::packages installs only run-time dependencies	" but can	be instructed to install compile-time packages as well by setting the	service::configuration::use_dev_pkgs flag to true. this is useful in	cases where the service's dependencies need to be built on the spot"	"	such as ci/nodepool instances. this patch activates the flag for the	contintcloud labs project.		while at it"	" this patch also switches mathoid and graphoid to use	service::packages"	 listing their complete debian dependencies. also	"	mathoid will not be using java png generation (which was never turned on	in production any way). instead"	 the upcoming version will use librsvg	"	so list it as a dependency.		bug: t128280	bug: t119693	change-id: i882f0f768bdea0c78403513e5eb1d778bef97462	|graphoid: enable spec-based monitoring		bug: t94821	change-id: if0c5b0790583794275dc43de458fa167d8bb24b5	|remove firejail conditional		now that firejail"	" graphoid and mathoid have been migrated to firejail	in production"	" remove the ""firejail"" conditional in service::node and	use firejailed execution for all upcoming services.		bug: t101870	change-id: i0970967a2eb7e8d9b21ef361d6107702f20e15d1	|enable firejail for graphoid		enable firejail for graphoid (preliminary tests on deployment-sca02 were	fine"	" but more tests to follow)		bug: t103095	change-id: ifbedad623496f0267e86f10798872fa1df191d55	|graphoid: service deployment on sca		this patch introduces the role::graphoid and graphoid classes"	"	responsable for deploying graphoid on the sca cluster"	" together with its	configuration. concretely"	" the graphoid class installs the package	dependencies and uses service::node to create the rest. hiera is	configured so that graphoid works both in production and	deployment-prep.		bug: t90487	change-id: i1d3edad9f5df5b3a9ea9443411f228fd24e74ed0	|"																																																																																																																																																																																																																																																																																																																																																
"services: introduce service::packages		some services"	 like mathoid and graphoid	" need extra debian packages to	be present on the system during run time. additionally"	" they also have	compile-time dependencies (mostly header files packaged in -dev	packages). service::packages provides a way for us to specify and	install the complete list of such dependencies for each service. by	default"	 service::packages installs only run-time dependencies	" but can	be instructed to install compile-time packages as well by setting the	service::configuration::use_dev_pkgs flag to true. this is useful in	cases where the service's dependencies need to be built on the spot"	"	such as ci/nodepool instances. this patch activates the flag for the	contintcloud labs project.		while at it"	" this patch also switches mathoid and graphoid to use	service::packages"	 listing their complete debian dependencies. also	"	mathoid will not be using java png generation (which was never turned on	in production any way). instead"	 the upcoming version will use librsvg	"	so list it as a dependency.		bug: t128280	bug: t119693	change-id: i882f0f768bdea0c78403513e5eb1d778bef97462	|"																																																																																																																																																																																																																																																																																																																																																								
"tool labs: more bugfixes to gridengine class		- template(template(x)) isn't as useful as might seem	  at first glance (don't expand twice)		change-id: ide24a8bd21e9d5ef0369b55d7db97bdc5d21bb1b	|"																																																																																																																																																																																																																																																																																																																																																																			
"tool labs: more bugfixes to gridengine class		- template(template(x)) isn't as useful as might seem	  at first glance (don't expand twice)		change-id: ide24a8bd21e9d5ef0369b55d7db97bdc5d21bb1b	|"																																																																																																																																																																																																																																																																																																																																																																			
"gridengine: fix status check for gridengine-exec		even though i am *very* certain that i tested both on	toolsbeta-exec-101 and toolsbeta-exec-202 *exactly* that indeed the	gridengine-exec service was identified as running when there was an	sge_execd process"	" somewhere down the line reality shifted and now	puppet is behaving as documented at	https://docs.puppetlabs.com/references/latest/type.html#service-attribute-hasstatus:		| [...]		| if a service's init script does not support any kind of status	| command"	" you should set hasstatus to false and either provide a	| specific command using the status attribute or expect that puppet will	| look for the service name in the process table.  [...]		so this change sets hasstatus to false to force puppet to use the	pattern attribute.		bug: t110532	change-id: i1244c55c77e605d3e98d0436ee7923a156223a93	|gridengine: ensure that service gridengine-exec is running		bug: t109728	change-id: i475541888365a986571ee1c4d0078ca24b5cec37	|"																																																																																																																																																																																																																																																																																																																																																																	
"gridengine: puppetize gridengine-mailer		bug: t63160	change-id: ia0fb28010ad05996e71c1e057e4185b40bfcb532	|"																																																																																																																																																																																																																																																																																																																																																																			
"gridengine: do not have puppet autostart the master		this doesn't work very well since the gridengine init	file does not have a 'status' and hence puppet has no idea	if this is running or not.		bug: t122638	change-id: i3e955496f4f520d24b89cd7aad42e589cef05d2d	|tool labs: start gridengine-master by default		this comes with a caveat: any work on the grid master"	" or any	deliberate switchover to the shadow master"	" then requires that	the puppet agent be disabled on tools-master to avoid	random restarts.		bug: t109316	change-id: ie677b5745d2fd6b190cf1ae4717e685621acc67b	|tools: puppetize gridengine complex configuration		bug: t107821	change-id: ie2c7b07efc055ddb6ccbb1c8a2b18244f2684764	|make qacct usable		with this change"	" we push the grid engine accounting file from the	master every five minutes to the shared project directory and pull it	from there to the individual submit hosts roughly a minute later.	this gives users a granularity that should be sufficient for most	development work.		we use temporary files to achieve atomicity and prevent qacct reading	incomplete files.		this change assumes that a grid engine master (gridengine::master) is	never a submit host (gridengine::submit_host).  otherwise in the worst	case accounting information added between the push and the pull would	be lost.		this fixes bug #48696.		bug: 48696	change-id: i29f0e42e4f49a406565344c31a7c93924bcd7408	|add ganglia statistics to grid engine.		statistics for the grid jobs in pending"	" running and error state are	forwarded every minute to ganglia via gmetric under the ""sge""	grouping.		bug: 48338	change-id: i48a65620d2fa5ee0fa3d147f9157af60c44c31c3	|more tweaks and bugfixes for the tool labs		- gridengine::master to use $fqdn as gridmaster	- typo fix in toollabs::webserver		change-id: i92f167e53abd1a450c179d2a9a43761dd444e083	|"																																																																																																																																																																																																																																																																																																																																																															
"gridengine: fix puppet-lint warning		the change b4afac8d0b9143450648dc3323ed8e364cf0adca removed the	parameter $local from the type gridengine::resourcedir"	" effectively	setting it to false from the previous default true.  this setting	(false) is necessary for the cross-instance configuration via a shared	file system folder to work.		this change makes the setting explicit.		bug: t125042	change-id: iea80c08e62e0fdc0a0af4cfc74eff64fab8b5a7b	|"																																																																																																																																																																																																																																																																																																																																																																		
"tools: manage obsolete files in /usr/local/bin		/usr/local/bin had some obsolete versions of scripts that since then	have been moved to /usr/bin.  to properly manage those"	" we add	symbolic links pointing to /usr/bin.  also"	" the requirement of the	jobutils package is moved from toollabs::bastion and	toollabs::webserver to gridengine::submit_host.  this fixes bug		bug: 52258	change-id: i28ff4ea1806f0f58e1738cf8194f44ea49085608	|make qacct usable		with this change"	" we push the grid engine accounting file from the	master every five minutes to the shared project directory and pull it	from there to the individual submit hosts roughly a minute later.	this gives users a granularity that should be sufficient for most	development work.		we use temporary files to achieve atomicity and prevent qacct reading	incomplete files.		this change assumes that a grid engine master (gridengine::master) is	never a submit host (gridengine::submit_host).  otherwise in the worst	case accounting information added between the push and the pull would	be lost.		this fixes bug #48696.		bug: 48696	change-id: i29f0e42e4f49a406565344c31a7c93924bcd7408	|"																																																																																																																																																																																																																																																																																																																																																																
update haproxy default file	" as it cannot be dynamic in jessie		as in jessie (systemd) the default config file cannot be a script"	"	but only a set of key-value pairs"	" we need to generate it	automatically.		this has been added to the systemd unit pre script and tested	successfully on dbproxy1005. the ""if"" and the duplicate defaults	file will be dropped as soon as all proxies are upgraded to	jessie.		bug: t125027	change-id: if2dd396fc7bfc38201337b9d318f12e69dc2519e	|haproxy: move check_haproxy to module itself		bug: t87132	change-id: i687f9918bce9c76990ef825e86348b7ca2ab1b1b	|"																																																																																																																																																																																																																																																																																																																																																																
"provide a systemd override unit for hhvm		the default service file shipped by the hhvm debian package needs to	be extended with a few site-specific changes. previously these were	overwritten entirely"	" but that led to problems when upgrading the	hhvm package: after an update it was running with incorrect settings	until the next puppet run.		this patch provides an override file with our customisations. a few vendor	settings need to be overwritten entirely"	" which is done with an initial blank	config line like ""execstart="".		the settings can be displayed with ""systemctl cat hhvm.service"". this	doesn't fully display the effective settings"	" though. that's still tbd	on upstream's side: https://github.com/systemd/systemd/issues/2654		bug: t143210	change-id: i7c9dab14b96682a6947882730143da56b63c3db1	|hhvm: add su directive to logrotate recipe		our current recipe was causing an error to be thrown on debian jessie.		bug: t137689	change-id: id29373f7e36c1ebd90216e1e800b678ffe210ff5	|hhvm: allow passing service parameters		ci does not need a hhvm service running in the background. we would want	to have the service to not be enabled on boot and not ensured running.		add service_params to hhvm class"	" pass it to base::service_unit.		bug: t126594	change-id: i4bc1ab34093b017329e6c2fe95ae6a4625674e5d	|hhvm: explicitly declare existence and ownership of cache files		bug: t112517	change-id: i04d270c8f0c2f3f6c7121b6e065b7a7da9d354f1	|disable fss.so on all hhvm servers		follow-up to i6985a8128. remove the hiera override for the canaries	and apply the change generally.		bug: t101418	change-id: i1685a65f940b12b7ecdad9bda78d236285d1b036	|set maximum execution time to 60 seconds		last in a sequence of changes spanning i00e1a6c57"	 ia5a30b7a0	" and i1fa012ca1.		bug: t97204	change-id: i00e1a6c57c673509443b8faefb361958b06c52d0	|remove hhvm-fss package from production		obsoleted by https://reviews.facebook.net/d40473"	" which i backported for our	package. i will remove the package by hand using salt.		bug: t101418	change-id: id0e9719e33b1eb945fa015c89ac363c717d82c11	|hhvm: expire apc keys after 2 days		we don't want keys to live indefinitely in apc in hhvm (as it implies	memory starving)"	" so we set an upper limit to the ttl of any key.		bug: t104769	change-id: i2259991ac6d68bc107c9c3c8ced4bd1a9abfe3c1	|hhvm: set apc expiration correctly		it's hhvm.server.apc.expire_on_sets"	" not hhvm.apc.expire_on_sets.		bug: t104769	change-id: ic708426dc8e71a2304369899dbe06b588a292a5b	|set hhvm.hack.lang.iconv_ignore_correct for //ignore behavior		enable the hhvm specific setting to work around glibc 2.14+ iconv	handling for '//ignore'.		bug: t98882	change-id: i197d2437a5553997eaf435db310107a02b6e40f0	|hhvm: make base_jit_size configurable		since hhvm 3.6 requires (apparently) a larger translation cache space	than hhvm 3.3"	" we make the parameter configurable and override the	default value on beta.		bug: t93194	change-id: ic2cb4c52e3652aed54fe7bd6963e081725e299bf	|hhvm: convert 'ascii art' to ascii		in order to fix more ""invalid byte sequence in us-ascii"" with ruby 1.9.x.		https://tickets.puppetlabs.com/browse/pup-1031		bug:t91453	change-id: i267f42716320fcb7f4d3af479d301fa75fd729e7	|hhvm: fix include_path		the include_path php setting was incorrectly set under the 'hhvm.'	hierarchy which does not work:		    $ grep include_path /etc/hhvm/php.ini	    hhvm.include_path = .:/usr/share/php		    $ hhvm -a	    hphpd> print ini_get('include_path');	    print ini_get('include_path');	    "".""		it needs to be `include_path` and the value enclosed in double quotes	and then:		    $ grep include_path /etc/hhvm/php.ini	    include_path = "".:/usr/share/php""		    $ hhvm -a	    hphpd> print ini_get('include_path');	    print ini_get('include_path');	    "".:/usr/share/php""		that fix the phpunit tests for timedmediahandler mediawiki extension	which uses include('pear.php').		bug: t78556	change-id: i6084f49e97c855286b86dbbd6ce8e80e94069492	|hhvm: provision hhvm-tidy and load tidy.so		bug: t578	change-id: i1143954b539b0f47d284b071645c57417be8bb25	|"																																																																																																																																																																																																																																																																																																																																																									
"hhvm: skip ganglia when it is unwanted		on labs ganglia is no more available.  drop it from hhvm::monitoring	when it is known to not be here ( $::standard::has_ganglia ).		see also change to the apache module:	    https://gerrit.wikimedia.org/r/287695		bug: t134808	change-id: i2bfc4a4364619d33112df270ee4cca127bceff72	|add diamond collector for hhvm apc stats		bug: t116255	change-id: i87682f905a151df29eb38e705d154181bdd6c4c7	|"																																																																																																																																																																																																																																																																																																																																																																			
"logrotate: convert icinga to logrotate::conf		bug: t127025	change-id: ifc7256491181ede8a31edbe2ecbad430fbf16f10	|icinga: libssl0.9.8 for nrpe checks to run		t110893 says that one of the manual steps was to install	libssl0.9.8 (in addition to libssl1.0.0) for some nrpe	checks to run and that we should puppetize that.		indeed both packages are installed on neon.		bug:t110893	change-id: i7c255b300ae106c6cf752c0325ddd97fff264ffa	|rename icinga-downtime script		icinga-downtime is the nicer name and as originally requested.	also the usage example didn't match the file name.		bug:79842	change-id: iab0ce2379ea44423e7ea64b2831917e832af20c1	|icinga: add script to schedule host downtimes		adds a script to schedule icinga host downtimes from the commandline.		bug:t79842	change-id: if82d9402edbc9e88c0f6a35ac795e37e0cedf0ce	|"																																																																																																																																																																																																																																																																																																																																																																			
"adding a ""interactive-team"" icinga group for alerting.		this adds an icinga group for the interactive team (yurik"	" maxsem and gehel).	it also sends notifications to #wikimedia-interactive.		bug: t137869	change-id: i5ad6fcb369985939bc6f4d9a6a87891bc0f0f7fb	|ores: send icinga report to irc		bug: t134726	change-id: i7ed577bec766377a28473d3b73ad6b9b1ab44e62	|change bz references to phabricator tickets		except in the mediawiki module		bug: t96431	change-id: i6b36e500635537e28520bf5bd61585ff00a41755	|icinga-wm: configure to join -analytics channel		let icinga-wm join the -analytics channel and report	things from the new custom -analytics log file.		bug:t96928	change-id: iee990607270fa4520e6c98b89919374cf82109a6	|move notices to -releng from -qa		also general s/qa/releng/"	" which i hope was done correctly.		bug: t86053	change-id: i094610fb1c6dbde83c62d4a03fb1baab8c30d2ca	|duplicate -qa notifcations to -releng		the releng team would like to unify the -devtools and -qa to a new	channel -releng.		looked for all occurences of #wikimedia-qa to add in #wikimedia-releng	as well.		impacts:	* logstash: hopefully the boolean logic is fine	* icinga/shinken: straightforward"	" the list is expanded by the	  template modules/ircecho/templates/default.erb		bug: t86053	change-id: i60bfb8098b6c5e6dbbb6480f73d190a91090e464	|"																																																																																																																																																																																																																																																																																																																																																																
"icinga: ssl cert monitoring for external services		adds a virtual host in icinga to add these ssl cert expiry	checks to that are not associated with one of our nodes via	a role class"	" because they live externally.		this way we can still have monitoring"	" just needs to belong to something	in icinga.		adds a new class to icinga and checks for blog.wikimedia.org and policy.wikimedia.org.	other special cases will follow-up when these work.		bug:t114059	change-id: i7f97dda664aedefc391898308cae74ca5fb33f8a	|"																																																																																																																																																																																																																																																																																																																																																																	
"add icinga monitoring for content on commons		add a virtual host for commons.wm.org to icinga.		add a check that"	 besides the https(!) connection	"	also looks at the content"	" hence check_command	'check_https_url_for_string"" is used which translates to:		command_line    $user1$/check_http -h $arg1$ -i $hostaddress$ -s	                -u $arg2$ -s $arg3$		where -s also makes it use https.		check for ""picture of the day"" on the main page.		this is all re: the explanation what happened on t124812.		@neon:/usr/lib/nagios/plugins# ./check_http -h commons.wikimedia.org	-i 198.35.26.96 -s -u ""/wiki/main_page"" -s ""picture of the day""		http ok: http/1.1 200 ok - 132756 bytes in 0.635 second response time	|time=0.634539s;;;0.000000 size=132756b;;;0		@neon:/usr/lib/nagios/plugins# ./check_http -h commons.wikimedia.org	-i 198.35.26.96 -s -u ""/wiki/main_page"" -s ""picture not of the day""		http critical: http/1.1 200 ok - string 'picture not of the day' not	found on 'https://commons.wikimedia.org:443/wiki/main_page'	- 132756 bytes in 0.634 second response time ...		bug:t124812	change-id: ie03fccb3de2e5827600b5a58a8f7de5870411298	|"																																																																																																																																																																																																																																																																																																																																																																
elasticsearch - check shards via the service	" not via each individual node		checking cluster state on each node is redundant and generate a lot of noise.	cluster wide checks are now done on the service only.		the logstash cluster is left unchanged as it does not have lvs.		the relforge cluster is at the moment left unmonitored. this will be	fixed once a cleanup of the different elasticsearch roles is done (see	https://gerrit.wikimedia.org/r/#/c/304067/).		bug: t133844	change-id: ica721152c10d777003726e80fa03ed82c69c8a10	|"																																																																																																																																																																																																																																																																																																																																																																		
"icinga cleanup: move gsb monitoring to ./monitor/		move the gsb monitoring class to ./monitor/ along with	the other existing classes doing similar stuff.		use the same naming scheme for classes for general cleanup	of the icinga module.		bug:t110893	change-id: i1efa09d01835fb648b191a3ed34f5dbb7ef24425	|"																																																																																																																																																																																																																																																																																																																																																																			
"icinga: check all ores web nodes		bug: t134782	change-id: i99b30d0999f7af124d1a354bd414cb948c70b868	|icinga/ores: add check command definition"	" use nagios_common		bug:t122830	change-id: ib1d08ff2fdfa0a19f651511cb623bcbdd5daab9c	|ores: enhance ores monitoring pt.2		after i8e3509d78ea0bd follow-up by adding trailing slash"	"	so we get a 200 and not a 301 (even though that is also	accepted as ok by default).		also improve the monitoring of the home page by actually	checking for parts of the ""hi! i'm ores. :d"" string on	http://ores.wmflabs.org/ and not just any 200.		bug:t121656	change-id: if437800800c824724609fde06f1ccce702d61382	|ores: move monitoring to icinga		when this was in the ores module itself	the virtual host never got realized on neon/icinga.		moving this into icinga itself and it works.		bug:t119340	change-id: ic7dd3e355322454bb1ae7081da61fc7248e5a851	|"																																																																																																																																																																																																																																																																																																																																																																	
"change path to proxy node requests		bug: t134782	change-id: i5c972cc1ebd8445f7d89db1acbc710b75526429a	|icinga: check all ores web nodes		bug: t134782	change-id: i99b30d0999f7af124d1a354bd414cb948c70b868	|"																																																																																																																																																																																																																																																																																																																																																																			
"tools: stop checking labs puppetmaster via toolschecker		since tools is its own puppetmaster now"	" this will not work	anymore.		bug: t142452	change-id: i01160500e89c61c2ac1157e2702831a6ec98dc12	|toollabs: don't have icinga check for webservice		it is too many things going on at the same time and hard	to be of active use. see bug for replacement options.		bug: t142164	change-id: i6935afd83fef0fb650d4ad9a49d76209d824cd54	|tools: add check for all nodes in ready condition		if they aren't"	" they should've been marked as unschedulable	with the kubectl drain / cordon commands.		bug: t140248	change-id: i93d732a8de62ce2970af94e862ebf936f6a9067d	|tools: add flannel/k8s etcd checks to icinga		bug: t140247	bug: t140246	change-id: i97f748b3d3ca9f502d394c7c449d3e7848111c56	|tools: add icinga check for kubernetes webservice		bug: t131929	change-id: i798bae8d4fb170d0515a4d114cdd3cc1f5caeac1	|icinga: make the tools checks not page temporarily		bug: t136775	change-id: i85980199386898572b82ab199d1005fef956d609	|tools.checker continually watch for webservices		bug: t136162	change-id: ia344ef600060b6783c7248e3b4bf7eeadddbba8b	|"																																																																																																																																																																																																																																																																																																																																																																	
"icinga: provide a check_gsb command and replace old commands		a client for the api to check google's safebrowsing lookup api. it needs	a client_id and an api key and a url as arguments. populate it on the	icinga server and create a check command to use with it. use that	command to replace the current gsb checks		bug: t116099		change-id: iad79713b9b952929b8286674a2c574566cfe310c	|wikitech-static monitoring"	"fix check command setup		it should be named ending in "".cfg.erb"""	" not just .erb.		and additionally config stanza from nagios_common module is needed.		(in the past we edited checkcommands.cfg directly)		bug:t89323	change-id: iddd6713641e5246fd8812750bcf2f83c22142d42	|wikitech-static monitoring"	" install plugin		install the plugin from icinga module and add file	resource to plugins.pp. (like ripe atlas check does it)		bug:t89323	change-id: i1bad2a191c8e426058b04f9f71259b6c4dad13cf	|"																																																																																																																																																																																																																																																																																																																																																																
drac	icinga	"ipmi: do not ensure => latest		some more remaining cases where we ensure ""latest""	with packages.		bug:t115348	change-id: id310d8128459aeb0f8feeb98e3f30a707cc00c71	|icinga: stop using webserver::php5		bug: t118786	change-id: i27924cd38a73e063e709eb48100b9d047ada023b	|icinga: puppetise apache mods		bug: t110893	change-id: i0f9de9df2d82e81a56e7c65765df5d593841535b	|"																																																																																																																																																																																																																																																																																																																																																																	
"iegreview: switch from parsoid to restbase		change the wikitext to html endpoint used from parsoid to restbase.		bug: t114186	change-id: i2101dcd910aa9a4c52ff9322120236dd77d8b0c8	|remove tls bits from internal sites behind cache_misc		all of these services live behind cache_misc"	" which	unconditionally provides and enforces standardized https and hsts.	getting rid of the redundant redirect/hsts code in them makes it	simpler to audit the puppet repo for functional tls-related	configuration on actual directly-public sites with less confusion.		one could make the argument that these role/sites could eventually	be re-used for a direct service"	" but if so the configuration would	be completely different.  what they do today (port 80 vhost with	!xfp->redir"	" +hsts) does not make sense for a directly-public	site"	" which would instead have port 80 vhost with unconditional	redir and a port 443 vhost with +hsts.		bug: t132685	change-id: i01f49496a73dd30c2e7ad42e94390779b82dbe65	|iegreview: use $::parsoid_site		bug: t125673	change-id: i99705e465363ededb204fbc71f4fd2075d39dcd9	|point iegreview to internal parsoid url		bug: t114186	change-id: i6a167eb3e71765dedaa666dbe92aa10d7f021665	|iegreview: require package php5-curl		the application needs php5-curl but it wasn't puppetized.	please don't install package manually"	" please.		php fatal error:  call to undefined function wikimedia\\iegreview\\curl_init()	in /srv/deployment/iegreview/iegreview/src/parsoidclient.php		bug:t105007	change-id: ic6f705cd79e566dad10b557fa5dd6d983f058b21	|iegreview: create module and role for deployment		bug: 71597	rt: 8578	change-id: i69d4a2821db0cc3148963f743fcbdca31208cb9f	|"																																																																																																																																																																																																																																																																																																																																																														
"imagemagick: fix policy.xml path for newer versions		the configuration directory for imagemagick changed to	/etc/imagemagick-6 since imagemagick 8:6.8.5.6-1. adjust accordingly for	debian >= jessie and ubuntu => wily.		bug: t134773	change-id: icb9ded31286371831ad574271716ff8aff6cf958	|"																																																																																																																																																																																																																																																																																																																																																																			
"workaround for mdadm boot-time race condition		the boot-time race condition assembling raid devices reported in t131961	can be avoided by sleeping a few seconds in initramfs-tools' local-top	stage"	" after which the root device is expected to be present.		see faq 26. in /usr/share/doc/mdadm/faq.gz.		this patch introduces a new puppet module called initramfs"	" allowing to	define initramfs hooks and scripts.		bug: t131961	change-id: i12db18dee30c67f98f7dd567e7527d43c134c5a7	|"																																																																																																																																																																																																																																																																																																																																																																	
"workaround for mdadm boot-time race condition		the boot-time race condition assembling raid devices reported in t131961	can be avoided by sleeping a few seconds in initramfs-tools' local-top	stage"	" after which the root device is expected to be present.		see faq 26. in /usr/share/doc/mdadm/faq.gz.		this patch introduces a new puppet module called initramfs"	" allowing to	define initramfs hooks and scripts.		bug: t131961	change-id: i12db18dee30c67f98f7dd567e7527d43c134c5a7	|"																																																																																																																																																																																																																																																																																																																																																																	
"workaround for mdadm boot-time race condition		the boot-time race condition assembling raid devices reported in t131961	can be avoided by sleeping a few seconds in initramfs-tools' local-top	stage"	" after which the root device is expected to be present.		see faq 26. in /usr/share/doc/mdadm/faq.gz.		this patch introduces a new puppet module called initramfs"	" allowing to	define initramfs hooks and scripts.		bug: t131961	change-id: i12db18dee30c67f98f7dd567e7527d43c134c5a7	|"																																																																																																																																																																																																																																																																																																																																																																	
"apt|mirrors|ubuntu: puppetized le certs		bug: t132450	change-id: id656567640081b13cffd14837cd107d1b10f3829	|add dhparam to install web_server		bug: t132450	change-id: i384cb7a89ad8129dce77d06715f500a8448e119b	|refactor install_server web stuff towards ssl config		* makes nginx.conf explicit"	" with ssl params included	* site conf as server_name=apt explicit"	" + default_server		bug: t132450	change-id: i7ac66091125a7a236ad2c7b808ab44d6ad7689d8	|"																																																																																																																																																																																																																																																																																																																																																																	
interface: do not 'ensure latest'	" use require_package		do not let puppet automatically update these fundamental	networking-related packages. while at it"	" use require_package and drop	the singleton classes.		bug: t115348	change-id: ifa690317111326841bca1376cc7e1fcfd08ab639	|"																																																																																																																																																																																																																																																																																																																																																																	
"interface: use allow-hotplug for ::manual and ::tagged		note that ::manual is only used by lvs"	" which is what we're trying	to affect here"	" so the change there is unconditional.  ::tagged is	also used by role::labs::openstack::nova"	" so i've given ::tagged a	hotplug parameter defaulting to true"	" and changed nova.pp to	explicit set that to false to preserve existing behavior there.		this requires some careful manual pre-puppet steps on the lvs	machines themselves (making puppet handle the change automagically	isn't worth the complexity!)"	" and should be a no-op on the	affected nova role.		bug: t110530	change-id: i574068c9ece38b37e3c67abc333b24435415ee8e	|"																																																																																																																																																																																																																																																																																																																																																														
"interface: use allow-hotplug for ::manual and ::tagged		note that ::manual is only used by lvs"	" which is what we're trying	to affect here"	" so the change there is unconditional.  ::tagged is	also used by role::labs::openstack::nova"	" so i've given ::tagged a	hotplug parameter defaulting to true"	" and changed nova.pp to	explicit set that to false to preserve existing behavior there.		this requires some careful manual pre-puppet steps on the lvs	machines themselves (making puppet handle the change automagically	isn't worth the complexity!)"	" and should be a no-op on the	affected nova role.		bug: t110530	change-id: i574068c9ece38b37e3c67abc333b24435415ee8e	|interface: do not 'ensure latest'"	" use require_package		do not let puppet automatically update these fundamental	networking-related packages. while at it"	" use require_package and drop	the singleton classes.		bug: t115348	change-id: ifa690317111326841bca1376cc7e1fcfd08ab639	|interface:  dequote booleans		bug: t113783	change-id: if09e398387473e5430f54373bd62b0454a703172	|"																																																																																																																																																																																																																																																																																																																																																												
"interface:  dequote booleans		bug: t113783	change-id: if09e398387473e5430f54373bd62b0454a703172	|"																																																																																																																																																																																																																																																																																																																																																																			
drac	icinga	"ipmi: do not ensure => latest		some more remaining cases where we ensure ""latest""	with packages.		bug:t115348	change-id: id310d8128459aeb0f8feeb98e3f30a707cc00c71	|"																																																																																																																																																																																																																																																																																																																																																																	
"ircecho: move all files into repo		it is two files"	" and having a debian repo for it does not	make too much sense. it also makes changes to it hard and	thus less people make changes to it.		bug: t95038	change-id: ie69bd1118f2fcff3fb55bc022c46bf89e3266a9c	|"																																																																																																																																																																																																																																																																																																																																																																		
"fix duplicate package[gdb] declaration		not using ensure_packages since standard-packages prefers latest. so	that on nodes not using java::tools"	" it will still keep that behaviour.		bug: t94917	change-id: ifd1e6b90683ad3aee73f7757a533e96815fa4925	|"																																																																																																																																																																																																																																																																																																																																																																		
"contint: graphviz on jenkins slaves		we are going to generate documentation using doxygen which can generate	graphs using 'dot' provided by the graphviz package.		graphviz is a pre-existing dependency for the jenkins master gallium	which is also a slave. to avoid duplicate definition"	" make use of	the new require_package().		bug: 72454	change-id: iab7b1288478f1534fd3e34f7e486656d88129ec1	|jenkins: logrotate access.log		jenkins does not automatically logrotate its access log. one has to rely	on logrotate to do so.  the debian package provided by upstream does not	include the script so i just copy pasted it and amended the filename to	match our own configuration.		a bug got filled upstream to have the logrotate script included in	debian package:	https://issues.jenkins-ci.org/browse/jenkins-18870		daily explicitly set	rotate and maxage set to 30		change-id: iee3495be6ebf812478da83470053512d1fc0587a	|"																																																																																																																																																																																																																																																																																																																																																																		
"jenkins: transition to ssh::userkey		bug: t92475	change-id: i240282cb4c065ace16877fdd4124496c46223e03	|contint: puppet class to setup browsertests slaves		we are going to run web browser tests against visualeditor in labs	instances.  the new role::ci::slave::browsertests class provides:		* dependencies for the jenkins slave agent. currently that is just the	  openjdk-7-jre-headless package.  i have split it up from the	  role::ci::slave class which is production specific.	* a home dir on /mnt/jenkins-workspace to avoid glusterfs and use	  /dev/vdb where all the disk space is.	* dependencies needed to install qa/browsertests.git which is a ruby	* application providing its own list of gems.	* a localhost vhost listening on 127.0.0.1:9413 and bound to the labs	  directory mnt/localhost-browsertests which has plenty of space.		note that labs provides a jenkins-deploy user"	" so we do not have to set	up that user like we are doing in role::ci::slave.		bug: 54385	change-id: i35f3a9b738fc8f1c594674e63d21e545eca77000	|"																																																																																																																																																																																																																																																																																																																																																																		
"install arc on the jenkins slaves.		this is needed for phabricator (harbormaster) testing and integration		bug: t103127		change-id: id9bcbd3aa7bb13f4a4afe34e4b2754761f67b279	|contint: puppet class to setup browsertests slaves		we are going to run web browser tests against visualeditor in labs	instances.  the new role::ci::slave::browsertests class provides:		* dependencies for the jenkins slave agent. currently that is just the	  openjdk-7-jre-headless package.  i have split it up from the	  role::ci::slave class which is production specific.	* a home dir on /mnt/jenkins-workspace to avoid glusterfs and use	  /dev/vdb where all the disk space is.	* dependencies needed to install qa/browsertests.git which is a ruby	* application providing its own list of gems.	* a localhost vhost listening on 127.0.0.1:9413 and bound to the labs	  directory mnt/localhost-browsertests which has plenty of space.		note that labs provides a jenkins-deploy user"	" so we do not have to set	up that user like we are doing in role::ci::slave.		bug: 54385	change-id: i35f3a9b738fc8f1c594674e63d21e545eca77000	|"																																																																																																																																																																																																																																																																																																																																																																		
"tools: use provisioned cert instead of puppet cert		bug: t139461	change-id: i52f9b35dbf6b5a6d503c619ada3d1157ed13ca61	|tools: provision accounts for all tools		maintain-kubeusers does the following:		1. generate accounts for all tools	2. generate abac file granting appropriate access	   to all tools	3. read up infrastructure user config from a different	   file and make sure they are present in final token auth	   file list	4. restart kube-apiserver if needed		this needs to run as root since we're writing to many differnt	users' homedirs"	" so we attempt to limit the damage by whitelisting	capabilities and making most filesystem paths be readonly		bug: t133999	change-id: i7a7a3dd951db2209e820752c4d14d77eb836b929	|tools: enable hostpathenforcer admission controller		bug: t112718	change-id: ieb33db64277748be6dee875ace4d77527d08dfd3	|tools: enable host automounts		bug: t134748	change-id: ie5537263629d421a889c24fc37c3c8b182603c69	|tools: enable the registry enforcer		bug: t133515	change-id: i8127e5e6e25b69e78d109c7e5ebb3183eb7ba4ae	|k8s: stop using packages for master components		bug: t130972	change-id: i991788d274c0c32ad233aa9d799fe760716b9d23	|"																																																																																																																																																																																																																																																																																																																																																																		
"k8s: stop using packages for master components		bug: t130972	change-id: i991788d274c0c32ad233aa9d799fe760716b9d23	|"																																																																																																																																																																																																																																																																																																																																																																			
"apt: enable backports on debian systems		this enables backports across the fleet and relies on the default debian	policy for the apt priority for the repository (i.e.	notautomatic/butautomaticupgrades).		suffice to say"	 packages from jessie-backports should be used with care	"	as they may change to a newer version at any point.		bug: t107507	change-id: i8dceea1e42f33056133d3a1315bc32dd8b78dcb8	|"																																																																																																																																																																																																																																																																																																																																																																	
"tools: fixup k8s bastion role		- adds a simple script to deploy appropriate binaries	- adds flannel + kube-proxy for access to pod/svc ips	- installs kubectl for use by everyone		bug: t136413	change-id: i3b106fe670a1e4f6a0a23a978b50ed211e85f31b	|"																																																																																																																																																																																																																																																																																																																																																																			
"tools: provision accounts for all tools		maintain-kubeusers does the following:		1. generate accounts for all tools	2. generate abac file granting appropriate access	   to all tools	3. read up infrastructure user config from a different	   file and make sure they are present in final token auth	   file list	4. restart kube-apiserver if needed		this needs to run as root since we're writing to many differnt	users' homedirs"	" so we attempt to limit the damage by whitelisting	capabilities and making most filesystem paths be readonly		bug: t133999	change-id: i7a7a3dd951db2209e820752c4d14d77eb836b929	|"																																																																																																																																																																																																																																																																																																																																																																		
"k8s: decouple kubelet from kube-proxy		only kubelet requires the private certificates"	" but we can't	just put that in there since kube-proxy requires the public	certificates. we'll eventually fix this by getting rid of	the k8s::ssl class"	" but until then....		bug: t136413	change-id: id24eb002d876c0a857c223add8832bc48aa5e6a5	|k8s: allow pod infra image to be overriden with hiera		bug: t133873	change-id: if5a007ad180b0b700f9763824d937ff68ac995c6	|k8s: stop using packages for k8s workers		bug: t130972	change-id: i73ce331234363e574eadbf8d9c5fc4864743e7ce	|"																																																																																																																																																																																																																																																																																																																																																																	
"tools: fixup k8s bastion role		- adds a simple script to deploy appropriate binaries	- adds flannel + kube-proxy for access to pod/svc ips	- installs kubectl for use by everyone		bug: t136413	change-id: i3b106fe670a1e4f6a0a23a978b50ed211e85f31b	|k8s: decouple kubelet from kube-proxy		only kubelet requires the private certificates"	" but we can't	just put that in there since kube-proxy requires the public	certificates. we'll eventually fix this by getting rid of	the k8s::ssl class"	" but until then....		bug: t136413	change-id: id24eb002d876c0a857c223add8832bc48aa5e6a5	|k8s: stop using packages for k8s workers		bug: t130972	change-id: i73ce331234363e574eadbf8d9c5fc4864743e7ce	|"																																																																																																																																																																																																																																																																																																																																																																	
"k8s: stop using packages for master components		bug: t130972	change-id: i991788d274c0c32ad233aa9d799fe760716b9d23	|"																																																																																																																																																																																																																																																																																																																																																																			
"maps: added list of cassandra servers		exposing variables with the list of cassandra servers allows to reduce	dulication of configuration.		bug: t138092	change-id: i4482702c216a1b3f80c9b01f9a6eee1f3dbf5369	|team-interactive receives maps alerts		adding team-interactive to the following alerts:		* service check on kartotherian	* service check on tilerator	* service check on tileratorui	* lvs check on kartotherian service		bug: t137869	bug: t137851	change-id: i02fca2da8ac90366d6be1c67d1e985c1b2c46228	|enable kartotherian service check for all maps servers		now that specs have been properly tested"	" we can enable them for all maps	servers.		bug: t137617	change-id: i3b61be2311a9e3506d6b386c97e56026eee3be8f	|enable 'has_spec' on kartotherian service.		spec has been written and deployed for kartotherian. we now need to use it.	to not spam everyone while testing"	" this is disabled on all servers except	maps2001. this will need to be cleaned once we confirm that all works	correctly.		bug: t137617	change-id: ibbd69c672b477d7d71326f12fb181c2201d39ab9	|scap3 config for kartotherian		bug: t129150	change-id: i12a08831cfc07280f2021adedb00262b5e81686e	depends-on: ie2a956c5d14f068771f4cfbb0e673008870012cb	|specific configuration for new maps cluster.		for the transition"	" we need to keep specific configurations. this will go	back to only one config once maps-test cluster is decomissionned.		bug: t134901	change-id: i6244968574b084f6226403be9c4727ca39977cd6	|maps: add usernames/passwords to kartotherian config		in order for the kartotherian service to connect to db & cassandra	provide it with the passwords in the generated service config.		bug: t108610	change-id: ib18328e86f15ddf5505bcb0b443b02f63c5b95b8	|"																																																																																																																																																																																																																																																																																																																																																																
"keyholder key cleanup		* clean up the mess that is scap::target and keyholder::agent	* make ssh_agent_proxy look up keys by name instead of fingerprint	** this avoids needing to store fingerprints in puppet manifests	* password-protected key test is now optional and skipped on beta		bug: t132747		change-id: id298a3e0f12e31afd7ea83970e192330ffbd4243	|hieraize keyholder::agent configuration		move keyholder::agent configuration to hiera to simplify keyholder	configuration. proliferation of *::deploy::source classes is messy	and complicates the already too complex process of adding a new	service group/key to the deployment masters.		bug: t130419	change-id: id5002cc9449deb0223f27af67a30a86c6187bfd9	|add a deployment source & target class for phabricator		this also adds support for key_content => secret('...') in	keyholder so that we can use a newer/cleaner pattern for	specifying the private key.		refs t125851		bug: t114363	change-id: i06eee23c338840fbba8ca81270f5ec0c81e02869	|use aqs-admins group for aqs deployment via deploy-service user		- add aqs-admins to tin	- allow aqs-admins to access deploy-service scap ssh key in keyholder		bug: t127720 t126294	change-id: i92a510496118dfdbfde5317d1a1eac58de4a328a	|reload keyholder-agent on keyholder-auth change		currently"	" if puppet adds a new key and a corresponding new	keyholder-auth.d yaml file to go with it this requires an root to run:		keyholder restart	keyholder arm		this change should ensure that only a `keyholder arm` is needed since it	will reload the keyholder permissions if a permission file has changed.		bug: t125992	change-id: ic9803696768fb8fa83d8e4ebad85119194c71c14	|"																																																																																																																																																																																																																																																																																																																																																																		
"keyholder-proxy/agent: convert to base::service_unit		convert upstart-specific service units to the more generic	base::service_unit. this allows us to add systemd units in	a followup patch (which are then automatically used if	role::deployment::server is used with jessie).		bug: t144043		change-id: i45c7e47623efb8e0462dc061157a5b30a8b73d76	|keyholder key cleanup		* clean up the mess that is scap::target and keyholder::agent	* make ssh_agent_proxy look up keys by name instead of fingerprint	** this avoids needing to store fingerprints in puppet manifests	* password-protected key test is now optional and skipped on beta		bug: t132747		change-id: id298a3e0f12e31afd7ea83970e192330ffbd4243	|keyholder/eventlogging: replace utf-8 chars		2 more occurences of utf-8 chars in *.pp files and then	that's all. replacing them because of t91453		zeromq is a redirect to mq on wikipedia as well. :p		bug:t91453	change-id: i59e95c76520159bcfaac6a6d371f7e8d9b1ada6f	|"																																																																																																																																																																																																																																																																																																																																																																			
"deployment-prep: keyholder shinken monitoring		bug: t111064	change-id: iee4486128d0daa6ae5c7672ebeeefc3b9fc2dbb0	|"																																																																																																																																																																																																																																																																																																																																																																			
for cert names	" use the fqdn instead of the ec2id.		this is safe now because fqdn includes project name"	" hence unique.		bug t95480		change-id: ifb387bffcb23c8fa9dcfba3fb602b2c97d8cb263	|"																																																																																																																																																																																																																																																																																																																																																																	
"move labs/designate/pdns to ns2.wmflabs.org		this is going to coexist with the ldap pdns implementation for a while"	"	so it needs its own name.		fixed monitoring"	" accordingly.		bug:  t93053	change-id: i579198b82931b223b6ccad8f45568bc6e0202819	|"																																																																																																																																																																																																																																																																																																																																																																	
"labs_lvm: only run extend-instance-vol when needed		currently"	" labs_lvm::volume calls extend-instance-vol in each puppet	run"	" making logs unnecessarily noisy.  this change runs	extend-instance-vol only if it would not be a no-op.		it does this by depending the call on that ""extend-instance-vol --test	$mountat $size"" does /not/ succeed and building that logic into	extend-instance-vol"	" i. e. if ""extend-instance-vol $mountat $size""	would fail because one of its tests fails"	" it is run (to not hide the	error from the user)"	" and only if all the tests succeed and lvextend	would fail because the volume is already of the intended size"	"	""extend-instance-vol --test"" succeeds"	" thus /not/ running the non-test	extend-instance-vol.		ideally"	" this whole cascade of shell scripts and defined types would	be replaced by a custom puppet type in ruby that could be written more	straightforward"	" but ceterum censeo changing file systems inside a	running system is bad and should be done at the openstack level	instead.		bug: t109933	change-id: ie58720d12a8e94d1c5b6a71aa71160e3f499cabc	|"																																																																																																																																																																																																																																																																																																																																																										
"labs_lvm: require parted explicitly		parted is installed on instances by default as a dependency for	ubuntu-standard.  however"	" labs_lvm's dependence on it was not	explicitly stated"	 so project administrators could uninstall it	"	making subsequent uses of labs_lvm fail.		this change explicitly states the dependency on the parted package.		bug: t112641	change-id: i501aad1a9ba48ebd433369fca7fe4a1eb80bd56a	|"																																																																																																																																																																																																																																																																																																																																																																
"labs_lvm: mount swap partition so it sticks		otherwise you end up not mounting it at boot by default		bug: t95979	change-id: ic1beae6c45e720a9139787837fadc01e3452542e	|tools: create consistent 3x ram swap on all exec nodes		also introduce labs_lvm::swap define		bug: t95979	change-id: i39d7a6ddb80ce44c9129263ab6f7ae6f6329c5ef	|"																																																																																																																																																																																																																																																																																																																																																																			
"support eqiad labs secondary disk		use the labs_lvm::volume class to mount varnish cache disk for labs	instances. mount it as xfs to solve bug 46359		bug: 46359	change-id: i52403cd1e32770d3c41c930dd6c836b0637e7a08	|"																																																																																																																																																																																																																																																																																																																																																																			
"rearrange handling of the 'vagrant' user for labs vagrant.		since we have a 'vagrant' user in ldap"	" trying to create a local	user causes some conflict.  just adding the homedir and sudo rule	seems to work fine.		bug: 63793	change-id: i52a207a81119f7e79f65113f272a2b67fe24e0fe	|labs_vagrant: allow wikidev group to sudo as vagrant		grant the wikidev (and svn) groups sudoer rights as the vagrant user.	this allows easier management of mediawiki-vagrant controlled content.		bug: 61397	change-id: i577f219bc6a187e02de755cb96269a80e45352d6	|change home directory of vagrant user		the labsvagrant module tries to create a new directory	at the systems default home.	vagrant uses hard links to /home/vagrant.	this change ensures that the vagrant user home is set to	/home/vagrant.		bug: 62470	change-id: i08b16b7c18a6ebffa551b7f62282378cbd5b79a6	|"																																																																																																																																																																																																																																																																																																																																																																		
"override default cloud.cfg with a custom file.		this is only slightly changed from the default --	we don't include the default user"	" and we exclude	the ssh-import-id module even though it isn't used	because... it shouldn't be used.		bug: t94866	change-id: i5facb99ab5df571674e5267d02cb3e31c54b3444	|for cert names"	" use the fqdn instead of the ec2id.		this is safe now because fqdn includes project name"	" hence unique.		bug t95480		change-id: ifb387bffcb23c8fa9dcfba3fb602b2c97d8cb263	|labs_vmbuilder: resource attributes quoting		bug: t91908	change-id: icab204a958f12acb8974e57ec37eb1cd0c58d004	|add firstboot script and ubuntu-standard package		this change adds the ubuntu-standard package for bug 54080 and	also adds the firstboot script that will be called on initial	instance boot.		change-id: if28081eb19917281caf5f8eec085ccec95253b2f	|"																																																																																																																																																																																																																																																																																																																																																																
"have labspuppetbackend listen on an external ip rather than 127.0.0.1		i need to contact this api from elsewhere.		bug: 294510	change-id: i0a854f6ff0ad8114b564bafdbe266c8adca0ec4d	|move labspuppetbackend to port 8100; open firewall		previously this was 8080 which is used for a surprisingly	large number of other things.		bug: t133412	change-id: ie3b4c2a9659e05fb15d567ebdaaa3bee83052569	|mysql backend for storing roles / hiera data for labs		todo:	  - more error validation	  - a name that is clearer	  - icinga checks		bug: t133412	change-id: i49fd45c47e5f756a77b3429a6e5a671e328285d2	|"																																																																																																																																																																																																																																																																																																																																																																			
"switch everything to the new openldap ldap servers.		bug: t101299	change-id: i5d5b20ac2ba857df12f448ba4060d50fcf077ba6	|labstore: use hiera to set currently active labstore		primarily tries to not run services that should be run	only in one host across multiple ones. the active host is	set by the active_labstore_host hiera key to the currently	active host's hostname.		note that puppet doesn't run simultaneously"	" so this is	a neat hack but not to be solely relied upon as a means	of 'make sure this is running in only one host'. it	primarily helps keep error spam down		bug: t106590	change-id: i3d12b96d75afdbe0cff7ab563cdcc55e910c3ca2	|"																																																																																																																																																																																																																																																																																																																																																																		
"labstore: drbd framework for software based ha		bug: t126083	change-id: i42048e317b30c9f1a0dcfffef0391417b8cda967	|"																																																																																																																																																																																																																																																																																																																																																																			
"labstore: drbd framework for software based ha		bug: t126083	change-id: i42048e317b30c9f1a0dcfffef0391417b8cda967	|"																																																																																																																																																																																																																																																																																																																																																																			
"labstore: run the cleanup script every day		bug: t109954	change-id: ie0ded32d134541ff77468f0621cf2fbdfd1f678c	|add cleanup-snapshots script		this script cleans up snapshots in the specified volume	group <vg> by discarding:		(a) snapshots that are over 80% full; and	(b) enough snapshots"	 oldest first	" so that there	    is at least <space> terabytes of allocatable space	    in the volume group.		bug: t106474	change-id: i098a9081b5c629a5fddcc268a1f6b98fcd08509f	|"																																																																																																																																																																																																																																																																																																																																																																	
"labstore:  run nfs-exports-daemon on all servers in a cluster		* run where module is applied regardless of active statu	so that any secondary has a good copy of the data	* move monitoring definitions to the role	* run on secondary cluster (coming soon 1004/1005)		bug: t126083		change-id: ie299dc5069d3db47d1e8b05a4ce5c043a40207cf	|labstore: use hiera to set currently active labstore		primarily tries to not run services that should be run	only in one host across multiple ones. the active host is	set by the active_labstore_host hiera key to the currently	active host's hostname.		note that puppet doesn't run simultaneously"	" so this is	a neat hack but not to be solely relied upon as a means	of 'make sure this is running in only one host'. it	primarily helps keep error spam down		bug: t106590	change-id: i3d12b96d75afdbe0cff7ab563cdcc55e910c3ca2	|"																																																																																																																																																																																																																																																																																																																																																																		
"labstore: add timers for backups		bug: t106474	change-id: ie10622ba825f620240be654798dda763a68129b7	|"																																																																																																																																																																																																																																																																																																																																																																			
"labstore secondary role cleanup and remove 00[12] specifics		bug: t126083	change-id: ia1ce37c6de42d21a9d2aea284203c5ff7d92aa90	|match class assignment to file for labstore::fileserver::secondary		bug: t126083	change-id: i6846f257c6d6330303049f951cb0c229400f4dbe	|introduce fileserver::secondary role		this is going to be a transition from the existing	labstore1001 which is currently ""primary"".  for now	the new cluster will be secondary until we transition	to it as primary to revise the current setup.		bug: t126083		change-id: iedef8c1d1324ae127e78e9034a8f30ed4a661375	|"																																																																																																																																																																																																																																																																																																																																																																			
"labstore: more puppetization fixes for labstore*		this simply reflects the current status and does not bring in	new configuration.		root.exports and public.exports are the base (common to all	of labs) nfs export configuration on which the manage daemon	build.		nfs-common and nfs-kernel-server are the nfs daemon config	files that live in /etc/default and set the necessary run-time	options (ports"	 which daemons to use	" and server group	management).		bug: t102478	change-id: i28d2f35f0f54853ccab01350922411828de967a2	|make labstore configuration into a module		this moves the labstore configuration away from the openstack	module (where"	 arguably	" it never belonged) into its own module.		currently"	" this does not cover gaps in configuration (more changesets	are coming for that) and simply moves manifests and files around	to their proper location and renames a few things.		it is intended that the actual effect of this change to	the manifests is a noop; none of the running configuration should	be changing.		bug: t93781	change-id: iddb77e6d54ad3b2743e7cb35e864e1467f85baec	|"																																																																																																																																																																																																																																																																																																																																																														
"labstore: nfs-exportd monitoring into a manifest		bugs: t126083	change-id: i2162860119d723fbe968f3ca9f257214f66f655b	|"																																																																																																																																																																																																																																																																																																																																																																			
"labs: allow explicitly specifying lookupcache via hiera		bug: t139769	change-id: i9458334ff21f5646ff1ade2f5885e16966f6bad4	|"																																																																																																																																																																																																																																																																																																																																																																			
"add a new security module with ::pam and ::access		this helps clean up security configuration mostly in labs right	now"	" but provides general-use classes and defines to customize	pam configuration cleanly (including access.conf handling)		bug: t120106	change-id: id0183e2bc677c6d4893aeb2956c3e3650b174da6	|"																																																																																																																																																																																																																																																																																																																																																																		
"nscld changes need to restart nscd as well		bug: t131541	change-id: i1f331a196e8929c9847a1cd98133409d06f4a86d	|nslcd specifying shell override		originally looked at in 223828 but	we already specify in nslcd.conf which seems to take	precedence so moving the override to match		bug: t131541	change-id: i2c5967d51dcb73898725b9943d850ab3fcba008d	|fix nsswitch_use_default to a string		hiera() returns strings unconditionally so comparisons to true	fails.  because it would be extra confusing if we compared to 'true'	we switch the required value to 'yes' instead.		bug: t87870	change-id: iad63049f8ccfab1a1c2c68b1daceb90b1ed67844	|labs: have fileservers no longer nsswitch to ldap		this adds a minor tweak to ldap::manifests::client so that a	hiera value can force the system nsswitch.conf to be the distro	default (rather than ours which adds the ldap source); and	sets that variable to true for the labstores.		bug: t87870	change-id: i76d7365e54c63f0668ebda4d7f9a252043be4438	|"																																																																																																																																																																																																																																																																																																																																																																			
"add a new security module with ::pam and ::access		this helps clean up security configuration mostly in labs right	now"	" but provides general-use classes and defines to customize	pam configuration cleanly (including access.conf handling)		bug: t120106	change-id: id0183e2bc677c6d4893aeb2956c3e3650b174da6	|"																																																																																																																																																																																																																																																																																																																																																																		
"ldap: vastly simplify modify-ldap-group		i'll follow this up with actual documentation on how to do	common ldap changes!		this is also maintained upstream code"	" and also has the	advantage of making you notice that our ldap groups are	super cluttered with people whose access we never remove.		bug: t114063	change-id: iad66cf8c1be0d970c94630ed53371e4bc68c9647	|ldap: remove unused homedirectorymanager		probably back from tampa days?		bug: t114063	change-id: i66eef55481dfc5f62835274761c5fd8fc3aabcda	|ldap: drastically simplify modify-ldap-user		much more comprehensive"	" simpler and upstreamed code		bug: t114063	change-id: i9da66cc15acc83074bd9e63986e02049194fe9c7	|ldap: replace change-ldap-password with reset-ldap-password		bug: t114063	change-id: if32be1f4dbf4e5c235f7e82004a835135f2c6583	|ldap: kill a bunch of unused scripts		- you create ldap users with wikitech now	- i don't think we use netgroups at all	- deleting ldap groups / users is super rare"	" use ldapvi		bug: t114063	change-id: ib72c27072eba202a3200170a83e2f093f2afe6e7	|ldap: set home for the ldap lookup user		since otherwise python tries to look in:		stat(""/home/ssh-key-ldap-lookup/.local/lib/python2.7/site-packages"")		for packages"	" and when nfs is dead this gets stuck		bug: t104327	change-id: i6571ab7eaf24679b91b8e26f413942289faacb75	|"																																																																																																																																																																																																																																																																																																																																																															
"ldap: vastly simplify modify-ldap-group		i'll follow this up with actual documentation on how to do	common ldap changes!		this is also maintained upstream code"	" and also has the	advantage of making you notice that our ldap groups are	super cluttered with people whose access we never remove.		bug: t114063	change-id: iad66cf8c1be0d970c94630ed53371e4bc68c9647	|ldap: drastically simplify modify-ldap-user		much more comprehensive"	" simpler and upstreamed code		bug: t114063	change-id: i9da66cc15acc83074bd9e63986e02049194fe9c7	|ldap: replace change-ldap-password with reset-ldap-password		bug: t114063	change-id: if32be1f4dbf4e5c235f7e82004a835135f2c6583	|"																																																																																																																																																																																																																																																																																																																																																																	
"ldap::role::client::labs:  allow restricted_from and _to from hiera		bug: t101447	change-id: i1fe7f1dd89f08206f3f11d72d21c9f3e2f45ddf4	|labs: widen access.conf exception to everything local		commit ad2874ee9cc74585a1f685e836852e5c3ab26676 added an access.conf	exception for cron"	" that was broken since the latest round of pam	reorganization.		the commit message for the above mentioned that ""[t]his will fix cron"	"	but of course there is still a possibility we'll see effects of our	access.conf configuration elsewhere (e.g. if we were using atd)"".	unfortunately that turned to be the case"	" with at least ""su"" known to be	broken.		instead of playing whack-a-mole with various different commands"	" use	pam_access' local directive to allow everything locally-originated on	the system. this should fix all of the effects we're seeing"	" while at	the same time giving us the necessary protection we require for ssh.		bug: t121765	change-id: id741e12d5cafed0a91710bd22ecff3b89c59e994	|add a new security module with ::pam and ::access		this helps clean up security configuration mostly in labs right	now"	" but provides general-use classes and defines to customize	pam configuration cleanly (including access.conf handling)		bug: t120106	change-id: id0183e2bc677c6d4893aeb2956c3e3650b174da6	|"																																																																																																																																																																																																																																																																																																																																																													
"le: add apache config/example		bug: t132812	change-id: i6d55bb5054fffbe4000b2e85e001351a6e43adaf	|le: fix ""creates"" path on first exec		fixing this keeps the first exec from re-running all the time	pointlessly (not that it hurts anything"	" just efficiency).		bug: t132812	change-id: ibae3d2ce4c9809e56a976974135ad6e961a39a34	|letsencrypt module guts + acme-setup script		bug: t132812	change-id: i08c0c87516533fd334d1ae3e1f0282b907369f9a	|"																																																																																																																																																																																																																																																																																																																																																																		
"le: actually deploy the challenge-apache.conf file		bugfix for 8675fdbb2"	" which added the file itself but did not	deploy it to hosts.		change-id: i2a4afc860b372fcfe56beaa7129dc0bdb7b8ba02	|le: include rather than require sslcert		bugfix for a0f8c9976"	" otherwise we get an internal dependency loop	within the sslcert module by doing a require and then invoking	sslcert::ca :p		bug: t132812	change-id: ice6d2ffbae397d5e3d594e82c0848087c27fe4d4	|letsencrypt module guts + acme-setup script		bug: t132812	change-id: i08c0c87516533fd334d1ae3e1f0282b907369f9a	|create letsencrypt module"	" install acme-tiny		one very first step for t132812"	" create module	letsencrypt and let it install acme-tiny"	"	taken from current master on github.		bug:t132812	change-id: i7f68efb798858f29cf09d312b0c01dea99d0c992	|"																																																																																																																																																																																																																																																																																																																																																														
"add hsts=1y to several one-off public services		this adds hsts=1y headers to the following services:		archiva.wikimedia.org	dumps.wikimedia.org	ganglia.wikimedia.org	librenms.wikimedia.org	rcstream.wikimedia.org		note this does not imply any redirects"	" or force a client which is	not https-capable to use https.  what it accomplishes is that if	an hsts-honoring user agent successfully reaches the service over	https once"	" the sts header will lock their future access from that	client onto https going forward.		bug: t132521	change-id: idb40ad1bfc5db93989713a68d1bf3eef2e8c4843	|librenms: move to apache::site		also move the website from role class to its own class		bug: t118786	change-id: ib40c2c89dfb9e5d8e1af07f7931956f50af65e6d	|"																																																																																																																																																																																																																																																																																																																																																																	
"logrotate: convert nginx to logrotate::conf		bug: t127025	change-id: i66a67d6d0bac58eeb20d028a8d6a2121602a92e8	|logrotate: add centralized define"	" apply to pybal		to avoid inconsistencies"	" a centralized logrotate::conf is created and	for now applied to pybal logrotate rule"	" which needed fixing and is	relatively not risky.		bug: t127025	change-id: i24c3e62caa8d09cba68424c4401e212bd1bc7bf6	|"																																																																																																																																																																																																																																																																																																																																																																
"add systemd unit for logstash		bug: t126677	change-id: i0f5854d9e9b5adfa82f5c4c0778b3875f58418b7	|logstash: jessie support and beta cluster cluster		* tweak service rules to work on jessie (sysv init vs systemd)	* add a second host to the beta cluster logstash cluster		bug: t101541	change-id: i293f35c07d83c5b0a833bf3a7fbcdf302ad96abf	|logstash: remove upstart jobs		the logstash packages produced by logstash.net include both system	v init scripts and upstart jobs for the logstash services. since we	specify `provider => 'debian'` we are telling puppet to prefer to	execute the system v scripts. this is in conflict with the default	behavior of `service logstash start` which will prefer to execute the	upstart scripts. this leads to duplicate service execution on servers	where an administrator has manually started the service.		bug: 72202	change-id: id6b9101e594d051098fa66c66e3c10d69d494588	|"																																																																																																																																																																																																																																																																																																																																																																			
"ferm rules for logstash log ingestion		bug: t104964	change-id: i92fc0ca397d77a791271b2d1074b12eadc0ba91d	|"																																																																																																																																																																																																																																																																																																																																																																			
"consume eventlogging validation logs from logstash		add a new ::role::logstash::eventlogging class that can be used to	configure a logstash server to consume eventlogging error events from	a kafka topic.		bug: t113627	change-id: i4d8ddc877d146fef3fbde850c53bc97e90ebe21a	|"																																																																																																																																																																																																																																																																																																																																																																			
"logstash: enable log4j provider		bug: t141324	change-id: iae69c1909d7bfb22161ba80b53267ce5395cdb78	|"																																																																																																																																																																																																																																																																																																																																																																			
"ferm rules for logstash log ingestion		bug: t104964	change-id: i92fc0ca397d77a791271b2d1074b12eadc0ba91d	|"																																																																																																																																																																																																																																																																																																																																																																			
"allow puppetmaster to send reports to logstash		add a puppet report handler for sending data to logstash. each report is	converted to a single log event which is sent as newline delimited json	to logstash over a tcp transport.		on the logstash side"	" the event's ""host"" field is fixed to contain the	hostname of the puppet agent that originated the report rather than the	ip address of the puppetmaster and tags for indexing in elasticsearch.		this results in the full diff of the puppet run being stored in	logstash. as such"	" care should be taken in ensuring that the target	logstash cluster is properly secured for types of sensitive data that	this may reveal.		bug: 60690	change-id: i604582a7faf902ba899985ca7127b95de1fa9b20	|"																																																																																																																																																																																																																																																																																																																																																																	
"logstash: new input for msgpack over udp		msgpack is a binary serialization format (<http://msgpack.org/>). it can	be used to exchange json like data between systems/languages. uwsgi	includes some nice instructions for logging to a logstash cluster with	msgpack encoded messages:	http://uwsgi-docs.readthedocs.io/en/latest/logencoders.html#the-msgpack-encoder		bug: t143172	change-id: i4d6d912e7d6d77e7cbfa276ad4b7e0c693d920c0	|add ferm rules for new logstash ingestion module logstash::input::udp		bug: t104964	change-id: ic1b73d42e87b36e4f9a73e5a40ea4622da970f90	|cassandra logstash setup		- sets up a logstash udp input that uses the json codec on port 11514	- deploys logstash-logback-encoder artifacts on cassandra hosts	- configures cassandra to use udp appender		bug: t100970	change-id: idc5cfc8c5b53e8dac88dbed9e506eee79568903e	|"																																																																																																																																																																																																																																																																																																																																																																			
"ferm rules for logstash log ingestion		bug: t104964	change-id: i92fc0ca397d77a791271b2d1074b12eadc0ba91d	|"																																																																																																																																																																																																																																																																																																																																																																			
"elasticsearch - disable cron to clear elasticsearch caches		this cron was put in place for an older elasticsearch version"	" where it	helped reduce gc pauses. we need to validate if it is still needed.		collection of additional metrics is also enabled to give visibility on	the impact of that change.		this change will be rolled back if we see an increase in gc pauses.		bug: t144396	change-id: i6b9136352e87b79efaf57816a94ddb7b33160e2c	|logstash:  fixed a quoted boolean in a code comment.		bug: t113783	change-id: i525b84a2f49853932f159cfc155188ae2425237a	|"																																																																																																																																																																																																																																																																																																																																																																		
"elasticsearch - disable cron to clear elasticsearch caches		this cron was put in place for an older elasticsearch version"	" where it	helped reduce gc pauses. we need to validate if it is still needed.		collection of additional metrics is also enabled to give visibility on	the impact of that change.		this change will be rolled back if we see an increase in gc pauses.		bug: t144396	change-id: i6b9136352e87b79efaf57816a94ddb7b33160e2c	|"																																																																																																																																																																																																																																																																																																																																																																		
"logstash: count mediawiki log events with statsd		count each mediawiki logstash event by sending an increment command for	the counter ""logstash.rate.mediawiki.$channel.$level"" (eg	""logstash.rate.mediawiki.memcached.error"") to a statsd server.		bug: t100735	change-id: i4771abef68a151d08340b63f95cc556c8010416d	|"																																																																																																																																																																																																																																																																																																																																																																			
"lshell scaffolding for restricting labs users		bug: t102395	change-id: iece9c2fb54a9376e6d59ddcb4bc120f29d4efc58	|"																																																																																																																																																																																																																																																																																																																																																																			
"lvs: fix optional parameter listed before required parameter		bug: t93645	change-id: ie946603eee038ac642501cdf559a75c0cb70b9c8	|lvs: rate-limit more icmp codes"	" lower to 1/200ms		bug: t136939	change-id: i54d8eb0ac307c63429535c82843ae3a28c5f56b7	|"																																																																																																																																																																																																																																																																																																																																																																		
"lvs: fix indentation of =>		bug: t93645	change-id: i42a704f38512a5e56f7d7fde3e1da170471e9432	|"																																																																																																																																																																																																																																																																																																																																																																			
"lvs_class grain bugfix		the regexes in 38b05cf3e were wrong for the lvs101[012] cases		change-id: i6194fe999e329a4f7ba9f6bf724bc873682f3484	|lvs1007-12 basic puppetization		note this doesn't place them in any traffic class or assign them	any production service ips.		bug: t104458	change-id: i340b18a6afb5c5ab1dfde7734fb48e5cc8e2e60e	|mathoid to service::node		have mathoid use the service::node paradigm		bug: t97124	change-id: i06f06cf1f516a536b82b286551eda011c02e3a6c	|graphoid: lvs configuration		this patch configures lvs for graphoid on 10.2.2.15 and adds simple	monitoring for it.		bug: t90487	change-id: i97d2b53ebd3fce12c5b9443e2206ff30f9eaa3a7	|lvs: add loadbalancers for appservers"	" api and rendering		bug: t92377	change-id: i4e76e44ed80304ed7c236678859e0e9158b4afcb	|lvs configuration for zotero service		adding lvs config and monitor for the zotero service.		bug:t89867	change-id: i9b51cba4985278edec7b288d1e6f7e8f505d1b11	|restbase: add internal lvs configuration		note: as a followup to this we'll need a role or variable not to deploy lvs	realserver during testing		bug: t89636	change-id: i85d70c5b2aded256ab808789e9ec0e6b8ca3bd8b	|lsearchd: remove lvs configuration		bug: t85009	change-id: i6e417cbb4fe1b40fd99821edc61c83b288197409	|declare hhvm_appservers lvs service ip for labs"	" too		already tested in labs.	not sure why it's pmtpa only"	" but i'm just emulating the setting for the	'apaches' lvs config.		bug: 69921	change-id: i1502875f36e2901a6c1986405eb482a5de3d266d	|"																																																																																																																																																																																																																																																																																																																																																																
"lvs::monitor: monitor all services via service_checker		bug: t134551	change-id: i4c902c94244275dd692a16dd9e84f6c6285ecf24	|mathoid to service::node		have mathoid use the service::node paradigm		bug: t97124	change-id: i06f06cf1f516a536b82b286551eda011c02e3a6c	|graphoid: lvs configuration		this patch configures lvs for graphoid on 10.2.2.15 and adds simple	monitoring for it.		bug: t90487	change-id: i97d2b53ebd3fce12c5b9443e2206ff30f9eaa3a7	|lvs configuration for zotero service		adding lvs config and monitor for the zotero service.		bug:t89867	change-id: i9b51cba4985278edec7b288d1e6f7e8f505d1b11	|restbase: add internal lvs configuration		note: as a followup to this we'll need a role or variable not to deploy lvs	realserver during testing		bug: t89636	change-id: i85d70c5b2aded256ab808789e9ec0e6b8ca3bd8b	|lsearchd: remove lvs configuration		bug: t85009	change-id: i6e417cbb4fe1b40fd99821edc61c83b288197409	|improve lvs check for elasticsearch		try to check the _nodes api to see if we can get a response for a	given node.		bug: 57319	change-id: i315ec9b4d1bd19729f0bf45bcc7af20503068381	|"																																																																																																																																																																																																																																																																																																																																																																			
"team-interactive receives maps alerts		adding team-interactive to the following alerts:		* service check on kartotherian	* service check on tilerator	* service check on tileratorui	* lvs check on kartotherian service		bug: t137869	bug: t137851	change-id: i02fca2da8ac90366d6be1c67d1e985c1b2c46228	|kartotherian.svc.codfw monitoring		bug: t137851	change-id: ica72d91c221649dfef4912fbc82393df6e1f839d	|lvs::monitor: monitor all services via service_checker		bug: t134551	change-id: i4c902c94244275dd692a16dd9e84f6c6285ecf24	|"																																																																																																																																																																																																																																																																																																																																																																			
"mailman: add cron to gather queue data		bug: t114861	change-id: i4618114137e7be35f811fff5954c81fca5b4fa7c	|mailman: add cronjob to delete old held messages		bug:t109838	change-id: if814e416cbd43270b00d1680d063019889a3ca00	|"																																																																																																																																																																																																																																																																																																																																																																			
"mailman: add cronjob to delete old held messages		bug:t109838	change-id: if814e416cbd43270b00d1680d063019889a3ca00	|"																																																																																																																																																																																																																																																																																																																																																																			
"mailman: no gate_news debconf option on >= jessie		""gate_news"" is mailman's newsgroup to mail gateway.		this option does not exist anymore in the jessie version of the	package.		@fermium:~# echo get mailman/gate_news | debconf-communicate	10 mailman/gate_news doesn't exist		@sodium:~# echo get mailman/gate_news | debconf-communicate	0 false		it causes puppet errors if we still try to set it on jessie:		mailman::listserve/exec[dpkg-reconfigure mailman]:	dependency exec[debconf-communicate set mailman/gate_news] has failures: true		bug:t109925	change-id: ib01baf00aca8c978e34b9553e29d1ef1bffee702	|"																																																																																																																																																																																																																																																																																																																																																																			
"mailman: remove import scripts		we won't use these anymore. instead we are rsyncing	directly in place and adjusted the scripts on the source side	as well as the rsyncd config.		bug:t110131	change-id: i6f0b30c6330d1f08294e9106ae22cd0f72fef8ce	|mailman: rsync for local import		bug:t110138	change-id: i3cb8696b28ae856d07e4a0e070bbe87814100dda	|mailman: rsync command for exim copy		bug:t110138	change-id: i0fa9eddfcfebf61f511367875a3654dec3f1d7e9	|mailman: mini script to rsync lists		bug:t109399	bug:t108071	change-id: i4e697624bcad465b9288a6632ef8693118278185	|mailman: add helper scripts for importing lists		adds scripts that are useful for importing lists copied from	another server. moves all scripts into a ./scripts sub directory.		bug:t108073	change-id: idbb8f6476aedc770a9efed44e4539c92caef8f5b	|"																																																																																																																																																																																																																																																																																																																																																																			
"mathoid: use scap3 as the deployment method		bug: t116338	change-id: i9e8cda8f9956e12e5e41bcc8f53bea149c1a9c60	|services: introduce service::packages		some services"	 like mathoid and graphoid	" need extra debian packages to	be present on the system during run time. additionally"	" they also have	compile-time dependencies (mostly header files packaged in -dev	packages). service::packages provides a way for us to specify and	install the complete list of such dependencies for each service. by	default"	 service::packages installs only run-time dependencies	" but can	be instructed to install compile-time packages as well by setting the	service::configuration::use_dev_pkgs flag to true. this is useful in	cases where the service's dependencies need to be built on the spot"	"	such as ci/nodepool instances. this patch activates the flag for the	contintcloud labs project.		while at it"	" this patch also switches mathoid and graphoid to use	service::packages"	 listing their complete debian dependencies. also	"	mathoid will not be using java png generation (which was never turned on	in production any way). instead"	 the upcoming version will use librsvg	"	so list it as a dependency.		bug: t128280	bug: t119693	change-id: i882f0f768bdea0c78403513e5eb1d778bef97462	|mathoid: increase the number of workers temporarily		there is a bug in mathoid that when certain tex input is given"	" the	worker process dies. until we do a hotfix"	" increase the number of	workers temporarily to 50 to minimise the chances of all workers dying	at the same time.		bug: t121762	change-id: ice3619c27855952d0f5723bea322ea9b04ab36ea	|mathoid: enable advanced enpoint monitoring		as of d824fc6 mathoid is exposing its monitoring spec at /?spec in	production. this patch enables its checking.		bug: t105775	change-id: ifae3e8ab62a9d831db27df97f92cd8daa9a5317e	|remove firejail conditional		now that firejail"	" graphoid and mathoid have been migrated to firejail	in production"	" remove the ""firejail"" conditional in service::node and	use firejailed execution for all upcoming services.		bug: t101870	change-id: i0970967a2eb7e8d9b21ef361d6107702f20e15d1	|enable firejail for mathoid		enable firejail for mathoid (preliminary tests with the mathoid ppa were	fine"	" additional tests in deployment-prep to follow)		bug: t101870	change-id: id13166487de593456532092df785b2297b18403f	|mathoid to service::node		have mathoid use the service::node paradigm		bug: t97124	change-id: i06f06cf1f516a536b82b286551eda011c02e3a6c	|mathoid: unify mathoid production and beta roles		bug: t86633	change-id: i10463938bac5afdd75e10b7cf8f2574fd809391f	|"																																																																																																																																																																																																																																																																																																																																																			
"services: introduce service::packages		some services"	 like mathoid and graphoid	" need extra debian packages to	be present on the system during run time. additionally"	" they also have	compile-time dependencies (mostly header files packaged in -dev	packages). service::packages provides a way for us to specify and	install the complete list of such dependencies for each service. by	default"	 service::packages installs only run-time dependencies	" but can	be instructed to install compile-time packages as well by setting the	service::configuration::use_dev_pkgs flag to true. this is useful in	cases where the service's dependencies need to be built on the spot"	"	such as ci/nodepool instances. this patch activates the flag for the	contintcloud labs project.		while at it"	" this patch also switches mathoid and graphoid to use	service::packages"	 listing their complete debian dependencies. also	"	mathoid will not be using java png generation (which was never turned on	in production any way). instead"	 the upcoming version will use librsvg	"	so list it as a dependency.		bug: t128280	bug: t119693	change-id: i882f0f768bdea0c78403513e5eb1d778bef97462	|"																																																																																																																																																																																																																																																																																																																																																								
"mathoid to service::node		have mathoid use the service::node paradigm		bug: t97124	change-id: i06f06cf1f516a536b82b286551eda011c02e3a6c	|"																																																																																																																																																																																																																																																																																																																																																																			
"mediawiki::cgroup: systemd compatibility		bug: t131749	change-id: ib81f914f2b0fada91e96c8b470af3bf697bfa53a	|mediawiki: small clean-ups		* instead of a fake sync to start apache on beta (bug 38996)"	" call	  ""/etc/init.d/apache2 start"".	* to avoid having the beta apaches attempt to sync the apache configs"	"	  create file['/usr/local/apache/conf'] before sync_apache_config has had	  a chance to run.	* tidy up whitespace"	 parameter order	" etc.	* avoid redundant dependencies when puppet already orders resources.	* declare apache::mod::cgi		change-id: i1b8a617c260bb68ec475656aa56a500a6ab0ad5d	|"																																																																																																																																																																																																																																																																																																																																																															
"provide the firejail containment for imagemagick's convert(1) on all app servers		it is also used by the score extensions which is installed on all app servers	and not only on the image scalers.		bug: t135111	change-id: i4463ad7285cf93faaed02294a19790be1f516d89	|add firejail profile and wrapper for ghostscript		used by the pdfhandler extension on the image scalers		bug: t135111	change-id: i942af80bdbbba3323070d49f4741c4cd5246ba85	|provide a firejail profile for the image scalers		this excludes the root user"	 drops all capabilities	" limits the network	to a loopback device"	" enables a seccomp filter for potentially harmful	syscalls and uses a private /dev directory. also sensitive directories	and commands are blacklisted.		the profile will be used in a followup patch.		bug: t135111	change-id: i9720488d9add2389b3f9b391f7d825a12d8622aa	|"																																																																																																																																																																																																																																																																																																																																																																
"facter: remove references to $::memorytotal		the memorytotal fact is not present in recent versions of	facter (anything > 1.7"	 actually). before that	" the fact was a synonym	for memorysize and deprecated:		https://docs.puppet.com/facter/1.7/core_facts.html#memorytotal		since we're using facter 2.2 in jessie"	" convert all references to	memorytotal to use memorysize instead.		bug: t131749	change-id: ida15e4880419ba99f350f7e3883d45560184f9c1	|mediawiki::hhvm: debian jessie compatibility		bug: t131749	change-id: i927ca0416fce7f8cf108d815530f067911ad39c3	|activate ssl + connection pooling for cirrussearch on prod		add sizing of the curl pools. while the default size of 5 should be good	for average traffic"	" we do have spikes higher than this. in case of pool	exhaustion a fatal error will be raised"	" so we want to ensure that this	happens as rarely as possible. resource limitation is done by pool counter	anyway.		this is a pre-requisite to activate connection pooling on production.		bug: t131839	change-id: icffdfd8b3f0549409d4c4e6f76c398216cd168de	|mediawiki: allow using a different web user than apache		at the moment the user:group for all web-related software in mediawiki	is the non-standard apache user. so"	 as a transitional helper	" we are	making the user configurable so that the transition can happen over time.		bug: t78076	change-id: idf7d1f9185aec9aec889ef5f1141bd0263909281	signed-off-by: giuseppe lavagetto <glavagetto@wikimedia.org>	|"																																																																																																																																																																																																																																																																																																																																																												
"mediawiki::hhvm: debian jessie compatibility		bug: t131749	change-id: i927ca0416fce7f8cf108d815530f067911ad39c3	|"																																																																																																																																																																																																																																																																																																																																																																			
"install firejail profile for convert		it is also used by the score extension which is installed on all app servers	and not only on the image scalers.		bug: t135111		change-id: i10b00b97333345b78eabf77aab54ca050c57ae4d	|provide the firejail containment for imagemagick's convert(1) on all app servers		it is also used by the score extensions which is installed on all app servers	and not only on the image scalers.		bug: t135111	change-id: i4463ad7285cf93faaed02294a19790be1f516d89	|mediawiki: make base class trusty and forward only		bug: t126310	change-id: i10b18e01b582404b105378c834c8a0acf9b3f6ba	|mediawiki: allow using a different web user than apache		at the moment the user:group for all web-related software in mediawiki	is the non-standard apache user. so"	 as a transitional helper	" we are	making the user configurable so that the transition can happen over time.		bug: t78076	change-id: idf7d1f9185aec9aec889ef5f1141bd0263909281	signed-off-by: giuseppe lavagetto <glavagetto@wikimedia.org>	|logstash: forward syslog events for apache2 + hhvm		forward syslog events from apache2 and hhvm processes to a logstash	server if configured to do so via hiera. forwards the same events that	would normally be sent to a udp2log relay directly to logstash.		using the syslog input to logstash and rsylog as the transfer agent from	the individual mediawiki hosts moves us closer to being able to	discontinue the use of log2udp forwarding to get events into logstash.		bug: t76119	change-id: i5e8ea2b9c917ced306631c8092ce3149920a28f1	|"																																																																																																																																																																																																																																																																																																																																																																	
"jobqueue_redis: set up encryption and cross-dc replication		since the topology is slightly different in eqiad and codfw"	" the logic	of cross-dc replication is moved into a data structure. the dc-local	redis masters are then set up for replication and cross-dc encryption	based on it. the local slaves have no ipsec encryption and only need to	know the instances present on their master"	" of which they are an exact	mirror. in case of need"	" a slave can be promoted to be master by	removing the slaveof definition and promoting it into the master-master	data structure.		bug: t124672	change-id: i2bd075501661bb9e9527bb8e1858a1322a4a1535	|jobqueue_redis: actually disable rdb saves		this is probably the reason why we see iowait spikes on rdb100{1"	"3}.		bug: t119739	change-id: i1248b278facb9169be36f51cda5717ec371285e9	|"																																																																																																																																																																																																																																																																																																																																																															
"mediawiki::jobrunner: drop precise compatibility		bug: t126310	change-id: i9ba835401259f6790ac838306ec8db1d524eed0f	|notify jobchron when jobrunner.conf changes.		bug: t123675	change-id: ifc619b888f457213b9d3b2b4071b3c10f36a1d2f	|job runners: add a dedicated htmlcacheupdate runner		the bulk of the jobs in the queue are wikidata / enwiki / commons	htmlcacheupdate jobs"	" which use $wgjobbackoffthrottling. adding a dedicated	runner would help ensure that these jobs get processed as soon as the backoff	expires"	" and would support aaron's theory that the de facto throttle rate is	far lower than what we set it to.		bug: t123815	bug: t124194	change-id: i180856917b5c74437e10e4c9b45e4e0a2ea1e381	|jobrunner: contain gwt jobs to run on two specific hosts		since gwt jobs are leaking memory and it has caused instabilities on the	jobrunners"	" we do as follows:		* remove the hack introduced in i44990808 to contain running gwt runners	  on odd-numbered jobrunners	* contain gwt jobs to run on two specific servers"	" which will be running	  those jobs exclusively. we use two newer"	" high-memory ones.	* modify the cronjob hack to run each hour on those machines"	" and to	  restart hhvm once it occupies a sizeable amount of the memory		bug: t122069	change-id: i3ff20b324ee98e93a926e0aa1ed568cc9343ae90	|add ferm rules for jobrunners		bug: t104972	change-id: i0b2c9cb74deece18daef0a184525b580d827023d	|set dedicated sul rename runner loop		bug: t87397	change-id: i6b42515953dedfb9c35910a7f841bfa493fda5c4	|add dedicated runner for messageindexrebuildjob		bug: t90704	change-id: ie3480d0b6e54635ef167fa1082dd28ce2cddbe90	|mediawiki: allow using a different web user than apache		at the moment the user:group for all web-related software in mediawiki	is the non-standard apache user. so"	 as a transitional helper	" we are	making the user configurable so that the transition can happen over time.		bug: t78076	change-id: idf7d1f9185aec9aec889ef5f1141bd0263909281	signed-off-by: giuseppe lavagetto <glavagetto@wikimedia.org>	|mediawiki::jobrunner -> mediawiki::jobqueue		* consistent with the principle that things in the module class should describe	  a software stack rather than a role (i.e."	" 'multimedia' rather than	  'imagescaler')	* resolves conflicting def'ns for videoscalers resulting from a puppet parser	  bug that makes class { '::mediawiki::jobrunner' } in	  role::mediawiki::videoscaler resolve to the role class rather than the module	  class.		change-id: i70c23114d1737e8d6c22ccc31c84ad3a3e7ac08a	|"																																																																																																																																																																																																																																																																																																																																																										
"setup cirrussearch continuous saneitization process to run via cron		bug: t139200	change-id: i3b934b52b7b67726ba58c3d6c37c605b869202c2	|[cirrus maint] redirect stderr to log and use full mwscript path		the log files from this command are generated"	" but not populated with	anything. likely they are empty because stderr was not also redirected	to the log files. best guess for why nothing is running is that the full	path to mwscript should be use. if not the case it still doesn't hurt	to be explicit		bug: t120843	change-id: i2247ae6b12b7dcf4b38d7104cbafa31960a0a6b3	|"																																																																																																																																																																																																																																																																																																																																																																		
"move mediawiki maintenance scripts to module		- delete misc/maintenance.pp because we want to get rid of the entire	misc/ if possible.		- rename it to mediawiki because all these are mw maintenance scripts.		- move it into the mediawiki module in separate files.		- instead of all the inclusions in site.pp put it in a small role		- move files from files/scripts and other random locations into module.		bug:t88597		change-id: ie13bd7a80d8dd850cc93103aee174c15e5de469d	|"																																																																																																																																																																																																																																																																																																																																																																			
"only run processechoemailbatch.php on echo-enabled wikis		bug: t137771	change-id: i61ea420fe913f5f81cc2445a1868ed9f5988bc3c	depends-on: iad1695b9e99d89cca76d14514cb050b130961d34	|move mediawiki maintenance scripts to module		- delete misc/maintenance.pp because we want to get rid of the entire	misc/ if possible.		- rename it to mediawiki because all these are mw maintenance scripts.		- move it into the mediawiki module in separate files.		- instead of all the inclusions in site.pp put it in a small role		- move files from files/scripts and other random locations into module.		bug:t88597		change-id: ie13bd7a80d8dd850cc93103aee174c15e5de469d	|"																																																																																																																																																																																																																																																																																																																																																																			
"move mediawiki maintenance scripts to module		- delete misc/maintenance.pp because we want to get rid of the entire	misc/ if possible.		- rename it to mediawiki because all these are mw maintenance scripts.		- move it into the mediawiki module in separate files.		- instead of all the inclusions in site.pp put it in a small role		- move files from files/scripts and other random locations into module.		bug:t88597		change-id: ie13bd7a80d8dd850cc93103aee174c15e5de469d	|"																																																																																																																																																																																																																																																																																																																																																																			
"move mediawiki maintenance scripts to module		- delete misc/maintenance.pp because we want to get rid of the entire	misc/ if possible.		- rename it to mediawiki because all these are mw maintenance scripts.		- move it into the mediawiki module in separate files.		- instead of all the inclusions in site.pp put it in a small role		- move files from files/scripts and other random locations into module.		bug:t88597		change-id: ie13bd7a80d8dd850cc93103aee174c15e5de469d	|"																																																																																																																																																																																																																																																																																																																																																																			
"move mediawiki maintenance scripts to module		- delete misc/maintenance.pp because we want to get rid of the entire	misc/ if possible.		- rename it to mediawiki because all these are mw maintenance scripts.		- move it into the mediawiki module in separate files.		- instead of all the inclusions in site.pp put it in a small role		- move files from files/scripts and other random locations into module.		bug:t88597		change-id: ie13bd7a80d8dd850cc93103aee174c15e5de469d	|"																																																																																																																																																																																																																																																																																																																																																																			
"move mediawiki maintenance scripts to module		- delete misc/maintenance.pp because we want to get rid of the entire	misc/ if possible.		- rename it to mediawiki because all these are mw maintenance scripts.		- move it into the mediawiki module in separate files.		- instead of all the inclusions in site.pp put it in a small role		- move files from files/scripts and other random locations into module.		bug:t88597		change-id: ie13bd7a80d8dd850cc93103aee174c15e5de469d	|"																																																																																																																																																																																																																																																																																																																																																																			
"move mediawiki maintenance scripts to module		- delete misc/maintenance.pp because we want to get rid of the entire	misc/ if possible.		- rename it to mediawiki because all these are mw maintenance scripts.		- move it into the mediawiki module in separate files.		- instead of all the inclusions in site.pp put it in a small role		- move files from files/scripts and other random locations into module.		bug:t88597		change-id: ie13bd7a80d8dd850cc93103aee174c15e5de469d	|"																																																																																																																																																																																																																																																																																																																																																																			
"move mediawiki maintenance scripts to module		- delete misc/maintenance.pp because we want to get rid of the entire	misc/ if possible.		- rename it to mediawiki because all these are mw maintenance scripts.		- move it into the mediawiki module in separate files.		- instead of all the inclusions in site.pp put it in a small role		- move files from files/scripts and other random locations into module.		bug:t88597		change-id: ie13bd7a80d8dd850cc93103aee174c15e5de469d	|"																																																																																																																																																																																																																																																																																																																																																																			
"move mediawiki maintenance scripts to module		- delete misc/maintenance.pp because we want to get rid of the entire	misc/ if possible.		- rename it to mediawiki because all these are mw maintenance scripts.		- move it into the mediawiki module in separate files.		- instead of all the inclusions in site.pp put it in a small role		- move files from files/scripts and other random locations into module.		bug:t88597		change-id: ie13bd7a80d8dd850cc93103aee174c15e5de469d	|"																																																																																																																																																																																																																																																																																																																																																																			
"move mediawiki maintenance scripts to module		- delete misc/maintenance.pp because we want to get rid of the entire	misc/ if possible.		- rename it to mediawiki because all these are mw maintenance scripts.		- move it into the mediawiki module in separate files.		- instead of all the inclusions in site.pp put it in a small role		- move files from files/scripts and other random locations into module.		bug:t88597		change-id: ie13bd7a80d8dd850cc93103aee174c15e5de469d	|"																																																																																																																																																																																																																																																																																																																																																																			
"move mediawiki maintenance scripts to module		- delete misc/maintenance.pp because we want to get rid of the entire	misc/ if possible.		- rename it to mediawiki because all these are mw maintenance scripts.		- move it into the mediawiki module in separate files.		- instead of all the inclusions in site.pp put it in a small role		- move files from files/scripts and other random locations into module.		bug:t88597		change-id: ie13bd7a80d8dd850cc93103aee174c15e5de469d	|"																																																																																																																																																																																																																																																																																																																																																																			
"move mediawiki maintenance scripts to module		- delete misc/maintenance.pp because we want to get rid of the entire	misc/ if possible.		- rename it to mediawiki because all these are mw maintenance scripts.		- move it into the mediawiki module in separate files.		- instead of all the inclusions in site.pp put it in a small role		- move files from files/scripts and other random locations into module.		bug:t88597		change-id: ie13bd7a80d8dd850cc93103aee174c15e5de469d	|"																																																																																																																																																																																																																																																																																																																																																																			
"move mediawiki maintenance scripts to module		- delete misc/maintenance.pp because we want to get rid of the entire	misc/ if possible.		- rename it to mediawiki because all these are mw maintenance scripts.		- move it into the mediawiki module in separate files.		- instead of all the inclusions in site.pp put it in a small role		- move files from files/scripts and other random locations into module.		bug:t88597		change-id: ie13bd7a80d8dd850cc93103aee174c15e5de469d	|"																																																																																																																																																																																																																																																																																																																																																																			
"move mediawiki maintenance scripts to module		- delete misc/maintenance.pp because we want to get rid of the entire	misc/ if possible.		- rename it to mediawiki because all these are mw maintenance scripts.		- move it into the mediawiki module in separate files.		- instead of all the inclusions in site.pp put it in a small role		- move files from files/scripts and other random locations into module.		bug:t88597		change-id: ie13bd7a80d8dd850cc93103aee174c15e5de469d	|"																																																																																																																																																																																																																																																																																																																																																																			
"move mediawiki maintenance scripts to module		- delete misc/maintenance.pp because we want to get rid of the entire	misc/ if possible.		- rename it to mediawiki because all these are mw maintenance scripts.		- move it into the mediawiki module in separate files.		- instead of all the inclusions in site.pp put it in a small role		- move files from files/scripts and other random locations into module.		bug:t88597		change-id: ie13bd7a80d8dd850cc93103aee174c15e5de469d	|"																																																																																																																																																																																																																																																																																																																																																																			
"maintenance: run at most three wikidata dispatchchanges instance at a time		instances of this script pile up and create an absurd number of	connections to the databases"	" amongst other nuisances.		we reduce the max time of the running script in hope that this can at	least reduce the pain.		bug: t118162	change-id: i0a7f0ccf029a0c85521a38cb507eb035282ca49d	|move mediawiki maintenance scripts to module		- delete misc/maintenance.pp because we want to get rid of the entire	misc/ if possible.		- rename it to mediawiki because all these are mw maintenance scripts.		- move it into the mediawiki module in separate files.		- instead of all the inclusions in site.pp put it in a small role		- move files from files/scripts and other random locations into module.		bug:t88597		change-id: ie13bd7a80d8dd850cc93103aee174c15e5de469d	|"																																																																																																																																																																																																																																																																																																																																																																		
"mediawiki: adjust jobq alarms		bug: t87594	change-id: ica567f05eac7dcf6b638aa3d5b6a6d3a4ffa4ce0	|"																																																																																																																																																																																																																																																																																																																																																																			
"mediawiki: use puppet-provided fontconfig everywhere		bug: t139543	change-id: i56512b41846b671edfd3db6eaf7f2e88eae7e7be	|provide a firejail profile for the image scalers		this excludes the root user"	 drops all capabilities	" limits the network	to a loopback device"	" enables a seccomp filter for potentially harmful	syscalls and uses a private /dev directory. also sensitive directories	and commands are blacklisted.		the profile will be used in a followup patch.		bug: t135111	change-id: i9720488d9add2389b3f9b391f7d825a12d8622aa	|mediawiki: allow using a different web user than apache		at the moment the user:group for all web-related software in mediawiki	is the non-standard apache user. so"	 as a transitional helper	" we are	making the user configurable so that the transition can happen over time.		bug: t78076	change-id: idf7d1f9185aec9aec889ef5f1141bd0263909281	signed-off-by: giuseppe lavagetto <glavagetto@wikimedia.org>	|mediawiki: small clean-ups		* instead of a fake sync to start apache on beta (bug 38996)"	" call	  ""/etc/init.d/apache2 start"".	* to avoid having the beta apaches attempt to sync the apache configs"	"	  create file['/usr/local/apache/conf'] before sync_apache_config has had	  a chance to run.	* tidy up whitespace"	 parameter order	" etc.	* avoid redundant dependencies when puppet already orders resources.	* declare apache::mod::cgi		change-id: i1b8a617c260bb68ec475656aa56a500a6ab0ad5d	|"																																																																																																																																																																																																																																																																																																																																																										
"nutcracker: do not declare redis_codfw in labs		bug: t127845	change-id: i32030e3a5acf7434d2f9ff1a773865d7e6b51f2a	|nutcracker: re-organize redis servers list		transform the nutcracker-centric list we had into a structured hash of	data"	 that can be used as source of information for other purposes too	"	as for example establish redis replication pairs.		also"	" add the two additional instances in codfw introduced in ia85aee42		bug: t126470	change-id: i65dc207e54822bf911744ff8832349a052789bcc	|make the 'sessions' redis cache multi-dc ready		currently"	" nutcracker on both codfw and eqiad is proxying client connections on	port 6380 to a redis clustered labeled 'session-redis' and whose membership	varies by cluster. for multi-dc"	" mediawiki needs to be aware of there being	multiple clusters"	" and it needs to be able to address requests to the primary	redis cluster.		to achieve this"	" add two new pools to the nutcracker configuration:	'redis_eqiad' and 'redis_codfw'. to make migration easy and safe"	" keep the	current 'session-redis' pool for now.		the new pools listen on a unix domain socket. for the time being"	" they don't	set 'preconnect'"	" to avoid inundating the redis hosts with idle connections.		bug: t111575	change-id: i64bc52ca95d47bf30e3c0b7d2a0d02e0c66245da	|deployment::server: re-puppetize nutcracker config		it got lost and unmanaged sometimes in the past"	" that is obviously wrong	and causing issues and slowness		bug: t103198	change-id: ia950a56726bd6eb42ee4867c7672903693e71788	|"																																																																																																																																																																																																																																																																																																																																																								
"provide the firejail containment for imagemagick's convert(1) on all app servers		it is also used by the score extensions which is installed on all app servers	and not only on the image scalers.		bug: t135111	change-id: i4463ad7285cf93faaed02294a19790be1f516d89	|mediawiki: remove useless lib* dependencies		depending on specific versions of libmemcached & libvips is a)	conceptually wrong"	" since the manifests are not depending on the	libraries themselves but on some package that uses them b) useless"	"	since these are pulled off by apt anyway c) an annoyance"	" as the package	names change due to soname differences.		bug: t103315"	" t103322	change-id: i28f4aa5458c27bc181dfcd51026a6612328dfe0b	|add freepats for score usage		bug: t85439	change-id: if6b568898992e716f277ad7c1213dd2d4d8e9f71	|move beta scap source directory off of nfs		change the directory that receives mediawiki code and configuration via	jenkins job updates from the nfs mounted	/data/project/apache/common-local/ to a local directory on	deployment-bastion.		configuration has been added to the beta::autoupdater class to ensure	that a clones of operations/mediawiki-config.git"	" mediawiki/core.git and	mediawiki/extensions.git are present in the new staging directory along	with an l10n cache directory and a localsettings.php file. note that the	wmf-config/privatesettings.php file will still need to be copied or	created by had for the deploy to be fully functional.		also cleanup configuration differences that were needed while scap was	being tested in beta as a parallel deployment process.		bug: 63746	change-id: i4cbd312e19a9b590760bba8e776fa5f816e20e34	|"																																																																																																																																																																																																																																																																																																																																																														
"mediawiki: use puppet-provided fontconfig everywhere		bug: t139543	change-id: i56512b41846b671edfd3db6eaf7f2e88eae7e7be	|mediawiki::packages::fonts: reject bitmap fonts on jessie		bug: t139543	change-id: i042b10f4f18ea66d4894ee4201399a2b1057437e	|provide fontconfig configuration which forces antialiasing		in older releases (up to the version present in trusty)"	" fontconfig-config provided	a config file which forced antialiasing. this is no longer present in the versions	in jessie and later"	" so provide it manually since otherwise some fonts look distorted	in smaller resolutions.		bug: t139543	change-id: i848dd6b068ade935b60f87a2f0d5c844034a759e	|install fonts-sil-lateef on scalers		bug: t138136	change-id: ifa6c3155dcd0ce8d06a439226d828596cbe115dc	|add fonts-taml-tscu font to scalers		bug: t117919	change-id: idc9d1b0a80822d6f8d44e41e6d0f32e8e53e026c	|install fonts-noto-cjk on jessie image scalers		it's available in jessie-backports. that font is not available in trusty"	"	but since trusty scalers are deprecated only add it on jessie.		bug: t123223	change-id: i93989a1c5c15d42a0e1af784c04017b4bd1bc615	|add amiri font to the scalers		fonts-hosny-amiri is currently installed on the scalers as a reverse	dependency of a very long dependency tree which originates with	texlive-fonts-recommended"	" but better make that explicit in case	texlive depenencies change in a later debian release.		bug: t135347	change-id: idc57bd58d4fd20be8ead8a262952ce3f205e8f60	|add fonts-smc (malayalam) to image/video scalers		this provides improved versions of malayalam fonts. fonts-smc replaces	ttf-malayalam-fonts"	" so drop this it for trusty servers (it wasn't	added for jessie to begin with since jessie no longer has these fonts)		bug: t33950	change-id: i05f5088bdb4421d2ca29ae34cde1b431045b3e57	|only install font-gujr-extra on jessie		font-gujr-extra conflicts with ttf-gujarati-fonts"	" but trusty doesn't	yet have the fonts-gujr replacement. since the migration to mediawiki	on jessie is in progress anyway"	" only install font-gujr-extra on jessie.		bug: t129500	change-id: ib6ed89554c65d8c476dc1ed134b06dbd57907419	|add additional gujarati fonts (rekha) (fonts-gujr-extra)		bug: t129500	change-id: iedec895987132785599a7e6ea6cbc64bcbf97368	|fix appserver font package name for indian fonts		ubuntu uses the ttf-indic-fonts source package"	" while debian switched to	the source package fonts-indic starting with jessie. so use the font	package names from fonts-indic on jessie.		bug: t131749		change-id: idcc33fab1f8931d661597d58822fbc386b111dfb	|mediawiki::packages: drop precise compatibility		bug: t126310	change-id: i932e43113b67f96c727edc668c2845167b120499	|mediawiki: ttf-gujarati-fonts replaced by fonts-gujr-extra		fonts-gujr-extra has been installed (ie20e26542d1b44)"	" but	it replaces ttf-gujarati-fonts. and if we tell puppet to install	both then it will remove and reinstall one or the other on every single	puppet run.		[mw1153:~] $ apt-cache show fonts-gujr-extra | grep -e 'break\|replace'		replaces: ttf-gujarati-fonts	breaks: ttf-gujarati-fonts (<< 2:1.0)		bug:t129500	change-id: ic8d0f01d5a9b44eb5ac7bfa2a23bce1e72063a9e	|mediawiki: do not install fonts-gujr-extra on precise		follow-up to ie20e26542d1b44"	" which caused puppet fails on	precise labs instances"	 such as tools-exec	" because this package	doesn't exist on precise.		bug:t129500	change-id: id6cc7818ff201afce008a48d2c9cd86df7a611ac	|add gujarati fonts to mediawiki::packages::fonts		the fonts-gujr-extra package will allow access to the rehka font"	"	used on wikimedia projects in gujarati for the logos.		bug: t129500	change-id: ie20e26542d1b44cd23ae3a61179e03bfc0e90d37	|install fonts-wqy-zenhei on app servers		bug:t84777	change-id: i880c687c8600b79950be7caba5e42f6368a54df5	|change bz references to phabricator tickets in mediawiki module		bug: t96431	change-id: ic8e1c720274d103e911eb367c54e9e3a9359ce6f	|mediawiki: install fonts metric-compatible with calibri and cambria		bug: t84842	change-id: i73790027f9ffc80a0b95c59ab084f6b7b3ffdfdf	|install fonts-unfonts-core"	" not just fonts-unfonts-extra		this is a set of korean truetype fonts.		""ttf-unfonts-core package is enough for daily use"" but we don't install it	""ttf-unfonts-extra package has the less common font families"" but we install it		https://packages.debian.org/wheezy/fonts-unfonts-extra	https://packages.debian.org/wheezy/fonts-unfonts-core		-extra recommends -core"	 but does not depend on it	"	so only -extra is installed but not -core.		bug: t91685	change-id: i2e436279e40a3761dad2eafd814b4b39e7e7d05c	|"																																																																																																																																																																																																																																																																																																																																																			
"mediawiki: remove all php5-fss references		both hhvm and zend php >= 5.5's native strtr() is fast enough these	days for mediawiki to not use fss		also see i20374d37bbb9958188a0487abc5b50f08ce40840.		bug: t95002	change-id: ie05ddd197ace3e6cdffa4cefd7c395dc6332c6ce	|"																																																																																																																																																																																																																																																																																																																																																																			
"provide the firejail containment for imagemagick's convert(1) on all app servers		it is also used by the score extensions which is installed on all app servers	and not only on the image scalers.		bug: t135111	change-id: i4463ad7285cf93faaed02294a19790be1f516d89	|install firejail on image/video scalers		bug: t135111	change-id: i9d5495e78bb7d8c6d9e359498a49bf2ab11ede04|mediawiki: remove useless lib* dependencies		depending on specific versions of libmemcached & libvips is a)	conceptually wrong"	" since the manifests are not depending on the	libraries themselves but on some package that uses them b) useless"	"	since these are pulled off by apt anyway c) an annoyance"	" as the package	names change due to soname differences.		bug: t103315"	" t103322	change-id: i28f4aa5458c27bc181dfcd51026a6612328dfe0b	|"																																																																																																																																																																																																																																																																																																																																																															
"mediawiki: remove all php5-fss references		both hhvm and zend php >= 5.5's native strtr() is fast enough these	days for mediawiki to not use fss		also see i20374d37bbb9958188a0487abc5b50f08ce40840.		bug: t95002	change-id: ie05ddd197ace3e6cdffa4cefd7c395dc6332c6ce	|mediawiki::packages: drop precise compatibility		bug: t126310	change-id: i932e43113b67f96c727edc668c2845167b120499	|mediawiki: remove useless lib* dependencies		depending on specific versions of libmemcached & libvips is a)	conceptually wrong"	" since the manifests are not depending on the	libraries themselves but on some package that uses them b) useless"	"	since these are pulled off by apt anyway c) an annoyance"	" as the package	names change due to soname differences.		bug: t103315"	" t103322	change-id: i28f4aa5458c27bc181dfcd51026a6612328dfe0b	|"																																																																																																																																																																																																																																																																																																																																																															
"mediawiki: remove all php5-fss references		both hhvm and zend php >= 5.5's native strtr() is fast enough these	days for mediawiki to not use fss		also see i20374d37bbb9958188a0487abc5b50f08ce40840.		bug: t95002	change-id: ie05ddd197ace3e6cdffa4cefd7c395dc6332c6ce	|mediawiki::php: drop precise compatibility		bug: t126310	change-id: ifef9fb25d0484e010c566e79ce5364a5d2bf3fe9	|"																																																																																																																																																																																																																																																																																																																																																																			
"install the scap package from deb instead of trebuchet		this switches scap to use the apt provider and fixes paths to point to	`/usr/bin/$binary` instead of `/srv/deployment/scap/scap/bin/$binary`		bug: t114363		change-id: iaa518889fa2c8b3d81db9e466cb63d0fcbc30cc4	|"																																																																																																																																																																																																																																																																																																																																																																			
"keyholder key cleanup		* clean up the mess that is scap::target and keyholder::agent	* make ssh_agent_proxy look up keys by name instead of fingerprint	** this avoids needing to store fingerprints in puppet manifests	* password-protected key test is now optional and skipped on beta		bug: t132747		change-id: id298a3e0f12e31afd7ea83970e192330ffbd4243	|clean up l10nupdate settings (1/2)		follow up to iaae908b		* purge l10nupdate ssh public key from servers	* remove unneeded sudoer grant to do anything as mwdeploy user		bug: t119746	change-id: i64ee38fc8d66ee4920373408efab518541e720e6	|admin: cleanup permissions granted to wikidev		these rights are not being used by any service account defined in the users.pp	file and conflict with the group being applied currently by data.yaml		bug: t97678	change-id: i466e26fd1dbb252443e3d4766b287596a055554e	|mediawiki: transition to ssh::userkey		bug: t92475	change-id: ic9a09f89edd48bc06bca87df9a93a177abf8aaa9	|fix obvious bugs in previously l10nupdate fix		l10nupdate needs to be able to run as www-data"	" and missing test.		change-id: i358a1c9d54b830be932ea4c02435bafa2340423c	|mediawiki: allow using a different web user than apache		at the moment the user:group for all web-related software in mediawiki	is the non-standard apache user. so"	 as a transitional helper	" we are	making the user configurable so that the transition can happen over time.		bug: t78076	change-id: idf7d1f9185aec9aec889ef5f1141bd0263909281	signed-off-by: giuseppe lavagetto <glavagetto@wikimedia.org>	|labs: add deployment related sudoer rules for svn group		allow ""old timers"" who have svn as their default group in ldap to do all	the deployment related things that ""kids these days"" can do.		bug: 65548	change-id: i98dd88bb277bf8f173a896540cd89a02677add3f	|"																																																																																																																																																																																																																																																																																																																																																																
mediawiki::web: drop hhvm define	" explicitly block php		bug: t126310	change-id: i4afc87c11b297341b3f3454c631b0b72b8f6f122	|app servers: make server response header equal to fqdn		apply i58d9be0b to all app servers"	" now that it has been confirmed to work	correctly on mw1017.		bug: t132599	change-id: i1f108eb7408c66eb63bca00e7c18dadf453b27e7	|mediawiki::web: drop compatibility with precise"	" mod_php		bug: t126310	change-id: i4d88c1fcffe59c42b2a0a005cbde17d2baefe8f0	|mediawiki::web: drop precise support		bug: t126310	change-id: i72d2706b515cdd28cbaf0acd832ce028f38cfb64	|mediawiki: allow using a different web user than apache		at the moment the user:group for all web-related software in mediawiki	is the non-standard apache user. so"	 as a transitional helper	" we are	making the user configurable so that the transition can happen over time.		bug: t78076	change-id: idf7d1f9185aec9aec889ef5f1141bd0263909281	signed-off-by: giuseppe lavagetto <glavagetto@wikimedia.org>	|mediawiki: small clean-ups		* instead of a fake sync to start apache on beta (bug 38996)"	" call	  ""/etc/init.d/apache2 start"".	* to avoid having the beta apaches attempt to sync the apache configs"	"	  create file['/usr/local/apache/conf'] before sync_apache_config has had	  a chance to run.	* tidy up whitespace"	 parameter order	" etc.	* avoid redundant dependencies when puppet already orders resources.	* declare apache::mod::cgi		change-id: i1b8a617c260bb68ec475656aa56a500a6ab0ad5d	|"																																																																																																																																																																																																																																																																																																																																																										
"beta apaches: delete apache::site['wmflabs'] too		follows-up: i5acaf0a4	bug: t107430	change-id: i11d20bed47f37c31e7b649efcad279499370a9bb	|remove bits.beta.wmflabs.org		will delete apache::site['wmflabs'] later		bug: t107430	change-id: i5acaf0a43b8a5ac549343dcd40a575bb81028522	|beta: get rid of old unused upload.beta.wmflabs.org apache config		this is handled by swift"	 and before that	" a custom unpuppetised proxy	on a since-deleted instance.		bug: t84950	change-id: ifbaad9bd8d7306bba0af11b8c342ade475768b3d	|fix w-beta.wmflabs.org redirect		bug: t116444	change-id: i73e68fae54f492cd59230d4dc0036ff155fc88bf	|beta: remove custom apache2 log config		rather than writing combined logs to nfs shares"	" let logging work just	like it does in production. error logs are sent to syslog and access	logs are written to local disk. rsyslog has rules to write the error log	to local disk"	" forward to udp2log host and forward to logstash server.		bug: t98289	change-id: i0cc51323343b7f1e1a7392558ffa771fb401b76a	|"																																																																																																																																																																																																																																																																																																																																																															
"facter: remove references to $::memorytotal		the memorytotal fact is not present in recent versions of	facter (anything > 1.7"	 actually). before that	" the fact was a synonym	for memorysize and deprecated:		https://docs.puppet.com/facter/1.7/core_facts.html#memorytotal		since we're using facter 2.2 in jessie"	" convert all references to	memorytotal to use memorysize instead.		bug: t131749	change-id: ida15e4880419ba99f350f7e3883d45560184f9c1	|"																																																																																																																																																																																																																																																																																																																																																																
mediawiki::web: drop compatibility with precise	" mod_php		bug: t126310	change-id: i4d88c1fcffe59c42b2a0a005cbde17d2baefe8f0	|"																																																																																																																																																																																																																																																																																																																																																																		
"move apache includes into generic sites.pp		bug: t86644	change-id: i32d3dc13ca857e61f9d296382892592e27807b92	|move portals into generic sites.pp		bug: t86644	change-id: ibf26a1fc51edf48a2c4bd7c5cf82f2a7a5225e9c	|rename mediawiki::web::sites to mediawiki::web::prod_sites to make room for a new generic sites.pp		bug: t86644	change-id: i2978b697e3c0145b2d331802532b2bd3ee43bbd5	|"																																																																																																																																																																																																																																																																																																																																																																			
"move apache includes into generic sites.pp		bug: t86644	change-id: i32d3dc13ca857e61f9d296382892592e27807b92	|move portals into generic sites.pp		bug: t86644	change-id: ibf26a1fc51edf48a2c4bd7c5cf82f2a7a5225e9c	|rename mediawiki::web::sites to mediawiki::web::prod_sites to make room for a new generic sites.pp		bug: t86644	change-id: i2978b697e3c0145b2d331802532b2bd3ee43bbd5	|create real uris for wikidata rdf uris		bug: t97195	change-id: i965dea788b848c183f79286811ea987462fbd8c3	|"																																																																																																																																																																																																																																																																																																																																																																			
"mediawiki_singlenode:  move $::labs_mediawiki_hostname to a param		bug: t101447	change-id: i6500aa8cda778188b25ebbd6dffc9a6145c8e47b	|base: move mysterious_sysctl from webserver		also webserver module is dead!		bug: t118786	bug: t118812	change-id: i53743262fd1413fae79cd6e2b3d7cc1f3d4e3628	|"																																																																																																																																																																																																																																																																																																																																																																			
"re-enable refresh on unit file change for memcached.		this option was turned off for https://gerrit.wikimedia.org/r/#/c/288880/ to	avoid a complete restart of the memcached cluster.		bug: t129963	change-id: i4e1b62b22814fe3b7d72a5a00aba0696ecff77be	|add the possibility to specify memcached's chunk growth factor.		memcached's -f command line option specifies the chunk size growth factor"	"	namely the value used to create slab classes. we use also the -n value set to	5"	" meaning that slab classes will start from 5 bytes and grow multipling each	time by 1.05 and rounding the value to the first one divisible by 8.		bug: t129963	change-id: i5579ce1ce57615feac1d432845b59488d5e93fec	|"																																																																																																																																																																																																																																																																																																																																																																	
"apt|mirrors|ubuntu: puppetized le certs		bug: t132450	change-id: id656567640081b13cffd14837cd107d1b10f3829	|mirrors::serve: split mirrors/ubuntu site configs		bug: t132450	change-id: i4c693daf76098365cee88f0d17a8dc466e7e780d	|"																																																																																																																																																																																																																																																																																																																																																																			
"mobileapps: increase memory limit to 450mb		the mcs has now more functionality and requires a bit more memory per	worker to get the work done. this patch increases the memory limit from	300 mb to 450 mb.		bug: t140215	change-id: i3c2436da99564f5160b7201f647006d8cb8f9a89	|deploy mobileapps using scap3"	" 2nd try		move mobileapps service::node from trebuchet deployment to scap.	add mobileapps deployers to deploy-service group.	ensure that mobileapps sources are correct on tin.		bug: t129147	(cherry picked from commit a9f061b957ff40a7b4497842d89b3a0bdc4a553c)		change-id: i79c2913ce2651a1c1a79757bac5672402843373e	|deploy mobileapps using scap3		move mobileapps service::node from trebuchet deployment to scap.	add mobileapps deployers to deploy-service group.	ensure that mobileapps sources are correct on tin.		bug: t129147	change-id: id7377e176be2497b240704009a13696f8a407f25	|mobileapps: put in place proper request templates for rb and mw		as of ia0a8d4af247ee9f0562a895ce3824db6e85b4ccc mobileapps supports	fully-templated requests when placing calls to restbase and the mw api.	this patch configures the production instance to use them.		bug: t113542	change-id: iea4bda7265df335ab8f0444436017a210f70d0e3	|mobileapps: change restbase uri		the mobile content service has changed the way they include the restbase	uri to a more flexible scheme that allows them to use both restbase's	internal uri"	" as well as the generic https://{domain}/api/rest_v1	external uri. this patch conforms to the new standard.		note: to be deployed in conjunction with	i6d703b627fc22a0bfe7c27b32efa54ef0e10b5cf .		change-id: i4523d97598ef10d2075bd5ec9f60ba8bf5acfef4	depends-on: i6d703b627fc22a0bfe7c27b32efa54ef0e10b5cf	bug: t125252	|introducing mobileapps role and puppet module		bug: t105538	change-id: i4cbc5a3bc1b96332d06db4b8a7b7e1f1f9ed95f6	|"																																																																																																																																																																																																																																																																																																																																																																	
"introducing mobileapps role and puppet module		bug: t105538	change-id: i4cbc5a3bc1b96332d06db4b8a7b7e1f1f9ed95f6	|"																																																																																																																																																																																																																																																																																																																																																																			
"monitoring/graphite: add until time limit argument		add 'until' parameter providing shifted in time monitoring.	useful for metrics 'eventlogging_difference_raw_validated' that raises false	alarms due to graphite data not being up-to-date between (now-5mins) and now.		bug: t116035	change-id: i4b549e23b40bce53833d86b2d4a06206512c8b98	|"																																																																																																																																																																																																																																																																																																																																																																			
"icinga: ensure hiera lookups for all contact_group defs		some defs like in base are likely overwriting and acting as global values.	this would mean hiera is either not looked at all or is overwritten.		bug:t111243	change-id: icb3b039a067af656b727fa6b1ebea7d1d9187f65	|"																																																																																																																																																																																																																																																																																																																																																																			
"stop icinga git remote update		this check has been causing some ownership issues on	/srv/mediawiki-staging for a few months. ideally"	" icinga wouldn't change	the state of a git repository.		use git ls-remote to check the current sha1 of the remote.		bug: t127093	change-id: i921d3f9e75a5ac2a19e1b82e246827ab4e1b7a9a	|"																																																																																																																																																																																																																																																																																																																																																																		
"icinga: ensure hiera lookups for all contact_group defs		some defs like in base are likely overwriting and acting as global values.	this would mean hiera is either not looked at all or is overwritten.		bug:t111243	change-id: icb3b039a067af656b727fa6b1ebea7d1d9187f65	|monitoring: replace illegal chars in description		we've been bitten by this multiple times"	" with invalid icinga configuration	being generated and much pulling of hair		bug: t101799	change-id: ifd2ae22206b759380579b2abac55aae67b490022	|"																																																																																																																																																																																																																																																																																																																																																																		
"ircecho: add icinga process monitoring		root@kraz:~# /usr/lib/nagios/plugins/check_procs -c 1:1 -c python --ereg-argument-array '/usr/local/bin/udpmxircecho.py'	procs ok: 1 process with command name 'python'"	" regex args '/usr/local/bin/udpmxircecho.py' | procs=1;;1:1;0;		yes"	 it's not enough	" we also want to check if the bot	is actually connected to the server"	" but i think that to be in addition	to the basics like process check.		bug:t135948	change-id: i3b03e178f1643ba74a254db5c42b0115c34f3b84	|ircecho: fix init file dependency for service on systemd		bug:t123729	change-id: ie0d4b3e33597a02096895377bab7b51e55910178	|ircecho: make it start on systemd"	" add unit file		the ircecho bot did not start yet when on jessie/systemd"	"	due to lack of a unit file.		also"	 check directly if $::initsystem is systemd	" not even	if it's jessie or whatever.		bug:t123729	change-id: i224dcf02462adbb384141703f4a1abef89cd1908	|move from python-irclib to python-irc		python-irclib is an older version of the same python module now packaged	as python-irc in jessie and above (debian #718309)		fix the dependency and udpmxircecho.py when running on jessie and later.		bug: t133101		change-id: ic7054ba9b19fabcbc4fd2f81b7bdd53ecf4cfd48	|ircserver/irc_echo: use systemd provider if on jessie		on jessie: ""provider upstart is not functional on this host"""	"	use systemd when on jessie"	" for both irc server and irc bot.		bug:t123729	change-id: ia760e944ab47c68cbdd78bc093b258bfdbf8bb74	|"																																																																																																																																																																																																																																																																																																																																																									
"ircd: make check_ircd a critical (paging) icinga check		this would make the existing ""check_ircd"" check a critical	check which means it would start sending sms to ops.		this isn't a new check and has been there for a while"	"	it runs check_ircd from a nagios-plugins package which	is a perl script that connects to the ircd.	(i248dac3cacb82471cf "	" i21a3ca32fd425dd20 puppetized a	manual setup from before that afaict)		this change is in reaction to t135948 though the issue	was not actually that no ircd was running but rather that the	irc bot wasn't on the irc server after a restart of the vm and	of course that vms are freezing which required the restart.		so i'm not 100% sure if this would have been much more helpful"	"	it would have created pages on restart of the vm.		bug:t135948	change-id: i604cc7b014ffe800cb85e8e43f652a42bde8738f	|ircserver: add irssi on irc server for testing		on an irc server"	 also install an irc client	 irssi	"	to be able to test the server from localhost.		bug:t123729	change-id: ifec4cd84cedf105d249dc4752b8312f23859cc90	|ircserver: puppetize install of ircd-ratbox		the existing server argon has ircd-ratbox installed	but this wasn't puppetized.		the new server kraz did not get the package.		bug:t123729	change-id: i4f626556a915f2a57139ffcb4bd8115f20327a1f	|ircserver: fix dependencies for running on jessie		if on jessie and systemd we don't install the upstart init script	and this resource dependency breaks.  set it accordingly on each	system.		bug:t123729	change-id: i6bfcca985ef3ad3dcb79dafba525fea1cca6bb4d	|ircserver: add systemd unit file and conditionals		if on jessie"	 add a (missing) systemd unit file	" else add the existing	upstart init script.		bug:t123729	change-id: i629c2a2c00f8525813d79a0d3a33c859d22212b0	|ircserver/irc_echo: use systemd provider if on jessie		on jessie: ""provider upstart is not functional on this host"""	"	use systemd when on jessie"	" for both irc server and irc bot.		bug:t123729	change-id: ia760e944ab47c68cbdd78bc093b258bfdbf8bb74	|"																																																																																																																																																																																																																																																																																																																																																									
"mysql: fix spec		service_ensure -> ensure_service. function is from wmflib and has been	renamed at some point.  it is apparently not an issue unless one has the	service managed by puppet.		add wmflib/stdlib to .fixtures.yml		the tests are all broken... maybe we will want to abandon this module	specs and revisit later.		bug: t78342	change-id: i4f4226e9a16b7bbffdaa4e49f1fa38a93aad4da5	|"																																																																																																																																																																																																																																																																																																																																																																			
"fix mysql process monitoring and puppet run on pc		i100a7adb4211b7fc6f0e7a37471010d4371a795b introduced	a bug that caused puppet runs to break on mysql servers"	"	f.e. on pc2:		err: could not retrieve catalog from remote server: error 400 on server:	invalid parameter nrpe_command at	/etc/puppet/modules/mysql_wmf/manifests/init.pp:19		this should be nrpe::monitor_service for both of them		change-id: ib7411cadba127ca018bc5406ada4bf1e4643dd50	|"																																																																																																																																																																																																																																																																																																																																																																		
"set path in flock mylvmbackup subshell		bug: t127991	change-id: ic24376cb047a0c7e557a242ea43127a1541e9988	|add $socket parameter to mylvmbackup		bug: t127991	change-id: i4c1ae2ac6f46ca03d2f463e9f00b5fe7ca78c287	|use flock to make sure this only ever runs one mylvmbackup at a time		bug: t127991	change-id: i4d20aa79369338e79b0d09a365a251d064960316	|mylvmbackup prebackup hook needs to be executable		bug: t127991	change-id: i13863783030ed3829976fa18bc0291533c60c6b8	|add mysql_wmf::mylvmbackup define"	" use this for backups of analytics-meta mysql instance		mylvmbackup's prebackup hook allows us to define our own backup method.  this hook runs after	the lvm snapshot has been taken and mounted at $mountdir.  we rsync $mountdir to $dest at this	time.		bug: t127991	change-id: i6b0c6e0b819c837b8dbffc97be0c08ee4f66a452	|"																																																																																																																																																																																																																																																																																																																																																																		
"nagios_common: add command for using service_checker		since we have the need to monitor the functionality of services rather	than if they're just alive"	" we add service_checker to the central	monitoring host so that it can later be used to check the lvs ips.		bug: t134551	change-id: i1bf0c37c0cfed8934e4a9361ef97dc36605727bc	|icinga/ores: add check command definition"	" use nagios_common		bug:t122830	change-id: ib1d08ff2fdfa0a19f651511cb623bcbdd5daab9c	|"																																																																																																																																																																																																																																																																																																																																																																	
"nagios_common: fix optional parameter listed before required parameter		bug: t93645	change-id: i2b02c493f303ff2000e609635be660ce1e5257bf	|"																																																																																																																																																																																																																																																																																																																																																																			
"nagios_common: delay default evaluation of template()		change 9fc237ba098ed3404309a4f18b3be06b4bca978a changed the default of	the content parameter for the class nagios_common::contacts to a call	of template().  this causes puppet failures on the labs shinken server	where the class shinken includes the class nagios_common::contacts	with the parameter source"	" but neither content nor contacts.  in that	case"	" puppet tries to evaluate the default template and fails because	contacts is undef.		this change fixes the error by evaluating the default template only if	the parameters source and content are both undef.		bug: t111982	change-id: i88999b3807f715d2d5395b33a5e7d87a2168f9e7	|"																																																																																																																																																																																																																																																																																																																																																																	
"netops: monitor all asw/msw/psw as well		monitor uptime and juniper alarms on all switches as well.		bug: t83992	change-id: if7f862791261e47419b2013082592a06961484e7	|"																																																																																																																																																																																																																																																																																																																																																																			
"netops: monitor all asw/msw/psw as well		monitor uptime and juniper alarms on all switches as well.		bug: t83992	change-id: if7f862791261e47419b2013082592a06961484e7	|"																																																																																																																																																																																																																																																																																																																																																																			
"network: add $production_networks		this includes all the networks under the ""production"" realm (public +	private).		accomplish this through a puppet parser function that allows arbitrary	lookups into our network data structure"	 e.g. per realm	" per sphere	(public"	 private)	" per address family.		bug: t122396	change-id: i4369dfed0f0645ae37432cbfbe172e38330fa57e	|"																																																																																																																																																																																																																																																																																																																																																															
"dbtree: add http->https protocol redirect		add the standard snippet when a service is behind misc-web with	nginx terminating ssl but we want protocol redirects.		needs mod_headers and mod_rewrite to be loaded.	(actually noc already uses mod_rewrite and this should be puppetized)		bug:t90837	change-id: i29cbcd3633f8a319bf16aa3cb30d25d8c4e3ed67	|activate apache site for dbtree		let dbtree have its own apache site like other tools.	template added but did not activate it yet.		follow-up id442ab305e6b8bea		bug:t90837	change-id: i89df4e1389174c545e9f272a6a6a2fc34bc10707	|dbtree: add apache config"	" move to own docroot		move the dbtree tool into a separate virtual server and docroot.		this way we can be independent from mediawiki deploys"	" have it in	a separate repo and let pupppet deploy it.		bug:t90837	change-id: id442ab305e6b8bea387469fb4c087a39f797b045	|puppetize dbtree config file to connect to tendril		dbtree needs a config file with the db user and password	to connect to tendril. so puppetize the config file as a template.		noticed private repo already had class passwords::tendril with a	db_user and db_pass being used in mariadb module.		but on neon we use a different user"	" tendril_web (/srv/tendril/lib/config.php)	i took the user and password from there and added them to private	puppet repo as db_user_web / db_pass_web.		bug:t90837		change-id: id1e2309a24e3b9870a293ea59c66c6d9c8d799d5	|let puppet clone dbtree into noc/docroot/dbtree		dbtree existed in 2 separate locations and the code had diverged.		we moved it into a separate repo at operations/software/dbtree and	now we can let puppet git clone it from there.		bug:t90837		change-id: i31d4f34d57808b021dbddcce7c466624a7baf319	|"																																																																																																																																																																																																																																																																																																																																																																
"nodepool: adjust database configuration		a nodepooldb database has been created on m5-master.eqiad.wmnet. the	password is already in the private repo.		bug: t110693	change-id: i0ae5e8ee9d725e84849ec32942972a98c260d382	|nodepool: update apt pinning		our jessie servers no more included upstream jessie-backports. update	the pinning to jessie-wikimedia/backports.		bug: t110656	change-id: i61d99be3a735abe7f84dd5f4a9c63e3882839e25	|nodepool: stop using diskimage		diskimage is yet another image creation tool and we probably have	enough. moreover nodepool would require root access on the machine to	rebuild image periodically (t102281).		stop using diskimage-builder	switch to `base-image` which instructs nodepool to use the given image	name provided by the cloud provider (wmflabs)	change image name from ci-dib-jessie-wikimedia to ci-jessie-wikimedia		releng will build and upload the image manually for now.		bug: t102281	change-id: i27fb0bf5843bfad53ba610da948bc4935f0391df	|nodepool: provide openstack env variables to system user		set some os_* env variables in nodepool .profile"	" let us easily interact	with the openstack api since the cli utilities recognizes the variables.		using shell_exports() from puppet wmflib module which has been used in	our apache module already.		bug: t103673	change-id: ia912f444af2dd2a0fab3b257e01b317f880e69f9	|nodepool: preliminary role and config file		bug: t89143	change-id: icb2f9b9fe7dbef60f293870e223edfa849cf0951	|"																																																																																																																																																																																																																																																																																																																																																																		
"confd: create module		this module allows to define configuration files to be	monitored/generated via confd.		bug: t97974	change-id: icc0e87e274d2a53a3308f4411a98d16c37314f8e	|"																																																																																																																																																																																																																																																																																																																																																																			
"ntp: do not 'ensure latest'		bug:t115348	change-id: i1dcd62e517f72395eaafdfe83905bb16d19a90b8	|"																																																																																																																																																																																																																																																																																																																																																																			
"nutcracker: default verbosity to 4		it looks like we're lowering verbosity to 4 across mediawiki machines anyways.	also verbosity 5 has created problems in the past with filling disks given our	usage.		bug: t136078	bug: t139786	change-id: iaca2acde397ef276ab2636db9487fb8f349a0444|nutcracker: add an additional guard on the master version		bug: t131749	change-id: i690e601871e56dd87e94dcd3dc844de2437c4b30	|nutcracker: make configs notify service again		we had to disable this because of a bug in sorted_yaml"	" but it's safe to	re-enable now.		change-id: i8e2b5b9f6dc7a963f192a5ade3e292918943dc42	|"																																																																																																																																																																																																																																																																																																																																																																		
"ocg: don't try to use syslog group on jessie		if the initsystem is systemd"	" use systemd-journal as the group	to own the logdir"	 since "syslog" doesn't exist anymore	" it has	been replaced by rsyslog on jessie and this group appears to be the	closest to that afaict.		bug:t84723	change-id: ic4302ed8abf4d36b38374d2693c746ec9f5f94d3	|ocg: install the right font packages on jessie		font packages have been renamed between ubuntu trusty	and debian jessie. this is pretty much identical to the	setup for mediawiki in modules/mediawiki/manifests/packages/fonts.pp	that moritz recently adjusted.		bug:t84723	change-id: i05f923473217a0058bc3bd71becdd62dd0f70034	|ocg: make it work on systemd		if the init system is systemd"	" setup a systemd unit file	for the service and use the appropriate dependencies"	" otherwise	use the upstart setup just like before.		no change"	" except the resource name is a variable:		http://puppet-compiler.wmflabs.org/2743/ocg1001.eqiad.wmnet/		bug:t84723	change-id: i065b4ba42ed84a15d0545ff5af3eabd0016ef5a8	|decommission ocg1003.		uses the new decommission flag landed in t120077.		bug: t84723	change-id: ie167559b8d2714448f2cf39bcbe48ca618613938	|use fqdn for ocg hostnames.		bug: t133864	change-id: ib8a75b8194fc0832d87df918ac9fe09ffb40a67e	|ocg: temp hack to fix empty redis password"	" take 2		https://gerrit.wikimedia.org/r/#/c/176181/ didn't actually	have any effect at all. perhaps the bug is in our heira	backend"	" and it somehow sets the password to ''?		this patch should verify that.		change-id: i0df8f404f50617cf2acbba2925553c9369d43341	|ocg: temp hack to bypass hiera for redis passwords		just keeping ocg up until _joe_ wakes up.		bug: t76111	change-id: i60dd4846be5e6ab7bb728ea8860dda430b0cc4c9	|"																																																																																																																																																																																																																																																																																																																																																											
ocg: move defaults to class params	" rather than hiera		sane defaults should be in the class itself as default params.		bug: t91555	change-id: i7e7cd1a3a20611bb866e05418474a004da8ffa82	|"																																																																																																																																																																																																																																																																																																																																																																		
"openldap: allow configurable acls		ldap acls are highly dependant on the order of the rules being processed"	"	so for practical purposes it might also be necessary to prepend some rules	to the base acl set. but the currently version should be a sufficient base	to build upon. if needed"	" we can add the feature to add an erb template	for acls preceding the base set.		some of the current corp acls could be moved into an extra_acls option	in a later commit.		bug: t101299	change-id: i21adea32ef824e3d18992083b1ca42ae63611690	|create a define to register extra ldap schemas		also move the existing base ldap schemas to this mechanism.		bug: t101299	change-id: ic7c158386982e62d4b394002b4a6457e5d95b83a	|openldap: allow specifying an additional set of ldap schemas		bug: t101299	change-id: i376e2d320fc555cb069c27f9b18d7cd4af6879ad	|"																																																																																																																																																																																																																																																																																																																																																																	
"create a define to register extra ldap schemas		also move the existing base ldap schemas to this mechanism.		bug: t101299	change-id: ic7c158386982e62d4b394002b4a6457e5d95b83a	|"																																																																																																																																																																																																																																																																																																																																																																			
add sus-migrate	" yet another attempt to support cold migration.		bug: t109902	change-id: ia1371ecdd1252773c80b7dc6bc0407bdf4d3efa0	|set up a keypair for cold migration.		bug: t106145	change-id: iafd5161829c6098dd5a98608c678a77caefb2f03	|"																																																																																																																																																																																																																																																																																																																																																																		
"openstack: fix optional parameter listed before required parameter		bug: t93645	change-id: i6d3a11e5ca311c8525d5a9c48a3cd58827972c05	|"																																																																																																																																																																																																																																																																																																																																																																			
"openstack: fix optional parameter listed before required parameter		bug: t93645	change-id: i6d3a11e5ca311c8525d5a9c48a3cd58827972c05	|"																																																																																																																																																																																																																																																																																																																																																																			
"openstack: allow unprivileged users to access nova logs		we now allow to grant a specific group of users to own the log directory	/var/log/nova instead of 'adm'"	" which we do not need anyways as we do	not set use_syslog=true in nova confgurations.		bug: t133992	change-id: i5fe5575c5f57ebc5590ba7f756f9efd48d24d531	|"																																																																																																																																																																																																																																																																																																																																																																		
"openstack: fix optional parameter listed before required parameter		bug: t93645	change-id: i6d3a11e5ca311c8525d5a9c48a3cd58827972c05	|designate: no longer require paramiko		it wasn't reliable so i've replaced it.		bug: t119408	change-id: ie000ac0efcebba4457d39ae84db50c26104a6902	|ensure mdns and pool-manager services stopped on backup designate server.		bug: t115347	change-id: ic66f9ed87fe42661697ec46ade21aaafd7d682be	|openstack: add log-rotation for designate-mdns and designate-pool-manager logs		these should really be handled by the .deb for designate"	" but as we've	already established"	" the packager totally forgot that these two	services even existed.		bug: t114544	change-id: i80d69f3a373a2c9c1d215178453c23e815ef79f5	|use the custom nova_fixed_multi handler for sink.		this allows us to create multiple entries for each host:		<hostname>.<projectname>.eqiad.wmflabs	<hostname>.eqiad.wmflabs	+ a reverse entry		bug: t93928	change-id: id3fbc59784c5ca905b1b0651f2862f5c4f70db64	|"																																																																																																																																																																																																																																																																																																																																																																	
"openstack: fix optional parameter listed before required parameter		bug: t93645	change-id: i6d3a11e5ca311c8525d5a9c48a3cd58827972c05	|add a customized glance policy file.		this is a duplicate of the horizon glance policy.  all actions	are restricted to admins; users and project members can see	images but not modify them.		bug: t126765	change-id: i9cbb6f3199290afe2b6e9613f5a69b00b94bc04a	|rsync glance image files to the controller spare		bug t98226	change-id: i0be79f6d0ae94234444666a7ae8c33492e95fe41	|rsync glance image files to the controller spare		bug t98226	change-id: ie9027bfc17d8acbb89b3c8c7817e6ba0df1cb088	|move the glance image datadir into a puppet var.		bug t98226	change-id: i93f2d9310b34be9c586e44a2391cb95c36a8340c	|"																																																																																																																																																																																																																																																																																																																																																																			
"horizon tab for modifying instance puppet config		- display available roles with docs and params	- display applied roles with params	- display miscellaneous hiera settings	- edit miscellaneous hiera settings	- apply/removes puppet roles		bug: t91990	change-id: i7f064073ba93ffb53369117f30db14772b0ab2de	|"																																																																																																																																																																																																																																																																																																																																																																			
"openstack: fix optional parameter listed before required parameter		bug: t93645	change-id: i6d3a11e5ca311c8525d5a9c48a3cd58827972c05	|provision striker via scap3		provision the striker django web application using scap3:	* uwsgi service running striker	* memcached server for session cache storage	* nginx vhost for static content and reverse proxy to uwsgi	* django and uwsgi logs forwarded to logstash1003 as json datagrams	* local apache combined log style access log		configuration of the striker django app is done via hiera settings. the	role settings file at hieradata/role/common/striker/web.yaml contains	dummy values for the striker::uwsgi::secret_config hiera hash. the	actual values for these production secrets should be configured via	non-public hiera settings files.		bug: t141014	change-id: i855f9484f799a6847590b5d1196abf903114fa34	|openstack: add proxy panel files		bug: t129245	change-id: i785bf87a58c9361c9c92e51c2df64215665733fa	|add wmflabsdotorg credentials to horizon config		bug: t129245	change-id: i9fce4c30d008aaf2361a973036ab279a71244fad	|support totp auth for horizon		bug: t105690	change-id: i3ad1a48cda39f5878afcf5287a652d5a3f1a2b99	|horizon: stop using webserver::php5		bug: t118786	change-id: i8181497d4a4ab02830720858d52397669ed35dd7	|"																																																																																																																																																																																																																																																																																																																																																																			
make openstack juno the new default	" except for horizon.		bug: t110886	change-id: ib84959bf91783ed4708147da97324cd189f80dee	|"																																																																																																																																																																																																																																																																																																																																																																		
"openstack: fix indentation of =>		bug: t93645	change-id: iacb704ea2cc4309c3bfdcfdad32b19f5667e7590	|openstack: fix optional parameter listed before required parameter		bug: t93645	change-id: i6d3a11e5ca311c8525d5a9c48a3cd58827972c05	|support totp auth in keystone		bug: t105690	change-id: i5e067bcd326a345616139e307336e44591734aad	|openstack: added a custom keystone/policy.json		for now this is identical to the package-default policy; soon	we'll want to modify it.		bug: t104588	change-id: ia228d034b33cce3e50416759422660179ed0f91c	|"																																																																																																																																																																																																																																																																																																																																																																			
openstack: lint	" fix optional parameter listed before required parameter		fixes files:		api.pp"	" compute.pp and network.pp		bug: t93645	change-id: i09653a7eee75c81739c83a520c726a6775e7dbcc	|add process monitoring for nova services.		- scheduler	- conductor	- api	- network		bug: t90784		change-id: i5fcc001dafd9be4cf6df408c5f3aca989fdd2553	|"																																																																																																																																																																																																																																																																																																																																																																	
openstack: lint	" fix optional parameter listed before required parameter		fixes files:		api.pp"	" compute.pp and network.pp		bug: t93645	change-id: i09653a7eee75c81739c83a520c726a6775e7dbcc	|disable unprivileged user namespaces on labvirt nodes running 4.4 hwe kernels		by default trusty allows the creation of user namespaces by unprivileged users	(debian defaulted to disallowing these since the feature was introduced for security reasons)	unprivileged user namespaces are not something we need in general (and especially	not in trusty where support for namespaces is incomplete) and was the source for	several local privilege escalation vulnerabilities. the 4.4 hwe kernel for trusty	contains a backport of the debian patch allowing to disable the creation of user	namespaces via a sysctl"	" so disable to limit the attack footprint		bug: t142567	change-id: ib7fe25db280b12744aec5b0cf3bbd523ef5155a2	|labs kvm ssl cert monitoring: fix nrpe command		the nrpe command needs the full path to the certfile"	"	not just the cert name itself.		bug:t116332	change-id: i7c254f358c2929d8678730fa98c80aa0fe730880	|labs kvm ssl cert monitoring: fix it		this is a follow-up to i83ba82a25e8e87 which didn't	quite work yet because the plugin needs to be executed	locally where the certs are"	" so we need to turn this into 	an nrpe check.		and check_ssl.cfg is the config for check_ssl"	" a different plugin	from check_ssl_certfile.		bug:t116332	change-id: i44fb35f362898d178d11f300c23ff227e59de5ba	|add monitoring for the kvm ssl cert"	" labvirt-star		bug: t116332	change-id: i83ba82a25e8e877de0cb745b0d768e34fb784310	|improved the 'buggy kernel' error message for labvirt nodes.		change-id: i181e31844e368f29ca2b948d8faf286062f037bc	|rsync:  unquote booleans		bug: t113783	change-id: i80362002e2f665daac829bfef959714f09c5c3e8	|use fqdn for rsync allowed hosts.		bug: t109902	change-id: i79b0444ff79cc959ebacb549fb91b1e98da368bc	|exclude yet more kernels that break nova-compute.		bug t99738		change-id: ib4ac90101a31f6bf358b9a0774b8f71b5a041288	|set up a keypair for cold migration.		bug: t106145	change-id: iafd5161829c6098dd5a98608c678a77caefb2f03	|bugfixes for b13b9157 (dependencies)		change-id: i4f50b376a5addfeb2d6f004863963bcc29aac94a	|issue new certificate for virt-star		following the issuing of labvirt-star in	https://gerrit.wikimedia.org/r/204612 and the discussion in t96291"	"	issue a new certificate from wmf_ca_2014_2017 for virt-star		bug: t96291	change-id: i893e867c1dc539b708ca0d893af0ba958b473b45	|populate labvirtstar from wmf_ca_2014_2017		this is a followup commit for f90aa14 setting up a certificate from our	own internal ca and not the old defunct one		bug: t96291	change-id: i9f17270814b8de1e128b2143cb22fe13e03b8ef7	|icinga monitoring for nova-compute process.		bug: t90784	change-id: i50c777b692b812952f25e510b99b67cf20fc64b8	|openstack: transition nova to ssh::userkey		bug: t92475	change-id: i0d4e826e4ae1ae329bc946498e51bd1ee17d99e8	|"																																																																																																																																																																																																																																																																																																																																																											
"add process monitoring for nova services.		- scheduler	- conductor	- api	- network		bug: t90784		change-id: i5fcc001dafd9be4cf6df408c5f3aca989fdd2553	|"																																																																																																																																																																																																																																																																																																																																																																			
openstack: lint	" fix optional parameter listed before required parameter		fixes files:		api.pp"	" compute.pp and network.pp		bug: t93645	change-id: i09653a7eee75c81739c83a520c726a6775e7dbcc	|dnsmasq: drop beta cluster mobile public ip		the deployment-cache-mobile04 [10.68.18.110] instance has been deleted.	the mobile traffic is served by the text cache.		bug: t130473	change-id: i6e483b9e5dd5636d122f83da4df46f7865b3f91e	|beta: move deployment server		this patch is everything that was cherry-picked on beta's puppetmaster	in order to move the deployment server in beta from deployment-bastion to	deployment-tin.		* retitle git::clones inside beta::autoupdater"	" conflict with	  git::clones in scap::l10nupdate.		* don't mount nfs to deployment-tin since we want to get rid of nfs in	  beta.		* change all instances of ""deployment-bastion"" to ""deployment-tin""		* change all instances of the old ip (10.68.16.58) to the new ip	  (10.68.17.240)		bug: t126377	bug: t126568	bug: t126537	change-id: i5322b68dfe2e34d0a9170abd31a03f3afbda3907	|beta: swap caches to deployment-cache-*04"	" which is jessie		bug: t98758	change-id: i29615c497281c116c13adc99b0ecf00a44a6d3a5	|feed the puppet host ip directly to dnsmasq.		this will allow us to do lookups on hostnames like 'puppet' and	'puppet.eqiad.wmflabs' so that we don't have to hardcode virt1000	in vms and images.		bug t100317		change-id: i5d4d27e920621cc1da10c7657d9478acb7a5497d	|add process monitoring for nova services.		- scheduler	- conductor	- api	- network		bug: t90784		change-id: i5fcc001dafd9be4cf6df408c5f3aca989fdd2553	|labs: increase labnet1001 conntrack tables		there should also be monitoring of this and"	 ideally	" an	alert if the tables get overfull.		bug: t72076	change-id: i29a48adde2fc69a967d24c5ce3613632bc5ec371	|add ip mapping for toolserver.org		bug: t87086	change-id: ideb7afc3c46a350928decef13ef240365f23491f	|"																																																																																																																																																																																																																																																																																																																																																													
"add process monitoring for nova services.		- scheduler	- conductor	- api	- network		bug: t90784		change-id: i5fcc001dafd9be4cf6df408c5f3aca989fdd2553	|"																																																																																																																																																																																																																																																																																																																																																																			
"set up let's encrypt certificate for labtestwikitech		bug: t133167	change-id: i65f67dc404e713ad8545ebfb68f946abebf8c66b	|add public-wiki-rewrites to wikitech		bug: t99096	change-id: ie30064c67e232c11b6b98ef1292fcbd21fcfeaa6	|wikitech: add wikitech.m.wikimedia.org as server alias		to make https://wikitech.m.wikimedia.org work and not randomly show	the wikimedia portal page"	" add it as a server alias in the silver	/wikitech apache config. then add to dns in i158cd2ac0a344.		bug: t120527	change-id: if5e5264816b6d02ff040e44755dd249e98e0e804	|create /etc/mediawiki/wikitechprivatesettings.php		this will replace the wikitechprivateldapsettings.php file which	is currently managed by the deployment system.		this is moving so puppet can have closer control	over which file is installed where.		bug: t124732	change-id: ib14dff33bdd524b293725a1307371a22707828f7	|"																																																																																																																																																																																																																																																																																																																																																																		
"openstack: fix indentation of =>		bug: t93645	change-id: iacb704ea2cc4309c3bfdcfdad32b19f5667e7590	|increase the filehandle limit for rabbitmq in labs.		this is an impulsive change motivated by:		- i just saw a talk by some openstack admins full of horror stories	   of cryptic failure cases when the file handle limit is hit	- rabbitmq just now seized up and i had to restart it	- https://bugs.launchpad.net/fuel/+bug/1279594		change-id: ie7ce51964accc19e9389c20ef156287af65ab410	|"																																																																																																																																																																																																																																																																																																																																																																			
"openstack: add a check to see if tool labs instances are spread enough		bug: t101635	change-id: ic9c50e24a8b03a64070d98118fee8c1b5decbe59	|"																																																																																																																																																																																																																																																																																																																																																																			
"specify wgopenstackmanagerprojectid in wikitechprivatesettings.php		also adjust both wgopenstackmanagerprojectid and wgopenstackmanagerprojectname	so they can be specified in heira.		these settings are needed for openstackmanager to make keystone queries.		bug: t115029	change-id: ic8e9456be2170885fa6d7fa435b691a2ef47a981	|create /etc/mediawiki/wikitechprivatesettings.php		this will replace the wikitechprivateldapsettings.php file which	is currently managed by the deployment system.		this is moving so puppet can have closer control	over which file is installed where.		bug: t124732	change-id: ib14dff33bdd524b293725a1307371a22707828f7	|"																																																																																																																																																																																																																																																																																																																																																																			
"ores: install aspell-sv		bug: t131450	change-id: i8f4c455e8cd83087a4ec7e097f94e6f756b5672b	|"																																																																																																																																																																																																																																																																																																																																																																			
"ores: collapse the redis configs into one stanza		since redis::instance allows us to use map to override configs per redis	instance"	" take advantage of that to collapse the config in order to add	support for replication in an easier fashion. while at it add all the	usual settings we have for a jobqueue redis and for now apply them as is	on the cache as well. that is:		* use the standard /srv/redis directory	* name the db filename per instance	* enable aof	* effectively stop rdb by specifying an empty save	* increase defaults limits for replication	* apply latency improvents on fsync	* have slave be able to be used read-write	* don't stop writes on bgsave error		bug: t124200	change-id: i49f5995363fbc669625af1c8a512c0f43ad9fe9b	|ores: split cache and queue redis		bug: t121658	change-id: i1af00a72e28f5b0252d0e9bef4da98406ec7974c	|ores: stop using aof for redis persistance		the defaults already include rdf"	" so just use that. right now	we ended up using both rdb and aof"	" which isn't that useful	in our case.		bug: t121658	change-id: i56f99f487e35e443862fef3e13ec884242c05661	|"																																																																																																																																																																																																																																																																																																																																																																
"ores: define extra config for ores		bug: t143567	change-id: ic1f4b4936d95c77e2bfbba65bad1994524515ba1	|ores: add memory report to uwsgi		bug: t143081	change-id: i31fa386b171ad7b6db1e897f0c4e62fabf73310e	|ores: increase ores workers to 40 per node		bug: t143105	change-id: iacfa4b805b3c55fc9c24418548277171f0dedc60	|ores: enable uwsgi-specific statsd setup		bug: t141543	change-id: i935ada5745a37c94d2ace45e9dfb1cc349b74aab	|ores: increase number of workers to 32 / node		bug: t142361	change-id: i060bc566fb4756b481d8edf1d13d119fbdff8025	|ores: puppet changes for the refactor		it has been done in a backward-compatible way	bug: t141575		change-id: idb6fed027f1f06c60306200b1f47c8cb143bca11	|ores: allow specifying deployment method		since labs reuses the ores classes"	" allow it to specify the deployment	system for now to avoid scap3 bugs		change-id: i4dcba9ff08e39eba5b1e7877c1a5f52043cc65c8	|ores: changes for configs for the refactor		bug: t141575	change-id: i8dd347020323a1554602edd9aa1ce4d56166d51b	|ores: reduce the web workers to 3/4		right now"	" we have 192 workers in scb to handle ~16 req/sec	(max ~32 req/sec) and web workers are memory hungry.		we bring this up again once we have better memory handling.		bug: t139177	change-id: ic51c040fd148e5a3b7706bf7188c37d16084a0c4	|ores: move cors to uwsgi from nginx		bug: t137433	change-id: iae9698b69b50bc548c427796a78c0d5908f012da	|ores: add graphite settings		bug: t137367	change-id: i5e197abbedba94667c8877fbe82c9d183c17a055	|ores: add logformat		it adds user agent and removes req and app logging.		bug: t113754	change-id: ibdddf9c5647933c54b89d36d57a42f8bc25cfe50	|"																																																																																																																																																																																																																																																																																																																																																																	
"maps: improve water_polygons population		unfortunately there is no updating process for water_polygons. shp2pgsql	supports 4 modes of operation:		* drop and recreate	* create	* append only	* create only (no data)		of those"	" the only suitable for an updating process is the append mode since it	does not drop tables. tables in postgresql have rights and owners and	indexes associated with them and dropping them creates problems. to work	around this add a sed command to truncate the table right after the	transaction starts and before insertion happens. that way"	" the table	never gets recreated and indexes"	 owners	" grants stay the same and not	touched by a cron script.	also document the owner of table water_polygons	have the cron script executed only once a month as it makes no sense to	update more often than that.		bug: t109710	bug: t109530	change-id: i6e6ce9f03da98c163283c6b848db3a25c17b28ec	|"																																																																																																																																																																																																																																																																																																																																																															
"upgrade osm2pgsql to 0.90.0		0.90.0 is available in jessie backports.		i took eventlogging::service::service as an example of how we pull packages	from backports.		this new version has been tested on new maps2??? servers and show that initial	import and replication are working fine.		bug: t112423	depends-on: i0482b718a496cfabf647295b413bce5e2a453375	change-id: i13cc0a9566a32cdf8f4ce7a85e22bfdab1c50173	|"																																																																																																																																																																																																																																																																																																																																																																			
"explicitely set input reader format in osm2pgsql		latest version of osm2pgsql does not seem to autodetect format correctly	in our replicate-osm script. as the format is known in advanced"	" let's	make it explicit.		bug: t112423	change-id: i0482b718a496cfabf647295b413bce5e2a453375	|keep osmosis osm_expire files for a month		bug: t136577	change-id: ie84aaa60a7b2932cf274fcf2dcbbd449a3da86ed	|"																																																																																																																																																																																																																																																																																																																																																																		
"osm module		module to handle installation of osm2pgsql"	 osmosis	" and population and	syncing with from planet.osm		while at it enabled the hstore extension in postgres module	also upload the already populated grants for osmosis and fix a couple of	bugs in the postgresql module while at it		change-id: id3db056ace7a073831e90ebdaf47f6d9b2596ec5	|"																																																																																																																																																																																																																																																																																																																																																																	
"otrs: update loginlogo		use a better version of otrs login logo. amend the filename as well to	remove the default word for it.		bug: t125911	change-id: i4390594711c24bd7814db1ef87a516eae9d6ccc1	|otrs: fix a typo. s/default/wmf/		fix the typo in loginlogo_default.png and set it to loginlogo_wmf.png		bug: t125911	change-id: ief1d806d92eda180def138ff44bf37193625fa5c	|otrs: login wikimedia agentlogo file		populate a login logo made for wikimedia installation		bug: t125911	change-id: i943da0e6146c44181cd25c5ef66ce97bec8b1f2e	|otrs: background wikimedia agentlogo file		populate a background logo made for wikimedia installation		bug: t125912	change-id: i9de97b91dc8857243bea0d623dd9f92e6d9c9807	|"																																																																																																																																																																																																																																																																																																																																																																			
"package builder: ensure libdistro-info-perl is installed		move the requirement of libdistro-info-perl from the	contint::package_builder to ::package::builder.	the former call the latter so it should ensure backward compatibility.		bug: t142097	change-id: ied35bbf12ec89fc520d999678e54f95c3e6c0760	|package_builder: require_packages and make ubuntu-friendly		 - require_package to make sure it doesn't bite with other	   require_package('build-essential') declarations	 - on ubuntu"	" /usr/share/keyrings/ubuntu-archive-keyring.gpg	   is provided by ubuntu-keyring rather than ubuntu-archive-keyring	 - fail on ubuntu precise"	" as debian debootstrap scripts are missing	   (t111730)		bug: t111730	change-id: i4a1b4cad4f5bfcaa7ea10b4d254519256a228de9|package_builder: add lintian		lintian dissects debian packages and reports bugs and policy	violations. it contains automated checks for many aspects of debian	policy as well as some checks for common errors. should be helpful in	the package builder		change-id: i18559736c761eb768ef17ce7dfa27a82e2bb77ae	|"																																																																																																																																																																																																																																																																																																																																																																	
"parsoid: switch to scap3 deployments		bug: t120103	change-id: ic224bdecbdf4bb22924defd5383569fd37be89d5	depends-on: ibb82efe85c491850a4b0e8e2ead3bf4cd3d92077	|service::node: allow users to specify the logging name		some services use the same service::node definition in different	contexts"	" so allow them to specify different logging names and statsd	prefixes for them.		one such case is parsoid. in production"	 the 'parsoid' tag is used	" but	on ruthenium (acting as the round-trip host)"	" the logs and metrics ought	to have a different name. this patch also sets them to 'parsoid-tests'	for ruthenium.		bug: t141464	change-id: i16d0b03e119d659ef2c977948af2e5fd831fe853	|service::node: add git as deployment method		this is also used in role::parsoid::testing where we don't want	deployments via scap/trebuchet.		bug: t90668	change-id: idc1d352b6f5d4aabb499b8208114e78de35f9ab1	|parsoid: increase heap limit to 600 mb		bug: t90668	change-id: i65894df520f0511efa9957ec39166d944c761943	|parsoid: add role based on service::node"	" apply to two hosts		add a new parsoid class and role that use service::node to install	parsoid and run it from the service-runner based deployment		this is part of i3f4a5 that is being splitted in multiple commits		bug: t90668	change-id: i9236292664abaa649c8748ce3cf8d9ea237ffd1c	|"																																																																																																																																																																																																																																																																																																																																																														
"install arc on the jenkins slaves.		this is needed for phabricator (harbormaster) testing and integration		bug: t103127		change-id: id9bcbd3aa7bb13f4a4afe34e4b2754761f67b279	|"																																																																																																																																																																																																																																																																																																																																																																			
"phabricator: don't run phd on inactive server yet		phabricator is not aware yet that it is running in a cluster	environment"	 and as 20after4 explained to me	" if phd is running	on the inactive server it will currently start mirroring	repos which results in deleting refs from github which then	get recreated by phd on iridium.		so to avoid that puppet has to stay disabled on phab2001 and so that	we can apply other changes"	" we are disabling the phd service on the	inactive server using the same hiera setting that we used to	disable icinga smsing us and cronspam being created.		when cluster config is activated this will be changed again and phd	will run on both machines and the second one can help do jobs from the	job queue and take load off the main one.		bug:t137928	change-id: i09c6557753547db23843dcaa697899feb78fb26a	|rewrite rules for git.wikimedia.org		redirect gitblit urls to phabricator (diffusion) equivalents.		bug: t137224	change-id: i73873258a5f3acc21d0db4689dee2f18ca38aff6	|rewrite rules for git.wikimedia.org		redirect gitblit urls to phabricator (diffusion) equivalents.		bug: t137224	change-id: i67ad308f9e6373e5234cb2d83006457d6f467bf8	|keyholder key cleanup		* clean up the mess that is scap::target and keyholder::agent	* make ssh_agent_proxy look up keys by name instead of fingerprint	** this avoids needing to store fingerprints in puppet manifests	* password-protected key test is now optional and skipped on beta		bug: t132747		change-id: id298a3e0f12e31afd7ea83970e192330ffbd4243	|add a deployment source & target class for phabricator		this also adds support for key_content => secret('...') in	keyholder so that we can use a newer/cleaner pattern for	specifying the private key.		refs t125851		bug: t114363	change-id: i06eee23c338840fbba8ca81270f5ec0c81e02869	|remove auth.login-message - not supported by upstream anymore		bug: t116142	change-id: icc1db6719c76815d890169242925c3cce558254e	|fix phabricator basedir in vcs.pp / phabricator-ssh-hook		bug: t100519		change-id: id5412522705614a0f4eec32ca520370fe3c9309f	|ensure that phabricator/src/extensions exists		gotta have the directory created before adding symlinks there. this	should fix t104904.		bug: t104904	change-id: ic1ae541b99e87f17efba517065a88deb70509b37	|ensure that phabricator/src/extensions exists		gotta have the directory created before adding symlinks there. this	should fix t104904.		bug: t104904	change-id: i9b9e21a7b51f8a5c9edf797679dc03faf589aad1	|phabricator: enable the webserver to serve git repos		sudo bits are untested"	" roughly following upstream's suggested	config. the symlink i've already tested live and should work	as long as permissions get set right.		bug: t128	change-id: i1c6cd0eb868307a0e4c733e3ab680fd64d82a118	|encode the tag name to be path-safe - fixes t98411		bug: t98411	change-id: i03eebe89a31748cdc41cd60ea29d9baf6036accd	|phab: phd is not lsb compliant and we work around it		upstream has requested we file a bug for this and stated	that phd is not meant to be lsb complaint at the moment.	this will hopefully move us forward.		change-id: i485bc6a1f7ca73c4efc3096eafa04a40bf2957e6	|symlink for sprint extension static files.		fixes t91207	refs t89275		bug: t91207		change-id: i29904737b60000398662c51ef2faee64a22d6177	|redirector for bugzilla -> phabricator		this iteration is simply a test for fab-01.wmflabs to validate	that the redirect rules are working and that the maniphest lookup works.		change-id: i5acedd2186d296895baa0a1c1486012a7ce91660	|"																																																																																																																																																																																																																																																																																																																																																															
"symlink for sprint extension static files.		fixes t91207	refs t89275		bug: t91207		change-id: i29904737b60000398662c51ef2faee64a22d6177	|"																																																																																																																																																																																																																																																																																																																																																																			
"phab: properly disable crons for maintenance		follows up iab5e0fb5. commenting a cron doesn't remove it from the	system. these should not be running at the moment but they still are		bug: t138460	change-id: ide926d45b246a2f2c44d0db69ec3f0b928d4c41c	|phabricator: community metrics stats mail		create community metrics mail for phabricator	like it existed for bugzilla. reuse existing code	but with new queries from andre_		bug: t1003	change-id: i39d0323e0f1961a25cbb769d6dea6ef553017022	|"																																																																																																																																																																																																																																																																																																																																																																			
"logrotate: convert phd to logrotate::conf		bug: t127025	change-id: i1e35b24a021f02bcde52876f698bcfa8fec3ca25	|initialize phd directory		this directory is needed for the phd service to work and isn't	initialized in new installations.		bug: t96567	change-id: i5ecbeb3a72f72303a2ee64da92e3267aaafd4221	|"																																																																																																																																																																																																																																																																																																																																																																			
"set up redirects for bugzilla urls to redirect to phabricator.		this was already set up for testing in labs"	" this change applies	the same to production in preparation for the bugzilla migration.		refs t40		change-id: i32cbc453946c5262802ee720644a4460ae375a79	|"																																																																																																																																																																																																																																																																																																																																																																		
"reenable jobs running on the phabricator db slave		afaics"	" only the dump process was pending to be reenabled after	all others had been enabled previously.		bug: t138460	change-id: i8799dadf3b3a7e1ee92a0535688f96b58f62aba8	|disable crons using the phabricator db slave due to maintenance		bug: t138460	change-id: iab5e0fb5823532b158c649a4bfb78bb4755a61ac	|disable cron script on the phab slave due to maintenance		bug: t138460	change-id: i009a434d021a3522cef031967b6d776a5c6953cd	|remove git::install for phabricator/tools		this is part of scap deploy now		bug: t125851	change-id: ie5356a71960831c939ca0c6675087a8b7caaaccc	|phab: re-enable dump script		re-enables the dump script"	" but not all other crons	(that would be i495c3060c9131)		bug:t112135	change-id: if9a3a5dab72115200164f3d5bcf2b58dca2e5455	|"																																																																																																																																																																																																																																																																																																																																																																	
"fix phabricator basedir in vcs.pp / phabricator-ssh-hook		bug: t100519		change-id: id5412522705614a0f4eec32ca520370fe3c9309f	|ssh repo hosting support for phabricator.		just adds some basic prerequisites for phabricator to support hosting	git repos over ssh.		bug: t128		change-id: ic4460020204c7633be85b7fc00c8e336d5a314f5	|phabricator: enable the webserver to serve git repos		sudo bits are untested"	" roughly following upstream's suggested	config. the symlink i've already tested live and should work	as long as permissions get set right.		bug: t128	change-id: i1c6cd0eb868307a0e4c733e3ab680fd64d82a118	|"																																																																																																																																																																																																																																																																																																																																																																		
"add php5-curl package to phragile.		bug: t101235	change-id: i6c255fd0a9b3272cc886d934666f547d88ff8d53	|add phragile module.		this module configures a server to run a phragile instance	on labs.		bug: t101235	change-id: i3909fb4983426587e26f124a6326bb3ef23bffb3	|"																																																																																																																																																																																																																																																																																																																																																																			
"planet: only run updates when in active datacenter		add a parameter to set the active datacenter"	" then	only actively run feed updates in the active dc.	we don't want to run them in both places for no reason.		bug:t134507	change-id: ib9f1cc485e08f22e3d1c2d5bb2bf1a963e3c3f76	|planet: besides http_proxy need https_proxy too		some feed urls are https"	" not http. we need to also set	https_proxy for those to be proxied.		bug:t101730	change-id: iea104b5711c853c3ebb12626ad4a3cb3e43b0ca5	|planet: proxy through url-downloader to fetch urls		now that planet is on a ganeti vm we can't directly fetch	the external feed urls but have to proxy via url-downloader.wm.org	instead.		bug:t101730	change-id: i3587178ea3ead8cd1b382fe401e0b99a7a676f1f	|"																																																																																																																																																																																																																																																																																																																																																																	
"planet: only run updates when in active datacenter		add a parameter to set the active datacenter"	" then	only actively run feed updates in the active dc.	we don't want to run them in both places for no reason.		bug:t134507	change-id: ib9f1cc485e08f22e3d1c2d5bb2bf1a963e3c3f76	|planet: proxy through url-downloader to fetch urls		now that planet is on a ganeti vm we can't directly fetch	the external feed urls but have to proxy via url-downloader.wm.org	instead.		bug:t101730	change-id: i3587178ea3ead8cd1b382fe401e0b99a7a676f1f	|"																																																																																																																																																																																																																																																																																																																																																																		
"planet: install xslt-proc		description-en: xslt 1.0 command line processor		this is needed by planet to transform xml to html but it did not install it	via package dependencies.		info:planet.runner:loading cached data	sh: 1: xsltproc: not found	sh: 1: xsltproc: not found	sh: 1: xsltproc: not found	..		bug:t101730	change-id: ib9ca87db66e920cb255d2df1cb17c3d339774b50	|planet: remove feedparser.py		in the past this came with the planet-venus package and we had to apply	a manual fix. (t47806) so this was puppetized to apply our fix.		now"	 on jessie	" it apparently comes from the package ""python-feedparser"" instead.		so that caused failed dependencies on initial puppet run on a ganeti instance with jessie.		ropup31b8ed7c65ec5b54ba0ca0636ec8ee46ebb57bad		bug:t101730	change-id: i866d4b7ab0c7b477198299905a6bbc826a3097f6	|"																																																																																																																																																																																																																																																																																																																																																																	
"planet: stop using webserver::php5		bug: t118786	change-id: i5c124f5bc3dad1e5952cf4f59ccc5bdd382ece60	|"																																																																																																																																																																																																																																																																																																																																																																			
"puppetmaster: add role for puppetdb		bug: t142363	change-id: i5358e28edfa3cb448540f9b42e210829c0b35947	|basic role for sentry		depends on i7a0ce9e087dee1b95f916288785470b1423f5435	and i2cfacb4544f99df9f5e6c30dc2824e8b153e27b2		bug: t84956	change-id: i1207235f0ee97c253b1a1e9e2bfa89eb79665290	|"																																																																																																																																																																																																																																																																																																																																																																			
"postgresql: init database with puppet		database is initialized by postgresql package"	" but if we move the data	directory somewhere else"	" it needs to be initialized.		to avoid dependency cycle"	 pg-reload is not notified	" following the same	pattern used in postgresql::slave.		bug: t138092	change-id: i8b5031306bf714a4455d9291ad32b3e6ae650d61	|postgresql: init database with puppet		database is initialized by postgresql package"	" but if we move the data	directory somewhere else"	" it needs to be initialized.		bug: t138092	change-id: if7240e6d8ca20b5bbe11a4f411f43d7773433f00	|manage postgresql data dir with puppet		default data directory (/var/lib/postgresql/...) is created during	installation of debian package. in case we want to use another data directory"	"	like it is the case for maps servers"	" this directory is not created and need	to be managed by puppet.		minor refactoring of existing tests was done to ensure all tests are green.		bug: t138092	change-id: iec59cf0290a5ea34cdab26d3604b32a9edde4967	|"																																																																																																																																																																																																																																																																																																																																																											
"osm module		module to handle installation of osm2pgsql"	 osmosis	" and population and	syncing with from planet.osm		while at it enabled the hstore extension in postgres module	also upload the already populated grants for osmosis and fix a couple of	bugs in the postgresql module while at it		change-id: id3db056ace7a073831e90ebdaf47f6d9b2596ec5	|"																																																																																																																																																																																																																																																																																																																																																																	
"manage postgresql data dir with puppet		default data directory (/var/lib/postgresql/...) is created during	installation of debian package. in case we want to use another data directory"	"	like it is the case for maps servers"	" this directory is not created and need	to be managed by puppet.		minor refactoring of existing tests was done to ensure all tests are green.		bug: t138092	change-id: iec59cf0290a5ea34cdab26d3604b32a9edde4967	|"																																																																																																																																																																																																																																																																																																																																																																	
"manage postgresql data dir with puppet		default data directory (/var/lib/postgresql/...) is created during	installation of debian package. in case we want to use another data directory"	"	like it is the case for maps servers"	" this directory is not created and need	to be managed by puppet.		minor refactoring of existing tests was done to ensure all tests are green.		bug: t138092	change-id: iec59cf0290a5ea34cdab26d3604b32a9edde4967	|"																																																																																																																																																																																																																																																																																																																																																																	
"osm module		module to handle installation of osm2pgsql"	 osmosis	" and population and	syncing with from planet.osm		while at it enabled the hstore extension in postgres module	also upload the already populated grants for osmosis and fix a couple of	bugs in the postgresql module while at it		change-id: id3db056ace7a073831e90ebdaf47f6d9b2596ec5	|"																																																																																																																																																																																																																																																																																																																																																																	
"postgresql - allow multiple entries for the same user in pg_hba.conf		there are cases where we need multiple entries for the same user. for example	multiple slaves for replication are using the same user from different ips.		this change changes the contract of postgresql::user.		bug: t138092	change-id: i54c7acac16e359579365d0f2d748c2197f5bba70	|ensure correct order in postgresql::user		the password update exec can be applied first"	" in which case	puppet skips it since the user does not exist"	" and the user is	created with the wrong credentials. the next puppet run would	fix this"	" but anything depending on it will still break.		since the pass_set exec intentionally avoids depending on anything"	"	use a notify instead of a require to ensure ordering. this might	result in the command running twice"	" but there is no harm in that.		bug: t112228	change-id: i232ec321ec0525a4447f7629b658a58045375079	|"																																																																																																																																																																																																																																																																																																																																																														
"prometheus: add logging and rotation		bug: t126785	change-id: i64f7315872766291a7769599a4dbd491e29e3d1b	|prometheus: add init.pp class and expand documentation		bug: t126785	change-id: id3011e9403c636012ed055054de851b044c6f08b	|"																																																																																																																																																																																																																																																																																																																																																																			
"quote args parameters for trusty compatibility		1) this works on jessie too	2) i prefer to always overwrite the content of the file"	" as	   setting defaults will maintain the old content	3) we could do it on the role if this could have side effects"	" but	   i prefer it like this.		bug: t126757	change-id: iae58e4130dcd27746aae6c112226c56b588bb23f	|add /var/lib/prometheus to prometheus clients		bug: t126757	change-id: i41522334666be23a94af6c27d41c9f033ffb5a9a	|prometheus: add mysqld exporter		bug: t126757	change-id: ic9cccca83b41bfbd222f867155f2290db75a707f	|"																																																																																																																																																																																																																																																																																																																																																																	
"prometheus: add node_exporter support		the prometheus-node-exporter package provides node (machine"	" not the javascript	framework) level metrics.		bug: t92813	change-id: i6832dcf31b16d5d9dd876dcdd538269e4107a090	|"																																																																																																																																																																																																																																																																																																																																																																		
"prometheus: add server support		a prometheus::server define is provided that will install and setup a	prometheus server instance.		additionally"	" an example of labs deployment is provided with	role::prometheus::labs_project"	" currently running at	https://prometheus-staging.wmflabs.org/labs. the provided script will	autodiscover and scrape/poll metrics from all labs instances running	prometheus's node_exporter in the same project. (see also i6832dcf31)		bug: t126785	change-id: ia2a8f204ea0e3ac865a6ab8bd7b4af6c7915bcef	|"																																																																																																																																																																																																																																																																																																																																																																	
"prometheus: add init.pp class and expand documentation		bug: t126785	change-id: id3011e9403c636012ed055054de851b044c6f08b	|prometheus: add server support		a prometheus::server define is provided that will install and setup a	prometheus server instance.		additionally"	" an example of labs deployment is provided with	role::prometheus::labs_project"	" currently running at	https://prometheus-staging.wmflabs.org/labs. the provided script will	autodiscover and scrape/poll metrics from all labs instances running	prometheus's node_exporter in the same project. (see also i6832dcf31)		bug: t126785	change-id: ia2a8f204ea0e3ac865a6ab8bd7b4af6c7915bcef	|"																																																																																																																																																																																																																																																																																																																																																																	
"prometheus: add init.pp class and expand documentation		bug: t126785	change-id: id3011e9403c636012ed055054de851b044c6f08b	|prometheus: add nginx reverse proxy		introduce prometheus::web to put nginx in front of multiple prometheus	instances. each instance can be accessed internally at http://localhost:<port>	or externally at http://<address>/<instance_title>.		bug: t126785	change-id: i1025d613d5252b16b4ba1facc063c9897b5e9e86	|"																																																																																																																																																																																																																																																																																																																																																																			
"fix race in puppet::self (puppet.conf compilation)		sometimes puppet::self compiles the puppet.conf before removing the	10-main.conf in puppet.conf.d"	" causing the puppet.con to contain	both the main.conf and self.conf templates.		it should have only one or the other and this change should ensure	that the operations happen in the correct order (hopefully!)		bug: t132689	change-id: i4c08e6e74764a51f31d57c97d383c4dbb03f021a	|puppetmaster: use lang from /etc/default/locale"	" not c		this allows to create puppet manifests that use non-ascii characters"	"	both for puppetmasters that use passenger and ones that are running the	standalone service.		bug: t141242	change-id: i06d44679eb4601d1cb4e09756d7f8e823f9190da	|get rid of the ldap+yaml enc		it was a terrible idea		bug: t114063	change-id: i99642edfe438d1d49e151fc3915d5a27a8085b88	|base::certificates: add puppet's ca to the trusted store		also"	" add a puppet_ssldir() function to unify the logic to pick the	puppet ssl dir everywhere. actually apply it only where it will be	needed in the future.		bug: t114638	change-id: i40e6673811b76aad4ea85d8e7b257e078baa7a8a	|base::certificates: add puppet's ca to the trusted store		also"	" add a puppet_ssldir() function to unify the logic to pick the	puppet ssl dir everywhere. actually apply it only where it will be	needed in the future.		bug: t114638	change-id: i9e3fafb486c89a291395928f65531ace44c4caa0	|for cert names"	" use the fqdn instead of the ec2id.		this is safe now because fqdn includes project name"	" hence unique.		bug t95480		change-id: ifb387bffcb23c8fa9dcfba3fb602b2c97d8cb263	|ldap+yaml file puppet enc for self hosted puppetmasters		- allows reproducible cluster setups for a particular project -	  just specify roles in the enc and hiera appropriately"	" and	  with autosigning / etc"	" you can delete and re-create instances	  much more easily	- documents which instances have which roles - no need to hunt	  around in wikitech and guess which roles are really required	- makes it possible to version control which roles apply where	- can be re-used when horizon hits	- this only applies for self-hosted puppetmasters atm"	" due to	  performance considerations		bug: t85279	change-id: ic7c6c4492488f559ce00480c6cfc3e8710be1033	|"																																																																																																																																																																																																																																																																																																																																																									
"puppet: have a 'secret' repository for self hosted puppetmasters		- is read / writeable only by root	- can contain arbitrary data that isn't publicly made available	- not auto rebased anywhere		bug: t112005	change-id: i78e3d3347d0a56a5e5bbb70fa293683d44deb9b2	|"																																																																																																																																																																																																																																																																																																																																																																			
"get rid of the ldap+yaml enc		it was a terrible idea		bug: t114063	change-id: i99642edfe438d1d49e151fc3915d5a27a8085b88	|puppet: kill puppet::self::geoip		was a copy of puppetmaster::geoip with minor modifications"	"	said modifications rolled into parameters now		bug: t120159	change-id: ib5cefcc78803013044e6f9b13be7c7029a269e72	|labs: subscribe self-hosted puppetmaster to hiera.yaml changes		currently"	" the local puppetmaster service for self-hosted puppet	masters is neither subscribed to changes to nor requires	/etc/puppet/hiera.yaml.  this can cause the puppetmaster service to be	started before the hiera configuration is available"	" triggering	failures of hiera look-ups.		this change subscribes the puppetmaster service for self-hosted puppet	masters to the hiera configuration"	" thus postponing its start until	the hiera configuration is written and restarting it when the	meta-configuration changes.  this will not cause (unnecessary)	restarts of the puppetmaster service when the data files themselves	beneath hieradata/ are changed.		bug: t107205	change-id: i6786399d6713106a7eae693559cdf0116618e19d	|for cert names"	" use the fqdn instead of the ec2id.		this is safe now because fqdn includes project name"	" hence unique.		bug t95480		change-id: ifb387bffcb23c8fa9dcfba3fb602b2c97d8cb263	|ldap+yaml file puppet enc for self hosted puppetmasters		- allows reproducible cluster setups for a particular project -	  just specify roles in the enc and hiera appropriately"	" and	  with autosigning / etc"	" you can delete and re-create instances	  much more easily	- documents which instances have which roles - no need to hunt	  around in wikitech and guess which roles are really required	- makes it possible to version control which roles apply where	- can be re-used when horizon hits	- this only applies for self-hosted puppetmasters atm"	" due to	  performance considerations		bug: t85279	change-id: ic7c6c4492488f559ce00480c6cfc3e8710be1033	|"																																																																																																																																																																																																																																																																																																																																																										
"puppet_compiler: refresh module/role		since we rebuilt the puppet compiler"	" we refresh the puppet module as	well.		bug: t96802	change-id: ie3fc79eec44667f3bee4f5cbb9130f3826e94964	|puppet_compiler: resource attributes quoting and minor lints		bug: t91908	change-id: i25f6e1b36c7f0870d3ade3356792d22553d3521a	|"																																																																																																																																																																																																																																																																																																																																																																		
"puppet_compiler: add packages for labs realm		bug: t97081	change-id: i732bcb92d065bf60ead9f3213f8409a624d399ef	|puppet_compiler: refresh module/role		since we rebuilt the puppet compiler"	" we refresh the puppet module as	well.		bug: t96802	change-id: ie3fc79eec44667f3bee4f5cbb9130f3826e94964	|"																																																																																																																																																																																																																																																																																																																																																																		
"puppet_compiler: refresh module/role		since we rebuilt the puppet compiler"	" we refresh the puppet module as	well.		bug: t96802	change-id: ie3fc79eec44667f3bee4f5cbb9130f3826e94964	|"																																																																																																																																																																																																																																																																																																																																																																		
"puppet_compiler: refresh module/role		since we rebuilt the puppet compiler"	" we refresh the puppet module as	well.		bug: t96802	change-id: ie3fc79eec44667f3bee4f5cbb9130f3826e94964	|"																																																																																																																																																																																																																																																																																																																																																																		
"graphite: move to graphite1001		point relevant graphite producer/consumer to graphite1001. web-wise"	" migrate	only graphite.wikimedia.org for now.		bug: t85909	change-id: i63bf225aaf3fa7b4f0537125351c862584e4db8e	|"																																																																																																																																																																																																																																																																																																																																																																		
"puppetmaster: pass the group to git::clone		this is needed in order to have consistent status of files that have an	undefined owner in the puppet manifests.		bug: t98173	change-id: icda289f8484ad1bf1e285ec70611c280c7e5eb2c	|"																																																																																																																																																																																																																																																																																																																																																																			
"labs: fix puppetmaster::certcleaner for self-hosted puppet masters		for labs instances"	" no hiera configuration for labs_puppet_master is	defined.  this breaks puppetmaster::certcleaner which is included on	self-hosted puppet masters.		this change sets the default for the hiera look-up to the fqdn"	" thus	effectively making it a no-op as certcleaner.py already skips entries	with the fqdn.		bug: t106627	change-id: i30464f2dd69b1c92023e5829a14e669a2fec8414	|switch on salt auto_accept for labs.		rename puppetsigner.py certcleaner.py and remove	signing function.		bug: t102504	change-id: i2d2e7911d0d3f8cedf7f03b59e86f3855b65e68c	|"																																																																																																																																																																																																																																																																																																																																																																	
"puppetmaster: acls only in apache for puppet 3		due to a combination of unfixed bugs and lame syntax changes (only one	allow_ip directive allowed per directive in auth.conf) it is practically	impossible to enforce our acls via puppet configuration. that was	anyways redundant as we had acls in apache already"	" so we're removing	them right away.		change-id: ie7388f49493459e1259ab21cd181f3e94df24cd6	signed-off-by: giuseppe lavagetto <glavagetto@wikimedia.org>	|puppet: upgrade labs puppetmasters to version 3		this change will install puppet 3 on the labs puppet masters.		some config changes are needed in puppet 3 due to a long standing bug"	"	see http://docs.puppetlabs.com/guides/file_serving.html#ip-addresses		change-id: i7df5d8c4bf86cd24772cca02218d311bc6f72c0d	signed-off-by: giuseppe lavagetto <glavagetto@wikimedia.org>	|"																																																																																																																																																																																																																																																																																																																																																																	
"prometheus: monitor hosts in the current site		generate a list of hosts with their respective ganglia cluster for the current	site.		bug: t126785	change-id: i1963f9c3dd36323ddd8a2e0ec21ed7ce4eb8cad4	|"																																																																																																																																																																																																																																																																																																																																																																			
"puppet: kill puppet::self::geoip		was a copy of puppetmaster::geoip with minor modifications"	"	said modifications rolled into parameters now		bug: t120159	change-id: ib5cefcc78803013044e6f9b13be7c7029a269e72	|"																																																																																																																																																																																																																																																																																																																																																																		
"puppetmaster: fix indentation of =>		bug: t93645	change-id: i0eba3799f831a5a47f95c4f1ad42918b064db548	|puppetmasters: support multiple git masters		given we will have multiple frontends"	" we want all of them to act as git	masters so that we don't have a spof in case one fails.		this means:	- for the public repo"	" use a list of all servers from hiera to know	where to sync to	- for the private repo"	" both use that same list to push everywhere and	add a post-receive hook for the masters"	" so that the non-bare repo will	be reset to the new head.		bug: t143869	change-id: i4a1d900af511baa8b55d833e474c553a071cb76e	|puppetmaster: puppetize private post-commit hook		bug: t98173	change-id: i461fa4ee2e6cff5d42c451bf77c9d166cdd30507	|puppetmaster: correct puppetization of the private repo		the puppetization of the private repository was almost not existent"	"	and mostly broken.		do what follows:	- distinguish the private master from the other servers	- automatically init a repository in /srv/puppet"	" where the git data are	supposed to reside	- add a post-receive hook that syncs data to	/var/lib/git/operations/private	- rationalize installation of the git hooks	- set up /var/lib/git/operations/private to use /srv/puppet as a git	remote		the only detail that is still missing here is the post-commit hook on	the private master"	 which will be fixed in a new	" later commit.		bug: t98173	change-id: i95b9e56c3c79e20dfca564634799a1e48b5d5a52	|puppetmaster: perform git init in the private repo dir		while this would not copy over the content of the private repo"	" it will	allow us to push to it and also will prevent puppet from failing on its	first run.		bug: t98173	change-id: i1842586a7e7db8b6e520dfbe05cdba366f267a49	|git: create the log file for t128895		bug: t128895	change-id: i5d8d225ba5633dc8e53f2d55fceeab088ae3d761	|"																																																																																																																																																																																																																																																																																																																																																										
"puppetmaster: correct puppetization of the private repo		the puppetization of the private repository was almost not existent"	"	and mostly broken.		do what follows:	- distinguish the private master from the other servers	- automatically init a repository in /srv/puppet"	" where the git data are	supposed to reside	- add a post-receive hook that syncs data to	/var/lib/git/operations/private	- rationalize installation of the git hooks	- set up /var/lib/git/operations/private to use /srv/puppet as a git	remote		the only detail that is still missing here is the post-commit hook on	the private master"	 which will be fixed in a new	" later commit.		bug: t98173	change-id: i95b9e56c3c79e20dfca564634799a1e48b5d5a52	|"																																																																																																																																																																																																																																																																																																																																																															
"puppet: transition to ssh::userkey		bug: t92475	change-id: i342f2061467866844df4b6b9eee8039a1f29e808	|"																																																																																																																																																																																																																																																																																																																																																																			
"move puppet repository cherrypick counter to diamond collector		bug: t132997	change-id: ic8a846ed5cb4a49657db554b5eb74da42b9aeb35	|tools: add puppetmaster/client roles		- only applied on k8s related nodes	- deny access to all non-admins	- also make gitsync configurable so it can sync the	  puppet repositories more frequently		bug: t112005	change-id: i23e64a138a287fa1e69b4d2ce894cf95f1c22592	|puppetmaster: send cherry-picked commit count stats to statsd		bug: t87616	change-id: i27708e1e9e8c896b69db140ca7ff49318ea986ee	|"																																																																																																																																																																																																																																																																																																																																																																			
"puppetmaster: fix trailing whitespace found		bug: t93645	change-id: i387e75e3fe6b1ccc20d6e83e82d29b80c4b35e01	|puppetmasters: support multiple git masters		given we will have multiple frontends"	" we want all of them to act as git	masters so that we don't have a spof in case one fails.		this means:	- for the public repo"	" use a list of all servers from hiera to know	where to sync to	- for the private repo"	" both use that same list to push everywhere and	add a post-receive hook for the masters"	" so that the non-bare repo will	be reset to the new head.		bug: t143869	change-id: i4a1d900af511baa8b55d833e474c553a071cb76e	|puppetmaster::frontend: move vhost to role		also"	" use puppetmaster::web_frontend to define the main vhost.		bug: t143869	change-id: i77b40c30a0977a1da5edaac88735f96d7bf10b64	|puppetmaster: move vhost from passenger class		bug: t143869	change-id: i2589cd53c31df50a6639c53ebbd12d108e905ca3	|puppetmaster: add ca and ca_server settings to frontend		also"	" get the address of the ca_server from hiera if available.	this allows to have secundary frontends.		bug: t143869	change-id: i0c8a5efd48f547693c4da86ddfcda30213d0c670	|puppetmaster: brown paper bag fix		bug: t141242	change-id: ie6b57adb0e062c8be5a262112225d1efe4ee7ee4	|puppetmaster: use puppet 3.8 on jessie		since puppet 3.8 (3.8.5 to be exact) is available on jessie-backports"	"	let's move to that"	" so that a future transition to puppet 4 will be less	harmful.		bug: 141242	change-id: i5e86e17258417b6a4f29fd6f9ab98d234df8c5e3	|puppetmaster: puppetize private post-commit hook		bug: t98173	change-id: i461fa4ee2e6cff5d42c451bf77c9d166cdd30507	|puppetmaster: correct puppetization of the private repo		the puppetization of the private repository was almost not existent"	"	and mostly broken.		do what follows:	- distinguish the private master from the other servers	- automatically init a repository in /srv/puppet"	" where the git data are	supposed to reside	- add a post-receive hook that syncs data to	/var/lib/git/operations/private	- rationalize installation of the git hooks	- set up /var/lib/git/operations/private to use /srv/puppet as a git	remote		the only detail that is still missing here is the post-commit hook on	the private master"	 which will be fixed in a new	" later commit.		bug: t98173	change-id: i95b9e56c3c79e20dfca564634799a1e48b5d5a52	|puppetmaster: acls only in apache for puppet 3		due to a combination of unfixed bugs and lame syntax changes (only one	allow_ip directive allowed per directive in auth.conf) it is practically	impossible to enforce our acls via puppet configuration. that was	anyways redundant as we had acls in apache already"	" so we're removing	them right away.		change-id: ie7388f49493459e1259ab21cd181f3e94df24cd6	signed-off-by: giuseppe lavagetto <glavagetto@wikimedia.org>	|"																																																																																																																																																																																																																																																																																																																																																						
"fixups for labs password generation:		- include 'whois' package for mkpasswd	- the password dir needs to be owned by puppet so	  puppet can write the passwords there.		bug: t142216	change-id: ib0321e2aed1a7db4b94e74e0c6ad62c6515ba105	|labs: generate/store root passwords for instances		each project will have a root password that applies to all	project instances.  the password is stored in	/var/local/instance-root/passwords/$projectname on the labs	puppetmaster.		passwords are automatically regenerated if the file is missing"	"	so removing the password file is an easy way to reset passwords	if needed.		bug: t142216	change-id: ia9eb2bdb5879fe074ecb9e175f57f3849ff52821	|"																																																																																																																																																																																																																																																																																																																																																																		
"puppetmaster: move vhost from passenger class		bug: t143869	change-id: i2589cd53c31df50a6639c53ebbd12d108e905ca3	|puppetmaster: split backend and frontend vhosts		bug: t143869	change-id: i0dd87849245aa82085bc7623fa2fca31089f47bf	|puppetmaster: use lang from /etc/default/locale"	" not c		this allows to create puppet manifests that use non-ascii characters"	"	both for puppetmasters that use passenger and ones that are running the	standalone service.		bug: t141242	change-id: i06d44679eb4601d1cb4e09756d7f8e823f9190da	|puppetmaster::passenger: use sslcert::dhparam on jessie		since we're using a dh parameters file on jessie"	" we need to add it or	apache wouldn't be able to start.		bug: t98173	change-id: ib4674f8a7f85f6049c4ce6af4a8e20f0a6bea90d	|"																																																																																																																																																																																																																																																																																																																																																																
"puppetmaster: add role for puppetdb		bug: t142363	change-id: i5358e28edfa3cb448540f9b42e210829c0b35947	|"																																																																																																																																																																																																																																																																																																																																																																			
"puppetmaster: add role for puppetdb		bug: t142363	change-id: i5358e28edfa3cb448540f9b42e210829c0b35947	|"																																																																																																																																																																																																																																																																																																																																																																			
"puppetmaster: add role for puppetdb		bug: t142363	change-id: i5358e28edfa3cb448540f9b42e210829c0b35947	|"																																																																																																																																																																																																																																																																																																																																																																			
"puppetmaster: don't depend scripts on role::access_new_install		otherwise puppet breaks on the backends where we don't have new_install key deployed		bug: t103499	change-id: ie785fca4451da125d8ad2b065006afd790a4b020	|puppetmaster::scripts: include reimaging scripts only in production		we don't really need to include these on labs (self-hosted)	puppetmasters"	 as we don't reimage servers as we do in production	"	obviously. so both scripts are useless and they caused a breakage for	labs self-hosted puppetmasters.		bug: t103499	change-id: ifbab6d3dd1221fdefd76c13ff8705a8eea9a8280	|puppetmaster: make time to keep old reports for configurable		run cron job every 8 hours. not running more frequently because	there are a *lot* of report files in the prod puppetmasters	and find + rm could load disks up quite a bit		bug: 73472	change-id: ic45651fd5a9f80821398ccbb4f2f13155134ae88	|"																																																																																																																																																																																																																																																																																																																																																																	
"puppetmaster: fix indentation of =>		bug: t93645	change-id: i0eba3799f831a5a47f95c4f1ad42918b064db548	|puppetmaster::frontend: move vhost to role		also"	" use puppetmaster::web_frontend to define the main vhost.		bug: t143869	change-id: i77b40c30a0977a1da5edaac88735f96d7bf10b64	|webserver ca:  disable the quoted-bool lint check		this is for a value that's passed on to a config.		bug: t113783	change-id: i764f17965864812c373b409cc11b87322f035048	|"																																																																																																																																																																																																																																																																																																																																																																		
"puppetmaster::frontend: add vhost for fqdn		this will be used by clients using srv records; also only install the	old 'puppet' virtualhost on the primary frontend (the one that will be	managing the ca too).		bug: t143869	change-id: i8bc3e46c83171f461a5b8c059be1b70fbd52134b	|puppetmaster: add puppetmaster::web_frontend		this substitutes for now the class puppetmaster::web_test"	" but will be	then used elsewhere too. it also allows to define a ca server different	from the local host"	" so that remote puppetmaster frontends will be able	to use it too.		bug: t143869	change-id: i6f263620beb48ba051c2f85e487787649f9a3cc2	|"																																																																																																																																																																																																																																																																																																																																																																	
"pybal: fix optional parameter listed before required parameter		bug: t93645	change-id: i09cc342039205b3efa9ab2d511bca2abadf23445	|"																																																																																																																																																																																																																																																																																																																																																																			
logrotate: add centralized define	" apply to pybal		to avoid inconsistencies"	" a centralized logrotate::conf is created and	for now applied to pybal logrotate rule"	" which needed fixing and is	relatively not risky.		bug: t127025	change-id: i24c3e62caa8d09cba68424c4401e212bd1bc7bf6	|pybal: raise open files ulimit to 10240		bug: t110091	change-id: i01ba6e7cd4995eba0122d6b1dc30d63ea57e58a4	|"																																																																																																																																																																																																																																																																																																																																																																
"pybal: install monitoring		this creates both data collection in graphite via diamond and an nrpe	check for pools in a critical state.		bug: t102394	change-id: i0916d4a7659050c6b733cab93783c1db3d2aace7	|"																																																																																																																																																																																																																																																																																																																																																																			
"quarry: enforce https only at nginx level		rather than at uwsgi.		bug: t107627	change-id: i6e575b9cd6b4013a5734fde47995973008d080fd	|quarry: make quarry https only		bug: t107627	change-id: i74dd4a7f2b6088f9caeb10a362c6f0d1b34b58cc	|"																																																																																																																																																																																																																																																																																																																																																																			
"racktables: puppetize /srv/org/.. directory tree		when applying this role on a new server there are puppet	errors that this directory structure does not exist yet.		fix those puppet errors.		bug:t105555	change-id: i20715d9e9a905636a0db503e0df219cada3dbe66	|racktables: do not use webserver::php5		bug: t118786	change-id: iae2a0166148ab159f3dd994805c0693a6d9c20e1	|racktables: notify apache2 service		notifying the class introduces a dependency cycle:		error: could not apply complete catalog: found 1 dependency cycle:	(exec[ensure_present_mod_php5] => apache::mod_conf[php5] =>	class[apache::mod::php5] => file_line[racktables_php_memory] => class[apache]	=> package[apache2] => exec[ensure_present_mod_php5])		bug: t102092	change-id: ic927a45be5d7b13b5107a959b2aa3a0cd2bcbb42	|racktables: increase default php memory limit		bug: t102092	change-id: iacce6f1ffd43eee6797de4a74c9a6ba7b3a0a278	|make standard class's exim including behavior configurable		because some of the instances have their own exim classes	and labs includes 'standard' everywhere.		also kill standard-noexim"	" and setup role based lookups for	all current users of standard-noexim (except for	beryllium"	" which doesn't seem to have any roles at all)		bug: t86575	change-id: ibfa6e218735b5fa233ea50b2c1e2f641d712f9ca	|"																																																																																																																																																																																																																																																																																																																																																																	
"raid: add monitoring for hp controllers		this shamelessly uses the check that the debian system administration	team has written"	" along with its assorted sudo rules for hpssacli.		source: http://anonscm.debian.org/cgit/mirror/dsa-nagios.git		bug: t97998	change-id: i8922d077fe782325758725a68c350849e4d0de6d	|raid: setup multiple checks"	" one per each raid found		instead of calling check_raid once"	" and let it autodetect a single raid	controller (or always return ""ok"""	 if none found)	" tie our newly-created	fact with our newly-written check-raid support for arguments to setup	multiple nrpe checks"	" as (or if) needed.		this also removes support for /etc/nagios/raid_utility which was used as	a workaround for systems with multiple raid controllers"	" such as	labstore1001.		bug: t84050	change-id: id55187c725ec08e3c24f362729143a2182061726	|raid: vary package installation on the raid installed		installing all raid controller packages on all hosts is kind of a waste.	use the newly-written $raid fact to differentiate systems based on what	kind of raid controller they have installed and install the appropriate	packages.		bug: t84050	change-id: ia16b7ad8ad281640fe18fe77cb781d2480af54dc	|create raid module to hold raid monitoring checks		move check-raid.py and associated packages and definitions away from	base::monitoring::host and into a new ""raid"" class"	" init class of the	new ""raid"" module. not much win so far"	" more will follow.		bug: t84050	change-id: ifb3e9dd0ed78cf6fa7b37f576ae0302c668e966a	|"																																																																																																																																																																																																																																																																																																																																																										
"redis: manage our redis common config with puppet		at the moment"	" the main redis.conf file is unmanaged by puppet; this is	not a good idea as local hacks tend to persist and can create production	problems. create a common file which is not distro-specific"	" and make	redis.conf distro-specific and including the common file.		bug: t134400	change-id: i3fae31c4b1fc3278a1d24c82a635795318d13167	|redis: create /var/run/redis at boot		bug: t130147	change-id: i55a84b5c8e7be7a35c4d82cc6e2fa6682d0fc679	|redis: make redis::instance use base::service_unit		- so we get a different systemd service for each redis instance	  rather than a 'instance' of the same systemd service	- makes it easier to add upstart support in a followup commit		bug: t118704	change-id: i15c1aeeb41f2bb6b2af5d8916380febc5908c450	|add redis::instance		round off a series of patches to make the redis module capable of provisioning	multiple instances by finally a redis::instance resource"	" which uses systemd	unit template files to provide a concise and integrated mechanism for	provisioning and managing multiple redis instances.		temporarily provision two redis instances on pybal-test2003 in ganeti to test	this.		bug: t100714	change-id: i3419de0efd4123cb5e5a41e90d27b9f340383496	|dynamicproxy: firewall redis more restrictively		bug: t114209	change-id: i880ef010b50815fe53c44cd7f6025f621a135591	|"																																																																																																																																																																																																																																																																																																																																																																
"redis::instance: use specific aof/rdb file names by default		there is no point"	 and would be harmful	" not to have a default	per-instance aof/rdb file"	" as the common files are declaring a common	value for it.		bug: t134400	change-id: i5f2e00bed5a0d38f05302d4f64812642e782deae	|role::memcached: create cross-dc replication for sessions		in order to have all the defined shards (that we already use for ipsec	cross-connections) being replicated from the master dc to all the	others"	" we do the following:		* add a ""map"" parameter to redis::instance"	" allowing to add variable	  settings for different instances on the same node"	" much alike what we	  do with varnish::instance		* add a redis::multidc::instances function that"	" given the ip address of	  the server we're on"	" will extract which instances should be present on	  the machine and which host/port they must replicate from if the	  datacenter is not currently the primary.		bug: t126470	change-id: ibdcf252f8b0e6490db5998a57d83e578d8a1338a	|redis: add upstart support to redis::instance		bug: t118704	change-id: i10eed026a9a2bd99a14e575159d065541d75a8d0	|redis: make redis::instance use base::service_unit		- so we get a different systemd service for each redis instance	  rather than a 'instance' of the same systemd service	- makes it easier to add upstart support in a followup commit		bug: t118704	change-id: i15c1aeeb41f2bb6b2af5d8916380febc5908c450	|add redis::instance		round off a series of patches to make the redis module capable of provisioning	multiple instances by finally a redis::instance resource"	" which uses systemd	unit template files to provide a concise and integrated mechanism for	provisioning and managing multiple redis instances.		temporarily provision two redis instances on pybal-test2003 in ganeti to test	this.		bug: t100714	change-id: i3419de0efd4123cb5e5a41e90d27b9f340383496	|"																																																																																																																																																																																																																																																																																																																																																										
"role::memcached: create cross-dc replication for sessions		in order to have all the defined shards (that we already use for ipsec	cross-connections) being replicated from the master dc to all the	others"	" we do the following:		* add a ""map"" parameter to redis::instance"	" allowing to add variable	  settings for different instances on the same node"	" much alike what we	  do with varnish::instance		* add a redis::multidc::instances function that"	" given the ip address of	  the server we're on"	" will extract which instances should be present on	  the machine and which host/port they must replicate from if the	  datacenter is not currently the primary.		bug: t126470	change-id: ibdcf252f8b0e6490db5998a57d83e578d8a1338a	|"																																																																																																																																																																																																																																																																																																																																																														
"role::memcached: add cross-dc ipsec for the various shards		a new class redis::multidc::ipsec is introduced; it is able to set up	ipsec appropriately between specific redis machines in multiple	datacenters so that replication is supported. specifically for sessions"	"	we defined 1:1 shards between codfw and eqiad in nutcracker"	" so we can	expect the shards to be equally distributed in the two dcs. activating	replication will allow to have a disaster recovery option; however a	precondition to that is having an encrypted communications channel	between the dcs.		bug: t126470	change-id: i0a32f938baefa276d0346af06f97644c6ceaa2ce	|"																																																																																																																																																																																																																																																																																																																																																																	
"releases: add header for mediawiki release dir		adds custom header for the mediawiki releases directory"	"	as requested by legoktm.		bug:t125164	change-id: iab49bf7de987fb339173dddce52059ef24a205e1	|releases: fix path to custom html header		bug:t125164	change-id: if593bc50117b2f45024a90154ac5d9c59871e504	|releases: beautify directory index page		currently https://releases.wikimedia.org is just a default	directory index that isn't very pretty"	" make it look a bit nicer by:		- enable the ""fancyindexing"" option	  (https://httpd.apache.org/docs/2.4/mod/mod_autoindex.html#indexoptions.fancyindexing)		- add a custom header file"	" so we display ""wikimedia software releases""	  instead of just ""index of /""	  (https://httpd.apache.org/docs/2.4/mod/mod_autoindex.html#headername)		- use versionsort"	" so that f.e. mediawiki 1.12 will be listed after 1.8	  (https://httpd.apache.org/docs/2.4/mod/mod_autoindex.html#indexoptions)		- sort descending"	" so that latest versions are on top	  (https://httpd.apache.org/docs/2.4/mod/mod_autoindex.html#indexorderdefault)		- suppress displaying the header file itself with indexignore	  (https://httpd.apache.org/docs/2.4/mod/mod_autoindex.html#indexignore)		- suppress the html preamble"	" it's replaced with our custom header and we don't want invalid	  html with duplicate <html> tags	  (https://httpd.apache.org/docs/2.4/mod/mod_autoindex.html#indexoptions.suppresshtmlpreamble)		bug:t125164	change-id: i8bd65d33f4b036bc7a5ebb6f179688868e4073a8	|releases: load mod_headers for proto redirect		for the http->https redirect added in i3f98f832ad25386	we need to load mod_headers or ""invalid command 'header'"".		bug:t118787	change-id: i11b4ba3f269a862d09f9f47ca8c46f714ecb55dc	|releases: move from webserver module to apache module		the webserver module is deprecated and must die		bug: t118786	change-id: i05792f76d8a272e37cbc14c85369332f66a95d20	|install phpunit on release server		phpunit is requested on t94486 to be installed on release servers	to build mediawiki tarballs there (caesium).		unless we want to use a decicated build machine"	" this would imply	installing the package here in the role class for release machines.		bug:t94486	change-id: i15153c97c98754802aa1424df51222fd3004a130	|"																																																																																																																																																																																																																																																																																																																																																												
releases: don't define incomingdir	" duplicate def		the incomingdir is already created by the aptrepo module which	is used further below. like this there is a duplicate declaration.		file[/srv/org/wikimedia/reprepro/incoming] is already declared in file	/etc/puppet/modules/aptrepo/manifests/init.pp:139; cannot redeclare at	/etc/puppet/modules/releases/manifests/reprepro.pp:52		bug:t136793	change-id: i4a5812231f267d7fffae9dc34c21ceb39f01e31c	|upgrade elastic search to 1.7.5		updated the reprepro ""updates"" file entry for elasticsearch to the current	1.7 branch.		bug: t122697	change-id: i7fb1d0bd2650cf85cc59e3370c9bf6ae292ecaeb	|releases: add new distro jessie for mediawiki releases		add debian jessie as a new distro in preparation for t111225.		bug:t111225	change-id: i405973813ea2d73b0aa771c1de9560b554e484fb	|releases: install unzip in module"	" not on node level		do not install packages directly on nodes.		put it in reprepo::upload instead because role::releases::upload 	is on tin and the reason reedy asked for zip back then was for releases:		class role::releases::upload {	    class { '::releases::reprepro::upload': }	}		also"	" update rt ticket number to imported phab ticket.		bug:t83213	change-id: i4ec2a9e8ed237f061969faeeaced69772d4b5172	|"																																																																																																																																																																																																																																																																																																																																																																
"releases: switch reprepro upload server to bromine		releases.wm.org switched backends from caesium to bromine.	gotta also adjust the reprepro config here.		bug:t124261	change-id: if25984aa9b9550bdabc19365cbd437dc40b0cb1a	|"																																																																																																																																																																																																																																																																																																																																																																			
"add logrotate for reportupdater jobs		bug: t127327	change-id: i019401c0397ff33f3f1b61392a316fdf56d10976	|"																																																																																																																																																																																																																																																																																																																																																																			
"increase log verbosity on reportupdater cron jobs		today"	" the cron jobs use the default log level of reportupdater.	however"	" the logs are not informative enough. setting the -l flag	to 'info' increases the log verbosity enough to get query	execuion logs.		bug: t126058	change-id: ic108060873aab3d3b80dde738b36ebb5653642d1	|"																																																																																																																																																																																																																																																																																																																																																																	
"rt: loading mod_fastcgi wasnt puppetized		on the old rt server"	" mod_fastcgi and mod_fcgid	are installed but only mod_fastcgi is enabled.		it wasn't puppetized so the new server did not get it.		bug:t119112	change-id: i1823777b30c4e461985b560c58b0ae382358bbe2	|rt: install different apache config on new server		if we are on the new server on jessie"	" we are also going	to be behind misc-web. that means we are a backend and	only speak http and redirecting the same way as before	causes broken redirects. so remove all the *:443 and ssl part	in that case but leave existing setup unchanged.		since we know it's already apache 2.4 also removing the snippets	that added compat for apache 2.2.		bug:t119112	change-id: i6bf889390041ace6fc0dbdd1eda9b3d99d8cd0bf	|rt: include apache mod_headers		when applying rt role on new jessie host:		ah00526: syntax error on line 26 of	/etc/apache2/sites-enabled/50-rt-wikimedia-org.conf:	invalid command 'header'		mod_headers is loaded on old server but was not puppetized		bug:t119112	change-id: ic8248f1a6ce07edce3a8288b52c06bd51bbd3b4f	|rt: include apache mod rewrite		rewrite rules are being used in the rt apache	template but loading mod_rewrite in apache was not	puppetized"	" leading to errors when applying it on a new	machine.		bug:t119112	change-id: id2dc1c3f78106ceddcf5c7d0e3cdc460e9fbd8ef	|rt: don't include php"	" this is perl		as the comment says"	" ""why"" and the answer is most likely	just that we had ""webserver-php5"" as the default webserver class back	then"	" then you can see in git log how yuvipanda made it stop using that.		bug:t119112	change-id: i28136f0c510fb812b75d2453bf2cc6a90480891c	|rt: stop using webserver::php5		bug: t118786	change-id: i0bda3ff3886b360a22245de1aa3f9ea191de5028	|"																																																																																																																																																																																																																																																																																																																																																													
rt: do not ensure=>latest	"install perldoc		the comments claimed it was changed to ""present""	to avoid surprise upgrades"	" but the code said otherwise.		actually change it to 'present'.		also"	" add perl-doc package which it told me i needed	when i looked at docs on the new server.		bug:t119112	change-id: i8539519ee76cd69cab35888856620f4abf3bcbca	|"																																																																																																																																																																																																																																																																																																																																																																
"emit resource_change events from restbase.		set up eventlogging-service configuration for restbase to	enable resource_change in production		bug: t126571	change-id: i3388d446e48bb9c9441b30b1f436c308fe1c9b43	|restbase: override logging name		makes the `logging.name` restbase config overridable.  the default is	""restbase"" which should make this a noop in production.  for staging	it is configured as ""restbase-test"".		see also: https://gerrit.wikimedia.org/r/#/c/238431/ and	https://gerrit.wikimedia.org/r/#/c/273052/1		bug: t103124	change-id: i8290033b875f61645ff59b99ad25cb29a62771b7	|restbase: make statsd metric prefix configurable		bug: t112644	change-id: i1a4ace18d2b1a3f1227691ae054da1d588646302	|restbase: switch to service::node		there are many shared features between the restbase (w/	restbase::monitoring) class and the service::node define. so"	" instead of	duplicating work to keep all service-runner-based services updated"	" make	restbase use the service::node define as well.		bug: t118401	change-id: ica246d4e4a2c551ddf47334762a821536eccb307	|restbase: move to systemd unit file		also move to base::service_unit		bug: t103134	change-id: i96ab266bd7f5d857eaf61940e6107a0fd651e8d8	|restbase: set up the aqs public api		this patch exposes the analytics query service public api endpoints for	the global domain.		bug: t114830	change-id: i17ae36660ebb374e7062cd1e4ad4634ffddf66a7	|restbase: add global domain and mathoid spec		this ps introduces the global domain - wikimedia.org - which is to be	used by restbase as the domain holding data that does not pertain to any	specific domain (and that is shared amongst them). mathoid is a first	such use case: when making requests to mathoid"	" it doesn't matter which	domain is used"	" as the rendered formula does not change with a different	domain.		bug: t102030	change-id: i1311586d322320161af087c907f14df35a089e67	|restbase: ensure service present		prevent puppet from starting restbase"	" including after a reboot		bug: t103134	change-id: ib3e29d8e748e9a430bf1f80ef712c4548a1c8390	|add deploy-service user		these are changes necessary for service deployment to work inside beta.		deploy-service user	---		creates a deploy-service user that will be used to execute remote	commands on restbase nodes in the restbase remote deploy directory	(`/srv/deployment/restbase/deploy`).		this user is for restbase hosts		to ensure that this new user has full control over the remote repository	(currently deployed via trebuchet) the ownership of the remote directory	is modified via a puppet exec.		the exec call (as well as deployment via trebuchet) will	be removed as the scap3 project progresses.		deploy-service group	---		creates a deploy-service group which has access to the ssh-agent proxy	containing the private key for the servicedeploy user on restbase hosts.		the private key is in the private puppet repository (commit 3c2da005f0749b).	its passphrase is in the password store (commit 93ceafd744c).		this group is for tin.		change-id: i0a1da64658b4a9df4bb57897c890da105dba95d6	bug: t109862	|configure datacenter set		t76494 requires a list of datacenters to be configured (one of which must	contain the `localdc').		having this directive in place prior to the code that requires it won't hurt	anything (not having it after will).		bug: t76494	change-id: i3f8a0cf6c25800d5ffd5187c69062dbc60e40b81	|restbase: add mobileapps endpoints and back-end config		the mobileapps service is now available in production (as	mobileapps.svc.eqiad.wmnet:8888). this patch enables restbase to expose	its public endpoints and to forward any requests to the service itself.		note: this patch only enables restbase in proxy mode. a caching approach	is envisaged for later this week.		note: to be deployed in tandem with	i30cba0350ea3153df4a3712dc2b50efdf2f991cd		bug: t102130	bug: t92627	change-id: ib800009eacbc4c71e199a034bcdb14312ad817ae	|add basic alerts on restbase error rates and storage latencies		bug: t78514	change-id: ic4b083cfd49436013b7958e9424c8ff131095726	|adjust restbase / cassandra settings for deployment-prep		this patch adjusts the hiera settings needed to run restbase and	cassandra properly on the beta cluster.		bug: t91102	change-id: i48b1a139b02845c94c85cd231e54da67c62512c9	|"																																																																																																																																																																																																																																																																																																																																																														
"restbase: switch to service::node		there are many shared features between the restbase (w/	restbase::monitoring) class and the service::node define. so"	" instead of	duplicating work to keep all service-runner-based services updated"	" make	restbase use the service::node define as well.		bug: t118401	change-id: ica246d4e4a2c551ddf47334762a821536eccb307	|restbase: make the port fully configurable and change for aqs to 7232		there are some places where we make the assumption of restbase running	on port 7231. however"	 with the introduction of aqs	" we need to be able	to fully configure it"	" as they both can't have the same port due to lvs.		also: conftool-data/services/services.yaml defined zotero's port as 7231	for some reason. this patch changes it to 1969.		bug: t116245	change-id: ibaecb8f6ee5491362100fe32be2b65d755032b27	|restbase: make the domain to monitor configurable		up till now the domain to monitor for restbase was hard-coded into the	restbase::monitoring class. however"	" with the creation of the second	restbase cluster"	 aqs	" we need to be able to configure it (via hiera) as	not all restbase instances expose the same domains. concretely"	" aqs	exposes only the analytics.wikimedia.org domain.		bug: t115588	change-id: i1446fc10a76af6229f4858ee00df7d6ee5678f9f	|restbase: spec-based monitoring		bug: t94831	change-id: i28dfa6c601d7514dc40260b306ef8f655f79d83f	|add the services team to the contact list for restbase http checks		bug: t104656	change-id: i1d66a6f0b3f0a08f11b9c9286c6c356f0565a2b4	|"																																																																																																																																																																																																																																																																																																																																																										
"add hue and client classes (these got lost?)		also rename system::role and drop redundant 'role::' prefix.		hiera configs to come in next commit		bug: t109859		change-id: id3e61176f3ef101e0e8025b1f292de80d6a01d7c	|"																																																																																																																																																																																																																																																																																																																																																																			
"add the analytics contact group to hadoop/kafka related nrpe monitors.		the final goal is to raise awareness of kafka/hadoop issues directly on	the analytics irc channel.		bug: t125128	change-id: ifa5da3308225645620da45a8e3e4695ad82b531f	|include process and disk alerts for hive"	" oozie and mysql on analytics1003		also include a process alert for hue on analytics1027		bug: t133182	change-id: i6f9896e8bd8bf92322fa705b6892b59418380080	|analytics1015 -> analytics1003 migration		bug: t130840	change-id: if1f3334f23170e1f5c9603e292d332086bc01549	|update mariadb submodule with formatting change"	" set password to false		undef didn't work???		bug: t127991	change-id: ic2bd28b49ae8596bf43d0d9899e1f2d879beb705	|make mysql instance on analytics1015 the master		bug: t110090	change-id: ief6dce62699eed08014bc379bbd77057555161b0	|include hiera configuration for labs and prod analytics_cluster role		labs projects will still need to set specific hiera settings.		also update cdh module with grant class addition.		bug: t109859		change-id: ib2c82e144519ffb12536d5e4b320fc516399f7f7	|rename analytics_new to analytics_cluster		this will replace manifests/role/analytics/*		bug: t109859	change-id: i732641d44a746967ae1980c8dc5f584303fbd28e	|"																																																																																																																																																																																																																																																																																																																																																																	
add mysql_wmf::mylvmbackup define	" use this for backups of analytics-meta mysql instance		mylvmbackup's prebackup hook allows us to define our own backup method.  this hook runs after	the lvm snapshot has been taken and mounted at $mountdir.  we rsync $mountdir to $dest at this	time.		bug: t127991	change-id: i6b0c6e0b819c837b8dbffc97be0c08ee4f66a452	|"																																																																																																																																																																																																																																																																																																																																																																		
"add ferm rule for rsync daemon on analytics1002 in role::analytics_cluster::database::meta::backup_dest		bug: t127991	change-id: i6555fad6bf501423efa8e8ec22f44206fbfa8e32	|include rsync::server in role::analytics_cluster::database::meta::backup_dest		bug: t127991	change-id: i8bac52a455a269a47ff702f908539abd9eb38845	|add mysql_wmf::mylvmbackup define"	" use this for backups of analytics-meta mysql instance		mylvmbackup's prebackup hook allows us to define our own backup method.  this hook runs after	the lvm snapshot has been taken and mounted at $mountdir.  we rsync $mountdir to $dest at this	time.		bug: t127991	change-id: i6b0c6e0b819c837b8dbffc97be0c08ee4f66a452	|"																																																																																																																																																																																																																																																																																																																																																																		
"refactor zookeeper cluster config so it is available in all hiera scopes		zookeeper cluster config is now specified globally in common.yaml"	"	so any puppet manifest can lookup zookeeper host names"	" even if	if that cluster config is in a different datacenter.		this is needed in order to use kafka mirrormaker"	" as it needs	to look up the source kafka cluster's zookeeper config"	" in order	to mirror from it.		this should be a noop everywhere"	" but needs to be deployed very	carefully.		bug: t143232	change-id: i3ff2c33b473901380433080af255999b7e99fbca	|apply druid roles in production with initial (guesswork) configuration		bug: t131974	change-id: i76e37089896bfc6f3b8db875dc53a03b306b662f	|druid module and analytics_cluster role class		bug: t131974	change-id: i65cb169ac2701e754cd6a68e31903bcb25644290	|"																																																																																																																																																																																																																																																																																																																																																														
"druid module and analytics_cluster role class		bug: t131974	change-id: i65cb169ac2701e754cd6a68e31903bcb25644290	|"																																																																																																																																																																																																																																																																																																																																																																			
"druid module and analytics_cluster role class		bug: t131974	change-id: i65cb169ac2701e754cd6a68e31903bcb25644290	|"																																																																																																																																																																																																																																																																																																																																																																			
"apply new analytics_cluster role to analytics1027		bug: t109859	change-id: id7294fd7ffd076e7a44f6e8695cd4d5be6b85b12	|"																																																																																																																																																																																																																																																																																																																																																																			
"refactor zookeeper cluster config so it is available in all hiera scopes		zookeeper cluster config is now specified globally in common.yaml"	"	so any puppet manifest can lookup zookeeper host names"	" even if	if that cluster config is in a different datacenter.		this is needed in order to use kafka mirrormaker"	" as it needs	to look up the source kafka cluster's zookeeper config"	" in order	to mirror from it.		this should be a noop everywhere"	" but needs to be deployed very	carefully.		bug: t143232	change-id: i3ff2c33b473901380433080af255999b7e99fbca	|add the analytics contact group to hadoop/kafka related nrpe monitors.		the final goal is to raise awareness of kafka/hadoop issues directly on	the analytics irc channel.		bug: t125128	change-id: ifa5da3308225645620da45a8e3e4695ad82b531f	|apply new analytics_cluster role to analytics1027		bug: t109859	change-id: id7294fd7ffd076e7a44f6e8695cd4d5be6b85b12	|create refinery classes in analytics_cluster role"	" apply them to stat1002		also move the analytics::users class to the analytics_cluster::users class"	" this	is applied on stat1002 and analytics100[12]		bug: t109859	change-id: i4e8278e6efe1f7515f149a62f55330586a92a50a	|move hadoop memory settings for production above class declaration		bug: t109859	change-id: i36645b94938ee8068f36af9218b19ee7122ba957	|fix use of variable in analytics_cluster/hadoop/client.pp		bug: t109859	change-id: iaca044cedd53a360c4d2306696ed43d54d7c2696	|include hiera configuration for labs and prod analytics_cluster role		labs projects will still need to set specific hiera settings.		also update cdh module with grant class addition.		bug: t109859		change-id: ib2c82e144519ffb12536d5e4b320fc516399f7f7	|add hue and client classes (these got lost?)		also rename system::role and drop redundant 'role::' prefix.		hiera configs to come in next commit		bug: t109859		change-id: id3e61176f3ef101e0e8025b1f292de80d6a01d7c	|rename analytics_new to analytics_cluster		this will replace manifests/role/analytics/*		bug: t109859	change-id: i732641d44a746967ae1980c8dc5f584303fbd28e	|"																																																																																																																																																																																																																																																																																																																																																												
"add alerts and ferm rule for hadoop-hdfs-zkfc process		bug: t129838	change-id: i56274e1c118baa8e2c4c7bae2350af7eb307d09c	|rename analytics_new to analytics_cluster		this will replace manifests/role/analytics/*		bug: t109859	change-id: i732641d44a746967ae1980c8dc5f584303fbd28e	|"																																																																																																																																																																																																																																																																																																																																																																			
"rename analytics_new to analytics_cluster		this will replace manifests/role/analytics/*		bug: t109859	change-id: i732641d44a746967ae1980c8dc5f584303fbd28e	|"																																																																																																																																																																																																																																																																																																																																																																			
"add the analytics contact group to hadoop/kafka related nrpe monitors.		the final goal is to raise awareness of kafka/hadoop issues directly on	the analytics irc channel.		bug: t125128	change-id: ifa5da3308225645620da45a8e3e4695ad82b531f	|add alerts and ferm rule for hadoop-hdfs-zkfc process		bug: t129838	change-id: i56274e1c118baa8e2c4c7bae2350af7eb307d09c	|move hadoop_user_posix_groups setting to eqiad/cdh/hadoop/users.yaml		bug: t109859	change-id: id091274bcad12244376691c2acfa2d8555f73fc3	|add hue and client classes (these got lost?)		also rename system::role and drop redundant 'role::' prefix.		hiera configs to come in next commit		bug: t109859		change-id: id3e61176f3ef101e0e8025b1f292de80d6a01d7c	|rename analytics_new to analytics_cluster		this will replace manifests/role/analytics/*		bug: t109859	change-id: i732641d44a746967ae1980c8dc5f584303fbd28e	|"																																																																																																																																																																																																																																																																																																																																																																			
"add the analytics contact group to hadoop/kafka related nrpe monitors.		the final goal is to raise awareness of kafka/hadoop issues directly on	the analytics irc channel.		bug: t125128	change-id: ifa5da3308225645620da45a8e3e4695ad82b531f	|add alerts and ferm rule for hadoop-hdfs-zkfc process		bug: t129838	change-id: i56274e1c118baa8e2c4c7bae2350af7eb307d09c	|add hue and client classes (these got lost?)		also rename system::role and drop redundant 'role::' prefix.		hiera configs to come in next commit		bug: t109859		change-id: id3e61176f3ef101e0e8025b1f292de80d6a01d7c	|rename analytics_new to analytics_cluster		this will replace manifests/role/analytics/*		bug: t109859	change-id: i732641d44a746967ae1980c8dc5f584303fbd28e	|"																																																																																																																																																																																																																																																																																																																																																																			
"add the analytics contact group to hadoop/kafka related nrpe monitors.		the final goal is to raise awareness of kafka/hadoop issues directly on	the analytics irc channel.		bug: t125128	change-id: ifa5da3308225645620da45a8e3e4695ad82b531f	|apply new analytics_cluster role to analytics1027		bug: t109859	change-id: id7294fd7ffd076e7a44f6e8695cd4d5be6b85b12	|create refinery classes in analytics_cluster role"	" apply them to stat1002		also move the analytics::users class to the analytics_cluster::users class"	" this	is applied on stat1002 and analytics100[12]		bug: t109859	change-id: i4e8278e6efe1f7515f149a62f55330586a92a50a	|rename analytics_new to analytics_cluster		this will replace manifests/role/analytics/*		bug: t109859	change-id: i732641d44a746967ae1980c8dc5f584303fbd28e	|"																																																																																																																																																																																																																																																																																																																																																																	
"refactor zookeeper cluster config so it is available in all hiera scopes		zookeeper cluster config is now specified globally in common.yaml"	"	so any puppet manifest can lookup zookeeper host names"	" even if	if that cluster config is in a different datacenter.		this is needed in order to use kafka mirrormaker"	" as it needs	to look up the source kafka cluster's zookeeper config"	" in order	to mirror from it.		this should be a noop everywhere"	" but needs to be deployed very	carefully.		bug: t143232	change-id: i3ff2c33b473901380433080af255999b7e99fbca	|analytics_cluster: add wrapper script for beeline		bug: t116123	change-id: ib0d8b243749da99b046c16d89ba63e99c13bd38e	|apply new analytics_cluster role to analytics1027		bug: t109859	change-id: id7294fd7ffd076e7a44f6e8695cd4d5be6b85b12	|create refinery classes in analytics_cluster role"	" apply them to stat1002		also move the analytics::users class to the analytics_cluster::users class"	" this	is applied on stat1002 and analytics100[12]		bug: t109859	change-id: i4e8278e6efe1f7515f149a62f55330586a92a50a	|rename analytics_new to analytics_cluster		this will replace manifests/role/analytics/*		bug: t109859	change-id: i732641d44a746967ae1980c8dc5f584303fbd28e	|"																																																																																																																																																																																																																																																																																																																																																												
"add the analytics contact group to hadoop/kafka related nrpe monitors.		the final goal is to raise awareness of kafka/hadoop issues directly on	the analytics irc channel.		bug: t125128	change-id: ifa5da3308225645620da45a8e3e4695ad82b531f	|include process and disk alerts for hive"	" oozie and mysql on analytics1003		also include a process alert for hue on analytics1027		bug: t133182	change-id: i6f9896e8bd8bf92322fa705b6892b59418380080	|apply new analytics_cluster role to analytics1027		bug: t109859	change-id: id7294fd7ffd076e7a44f6e8695cd4d5be6b85b12	|add hue and client classes (these got lost?)		also rename system::role and drop redundant 'role::' prefix.		hiera configs to come in next commit		bug: t109859		change-id: id3e61176f3ef101e0e8025b1f292de80d6a01d7c	|rename analytics_new to analytics_cluster		this will replace manifests/role/analytics/*		bug: t109859	change-id: i732641d44a746967ae1980c8dc5f584303fbd28e	|"																																																																																																																																																																																																																																																																																																																																																																		
"rename analytics_new to analytics_cluster		this will replace manifests/role/analytics/*		bug: t109859	change-id: i732641d44a746967ae1980c8dc5f584303fbd28e	|"																																																																																																																																																																																																																																																																																																																																																																			
"add the analytics contact group to hadoop/kafka related nrpe monitors.		the final goal is to raise awareness of kafka/hadoop issues directly on	the analytics irc channel.		bug: t125128	change-id: ifa5da3308225645620da45a8e3e4695ad82b531f	|include process and disk alerts for hive"	" oozie and mysql on analytics1003		also include a process alert for hue on analytics1027		bug: t133182	change-id: i6f9896e8bd8bf92322fa705b6892b59418380080	|apply new analytics_cluster role to analytics1027		bug: t109859	change-id: id7294fd7ffd076e7a44f6e8695cd4d5be6b85b12	|add hue and client classes (these got lost?)		also rename system::role and drop redundant 'role::' prefix.		hiera configs to come in next commit		bug: t109859		change-id: id3e61176f3ef101e0e8025b1f292de80d6a01d7c	|rename analytics_new to analytics_cluster		this will replace manifests/role/analytics/*		bug: t109859	change-id: i732641d44a746967ae1980c8dc5f584303fbd28e	|"																																																																																																																																																																																																																																																																																																																																																																		
"add the analytics contact group to hadoop/kafka related nrpe monitors.		the final goal is to raise awareness of kafka/hadoop issues directly on	the analytics irc channel.		bug: t125128	change-id: ifa5da3308225645620da45a8e3e4695ad82b531f	|include process and disk alerts for hive"	" oozie and mysql on analytics1003		also include a process alert for hue on analytics1027		bug: t133182	change-id: i6f9896e8bd8bf92322fa705b6892b59418380080	|include hiera configuration for labs and prod analytics_cluster role		labs projects will still need to set specific hiera settings.		also update cdh module with grant class addition.		bug: t109859		change-id: ib2c82e144519ffb12536d5e4b320fc516399f7f7	|add hue and client classes (these got lost?)		also rename system::role and drop redundant 'role::' prefix.		hiera configs to come in next commit		bug: t109859		change-id: id3e61176f3ef101e0e8025b1f292de80d6a01d7c	|"																																																																																																																																																																																																																																																																																																																																																																		
"set file.encoding=utf-8 for all java processes in analytics cluster		bug: t128607	change-id: i05f989c369f909ed8b31301a7cdf5a8681bd5a4a	|add role::analytics_cluster::java class		bug: t109859	change-id: i632802c11df68221e1188cdd26d858838475a9ed	|"																																																																																																																																																																																																																																																																																																																																																																			
"rename analytics_new to analytics_cluster		this will replace manifests/role/analytics/*		bug: t109859	change-id: i732641d44a746967ae1980c8dc5f584303fbd28e	|"																																																																																																																																																																																																																																																																																																																																																																			
"rename analytics_new to analytics_cluster		this will replace manifests/role/analytics/*		bug: t109859	change-id: i732641d44a746967ae1980c8dc5f584303fbd28e	|"																																																																																																																																																																																																																																																																																																																																																																			
"add the analytics contact group to hadoop/kafka related nrpe monitors.		the final goal is to raise awareness of kafka/hadoop issues directly on	the analytics irc channel.		bug: t125128	change-id: ifa5da3308225645620da45a8e3e4695ad82b531f	|include process and disk alerts for hive"	" oozie and mysql on analytics1003		also include a process alert for hue on analytics1027		bug: t133182	change-id: i6f9896e8bd8bf92322fa705b6892b59418380080	|apply new analytics_cluster role to analytics1027		bug: t109859	change-id: id7294fd7ffd076e7a44f6e8695cd4d5be6b85b12	|add hue and client classes (these got lost?)		also rename system::role and drop redundant 'role::' prefix.		hiera configs to come in next commit		bug: t109859		change-id: id3e61176f3ef101e0e8025b1f292de80d6a01d7c	|rename analytics_new to analytics_cluster		this will replace manifests/role/analytics/*		bug: t109859	change-id: i732641d44a746967ae1980c8dc5f584303fbd28e	|"																																																																																																																																																																																																																																																																																																																																																																		
"rename analytics_new to analytics_cluster		this will replace manifests/role/analytics/*		bug: t109859	change-id: i732641d44a746967ae1980c8dc5f584303fbd28e	|"																																																																																																																																																																																																																																																																																																																																																																			
"remove analytics-deploy user/group since they will be created by scap:target.		bug: t129151	change-id: id16bab21926b307f95faabe5682d4d44131fa9c7	|add the deploy-analytics user/group to the refinery role		bug: t129151	change-id: i9c8d34ca2184b2d948d5fff70e036d188480d563	|clone mediawiki/event-schemas in refinery role		bug: t126501	change-id: ib35557bc84f15a0026d11d580d1244d9be3e2c85	|use project-$labsproject in labs for /var/log/refinery		bug: t109859	change-id: i746fa9ffb7098fa3fe6b322a84424e7177ffe2f8	|create refinery classes in analytics_cluster role"	" apply them to stat1002		also move the analytics::users class to the analytics_cluster::users class"	" this	is applied on stat1002 and analytics100[12]		bug: t109859	change-id: i4e8278e6efe1f7515f149a62f55330586a92a50a	|"																																																																																																																																																																																																																																																																																																																																																																	
"update camus job to use new check_jar		refinery packaging has changed. camuspartitionchecker is now in	refinery-camus jar instead of refinery-job jar. this update reflects	that change.		bug: t142717		change-id: ibd8a82b82572fa2539dd369b838f32a5daf6904d	|kafka config: add config functions		up until now"	" kafka configuration has been held in	role::kafka::(main|analytics)::config"	" which are mostly copy/pastes of	each other. this patch consolidates them by introducing two functions:	kafka_config and kafka_cluster_name"	" the former using the latter. this	allows us to elegantly get the config by simply using the cluster prefix	we are interested in:		  $analytics_conf = kafka_config('analytics')	  $main_conf      = kafka_config('main')		bug: t130371	change-id: i206b54d10e8188e7775d3f6621c8d4cc60e0d269	|add camus job for importing eventbus events		bug: t125144	change-id: i36267e321cb8cd5de7d0818991321cdce04bbe3a	|apply new analytics_cluster role to analytics1027		bug: t109859	change-id: id7294fd7ffd076e7a44f6e8695cd4d5be6b85b12	|create refinery classes in analytics_cluster role"	" apply them to stat1002		also move the analytics::users class to the analytics_cluster::users class"	" this	is applied on stat1002 and analytics100[12]		bug: t109859	change-id: i4e8278e6efe1f7515f149a62f55330586a92a50a	|"																																																																																																																																																																																																																																																																																																																																																														
"remove pagecounts-[raw|all-sites] related code		the new pageviews dataset is available"	" therefore pagecounts-raw	and pagecounts-all-sites are deprecated. data already synced on dumps	server is kept"	 as well as already generated html files	" but code	to rsync new data and re-generate html files is deleted.		bug: t130656	change-id: i7a8da8e1248511c379259bd03474109323c9a7a7	|create refinery classes in analytics_cluster role"	" apply them to stat1002		also move the analytics::users class to the analytics_cluster::users class"	" this	is applied on stat1002 and analytics100[12]		bug: t109859	change-id: i4e8278e6efe1f7515f149a62f55330586a92a50a	|"																																																																																																																																																																																																																																																																																																																																																														
create refinery classes in analytics_cluster role	" apply them to stat1002		also move the analytics::users class to the analytics_cluster::users class"	" this	is applied on stat1002 and analytics100[12]		bug: t109859	change-id: i4e8278e6efe1f7515f149a62f55330586a92a50a	|"																																																																																																																																																																																																																																																																																																																																																																	
create refinery classes in analytics_cluster role	" apply them to stat1002		also move the analytics::users class to the analytics_cluster::users class"	" this	is applied on stat1002 and analytics100[12]		bug: t109859	change-id: i4e8278e6efe1f7515f149a62f55330586a92a50a	|"																																																																																																																																																																																																																																																																																																																																																																	
create refinery classes in analytics_cluster role	" apply them to stat1002		also move the analytics::users class to the analytics_cluster::users class"	" this	is applied on stat1002 and analytics100[12]		bug: t109859	change-id: i4e8278e6efe1f7515f149a62f55330586a92a50a	|"																																																																																																																																																																																																																																																																																																																																																																	
create refinery classes in analytics_cluster role	" apply them to stat1002		also move the analytics::users class to the analytics_cluster::users class"	" this	is applied on stat1002 and analytics100[12]		bug: t109859	change-id: i4e8278e6efe1f7515f149a62f55330586a92a50a	|"																																																																																																																																																																																																																																																																																																																																																																	
remove analytics-wmde from analytics cluster	" improve docs around analytics cluster users		i didn't realize that addshore needed access to webrequest (private) data with this user.	doing so would a. require extra permission from ops and b. is not possible right now"	"	since puppet will not allow us to add analytics-wmde to the (real user)	analytics-privatedata-users group.		i will manually remove the analytics-wmde(-users) stuff from analytics cluster namenodes.		bug: t141525	change-id: if8e8a3174ff5777ff843bf3b9626680968943fbe	|add analytics-wmde user to role::analytics_cluster::users		bug: t141525	change-id: i822a2f9f1f3e9d77295a279fdadd8f96ea073dfc	|create refinery classes in analytics_cluster role"	" apply them to stat1002		also move the analytics::users class to the analytics_cluster::users class"	" this	is applied on stat1002 and analytics100[12]		bug: t109859	change-id: i4e8278e6efe1f7515f149a62f55330586a92a50a	|"																																																																																																																																																																																																																																																																																																																																																															
"aptrepo: make owners of incoming dir configurable		for different uses (apt.wm vs. releases.wm) we have	different users/groups owning the incoming directory.		now that we use the same module for them we need to make	it configurable too"	" for uploads to work like before.		this is not changing the actual owner/group from how it was	before"	" it's restoring carbon and bromine as they were.		bug:t132757	change-id: i62ecadc06c98b0a4e9e8b755a930e6c5cb38a206	|aptrepo: set separate incoming conf for releases		after we made this configurable"	" make the actual ""default""	config used on releases the default and set a separate one	for the config of apt.wm.org on carbon to make uploads from tin	work again as before.		bug:t132757	change-id: i83b49fbb5a83208483532f9018dc1319c3dbd0c2	|aptrepo: mv wikimedia-specific distributions file to role		this file is specific to wikimedia and should be realized in the role	class not the module itself.		when"	 like on bromine	 aptrepo::distribution is used	" this creates a	conflict and puppet error.		it could also be replaced with aptrepo::distribution instead but	some options are missing for now.		bug:t132757	bug:t136793	change-id: ib98634da6745278ab0948ddb14aaf69434fc93a4	|"																																																																																																																																																																																																																																																																																																																																																													
"archiva: migration class to rsync data to new host		add temporary rsync setup and ferm rule to copy data	from titanium to meitnerium to replace archiva with a	jessie server.		copy directly from and into /var/lib/archiva. applied	on target server. so this allows pushing to the new	server and does not influence the old server.		bug:t123725	change-id: i5cae60e20f2f92e3af5ee55c99f4a207dd22c5ca	|"																																																																																																																																																																																																																																																																																																																																																																			
remove otrs backups from dbstore1001	" create them on es2001 instead		the whole mariadb role (actions that are not part of the mariadb	module iself"	" but deployment-specific) have to be refactored on its	own db_maintenance module"	" but we will keep them here for now.		stop taking backups for otrs on dbstore1001"	" that has no disk space	left. start taking them on es2001"	" which has plenty of space and is	close to m2 slave (db2011). a tarball will be created from that	host and stored temporarily on es2001"	" until the bacula director	gets it and then they are deleted.		this will free up to 1tb of space from dbstore1001"	" while	maintaining the functionality of the backups on a separate host.	this is not ideal"	" but this is supposed to be temporary until	otrs space issues are fixed or disks for dbstore1001 are bought"	"	whatever happens first.		bug: t131705	change-id: i4c352856e391fc7829ab87e77d130eec9f8ebd7e	|define backup for contint		bug: t80385	change-id: iec88d1139f27e15a7856bca59c637bbb42895aaf	|add a new backup set to backup openldap databases and enable on serpens		run slapcat on to create a snapshot of the ldap data in the pre-run script	and a cleanup script after the backup run.		bug: t120919	change-id: i2ba5436a356b729b22dd8d7dcb5c64f11cb36e1f	|"																																																																																																																																																																																																																																																																																																																																																										
"bast1001: rsync home dirs back from tungsten		bug:t123721	change-id: ic9ac09b7578279b3de1dcf258a889d476c27e070	|rsync bast1001 home dirs to osmium"	" temp for upgrade		bug:t123721	change-id: ia45622f073e593416bd3d91a778948b9e9eb11f8	|"																																																																																																																																																																																																																																																																																																																																																																		
"beta: move deployment server		this patch is everything that was cherry-picked on beta's puppetmaster	in order to move the deployment server in beta from deployment-bastion to	deployment-tin.		* retitle git::clones inside beta::autoupdater"	" conflict with	  git::clones in scap::l10nupdate.		* don't mount nfs to deployment-tin since we want to get rid of nfs in	  beta.		* change all instances of ""deployment-bastion"" to ""deployment-tin""		* change all instances of the old ip (10.68.16.58) to the new ip	  (10.68.17.240)		bug: t126377	bug: t126568	bug: t126537	change-id: i5322b68dfe2e34d0a9170abd31a03f3afbda3907	|"																																																																																																																																																																																																																																																																																																																																																																		
"cache_maps: switch to file storage backend		the deprecated_persistent storage backend is making varnish crash	relatively often. cach_misc is already using -s file"	" use file backend	storage on maps as well.		bug: t142810	change-id: i82edae903471f96762240cd60a635a008066755d	|add 'varnish_version' salt grain		bug: t131499	change-id: ib50ac2829ef0cbcb494d62a7ca84205c5fc2075b	|varnish+statsd: refactor classes"	" move rls to text-only		this removes the r::c::statsd and r::c::statsd::frontend classes"	"	as they are now just wrappers to include other classes and only	used in single locations.  the included logging::xcps and	logging::statsd stanzas are moved to r::c::base (functional	no-op)"	" and logging::rls is moved to r::c::text (it was previously	deployed to all clusters"	" but only the text cluster hosts load.php	at this point in time).		the pointless varnishrls daemons on non-text clusters will need	manual stops for this to take full effect.		bug: t131353	change-id: i0d92220a458c774f32d06b248543e8cd5be85dfc	|maps vcl forward-port to varnish 4		this patch uses a boolean hiera attribute"	 varnish_version4	" to	distinguish between varnish 3 and varnish 4 vcl syntax.		with these changes applied"	" varnish 4 starts properly on machines	deployed with role cache::maps.		bug: t124279	change-id: iee05d5f712093c0a1d939e74a340627982979404	|r::c::config: remove has_ganglia		this just mirrors standard::has_ganglia (even in labs!)"	" so switch	all references to that and delete it.		bug: t127484	change-id: ic063d5dbc95be8df92fc7bdd38774b16b055040d	|caches: remove backend_scaled_weights		these weightings are currently managed in confd data.  i was	tempted to preserve them as commentary as well"	" but we're only	using these as true runtime differentials within a cluster in one	case today: esams cache_text.  even that case will go away once we	do t125485		bug: t125485	bug: t127484	change-id: i8c04c9a2802e6d0e8f6b1981e3370ba03a1e6662	|2layer: remove dead nodes storage_size		bug: t125486	change-id: ief46d18401ac05f5488f0ac527d415af732d4865	|fix up varnish director-level retries		non-chash directors get default retries == num_backends.	chash directors get some math to give them a relatively-small	value with 99% probability of hitting all backends while searching	for a healthy one.		bug: t99839		change-id: i15d66e6f14198c365317590a136b755ca4994ce2	|bugfix (i hope) for labs breakage from 3d2fadd5		change-id: i0fbb9d8ad9417f528c235dc2a29a509b41ea46ec	|"																																																																																																																																																																																																																																																																																																																																																									
"cache: vary statsd_server with hiera		on the beta cluster the varnish caches have a few process that reference	the prodution statsd host:		/usr/local/bin/varnishstatsd --statsd-server=statsd.eqiad.wmnet \	    --key-prefix=varnish.eqiad.backends	/usr/local/bin/varnishxcps --statsd-server=statsd.eqiad.wmnet	/usr/local/bin/varnishrls --statsd-server=statsd.eqiad.wmnet		update the role::cache::* classes to use the generic hiera key 'statsd'	which is defined with:		  hieradata/labs.yaml:# labs statsd instance	  hieradata/labs.yaml:statsd: labmon1001.eqiad.wmnet:8125	  hieradata/common.yaml:# main statsd instance	  hieradata/common.yaml:statsd: statsd.eqiad.wmnet:8125		the three python scripts are in modules/varnish/files they recognize the	'host:port' format and default the port to 8125.		the change for production would be:		- --statsd-server=statsd.eqiad.wmnet	+ --statsd-server=statsd.eqiad.wmnet:8125		such a change could have impacted an icinga check_proc commands that are	defined in modules/varnish/manifests/logging/ "	" but they are invoked	with '-a' and the name of the process"	" eg they don't look at the extra	arguments.		bug: t116898	change-id: i51c754fbec577a73e258922d4fc2054e9b1a854a	|role::cache::text: handle url shortener requests		given how painful it is to mangle the http host header in apache and the	relative ease of doing this at the varnish layer"	" we perform request	masking at the varnish backend when making a request to the appservers.		bug: t133485	change-id: i286e6c2a50bf4735c3fc1ac629aff3f3c35f314a	|varnish+statsd: refactor classes"	" move rls to text-only		this removes the r::c::statsd and r::c::statsd::frontend classes"	"	as they are now just wrappers to include other classes and only	used in single locations.  the included logging::xcps and	logging::statsd stanzas are moved to r::c::base (functional	no-op)"	" and logging::rls is moved to r::c::text (it was previously	deployed to all clusters"	" but only the text cluster hosts load.php	at this point in time).		the pointless varnishrls daemons on non-text clusters will need	manual stops for this to take full effect.		bug: t131353	change-id: i0d92220a458c774f32d06b248543e8cd5be85dfc	|r::c::config: move to hieradata		this also changes the structure a little bit to accommodate future	things.  note that 'misc' cluster never had r::c::configuration	data; it hardcodes all of its (eqiad-only) backends in misc.pp.	will update it to match when we start going after misc-cluster	backends for codfw support.		bug: t127484	change-id: i278c87cc6f7f76d7e98490454762a224e531bff4	|purging: do not vcl-filter on domain regex		... because we're now splitting the multicast addresses	themselves"	" which is far more efficient.		needs to wait on deploy of mediawiki config change: i8799f7b30		bug: t116752	change-id: i2d2078e7240f16040ecee0fc65059955a0f8d13d	|move zerofetcher to r::c::base		because we'll be making the xff-decoding logic that uses its	netmapper databases universal to all the clusters...		bug: t89177	bug: t109286	change-id: i7ad6478758582a7e2fa3ed26fd57847a202dcfed	|standardize hiera-overridable class/config params		we had a few different ways of accomplishing the same thing here"	"	and increasingly many of these variables are likely to need to	cross into sibling classes during refactors as well.  this	standardizes the pattern as:		1. class param in r::c::base	2. defaulted for prod in base.pp param list	3. labs override of r::c::b::foo in hieradata/labs.yaml	4. per-cluster copy to $vcl_config as-needed	5. always accessed from vcl_config.fetch() in templates	6. no default-argument in the fetch() call		the affected variables standardized under this scheme are now:	zero_site	purge_host_only_upload_re	purge_host_not_upload_re	static_host	upload_domain	bits_domain	top_domain		this will likely change again at a later point"	" but it's a better	place to be for the moment in terms of factoring.		bug: t96847	bug: t109286	change-id: i6351b0897aaa7ac53ca4482037ff28c31cb9851c	|"																																																																																																																																																																																																																																																																																																																																																									
"r::c::instances: frontends also listen on :3127		bug: t107236	change-id: ifd7b9976e7d94b067a34925128c89d4670bbfb83	|varnish: jemalloc tuning for frontend caches		this should reduce the virtual and resident waste/overhead when	configuring frontend malloc storage with large fractions of total	memory.  note that the chunk size could probably use further	tuning per-cluster"	" but the values in this patch are reasonable	conservative estimates from some basic experimentation/research.		bug: t135384	change-id: ie0bdcbf6a0290b76131a6a43c3013d72b653100f	|varnish: fix puppet in deployment-prep		there are no deployment-prep instances in codfw"	" so we currently get undefined	going in here which breaks everything. labtest is hosted in codfw but it's not	integrated with labs and has no working network.		bug: t129270	change-id: ia0b006d82a9f8d6f159ea121288a09d58603137d	|maps vcl forward-port to varnish 4		this patch uses a boolean hiera attribute"	 varnish_version4	" to	distinguish between varnish 3 and varnish 4 vcl syntax.		with these changes applied"	" varnish 4 starts properly on machines	deployed with role cache::maps.		bug: t124279	change-id: iee05d5f712093c0a1d939e74a340627982979404	|caches: remove backend_scaled_weights		these weightings are currently managed in confd data.  i was	tempted to preserve them as commentary as well"	" but we're only	using these as true runtime differentials within a cluster in one	case today: esams cache_text.  even that case will go away once we	do t125485		bug: t125485	bug: t127484	change-id: i8c04c9a2802e6d0e8f6b1981e3370ba03a1e6662	|r::c::instances - hack around cache_maps eqiad-only		bug: t109162	bug: t127481	change-id: ic9bf2d8e5ac3397dd6563f21b241ac2215110be1	|role::cache::instances: all backends get all backends		this removes the tier distinction: all backend varnish instances	get backend definitions for the applayer and all remote backend	caches (currently just eqiad+codfw) which aren't themselves.  vcl"	"	however"	 still explicit hardcodes the use of eqiad over codfw	" and	the use of the applayer backend only in tier1.		bug: t127481	change-id: ie413fea3e492c5d11bc77e13eed7179f09b62811	|role::cache::instances: create and use for maps		bug: t127481	change-id: ic2d55a333c0f1334c63e99e09ba80204051928d6	|"																																																																																																																																																																																																																																																																																																																																																										
"kafka config: add config functions		up until now"	" kafka configuration has been held in	role::kafka::(main|analytics)::config"	" which are mostly copy/pastes of	each other. this patch consolidates them by introducing two functions:	kafka_config and kafka_cluster_name"	" the former using the latter. this	allows us to elegantly get the config by simply using the cluster prefix	we are interested in:		  $analytics_conf = kafka_config('analytics')	  $main_conf      = kafka_config('main')		bug: t130371	change-id: i206b54d10e8188e7775d3f6621c8d4cc60e0d269	|update the varnishkafka module with latest changes.		the varnishkafka module now ships a basic rsyslog configuration"	"	allowing us to remove it from the files/varnish directory.		bug: t129344	change-id: ib78554bd9026f14ffb809832ac198f8b4283101c	|move varnishkafka apt pinning to role definition		we want to make sure the pinning file for varnishkafka on varnish 3	instances is present before the package is installed.		bug: t122880	change-id: ia9a5a334dad27a9cd915139b477adcc3fe403546	|use new kafka role in role::cache::kafka		bug: t121659	change-id: i755e1422b35e8b0b04cbd9a6c4fbd9091f6c861f	|"																																																																																																																																																																																																																																																																																																																																																															
"add correct varnishkafka configuration files for varnish 4 servers.		bug: t124278	change-id: i3eb5596a13240edf9cc84f508b5bac7a812c09fe	|varnishkafka: use vsl query on varnish 4		on varnish 4 machines"	" varnishkafka config files need to use	varnish.arg.q instead of varnish.arg.m to filter logs.		bug: t124278	change-id: i9bf78b539d07efb9606ed048963aab330ffaa197	|remove clientip from eventlogging varnishkafka format		bug: t128407	change-id: id8062e0824b25be3df8126354ee01fe115568ff7	|use x-client-ip instead of %h for eventlogging varnishkafka instance		bug: t119144	change-id: i76d77e68499abcbd892e4ff380bd3b38d22350c0	|set up varnishkafka instance on cache servers to log raw client side events to kafka		this will soon fully deprecate the udp based varnishncsa instance"	" allow us	to turn off the eventlogging client side udp -> zmq forwarder.		bug: t106255		change-id: i470e37575fae87cd85665af88c7212229e68b16b	|"																																																																																																																																																																																																																																																																																																																																																																	
"add correct varnishkafka configuration files for varnish 4 servers.		bug: t124278	change-id: i3eb5596a13240edf9cc84f508b5bac7a812c09fe	|varnishkafka: use vsl query on varnish 4		on varnish 4 machines"	" varnishkafka config files need to use	varnish.arg.q instead of varnish.arg.m to filter logs.		bug: t124278	change-id: i9bf78b539d07efb9606ed048963aab330ffaa197	|statsv: switch ""ip"" field to x-client-ip like webrequest		bug: t118557	change-id: i20b87d04c209c2eb5af7f98d6ca92403965d4a3d	|wrap varnishkafka ganglia monitor with has_ganglia		since the varnishkafka ganglia module sensibly requires	package['ganglia-monitor']"	" and since only production includes ganglia	in the standard class"	" wrap varnishkafka ganglia monitor with has_ganglia	hiera variable.		change-id: i1f4dcb5be79dfbfdfd495ef9348aea7fb0a0494f	bug: t103278	|"																																																																																																																																																																																																																																																																																																																																																																
"vk webrequest: use x-cache-status for cache_status		bug: t142410	change-id: i33303602984e672d6cc1d5dcd38a7b521428ed96	|add correct varnishkafka configuration files for varnish 4 servers.		bug: t124278	change-id: i3eb5596a13240edf9cc84f508b5bac7a812c09fe	|varnishkafka: use vsl query on varnish 4		on varnish 4 machines"	" varnishkafka config files need to use	varnish.arg.q instead of varnish.arg.m to filter logs.		bug: t124278	change-id: i9bf78b539d07efb9606ed048963aab330ffaa197	|webrequest: move client_ip data to legacy ""ip"" field		bug: t118557	change-id: i161f089694ec4f0fa4cd4894b44dcca9ce51287b	|add resp.http.x-client-ip -> webrequest:client_ip		bug: t118557	change-id: i50d04b776cb7661af06562d204e6d8e979fd0944	|wrap varnishkafka ganglia monitor with has_ganglia		since the varnishkafka ganglia module sensibly requires	package['ganglia-monitor']"	" and since only production includes ganglia	in the standard class"	" wrap varnishkafka ganglia monitor with has_ganglia	hiera variable.		change-id: i1f4dcb5be79dfbfdfd495ef9348aea7fb0a0494f	bug: t103278	|varnishkafka: use statsd.eqiad.wmnet		statsd stack is in a much better place now"	" we can point traffic there		bug: t95687	change-id: i285ad47a3bbe957c682797a968390ef798eb69da	|"																																																																																																																																																																																																																																																																																																																																																															
"varnish: fix jemalloc chunk size config option name		the option to tune virtual memory chunk size is lg_chunk"	" not	lg_chunk_size. the values we have been using so far have thus been	ignored"	" and the default value for lg_chunk (2^22=4m) has been used.		set the chunk size to 512k (2^19) on cache_text"	" and 1m (2^20) on the	others. we can re-experiment with lower values later on.		bug: t135384	change-id: ia9bf5bd8efc0dc38433f2933ab5214cfc79b0d8b	|caches: reduce fe mem size: 50% -> 40%		we're getting some oomkills of varnishds in ulsfo"	" which has the	upload caches with the smallest physical ram.  clearly we've	crossed some line and need to cut back on fe mem size percentage a	bit for safety in the general case.		bug: t135384	change-id: i19f654922dedb155d022925b7b1a3b382009ec17	|cache_maps: switch to file storage backend		the deprecated_persistent storage backend is making varnish crash	relatively often. cach_misc is already using -s file"	" use file backend	storage on maps as well.		bug: t142810	change-id: i82edae903471f96762240cd60a635a008066755d	|varnish: jemalloc tuning for frontend caches		this should reduce the virtual and resident waste/overhead when	configuring frontend malloc storage with large fractions of total	memory.  note that the chunk size could probably use further	tuning per-cluster"	" but the values in this patch are reasonable	conservative estimates from some basic experimentation/research.		bug: t135384	change-id: ie0bdcbf6a0290b76131a6a43c3013d72b653100f	|https redirect for all: 2/3 remove vcl_config settings		this removes the vcl_config.https_redirects settings"	" which now	control nothing.  functional no-op"	" but split from previous commit	to avoid any race condition on puppetmaster update.		bug: t103919	change-id: ibd33ffb149c888a70973238a650c6318ece2616b	|vcl: remove vcl_config.do_gzip conditional		this is now on for all clusters and has been for some time.  it's	been toggled off for 1x cluster a couple of times in the recent	past for bug suspicion"	" but the problem always ended up lying	elsewhere"	" so may as well kill some complexity.  we can always	conditional-hack it if we need to for actual experimentation.		change-id: i84c7e3caa31ceaa328959b1ca6351731f50ba35e	|r::c::config: move to hieradata		this also changes the structure a little bit to accommodate future	things.  note that 'misc' cluster never had r::c::configuration	data; it hardcodes all of its (eqiad-only) backends in misc.pp.	will update it to match when we start going after misc-cluster	backends for codfw support.		bug: t127484	change-id: i278c87cc6f7f76d7e98490454762a224e531bff4	|r::c::config: remove has_ganglia		this just mirrors standard::has_ganglia (even in labs!)"	" so switch	all references to that and delete it.		bug: t127484	change-id: ic063d5dbc95be8df92fc7bdd38774b16b055040d	|cache_maps: remove probe		it doesn't generally make sense to probe services behind	lvs/pybal"	 as we'd be probing random servers	" and pybal is probing	them for us anyways.		bug: t127481	change-id: ia5c5030103502087c54d8479761332e1773022f4	|role::cache::instances: create and use for maps		bug: t127481	change-id: ic2d55a333c0f1334c63e99e09ba80204051928d6	|rename cache_remote to cache_eqiad		this makes the backend selection explicit inside the vcl"	" and	paves the way for further refactoring...		bug: t127481	change-id: id78d002b303460c3f01d5cc471f221823460e6d7	|vcl: move layer from vcl_config to instance param		bug: t127481	change-id: ic4baa6640aa11bd4aed5b15fd676bd6c24761c89	|vcl: rename remaining ""backend"" cache backends		this renames 'backend' to 'cache_local' or 'cache_remote' as	appropriate"	" and ditto for the _random variant.		due to race conditions with confd directors vcl"	" this will usually	require 2x puppet runs to stop failing vcl compilation and thus	failing puppet itself...		bug: t127481	change-id: i543e42ed565017ed6be35a77bbaa8969d2d852a4	|remove $::realm conditionals around varnishkafka for labs webrequests		bug: t127369	change-id: i1bf5466549d97201d2aa30eb9b45db9e7f6fe793	|vcl: ttl fixed/cap params vcl_fetch		this creates two new vcl_config parameters which affect vcl_fetch	beresp.ttl behaviors:		ttl_fixed: if set"	" all obj.ttl with status < 400 are set to this	ttl_cap: def 30d"	" all obj.ttl >= this are set to this		these replace/standardize existing manipulations of this sort in	the various clusters.  the actual values and applications of the	fixed/cap behaviors are unchanged by this patch in practice.		note that maps-cluster change goes a little further"	" as we're also	removing the remainder of its minimal vcl_fetch (which was to	return deliver)"	" allowing default vcl_fetch hfp behaviors (which	is probably how it should've been anyways"	" and regardless this	cluster is still in testing).		bug: t124954	change-id: i5c7c6908e196701a9e042e46b5f8ad9bca6137a1	|cache_maps: define tier-2 backending		bug: t109162	change-id: ibfd96eb1fc473f0f8c4e9222d28e70733bacbb9f	|clean up some unused udp2log stuff		bug: t97294	change-id: i02eac9f5172d52732af05fc9a0d91c54b1f5869e	|add backend_random to maps and upload clusters config		bug: t96847	change-id: i0527274b7f72413a211b92295ebd99825bfb14ea	|varnish: refactor instance parameters (no-op)		switches ""port"" scalar to ""ports"" array"	" and then removes the	""varnish_"" prefixes on related variables that have been fixme for	a while.		bug: t119396	change-id: i9bd3cfdf9a0834f5ce1a1085c9b867349487bf2a	|purging: do not vcl-filter on domain regex		... because we're now splitting the multicast addresses	themselves"	" which is far more efficient.		needs to wait on deploy of mediawiki config change: i8799f7b30		bug: t116752	change-id: i2d2078e7240f16040ecee0fc65059955a0f8d13d	|vhtcpd: refac args template"	" allow multiple mc addrs		bug: t116752	change-id: icc0497e2fe8330ed5a451ecc384bd78e719816e0	|deploy varnishreqstats diamond collector on remaining cache hosts		also add ensure parameter to varnish::monitoring::varnishreqstats		bug: t83580	change-id: ied283ac8d40bde07d37add59aecc6aee7548b267	|genericize the cluster_nodes-like variables to reduce diffs		bug: t96847	bug: t109286	change-id: i26c206a4a13dc302de4b8a08152c47b2c9bbbb3e	|standardize hiera-overridable class/config params		we had a few different ways of accomplishing the same thing here"	"	and increasingly many of these variables are likely to need to	cross into sibling classes during refactors as well.  this	standardizes the pattern as:		1. class param in r::c::base	2. defaulted for prod in base.pp param list	3. labs override of r::c::b::foo in hieradata/labs.yaml	4. per-cluster copy to $vcl_config as-needed	5. always accessed from vcl_config.fetch() in templates	6. no default-argument in the fetch() call		the affected variables standardized under this scheme are now:	zero_site	purge_host_only_upload_re	purge_host_not_upload_re	static_host	upload_domain	bits_domain	top_domain		this will likely change again at a later point"	" but it's a better	place to be for the moment in terms of factoring.		bug: t96847	bug: t109286	change-id: i6351b0897aaa7ac53ca4482037ff28c31cb9851c	|add cache_maps and related lvs config"	" using cp104[34]		bug: t105076	change-id: if05c07a32e89c8c5ec73716281cf4526943f5b7e	|"																																																																																																																																																																																																																																																																																																																																								
"add the pivot.w.o domain to the stat1001 misc varnish director		this new domain will be used for a new analytics ui called pivot"	"	meant to explore druid's pageview data.	an apache vhost is already running on stat1001 (basic auth + ldap)"	"	meanwhile the gdnsd change will be done afterwards.		bug: t138262	change-id: i368b50958623ffe7ac8a8cca5cd5f2d94b20dab6	|move yarn.w.o traffic to stat1001.eqiad.wmnet		the analytics team added an apache vhost to stat1001 to support	yarn.wikimedia.org. the vhost authenticate the user via	basic auth + ldap and proxies the requests to analytics1001	(that runs a java based web-server).		bug:t116192	change-id: i72efac79b727d20dfc3fbd2b08d0e3182ee614ee	|add toolsadmin.wikimedia.org to misc varnish		toolsadmin.wikimedia.org is the tool labs admin console application	(striker) running on californium.		bug: t136256	depends-on: idb8074b97e7c3bd62fc9928eedf451d1713740b5	change-id: ifa4e2ad62249eca523885741da56ad49205943aa	|varnish: fix jemalloc chunk size config option name		the option to tune virtual memory chunk size is lg_chunk"	" not	lg_chunk_size. the values we have been using so far have thus been	ignored"	" and the default value for lg_chunk (2^22=4m) has been used.		set the chunk size to 512k (2^19) on cache_text"	" and 1m (2^20) on the	others. we can re-experiment with lower values later on.		bug: t135384	change-id: ia9bf5bd8efc0dc38433f2933ab5214cfc79b0d8b	|caches: reduce fe mem size: 50% -> 40%		we're getting some oomkills of varnishds in ulsfo"	" which has the	upload caches with the smallest physical ram.  clearly we've	crossed some line and need to cut back on fe mem size percentage a	bit for safety in the general case.		bug: t135384	change-id: i19f654922dedb155d022925b7b1a3b382009ec17	|cache_maps: switch to file storage backend		the deprecated_persistent storage backend is making varnish crash	relatively often. cach_misc is already using -s file"	" use file backend	storage on maps as well.		bug: t142810	change-id: i82edae903471f96762240cd60a635a008066755d	|cache_misc: no need for (?i) on planet regex		our common vcl normalizes hostnames to lowercase.		bug: t110717	change-id: i4ed7520e0bd6cb2ffa827891f52727ac30102e4e	|graphite: move labs graphite to graphite-labs.wikimedia.org		bug: t140899	change-id: i6babde830181d8e613735b0088506c24b9e244a5	|cache: add labs grafana behind misc varnish		bug: t120295	change-id: i3a5a9415a95fd2e8f1538c2a102659341526ab73	|varnish: git.wm.org to iridium"	" remove related config/tests/monitoring		this changes the backend to iridium so that the rewrites from git.w.o to	phabricator.w.o can be on the same host as phabricator.		this is also removing config and tests that was specifically for gitblit and	should not be needed anymore. it removes the monitoring for git.w.o as	phabricator is already monitored.		bug:t137224	depends-on: i67ad308f9e6373e5234cb2d83006457d6f467bf8	change-id: id8dad592e3f16736bc8eb0d6806be1b53feb94fe	|etherpad-restore: use etherpad1001b		bug: t138516	change-id: ia2aa8b4f64a72491d0ea780189d4ed5bc0d5cc22	|cache::misc: set up a temporary etherpad host		set up a temporary etherpad host to allow interested users to self-serve	restoring pads that were not restored previously while bringing the	service into a working state again after the recent database corruption.	we go for this approach only because it's wikimania 2016 time and a lot	of interesting pads might have be lost irrevocably before their	users/owners had any chance to follow the best practice of archiving	them elsewhere.		bug: t138516	change-id: i860eb2af2fe1310f19c1c3a1e48a69fa723b2cef	|stream: use hash(x-client-ip) for backend selection		i think this is what's confounding some of my testing.  i think	randomized applayer backends is messing up the multi-step	handshake from the client.  note the direct lvs->rcstream config	uses 'sh' balancing.		bug: t134871	change-id: iceb1404a0dcf09939b4f8b2c3d545e4e9d3cb5f1	|cache_misc: add stream.wm.o		bug: t134871	change-id: i67a5798f256a0397cf3ee96d3ed68d2c60a881b3	|ores: add varnish backend in the misc cluster		use the misc varnish cluster to drive ores.wikimedia.org. discussion in	t124203.		bug: t124203	change-id: ib5cc70853854e4554db5bb547f1f0896c042adbd	|cache::misc add endowment.wm.org -> bromine		add endowment.wikimedia.org in varnish cache	misc config. let it be served by bromine as backend	like annual.wm.org and other microsites.		bug:t136735	change-id: ibbd956e4d68ab2873a2c14b48499af7b80e7e960	|varnish: jemalloc tuning for frontend caches		this should reduce the virtual and resident waste/overhead when	configuring frontend malloc storage with large fractions of total	memory.  note that the chunk size could probably use further	tuning per-cluster"	" but the values in this patch are reasonable	conservative estimates from some basic experimentation/research.		bug: t135384	change-id: ie0bdcbf6a0290b76131a6a43c3013d72b653100f	|depooling wdqs1001 for reinstall and new disks		bug: t120714	change-id: i205d94072b5b404d30f9da3f6755fe3d837b3380	|add analytics.wikimedia.org to list of domains served by misc varnish backend stat1001		bug: t132407	change-id: iba357d131257058d0d39713ee63e58b26e3a3f77	|return a custom http 503 response for all the stat1001 websites due to maintenance.		this change will be deployed just before the stat1001 reimage to debian and it will	be rolled back as soon as the procedure is completed.		bug: t76348	change-id: i1333dd3e7077f3bbe4158d725a2fdb5151c1972e	|add a maintenance flag to cache::misc directors.		this change adds the possibility to put a backend misc service under	maintenance with an optional custom error message displayed.		bug: t76348	change-id: ic01e8da8036169979a989a54c1541612d8fb966c	|depooled wdqs1001 during reinstall		bug: t133566	change-id: i5983cbc3c9a71abe9e615cc1181b04ce48032e45	|remove wdqs1002 from varnish during reinstall / fix		wdqs1002 did not restart correctly for kernel upgrade. to ensure we can test	it properly before sending traffic to it"	" let's remove it from varnish	temporarily.		bug: t132387	change-id: idcb5339a7558d6b25c98c13581418f94cd7abe55	|cache_misc: declarative req.http.host=>backend map		bug: t131501	change-id: i5f7ed0cfaf71553818d9e162f7d9ff9cd58d89a6	|misc vcl: disable yarn.wm.o more-completely		this moves the 404 from the backend vcl to the frontend vcl and	gets rid of the now-unused backend appserver definition for	analytics1001.  the driver here is it's the only oddball that	doesn't match up with plans for genericizing the backend selection	from a data structure.		bug: t131501	bug: t116192	change-id: ic697dd3d008bd6cfb0f89a4584f5aae759afc847	|misc cluster vcl: avoid name conflict between directors and probes		add _director suffix to the logstash and wdqs directors in order to	avoid name clashes with varnish 4: we also have two probes named	logstash and wdqs.		bug: t131501	change-id: i37ccb33e5e5af3c51820a6913bfb807980541596	|vcl: remove vcl_config.do_gzip conditional		this is now on for all clusters and has been for some time.  it's	been toggled off for 1x cluster a couple of times in the recent	past for bug suspicion"	" but the problem always ended up lying	elsewhere"	" so may as well kill some complexity.  we can always	conditional-hack it if we need to for actual experimentation.		change-id: i84c7e3caa31ceaa328959b1ca6351731f50ba35e	|role::cache::instances: use for misc cluster		bug: t127481	change-id: i5fd7b884c653aeda349f25cf845354cf45ce2332	|rename cache_remote to cache_eqiad		this makes the backend selection explicit inside the vcl"	" and	paves the way for further refactoring...		bug: t127481	change-id: id78d002b303460c3f01d5cc471f221823460e6d7	|vcl: move layer from vcl_config to instance param		bug: t127481	change-id: ic4baa6640aa11bd4aed5b15fd676bd6c24761c89	|vcl: rename remaining ""backend"" cache backends		this renames 'backend' to 'cache_local' or 'cache_remote' as	appropriate"	" and ditto for the _random variant.		due to race conditions with confd directors vcl"	" this will usually	require 2x puppet runs to stop failing vcl compilation and thus	failing puppet itself...		bug: t127481	change-id: i543e42ed565017ed6be35a77bbaa8969d2d852a4	|remove $::realm conditionals around varnishkafka for labs webrequests		bug: t127369	change-id: i1bf5466549d97201d2aa30eb9b45db9e7f6fe793	|cache_misc: disable do_gzip		easiest way to test this interaction across layers in cache_misc	for the bug linked below...		bug: t127294	change-id: i68ceace3e4bfbf93b57fa488cc12eb4552dfe736	|varnish/misc-web: remove caesium backend"	" decom'ed		this backend has been shutdown and decom'ed.		bug:t125165	change-id: ia3809f835063383e2160bbc0239e598eed6cbc46	|add piwik role		* provision behind misc-varnish as piwik.wikimedia.org.	* restrict access at apache level by using mod_authnz_ldap.		there is no piwik module yet"	" because piwik is not configurable from the	command line. going through the web installer is a requirement for setting up	the database. the only alternative is to make puppet import a dump of an empty	(but fully initialized) piwik database"	" and we don't have good abstractions for	that.		bug: t103577	change-id: i136ab0a38339544f461a73154d1e4ad5a0679b0e	|cache_misc: send randomized pass traffic directly to t1 backends		backend_random is only used for (and for all) ""pass"" traffic (both	explicit and hit for pass).  for tier-2 frontends"	" the jump of	this traffic through tier-2 backends before hitting tier-1	backends is pointless and wasteful: sending it directly to tier-1	backends accomplishes the same thing more efficiently and still	makes use of our ipsec protection for x-dc connections.  in the	long run we'll go one step further and have all frontends	(regardless of tier) contact the applayer directly for pass	traffic and not need ""backend_random"" at all"	" but that's blocked	on further x-dc crypto work.		bug: t96847	change-id: i239934cf260c218276749000ef38d80893a4c4cd	|cache_misc: move pass-blocks to layer-common code		bug: t119394	change-id: i1de9dfbb91f9782b6d099120a954adb2fd622ec5	|cache_misc - switch to conftool dynamic directors		bug: t119394	change-id: if7f273cede7549da000945a5c6cfdd707f4e2449	|misc-cluster 2layer refactor"	" step 3/3		this configures the frontends to use the local backend varnish	instances"	" and strips backend-only vcl from their vcl files so	that they just do frontend-only things like redirects and header	manipulation.		bug: t119394	change-id: i8effc26bf8cdaf7e1ca0cb4798f38e45eef16ee0	|misc-cluster 2layer refactor"	" step 2/3		this adds the misc role to the intended machines at other	dataceters"	 adds ipsec connectivity between them all	" configures	the tier-two backends to use the tier-one backends"	" and strips the	backend vcl of frontend-only code.  at this point the backends at	all tiers should function correctly"	" but the frontends still	aren't making use of it.		bug: t119394	change-id: i56eb2b93307089a4547e255534fd41d4cbd5f97b	|misc-cluster 2layer refactor"	" step 1/3		note: this requires careful manual deployment with depooling and	manual daemon stops!		this switches the misc cluster to the 2layer configuration like	all of the other cache clusters at the puppet level"	" but leaves	the ""frontend"" instance which listens to port 80 communicating	directly with the applayer backend hosts for now"	" rather than	actually using the second layer.  followup commits will take this	further...		bug: t119394	change-id: iacf7e07574e98124a1dfc5479137a55dfd209662	|varnish: refactor instance parameters (no-op)		switches ""port"" scalar to ""ports"" array"	" and then removes the	""varnish_"" prefixes on related variables that have been fixme for	a while.		bug: t119396	change-id: i9bd3cfdf9a0834f5ce1a1085c9b867349487bf2a	|purging: do not vcl-filter on domain regex		... because we're now splitting the multicast addresses	themselves"	" which is far more efficient.		needs to wait on deploy of mediawiki config change: i8799f7b30		bug: t116752	change-id: i2d2078e7240f16040ecee0fc65059955a0f8d13d	|misc: add rutherfordium and point people.wm.o to it		adds rutherfordium.eqiad.wmnet as a new backend and point people.wm.o to it.	also change the comment on terbium from public_html to noc.wm.o.		bug: t116992	change-id: i7bc23224612ce18f6609f84c22c3a5eeaf263a5c	|enable varnishreqstats on all misc and mobile hosts		bug: t83580	change-id: i71203aed23f8762716f9876f8dc88174ee10cb05	|the varnish reqstats diamond collector does not work"	" emit to statsd directly instead		this also adds a main statsd hiera variable for general use.		bug: t83580	change-id: ife12f04c2b12f582a2338cc5791de1e75ef9114a	|deploy varnishreqstats diamond collector on remaining cache hosts		also add ensure parameter to varnish::monitoring::varnishreqstats		bug: t83580	change-id: ied283ac8d40bde07d37add59aecc6aee7548b267	|bugfix for c6806db0 + misc-web vcl		change-id: ida83f9ff41574245f6369dd270635252c6c527b5	|varnish-misc: remove backend zirconium		decom/reclaim		bug:t105510	change-id: ib27725b8fa6b999986bc0965d3a261ff503f6d9f	|misc-web: add node krypton as a backend		bug:t104946	change-id: ib986ace95ce5c336c81e2a9bbc2cddc9602d87e9	|add bromine as a misc-web backend		bromine is a new ganeti vm for misc. services.	add it as a backend in for misc-web varnish.		bug:t101734	change-id: ie66625bb8d4d7c7169efde2ec3e34979dfa56ba5	|cache/misc: add planet1001 as a backend		it's a ganeti vm to host planet now instead of zirconium.		bug:t101730	change-id: iebbc0310c3927b8fe29166b626ecb1e48cc2c63f	|"																																																																																																																																																																																																																																																																																																																																		
"enable tcp_tw_reuse on caches		bug: t107749	change-id: ib0e0a45c0a71f52437b316c51e544661ee2d3fb5	|"																																																																																																																																																																																																																																																																																																																																																																			
"tlsproxy: redirect-only service on 8080		bug: t107236	change-id: ieb8d43bf7edc7f068f76aa08fa5c3a070b79e3ba	|r::c::ssl: use 3127 for upstream_port		bug: t107236	change-id: i204c1b1aab727be385a7ecb5cdcff1b0901292c5	|tlsproxy: refactor/cleanup"	" beta work		for production"	" this mostly eliminates some pointless intermediary	classes like role::cache::ssl::local and unifies the configuration	of the ""unified"" cert a bit more between clusters (including new	monitoring for some).		all of the betassl hacks are removed completely"	" and the ssl	related beta conditionals are now reduced to just one small block	in role::cache::ssl::unified.  this will currently break on beta"	"	but the previous config was also broken in beta"	" so no change	there.  i'd rather target convergence than divergence when we	start fixing that on the beta instances"	" and this change brings	them into much closer (if not perfect) alignment.		bug: t97593	change-id: i83d36b5db01becbd5cd42edbf630621549becf24	|tlsproxy: multi-cert support"	" including ocsp		this updates tlsproxy::localssl and all callers to support an	array of certs for a single nginx-level ""site"""	" for e.g. matching	ecdsa+rsa keys that are otherwise-identical.		this includes updates to the stapling stuff to support multiple	certificates in a single ssl_stapling_file response.  the stapling	updater cron was relatedly refactored to use a set of input	configuration files instead of just refreshing whatever it finds	in the ouput directory.		actually using more than one certificate in a site's cert array	requires special non-standard nginx patches at this time.		bug: t86654	change-id: i996b7f958d17df1516c8f011001518c5397cd5e2	|"																																																																																																																																																																																																																																																																																																																																																											
"beta: use let's encrypt cert		acme_tiny is modified to allow tls redirection to an invalid cert for	acme-challenge.		bug: t50501	change-id: i450316d795046ed49d057b221433ce9b172b9d6b	|tlsproxy: redirect-only service on 8080		bug: t107236	change-id: ieb8d43bf7edc7f068f76aa08fa5c3a070b79e3ba	|r::c::ssl: use 3127 for upstream_port		bug: t107236	change-id: i204c1b1aab727be385a7ecb5cdcff1b0901292c5	|tlsproxy: refactor/cleanup"	" beta work		for production"	" this mostly eliminates some pointless intermediary	classes like role::cache::ssl::local and unifies the configuration	of the ""unified"" cert a bit more between clusters (including new	monitoring for some).		all of the betassl hacks are removed completely"	" and the ssl	related beta conditionals are now reduced to just one small block	in role::cache::ssl::unified.  this will currently break on beta"	"	but the previous config was also broken in beta"	" so no change	there.  i'd rather target convergence than divergence when we	start fixing that on the beta instances"	" and this change brings	them into much closer (if not perfect) alignment.		bug: t97593	change-id: i83d36b5db01becbd5cd42edbf630621549becf24	|tlsproxy: multi-cert support"	" including ocsp		this updates tlsproxy::localssl and all callers to support an	array of certs for a single nginx-level ""site"""	" for e.g. matching	ecdsa+rsa keys that are otherwise-identical.		this includes updates to the stapling stuff to support multiple	certificates in a single ssl_stapling_file response.  the stapling	updater cron was relatedly refactored to use a set of input	configuration files instead of just refreshing whatever it finds	in the ouput directory.		actually using more than one certificate in a site's cert array	requires special non-standard nginx patches at this time.		bug: t86654	change-id: i996b7f958d17df1516c8f011001518c5397cd5e2	|"																																																																																																																																																																																																																																																																																																																																																											
"cache: vary statsd_server with hiera		on the beta cluster the varnish caches have a few process that reference	the prodution statsd host:		/usr/local/bin/varnishstatsd --statsd-server=statsd.eqiad.wmnet \	    --key-prefix=varnish.eqiad.backends	/usr/local/bin/varnishxcps --statsd-server=statsd.eqiad.wmnet	/usr/local/bin/varnishrls --statsd-server=statsd.eqiad.wmnet		update the role::cache::* classes to use the generic hiera key 'statsd'	which is defined with:		  hieradata/labs.yaml:# labs statsd instance	  hieradata/labs.yaml:statsd: labmon1001.eqiad.wmnet:8125	  hieradata/common.yaml:# main statsd instance	  hieradata/common.yaml:statsd: statsd.eqiad.wmnet:8125		the three python scripts are in modules/varnish/files they recognize the	'host:port' format and default the port to 8125.		the change for production would be:		- --statsd-server=statsd.eqiad.wmnet	+ --statsd-server=statsd.eqiad.wmnet:8125		such a change could have impacted an icinga check_proc commands that are	defined in modules/varnish/manifests/logging/ "	" but they are invoked	with '-a' and the name of the process"	" eg they don't look at the extra	arguments.		bug: t116898	change-id: i51c754fbec577a73e258922d4fc2054e9b1a854a	|varnish: fix jemalloc chunk size config option name		the option to tune virtual memory chunk size is lg_chunk"	" not	lg_chunk_size. the values we have been using so far have thus been	ignored"	" and the default value for lg_chunk (2^22=4m) has been used.		set the chunk size to 512k (2^19) on cache_text"	" and 1m (2^20) on the	others. we can re-experiment with lower values later on.		bug: t135384	change-id: ia9bf5bd8efc0dc38433f2933ab5214cfc79b0d8b	|caches: reduce fe mem size: 50% -> 40%		we're getting some oomkills of varnishds in ulsfo"	" which has the	upload caches with the smallest physical ram.  clearly we've	crossed some line and need to cut back on fe mem size percentage a	bit for safety in the general case.		bug: t135384	change-id: i19f654922dedb155d022925b7b1a3b382009ec17	|insecure post: 100% failure"	" loophole closed		bug: t136674	bug: t105794	change-id: ie2db01e1c05dc793e3350ba1111bbd30c50edb35	|cache_text: raise fe mem size to 50%		bug: t135384	change-id: i0dfcb944e0e5d17adb16d5adca1006d2f59b7325	|role::cache::text: handle url shortener requests		given how painful it is to mangle the http host header in apache and the	relative ease of doing this at the varnish layer"	" we perform request	masking at the varnish backend when making a request to the appservers.		bug: t133485	change-id: i286e6c2a50bf4735c3fc1ac629aff3f3c35f314a	|raise fe mem size to 37% on text and upload		this gets us halfway further from the current 25% values to the	50% values tested maps and misc (where the cache doesn't often	grow to full size anyways...).  with the new jemalloc tuning"	" the	virtual overhead shouldn't get unreasonable.		bug: t135384	change-id: i05d0a59a72ea7b05367343e717b7f709fd2903b5	|varnish: jemalloc tuning for frontend caches		this should reduce the virtual and resident waste/overhead when	configuring frontend malloc storage with large fractions of total	memory.  note that the chunk size could probably use further	tuning per-cluster"	" but the values in this patch are reasonable	conservative estimates from some basic experimentation/research.		bug: t135384	change-id: ie0bdcbf6a0290b76131a6a43c3013d72b653100f	|cache_text: cap frontend ttl at 1d		past stats indicate this is a non-issue for perf/hitrate"	" it	doesn't affect our resiliency in operational scenarios because	it's non-persistent anyways"	" and it further tightens how long	objects can linger across all cache layers combined.		note cache_upload has already historically capped its frontend	ttls at the even lower value of 1h.		bug: t124954	change-id: ia110e7a3406fc3ba6d48239fb5eb90efbf5b6f96	|cache_text: raise fe mem from 1/8 to 1/4 total		bug: t135384	change-id: i1453b7e91bf80d30b918ecc868c3e25e92bdacee	|https redirect for all: 2/3 remove vcl_config settings		this removes the vcl_config.https_redirects settings"	" which now	control nothing.  functional no-op"	" but split from previous commit	to avoid any race condition on puppetmaster update.		bug: t103919	change-id: ibd33ffb149c888a70973238a650c6318ece2616b	|varnish+statsd: refactor classes"	" move rls to text-only		this removes the r::c::statsd and r::c::statsd::frontend classes"	"	as they are now just wrappers to include other classes and only	used in single locations.  the included logging::xcps and	logging::statsd stanzas are moved to r::c::base (functional	no-op)"	" and logging::rls is moved to r::c::text (it was previously	deployed to all clusters"	" but only the text cluster hosts load.php	at this point in time).		the pointless varnishrls daemons on non-text clusters will need	manual stops for this to take full effect.		bug: t131353	change-id: i0d92220a458c774f32d06b248543e8cd5be85dfc	|vcl: remove vcl_config.do_gzip conditional		this is now on for all clusters and has been for some time.  it's	been toggled off for 1x cluster a couple of times in the recent	past for bug suspicion"	" but the problem always ended up lying	elsewhere"	" so may as well kill some complexity.  we can always	conditional-hack it if we need to for actual experimentation.		change-id: i84c7e3caa31ceaa328959b1ca6351731f50ba35e	|r::c::config: move to hieradata		this also changes the structure a little bit to accommodate future	things.  note that 'misc' cluster never had r::c::configuration	data; it hardcodes all of its (eqiad-only) backends in misc.pp.	will update it to match when we start going after misc-cluster	backends for codfw support.		bug: t127484	change-id: i278c87cc6f7f76d7e98490454762a224e531bff4	|r::c::config: remove has_ganglia		this just mirrors standard::has_ganglia (even in labs!)"	" so switch	all references to that and delete it.		bug: t127484	change-id: ic063d5dbc95be8df92fc7bdd38774b16b055040d	|add a cluster_be_recv_pre_purge handler & normalize paths		to ensure reliable purging of titles with special characters"	" we would like to	apply the same path normalizations to purge and other requests. the previous	attempt to do so (274282) only applied to frontends"	" so was not a complete	solution.		this patch introduces an equivalent cluster_be_recv_pre_purge handler"	" and	calls / defines it for all varnish clusters. for the text cluster"	" this	handler is then used to apply the same path normalizations as performed in the	frontend to purge requests.		bug: t127387	change-id: i9a882013adb620ae5f5e36eb0ad4ef1a9ba1b0a0	|role::cache::instances: use for text cluster		bug: t127481	change-id: id222b58fb38678721cefefd42268b0ca0766fd6d	|rename cache_remote to cache_eqiad		this makes the backend selection explicit inside the vcl"	" and	paves the way for further refactoring...		bug: t127481	change-id: id78d002b303460c3f01d5cc471f221823460e6d7	|vcl: move layer from vcl_config to instance param		bug: t127481	change-id: ic4baa6640aa11bd4aed5b15fd676bd6c24761c89	|vcl: rename remaining ""backend"" cache backends		this renames 'backend' to 'cache_local' or 'cache_remote' as	appropriate"	" and ditto for the _random variant.		due to race conditions with confd directors vcl"	" this will usually	require 2x puppet runs to stop failing vcl compilation and thus	failing puppet itself...		bug: t127481	change-id: i543e42ed565017ed6be35a77bbaa8969d2d852a4	|normalize_path: move to own include file		bug: t127387	change-id: i8813059c5f1fe55d0899b03b83ee7bb7e9257832	|disable do_gzip on cache_text (experiment)		bug: t127931	change-id: i95c97b839ba7ce867994333bf1f1a645c1790e84	|remove $::realm conditionals around varnishkafka for labs webrequests		bug: t127369	change-id: i1bf5466549d97201d2aa30eb9b45db9e7f6fe793	|text vcl: add support for citoid+cxserver passes		this adds pass-only support for the legacy public citoid and	cxserver hostnames to the text cluster"	" the same way they were	mapped through the parsoid cluster.  requires a dns change	afterwards to take effect.		bug: t110476	bug: t110478	change-id: i89a4283279aa8524f05d20f87e0e97a1c0511731	|cache_text: add mobile ips to loopback		note: this doesn't do anything in functional terms - it merely	prepares for the next steps...		bug: t109286	change-id: ic196573770d5686508b415d8d476e33a2c473043	|clean up some unused udp2log stuff		bug: t97294	change-id: i02eac9f5172d52732af05fc9a0d91c54b1f5869e	|cache_text/mobile: send randomized pass traffic directly to t1 backends		backend_random is only used for (and for all) ""pass"" traffic (both	explicit and hit for pass).  for tier-2 frontends"	" the jump of	this traffic through tier-2 backends before hitting tier-1	backends is pointless and wasteful: sending it directly to tier-1	backends accomplishes the same thing more efficiently and still	makes use of our ipsec protection for x-dc connections.  in the	long run we'll go one step further and have all frontends	(regardless of tier) contact the applayer directly for pass	traffic and not need ""backend_random"" at all"	" but that's blocked	on further x-dc crypto work.		bug: t96847	change-id: i75d558c94f4e72f8e7a65cac1a38d0270d82fde5	|text vcl: remove hiera mobile/text conditionals		this removes the hiera conditionals for cache_(text|mobile) by	explicitly setting (or clearing) x-subdomain for both cases in	vcl_recv and then keying off of x-subdomain as a runtime	conditional for other cases that might matter.  some of the	x-subdomain conditionals can probably be removed later as well	with more testing and research.		note also a new hash_data() in the mobile-only (x-subdomain-only)	path which keeps mobile and desktop hash entries separate.		at this point"	" text and mobile are running identical runtime vcl	code files"	" and differ only in the hostnames->ips mapped to them	and the separation of their cache data pools"	" and we should be	able to begin some manual testing of actual mobile requests	through the text cluster to compare with the real mobile cluster.		bug: t109286	change-id: i8b7b57c34d536c981efefcb00fc13eea4eaf891d	|varnish: refactor instance parameters (no-op)		switches ""port"" scalar to ""ports"" array"	" and then removes the	""varnish_"" prefixes on related variables that have been fixme for	a while.		bug: t119396	change-id: i9bd3cfdf9a0834f5ce1a1085c9b867349487bf2a	|purging: do not vcl-filter on domain regex		... because we're now splitting the multicast addresses	themselves"	" which is far more efficient.		needs to wait on deploy of mediawiki config change: i8799f7b30		bug: t116752	change-id: i2d2078e7240f16040ecee0fc65059955a0f8d13d	|deploy varnishreqstats on all text caches		bug: t83580	change-id: i3ea78f61ea787243eefd517bf1fcca8a51bd17ec	|enable varnishreqstats on all misc and mobile hosts		bug: t83580	change-id: i71203aed23f8762716f9876f8dc88174ee10cb05	|vhtcpd: refac args template"	" allow multiple mc addrs		bug: t116752	change-id: icc0497e2fe8330ed5a451ecc384bd78e719816e0	|deploy varnishreqstats diamond collector on remaining cache hosts		also add ensure parameter to varnish::monitoring::varnishreqstats		bug: t83580	change-id: ied283ac8d40bde07d37add59aecc6aee7548b267	|move zerofetcher to r::c::base		because we'll be making the xff-decoding logic that uses its	netmapper databases universal to all the clusters...		bug: t89177	bug: t109286	change-id: i7ad6478758582a7e2fa3ed26fd57847a202dcfed	|genericize the cluster_nodes-like variables to reduce diffs		bug: t96847	bug: t109286	change-id: i26c206a4a13dc302de4b8a08152c47b2c9bbbb3e	|add zero updater to text.pp"	" align position		bug: t109286	change-id: i7de633b3a900d53fde6c60348d41e75a3cabe497	|trivial mobile/text.pp diff reductions		whitespace"	 hash reorder	" etc		bug: t109286	change-id: ia23c3063267212dee3470ec3b464f04b09bb29b6	|standardize hiera-overridable class/config params		we had a few different ways of accomplishing the same thing here"	"	and increasingly many of these variables are likely to need to	cross into sibling classes during refactors as well.  this	standardizes the pattern as:		1. class param in r::c::base	2. defaulted for prod in base.pp param list	3. labs override of r::c::b::foo in hieradata/labs.yaml	4. per-cluster copy to $vcl_config as-needed	5. always accessed from vcl_config.fetch() in templates	6. no default-argument in the fetch() call		the affected variables standardized under this scheme are now:	zero_site	purge_host_only_upload_re	purge_host_not_upload_re	static_host	upload_domain	bits_domain	top_domain		this will likely change again at a later point"	" but it's a better	place to be for the moment in terms of factoring.		bug: t96847	bug: t109286	change-id: i6351b0897aaa7ac53ca4482037ff28c31cb9851c	|set up varnishkafka instance on cache servers to log raw client side events to kafka		this will soon fully deprecate the udp based varnishncsa instance"	" allow us	to turn off the eventlogging client side udp -> zmq forwarder.		bug: t106255		change-id: i470e37575fae87cd85665af88c7212229e68b16b	|cache_(text|upload): frontend default_ttl => 30d		bug: t108612	change-id: i1b57d0d69fe3d132be9aa82515ebc15f92a31cc4	|tlsproxy: refactor/cleanup"	" beta work		for production"	" this mostly eliminates some pointless intermediary	classes like role::cache::ssl::local and unifies the configuration	of the ""unified"" cert a bit more between clusters (including new	monitoring for some).		all of the betassl hacks are removed completely"	" and the ssl	related beta conditionals are now reduced to just one small block	in role::cache::ssl::unified.  this will currently break on beta"	"	but the previous config was also broken in beta"	" so no change	there.  i'd rather target convergence than divergence when we	start fixing that on the beta instances"	" and this change brings	them into much closer (if not perfect) alignment.		bug: t97593	change-id: i83d36b5db01becbd5cd42edbf630621549becf24	|add legacy bits.wm.o support to text-lb vcl		this is the code that should allow us to move the dns for the	bits.wm.o hostname to the text cluster.		on the tier one backends"	" this adds the bits.wm.o request url/host	mangling before fetching.  on the frontends"	" this supports the	legacy beacon/event/statsv pattern as-it-was"	" as well as the	bits-specific hacks for apache-level https redirects.		the rest of the potential diffs were already ported to shared code	(e.g.  $foo/geoiplookup + geoiplookup.wm.o)"	" already existed in	the text or shared code"	" or are primarily a performance issue	which won't matter at bits' current relatively-low request rate.		bug: t95448	change-id: i3c4f1b938cdcf222ae994d5df970621b74c9ab23	|install varnish reqstats diamond collector on just cp1052 for testing		bug: t83580	change-id: ic3fa9cd81eebbefff40840f986a35f3681f5d36a	|set up /api/rest_v1/ entry point for restbase		there are major performance benefits in minimizing the number of domains we	use to serve content. as documented in t95229"	" total cold-start overheads for	a new domain (dns"	" tcp & tls) seem to exceed 1s with mean ve user's connection	latencies.		this patch sets up a path-based entry point for the rest api at /api/rest_v1/"	"	which avoids this issue by sharing the existing connection(s) to the main	project domain. requests matching ^/api/rest_v1/ are diverted to the restbase	cluster in the backend varnishes. while there might be performance advantages	in doing this in the frontend varnish (especially for esams"	" where we'd reduce	the number of varnish hops from 3 to 1)"	" other considerations like ipsec make	traversing the second layer more practical for now.		additional minor tweaks:		- configure beta labs restbase instance		bug: t95229		change-id: i46e422825af2cf6f972b64e6d50040220ab08995	|"																																																																																																																																																																																																																																																																																																								
"cache: vary statsd_server with hiera		on the beta cluster the varnish caches have a few process that reference	the prodution statsd host:		/usr/local/bin/varnishstatsd --statsd-server=statsd.eqiad.wmnet \	    --key-prefix=varnish.eqiad.backends	/usr/local/bin/varnishxcps --statsd-server=statsd.eqiad.wmnet	/usr/local/bin/varnishrls --statsd-server=statsd.eqiad.wmnet		update the role::cache::* classes to use the generic hiera key 'statsd'	which is defined with:		  hieradata/labs.yaml:# labs statsd instance	  hieradata/labs.yaml:statsd: labmon1001.eqiad.wmnet:8125	  hieradata/common.yaml:# main statsd instance	  hieradata/common.yaml:statsd: statsd.eqiad.wmnet:8125		the three python scripts are in modules/varnish/files they recognize the	'host:port' format and default the port to 8125.		the change for production would be:		- --statsd-server=statsd.eqiad.wmnet	+ --statsd-server=statsd.eqiad.wmnet:8125		such a change could have impacted an icinga check_proc commands that are	defined in modules/varnish/manifests/logging/ "	" but they are invoked	with '-a' and the name of the process"	" eg they don't look at the extra	arguments.		bug: t116898	change-id: i51c754fbec577a73e258922d4fc2054e9b1a854a	|varnish: fix jemalloc chunk size config option name		the option to tune virtual memory chunk size is lg_chunk"	" not	lg_chunk_size. the values we have been using so far have thus been	ignored"	" and the default value for lg_chunk (2^22=4m) has been used.		set the chunk size to 512k (2^19) on cache_text"	" and 1m (2^20) on the	others. we can re-experiment with lower values later on.		bug: t135384	change-id: ia9bf5bd8efc0dc38433f2933ab5214cfc79b0d8b	|cache_upload: switch to file storage backend on varnish 4		on varnish 4"	" the persistent storage backend is buggy (t142810) and	deprecated. switch cache_upload backends to -sfile on varnish 4.		see t142848 for the full reasoning behind the choice of dropping	persistent storage.		bug: t142810	bug: t142848	ref: https://www.varnish-cache.org/docs/trunk/phk/persistent.html	change-id: if6708476a0540f12476485dc1e1d1c077632114c	|caches: reduce fe mem size: 50% -> 40%		we're getting some oomkills of varnishds in ulsfo"	" which has the	upload caches with the smallest physical ram.  clearly we've	crossed some line and need to cut back on fe mem size percentage a	bit for safety in the general case.		bug: t135384	change-id: i19f654922dedb155d022925b7b1a3b382009ec17	|cache_upload: persistent storage backend naming on v4		the persistent storage backend has been renamed into	deprecated_persistent in varnish 4.		bug: t131502	change-id: i41824e1462d0ca7fdc8ea02817c265728fc49fdc	ref: https://www.varnish-cache.org/docs/trunk/phk/persistent.html	|cache_upload: raise fe mem size to 50%		bug: t135384	change-id: i388fa10676dba480fb000031ef84306f2be91246	|cache_upload: 1d fe ttl cap		previous experiment in i24dfc6dc raised to 4h.  there was very	little hitrate effect in the graphs"	" which confirms that ttl is	not the fe hitrate limiter (leaving the obvious remaining	candidates: total set size and/or the passing of range requests).	raising to 1d for the rare cases it matters"	" and to align with the	other cache clusters in general.		bug: t124954	bug: t135384	change-id: i9f37ece5c403256267a2a24b212a5b6351cec070	|cache_upload: experiment with 4h fe ttl cap		upload has traditionally capped the frontend at 1h.  other caches	were historically much higher and have been slowly brought down to	1d.  experimenting with how much of a limitation 1h really is on	fe hitrate (the limit may be set-size more than time).		bug: t124954	bug: t135384	change-id: i24dfc6dcddfc5dbf4d324272322c47a88a0ced01	|raise fe mem size to 37% on text and upload		this gets us halfway further from the current 25% values to the	50% values tested maps and misc (where the cache doesn't often	grow to full size anyways...).  with the new jemalloc tuning"	" the	virtual overhead shouldn't get unreasonable.		bug: t135384	change-id: i05d0a59a72ea7b05367343e717b7f709fd2903b5	|varnish: jemalloc tuning for frontend caches		this should reduce the virtual and resident waste/overhead when	configuring frontend malloc storage with large fractions of total	memory.  note that the chunk size could probably use further	tuning per-cluster"	" but the values in this patch are reasonable	conservative estimates from some basic experimentation/research.		bug: t135384	change-id: ie0bdcbf6a0290b76131a6a43c3013d72b653100f	|cache_upload: raise fe mem from 1/12 to 1/4 total		bug: t135384	change-id: i49f7639468e67c18a01510b6850ff05a2ac071df	|https redirect for all: 2/3 remove vcl_config settings		this removes the vcl_config.https_redirects settings"	" which now	control nothing.  functional no-op"	" but split from previous commit	to avoid any race condition on puppetmaster update.		bug: t103919	change-id: ibd33ffb149c888a70973238a650c6318ece2616b	|vcl: remove vcl_config.do_gzip conditional		this is now on for all clusters and has been for some time.  it's	been toggled off for 1x cluster a couple of times in the recent	past for bug suspicion"	" but the problem always ended up lying	elsewhere"	" so may as well kill some complexity.  we can always	conditional-hack it if we need to for actual experimentation.		change-id: i84c7e3caa31ceaa328959b1ca6351731f50ba35e	|r::c::config: move to hieradata		this also changes the structure a little bit to accommodate future	things.  note that 'misc' cluster never had r::c::configuration	data; it hardcodes all of its (eqiad-only) backends in misc.pp.	will update it to match when we start going after misc-cluster	backends for codfw support.		bug: t127484	change-id: i278c87cc6f7f76d7e98490454762a224e531bff4	|r::c::config: remove has_ganglia		this just mirrors standard::has_ganglia (even in labs!)"	" so switch	all references to that and delete it.		bug: t127484	change-id: ic063d5dbc95be8df92fc7bdd38774b16b055040d	|role::cache::instances: use for upload cluster		bug: t127481	change-id: i33aa45aea67048647ab75ae36cbb9afdd230ef27	|rename cache_remote to cache_eqiad		this makes the backend selection explicit inside the vcl"	" and	paves the way for further refactoring...		bug: t127481	change-id: id78d002b303460c3f01d5cc471f221823460e6d7	|vcl: move layer from vcl_config to instance param		bug: t127481	change-id: ic4baa6640aa11bd4aed5b15fd676bd6c24761c89	|vcl: rename remaining ""backend"" cache backends		this renames 'backend' to 'cache_local' or 'cache_remote' as	appropriate"	" and ditto for the _random variant.		due to race conditions with confd directors vcl"	" this will usually	require 2x puppet runs to stop failing vcl compilation and thus	failing puppet itself...		bug: t127481	change-id: i543e42ed565017ed6be35a77bbaa8969d2d852a4	|remove $::realm conditionals around varnishkafka for labs webrequests		bug: t127369	change-id: i1bf5466549d97201d2aa30eb9b45db9e7f6fe793	|vcl: drop default ttl_cap to 21 days		also sets upload-be explicitly to old default of 30 days"	" so that	it remains unaffected by this change for now (upload-fe already	had an explicit value).  maps cluster already had an explicit	value at both layers.  effectively the drop to 21 days affects	only the ""text"" and ""misc"" clusters (at both layers).		bug: t124954	change-id: i66acf1d36209091b8147e1e9de507837a7e5425e	|vcl: ttl fixed/cap params vcl_fetch		this creates two new vcl_config parameters which affect vcl_fetch	beresp.ttl behaviors:		ttl_fixed: if set"	" all obj.ttl with status < 400 are set to this	ttl_cap: def 30d"	" all obj.ttl >= this are set to this		these replace/standardize existing manipulations of this sort in	the various clusters.  the actual values and applications of the	fixed/cap behaviors are unchanged by this patch in practice.		note that maps-cluster change goes a little further"	" as we're also	removing the remainder of its minimal vcl_fetch (which was to	return deliver)"	" allowing default vcl_fetch hfp behaviors (which	is probably how it should've been anyways"	" and regardless this	cluster is still in testing).		bug: t124954	change-id: i5c7c6908e196701a9e042e46b5f8ad9bca6137a1	|clean up some unused udp2log stuff		bug: t97294	change-id: i02eac9f5172d52732af05fc9a0d91c54b1f5869e	|cache_upload: send randomized pass traffic directly to t1 backends		backend_random is only used for (and for all) ""pass"" traffic (both	explicit and hit for pass).  for tier-2 frontends"	" the jump of	this traffic through tier-2 backends before hitting tier-1	backends is pointless and wasteful: sending it directly to tier-1	backends accomplishes the same thing more efficiently and still	makes use of our ipsec protection for x-dc connections.  in the	long run we'll go one step further and have all frontends	(regardless of tier) contact the applayer directly for pass	traffic and not need ""backend_random"" at all"	" but that's blocked	on further x-dc crypto work.		bug: t96847	change-id: i66813f92fe7763b55b7c05a34238019e77a4e0d0	|add backend_random to maps and upload clusters config		bug: t96847	change-id: i0527274b7f72413a211b92295ebd99825bfb14ea	|cache_upload: remove unused ""rendering"" backend		bug: t96847	change-id: icea46bd013c3441311b6cd23bcf43b515d945041	|varnish: refactor instance parameters (no-op)		switches ""port"" scalar to ""ports"" array"	" and then removes the	""varnish_"" prefixes on related variables that have been fixme for	a while.		bug: t119396	change-id: i9bd3cfdf9a0834f5ce1a1085c9b867349487bf2a	|purging: do not vcl-filter on domain regex		... because we're now splitting the multicast addresses	themselves"	" which is far more efficient.		needs to wait on deploy of mediawiki config change: i8799f7b30		bug: t116752	change-id: i2d2078e7240f16040ecee0fc65059955a0f8d13d	|upload purging: do not listen on text/mobile addr		needs to wait on deploy of mediawiki config change: i8799f7b30		bug: t116752	change-id: if4f0dcf0e4be4f39f9b95247eddc3454b000f5da	|vhtcpd: refac args template"	" allow multiple mc addrs		bug: t116752	change-id: icc0497e2fe8330ed5a451ecc384bd78e719816e0	|deploy varnishreqstats diamond collector on remaining cache hosts		also add ensure parameter to varnish::monitoring::varnishreqstats		bug: t83580	change-id: ied283ac8d40bde07d37add59aecc6aee7548b267	|add varnish reqstats diamond collector for upload caches		bug: t83580	change-id: i5a118fbc6fb23a49544fb99c673655ca1dff201b	|send image varnish frontend data from logs to statsd		this is a modified version of varnishrls for varnish thumbnail access stats		bug: t105681	change-id: iae36f1916f28d568c5a9c76f07c55699a092b63c	|genericize the cluster_nodes-like variables to reduce diffs		bug: t96847	bug: t109286	change-id: i26c206a4a13dc302de4b8a08152c47b2c9bbbb3e	|standardize hiera-overridable class/config params		we had a few different ways of accomplishing the same thing here"	"	and increasingly many of these variables are likely to need to	cross into sibling classes during refactors as well.  this	standardizes the pattern as:		1. class param in r::c::base	2. defaulted for prod in base.pp param list	3. labs override of r::c::b::foo in hieradata/labs.yaml	4. per-cluster copy to $vcl_config as-needed	5. always accessed from vcl_config.fetch() in templates	6. no default-argument in the fetch() call		the affected variables standardized under this scheme are now:	zero_site	purge_host_only_upload_re	purge_host_not_upload_re	static_host	upload_domain	bits_domain	top_domain		this will likely change again at a later point"	" but it's a better	place to be for the moment in terms of factoring.		bug: t96847	bug: t109286	change-id: i6351b0897aaa7ac53ca4482037ff28c31cb9851c	|cache_(text|upload): frontend default_ttl => 30d		bug: t108612	change-id: i1b57d0d69fe3d132be9aa82515ebc15f92a31cc4	|tlsproxy: refactor/cleanup"	" beta work		for production"	" this mostly eliminates some pointless intermediary	classes like role::cache::ssl::local and unifies the configuration	of the ""unified"" cert a bit more between clusters (including new	monitoring for some).		all of the betassl hacks are removed completely"	" and the ssl	related beta conditionals are now reduced to just one small block	in role::cache::ssl::unified.  this will currently break on beta"	"	but the previous config was also broken in beta"	" so no change	there.  i'd rather target convergence than divergence when we	start fixing that on the beta instances"	" and this change brings	them into much closer (if not perfect) alignment.		bug: t97593	change-id: i83d36b5db01becbd5cd42edbf630621549becf24	|fix up varnish director-level retries		non-chash directors get default retries == num_backends.	chash directors get some math to give them a relatively-small	value with 99% probability of hitting all backends while searching	for a healthy one.		bug: t99839		change-id: i15d66e6f14198c365317590a136b755ca4994ce2	|gzip svgs on back upload varnishes.		i noticed the front page of translatewiki.net loading	<http://upload.wikimedia.org/wikipedia/commons/b/b0/openstreetmap_logo.svg>	which is 57.7 kb uncompressed"	" but 11.2 kb compressed. big difference!	so: gzip-compress backend responses with content-type: image/svg+xml.		rt: 5795	bug: 54291	change-id: i64388ed0f0555a2d2260628f189acd358a561c90	|"																																																																																																																																																																																																																																																																																																																												
"contint: rsync server to hold jobs caches		bug: t116017	change-id: ie374ba31ecd4d90aa82af11cd2b04f78367bc903	|"																																																																																																																																																																																																																																																																																																																																																																			
"contint: tidy nodepool slaves config history		nodepool spawns jenkins slaves as non ephemeral slaves"	" that causes the	jenkins config history plugin to save the configuration each time a	node is spawned under /var/lib/jenkins/config-history/nodes.		once 32k entries have been created"	" the file system refuses to add any	more sub directories and no more instances can be spawned (t127131).		a previous attempt 4bbfd3b9 used puppet built-in tidy but its	matches is based on the file basename which is not what we want.		add a cron job using find to garbage collect the files every hour.		bug: t126552	change-id: i3362deef12cf3ddcd3dcdea6052b3ef5be606bc7	|contint: tidy nodepool slaves config history		nodepool spawns jenkins slaves as non ephemeral slaves"	" that causes the	jenkins config history plugin to save the configuration each time a node	is spwaned under /var/lib/jenkins/config-history/nodes. once 32k entries	have been created"	" the file system refuses to add any more sub	directories and no more instances can be spawned (t127131).		use puppet tidy type to garbage collect the nodepool slaves config	history after just one day. it is quiet unlikely we will ever spawn 32k	builds per day.		bug: t126552	change-id: i907f2fff62dee9e31d93e93f0bc4c688f54071f8	|contint: create /var/lib/jenkins/builds		we are moving the jenkins build records under their own directory under	/var/lib/jenkins.		bug: t80385	change-id: i13acee3e3b80e56eaba0132a8d8c0ad63aa8f259	|define backup for contint		bug: t80385	change-id: iec88d1139f27e15a7856bca59c637bbb42895aaf	|"																																																																																																																																																																																																																																																																																																																																																															
"contint: put mysql db on tmpfs for role::ci::slave::labs		this should do the right thing.  in theory.		256m should be enough to start with.		* the current disk-based /var/lib/mysql directory averages	  between 74m and 90m in size. this was captured with three	  concurrent mediawiki-core builds running.	* we allow up to 4 concurrent workers on a slave.	* jobs that also install extra mediawiki extensions can be larger.		bug: t96230	bug: t126699	change-id: i58b76983f57b8d259b96c8a9ad30c0f31b5f3d3c|contint: let us vary localhost vhost unix user		the contint::worker_localhost create an apache document root that needs	to be writable by the user that runs the jenkins jobs. on permanent	slaves that is 'jenkins-deploy' for legacy reasons"	" on nodepool it is	'jenkins'.		make contint::worker_localhost to require a $owner parameter that is	solely used to set the owner of /srv/localhost-worker		adjust the only existing call in this repo which is used by permanent	slaves and thus must use jenkins-deploy.		bug: t136301	change-id: i8f62962c515019bb87fa92937c8c5435e6d53359	|contint: use slave-scripts/bin/php wrapper script		set up /usr/bin/php as a wrapper shell script that chooses the proper	php version to use based on the $php_bin environment variable that is	set by zuul.		since this is a non-standard alternative"	" we need to use	`update-alternatives install`.		bug: t126211	change-id: i9758c8577164d4e528a028ab402020c4c592d1be	|"																																																																																																																																																																																																																																																																																																																																																																	
"kill references to $::instancename		bug: t101447	change-id: i954ac93e29f80e22bebe73a5804b073388888dd2	|"																																																																																																																																																																																																																																																																																																																																																																			
"remove pagecounts-[raw|all-sites] related code		the new pageviews dataset is available"	" therefore pagecounts-raw	and pagecounts-all-sites are deprecated. data already synced on dumps	server is kept"	 as well as already generated html files	" but code	to rsync new data and re-generate html files is deleted.		bug: t130656	change-id: i7a8da8e1248511c379259bd03474109323c9a7a7	|add rsync job for unique_devices dataset.		unique_devices dataset contains daily and monthly files computed	using the last access cookie method (see	https://meta.wikimedia.org/wiki/research:unique_devices).		bug: t126767	change-id: ida5eb1a145c9046d9077e774779db4e998761231	|pull down wikitech dumps and serve them in 'other' datasets		bug: t128680	change-id: if98e9c17220915627d67eb7e761e3e82693cb395	|send web server logs from dataset hosts to stat1002		add rsync class for nginx logs"	" add to dataset primary role		bug: t118739		change-id: i18a31bc95c4ac656ea9dcdb3a603344d14036d03	|disable rsync between ms1001 and dataset1001"	" prep for jessie upgrade		bug: t123724	change-id: i0668dcde2ad0b079217010fda56414ff07b3d822	|"																																																																																																																																																																																																																																																																																																																																																														
disable rsync between ms1001 and dataset1001	" prep for jessie upgrade		bug: t123724	change-id: i0668dcde2ad0b079217010fda56414ff07b3d822	|"																																																																																																																																																																																																																																																																																																																																																																		
"keyholder key cleanup		* clean up the mess that is scap::target and keyholder::agent	* make ssh_agent_proxy look up keys by name instead of fingerprint	** this avoids needing to store fingerprints in puppet manifests	* password-protected key test is now optional and skipped on beta		bug: t132747		change-id: id298a3e0f12e31afd7ea83970e192330ffbd4243	|remove puppet classes and files associated with /srv/mediawiki/private/wikitechprivateldapsettings.php		this file is now installed by the openstack class directly	on wikitech hosts.		bug: t124732	change-id: i3c26f3ae46a13851a75640d54c2ee0421caa2428	|"																																																																																																																																																																																																																																																																																																																																																																			
"role::deployment: make it possible to switch between different servers		bug: t124024	change-id: i33311b76728a6aa9df7d87500b6b3fc90a11a033	|"																																																																																																																																																																																																																																																																																																																																																																			
"stop icinga git remote update		this check has been causing some ownership issues on	/srv/mediawiki-staging for a few months. ideally"	" icinga wouldn't change	the state of a git repository.		use git ls-remote to check the current sha1 of the remote.		bug: t127093	change-id: i921d3f9e75a5ac2a19e1b82e246827ab4e1b7a9a	|include php5-readline package on deployment servers.		bug: t126262	change-id: i8136ffa1ce3be2ca41dab1cde69ff3b0e49a4030	|add new scap::source define to ease bootstrapping of repositories on deploy servers		scap::source will clone your source repo"	 and if scap_repository is set	" it will	clone that repo at /srv/deployment/$title/scap.	this allows for scap/ directories to be separated from source	repositories"	" and allows scap repos to bootstrap themselves on	deploy servers"	" instead of relying on trebuchet.		'scap::sources' is a hiera variable that contains resource declarations for scap::source	that will be dynamically by scap::server.		eventlogging/eventbus is the guinea pig here"	" so this is applied to it.  it is declared	in hieradata/role/common/deployment/server.yaml to clone from the eventlogging repository.		this shouldn't conflict with trebuchet's deployment.yaml clones"	" as the git::clone	will only execute if .git/config doesn't yet exist.		this also moves scap::server's directy hiera_hash lookups to class parameter	based lookups via hiera classpath.  see scap/server.yaml files.		todo: can we use :expand_path nuyaml config in labs?  ask guiseppe.		bug: t118772	change-id: i32bd25a84b182b52db7db81404734f1259b623e6	|hieraize keyholder::agent configuration		move keyholder::agent configuration to hiera to simplify keyholder	configuration. proliferation of *::deploy::source classes is messy	and complicates the already too complex process of adding a new	service group/key to the deployment masters.		bug: t130419	change-id: id5002cc9449deb0223f27af67a30a86c6187bfd9	|add a deployment source & target class for phabricator		this also adds support for key_content => secret('...') in	keyholder so that we can use a newer/cleaner pattern for	specifying the private key.		refs t125851		bug: t114363	change-id: i06eee23c338840fbba8ca81270f5ec0c81e02869	|use aqs-admins group for aqs deployment via deploy-service user		- add aqs-admins to tin	- allow aqs-admins to access deploy-service scap ssh key in keyholder		bug: t127720 t126294	change-id: i92a510496118dfdbfde5317d1a1eac58de4a328a	|deployment: backup /srv to bacula		adds a new backup file set"	" consisting of the entire /srv.	applying it on deployment servers via the role class.		the size of /srv is currently 26g on mira.		bug:t125527	change-id: ie4cc48b14737948c0f5fdfa08e57db23ff0f4130	|deployment: activate redis replica between the masters		any master that is not the current deployment server will replicate its	data"	" as trebuchet is configured to speak only with the current master.		bug: t124024	change-id: ibe245b5fe0ebf927d55f4843e7dfcd71f1b44b64	|puppetize eventlogging-service with systemd in role::eventbus		deployment via scap3.		this patch works in beta.  there is still work to be done"	"	but the patch is getting too large.  further work	will proceeed in new changes.		no changes on eventlog1001 according to	https://integration.wikimedia.org/ci/job/operations-puppet-catalog-compiler/1506/		todo: move role::eventbus::eventbus back to role::eventbus when t119042 works.	todo: use role::kafka::* to get kafka config.		bug: t118780	change-id: i621de844ed7a5bd1ac532b52058925350d9e5337	|"																																																																																																																																																																																																																																																																																																																																																									
"add alert for elasticsearch 50th percentile prefix search time		typically prefix search is around 10-30ms. if it hits 75 or 150ms	there is almost certainly something wrong that should be addressed.		requires adding discovery-alerts@lists.wikimedia.org to the private	puppet repo containing alerting email addresses (contacts.cfg)		bug: t124542	change-id: i9c7b79f7af221c0d32ba1c6baa39c55f1bc92d8d	|"																																																																																																																																																																																																																																																																																																																																																																			
"fix for analytics-search-user changes		can't include admin::groups in multiple roles		bug: t122620	change-id: i486a11dba9100595474d8ab5c28121e6a25c3bce	|create new puppet group analytics-search-users		creates a new puppet group for deploying search related analytics	tasks to the hadoop cluster. sets up trebuchet to handle deployment	of the repository to stat1002 and sets up a user for use on stat1002	to deploy into hdfs.		bug: t122620	change-id: i3cca84f0b8066a4ba2c941c1edf8afc264b36b64	|"																																																																																																																																																																																																																																																																																																																																																																			
"remove g+w flag to /srv/log/eventlogging to allow proper logrotation		logrotate fails regularly with the following message:	""error: skipping ""/srv/log/eventlogging/eventlogging-service-eventbus.failed_events.log""	because parent directory has insecure permissions	(it's world writable or writable by group which is not ""root"")	set ""su"" directive in config file to tell logrotate which	user/group should be used for rotation.		i am not seeing any reason why we shouldn't go to 755 but the alternative	would be to set the su directive in the logrotate file.		bug: t132324	change-id: i739f8937e1c3e01d450425e0b040b9da5f7116a5	|kafka config: add config functions		up until now"	" kafka configuration has been held in	role::kafka::(main|analytics)::config"	" which are mostly copy/pastes of	each other. this patch consolidates them by introducing two functions:	kafka_config and kafka_cluster_name"	" the former using the latter. this	allows us to elegantly get the config by simply using the cluster prefix	we are interested in:		  $analytics_conf = kafka_config('analytics')	  $main_conf      = kafka_config('main')		bug: t130371	change-id: i206b54d10e8188e7775d3f6621c8d4cc60e0d269	|eventlogging::service::* classes now depend but don't include eventlogging::server		this is so the path to eventlogging source code can be configured per deployment	target.  this should be a no-op on eventlog1001.		bug: t118772	change-id: i55600577a534161781833b6fa7fc51a423066482	|create new eventlogging::analytics role in modules/role"	" use scap for deployment		this is only the deployment of a new cloned repo to eventlog1001"	" it does not affect	the running deployment or daemons.		bug: t118772	change-id: ib37ec5a3aba1a9e018a700d4271b4930d4dc5472	|add new scap::source define to ease bootstrapping of repositories on deploy servers		scap::source will clone your source repo"	 and if scap_repository is set	" it will	clone that repo at /srv/deployment/$title/scap.	this allows for scap/ directories to be separated from source	repositories"	" and allows scap repos to bootstrap themselves on	deploy servers"	" instead of relying on trebuchet.		'scap::sources' is a hiera variable that contains resource declarations for scap::source	that will be dynamically by scap::server.		eventlogging/eventbus is the guinea pig here"	" so this is applied to it.  it is declared	in hieradata/role/common/deployment/server.yaml to clone from the eventlogging repository.		this shouldn't conflict with trebuchet's deployment.yaml clones"	" as the git::clone	will only execute if .git/config doesn't yet exist.		this also moves scap::server's directy hiera_hash lookups to class parameter	based lookups via hiera classpath.  see scap/server.yaml files.		todo: can we use :expand_path nuyaml config in labs?  ask guiseppe.		bug: t118772	change-id: i32bd25a84b182b52db7db81404734f1259b623e6	|prefix eventbus kafka topics with datacenter name		bug: t130562	change-id: ibae1977fc7d73ef76d8db3676c6303fa911e48c3	|create eventschemas module"	" use this in eventbus role		add ability for eventlogging-service to reload (sighup) on	puppet resource changes.		bug: t127099	change-id: ibe8670b67cf5c77a6b1fc8bbd340634850a9563f	|make scap::target use the scap3 package provider		this also updates eventbus to pass manage_user=>false	refs t113072		bug: t127215		change-id: i223a9fff2d48a3372ca14e56ae94087a6530f9ee	|add lvs/pybal config for eventbus		bug: t118780	change-id: idd996753d018afbe5bd56d17c5e01e9f58c5086e	|puppetize eventlogging-service with systemd in role::eventbus		deployment via scap3.		this patch works in beta.  there is still work to be done"	"	but the patch is getting too large.  further work	will proceeed in new changes.		no changes on eventlog1001 according to	https://integration.wikimedia.org/ci/job/operations-puppet-catalog-compiler/1506/		todo: move role::eventbus::eventbus back to role::eventbus when t119042 works.	todo: use role::kafka::* to get kafka config.		bug: t118780	change-id: i621de844ed7a5bd1ac532b52058925350d9e5337	|"																																																																																																																																																																																																																																																																																																																																																						
"gerrit: make ipv6 optional		there is no ipv6 support in labs. this makes it easier	to test and use the actual production role there.		bug: t133070	change-id: i4938e3e4442e09205016a65f114a096adbedb54a	|gerrit: simplify ssl and hostname management		- don't pass it around the role if we don't need to	- use letsencrypt if we don't have a dedicated cert		bug:t125018	change-id: i830bc1fa60d775236200996425b9c633f435b40c	|"																																																																																																																																																																																																																																																																																																																																																																			
"grafana: refactor production role into base role		in preparation for introducing a labs grafana role		bug: t120295	change-id: i362e58ebe0bfee41fa97ed989a5de9c8085a05e8	|"																																																																																																																																																																																																																																																																																																																																																																			
"grafana: expand edit access in labs grafana		this is anyone with shell access to any project on labs.		bug: t120295	change-id: idc8c17f57bf80160ed908c2ce59c00b5c5a5011c	|grafana: add and provision labs grafana role		bug: t120295	change-id: i24036bd3298f3e6f679d37ee9ed1a69ce39fa1ad	|"																																																																																																																																																																																																																																																																																																																																																																			
"grafana: refactor production role into base role		in preparation for introducing a labs grafana role		bug: t120295	change-id: i362e58ebe0bfee41fa97ed989a5de9c8085a05e8	|grafana: mark role explicitly as production		bug: t120295	change-id: i245e877a68540eb61fe35b37bd1c9329c8213a88	|"																																																																																																																																																																																																																																																																																																																																																																			
"add alerting for mediawiki exceptions and fatals		watch the rate per minute of mediawiki exceptions and fatals. warn if it	exceeds 25; panic if it exceeds 50. i hope we can gradually make these numbers	lower"	" but for now we need to make sure we're not too noisy or we'll	inadvertantly train people to ignore the alert.		bug: t140942	change-id: i638d270e52a559a5b6bc0f68788172869ca2d888	|kafka config: add config functions		up until now"	" kafka configuration has been held in	role::kafka::(main|analytics)::config"	" which are mostly copy/pastes of	each other. this patch consolidates them by introducing two functions:	kafka_config and kafka_cluster_name"	" the former using the latter. this	allows us to elegantly get the config by simply using the cluster prefix	we are interested in:		  $analytics_conf = kafka_config('analytics')	  $main_conf      = kafka_config('main')		bug: t130371	change-id: i206b54d10e8188e7775d3f6621c8d4cc60e0d269	|make all kafka broker metrics prefixed with kafka.cluster.$cluster_name		bug: t121643	change-id: i9cac3f83a2c79dc895dcbed81b689144bc73c6da	|"																																																																																																																																																																																																																																																																																																																																																															
"cache_mobile decom: 2/2 remove most cache config		after this we can manually stop various daemons on these hosts and	leave them idle (but still configured with ""standard"") for a few	days until they're re-purposed.		bug: t109286	change-id: i51354c8abc76c480146f61210cb4f8f55e889a7d	|"																																																																																																																																																																																																																																																																																																																																																																			
"graphite: parametrize cors_origins for labs		bug: t143556	change-id: ia424041cddb5c23ae217ebce86f33fe82b7bb720	|introduce a hourly storage schema in graphite		maps needs to collect hourly metrics.		this introduces an hourly schema which can be used to store hourly metric"	"	with 1-day aggregation after 1 year. this follows the same pattern as the	existing daily schema.		the space gained by this is fairly small (130k per metric vs 300k per metric	for the default schema)"	" but will help not having holes in time series for	metrics collected hourly.		bug: t143048	change-id: i69e7d38b070f8c6348cc62f5fab808d56911e414	|graphite: add cluster_servers graphite-web setting		moving to multiple graphite machines means instructing graphite-web to ask	other servers for metrics when queried		bug: t85451	change-id: i71697f084f40c1bbdb0217f5136b34d01170c0dd	|graphite: permit line protocol traffic from all_networks		following i68f585093d we'll need to grant access from public networks too		bug: t121861	change-id: i3b8248fcd6641923db8dc25d637317e578ae9329	|"																																																																																																																																																																																																																																																																																																																																																																	
"iegreview: switch from parsoid to restbase		change the wikitext to html endpoint used from parsoid to restbase.		bug: t114186	change-id: i2101dcd910aa9a4c52ff9322120236dd77d8b0c8	|"																																																																																																																																																																																																																																																																																																																																																																			
"add the analytics contact group to hadoop/kafka related nrpe monitors.		the final goal is to raise awareness of kafka/hadoop issues directly on	the analytics irc channel.		bug: t125128	change-id: ifa5da3308225645620da45a8e3e4695ad82b531f	|limit the maximum kafka topic partition size to 500gb.		there is an open bug in kafka >= 0.9 that sets all the broker log	segments' mtime to now when a broker is restarted. this change will	ensure that log segments will get automatically purged if a topic	partition size will exceed 500gb. this setting will interfere	with the global temporal based retention policy of 7 days.		bug: t136690	change-id: i14714cb09b8da162aefcd3dadc6d93fdf071a78f	|fix default replication factor in clusters with less than 3 brokers (labs)		bug: t121562	change-id: i367ddda6412f1719f01b6d13849ddb390ce51452	|add temporary hiera config to contitionally set broker protocol version		bug: t121562	change-id: i7e100b5eb7af6876e39de899ba625b63c8340883	|fix ferm rule for confluent kafka broker		also add kakfa to list of typos		bug: t121562	change-id: if53f8146edfed832307fb8eb3ff345431854806c	|fix include and thresholds for icinga alerts for confluent kafka brokers		bug: t121562	change-id: i7062da55b377c2de9f3fe7d8976b7a9f5d38134a	|alter role::kafka::analytics::broker to be able to use confluent module during upgrade		the older kafka module use will be removed from this role once the upgrade is complete.		bug: t121562	change-id: i0ab53bc2e4b279e8705833fe7480152a872abaa9	|kafka config: add config functions		up until now"	" kafka configuration has been held in	role::kafka::(main|analytics)::config"	" which are mostly copy/pastes of	each other. this patch consolidates them by introducing two functions:	kafka_config and kafka_cluster_name"	" the former using the latter. this	allows us to elegantly get the config by simply using the cluster prefix	we are interested in:		  $analytics_conf = kafka_config('analytics')	  $main_conf      = kafka_config('main')		bug: t130371	change-id: i206b54d10e8188e7775d3f6621c8d4cc60e0d269	|restore nf_conntrack_max setting for the analytics kafka brokers.		we added a graphite metric (using a diamond script) to track	nf_conntrack_count and observed the kafka hosts behavior over	the past days. the count is back to ~130k as expected"	"	and we verified that the previous spikes were related to a surge	of time_waits flows (src mw hosts"	" dst kafka hosts).	now that we have visibility and we established that previous	nf_conntrack_count levels were abnormal"	" we can remove this temporarily measure.		bug: t131028	change-id: i11cba2624f324c9cb262ffcbb708930b36508473	|add netfliter nf_conntrack diamond collector to kafka brokers.		bug: t131028	change-id: id83f275c00577f632c1dd01ed14d8396449700c0	|bump nf_conntrack_max temporarily to allow proper investigation.		bug: t131028	change-id: ie9bdd0c7c55b3315f33cf82a7130c7cb55b30c53	|make all kafka broker metrics prefixed with kafka.cluster.$cluster_name		bug: t121643	change-id: i9cac3f83a2c79dc895dcbed81b689144bc73c6da	|using more generic roles for kafka classes"	" configuring new main brokers kafka[12]00[12]		this will eventually also deprecate role::analytics::kafka::* in favor of role::kafka::analytics::*	role::kafka::analytics::* is not yet included anywhere"	" but will be after this puppetization	is applied and verified to work on the new brokers.		bug: t120957	bug: t121553	bug: t121558		change-id: ifec423daa5d9b2a3d3e6e4b0bd12dda5639b8594	|"																																																																																																																																																																																																																																																																																																																																																											
"kafka config: add config functions		up until now"	" kafka configuration has been held in	role::kafka::(main|analytics)::config"	" which are mostly copy/pastes of	each other. this patch consolidates them by introducing two functions:	kafka_config and kafka_cluster_name"	" the former using the latter. this	allows us to elegantly get the config by simply using the cluster prefix	we are interested in:		  $analytics_conf = kafka_config('analytics')	  $main_conf      = kafka_config('main')		bug: t130371	change-id: i206b54d10e8188e7775d3f6621c8d4cc60e0d269	|move burrow role to kafka/analytics		note that this commit removes the last manifests/role/analytics/* file		bug: t109859		change-id: id19308159659c84d480fe5aa02356438d6c50da1	|"																																																																																																																																																																																																																																																																																																																																																																
"mirror all topics in main-eqiad topics into analytics-eqiad		bug: t134184	change-id: ib1a88008cce0477cdacdc3f5516aaf43987407be	|confluent mirrormaker puppetization		this removes the old analytics mirror role.  it will be recreated in a new patch.		bug: t134184	change-id: i91d8545117119648c5ba4376ada6642751c8206e	|kafka config: add config functions		up until now"	" kafka configuration has been held in	role::kafka::(main|analytics)::config"	" which are mostly copy/pastes of	each other. this patch consolidates them by introducing two functions:	kafka_config and kafka_cluster_name"	" the former using the latter. this	allows us to elegantly get the config by simply using the cluster prefix	we are interested in:		  $analytics_conf = kafka_config('analytics')	  $main_conf      = kafka_config('main')		bug: t130371	change-id: i206b54d10e8188e7775d3f6621c8d4cc60e0d269	|"																																																																																																																																																																																																																																																																																																																																																																
"prepare for upgrading kafka main-eqiad to confluent kafka 0.9		bug: t138265	change-id: i56bfebb0ed5481fc02ff70d4d7fd0c3689b0791b	|finalize main-codfw kafka upgrade		bug: t138265	change-id: if95055c1cf84a4da09aee35151632533ef889816	|upgrade kafka main-codfw to 0.9		bug: t138265	change-id: ic7c612550138a33faf25e50748b02b0a09537502	|kafka config: add config functions		up until now"	" kafka configuration has been held in	role::kafka::(main|analytics)::config"	" which are mostly copy/pastes of	each other. this patch consolidates them by introducing two functions:	kafka_config and kafka_cluster_name"	" the former using the latter. this	allows us to elegantly get the config by simply using the cluster prefix	we are interested in:		  $analytics_conf = kafka_config('analytics')	  $main_conf      = kafka_config('main')		bug: t130371	change-id: i206b54d10e8188e7775d3f6621c8d4cc60e0d269	|add netfliter nf_conntrack diamond collector to kafka brokers.		bug: t131028	change-id: id83f275c00577f632c1dd01ed14d8396449700c0	|make all kafka broker metrics prefixed with kafka.cluster.$cluster_name		bug: t121643	change-id: i9cac3f83a2c79dc895dcbed81b689144bc73c6da	|use $group_prefix for main kafka cluster checks		bug: t122330	change-id: i33ebb21107e1052e21ac3ecfc47fd1f2b579319d	|using more generic roles for kafka classes"	" configuring new main brokers kafka[12]00[12]		this will eventually also deprecate role::analytics::kafka::* in favor of role::kafka::analytics::*	role::kafka::analytics::* is not yet included anywhere"	" but will be after this puppetization	is applied and verified to work on the new brokers.		bug: t120957	bug: t121553	bug: t121558		change-id: ifec423daa5d9b2a3d3e6e4b0bd12dda5639b8594	|"																																																																																																																																																																																																																																																																																																																																																														
"mirror main-eqiad into main-codfw		this will only set up mirroring eqiad -> codfw.  we will	make sure this works first"	" and then also set up codfw -> eqiad mirroring.		note that this is the first patch in gerrit change https://gerrit.wikimedia.org/r/#/c/304928/1.	future patches to that change were attempts to make main cluster mirroring much more	flexible and testable in labs using a new puppet function kafka_mirror_instances().		due to time constraints and difficulty getting tests to work"	" we are going	with this simple prod-only version for now.		this also fixes a bug in kafka_cluster_name that would return inverted	site/prefix if given both arguments.		bug: t134184	change-id: ibc1818ef287cc37f4048ac86cfb609fa121c3e92	|"																																																																																																																																																																																																																																																																																																																																																																	
"labsdb: include labs salt groups and prometheus monitoring for dbs		bug: t126757	change-id: ibec339faeff2b44eae89b7fbe5e50ab1b6ed8be0	|"																																																																																																																																																																																																																																																																																																																																																																			
"labsdb: include labs salt groups and prometheus monitoring for dbs		bug: t126757	change-id: ibec339faeff2b44eae89b7fbe5e50ab1b6ed8be0	|setup the new labsdb hosts with a new role		bug: t140452	change-id: i2c0b24dc34048439b44548b317182b4ee7ceb9ff	|"																																																																																																																																																																																																																																																																																																																																																																			
"labsdb: include labs salt groups and prometheus monitoring for dbs		bug: t126757	change-id: ibec339faeff2b44eae89b7fbe5e50ab1b6ed8be0	|"																																																																																																																																																																																																																																																																																																																																																																			
"document needed database steps when setting up a new labservices box		bug: t136065	change-id: ib573f9e013c3918e75aca58c13a796448460a51f	|fix grants for labs pdns		* add proper pdns_admin password	* add grants for designate host		bug: t128737	change-id: i3d40a2c55c6348dbff341e0a2ecb1da32a38a8b9	|add grants to pdns mysql for localhost		bug: t128737	change-id: ibbba418287b0dd70178e54ad042225775c9244cc	|icinga labs auth dns check update description		make the protocol description fields distinct		bug: t124680	change-id: i921134a52897c8eef9e1c705618cbfe7feb36350	|add mysql to labs dns servers		bug: t128737	change-id: icb43e2191b3821c0f47a679d2828d73adbdb357b	|"																																																																																																																																																																																																																																																																																																																																																																			
"puppetise script to manage labs floating ip ptr records		relies on existence of a '128-25.155.80.208.in-addr.arpa.' zone under the wmflabsdotorg project.		has been tested both in labtest and had an initial run on silver.		bug: t104521	change-id: ibe5a64ea472f230f5c959baa75b8cbb6883d7cbb	|"																																																																																																																																																																																																																																																																																																																																																																			
"labs dnsrecursor: add tcy.wiki(pedia)		bug:t140898	change-id: ia5fa4be4783c9bf1bee11644b22e4d289dafd835	|increase the cache size for the labs dns recursor		currently we're getting a 10-15% hit rate.  let's see	if growing the cache gets that rate up any higher.  this	is a 3x increase.		bug:  t124680	change-id: i78749de04cbbbfc68983035e9edd340fb820a7b8	|add jam.wikipedia to restbase and labs dnsrecursor		bug: t134017	change-id: idd6582be8a1d27024ff938bae3abe40ecc7e3bad	|labs dnsrecurser update settings		* don't cache negative lookups for that long	* max tcp dns requests per client lower		bug: t124680	change-id: i6d1c6d2015e0e6fc022ca06e8efb34c7a0dae46c	|labs: set tools zonefile to be loaded		bug: t118758	change-id: i527a5af61d4c2cd2cdbef7a78d394acef09ffec5	|labs: add cnames for tools specific things		bug: t118758	change-id: ic3a1728783b0b6664e930493ff9e98b13f1b3fb0	|labsdb1003 is a bit overloaded right now"	" move commonswiki to 1		there has been several reports of slowness on c3 (labsdb1003)"	"	while some were created by unproperly cached requests"	" that has	been already solved and now there is still several users hitting	hard commonswiki. move those to labsdb1001"	" which is slightly less	loaded.		bug: t127940 t127266	change-id: if8aee7d04e3818140f07f493ab989d965a07b935	|depool labsdb1002		bug: t126942	change-id: ia7143e2f528e6cf24dac0c0e56935bd07901aa85	|restbase and labs dns configuration for ady.wikipedia		bug: t125501	change-id: i4cda48113ab4d34b978026f04a86ebf54240c690	|add restbase and labs dns config for wikimania2017wiki		bug: t122062	change-id: ic03c3ed01c730ad43a93ae6cd05694469da94481	|"																																																																																																																																																																																																																																																																																																																																																															
"graphite: parametrize cors_origins for labs		bug: t143556	change-id: ia424041cddb5c23ae217ebce86f33fe82b7bb720	|graphite: move labs graphite to graphite-labs.wikimedia.org		bug: t140899	change-id: i6babde830181d8e613735b0088506c24b9e244a5	|"																																																																																																																																																																																																																																																																																																																																																																			
"labs: allow setting nfs mounts to be soft via hiera		bug: t127224	change-id: i081bd212b043327c66f4f854f16c4d621e630a3c	|"																																																																																																																																																																																																																																																																																																																																																																			
"role::labs::lvm::mnt:  allow mount_point to be set from hiera		bug: t101447	change-id: ia36380fe0d8436c04baaaea178290782012a41d8	|added filtertags to labs role descriptions.		this is an experiment to spruce up role filtering	for the new labs puppet gui		bug: t91990	change-id: ic25662a110068969240083f6f4f9986628388898	|"																																																																																																																																																																																																																																																																																																																																																																			
"added filtertags to labs role descriptions.		this is an experiment to spruce up role filtering	for the new labs puppet gui		bug: t91990	change-id: ic25662a110068969240083f6f4f9986628388898	|"																																																																																																																																																																																																																																																																																																																																																																			
"added filtertags to labs role descriptions.		this is an experiment to spruce up role filtering	for the new labs puppet gui		bug: t91990	change-id: ic25662a110068969240083f6f4f9986628388898	|"																																																																																																																																																																																																																																																																																																																																																																			
"labstore: misc don't shadow remounts default		bug: t126083	change-id: i737f54592c6d0222d01dde7c1ce1968fffe7ec0b	|labstore: statistics and scratch mount definitions		change-id: i45e3481e8a2004eab2b377b5a2a9d191be7bf0ac	bugs: t126083	|"																																																																																																																																																																																																																																																																																																																																																																			
"labstore: nfs-exportd monitoring into a manifest		bugs: t126083	change-id: i2162860119d723fbe968f3ca9f257214f66f655b	|labstore:  run nfs-exports-daemon on all servers in a cluster		* run where module is applied regardless of active statu	so that any secondary has a good copy of the data	* move monitoring definitions to the role	* run on secondary cluster (coming soon 1004/1005)		bug: t126083		change-id: ie299dc5069d3db47d1e8b05a4ce5c043a40207cf	|"																																																																																																																																																																																																																																																																																																																																																																			
"labstore:  run nfs-exports-daemon on all servers in a cluster		* run where module is applied regardless of active statu	so that any secondary has a good copy of the data	* move monitoring definitions to the role	* run on secondary cluster (coming soon 1004/1005)		bug: t126083		change-id: ie299dc5069d3db47d1e8b05a4ce5c043a40207cf	|labstore100[4|5]: define initial labstore::drbd::resource		bug: t126083	change-id: i038a55884eadcae39f327339fee76909e6c31d49	|introduce fileserver::secondary role		this is going to be a transition from the existing	labstore1001 which is currently ""primary"".  for now	the new cluster will be secondary until we transition	to it as primary to revise the current setup.		bug: t126083		change-id: iedef8c1d1324ae127e78e9034a8f30ed4a661375	|"																																																																																																																																																																																																																																																																																																																																																																			
"nfs: modify /data/scratch on nfs clients to point to mount from labstore1003		this patch removes the old mount from labstore1001 on /data/scratch"	" and then	makes this path a link to the mountpoint /mnt/nfs/labstore1003-scratch"	" which	serves /scratch from labstore1003. this step is invasive and assumes that	the scratch from labstore1003 is already available at the described mount path.		bug: t134896	change-id: i1d86cdd94246f7c6d824526b772918d90ea30f2c	|tools: mount scratch on labstore1003 as well		in anticipation of moving scratch		bug: t134896	change-id: i2f9e80aa13b77b98b6419b024d428a4862143268	|labs: allow explicitly specifying lookupcache via hiera		bug: t139769	change-id: i9458334ff21f5646ff1ade2f5885e16966f6bad4	|"																																																																																																																																																																																																																																																																																																																																																																	
"dynamicproxy: add nginx config to redirect www.wmflabs.org/wmflabs.org to wikitech		to https://wikitech.wikimedia.org/wiki/portal:wikimedia_labs specifically		latest ps needs testing on labs-dynamicproxy-test.openstack.eqiad.wmflabs		bug: t38885	change-id: i487174a20bfe0d2ebc113b736a492307c3e34ec8	|"																																																																																																																																																																																																																																																																																																																																																																			
"designate:   open firewall to axfr traffic from pdns hosts.		previously the secondary pdns server was unable to get xfr updates	from designate-mdns.  it stayed in sync by accident"	" due to sharing	a commmon db with the primary pdns server.		this may also have caused lockups"	" if the secondary was holding	a lock on the database while waiting for an xfr update.		bug: t124680	change-id: ie26af2f6e51e91ec3695718ee5d8e7c3bb4af861	|"																																																																																																																																																																																																																																																																																																																																																																	
"add modules-load.d/kmod configuration for br_netfilter for linux >= 3.18		starting with 3.18 (34666d467cbf1e2e3c7bb15a63eccfb582cdd71f) the	netfilter code was split from the bridge kernel module into a	separate module (br_netfilter).		ideally"	 the nova upstart job/systemd unit would deal with that	"	but let's load it in puppet for now.		bug: t142388	change-id: i9d66a39d62caa6c80a74894da9c633e57197edd9	|create /srv/math-images on wikitech hosts		to deploy math extension on wikitech hosts"	" we need to write files.		as it's not desired to connect to swift"	" we'll store files locally.		bug: t126628	change-id: if99e9ecdec634a4378fdef3dcfbeae7d54bf7373	|increase conntrack limits for nova compute nodes.		bug: t139598	change-id: id84c67064ec78f9d2c197ada2b33c44895b49d91	|allow horizon hosts to contact the labs puppetmaster.		bug: t91990	change-id: i5d4e5898d5ae7c54a05492a0d74b14c5e5792141	|set up let's encrypt certificate for labtestwikitech		bug: t133167	change-id: i65f67dc404e713ad8545ebfb68f946abebf8c66b	|support totp auth in keystone		bug: t105690	change-id: i5e067bcd326a345616139e307336e44591734aad	|add texvc to role::labs::openstack::nova::manager		this change allows to deploy the math extension to wikitech.		bug: t126468	change-id: ie8e721d02e91963ff5464568f6d77f6ceb32e66d	|remove reference to labs_nova_controller_other		we don't have a controller in codfw.		bug: t123790	change-id: ib15ee1c3f4acd4a09c524bf45eee1f5e0eb926a8	|nova::controller: remove firewall hole for http(s)		labcontrol servers are ""openstack::nova::controller""s		silver (wikitech) is a ""openstack::nova::manager""		the latter needs to have ports 80/443 open for access to wikitech"	"	but the former does not"	" there is a puppetmaster on this but using a	different port and no other sites.		this class is only on labcontrol servers and these servers	don't have any apache sites or no apache at all. (if in codfw?!)		so this firewall hole is not needed at all and exposes a default apache	install that it doesn't need.		bug:t120449	change-id: i23a3c480239827de3f64b595961152425b664b5d	|add labs_baremetal_servers hiera item.		this is a list of ips which will allow us to open firewalls	appropriately for labs bare metal servers.		bug: t120262	change-id: ib45203c49f51555e0be833978ec19ecf84428343	|interface: use allow-hotplug for ::manual and ::tagged		note that ::manual is only used by lvs"	" which is what we're trying	to affect here"	" so the change there is unconditional.  ::tagged is	also used by role::labs::openstack::nova"	" so i've given ::tagged a	hotplug parameter defaulting to true"	" and changed nova.pp to	explicit set that to false to preserve existing behavior there.		this requires some careful manual pre-puppet steps on the lvs	machines themselves (making puppet handle the change automagically	isn't worth the complexity!)"	" and should be a no-op on the	affected nova role.		bug: t110530	change-id: i574068c9ece38b37e3c67abc333b24435415ee8e	|"																																																																																																																																																																																																																																																																																																																																																								
"adds compute node role to ores		bug: t130461		change-id: ic1d75bf50bdcb728023c3a702430746b622f3500	|"																																																																																																																																																																																																																																																																																																																																																																			
"ores: puppet changes for the refactor		it has been done in a backward-compatible way	bug: t141575		change-id: idb6fed027f1f06c60306200b1f47c8cb143bca11	|ores: changes for configs for the refactor		bug: t141575	change-id: i8dd347020323a1554602edd9aa1ce4d56166d51b	|ores: deprecate flower		we use graphite now"	" removed the role already in	https://wikitech.wikimedia.org/w/index.php?oldid=610289		bug: t137003	change-id: i7d37e7143f1ef8b58ee40e0f7937aaae2f098dc2	|"																																																																																																																																																																																																																																																																																																																																																																		
"ores: puppet changes for the refactor		it has been done in a backward-compatible way	bug: t141575		change-id: idb6fed027f1f06c60306200b1f47c8cb143bca11	|ores: changes for configs for the refactor		bug: t141575	change-id: i8dd347020323a1554602edd9aa1ce4d56166d51b	|"																																																																																																																																																																																																																																																																																																																																																																			
"labs: generate/store root passwords for instances		each project will have a root password that applies to all	project instances.  the password is stored in	/var/local/instance-root/passwords/$projectname on the labs	puppetmaster.		passwords are automatically regenerated if the file is missing"	"	so removing the password file is an easy way to reset passwords	if needed.		bug: t142216	change-id: ia9eb2bdb5879fe074ecb9e175f57f3849ff52821	|allow access to the labs puppetmaster from labs metal hosts.		bug: t95185	change-id: icc57ebb65e6ff94bedd7ad44e64e0f9b2f4254f1	|"																																																																																																																																																																																																																																																																																																																																																																		
"new role: role::labs::redirector		role installs nginx and configures multiple named vhosts which each map	to a single 301 status redirect.		bug: t134508	change-id: ifdcea0a65077e7d5e4e0bb2139ddf9a8bfb43511	|"																																																																																																																																																																																																																																																																																																																																																																			
"labs: don't have shinken do basic instance checks		temporary until we get new hardware		bug: t137753		change-id: ib58b610c7790d14536fb7ddf937363083f4405c3	|labs: remove shinken monitoring for tools / deployment-prep		temporary until we get new hardware		bug: t137753	change-id: iacfa9b7c465beba0f4e484cdb8cec9aabc42b20e	|"																																																																																																																																																																																																																																																																																																																																																																			
"tools: set homedir permissions properly in kube-maintainusers		otherwise if it created homedirs it was setting them to be	readable and writeable only by root		- stops toolswatcher"	" remove all files related	- reduce runtime sleep from 5min to 1min - this puts a	  bit more load on the ldap servers but is probably ok	  because we can stop toolswatcher		bug: t140460	change-id: i23e06ea5de8115904e606b1580aa3f7391157559	|"																																																																																																																																																																																																																																																																																																																																																																		
"lvs configuration for maps cluster in eqiad		bug: t142393	change-id: i73ffe86c21b375e3d578a4b4c3925dd854eaf2e7	|prometheus: add to lvs		also deploy service ip on prometheus eqiad/codfw.		note that lvs::realserver is applied to the hosts individually"	" not the	""prometheus server"" role. many such roles can coexist on the same host"	"	irrespectively of lvs"	" also not every prometheus server is behind lvs.		bug: t126785	change-id: ibf89504a06a69aca62af3f200d93dc4615e05023	|lvs: add thumbor to lvs		there will be nginx listening on port 8800 and revproxing to multiple thumbor	instances.		bug: t139606	change-id: ia6c7248b82b385b0425f18d4f3494f77a2a8eac0	|remove old rcstream public lvs config		dns was moved off of these ip addresses a couple of weeks ago"	" and	no clients are shown connecting to these ips in live lvs data	anymore.		followup commit removes conftool-data"	" for after pybal has been	restarted.		bug: t134871	change-id: i31e9f1ef5034634ecdca72590dd2abf0c660442f	|lvs: add ores		introducing ores as an low-traffic lvs service		bug: t124202	change-id: i2efa80074dbb8edbcc7847e55664f249a6aafcbc	|add lvs configuration for eventbus in codfw (dns reverse/wmnet config already in place).		bug: t121558	change-id: i32092b499a27036e8427fb42ce96693c141a66ad	|cache_maps: add all sites in lvs		bug: t109162	change-id: if0ced5f4e59314e92b8033ba417ced17098149e7	|lvs: sc[ab] services lvs configuration		* proxyfetch urls already fixed in ib218dcae2e4eb1	* add codfw ips	* partially add codfw icinga checks	* update descriptions to be site dependent	* add lvs ips to the balancer	* update icinga configuration to pretend we at least send a correct-ish	host: header even if we dont really		add lvs ips and definitions for codfw services residing in sca"	" scb		bug: t129234	change-id: i527b1f084f882c8548eb7391caf1d4bd9c326347	|parsoidcache: remove from lvs		bug: t110472	change-id: id82a0e286801339703f0743436d2c3617adc4a1f	|add lvs/pybal config for eventbus		bug: t118780	change-id: idd996753d018afbe5bd56d17c5e01e9f58c5086e	|pybal: install monitoring		this creates both data collection in graphite via diamond and an nrpe	check for pools in a critical state.		bug: t102394	change-id: i0916d4a7659050c6b733cab93783c1db3d2aace7	|reprepro: add an experimental component		currently only under jessie-wikimedia.		also add stanza to role lvs::balancer to enable it"	" as we need to	include newer kernels and their firmware there.		bug: t119519	change-id: i675d3f46a06278a15aab2562e83c36c27a7ba8f3	|cache_misc: add lvs service ips to balancers themselves		bug: t119394	change-id: i3c03fb5a836c72b039da3aeb6dc37e926ab95300	|aqs: add lvs configuration		add configuration for aqs lvs setup. mark it as low-traffic"	" set port	7232 since 7231 is already used by restbase		bug: t116245	change-id: i485d338e77b76486654fdd4c2d211f84e03c3bc1	|restbase: add lvs codfw configuration		bug: t108613	change-id: ia4b4b1e16f35eb2bf473e89a47d28b1f3354f7bf	|add cache_maps and related lvs config"	" using cp104[34]		bug: t105076	change-id: if05c07a32e89c8c5ec73716281cf4526943f5b7e	|decom bits cluster varnish/lvs configuration		bug: t95448	change-id: idcd578dfa3381dfdafe715fb3c56b3759de5bc0a	|"																																																																																																																																																																																																																																																																																																																																																										
"maps - initial import script		fix wrong script name		bug: t138501	change-id: i3d94b111e6bd4bba6d34aebda0f7ce938aecb834	|actually create initial import script for osm data		bug: t138501	change-id: ib9e228b99c982571c903b11206dbd9aff4e811e8	|script to do the initial data load from osm for maps project		this script is a naive implementation of the steps taken to get map's	postgres database in working shape.		bug: t138501	change-id: ibb7ce464636c380b5b7f1bed5ffe4a1fe1e1f177	|maps - enable tileratorui notification of new expier files		after running update of osm data"	" notify tileratorui of the new expire files.		tileratorui always returns an empty response (which is invalid). ignore this	issue until this is fixed.		bug: t139451	change-id: i94e03f8dc2224ceacf2cac2b22d5f41da8b793ba	|change expired file zoom level from 16 to 15.		keeping on zoome level 15 still gives us the ability to oversample on level 16	but saves quite a lot of space.		bug: t136483	change-id: if3b286f2540307a8b043cc13de7f710f3024f9cc	|increase the number of workers for osm2pgsql.		on new maps server"	" we have cpu underutilization during import. this change	raises the number of threads for new maps servers but keep the current	configuration for the old maps-test servers.		bug: t136578	change-id: ib9aee02b8a0e0a876bc713eccb1e64b185a82237	|"																																																																																																																																																																																																																																																																																																																																																																	
"include a cassandra::instance::monitoring class		in order to follow the single responsability	principle"	" it could be great to externalize the	monitoring setup from the general cassandra	setup. this is the next step to include the	monitoring setup in all the calls to ::cassandra		bug: t137422		change-id: i9177f9797bfb5a13696fa3ad2b9af5264def5513	|maps: add cassandra helper classes		maps cassandra cluster never got the metrics and logging cassandra	subclasses. the reasoning back then was kiss"	" and there was never up to	now a need to actually add them. adding them in this patch		bug: t130654	change-id: i4c8f0e7cf249973b67bac977adf8a2bcce352c0e	|"																																																																																																																																																																																																																																																																																																																																																																	
"enable reuse of sockets in time_wait state on all app servers		we have this set up on the api servers"	" but it is useful for other app server	roles"	" and safe to do.		bug: t130364	change-id: i93929a36117473e51275c96730d4157c8c98986e	|"																																																																																																																																																																																																																																																																																																																																																																	
"enable reuse of sockets in time_wait state on all app servers		we have this set up on the api servers"	" but it is useful for other app server	roles"	" and safe to do.		bug: t130364	change-id: i93929a36117473e51275c96730d4157c8c98986e	|"																																																																																																																																																																																																																																																																																																																																																																	
"mediawiki: remove python-mysqldb from maintenance servers		this package was here from t84075 for sul audit work by legoktm	on terbium. from there it moved into the maintenance role	to be also installed on terbium's equivalent in codfw.		legoktm confirmed this is not needed anymore.		does not affect appservers"	" only role mediawiki::maintenance.		bug:t84075	bug:t129930	change-id: i53f42dfac2284a2d87cb3a361fe7bc9971f57672	|mw:maintenance: move eventlogging from node to role		instead of directly including this in site.pp on the	node-level"	 move it to the mw maintenance role class	"	so that it gets installed on all mw maint servers"	"	also the new terbium-equivalent in codfw.		bug:t112660	bug:t129930	change-id: i373153770e0a61a34c155065fbd9cb4a6c496401	|mw:maintenance: move python-mysqldb from nodes to role		instead of installing packages directly on the node level (meh)"	"	and repeating it for the equivalent in codfw"	" move this package	install into the role class for mw maintenance hosts.		also reopened t84075 to check if we still need this at all since	it was called a temporary solution. not a problem to keep though	if we use it.		bug:t84075	bug:129930	change-id: i3529298c4427d8ba72dc36688e17237b2182c00f	|mediawiki::maintenance: add codfw host"	" multidc support		as we need to run jobs within codfw after switching over mediawiki"	" we	need an host there. pick one large-sized appserver (mw2090) for the	duty; also make the cronjob presence depend on the local datacenter	being the primary.		bug: t126987	change-id: i004a15094b494bbe451dd0f17358645e04d1265f	|install php5-readline on mediawiki maintenance hosts		bug: t126262	change-id: i095563c4b9e999ab7bbb8f194d96bd9e83058d0f	|"																																																																																																																																																																																																																																																																																																																																																											
"mediawiki: include fonts in role::mediawiki::webserver		currently ::mediawiki::packages::fonts does not get included	on all appservers"	" but it probably should for bugs like t84777.		""timelines aren't rendered on image scalers. they're rendered on standard	mediawiki app servers ""		""they need fonts-wqy-zenhei installing so they	can do chinese timelines nicely ""		and so i would expect this to be the case for potentially all fonts and we	could just install them all on all appservers"	" no?		now adding to 'role::mediawiki::webserver' as requested.		bug:t84777	change-id: i83e5329a45c42b93abafa1e4466852c83d00b768	|"																																																																																																																																																																																																																																																																																																																																																																	
"add puppet code for endowment.wm.org site		add minimal puppet module and role to setup	endowment.wikimedia.org like we do for annual.wm.org.		bug:t136735	change-id: iebea9ee1c5d2d3b9b6657b5087dd447465163fe1	|"																																																																																																																																																																																																																																																																																																																																																																			
"provision a ""staging"" microsite for the transparency report		provision a private microsite of the transparency report"	" served under /private	from files in the private transparency report gerrit repository.		bug: t138197	change-id: if35ba69c2c295c29b24b81f023e8954ae29e4e89	|"																																																																																																																																																																																																																																																																																																																																																																		
"notebook: add base::firewall to stub role		adds standard firewall rules on experimental notebook servers.	madhuvishy will be root on this and is aware"	" said we'll	just need to open a single proxy port later.		bug:t134716	change-id: ie51d50d42cc09dd248688848bfd5c0a8af13cfa7	|notebook: introduce stub role		to make access control easier to provide		bug: t134716	change-id: i369f27db3ab3888c75515aa17fbbe98b1b206be7	|"																																																																																																																																																																																																																																																																																																																																																																		
"remove plutonium from infrastructure		going for reclaiming to spares"	" removed from:	* site.pp	* netboot	* dhcp	* ferm rules		bug: t118586	change-id: icf8b4fbc835787db59507ce5c2c96242779f3355	|"																																																																																																																																																																																																																																																																																																																																																																		
"labs: restart slapd if it uses > 50% of memory		add a cron that restarts slapd <s>once a week</s> to mitigate the slapd memory	leak issue"	" as suggested by moritz.		amended to restart it if it really uses more than 50% of the memory"	" check in an	hourly cron. as suggested by _joe_ in comments.		copied from mediawiki::jobrunner where we do the same for hhvm.		bug: t130593	change-id: idf33099b07d3d231a0c229628db5c9d6c67dd8b0	|"																																																																																																																																																																																																																																																																																																																																																																	
"add the role::ores::redis class		used to populate a replicated redis database pair		bug: t124200	change-id: ia9d710864e130a6f3b3cf2484897d4a0d5713dc1	|"																																																																																																																																																																																																																																																																																																																																																																			
"add role::ores::web and roles::ores::worker		bug: t124201	change-id: i0cf8bdf1ece654118ac5fe1b0543e2bd4c826af6	|"																																																																																																																																																																																																																																																																																																																																																																			
"add role::ores::web and roles::ores::worker		bug: t124201	change-id: i0cf8bdf1ece654118ac5fe1b0543e2bd4c826af6	|"																																																																																																																																																																																																																																																																																																																																																																			
"manage postgresql data dir with puppet		default data directory (/var/lib/postgresql/...) is created during	installation of debian package. in case we want to use another data directory"	"	like it is the case for maps servers"	" this directory is not created and need	to be managed by puppet.		minor refactoring of existing tests was done to ensure all tests are green.		bug: t138092	change-id: iec59cf0290a5ea34cdab26d3604b32a9edde4967	|"																																																																																																																																																																																																																																																																																																																																																																	
"manage postgresql data dir with puppet		default data directory (/var/lib/postgresql/...) is created during	installation of debian package. in case we want to use another data directory"	"	like it is the case for maps servers"	" this directory is not created and need	to be managed by puppet.		minor refactoring of existing tests was done to ensure all tests are green.		bug: t138092	change-id: iec59cf0290a5ea34cdab26d3604b32a9edde4967	|"																																																																																																																																																																																																																																																																																																																																																																	
"manage postgresql data dir with puppet		default data directory (/var/lib/postgresql/...) is created during	installation of debian package. in case we want to use another data directory"	"	like it is the case for maps servers"	" this directory is not created and need	to be managed by puppet.		minor refactoring of existing tests was done to ensure all tests are green.		bug: t138092	change-id: iec59cf0290a5ea34cdab26d3604b32a9edde4967	|"																																																																																																																																																																																																																																																																																																																																																																	
"otrs: add check_procs for clamd/freshclam		the role class is a misnomer (this sets up everything"	" not just the	webserver) and the lines between the clamav module"	" the otrs module and	the role class are very blurry. add the checks to the role class for	now.		bug: t137188	change-id: i9907565d36fc8356f7596703273e78bb8fe4e417	|"																																																																																																																																																																																																																																																																																																																																																																	
"parsoid::testing: move to use the parsoid class		the parsoid class is using service::node and the service-runner based	version of parsoid.		this is part of i3f4a5 that is being splitted in multiple commits		bug: t90668	change-id: i863cf7cd7cb2a0d67e27647e032a8a357f91df28	|parsoid::testing: use master_dc variables		bug: t124670	change-id: ia97446f7a4278e95db2e9daff71e527b90825967	|"																																																																																																																																																																																																																																																																																																																																																																			
"service::node: add git as deployment method		this is also used in role::parsoid::testing where we don't want	deployments via scap/trebuchet.		bug: t90668	change-id: idc1d352b6f5d4aabb499b8208114e78de35f9ab1	|parsoid::testing: move to use the parsoid class		the parsoid class is using service::node and the service-runner based	version of parsoid.		this is part of i3f4a5 that is being splitted in multiple commits		bug: t90668	change-id: i863cf7cd7cb2a0d67e27647e032a8a357f91df28	|parsoid::testing: use master_dc variables		bug: t124670	change-id: ia97446f7a4278e95db2e9daff71e527b90825967	|"																																																																																																																																																																																																																																																																																																																																																																			
cygnus/technetium: install nmap	" include standard		cygnus and technetium are vms for pentesting frack.	sets up a stub class to install the requested nmap.	includes standard on these instances.		bug:t126012	bug:t118763	change-id: iaff5d643680ecc04ecb0fed03d0ca3e81fa9283e	|"																																																																																																																																																																																																																																																																																																																																																																		
"more phabricator config changes refs t128797		bug: t128797	change-id: iad9028d0a19d863cf863b08146ade4b8b274ffa5	|move phabricator/extensions to libext fixes t128797		this puppetizes a hotfix i applied on iridium to fix t128751		bug: t128797	change-id: ic3901af340324c5024c43b7d2b26a0ce1ab34e80	|"																																																																																																																																																																																																																																																																																																																																																																			
"phab: remove config abstraction. useless & confusing		bug: t144112	change-id: id20e273b1fb3422add6e60ebb82a42b20da408db	|phabricator: allow ssh between servers for cluster support		allow ssh from one phabricator server to another in the	other dc for cluster support. as mentioned by 20after4 on t137928#2559879.		adds the phabricator hosts to hiera via role"	" resolves the dns names	to create firewall rules.		needs the cname for iridium added in i250e8b1b0a13aa.		bug:t137928	change-id: i65fa4f67e2ef39f7c1fb12d1497e5c74d1798dcc	|phabricator: re-enable project-changes email		bug:t139950	change-id: i592830e0fe921fcab5bc070331af10eeeb9590bb	|phabricator: re-enable community metrics mail		re-enable the community metrics mail / weekly report	that gets sent to wikitech-l.		bug:t139950	change-id: iaca225db78d848c9db521133bdedee5c68474c8d	|phab: properly disable crons for maintenance		follows up iab5e0fb5. commenting a cron doesn't remove it from the	system. these should not be running at the moment but they still are		bug: t138460	change-id: ide926d45b246a2f2c44d0db69ec3f0b928d4c41c	|disable crons using the phabricator db slave due to maintenance		bug: t138460	change-id: iab5e0fb5823532b158c649a4bfb78bb4755a61ac	|rewrite rules for git.wikimedia.org		redirect gitblit urls to phabricator (diffusion) equivalents.		bug: t137224	change-id: i73873258a5f3acc21d0db4689dee2f18ca38aff6	|rewrite rules for git.wikimedia.org		redirect gitblit urls to phabricator (diffusion) equivalents.		bug: t137224	change-id: i67ad308f9e6373e5234cb2d83006457d6f467bf8	|phabricator: send maintenance mail to list not individuals		instead of hardcoding individual email addresses here in the	role"	 with the disadvantages of needing a puppet change	" exposing	people's addresses"	 needing ops attention	" send this report	to a new mailing list instead (created in t136660).		bug:t136660	bug:t133649	change-id: ie1f043be07342de7b7945dd16ed9298ea92262dd	|more phabricator config changes refs t128797		bug: t128797	change-id: iad9028d0a19d863cf863b08146ade4b8b274ffa5	|librarize phab extensions repo		bug: t128797		change-id: i96b0b74750af1ff011bd052a321b10c4cc87d98b	|phab: add sender domains for maint-announce tickets		whitelist sender domains that can direct-comment on tickets	in the maint-announce project.		bug:t118176	change-id: ia0ab96f4c388fecbcdbb49fd3beb2e172ea4a487	|move phabricator/extensions to libext fixes t128797		this puppetizes a hotfix i applied on iridium to fix t128751		bug: t128797	change-id: ic3901af340324c5024c43b7d2b26a0ce1ab34e80	|"																																																																																																																																																																																																																																																																																																																																																														
"planet: only run updates when in active datacenter		add a parameter to set the active datacenter"	" then	only actively run feed updates in the active dc.	we don't want to run them in both places for no reason.		bug:t134507	change-id: ib9f1cc485e08f22e3d1c2d5bb2bf1a963e3c3f76	|"																																																																																																																																																																																																																																																																																																																																																																		
"manage postgresql data dir with puppet		default data directory (/var/lib/postgresql/...) is created during	installation of debian package. in case we want to use another data directory"	"	like it is the case for maps servers"	" this directory is not created and need	to be managed by puppet.		minor refactoring of existing tests was done to ensure all tests are green.		bug: t138092	change-id: iec59cf0290a5ea34cdab26d3604b32a9edde4967	|"																																																																																																																																																																																																																																																																																																																																																																	
"manage postgresql data dir with puppet		default data directory (/var/lib/postgresql/...) is created during	installation of debian package. in case we want to use another data directory"	"	like it is the case for maps servers"	" this directory is not created and need	to be managed by puppet.		minor refactoring of existing tests was done to ensure all tests are green.		bug: t138092	change-id: iec59cf0290a5ea34cdab26d3604b32a9edde4967	|"																																																																																																																																																																																																																																																																																																																																																																	
"manage postgresql data dir with puppet		default data directory (/var/lib/postgresql/...) is created during	installation of debian package. in case we want to use another data directory"	"	like it is the case for maps servers"	" this directory is not created and need	to be managed by puppet.		minor refactoring of existing tests was done to ensure all tests are green.		bug: t138092	change-id: iec59cf0290a5ea34cdab26d3604b32a9edde4967	|"																																																																																																																																																																																																																																																																																																																																																																	
"prometheus: add nginx reverse proxy		introduce prometheus::web to put nginx in front of multiple prometheus	instances. each instance can be accessed internally at http://localhost:<port>	or externally at http://<address>/<instance_title>.		bug: t126785	change-id: i1025d613d5252b16b4ba1facc063c9897b5e9e86	|prometheus: add server support		a prometheus::server define is provided that will install and setup a	prometheus server instance.		additionally"	" an example of labs deployment is provided with	role::prometheus::labs_project"	" currently running at	https://prometheus-staging.wmflabs.org/labs. the provided script will	autodiscover and scrape/poll metrics from all labs instances running	prometheus's node_exporter in the same project. (see also i6832dcf31)		bug: t126785	change-id: ia2a8f204ea0e3ac865a6ab8bd7b4af6c7915bcef	|"																																																																																																																																																																																																																																																																																																																																																																	
"quote args parameters for trusty compatibility		1) this works on jessie too	2) i prefer to always overwrite the content of the file"	" as	   setting defaults will maintain the old content	3) we could do it on the role if this could have side effects"	" but	   i prefer it like this.		bug: t126757	change-id: iae58e4130dcd27746aae6c112226c56b588bb23f	|configuration changes regarding mysql exporter for prometheus		* add processlist monitoring	* disable table monitoring		bug: t126757	change-id: i0d1feabd2f515ada346c99a7effb9ae94e05e995	|prometheus: add mysqld exporter		bug: t126757	change-id: ic9cccca83b41bfbd222f867155f2290db75a707f	|"																																																																																																																																																																																																																																																																																																																																																																	
"prometheus: add node_exporter support		the prometheus-node-exporter package provides node (machine"	" not the javascript	framework) level metrics.		bug: t92813	change-id: i6832dcf31b16d5d9dd876dcdd538269e4107a090	|"																																																																																																																																																																																																																																																																																																																																																																		
"fix puppet issues generating empty files for mysql configuration		bug: t126757	change-id: i5ff554ef41472a8a964e2ecae20ef852ba05b910	|puppetize static configuration for prometheus-mysqld-exporter		this is only a temporary measure until puppetdb is ready and	we can generate those dynamically.		there is no labs hosts on codfw.		bug: t126757	change-id: ic68ed2fa8bd007bd9d8d609740744f31aeefaf5d	|prometheus: add mysql job configuration		the idea being that since each mysql 'group' has a related function"	" each gets	its own job. aggregation can still be performed across jobs by e.g. selecting	all jobs prefixed with 'mysql-'.		bug: t126757	change-id: id59d8b19eb986210514fa7ded4f716d202da8d46	|prometheus: monitor hosts in the current site		generate a list of hosts with their respective ganglia cluster for the current	site.		bug: t126785	change-id: i1963f9c3dd36323ddd8a2e0ec21ed7ce4eb8cad4	|prometheus: add nginx reverse proxy		introduce prometheus::web to put nginx in front of multiple prometheus	instances. each instance can be accessed internally at http://localhost:<port>	or externally at http://<address>/<instance_title>.		bug: t126785	change-id: i1025d613d5252b16b4ba1facc063c9897b5e9e86	|"																																																																																																																																																																																																																																																																																																																																																																		
"puppetmaster: add ca and ca_server settings to frontend		also"	" get the address of the ca_server from hiera if available.	this allows to have secundary frontends.		bug: t143869	change-id: i0c8a5efd48f547693c4da86ddfcda30213d0c670	|"																																																																																																																																																																																																																																																																																																																																																																		
"puppetmasters: support multiple git masters		given we will have multiple frontends"	" we want all of them to act as git	masters so that we don't have a spof in case one fails.		this means:	- for the public repo"	" use a list of all servers from hiera to know	where to sync to	- for the private repo"	" both use that same list to push everywhere and	add a post-receive hook for the masters"	" so that the non-bare repo will	be reset to the new head.		bug: t143869	change-id: i4a1d900af511baa8b55d833e474c553a071cb76e	|puppetmaster::frontend: get workers from hiera		also fill in the values for eqiad and codfw		bug: t143869	change-id: id11e82f7deee9dcabd4c2ea6e74960032f1b9ceb	|puppetmaster::frontend: add vhost for fqdn		this will be used by clients using srv records; also only install the	old 'puppet' virtualhost on the primary frontend (the one that will be	managing the ca too).		bug: t143869	change-id: i8bc3e46c83171f461a5b8c059be1b70fbd52134b	|puppetmaster::frontend: move vhost to role		also"	" use puppetmaster::web_frontend to define the main vhost.		bug: t143869	change-id: i77b40c30a0977a1da5edaac88735f96d7bf10b64	|puppetmaster: add ca and ca_server settings to frontend		also"	" get the address of the ca_server from hiera if available.	this allows to have secundary frontends.		bug: t143869	change-id: i0c8a5efd48f547693c4da86ddfcda30213d0c670	|puppetmaster: correct puppetization of the private repo		the puppetization of the private repository was almost not existent"	"	and mostly broken.		do what follows:	- distinguish the private master from the other servers	- automatically init a repository in /srv/puppet"	" where the git data are	supposed to reside	- add a post-receive hook that syncs data to	/var/lib/git/operations/private	- rationalize installation of the git hooks	- set up /var/lib/git/operations/private to use /srv/puppet as a git	remote		the only detail that is still missing here is the post-commit hook on	the private master"	 which will be fixed in a new	" later commit.		bug: t98173	change-id: i95b9e56c3c79e20dfca564634799a1e48b5d5a52	|puppetmaster: add rhodium as an inactive backend		bug: t98173	change-id: ib3bfc46150c6e378a000c34ff61f8dfd17e41d99	|"																																																																																																																																																																																																																																																																																																																																																									
"puppetmaster: add role for puppetdb		bug: t142363	change-id: i5358e28edfa3cb448540f9b42e210829c0b35947	|"																																																																																																																																																																																																																																																																																																																																																																			
"kill references to $::instancename		bug: t101447	change-id: i954ac93e29f80e22bebe73a5804b073388888dd2	|"																																																																																																																																																																																																																																																																																																																																																																			
"rt.wm.o: remove old cert definition		bug: t132812	bug: t133717	change-id: i5aec77e996dd45113f171351c3c858ec94dc35a8	|rt.wm.o: use le cert		bug: t132812	bug: t133717	change-id: i15cf9104796698d05d8601a5801279169962abbe	|"																																																																																																																																																																																																																																																																																																																																																																			
"temp. setup to use db2007 for rt upgrade test		this is a temp. setup to use db2007 with a copy	of the rt database to test changes during a version	upgrade. the server is in the process of being decom'ed	and this will be removed again.		bug:t119112	bug:t125827	change-id: iebdbebd7aacb07051785afcb795a652c505e19ba	|"																																																																																																																																																																																																																																																																																																																																																																			
"puppetize salt master pub/priv keys for labs and prod masters		bug: t118385	change-id: iff0c7ce035f6364bf597e6ff9ede490964f70681	|"																																																																																																																																																																																																																																																																																																																																																																			
"puppetize salt master pub/priv keys for labs and prod masters		bug: t118385	change-id: iff0c7ce035f6364bf597e6ff9ede490964f70681	|"																																																																																																																																																																																																																																																																																																																																																																			
"introduce zosma.codfw.wmnet		add new ganeti vm for security tools to	site.pp"	" add a stub role to ensure we have a firewall	and hieradata for debdeploy so we are getting security	upgrades. finally add to installserver to set a partman recipe	for ganeti vms.		bug:t138650	change-id: i533148e843365bd5411f2d0383706bd94eddf03b	|"																																																																																																																																																																																																																																																																																																																																																																		
"enable generation of media lists per project on snapshot1007		bug: t133694	change-id: i3b38fd93b8fc648e8f3d34c6d3374ee155a0e87f	|"																																																																																																																																																																																																																																																																																																																																																																			
"keyholder key cleanup		* clean up the mess that is scap::target and keyholder::agent	* make ssh_agent_proxy look up keys by name instead of fingerprint	** this avoids needing to store fingerprints in puppet manifests	* password-protected key test is now optional and skipped on beta		bug: t132747		change-id: id298a3e0f12e31afd7ea83970e192330ffbd4243	|"																																																																																																																																																																																																																																																																																																																																																																			
"striker: replace nginx with apache		replace the nginx reverse proxy with an equivalent apache vhost.		note: on any host where the prior striker::nginx class was applied"	"	nginx will need to be cleaned up manually:		  $ sudo service nginx stop	  $ sudo apt-get purge nginx-light nginx-common	  $ sudo rm -rf /etc/nginx /var/log/nginx		bug: t136256	change-id: i358722da216a230586d182c6ad707704d0b61b2e	|provision striker via scap3		provision the striker django web application using scap3:	* uwsgi service running striker	* memcached server for session cache storage	* nginx vhost for static content and reverse proxy to uwsgi	* django and uwsgi logs forwarded to logstash1003 as json datagrams	* local apache combined log style access log		configuration of the striker django app is done via hiera settings. the	role settings file at hieradata/role/common/striker/web.yaml contains	dummy values for the striker::uwsgi::secret_config hiera hash. the	actual values for these production secrets should be configured via	non-public hiera settings files.		bug: t141014	change-id: i855f9484f799a6847590b5d1196abf903114fa34	|"																																																																																																																																																																																																																																																																																																																																																																		
"lvs: add thumbor to lvs		there will be nginx listening on port 8800 and revproxing to multiple thumbor	instances.		bug: t139606	change-id: ia6c7248b82b385b0425f18d4f3494f77a2a8eac0	|puppetization for thumbor		bug: t139606	change-id: i0b8794836eed2cb2b707f442f66c09ead6886252	|"																																																																																																																																																																																																																																																																																																																																																																			
"tools: centrally collect all logs from k8s related nodes		bug: t141270	change-id: i0edd793afadba367aa54dacb66bcfaec126d3457	|docker: add a class that facilitates building base images		bug: t118446	change-id: ice8f3220268934d018b5297396f1c4b2327bb38a	|"																																																																																																																																																																																																																																																																																																																																																																			
"tools: centrally collect all logs from k8s related nodes		bug: t141270	change-id: i0edd793afadba367aa54dacb66bcfaec126d3457	|"																																																																																																																																																																																																																																																																																																																																																																			
"toollabs elastic don't use nginx light		nginx is already included in elastic tree as	full and we don't use light varient seemingly	/anywhere/ atm and it seems much simpler to	conform than to get the very small benefit	of nginx-light.		bug: t131644	change-id: icd4279935072c661ca823db51d9281506b134603	|"																																																																																																																																																																																																																																																																																																																																																																			
"tools: centrally collect all logs from k8s related nodes		bug: t141270	change-id: i0edd793afadba367aa54dacb66bcfaec126d3457	|tools: add checks for k8s and flannel etcds		also open up holes from tools-checker host to the etcds		bug: t140247	bug: t140246	change-id: i3fc7bd1d14f2d52282f5110b151775e2672ea69f	|tools: allow bastions to talk to flannel etcd		bug: t136413	change-id: ic9954742f46aab94effbb686365197601888d824	|"																																																																																																																																																																																																																																																																																																																																																																			
"tools: allow multiple k8s master to access etcd		bug: t142862	change-id: idd4c944ad4242853f2b0fcfc5810121d7b5a8a9a	|tools: centrally collect all logs from k8s related nodes		bug: t141270	change-id: i0edd793afadba367aa54dacb66bcfaec126d3457	|tools: add checks for k8s and flannel etcds		also open up holes from tools-checker host to the etcds		bug: t140247	bug: t140246	change-id: i3fc7bd1d14f2d52282f5110b151775e2672ea69f	|"																																																																																																																																																																																																																																																																																																																																																																			
"tools: centrally collect all logs from k8s related nodes		bug: t141270	change-id: i0edd793afadba367aa54dacb66bcfaec126d3457	|tools: fixup k8s bastion role		- adds a simple script to deploy appropriate binaries	- adds flannel + kube-proxy for access to pod/svc ips	- installs kubectl for use by everyone		bug: t136413	change-id: i3b106fe670a1e4f6a0a23a978b50ed211e85f31b	|"																																																																																																																																																																																																																																																																																																																																																																			
"tools: centrally collect all logs from k8s related nodes		bug: t141270	change-id: i0edd793afadba367aa54dacb66bcfaec126d3457	|tools: add a kubernetes diamond collector		bug: t140887	change-id: i4822045fb8c4a127fec4106658f6cec3180048fd	|tools: use provisioned cert instead of puppet cert		bug: t139461	change-id: i52f9b35dbf6b5a6d503c619ada3d1157ed13ca61	|tools: provision star.tools.wmflabs.org cert for k8s master		bug: t139461	change-id: i4527f18eaf01fdbaed0d8e172e2fd43299d60f56	|tools: provision accounts for all tools		maintain-kubeusers does the following:		1. generate accounts for all tools	2. generate abac file granting appropriate access	   to all tools	3. read up infrastructure user config from a different	   file and make sure they are present in final token auth	   file list	4. restart kube-apiserver if needed		this needs to run as root since we're writing to many differnt	users' homedirs"	" so we attempt to limit the damage by whitelisting	capabilities and making most filesystem paths be readonly		bug: t133999	change-id: i7a7a3dd951db2209e820752c4d14d77eb836b929	|tools: enable hostpathenforcer admission controller		bug: t112718	change-id: ieb33db64277748be6dee875ace4d77527d08dfd3	|tools: enable host automounts		bug: t134748	change-id: ie5537263629d421a889c24fc37c3c8b182603c69	|tools: enable the registry enforcer		bug: t133515	change-id: i8127e5e6e25b69e78d109c7e5ebb3183eb7ba4ae	|k8s: add simple script for deploying master		bug: t130972	change-id: i77f68f4e086cd034283f9b8722e264421b4ab4c5	|"																																																																																																																																																																																																																																																																																																																																																																		
"tools: centrally collect all logs from k8s related nodes		bug: t141270	change-id: i0edd793afadba367aa54dacb66bcfaec126d3457	|k8s: simple script to deploy worker & proxy		bug: t130972	change-id: ibc6504ada4115146eaab377e9030f2dca755b42f	|"																																																																																																																																																																																																																																																																																																																																																																			
"k8s: use direct-lvm for docker storage backend		bug: t141126	change-id: i44f0d8486ddca81cf3becc5f66fcc52b8279d163	|tools: centrally collect all logs from k8s related nodes		bug: t141270	change-id: i0edd793afadba367aa54dacb66bcfaec126d3457	|k8s: decouple kubelet from kube-proxy		only kubelet requires the private certificates"	" but we can't	just put that in there since kube-proxy requires the public	certificates. we'll eventually fix this by getting rid of	the k8s::ssl class"	" but until then....		bug: t136413	change-id: id24eb002d876c0a857c223add8832bc48aa5e6a5	|k8s: simple script to deploy worker & proxy		bug: t130972	change-id: ibc6504ada4115146eaab377e9030f2dca755b42f	|k8s: mount separate lvm volume for /var/lib/docker		bug: t129729	change-id: i1cf0d7d4e0065baa393cc19375be267254f202c9	|"																																																																																																																																																																																																																																																																																																																																																																	
"tools: reduce number of days central logs are kept to 3		we can increase this later once we know a single vm can	handle it.		also rename role to be more descriptive.		bug: t141270	change-id: i7f6485d1491f74735389f475e7c0ebfc2142c0e1	|"																																																																																																																																																																																																																																																																																																																																																																			
"tools: add role::toollabs::merlbot_proxy		role to provision an nginx server acting as an http -> https reverse	proxy. this is a temporary solution for issues with merlbot and the	impending closure of the http post loophole.		bug: t137235	change-id: id49c79d524654b409cc991634effb473b38fb78b	|"																																																																																																																																																																																																																																																																																																																																																																			
"refactor zookeeper cluster config so it is available in all hiera scopes		zookeeper cluster config is now specified globally in common.yaml"	"	so any puppet manifest can lookup zookeeper host names"	" even if	if that cluster config is in a different datacenter.		this is needed in order to use kafka mirrormaker"	" as it needs	to look up the source kafka cluster's zookeeper config"	" in order	to mirror from it.		this should be a noop everywhere"	" but needs to be deployed very	carefully.		bug: t143232	change-id: i3ff2c33b473901380433080af255999b7e99fbca	|remove unused ganglia kafka views		bug: t121659	change-id: i063cdfe16a32963c9d9cfd33f00e923b074e52dc	|"																																																																																																																																																																																																																																																																																																																																																														
"don't page if druid-eqiad zookeeper cluster has a server down		bug: t138263	change-id: ia753dc262a5e1b9421ccee28a7bf036c2780b43a	|refactor zookeeper cluster config so it is available in all hiera scopes		zookeeper cluster config is now specified globally in common.yaml"	"	so any puppet manifest can lookup zookeeper host names"	" even if	if that cluster config is in a different datacenter.		this is needed in order to use kafka mirrormaker"	" as it needs	to look up the source kafka cluster's zookeeper config"	" in order	to mirror from it.		this should be a noop everywhere"	" but needs to be deployed very	carefully.		bug: t143232	change-id: i3ff2c33b473901380433080af255999b7e99fbca	|include icinga alerts for zookeeper		alert on process running and if num client connections gets too high.		bug: t137302	change-id: i6f5c5cc00bb51f814e5a496d9c9e14cea63c1eb6	|update zookeeper submodule and configure sending zookeeper jmx stats to statsd		this adds a new hiera variable called 'zookeeper_cluster_name' used to uniquely	id a zookeeper cluster in statsd/graphite.		this patch stops sending zookeeper metrics to ganglia.		bug: t137302	change-id: i1b70b361e7235594c33e39be7858edf7204e59ee	|"																																																																																																																																																																																																																																																																																																																																																														
"remove the ferm rules from modules/rsync/manifests/server.pp		they represent the least common denominator of all ferm rules	for rsyncd instances. instead"	" rsync rules should rather be present	in the respective roles where the accessing ips can be configured	more fine-grained depending on the needs of the role.		the ferm rule generated from the rsync module is	/etc/ferm/conf.d/10_rsync-server. i've made a salt run to search	for that file and double-checked it against existing rsync rules:		these roles have a custom rsync ferm rule already:	role package::builder (copper)	role::osm::master (labsdb1006)	role::archiva (titanium)	role::abacist (stat1001)	role statistic::cruncher (stat1003)	role::swift::storage (ms-be* hosts)		role deployment::server isn't currently ferm-enabled"	" although ferm has been	enabled anyway on the currently unused mira host in codfw.		role::logging:mediawiki (on fluorine) uses misc::udp2log::rsync (also used	on terbium) to configure ferm rules for rsyncd. to move these into the	relevant role classes is an independant followup patch (since the current	patch allows us to limit the access to rsyncd).		bug: t108987	change-id: i845b7f71c00118b5ecc199edd7373b2ab0c65ac8	|"																																																																																																																																																																																																																																																																																																																																																																	
"rsync:  unquote booleans		bug: t113783	change-id: i80362002e2f665daac829bfef959714f09c5c3e8	|"																																																																																																																																																																																																																																																																																																																																																																			
"rsyslog: temporarily lower centralserver retention		we're in the process of acquiring syslog hw in codfw and bigger disks for	lithium in eqiad. in the meantime halve the retention period.		bug: t139612	change-id: i450f34f9474a1249a8a6a599334de5e68924b9b5	|rsyslog: add rsyslog::receiver to deprecate syslog-ng		as noted in t107611 we're using syslog-ng only to aggregate logs centrally"	"	there's no reason why rsyslog isn't suitable"	" so deprecate the former.		while doing so also change filenames to end in .log"	" this makes logrotate	easier to use by not being forced to match *		also note that group membership changes from wikidev to syslog because	trusty's rsyslog doesn't support the filegroupnum option in omfile"	"	http://www.rsyslog.com/doc/v8-stable/configuration/modules/omfile.html	i don't think this is a problem in practice"	" worst case we need to upgrade	lithium to jessie.		bug: t107611	change-id: i169b8d5637c86c4dc9543b36197f9ded1c84fa25	|"																																																																																																																																																																																																																																																																																																																																																														
"mariadb: set additional salt grains for core dbs		change-id: idd88b7a4e892841be1616cbecd8c66a619ce206f	bug: t133337	|"																																																																																																																																																																																																																																																																																																																																																																			
"salt: reducing permissions on the master's job cache		bug: t143536	change-id: i06eb3b4cab886fa1f5423c707bcc66f99615b5fc	|new salt runner to accept/delete/check status of salt key		tested accept/status/delete"	" return values properly when called	via salt-call publish.runner keys.{function} <minion>		this is intended for use by remote scripts such as wmf-reimage	still needed: auth in salt config to permit remote hosts to run this command		bug: t124761	change-id: id6911f7606fe785c7fcd1f27b7505181574b16ba	|switch on salt auto_accept for labs.		rename puppetsigner.py certcleaner.py and remove	signing function.		bug: t102504	change-id: i2d2e7911d0d3f8cedf7f03b59e86f3855b65e68c	|add hiera yaml for staging"	" refactor salt class		adds a bunch of hiera variables for staging"	" and refactors the salt master	roles to allow for easier hiera abstraction.		bug: t88304	change-id: i4265ed0b2c26e3ae29f10df7482386bfd7f5e559	|"																																																																																																																																																																																																																																																																																																																																																																
"puppetize salt master pub/priv keys for labs and prod masters		bug: t118385	change-id: iff0c7ce035f6364bf597e6ff9ede490964f70681	|"																																																																																																																																																																																																																																																																																																																																																																			
"scap: use conftool data to populate dsh groups		populate the dsh groups from puppet based on their status in conftool:		any server in conftool data that is also not marked as 'inactive' will	be included in the dsh list.		bug: t132529	change-id: ibad2c11c85dd3be10aae6e4fcde52d61da80ca13	|scap: use conftool data to populate dsh groups		populate the dsh groups from puppet based on their status in conftool:		any server in conftool data that is also not marked as 'inactive' will	be included in the dsh list.		bug: t132529	change-id: if164c59b6d83da836a1699c864713efeb8d6047f	|scap: add co-master configuration		configuration for scap to facilitate master-master replication.		needed by: i3d2b4e7495d75540c914b2eb999124ad1ee6f8b0	bug: t104826	change-id: i5c0a1fd283cc545ab073a514e933a87d5fe23996	|"																																																																																																																																																																																																																																																																																																																																																																			
"scap: use conftool data to populate dsh groups		populate the dsh groups from puppet based on their status in conftool:		any server in conftool data that is also not marked as 'inactive' will	be included in the dsh list.		bug: t132529	change-id: ibad2c11c85dd3be10aae6e4fcde52d61da80ca13	|"																																																																																																																																																																																																																																																																																																																																																																			
"clean old scap code		removes old binstubs and the old /srv/deployment/scap directory.		bug: t128386	bug: t135206	change-id: id33fbb510b1c9b6561a770810e9a611cea2129c6	|scap: bump version to 3.1.0-1		bug: t130902	change-id: i39791885c0bc4d17da360f4b38dd4e89b799f22e	|fix scap/init.pp source -> content		followup to https://gerrit.wikimedia.org/r/#/c/272947/10		bug: t126259		change-id: ide69250606264a0076f7e7997b3e269d8109c02c	|parameterize the git_server variable in global scap.cfg		it needs to be possible to override this in hiera data on beta	and the phabricator labs project.		bug: t126259	change-id: id1c08a68ec1e7cadcb10c18fbb08c15ac6381a45	|install the scap package from deb instead of trebuchet		this switches scap to use the apt provider and fixes paths to point to	`/usr/bin/$binary` instead of `/srv/deployment/scap/scap/bin/$binary`		bug: t114363		change-id: iaa518889fa2c8b3d81db9e466cb63d0fcbc30cc4	|scap: put configuration for scap in /etc/scap3.cfg		this is all copied as-is from scap right now. the idea is that we	don't want to require a package rebuild to change config.		bug: t121435	change-id: i968e791cda5b73148fef5b774f05739711978088	|"																																																																																																																																																																																																																																																																																																																																																																			
"fix suoders permissions for l10nupdate		since we are now using a multiword command for sync-l10n we must now	explicitly allow the l10nupdate user to pass arguments.		bug: t135849	change-id: i164690d8030a23e3898abe7bc2aa4178d8ccf02e	|logrotate: convert l10nupdate to logrotate::conf		bug: t127025	change-id: i9797e5559beb461ea53937def7013568affeae42	|install the scap package from deb instead of trebuchet		this switches scap to use the apt provider and fixes paths to point to	`/usr/bin/$binary` instead of `/srv/deployment/scap/scap/bin/$binary`		bug: t114363		change-id: iaa518889fa2c8b3d81db9e466cb63d0fcbc30cc4	|provision ~/.gitconfig file for l10nupdate user		bug: t119746	change-id: i1006d9100df562cf03872bdbbea5f3fd72221089	|don't try to run l10nupdate on mira		it won't work there yet and is causing errors"	" but we probably only	ever want it to run from one server at a given time anyway.		bug: t106460	change-id: ia3f0c968863b121144469ffc7b75e111c0eb102e	|scap: ensure /home/l10nupdate/.ssh exists		when applying the deployment server roles on mira"	 the new codfw deploy server	"	which pulls in scap"	" i got several of these errors:		""could not set 'file' on ensure: no such file or directory"" related to l10nupdate		because /home/l10nupdate got created but .ssh inside it did not so puppet failed to put the keys there.		bug:t95436	bug:t82575	change-id: ic5dc2c3f63bc3950a10f4f543d6bc9c22680be79	|scap: clone mediawiki-config on all scap masters		- get rid of scap role"	" wasn't giving us much.	- also make group ownership in l10nupdate configurable	- include l10nupdate on all scap masters		bug: t88442	change-id: i34112d01af093cf13f31c7f32d21925aa600f9dc	|scap: fix typo		bug: t87221	change-id: ia003ce509169a1b38346cb8421841f4c1c1f672f	|scap: move l10nupdate into module		bug: t87221	change-id: id8f5086d78fd8952aef3bcddce987614f80e2161	|"																																																																																																																																																																																																																																																																																																																																																														
"role::deployment: make it possible to switch between different servers		bug: t124024	change-id: i33311b76728a6aa9df7d87500b6b3fc90a11a033	|scap: add co-master configuration		configuration for scap to facilitate master-master replication.		needed by: i3d2b4e7495d75540c914b2eb999124ad1ee6f8b0	bug: t104826	change-id: i5c0a1fd283cc545ab073a514e933a87d5fe23996	|make mediawiki-config clone be owned by mwdeploy		not root		bug: t117016	bug: t104826	change-id: i7d19591961ffe32b63b97ef7b3f2477bb0d81373	|rsync:  unquote booleans		bug: t113783	change-id: i80362002e2f665daac829bfef959714f09c5c3e8	|trebuchet group wikidev; mw-staging owner mwdeploy		change ownership of files on {tin"	"deployment-bastion} to correct recent	permissions problems that arose from combining	role::deployment::server::{production"	"labs} into	role::deployment::server (i3e947637b49ce2a94128e21db35798a49e8d45e8)		bug: t94054"	" t94261	change-id: i0b391b1c50857794d1526edc2c80e3c87b67ef8c	|scap: clone mediawiki-config on all scap masters		- get rid of scap role"	" wasn't giving us much.	- also make group ownership in l10nupdate configurable	- include l10nupdate on all scap masters		bug: t88442	change-id: i34112d01af093cf13f31c7f32d21925aa600f9dc	|scap: move scap master code into own class		- create a role class for a scap master	- scap needs dsh from what i understand"	" so it should be	  in scap::master	- remove some layers of indirection that seem unnecessary.		bug: t87221	change-id: ib96af2cb7a7f84c4f023479312555add37d7c22a	|"																																																																																																																																																																																																																																																																																																																																																														
"rsync:  unquote booleans		bug: t113783	change-id: i80362002e2f665daac829bfef959714f09c5c3e8	|scap: move rsync proxies into module		it was mistakenly put in the deployment module (which afaik	does not actually deal with scap at all) in	i22dd6d44a4574f679451a606fab7750e7345bb6c. this moves it to	the scap module instead		bug: t87221	change-id: ic74c6c7ddfd85e4db083db2c307e3dcbecadc88e	|"																																																																																																																																																																																																																																																																																																																																																																			
"foreachwikiindblist: fix sudo guard and cleanup script		* change the sudo guard condition in foreachwikiindblist to match the	guard used in mwscript.	* use $mediawiki_web_user var from /etc/profile.d/mediawiki.sh	* move from template to file resource.	* reduce duplication by building command incrementally.	* use php5 explicitly to match mwscript (hhvm has poor cli performance).		bug: t136258	change-id: ifb0e55e8e2831faed1f7dabd08cfef8c64c66ae6	|make foreachwikiindblist accept dblist expressions		see i81df3a61"	" i0a460754		bug: t101213	change-id: i1026070e83a8f7e7559b6f37d99a968e0e833bf2	|execute scap-provided script as mediawiki::users::web		a couple of script used the user 'apache' and it was hardcoded		bug: t89165		change-id: i8f527b45e19ba850d2efeb0ff202835a5d87c0cc	|scap: move scap master code into own class		- create a role class for a scap master	- scap needs dsh from what i understand"	" so it should be	  in scap::master	- remove some layers of indirection that seem unnecessary.		bug: t87221	change-id: ib96af2cb7a7f84c4f023479312555add37d7c22a	|scap: move 'common_scripts' into scripts class		a mechanical move		bug: t87221	change-id: icba39e8e70680b7bbb2b47646f88f54ea9c52781	|"																																																																																																																																																																																																																																																																																																																																																																	
"keyholder key cleanup		* clean up the mess that is scap::target and keyholder::agent	* make ssh_agent_proxy look up keys by name instead of fingerprint	** this avoids needing to store fingerprints in puppet manifests	* password-protected key test is now optional and skipped on beta		bug: t132747		change-id: id298a3e0f12e31afd7ea83970e192330ffbd4243	|add new scap::source define to ease bootstrapping of repositories on deploy servers		scap::source will clone your source repo"	 and if scap_repository is set	" it will	clone that repo at /srv/deployment/$title/scap.	this allows for scap/ directories to be separated from source	repositories"	" and allows scap repos to bootstrap themselves on	deploy servers"	" instead of relying on trebuchet.		'scap::sources' is a hiera variable that contains resource declarations for scap::source	that will be dynamically by scap::server.		eventlogging/eventbus is the guinea pig here"	" so this is applied to it.  it is declared	in hieradata/role/common/deployment/server.yaml to clone from the eventlogging repository.		this shouldn't conflict with trebuchet's deployment.yaml clones"	" as the git::clone	will only execute if .git/config doesn't yet exist.		this also moves scap::server's directy hiera_hash lookups to class parameter	based lookups via hiera classpath.  see scap/server.yaml files.		todo: can we use :expand_path nuyaml config in labs?  ask guiseppe.		bug: t118772	change-id: i32bd25a84b182b52db7db81404734f1259b623e6	|hieraize keyholder::agent configuration		move keyholder::agent configuration to hiera to simplify keyholder	configuration. proliferation of *::deploy::source classes is messy	and complicates the already too complex process of adding a new	service group/key to the deployment masters.		bug: t130419	change-id: id5002cc9449deb0223f27af67a30a86c6187bfd9	|"																																																																																																																																																																																																																																																																																																																																																													
"add new scap::source define to ease bootstrapping of repositories on deploy servers		scap::source will clone your source repo"	 and if scap_repository is set	" it will	clone that repo at /srv/deployment/$title/scap.	this allows for scap/ directories to be separated from source	repositories"	" and allows scap repos to bootstrap themselves on	deploy servers"	" instead of relying on trebuchet.		'scap::sources' is a hiera variable that contains resource declarations for scap::source	that will be dynamically by scap::server.		eventlogging/eventbus is the guinea pig here"	" so this is applied to it.  it is declared	in hieradata/role/common/deployment/server.yaml to clone from the eventlogging repository.		this shouldn't conflict with trebuchet's deployment.yaml clones"	" as the git::clone	will only execute if .git/config doesn't yet exist.		this also moves scap::server's directy hiera_hash lookups to class parameter	based lookups via hiera classpath.  see scap/server.yaml files.		todo: can we use :expand_path nuyaml config in labs?  ask guiseppe.		bug: t118772	change-id: i32bd25a84b182b52db7db81404734f1259b623e6	|"																																																																																																																																																																																																																																																																																																																																																													
"keyholder key cleanup		* clean up the mess that is scap::target and keyholder::agent	* make ssh_agent_proxy look up keys by name instead of fingerprint	** this avoids needing to store fingerprints in puppet manifests	* password-protected key test is now optional and skipped on beta		bug: t132747		change-id: id298a3e0f12e31afd7ea83970e192330ffbd4243	|scap access.conf entries for labs deployments		s/beta/scap here as scap is used in more contexts	than just beta.		bug: t121721	change-id: i1b9c8a4df36b2001c1e8cc2237c662b5475ac178	|add beta-specific access.conf exceptions in scap::target		explicitly allow scap-managed users to log in to targets from the	deployment host. refs t121721		bug: t121721	change-id: i3a5b08b0a9c31d8984aac503d8e94fdab00a75cf	|zotero: use scap3 for deployment		also"	" correct a minor bug in scap::target whereby if two repos have the	same root directory"	" duplicate chown exec and sudo resources are declared.		bug: t129140	bug: t129143	change-id: i25437210c61d9861f2a493b9a601f91723ffc39f	|add new scap::source define to ease bootstrapping of repositories on deploy servers		scap::source will clone your source repo"	 and if scap_repository is set	" it will	clone that repo at /srv/deployment/$title/scap.	this allows for scap/ directories to be separated from source	repositories"	" and allows scap repos to bootstrap themselves on	deploy servers"	" instead of relying on trebuchet.		'scap::sources' is a hiera variable that contains resource declarations for scap::source	that will be dynamically by scap::server.		eventlogging/eventbus is the guinea pig here"	" so this is applied to it.  it is declared	in hieradata/role/common/deployment/server.yaml to clone from the eventlogging repository.		this shouldn't conflict with trebuchet's deployment.yaml clones"	" as the git::clone	will only execute if .git/config doesn't yet exist.		this also moves scap::server's directy hiera_hash lookups to class parameter	based lookups via hiera classpath.  see scap/server.yaml files.		todo: can we use :expand_path nuyaml config in labs?  ask guiseppe.		bug: t118772	change-id: i32bd25a84b182b52db7db81404734f1259b623e6	|scap::target: allow scap's user to restart all services on a node		scap::target's set-up of sudo rules implicitly assumed that it would be	deploying only one service per node"	" so only one sudo::user resource was	being set. however"	" we have nodes where multiple services are	collocated"	" such as the sca and scb clusters. this patch allows the same	scap deployment user to restart multiple services on the same machine.		bug: t130948	change-id: id13f35ec2cf4e32e4931ffdc9df69425d433aad8	|add a deployment source & target class for phabricator		this also adds support for key_content => secret('...') in	keyholder so that we can use a newer/cleaner pattern for	specifying the private key.		refs t125851		bug: t114363	change-id: i06eee23c338840fbba8ca81270f5ec0c81e02869	|make scap::target use the scap3 package provider		this also updates eventbus to pass manage_user=>false	refs t113072		bug: t127215		change-id: i223a9fff2d48a3372ca14e56ae94087a6530f9ee	|"																																																																																																																																																																																																																																																																																																																																																								
"add a new security module with ::pam and ::access		this helps clean up security configuration mostly in labs right	now"	" but provides general-use classes and defines to customize	pam configuration cleanly (including access.conf handling)		bug: t120106	change-id: id0183e2bc677c6d4893aeb2956c3e3650b174da6	|"																																																																																																																																																																																																																																																																																																																																																																		
"add a new security module with ::pam and ::access		this helps clean up security configuration mostly in labs right	now"	" but provides general-use classes and defines to customize	pam configuration cleanly (including access.conf handling)		bug: t120106	change-id: id0183e2bc677c6d4893aeb2956c3e3650b174da6	|"																																																																																																																																																																																																																																																																																																																																																																		
"add a new security module with ::pam and ::access		this helps clean up security configuration mostly in labs right	now"	" but provides general-use classes and defines to customize	pam configuration cleanly (including access.conf handling)		bug: t120106	change-id: id0183e2bc677c6d4893aeb2956c3e3650b174da6	|"																																																																																																																																																																																																																																																																																																																																																																		
"add a new security module with ::pam and ::access		this helps clean up security configuration mostly in labs right	now"	" but provides general-use classes and defines to customize	pam configuration cleanly (including access.conf handling)		bug: t120106	change-id: id0183e2bc677c6d4893aeb2956c3e3650b174da6	|"																																																																																																																																																																																																																																																																																																																																																																		
"sentry: really create group		apparently groups do not default to 'present'.		bug: t85239	change-id: ic8824667a74de2ae15ad7e7c58b6795ce202e625	|basic role for sentry		depends on i7a0ce9e087dee1b95f916288785470b1423f5435	and i2cfacb4544f99df9f5e6c30dc2824e8b153e27b2		bug: t84956	change-id: i1207235f0ee97c253b1a1e9e2bfa89eb79665290	|"																																																																																																																																																																																																																																																																																																																																																																			
"service::configuration: set the default log_dir to /srv/log		most services that use service::configuration store their logs in	/srv/log (changed in hiera)"	" but some still use /var/log. make the	former the default for uniformity. another point is that all of these	services are firejail-ed"	 which makes /var read-only	" hence making it	pointless for services to try to log into /var/log.		also fix a bug whereby service::node assumed	service::configuration::log_dir existed.		change-id: i2fd39e72f3b400a1b09320e92fa8105b847ab439	|services: introduce service::packages		some services"	 like mathoid and graphoid	" need extra debian packages to	be present on the system during run time. additionally"	" they also have	compile-time dependencies (mostly header files packaged in -dev	packages). service::packages provides a way for us to specify and	install the complete list of such dependencies for each service. by	default"	 service::packages installs only run-time dependencies	" but can	be instructed to install compile-time packages as well by setting the	service::configuration::use_dev_pkgs flag to true. this is useful in	cases where the service's dependencies need to be built on the spot"	"	such as ci/nodepool instances. this patch activates the flag for the	contintcloud labs project.		while at it"	" this patch also switches mathoid and graphoid to use	service::packages"	 listing their complete debian dependencies. also	"	mathoid will not be using java png generation (which was never turned on	in production any way). instead"	 the upcoming version will use librsvg	"	so list it as a dependency.		bug: t128280	bug: t119693	change-id: i882f0f768bdea0c78403513e5eb1d778bef97462	|service::node: fix logstash port		bug: t97615	change-id: i60fbc12774cbe30c7569c8b19521e23733fe70d0	|add a generic node service module		service::node is a generic puppet resource that allows node.js services to be	easily set up on the sca cluster. since all such services are set up in	the exact same way"	" most of the code can be shared between them. the	only specific parameters are a service's port and own configuration	directives. the other parameters of service are controlled by	role::sca's hiera.		as an example"	" role::citoid has been converted to using service::node	instead of its own citoid module.		bug: t95533	change-id: ic6c9d4f8d0b086b94d167fd9449377a87734456b	|"																																																																																																																																																																																																																																																																																																																																																			
"service::node: add git as deployment method		this is also used in role::parsoid::testing where we don't want	deployments via scap/trebuchet.		bug: t90668	change-id: idc1d352b6f5d4aabb499b8208114e78de35f9ab1	|"																																																																																																																																																																																																																																																																																																																																																																			
"service::node: add git as deployment method		this is also used in role::parsoid::testing where we don't want	deployments via scap/trebuchet.		bug: t90668	change-id: idc1d352b6f5d4aabb499b8208114e78de35f9ab1	|"																																																																																																																																																																																																																																																																																																																																																																			
"keyholder key cleanup		* clean up the mess that is scap::target and keyholder::agent	* make ssh_agent_proxy look up keys by name instead of fingerprint	** this avoids needing to store fingerprints in puppet manifests	* password-protected key test is now optional and skipped on beta		bug: t132747		change-id: id298a3e0f12e31afd7ea83970e192330ffbd4243	|"																																																																																																																																																																																																																																																																																																																																																																			
"service::node: add git as deployment method		this is also used in role::parsoid::testing where we don't want	deployments via scap/trebuchet.		bug: t90668	change-id: idc1d352b6f5d4aabb499b8208114e78de35f9ab1	|"																																																																																																																																																																																																																																																																																																																																																																			
"service::node: auto-monitoring of local endpoints		bug: t94821	change-id: i96ddc75be235d6efeb2e8d50f4af5bf0f8b2537a	|"																																																																																																																																																																																																																																																																																																																																																																			
"service::node: allow users to specify the logging name		some services use the same service::node definition in different	contexts"	" so allow them to specify different logging names and statsd	prefixes for them.		one such case is parsoid. in production"	 the 'parsoid' tag is used	" but	on ruthenium (acting as the round-trip host)"	" the logs and metrics ought	to have a different name. this patch also sets them to 'parsoid-tests'	for ruthenium.		bug: t141464	change-id: i16d0b03e119d659ef2c977948af2e5fd831fe853	|service::node: add git as deployment method		this is also used in role::parsoid::testing where we don't want	deployments via scap/trebuchet.		bug: t90668	change-id: idc1d352b6f5d4aabb499b8208114e78de35f9ab1	|service::node: add 'entrypoint' and 'heartbeat_to'		as we want to use service::node for deploying parsoid"	" we need to add	two configuration parameters that will be used for it.		this is part of i3f4a5 that is being splitted in multiple commits		bug: t90668	change-id: i57a656d97587101e1f9862bb6e1e56479741d307	|add the ability to configure contact group for check of services.		for example"	 on maps servers	" it make sense to the interactive team to	be notified of service issues"	" but not to receive all notifications on	which they cannot act anyway.		the immediate need is on service::node"	" but i updated service::uwsgi as well	to keep coherence.		bug: t137869	bug: t137891	change-id: i1a1911263c04132d90f53e28ab8c5d2fc3a3a2c2	|service::configuration: set the default log_dir to /srv/log		most services that use service::configuration store their logs in	/srv/log (changed in hiera)"	" but some still use /var/log. make the	former the default for uniformity. another point is that all of these	services are firejail-ed"	 which makes /var read-only	" hence making it	pointless for services to try to log into /var/log.		also fix a bug whereby service::node assumed	service::configuration::log_dir existed.		change-id: i2fd39e72f3b400a1b09320e92fa8105b847ab439	|keyholder key cleanup		* clean up the mess that is scap::target and keyholder::agent	* make ssh_agent_proxy look up keys by name instead of fingerprint	** this avoids needing to store fingerprints in puppet manifests	* password-protected key test is now optional and skipped on beta		bug: t132747		change-id: id298a3e0f12e31afd7ea83970e192330ffbd4243	|change prop: increase heap limit to 750 mb		with concurrency limiting"	" the service needs to be able to sustain	bursts of messages"	" which needs a temporary increase in the amount of	memory used by the process so it can store in memory extra messages	consumed from kafka before consumption has been paused.		increasing the limit in this instance is safe because"	" unlike other	services"	 change-prop uses only one worker per defined rule	" so the	increase in memory consumption will be seen only on a fraction of	workers"	" not across the board.		bug: t134456	change-id: ie89ef9f601c0668747d01f8ff383b4e8f627f305	|changeprop: set hyperswitch as the start-up module		there was a bug in the service's configuration where the service was	started using src/app.js. alas"	" that file doesn't even exist. change	propagation uses hyperswitch as its load module"	" so use it.		also"	" update the config as v0.2.0's config is not compatible with the	old one.		change-id: iaea347eb56448e36fc7372f839aee41d7bb0f368	|restbase: switch to service::node		there are many shared features between the restbase (w/	restbase::monitoring) class and the service::node define. so"	" instead of	duplicating work to keep all service-runner-based services updated"	" make	restbase use the service::node define as well.		bug: t118401	change-id: ica246d4e4a2c551ddf47334762a821536eccb307	|service::node: make the number of workers to start configurable		some services"	 like tilerator	" need to be able to specify the number of	service workers to run. this patch allows its configuration via the	$no_workers param added to the service::node define.		bug: t108888	change-id: ib0429ae8466ab712ae6927917cba98bcc88fad3b	|remove firejail conditional		now that firejail"	" graphoid and mathoid have been migrated to firejail	in production"	" remove the ""firejail"" conditional in service::node and	use firejailed execution for all upcoming services.		bug: t101870	change-id: i0970967a2eb7e8d9b21ef361d6107702f20e15d1	|service::node: auto-monitoring of local endpoints		bug: t94821	change-id: i96ddc75be235d6efeb2e8d50f4af5bf0f8b2537a	|allow optional firejail containment for nodejs services.		this has been initially tested with mathoid and after we flip	the services one-by-one"	 the firejail conditional can be dropped	"	making firejail the default for all future node services.		the current configuration runs every nodefs service an isolated	linux namespace with	- read-only system directories (like /usr or /lib)	- private pid space	- private /tmp (using tmpfs)	- /root and /home/* blacklisted	- reduced capabilities: cap_sys_module"	 cap_sys_rawio	 cap_sys_boot	"	  cap_sys_nice"	 cap_sys_tty_config	 cap_syslog	 cap_mknod	" cap_sys_admin	- filtered syscalls: mount"	 umount2	 ptrace	 kexec_load	 open_by_handle_at	"	  init_module"	 finit_module	 delete_module	 iopl	ioperm	 swapon	 swapoff	"	  mknode"	 syslog	 process_vm_readv and process_vm_writev	 sysfs	_sysctl	"	  adjtimex"	 clock_adjtime	 lookup_dcookie	 perf_event_open	" fanotify_init	  kcmp		bug: t101870	change-id: i7e9c8d1c3f7d6655bba598938eba885210c9e9d6	|add a generic node service module		service::node is a generic puppet resource that allows node.js services to be	easily set up on the sca cluster. since all such services are set up in	the exact same way"	" most of the code can be shared between them. the	only specific parameters are a service's port and own configuration	directives. the other parameters of service are controlled by	role::sca's hiera.		as an example"	" role::citoid has been converted to using service::node	instead of its own citoid module.		bug: t95533	change-id: ic6c9d4f8d0b086b94d167fd9449377a87734456b	|"																																																																																																																																																																																																																																																																																																								
"services: introduce service::packages		some services"	 like mathoid and graphoid	" need extra debian packages to	be present on the system during run time. additionally"	" they also have	compile-time dependencies (mostly header files packaged in -dev	packages). service::packages provides a way for us to specify and	install the complete list of such dependencies for each service. by	default"	 service::packages installs only run-time dependencies	" but can	be instructed to install compile-time packages as well by setting the	service::configuration::use_dev_pkgs flag to true. this is useful in	cases where the service's dependencies need to be built on the spot"	"	such as ci/nodepool instances. this patch activates the flag for the	contintcloud labs project.		while at it"	" this patch also switches mathoid and graphoid to use	service::packages"	 listing their complete debian dependencies. also	"	mathoid will not be using java png generation (which was never turned on	in production any way). instead"	 the upcoming version will use librsvg	"	so list it as a dependency.		bug: t128280	bug: t119693	change-id: i882f0f768bdea0c78403513e5eb1d778bef97462	|"																																																																																																																																																																																																																																																																																																																																																								
"provision striker via scap3		provision the striker django web application using scap3:	* uwsgi service running striker	* memcached server for session cache storage	* nginx vhost for static content and reverse proxy to uwsgi	* django and uwsgi logs forwarded to logstash1003 as json datagrams	* local apache combined log style access log		configuration of the striker django app is done via hiera settings. the	role settings file at hieradata/role/common/striker/web.yaml contains	dummy values for the striker::uwsgi::secret_config hiera hash. the	actual values for these production secrets should be configured via	non-public hiera settings files.		bug: t141014	change-id: i855f9484f799a6847590b5d1196abf903114fa34	|ores: add file['/srv/log'] for web nodes in labs		i wanted to put it in modules/service/manifests/uwsgi.pp	but it might be declared somewhere else in scb roles causing a mess	(because we have this directory in scb nodes already"	" no idea why)		bug: t140265	change-id: i1f2600a52265661e7e1eebf353edf6af86cc16b4	|add the ability to configure contact group for check of services.		for example"	 on maps servers	" it make sense to the interactive team to	be notified of service issues"	" but not to receive all notifications on	which they cannot act anyway.		the immediate need is on service::node"	" but i updated service::uwsgi as well	to keep coherence.		bug: t137869	bug: t137891	change-id: i1a1911263c04132d90f53e28ab8c5d2fc3a3a2c2	|service: allow not requiring scap3 for service::uwsgi		this breaks puppet on ores.wmflabs.org right now"	" and we	definitely need a transitionary period where we can both	deploy on production with scap3 and on labs with fabric.		bug: t136488	change-id: i5e33ad752890a3e6fd4d0d35ed7716e1b52de234	|keyholder key cleanup		* clean up the mess that is scap::target and keyholder::agent	* make ssh_agent_proxy look up keys by name instead of fingerprint	** this avoids needing to store fingerprints in puppet manifests	* password-protected key test is now optional and skipped on beta		bug: t132747		change-id: id298a3e0f12e31afd7ea83970e192330ffbd4243	|"																																																																																																																																																																																																																																																																																																																																																													
"ores: send icinga report to irc		bug: t134726	change-id: i7ed577bec766377a28473d3b73ad6b9b1ab44e62	|move notices to -releng from -qa		also general s/qa/releng/"	" which i hope was done correctly.		bug: t86053	change-id: i094610fb1c6dbde83c62d4a03fb1baab8c30d2ca	|duplicate -qa notifcations to -releng		the releng team would like to unify the -devtools and -qa to a new	channel -releng.		looked for all occurences of #wikimedia-qa to add in #wikimedia-releng	as well.		impacts:	* logstash: hopefully the boolean logic is fine	* icinga/shinken: straightforward"	" the list is expanded by the	  template modules/ircecho/templates/default.erb		bug: t86053	change-id: i60bfb8098b6c5e6dbbb6480f73d190a91090e464	|"																																																																																																																																																																																																																																																																																																																																																																	
"switch everything to the new openldap ldap servers.		bug: t101299	change-id: i5d5b20ac2ba857df12f448ba4060d50fcf077ba6	|"																																																																																																																																																																																																																																																																																																																																																																			
"smokeping: add protocol redirect		just like for torrus in i3d3318ebc03b15	add the http->https protocol redirect snippet	after smokeping moved behind misc-web cluster.		here we also need to ensure we have mod_rewrite and mod_headers.		bug:t120258	change-id: iac08cc39079ef162f36e2d85c2a0cdda1737d49d	|smokeping: use apache::site		bug: t118786	change-id: i843d5db34035f0d86a9945140f61025edad9e965	|delete webserver::apache::module		replaced by apache::mod::* hierarchy.		including ::apache::mod::ssl from within webserver::apache would land us with	a parser bug. so as temporary workaround"	" include apache::mod::ssl alongside	the only instantiation of webserver::apache::site for which the if guard would	be true (librenms).		the entire webserver::apache::* hierarchy will be deleted by follow-up commits"	"	so it's ok for now.		change-id: ia6e5ec8ad80f7996b679db327c30b8e1c503a114	|"																																																																																																																																																																																																																																																																																																																																																																	
"add cron job for content translation dumps		bug: t127793	change-id: i77ee28e9e08e365d2044a54eadfcc9d7f30a26d3	|"																																																																																																																																																																																																																																																																																																																																																																			
"move cron job for central auth dump to snapshot1007		also remove the enable parameter"	" tiny bit of cleanup		bug: t133694	change-id: i979855d68369421b8802be75db793cf6d416c1e2	|"																																																																																																																																																																																																																																																																																																																																																																		
"add cron job for content translation dumps		bug: t127793	change-id: i77ee28e9e08e365d2044a54eadfcc9d7f30a26d3	|"																																																																																																																																																																																																																																																																																																																																																																			
"move generation of lists of good dumps to snapshot1007		also remove enable param		bug: t133694	change-id: i8e8082879a4d33e401681a86310341ddaba97dee	|"																																																																																																																																																																																																																																																																																																																																																																			
cleanup media list generation cron job	" remove from snapshot1003		use onallwikis.py for media list generation	remove unneeded conf file	this is prep for moving the job to snapshot1007		bug: t133694	change-id: i8d9f59b20fbeea27f6edc1fe2ad60ce29e8bdee6	|"																																																																																																																																																																																																																																																																																																																																																																		
"move cron job for pagetitle list generation to snapshot1007		take the opportunity to get rid of params we don't need/use	in these cron job manifests		bug: t133694	change-id: ibf938978c8e3b1daab293981d5637b23de8aec89	|"																																																																																																																																																																																																																																																																																																																																																																			
move wikidata json	" ttl dumps cron job to snapshot1007		also remove ensure parameter"	" tiny cleanup		bug: t133694	change-id: i2e218d46035a6a4fe43f7a9fc646025083e81a1c	|"																																																																																																																																																																																																																																																																																																																																																																	
move wikidata json	" ttl dumps cron job to snapshot1007		also remove ensure parameter"	" tiny cleanup		bug: t133694	change-id: i2e218d46035a6a4fe43f7a9fc646025083e81a1c	|"																																																																																																																																																																																																																																																																																																																																																																	
cleanup media list generation cron job	" remove from snapshot1003		use onallwikis.py for media list generation	remove unneeded conf file	this is prep for moving the job to snapshot1007		bug: t133694	change-id: i8d9f59b20fbeea27f6edc1fe2ad60ce29e8bdee6	|fix up xmlstubs batch jobs setting for en wiki xml dumps		bug: t132279	change-id: i11b7d78dc322d1de6e626d1f1d80effdfbdccc07	|dumps: rebalance page ranges for dump jobs that run in parallel		bug: t123571		change-id: i0ece4aa98183c776e9c5666a201d5212761f6d1c	|dumps: checkpointing for de and fr wikipedia		bug: t116907	change-id: i7e3602074a5e33d58a8f8dbf845a41efab599e35	|"																																																																																																																																																																																																																																																																																																																																																																		
"extend dumps cron job to run partial dumps as well		this prepares the dump cron script to run full and partial	dumps as specified"	" and sets up the new cron job for the	partial dumps later in the month.		bug: t126339	change-id: if58ef377a253fd9f689a619eb40428417c9c7370	|dumps: set up but don't enable script for dumps to run from cron		also add separate creation stages for small"	" big wikis.	we must check each group separately to see if the directories	exist"	" so we'll be creating each group of dirs separately if	needed.		bug: t107750		change-id: i20bc0c2e7fa0a4781343fe852bdb36ded197343d	|"																																																																																																																																																																																																																																																																																																																																																																
"puppetize dumps monitor as a service		bug: t110888	change-id: i24c7b40980320f03972a1007df0c4a8019c4819b	|"																																																																																																																																																																																																																																																																																																																																																																			
"make sure directory creation uses the dump cron job startdate		bug: t126339	change-id: i2a2844411aab5df1e4578eebb0a908e613c35964	|extend dumps cron job to run partial dumps as well		this prepares the dump cron script to run full and partial	dumps as specified"	" and sets up the new cron job for the	partial dumps later in the month.		bug: t126339	change-id: if58ef377a253fd9f689a619eb40428417c9c7370	|dumps: set up but don't enable script for dumps to run from cron		also add separate creation stages for small"	" big wikis.	we must check each group separately to see if the directories	exist"	" so we'll be creating each group of dirs separately if	needed.		bug: t107750		change-id: i20bc0c2e7fa0a4781343fe852bdb36ded197343d	|"																																																																																																																																																																																																																																																																																																																																																																
"ssh::client: allow using puppetdb		bug: t142846	change-id: i91320b04c97a742cd367f122a504f79b7056f8fd	|"																																																																																																																																																																																																																																																																																																																																																																			
"ssh: allow customizing authorized_keys_command		bug: t113979	change-id: iee5197ef33abde4c6c0002c0129f0931bc9ab1f5	|ssh: disable ldap key lookup for hba		verified that only tools project uses this"	" and that	is handled by hiera now		bug: t101447	change-id: i59e184d6c30215e9018ab8d555895e11d4ffa6b0	|ssh: unify config between precise and trusty/jessie		- sshd has been backported from trusty to precise	- use ldap directly to verify public keys in labs"	" rather	  than the nfs mount. this removes a big nfs dependency.	- lucid support grumble grumble	- no lucid in labs"	" so all the labs-conditionalled things need	  no lucid support!		bug: t102401	change-id: i88d6ee3633a592c3dfeaa9613db311941c6485fd	|ssh: remove .ssh/authorized_keys support from prod		this is the scariest patch in this whole changeset:		remove support for $home/.ssh/authorized_keys from hosts in production"	"	relying solely on /etc/ssh/userkeys/ instead. this removes the	capability from users to set their own authorized_keys which is a good	security measure.		combined with /etc/ssh/userkeys being recurse => true"	 purge => true	"	this means that no ssh key can be provisioned manually on hosts and	puppet and only puppet can control ssh access"	" also a good security	measure.		bug: t92475	change-id: ibe090569a9241ba13bd76a44005483390629dda7	|ssh: don't look for keys in nfs on non-precise hosts		bug: t101660	change-id: i53c5fb525131efe8e2d31cd6384f88a1ae683c63	|ssh: make hba enable-able via hiera		bug: t98714	change-id: i0d68e70a627dc066700a18993216040ca6b56dcd	|ssh: don't give lucid nice things"	" because lucid is not nice		bug: t92475	change-id: i24c6ea3772871026bd5ad379ce0d7ebd77e13f2a	|ssh: support /etc/ssh/userkeys in production too		this just adds /etc/ssh/userkeys/%u to sshd_config"	" while keeping the	default value of .ssh/authorized_keys as a fallback (for now).		bug: t92475	change-id: i5758b9e762f887020efe5960fb0ff88abffda729	|ssh: change userkeys' path hierarchy		there's really no reason to use	    /etc/ssh/userkeys/%u/.ssh/authorized_keys	instead of just	    /etc/ssh/userkeys/%u		the latter is simpler and prettier. now that ssh::userkey is an	abstracted type"	" change its contents and sshd_config accordingly.		bug: t92475	change-id: idd31a91389349620ac707a289e49ccd7827928b2	|ssh: recurse/purge => true for /etc/ssh/userkeys		do not allow manually-placed keys under /etc/ssh/userkeys.		bug: t92475	change-id: id1b774316452eb3e6cc8e29656364dba8f6f6005	|ssh: introduce ssh::userkey resource		labs is currently using /etc/ssh/userkeys as one of the two locations to	place ssh user keys (the other being /public/keys"	" on nfs).		the directory is created with a file resource in the private repository	(because it was initially used only for the root user) but files are	placed underneath it here as well"	" in the beta module. move the	directory file resource to ssh::server class where it belongs and	puppet-manage it. warning: this needs a corresponding labs-private	change to avoid a conflict.		moreover"	 instead of provisioning three file resources (userkeys/root	"	userkeys/root/.ssh"	" userkeys/root/.ssh/authorized_keys) for each of root	& mwdeploy"	 be dry and create a new definition	" ssh::userkey that does	this for us. switch mwdeploy to using that"	" significantly simplyifying	it. this also needs an corresponding labs-private change for root.		bug: t92475b	change-id: i045695dd37b3920ca10be91a28aec5beee709327	|ssh server: make listenaddress configurable		for situations like id27657ca29e4196088		bug: 35611	rt: 8838	change-id: icb4cbadb2d3766869dbc5310121b69fc9e450bf2	|"																																																																																																																																																																																																																																																																																																																																																	
"ssh: make userkeys be world readable		sshd drops privs before attempting to read the keys"	" and	if the keys are root:root 0400 they can not be read. these	are public keys anyway"	" so 'tis ok.		bug: t92475	change-id: i6b56fc3f96e52f884d517b30b257fd5b300e52ec	|ssh: change userkeys' path hierarchy		there's really no reason to use	    /etc/ssh/userkeys/%u/.ssh/authorized_keys	instead of just	    /etc/ssh/userkeys/%u		the latter is simpler and prettier. now that ssh::userkey is an	abstracted type"	" change its contents and sshd_config accordingly.		bug: t92475	change-id: idd31a91389349620ac707a289e49ccd7827928b2	|ssh: introduce ssh::userkey resource		labs is currently using /etc/ssh/userkeys as one of the two locations to	place ssh user keys (the other being /public/keys"	" on nfs).		the directory is created with a file resource in the private repository	(because it was initially used only for the root user) but files are	placed underneath it here as well"	" in the beta module. move the	directory file resource to ssh::server class where it belongs and	puppet-manage it. warning: this needs a corresponding labs-private	change to avoid a conflict.		moreover"	 instead of provisioning three file resources (userkeys/root	"	userkeys/root/.ssh"	" userkeys/root/.ssh/authorized_keys) for each of root	& mwdeploy"	 be dry and create a new definition	" ssh::userkey that does	this for us. switch mwdeploy to using that"	" significantly simplyifying	it. this also needs an corresponding labs-private change for root.		bug: t92475b	change-id: i045695dd37b3920ca10be91a28aec5beee709327	|"																																																																																																																																																																																																																																																																																																																																																								
"sslcert: don't delete manually managed private keys		if sslcert::certificate's parameter $private is set to undef (as it	happens when install_certificate's parameter $privatekey is false)"	"	the meaning is not to have no private key at all"	" but to not have its	contents tampered with by puppet.		this change fixes a regression in	id34ba1fb75377b58ed841bce9792978c1ef9992c.		bug: t93212	change-id: i4ab892e9be773eff2fc985fa7792312519fac152	|"																																																																																																																																																																																																																																																																																																																																																																	
"chainedcert deps: one more bugfix to prev commits		change-id: i2e7f08ec07f4bab36333f645824944cf3c7e9ae2	|"																																																																																																																																																																																																																																																																																																																																																																			
"protoproxy/sslcert/cache: nginx ssl_stapling_file support		bug: t86666	change-id: if19dc78a8743cdcfff18b702a6c4502eeedcf393	|"																																																																																																																																																																																																																																																																																																																																																																			
"diamond: allow setting handlers via hiera		this allows us to set them to null if we want to discard	values"	" and also allows easier experimentaion in the future	if necessary		bug: t137753	change-id: ibc0820648d121cb915656094262cad22a26a288a	|diamond: allow disabling via hiera		bug: t137753	change-id: i42f0ffb29147941c905d45b9d99e8657044a1dc6	|diamond: send production traffic via graphite line protocol		this will lessen the pressure on statsdlb / statsite"	" already deployed to labs	instances in i2b7abaa44		bug: t121861	change-id: i68f585093d1006b1406e4ebd20001b4dcdb5217f	|diamond: send labs instance metrics via graphite/carbon		use carbon line protocol"	" to be received by carbon-c-relay		bug: t121861	change-id: i2b7abaa44678a7b26c988cade898313d1e42085b	|"																																																																																																																																																																																																																																																																																																																																																																
"don't install root password if has_admin = false		if we're not installing accounts or passwords"	" also	don't install the root password.  previously the	root password was getting installed on labs instances	which is not something we want.		bug: t142216	change-id: i5c2ace43e8427c607d0b8754c4c1ac29b891b0f6	|ganglia: don't run ganglia-monitor in labs		this is a partial fix for the current situation where all instances in labs	default to 'miscellaneous eqiad' cluster in the production ganglia. also"	"	host-level metrics for labs instances are already pushed to graphite by diamond	and grouped by project.		bug: t115330	change-id: i1cb6e53af05ca5ccd22a06f8d565525a970dca60	|standard: move to own module		bug: t119042	change-id: i83015837c1db244126640c1716c103af600a7d82	|"																																																																																																																																																																																																																																																																																																																																																																	
"add new projectview to projectcounts aggregation		remove projectcounts data git repo and cron jobs from aggregator.pp"	" keeping only code git repo.	add aggregator/projectcounts.pp class"	" taking care of legacy projectcounts data git repo and cron jobs.	add aggregator/projectview.pp class"	" taking care of new projectview data git repo and cron jobs.		bug: t101118	change-id: i98bc48535720935ace4a888680320602619dcbb1	|"																																																																																																																																																																																																																																																																																																																																																																
aggregate from projectviews-*	" not projectcounts-*		together with https://gerrit.wikimedia.org/r/#/c/247323/ and	https://gerrit.wikimedia.org/r/#/c/246149/"	" this change solidifies the	distinction between datasets computed using the old pageview definition	and those computed using the new pageview definition:		*counts*: old pageview definition	*views*: new pageview definition		bug: t114379	change-id: i9ca7c71324f0a354d5450239dd74700fcabd4fea	|add flag --all-projects to projectviews aggregator		this flag will make the aggregator aggregate across all projects	and create an all.csv file to be read from vital signs.		bug: t95339	change-id: ib502b1bf2fa160924bf3b70d0d41cae81733c1f4	|add new projectview to projectcounts aggregation		remove projectcounts data git repo and cron jobs from aggregator.pp"	" keeping only code git repo.	add aggregator/projectcounts.pp class"	" taking care of legacy projectcounts data git repo and cron jobs.	add aggregator/projectview.pp class"	" taking care of new projectview data git repo and cron jobs.		bug: t101118	change-id: i98bc48535720935ace4a888680320602619dcbb1	|"																																																																																																																																																																																																																																																																																																																																																														
add udp2log module	" make role::logging::mediawiki use it		bug: t122058	change-id: ie736c25c84fe66e0005a27a93b15c79c8c6ea1c5	|statistics: package hunspell-vi conflicts with myspell-da		for unknown reasons the package hunspell-vi has:		conflicts: .. myspell-da ..		but vietnames and danish are obviously different languages.	if we try to install both then puppet will attempt to change this	on every single run and the results will appear randomly changing.		bug:t121011	change-id: ic8fefc95bbc2d87323db3bdc188b198ba5f7e5cb	|statistics: remove package myspell-de-de-oldspell		this package conflicts with myspell-de-de"	" we can only	install one of them at a time.		bug:t99030	change-id: i7bb7bc3f91ad243e474b6e5e757ae85e3495c18c	|statistics: add aspell-id"	" hunspell-vi		as requested on t121011 add these dictionary packages	to stat1002/stat1003 for research / vandalism detection.		bug:t121011	change-id: iff100ecb3bee32818ed57169ec4b24a3ac604e4f	|statistics: don't install myspell-fr-gut package		we were trying to install both myspell-fr and myspell-fr-gut	but the packages actually conflict with lead to confusing results.		as confirmed by aaron halfaker we prefer the regular myspell-fr.		bug:t121011	change-id: i8aee22bc0498c01d1b08498264f871aa572d0040	|install php5-curl on statistics compute node (stat100[23])		bug: t113602	change-id: i2762dedf36f48a5c34b7d142a6d014f94ed02440	|statistics: add spell checker packages		adds 'enchant' and myspell dictionaries to statistics1002/1003.		enchant is a generic spell checking library which can use ispell"	" aspell	or myspell as backends.		in this case it's myspell"	 so adding all the language dictionaries available	"	as requested by halfak.		purpose: ""misspelled language features for machine learning and natural language processing""		https://packages.debian.org/jessie/enchant		bug:t99030	change-id: icf19a6c5cc24799707333494a5110589dbd4eacc	|install gfortran and libs on stat1002/1003 nodes		this is to install packages requested by halfak for research work.		they are requested to compile python's numpy and scipy libraries.		it's requested on the bug that these get installed on both hosts"	"	stat1002 and stat1003.		bug:t89414	change-id: id0e7e3a0ef0f5505df23e2c992c0f2330381f858	|"																																																																																																																																																																																																																																																																																																																																																												
"discovery-stats: fix script name		bug: t143048	change-id: ic2bc2c1b7b90b4e93c4c9d00978bda5f5b0c5b3e	|discovery-analytics: fixing logrotate rule name		bug: t143048	change-id: i589c2462168ee4505c2619300eb275dc000e3db4	|discovery-stats - git::clone needs to be in an empty directory		git::clone will clone repository directly in the directory given to the	define"	" it will not create a sub directory named after the repository.		bug: t143048	change-id: i3cc4042184f235454c1cacf5acceab383e86ebff	|discovery stats module		based on statistics::wmde. while the current code can be run from	anywhere on the cluster that has access to graphite"	" it might in the	future need access to db replicas and/or hadoop"	" so it should be placed	on a stat* host.		bug: t143048	change-id: ibac3173b941dbee9ac6ffe72aaa5c3dd8dcdb144	|"																																																																																																																																																																																																																																																																																																																																																																
"use eventlog1001 as main eventlogging host instead of vanadium		for this most part"	" this patch just does s/vanadium/eventlog1001/g.	it also configures a new varnishncsa instance on bits caches called	'eventlogging'"	" rather than 'vanadium'.  i have ensured that the	vanadium instnaces will be stopped"	" and the new eventlogging instances	will send to eventlog1001.  once this is applied"	" i will	manually remove the vanadium named instances and puppet configs.		bug: t90363	change-id: i2d0fc3d0a629f2bc75ef209ff2a51324893a9677	|"																																																																																																																																																																																																																																																																																																																																																															
use mtime instead of ctime when considering file retention	" fix retention for mw-logs on stat1002		bug: t118527	change-id: ic495b3a6f3b89308270150782a15a4a081c24138	|fix identation and wildcard in rsync for api.log		bug: t112744	change-id: ibb7e6df52b385dc4d816811e5f5ec6310324d657	|rename fluorine api rsync job to mw-api to avoid conflict with webrequest api log rsync job		bug: t112744	change-id: i3eb14a3d5256c91dfdf8107c3bc7072ca460e6ee	|rsync api log archives from fluorine to stat1002		bug: 112744	change-id: ibc560b70d58ba711cfd98135ed78e98bce1be5fb	|use udp2log::rsyncd class to set up rsyncd on fluorine		this gives default ferm rules to allow rsyncing of files		bug: t99245	change-id: i564b3b77b07035b15965dcf869a035630a1e2f2e	|fix for stat1002 cirrussearchrequests.log rsync job		bug: t98383	change-id: ia979c9b5b6d9917943ac92ff8e169226ea3a6930	|rsync cirrussearchrequests.log from fluorine to stat1002		bug: t98383	change-id: i11e48d07b00ba36cb510839dd23fd1a14af340bb	|"																																																																																																																																																																																																																																																																																																																																																																		
"remove more erbium related udp2log stuff		bug: t84062	bug: t118325	bug: t97294	change-id: i0fd0f200884f5480cc669ca8f6d7c8a676416899	|remove role::logging::udp2log::erbium and friends		fundraising's udp2log is gone now. remove:	- role::logging::udp2log::erbium	- misc::fundraising::udp2log_rotation	- nfs::netapp::fr_archive	- role::logging::kafkatee::webrequest::fundraising (this was for testing)	- statistics erbium rsync cron jobs		needs manual cleanup on erbium.		bug: t84062	bug: t118325	change-id: i8a7884fd72e5bbe11da6643a4d9823fb65ea254c	|remove oxygen udp2log related code		i will reinstall oxygen (as jessie or trusty) before re-puppetizing.		bug: t97294	change-id: if54b0aaa74636dc79ddceab05eb98032e697e2f3	|"																																																																																																																																																																																																																																																																																																																																																																			
use mtime instead of ctime when considering file retention	" fix retention for mw-logs on stat1002		bug: t118527	change-id: ic495b3a6f3b89308270150782a15a4a081c24138	|remove oxygen udp2log related code		i will reinstall oxygen (as jessie or trusty) before re-puppetizing.		bug: t97294	change-id: if54b0aaa74636dc79ddceab05eb98032e697e2f3	|"																																																																																																																																																																																																																																																																																																																																																																		
"rsync:  unquote booleans		bug: t113783	change-id: i80362002e2f665daac829bfef959714f09c5c3e8	|"																																																																																																																																																																																																																																																																																																																																																																			
"ensure we pull latest on analytics.wikimedia.org		bug: t134506	change-id: i23fa573fdcb9c4113af6dc4a5c1e976a75f43c7b	|cloning analytics.wikimedia.org repo		static content of analytics.wikimedia.org is	stored on gerrit repo. this change clones repo	to the location in which apache expects it to be to serve files.		bug: t134506	change-id: i20493ecffa7800813467d3e601402430c27dae5e	|set up analytics.wikimedia.org site on stat1001		bug: t132407	change-id: i27cb2da9382a49c27bc8d9c3067ede1ab6c5a228	|"																																																																																																																																																																																																																																																																																																																																																																			
"add cors to datasets.wikimedia.org		bug: t91532	change-id: ib951f91d9af64fce237fb3687cc25b84a7cff0f7	|"																																																																																																																																																																																																																																																																																																																																																																			
"replace mod_substitute logic with proxy_html due to perf issues		https://bz.apache.org/bugzilla/show_bug.cgi?id=56176 affected	the configuration with mod_substitute and unfortunately the	directive that could solve it is not present in the available	version of httpd on our repos.	mod_proxy_html offers proxyhtmlurlmap that does its job very well	and it should be more performant.		bug: t116192	change-id: ib0791160ee3595187d3cd0f03428188d421b1ea5	|add a substitute apache directive to fix broken links in the yarn ui		yarn.wikimedia.org is a proxy to the yarn ui"	" managed by a jetty	webserver. the html returned contains links with hardcoded	hostnames like analytics1001.eqiad.wmnet causing broken links.	adding also the missing proxy rules to make everything work.		bug: t116192	change-id: idb2ceaa8e900afb9b21ef220cfff89167c1268e1	|"																																																																																																																																																																																																																																																																																																																																																																		
"remove tls bits from internal sites behind cache_misc		all of these services live behind cache_misc"	" which	unconditionally provides and enforces standardized https and hsts.	getting rid of the redundant redirect/hsts code in them makes it	simpler to audit the puppet repo for functional tls-related	configuration on actual directly-public sites with less confusion.		one could make the argument that these role/sites could eventually	be re-used for a direct service"	" but if so the configuration would	be completely different.  what they do today (port 80 vhost with	!xfp->redir"	" +hsts) does not make sense for a directly-public	site"	" which would instead have port 80 vhost with unconditional	redir and a port 443 vhost with +hsts.		bug: t132685	change-id: i01f49496a73dd30c2e7ad42e94390779b82dbe65	|add apache mod-cgi to stat1001 configuration to allow perl cgi scripts.		this change is due to the fact that we migrated stat1001 to debian jessie.	the default apache config doesn't include mod-cgi so the migration broke	a pre-existent service. analytics is going to replace this old service this	quarter so perl cgi scripts won't be run in production soon.		bug: t76348	change-id: i0ec71e237b28cecc5ea7e1ccba103f5f391c2c60	|statistics: remove redundant webserver::apache include		the actual module had been migrated to apache::site anyway"	"	so this was a noop		bug: t118786	change-id: i5c5ef877003e283520eebd7035182d7182f3ae2b	|"																																																																																																																																																																																																																																																																																																																																																														
"add analytics-wmde user to role::analytics_cluster::users		bug: t141525	change-id: i822a2f9f1f3e9d77295a279fdadd8f96ea073dfc	|update analytics/wmde/scripts repo		this update will deploy:	 - update path to the db ini file	   108ba8fb015877f18ba7780d05373c3cd56e89d1	 - big cleanup"	" reorder & document	   ebb14fdaa093ee44888f122aa23407f67b56cdef	 - refactor config access	   60aa970b0ae8ccb82034b8972775cd3bf6f15b1e		bug: t140064	change-id: i7302901d5936d6c27f967cdaffae286434da09ef	|fix path and bad user requirement in stats_wmde		bug: t125989	change-id: iaf1c46340a1ba24d0ac5297e4ca9b95e71746f89	|statistics::wmde puppetization		bug: t125989	change-id: ie6c865a01e5ec00decf82ecaab221e7fa76a95b8	|"																																																																																																																																																																																																																																																																																																																																																																		
"statsd_proxy: fix optional parameter listed before required parameter		bug: t93645	change-id: i8bc0529c0e4e15df4d13ec483ae38241954c0b1f	|add a new statsd_proxy module and replace statsdlb		statslb is a trivial program that is"	 thus	" not very performant (it's a	single-threaded loop that calls recv()"	" hashes and sends ). i started	hacking on it to improve its performance"	" by for example adding multiple	threads or multiple processes (via so_reuseport) to it"	" or using epoll()	or recvmmsg(). while doing that"	" i felt a bit nih and started googling a	little bit"	" until i discovered statsd-proxy: a statsd proxy that someone	else wrote"	 that uses multiple threads with so_reuseports	" hashes using	a consistently hashing algorithm (ketana)"	" supports weights etc.		so"	 a debian package	 systemd unit	" upstart job and puppet module later	(all trivial): replace statsdlb with a drop-in statsd_proxy replacement"	"	statically configured to use 4 threads for now. this should be a no-op	from the infrastructure pov"	" just faster.		bug: t126447	change-id: ic0cbdf30f2785b6a0097089e3e9762178222cbb9	|"																																																																																																																																																																																																																																																																																																																																																				
"statsite: decommission class		bug: t95687	change-id: ic2ff480a28fa4825864454a73daa9cabd524e3ec	|"																																																																																																																																																																																																																																																																																																																																																																			
"statsite: new module		statsite provides a txstatsd replacement"	" the module allows for multiple	instances to be provisioned with statsite::instance and controlled using the	'*ctl pattern'.		bug: t90111	change-id: i265f5307f73f69c242832d148e14595bfccfdba9	|"																																																																																																																																																																																																																																																																																																																																																																		
"statsite: enable extended counters by default		default counters aren't very useful for our purposes"	" switch to extended	counters		bug: t95703	change-id: i877e9914a75882cf632a87d923f96f41893535a2	|statsite: new module		statsite provides a txstatsd replacement"	" the module allows for multiple	instances to be provisioned with statsite::instance and controlled using the	'*ctl pattern'.		bug: t90111	change-id: i265f5307f73f69c242832d148e14595bfccfdba9	|"																																																																																																																																																																																																																																																																																																																																																																	
"striker: replace nginx with apache		replace the nginx reverse proxy with an equivalent apache vhost.		note: on any host where the prior striker::nginx class was applied"	"	nginx will need to be cleaned up manually:		  $ sudo service nginx stop	  $ sudo apt-get purge nginx-light nginx-common	  $ sudo rm -rf /etc/nginx /var/log/nginx		bug: t136256	change-id: i358722da216a230586d182c6ad707704d0b61b2e	|"																																																																																																																																																																																																																																																																																																																																																																		
"provision striker via scap3		provision the striker django web application using scap3:	* uwsgi service running striker	* memcached server for session cache storage	* nginx vhost for static content and reverse proxy to uwsgi	* django and uwsgi logs forwarded to logstash1003 as json datagrams	* local apache combined log style access log		configuration of the striker django app is done via hiera settings. the	role settings file at hieradata/role/common/striker/web.yaml contains	dummy values for the striker::uwsgi::secret_config hiera hash. the	actual values for these production secrets should be configured via	non-public hiera settings files.		bug: t141014	change-id: i855f9484f799a6847590b5d1196abf903114fa34	|"																																																																																																																																																																																																																																																																																																																																																																			
"provision striker via scap3		provision the striker django web application using scap3:	* uwsgi service running striker	* memcached server for session cache storage	* nginx vhost for static content and reverse proxy to uwsgi	* django and uwsgi logs forwarded to logstash1003 as json datagrams	* local apache combined log style access log		configuration of the striker django app is done via hiera settings. the	role settings file at hieradata/role/common/striker/web.yaml contains	dummy values for the striker::uwsgi::secret_config hiera hash. the	actual values for these production secrets should be configured via	non-public hiera settings files.		bug: t141014	change-id: i855f9484f799a6847590b5d1196abf903114fa34	|"																																																																																																																																																																																																																																																																																																																																																																			
"bugfix for aaa20e4ce		change-id: ie797de2b7a20c0d723f71c78115ac6bfe904cd2d	|strongswan: remove temporary hack for sysvinit		debian bug #781209 was promptly fixed"	" so we shouldn't need this hack	anymore.		change-id: i64ad8777aa4ad48562a41e55f4fca6e52863a9ff	|"																																																																																																																																																																																																																																																																																																																																																																		
"disable ipsec monitoring temporarily		bug: t110065	change-id: i1dc4f1157201430c8c204c8c76bb6cbcae7fc613	|"																																																																																																																																																																																																																																																																																																																																																																			
"fix installation of sudo-ldap on labs instances.		historically this has been handled in the base image"	"	but now that i'm trying to apply labs classes on bare	metal this was causing trouble.		bug: t120262	change-id: id9e89ff92cb9c3292c6c49fd809179293c168e4f	|"																																																																																																																																																																																																																																																																																																																																																																		
"swift: adjust group ownership for ubuntu/debian		special-case 'syslog' group on ubuntu.		bug: t137397	change-id: if2a898f6c6b74f4d72892a8612bfb9021d65dc79	|swift: adjust group ownership/perms for /var/log/swift		make it work on ubuntu too"	 on ubuntu rsyslog runs as syslog:syslog	" on debian	runs as root.		bug: t137397	change-id: i4f6e6df334d75e2676d651a5e31140a3f3015441	|swift: redirect syslog from all daemons to separate file		this is to avoid spamming /var/log/syslog"	" also decrease the chance of logs	filling up the disk with a more restrictive logrotate retention.		bug: t137397	change-id: iec42489838e5e46c09764b15c96d3ff5e6ab68b6	|"																																																																																																																																																																																																																																																																																																																																																																
"swift: use double quote in graphite query		looks like icinga will strip single quotes when executing the command		bug: t118398	change-id: i6423e48cf471cc63bef3b73700296212e1a8951b	|swift: monitor mediawiki originals upload rate		bug: t92322	change-id: ia48a07f6c8a2e97f7d84ca29805050a20fa92a5a	|swift: refactor graphite/icinga checks		select which swift cluster to generate alerts from"	" also rename the class to	something more descriptive		bug: t88974	change-id: i52f16352431cd55f8c75516208561ebc8b7cf474	|"																																																																																																																																																																																																																																																																																																																																																																		
"swift: adjust mount options for debian and ubuntu		bug: t117972	change-id: i715937b4b07a2dbd4702ab4cf73e1005680e6198	|swift: don't wait for data disks on boot		if a swift disk has failed we shouldn't wait for it to be mounted at boot		bug: t107416	change-id: i7d1e95f286f9e3e678204f93ce1c093b38071c67	|"																																																																																																																																																																																																																																																																																																																																																																			
deployment-prep: point upload cache at swift	" fix rewrite.py to use beta.wmflabs.org domains		bug: t64835	change-id: ie0ed6ddeeeb0f12ce4b4dc271db0528add894296	|swift: redirect syslog from all daemons to separate file		this is to avoid spamming /var/log/syslog"	" also decrease the chance of logs	filling up the disk with a more restrictive logrotate retention.		bug: t137397	change-id: iec42489838e5e46c09764b15c96d3ff5e6ab68b6	|logrotate: convert swift-proxy to logrotate::conf		this should be applied with a bit of attention"	" given the swift-proxy	logs are several gigabytes large.		bug: t127025	change-id: ic2fd316b092d2206bb6d06ad1947ced9481a6fc1	|swift: add python-webob"	" remove python-swauth deps		bug: t117972	change-id: icc7928aed463b73a918f27d1b67029ab78094a9b	|"																																																																																																																																																																																																																																																																																																																																																															
"swift: aggregate and report container object/byte stats		similarly to swift-account-stats"	" report (aggregated) statistics for swift	containers. initially for mediawiki's filestorage backend to ease monitoring of	thumb and original upload rates.		also remove unaggregated functionality from swift-account-stats.		bug: t92322	change-id: icb7605dbb334ccf225a05ffe54370b33decd090c	|"																																																																																																																																																																																																																																																																																																																																																																		
"swift: aggregate and report container object/byte stats		similarly to swift-account-stats"	" report (aggregated) statistics for swift	containers. initially for mediawiki's filestorage backend to ease monitoring of	thumb and original upload rates.		also remove unaggregated functionality from swift-account-stats.		bug: t92322	change-id: icb7605dbb334ccf225a05ffe54370b33decd090c	|"																																																																																																																																																																																																																																																																																																																																																																		
"rsync:  unquote booleans		bug: t113783	change-id: i80362002e2f665daac829bfef959714f09c5c3e8	|"																																																																																																																																																																																																																																																																																																																																																																			
"tendril: let puppet git clone on changes		instead of just cloning once and never updating"	" we want	puppet to clone when there are changes in the repo.		bug:t98816	change-id: if10dbe89748a8b3905ee47fbd420949d09ab6ef2	|tendril: git clone from wmf repo via puppet		so far this was manually deployed from a github repo and the docroot	wasn't puppetized.		we are replacing it with operations/software/tendril on wmf infra	and let puppet deploy it to /srv/tendril.		i4bb2ada2cec31 needs to happen first.		bug:t98816	change-id: i086bcf3cf20ee73c80896b76d247c73bc9b3d3f5	|"																																																																																																																																																																																																																																																																																																																																																																		
"parsoid::testing: use master_dc variables		bug: t124670	change-id: ia97446f7a4278e95db2e9daff71e527b90825967	|make testreduce generic and instantiate parsoid-rt services		* testreduce is used both for parsoid-rt testing and parsoid	  visual diff testing. in the future"	" it will be used for	  other visual diff testing.		* define instantiable testreduce::server and testreduce::client	  services.		* create a parsoid-rt-server and parsoid-rt-client roles.	  right now"	 ruthenium runs both	" but this is not going to be	  the case for long. we are going to move them to different	  nodes.		  copied over some of the files from ruthenium into the	  puppet repo. later patches can improve on this and	  make some of these hardcoded files templates.	  but"	" good enough for now.		* later patches will create generic visual diffing modules and	  use the visual diff and testreduce modules to instantiate the	  parsoid visual diffing services.		bug: t118778	change-id: i4af27c21f31c9ab5b4fd351dd948866cc3604433	|"																																																																																																																																																																																																																																																																																																																																																															
"make testreduce generic and instantiate parsoid-rt services		* testreduce is used both for parsoid-rt testing and parsoid	  visual diff testing. in the future"	" it will be used for	  other visual diff testing.		* define instantiable testreduce::server and testreduce::client	  services.		* create a parsoid-rt-server and parsoid-rt-client roles.	  right now"	 ruthenium runs both	" but this is not going to be	  the case for long. we are going to move them to different	  nodes.		  copied over some of the files from ruthenium into the	  puppet repo. later patches can improve on this and	  make some of these hardcoded files templates.	  but"	" good enough for now.		* later patches will create generic visual diffing modules and	  use the visual diff and testreduce modules to instantiate the	  parsoid visual diffing services.		bug: t118778	change-id: i4af27c21f31c9ab5b4fd351dd948866cc3604433	|"																																																																																																																																																																																																																																																																																																																																																															
"make testreduce generic and instantiate parsoid-rt services		* testreduce is used both for parsoid-rt testing and parsoid	  visual diff testing. in the future"	" it will be used for	  other visual diff testing.		* define instantiable testreduce::server and testreduce::client	  services.		* create a parsoid-rt-server and parsoid-rt-client roles.	  right now"	 ruthenium runs both	" but this is not going to be	  the case for long. we are going to move them to different	  nodes.		  copied over some of the files from ruthenium into the	  puppet repo. later patches can improve on this and	  make some of these hardcoded files templates.	  but"	" good enough for now.		* later patches will create generic visual diffing modules and	  use the visual diff and testreduce modules to instantiate the	  parsoid visual diffing services.		bug: t118778	change-id: i4af27c21f31c9ab5b4fd351dd948866cc3604433	|"																																																																																																																																																																																																																																																																																																																																																															
"thumbor: use native systemd memory limiting		not all thumbor transformations go through subprocesses anyways"	" rely on	systemd to put each thumbor instance in its own memory cgroup instead.		bug: t144938	change-id: i7ed12a9eeabd063e1c2958bf3aff697497bd839e	|thumbor: enable memory cgroup		bug: t144938	change-id: iaf3b1c732f9fd5f31a5eed5dc1ef8e64dadb0ae1	|thumbor: add firejail profile		taken as a base from mediawiki's imagescaler"	" likely will need adjustments.		bug: t139606	change-id: ic172136a338ae2f0833c5a3c14b4dc64a45d56ee	|puppetization for thumbor		bug: t139606	change-id: i0b8794836eed2cb2b707f442f66c09ead6886252	|"																																																																																																																																																																																																																																																																																																																																																																	
"puppetization for thumbor		bug: t139606	change-id: i0b8794836eed2cb2b707f442f66c09ead6886252	|"																																																																																																																																																																																																																																																																																																																																																																			
"thumbor: use 'mw' as thumbor account		bug: t139606	change-id: i99b19ce46ace7481b58dbf3170f432717024d392	|puppetization for thumbor		bug: t139606	change-id: i0b8794836eed2cb2b707f442f66c09ead6886252	|"																																																																																																																																																																																																																																																																																																																																																																			
"maps: added list of cassandra servers		exposing variables with the list of cassandra servers allows to reduce	dulication of configuration.		bug: t138092	change-id: i4482702c216a1b3f80c9b01f9a6eee1f3dbf5369	|team-interactive receives maps alerts		adding team-interactive to the following alerts:		* service check on kartotherian	* service check on tilerator	* service check on tileratorui	* lvs check on kartotherian service		bug: t137869	bug: t137851	change-id: i02fca2da8ac90366d6be1c67d1e985c1b2c46228	|scap3 config for tilerator		bug: t129146	change-id: i7974ffe28b2f7858bccd90257ece27c409fa144a	depends-on: ifce82fba9bc29792d636b27721354bdb9ba8edf1	|specific configuration for new maps cluster.		for the transition"	" we need to keep specific configurations. this will go	back to only one config once maps-test cluster is decomissionned.		bug: t134901	change-id: i6244968574b084f6226403be9c4727ca39977cd6	|maps - make redis server configureable		to deploy new maps servers"	" we need to have a different redis server than	maps-test cluster. configuration has been extracted to hiera and configured	properly for both clusters.		bug: t134901	change-id: icc948e26b54274fe02b02e95727d0b4bb3fd306a	|maps: add tileratorui service		tileratorui is a service to be used to allow a human to view tiles and	schedule build/rebuild/deletes and so on. it shares the same code repo	with tilerator and the only change is the configuration and users		bug: t116062	change-id: ifd1f3d586bc8794c59c768424f804bcaf445f06e	|tilerator: start ncpu / 2 workers		by default"	" service::node sets the number of workers to the number of	logical processors. since tilerator currently overloads postres"	" start	only half as many workers.		bug: t108974	change-id: i9a87e5f62d93dad7f1f05e82b89782cd200bb913	|added tilerator service"	" granted kartotherian osm db read access		* cloned kartotherian settings for everything since they are practically the same	* clarified kartotherian's service description	* add tilerator to the same servers as kartotherian	* allowed kartotherian to access osm database - we might have to get high-zoom	  tiles directly from the sql instead of pre-generating them.	* editor auto-removed one trailing space in one of the files.	* changed all private hiera settings to reference the maps:: namespace	* added tilerator lvs service ip		bug: t105074	change-id: ifcf4f1ef77c2d25e0fc42f0582e950cc76624cf2	|"																																																																																																																																																																																																																																																																																																																																																														
"team-interactive receives maps alerts		adding team-interactive to the following alerts:		* service check on kartotherian	* service check on tilerator	* service check on tileratorui	* lvs check on kartotherian service		bug: t137869	bug: t137851	change-id: i02fca2da8ac90366d6be1c67d1e985c1b2c46228	|specific configuration for new maps cluster.		for the transition"	" we need to keep specific configurations. this will go	back to only one config once maps-test cluster is decomissionned.		bug: t134901	change-id: i6244968574b084f6226403be9c4727ca39977cd6	|maps - make redis server configureable		to deploy new maps servers"	" we need to have a different redis server than	maps-test cluster. configuration has been extracted to hiera and configured	properly for both clusters.		bug: t134901	change-id: icc948e26b54274fe02b02e95727d0b4bb3fd306a	|maps: add tileratorui service		tileratorui is a service to be used to allow a human to view tiles and	schedule build/rebuild/deletes and so on. it shares the same code repo	with tilerator and the only change is the configuration and users		bug: t116062	change-id: ifd1f3d586bc8794c59c768424f804bcaf445f06e	|"																																																																																																																																																																																																																																																																																																																																																																	
"tlsproxy: enable client/server tfo support in the kernel		enable client/server support for tcp fast open (tfo).		the values (bitmap) are:		1: enables sending data in the opening syn on the client w/ msg_fastopen	2: enables tcp fast open on the server side"	 i.e.	" allowing data	   in a syn packet to be accepted and passed to the application before the	   3-way hand shake finishes		this is the first step towards enabling tcp fast open on tlsproxy. an	nginx configuration change is also necessary (fastopen=n).		bug: t108827	ref: https://www.rfc-editor.org/rfc/rfc7413.txt	change-id: id0b37f26225e26d94e31d6948f4679a9d80fdd41	|tlsproxy::instance: add missing hiera varnish_version4		bugfix for 2463071ed		change-id: i5dfb5e154b11d9e25d1f16c3456e7252b1782530	|support optional keepalives and websockets for v4 only		the websockets part requires the request buffering disable in the	earlier commit"	" i think.		bug: t134870	change-id: id31596760ee24b14ba93289b489f4529ad1853fa	|remove do_spdy conditional"	 all h2	" 1/2		this commit is split just in case of puppet race conditions.		bug: t96848	change-id: i72db4088b3c0938af02adada5f6ace4ecd47ed53	|tlsproxy: use do_spdy to control http2-vs-spdy		bug: t96848	change-id: i9debd779e169e6dc99cac1472c53c6f1a3a43c8b	|logrotate: convert nginx to logrotate::conf		bug: t127025	change-id: i66a67d6d0bac58eeb20d028a8d6a2121602a92e8	|base: move mysterious_sysctl from webserver		also webserver module is dead!		bug: t118786	bug: t118812	change-id: i53743262fd1413fae79cd6e2b3d7cc1f3d4e3628	|tlsproxy: enable dhe-2048 fs for android 2.x"	" etc.		bug: t104281	change-id: i648aaf21e35a6f9fe54e96f85fade0b269a8f7aa	|"																																																																																																																																																																																																																																																																																																																																																													
"beta: use let's encrypt cert		acme_tiny is modified to allow tls redirection to an invalid cert for	acme-challenge.		bug: t50501	change-id: i450316d795046ed49d057b221433ce9b172b9d6b	|tlsproxy: enable tcp fast open		after enabling client/server tfo support in the kernel in 2b8b99d and	verifying that lvs does not interfere with the modifications to the 3whs	introduced by tcp fast open"	" we are now ready to enable tfo support on	all tlsproxies.		we introduce a new hiera setting to limit the number of concurrent	pending tfo requests: tlsproxy::localssl::fastopen_pending_max. see rfc	7413 section 5.1 for an explanation of why this is needed.		the tcpfastopenlistenoverflow counter gets incremented every time an	inbound syn packet with tfo gets treated as a non-tfo syn because the	fastopen_pending_max threshold has been exceeded. we will keep an eye on	such counter and likely increase fastopen_pending_max as soon as client	adoption of tfo becomes significant.		bug: t108827	ref: http://nginx.org/en/docs/http/ngx_http_core_module.html#listen	ref: https://tools.ietf.org/html/rfc7413#section-5.1	ref: https://bradleyf.id.au/nix/shaving-your-rtt-wth-tfo/	change-id: i96e3b6f64d73346a7a6d94d475fcbbcdd071d5c0	|tlsproxy: redirect-only service on 8080		bug: t107236	change-id: ieb8d43bf7edc7f068f76aa08fa5c3a070b79e3ba	|support optional keepalives and websockets for v4 only		the websockets part requires the request buffering disable in the	earlier commit"	" i think.		bug: t134870	change-id: id31596760ee24b14ba93289b489f4529ad1853fa	|tlsproxy: use http/1.1 only in conjunction with varnish4		bug: t107749	bug: t131501	bug: t134989	change-id: icde4ef30148870e0a917902a867bf9fcda186819	|remove do_spdy conditional"	 all h2	" 1/2		this commit is split just in case of puppet race conditions.		bug: t96848	change-id: i72db4088b3c0938af02adada5f6ace4ecd47ed53	|tlsproxy: nginx keepalives param for testing		bug: t107749	change-id: icedfa93c65f8cf279178a028fc9bdcdcebce590c	|spdy support toggle"	" off for cp1008 canary		bug: t125979	change-id: ieb8dd08349d655ad32bdb905374dff6634acddac	|tlsproxy: refactor/cleanup"	" beta work		for production"	" this mostly eliminates some pointless intermediary	classes like role::cache::ssl::local and unifies the configuration	of the ""unified"" cert a bit more between clusters (including new	monitoring for some).		all of the betassl hacks are removed completely"	" and the ssl	related beta conditionals are now reduced to just one small block	in role::cache::ssl::unified.  this will currently break on beta"	"	but the previous config was also broken in beta"	" so no change	there.  i'd rather target convergence than divergence when we	start fixing that on the beta instances"	" and this change brings	them into much closer (if not perfect) alignment.		bug: t97593	change-id: i83d36b5db01becbd5cd42edbf630621549becf24	|tlsproxy: multi-cert support"	" including ocsp		this updates tlsproxy::localssl and all callers to support an	array of certs for a single nginx-level ""site"""	" for e.g. matching	ecdsa+rsa keys that are otherwise-identical.		this includes updates to the stapling stuff to support multiple	certificates in a single ssl_stapling_file response.  the stapling	updater cron was relatedly refactored to use a set of input	configuration files instead of just refreshing whatever it finds	in the ouput directory.		actually using more than one certificate in a site's cert array	requires special non-standard nginx patches at this time.		bug: t86654	change-id: i996b7f958d17df1516c8f011001518c5397cd5e2	|"																																																																																																																																																																																																																																																																																																																																																						
"ocsp stapling: make icinga alerts more aggressive		bug: t132835	change-id: i2e4e8094c2bb5c8020c9d559d8e01fdb0aa7ede5	|"																																																																																																																																																																																																																																																																																																																																																																			
"diamond: sge stats run from the services hosts		bug: t140999		change-id: ic068c5c60c79a4b187553f65f511a38b39d74bb1	|tools: add script that helps manage sge exec nodes		this patch adds a bash script - exec-manage"	" that helps	check status"	 depool	" repool and test a grid engine exec node.	this will help while running tools wide maintenance operations"	"	such as the /data/scratch migration.		bug: t134896	change-id: i659fb5a79b25c6159df3f0de10df895c57092f69	|toollabs: collect stats on grid usage by job		bug: t140999		change-id: i0bcf71b7553ae821b11acbe2b5c6049fe9310c0f	|tools: set cgred application to trusty only		precise has some compatibility issues and we are limping along	on one historical bastion for legacy use cases.  jessie is	untested and will need some investigation.  relevant hosts are	intentionally trusty.		bug: t140696	change-id: ib1398c6c95091515ccb2c7f0f9192972c139617f	|labs bastions cgroup for /shared/bin/node		bug: t131541		change-id: i720a11e79a88d192c7c70a9bb035bb8706c6b845	|tool labs bastions tcl cgroup		treat tcl interpreted procs as 'scripts'.		bug: t131541	change-id: i690a5a3dbf17de08d64af3414333f8e24c7b6dc0	|toollabs: use a template for limits.conf		nproc limits should be adjustable per host		bug: t131541	change-id: i53bc53a461deb8fe2ea2942119254003b9dc22c2	|cgred changes for toollabs bastions use case		- allow explicit ordering of fragments for cgrules.conf	- purge unmanaged entries for conf and rules	- raise shell memory limits	- use '%' to match across subsystems		bug: t131541	change-id: i5959482c2bdc4cfaf5dd94a9e4082ff21b7d02c4	|toollabs: bastion setup for cgred::group throttle		bug: t131541	change-id: i04a89dca94494eaebdf7759e026e89fa5a9d7484	|toollabs: bastion setup for cgred::group shell		we are already doing this under duress as a temporary	measure and this codifies.		bug: t131541	change-id: iedb9dc6598130cce01d81fbf28715fb447bdfdb6	|toollabs: bastion setup for cgred::group user daemons		we are already doing this under duress as a temporary	measure and this codifies.		bug: t131541	change-id: i5278cc1febb53149390f337cf51c6a3d622d73f8	|toollabs: bastion setup for cgred::group utilities		we are already doing this under duress as a temporary	measure and this codifies.		bug: t131541	change-id: i8c633292b2adf7804f1258283bcbe8829076e262	|remove duplicate package def for cgroup-bin		bug: t131541	change-id: i906f0c5bc945a52f16b68dff3f5a1184f02dfeb9	|toollabs: bastion setup for cgred::group scripts		we are already doing this under duress as a temporary	measure and this codifies.		bug: t131541	change-id: i4d0841b78fce2972c57c0de8663dc66b11292ed3	|pam_limits tools bastion parameters		establishes some baseline limits to prevent	leaky scripts running long term"	" users who	accidently fork bomb"	" and general shared	resource sanity.  we have been running with this setup	since early last week due to some crisis intervenion	(even on the xlarge instance).		bug: t131541	change-id: i0f92290a27e95217b57acd823d13e8231c90a86e	|toollabs bastions install cgroup-bin		bug: t131541	change-id: i8e3220b64aaa493729659bde386a6222d5239146	|toollabs: remove motd-tips		motd-tips tries to access a (non-existent) tips database on nfs"	"	which breaks root login to tools hosts when nfs is down.		bug: t104327	change-id: icf3ace6022d7b9644cb73066b12969835ff9d503	|tools: properly puppetize crontab replacement		bug: t86445	change-id: ia94c3b31fb01b52e54bf4b6471b61cc2d75ba710	|tools: don't forward crontab to tools-submit for system users		bug: t87527	change-id: i96cfdc8d2284a11c5736507c247b1bb2f00b2e54	|tools: make crontab host configurable		bug: t87387	change-id: id2c2afc4d9032f203a13ea832ad26e4aca0dfc39	|tools: manage obsolete files in /usr/local/bin		/usr/local/bin had some obsolete versions of scripts that since then	have been moved to /usr/bin.  to properly manage those"	" we add	symbolic links pointing to /usr/bin.  also"	" the requirement of the	jobutils package is moved from toollabs::bastion and	toollabs::webserver to gridengine::submit_host.  this fixes bug		bug: 52258	change-id: i28ff4ea1806f0f58e1738cf8194f44ea49085608	|"																																																																																																																																																																																																																																																																																																																																																										
"toollabs: move bigbrother to services nodes		bug: t123873	change-id: ia176352060537c6df05d5f9e60beef187919b983	|"																																																																																																																																																																																																																																																																																																																																																																			
"tools: switch to newer webservice comand		yay!		bug: t98440	change-id: ie1434e592b1d539f3768b36dd56ac69671af8692	|toolschecker: use system's ca certs		bug: t114638	change-id: i8de883d4135a2015d697f303e25fb5e698214d00	|tools: remove dependency of toollabs::checker on toollabs::submit		change 848c849a5a76c6dec318ddf3a9ce25e3d619365a introduced a	dependency of toollabs::checker on toollabs::submit to be able to test	starting and stopping web services.  as a side-effect"	" this also	installed the whole environment for execution nodes and started	(redundant) bigbrother services on checker hosts.		this change instead depends toollabs::checker on	gridengine::submit_host and only installs the executables and packages	that are needed to perform checks.  it does not attempt to roll back	the changes no longer needed but leaves that for manual	administration.		bug: t113744	change-id: i06fc591edc9db516c811ef45ed170fd255e2683e	|tools: replace reference to tools. in toolschecker.upstart		bug: t87387	change-id: ida6a68a696e264805432e9890e413bf9c7cb9d24	|toolschecker:  added db tests		bug: t107449	change-id: icd413f163a396c22083646f57c7f2ef86139af3b	|make copy of our instance puppet certs that tools checker can read.		then use them.		bug: t107456	change-id: i4a0529738766855575176b1aad5c6e814e60053c	|tools: replace reference to tools. in class toollabs::checker		bug: t87387	change-id: i6bc7c52e502440d03176b069c53a6b3161446adb	|"																																																																																																																																																																																																																																																																																																																																																																		
"toollabs: add composer to dev hosts		re-use the git repository used by the ci team.		bug: t104789	change-id: i277d84cef3c9f0f05ca9fe96a780eae44d36386a	|"																																																																																																																																																																																																																																																																																																																																																																			
"toollabs: allow hba login to all hosts		bug: t104613	change-id: ie510cd32c26743ee83165c097d38535d452cccd5|"																																																																																																																																																																																																																																																																																																																																																																			
"toollabs: backup crontabs from cronrunner		bug: t123873	change-id: ie68b64b29519bcfbc86fe8dd547628776c32ccd4	|toollabs: add cronrunner role		splitting up submit_host to clearer sub-roles		bug: t123873	change-id: ic1e0e1d593974dca1979034acfb84b97e86db94f	|"																																																																																																																																																																																																																																																																																																																																																																			
"tools: switch to newer webservice comand		yay!		bug: t98440	change-id: ie1434e592b1d539f3768b36dd56ac69671af8692	|tools: add dev packages needed to compile python-ldap		add libldap2-dev"	 libsasl2-dev	" and libssl-dev packages needed to	compile python-ldap so that it can be installed in a virtualenv	container using pip.		the list of apt packages is also sorted (openjdk-7-jdk was in incorrect	position) and adjusted to make additions alphabetically after 'valgrind'	easier in the future.		bug: t114388	change-id: i421556751dc2a963ee88938c3cf3bbce821c8b09	|toollabs: install ruby dev tools on dev hosts		precise: (no matches)	trusty: bundler (1.3.5)	jessie: bundler (1.7.4)		precise: rake (0.9.2.2)	trusty: rake (10.0.4)	jessie: rake (10.3.2)		precise: ruby-dev (virtual -> ruby1.8-dev)	trusty: ruby-dev (1:1.9.3.4))	jessie: ruby-dev (1:2.1.5)		bug: t120287	change-id: i1bdd6de3e5e832fb02674f8273dea55ba7ace380	|toollabs bastion: install gnu automake		for compiling binaries directly from git repos.		bug: t119870	change-id: i987d75e237ac51a3749312177e057c8e9511e52f	|toollabs: add composer to dev hosts		re-use the git repository used by the ci team.		bug: t104789	change-id: i277d84cef3c9f0f05ca9fe96a780eae44d36386a	|tools: install flex on bastions		bug: t114003	change-id: i535aaba5365990deb84ddec569d7b4b8c1e512b6	|toollabs: add script to generate python package listings		because the specific packages available on different releases	differs between python 2 and 3 /and/ between releases"	" generating	the list based on the published package lists is the easiest way	to provide a 'best-effort' set of available packages.		genpp/python*.pp is generated by running genpp/python.py. the	generated files are included in git because a) puppet expects puppet	files"	" and b) this allows human review of the generated files.		report-python.html is the auto-generated report of installed packages		bug: t101646	change-id: i31b2986d9b8f910f9c03ddde13696ae58011b65d	|change bz references to phabricator tickets		except in the mediawiki module		bug: t96431	change-id: i6b36e500635537e28520bf5bd61585ff00a41755	|tools: make webservice2 the default webservice		since /usr/local/bin overrides /usr/bin. scripts that fully	specify path wouldn't see any effect.		bug: t90855	change-id: if6cfc9f2a987920280edf3648211227009da3a7a	|tools: install byobu		bug: t88989	change-id: ib5d2e483e314a9c02c507ce4b0e1fbe32fc04105	|tools: install npm and nodesjs-legacy everywhere		because npm start is used to run these servers.		bug: t1102	change-id: ib0e25658f1b1c06941d518b59c28e650517911e7	|tools: install rlwrap in dev_environ		bug: t87368	change-id: i7ac26f39f4ee4bd01212aed3ede580f75e381ce9	|tools: install valgrind on bastions		bug: t87117	change-id: i680bdd8a04b6800ed105e27f5a05a2981c63a56a	|toollabs: add geoip packages		bug: 62649	change-id: i73626d17d5419611100fb7b991b20db97d7e3479	|tools: install user-requested packages		bug: 61445	bug: 65354	bug: 65426	change-id: i941b9556a80d547f8456caedc330d2d2981e8f2a	|toollabs: install pastebinit		bug: 50935	change-id: idf972516fcb589bc163fda6a643b8f61147f7fdc	|tools: install packages git-review and joe		bug: 62236	bug: 62871	change-id: i33dcde3dfd6d03ec17ee332eefe1880416a519f0	|tool labs: package libfcgi-dev		bug: 52902	change-id: i94d1618128169938c426732c0f97f14ff1349806	|tool labs: package installation round		bug: 58649	bug: 58516	bug: 58500	change-id: ibeff54cf925ce035591636862d9a81f7f2c3fa2b	|tool labs: install pyflakes in dev environ		similar to pep8 added by 77bd329"	" adds in pyflakes on toolslabs.		bug: 57863	change-id: i6fbf337240e5e9373e9b0dc5d266c1b795379842	|tool labs: install pep8 in dev environ		bug: 57863	change-id: i3c4e24ace1aa5cbad547756c01905cb8c6495a60	|tool labs: install djvulibre support		bug: 56972	change-id: ib32f53d3850a2043b85cc9f636f0e4724c04b929	|tool labs: multiple dependencies installed		bug: 57000	bug: 57001	bug: 57002	bug: 57003	bug: 57118	change-id: i065482ce37fd44a0df30dc67f1007065a631414d	|tool labs: install links and lynx to dev_environ		bug: 56997	change-id: i06cd40cde6533c0596dfa908073efcc156d75525	|toollabs: install ant on -login and -dev		bug: 55938	change-id: i0aef2811411745917762bad2f4d84f32be02fdbe	|tool labs: dependencies for bz 56996		bug: 56996	change-id: i6fecf617555b140288127162dd5b63ccbe0d0eaa	|tool labs: import many dependencies from ts's jira		bug: 56994	bug: 56995	change-id: i7eaf60abad202d815c2cad846c92f02121d480ef	|ensure that a matching version of jdk is present for the jre		since we specify the java 7 jre on exec_environ"	" we should have	the equivalent java 7 jdk on dev_environ.		bug: 54444	change-id: i308a7a91397915613403e07b15b00f2a0ebd5357	|tool labs: packages libdmtx0a"	" libdmtx-dev		bug: 53867	change-id: ice3ad0e09f12325b6f5399691e60ac743e4679c9	|tool labs: boost for python		bug: 53627	change-id: i1e50b981867faf2751fdea173f0e400c85a2b9e6	|tool labs: move dev packages to dev_environ		bug: 52717	change-id: i3dbc164cda28b95a8a0d54e8589755b9b2256aea	|ssh keystore for toollabs class		- bugfix: toollabs::master doesn't take a gridmaster arg		change-id: i0c63cd970acf33ab26a45ee261434bc7c710aa80	|"																																																																																																																																																																																																																																																																																																																																																												
"toollabs: install pdf2djvu		bug: t130138	change-id: ib75973e95b59c3ab5794563a1dbeaf7ffb55f6d0	|toollabs: install inkscape on exec nodes		precise: inkscape (0.48.3.1)	trusty: inkscape (0.48.4)	jessie: inkscape (0.48.5)		bug: t126933	change-id: i2b2d460c7c37f1ab13e379d17dfe00f723f4d3ca	|tools: allow users to create unpriv chroot		bug: fakechroot	change-id: i7bf06f7b418b2c05eda4aef59b6ecc1405f0f727	|add tex/latex fonts to tools exec nodes		bug: t137121	change-id: id9fea89132c2acc6d872e65b02c46580cbb206e3	|add 'libertine' fonts to tools exec nodes.		bug: t137121	change-id: i1e4f3e8d59db04a5bcb401cb1d5867439720e5de	|toollabs: replace trusty php5 session cleanup script		replace the php5 session cleanup cron job and script packaged with	trusty with a backport of the debian php 5.5 scripts for the same	purpose. the lsof check used in the ubuntu stock script can hang	indefinitely.		bug: t135861	change-id: i4ed6ba845fe96c62be1d45eb28998176dfd434eb	|tools: install xml2 on execution nodes		bug: t134146	change-id: i235aeabfc08f9775a99a2188886525a07af7906d	|tools: don't track mediawiki's font list for precise		'upstream' (in this case mediawiki module) doesn't support	precise anymore"	" so we probably shouldn't either. copies	the list of fonts to a static separate legacy class so	we don't end up with weird missing fonts on new precise	instances.		bug: t132282	change-id: ice36c77a4ecdb58fd05536b8be296b5cae5e84fb	|toollabs: install virtualenvwrapper		precise: virtualenvwrapper (2.11.1)	trusty: virtualenvwrapper (4.1.1)	jessie: virtualenvwrapper (4.3.1)		bug: t131840	change-id: i68847826868d4f1f364a84af96f753636edc96da|toollabs: libbytes-random-secure-perl does not exist on precise		bug: t126168	change-id: i928062f9f0f52cf7b827331a5de7f3c49b2d4580	|tools: replace php5-mysql with php5-mysqlnd		claims to be a fully compatible but faster replacement"	" so	let's give it a shot. provides functions unavailable to php5-mysql		bug: t125758	change-id: i9646ddf3667f74d90c3f079602378f4f1a1b5e55	|toolslabs: install hunspell and libhunspell-dev to exec nodes		bug: t125193	change-id: icb16c6ccac08bacf4fd27188569678c8e3b4c388	|install libbytes-random-secure-perl on tool labs		bug: t123824	change-id: i3cafd856d25ff044b5b836a762380a1bcc92c85a	|toollabs: install hunspell"	 python*-hunspell	" hunspell-dictionary to exec nodes		hunspell"	 hunspell-dictionary are available on {precise	 trusty	 jessie}	"	but python*-hunspell is only available on {trusty"	" jessie}.		requested on irc by reza1615 for their tool		bug: t123192	change-id: i3347bb0eddee00ea70d8f1f0509c196488c3a472	|toollabs: remove motd-tips		motd-tips tries to access a (non-existent) tips database on nfs"	"	which breaks root login to tools hosts when nfs is down.		bug: t104327	change-id: icf3ace6022d7b9644cb73066b12969835ff9d503	|toollabs: install libsort-fields-perl		precise: libsort-fields-perl (0.90)	trusty: libsort-fields-perl (0.90)	jessie: libsort-fields-perl (0.90)		bug: t116579	change-id: i07e857be87ec10326d25520b4ab8aeaa34deb07f	|toollabs: install mailutils		precise: mailutils (1:2.2)	trusty: mailutils (1:2.99.98)	jessie: mailutils (1:2.99.98)		bug: t114073	change-id: i547f7cfb6e96e854bb4745cafb85fb3099dd7228	|toollabs: install hugin-tools		precise: hugin-tools (2011.4.0)	trusty: hugin-tools (2013.0.0)	jessie: hugin-tools (2014.0.0)		bug: t108210	change-id: i07d81b0832612885dcbf7ce1f4e2afd1ae82a11e	|include python-mwclient (latest) on exec nodes.		bug: t114365		change-id: i44d700b1899bc2ebaace21b841ce698e2e35f2ca	|toollabs: add script to generate python package listings		because the specific packages available on different releases	differs between python 2 and 3 /and/ between releases"	" generating	the list based on the published package lists is the easiest way	to provide a 'best-effort' set of available packages.		genpp/python*.pp is generated by running genpp/python.py. the	generated files are included in git because a) puppet expects puppet	files"	" and b) this allows human review of the generated files.		report-python.html is the auto-generated report of installed packages		bug: t101646	change-id: i31b2986d9b8f910f9c03ddde13696ae58011b65d	|tools: install python3-scipy		bug: t103136	change-id: ie7598993639a1c5f36051bf0fe489df3e245642a	|tools: add python-ipaddr to exec_environ		bug: t86015	change-id: id5d2f0f70c9f238beb7b9efa1c8876a0141a3808	|tools: do not require package python-sh		python-sh was required for yuvi's such-a-bot but that now uses a	virtualenv"	" so this change removes the project-wide requirement.		bug: t91874	change-id: i849a9431482321b7c11cbf232f852d984c2a1855	|tools: include labsdb aliases only in exec hosts		these were on the gridengine master as well and gridengine-master	falls over and dies intermittetnly if the hosts file is too big.	we only really need this on the bastions and the exec hosts"	"	so let's include those only there.		bug: t100554	change-id: icdb17130b7797cbf0f9f8e16aa00c395ceb0b56d	|tools: do not require redundant package python-celery-with-redis		python-celery-with-redis is a ""bundle"" that ""installs the following	packages: ['celery>=3.0"	<4.0'	 'redis>=2.4.4']". however	" if those	specific versions were indeed wanted"	" they wouldn't actually be	fulfilled by the package as it just requires python-celery and	python-redis unconditionally.		as debian is very careful to stay backwards-compatible and we already	require the packages python-celery and python-redis (via	::redis::client::python) in	modules/toollabs/manifests/exec_environ.pp"	" this change removes the	redundant requirement.		bug: t91874	change-id: i53a9dfe025717523cbf3f46f2bc9070df62049d0	|tool labs: add xvfb to exec environment		bug: t100268	change-id: i8d3b090d83b1f1497457313c3aa04154586d6e43	|tool labs: install calibre for wsexport		bug: t100165	change-id: i0d180e1a52c3944669a44a894da942e3af00089f	|tools: fix trusty vs precise packages		bug: t97628	change-id: ic114ae7b94d0f442dd63de8a3dcc0bb61c06e72c	|install flake8 (both python 2 and 3 versions)		bug: t90447	change-id: iaa31550dd902f5f90b69678658b770d4782d54a8	|tool labs: add whois to exec nodes		was once default"	" but trusty made it optional.		bug: t98555	change-id: ie4c2370ddffa982e431f35540de6c60481ae8804	|labs: add jamvm explicitly on all flavours		bug: t98195	change-id: ib7134804c5887536d889f7774fc8b8fd38ed0c78	|change bz references to phabricator tickets		except in the mediawiki module		bug: t96431	change-id: i6b36e500635537e28520bf5bd61585ff00a41755	|tools: install npm and nodesjs-legacy everywhere		because npm start is used to run these servers.		bug: t1102	change-id: ib0e25658f1b1c06941d518b59c28e650517911e7	|tools: install python-socketio-client		package + dependencies custom built and installed on	local toollabs repo		bug: t86015	change-id: i544b79767a8e9b593db712c769803a2df5156b71	|tools: install python-unicodecsv		added local package to toollabs repo"	" backported from trusty		bug: t86015	change-id: i7acb35fdccdc951a14ce55a6ea4860878bb74f0b	|tools: install some pywikibot dependencies		bug: t86015	change-id: i36ef7157ce3e1516ac6711bfd446d93d6892e287	|tools: add mono fastcgi server package to exec_environ		bug: t85142	change-id: i18770b5a69e57b44fe3ffc3f04f4a3b89c2ccd4f	|tools: add hhvm to exec_environ		bug: t78783	change-id: ib68c0d8ed67c6d291c9332c62dd043bbb0e1292e	|tools: add perl library to toollabs exec_environ		bug: t76976	change-id: ib995eac0837b9a4e726de7eb52b4089fd4565711	|tools: add libraries to toollabs exec_environ		bug: t76974	change-id: i8f7a444bbf14ba22a6742557603af4fa5950f75f	|tools: add postgis package to exec_environ		bug: t76226	change-id: if4ac5f88d2430f5560cd6f0954f1068ad74dd4fe	|tool labs: add melt		bug: 69365	change-id: i41299cacbd6c2997f2eebe8338be96a55f6701c9	|tools: install package python-pygments 		provides syntax highlighting features		bug: 69050	change-id: if483ada9dfea6f47ac396a292dc4e36c1bf21823	|tools: include mediawiki::multimedia::fonts in exec_environ		when i previously included mediawiki::multimedia::fonts in	role::labs::tools::execnode to resolve bug #58740 in change	i421685039b7ae9f73535ac92b3d8b6e5ecf1b1ac"	" i did so under the	apparently wrong impression that only roles should include classes.	the net effect however was that the fonts were only installed on	""true"" execution nodes and not on the bastion or webserver nodes"	"	making for a rather strange setup.		at user request and with more logic"	" this change moves the include to	toollabs::exec_environ so that the fonts are installed on all nodes	where they are actually expected and needed.		bug: 66354	change-id: ie071002eef9d4824d7b70de0c6bdeb679450cca4	|tools: install libgd-gd2-perl		bug: 67199	change-id: i7c5c3f1a709541126cd1ce711d36b5df891df292	|tools: install php5-imagick		bug: 69078	change-id: i2805392b149c8e23a5cd5ebe4c41a351e19d06ff	|exec_environ.pp: install libaio1 to enable asynchronous i/o system calls		install linux kernel aio access library libaio1 to enable userspace to use asynchronous i/o system calls.	this can improve performance for applications like databases or webservers		bug: 68615	change-id: i482c530ef8b47e21f3f4a9107fd41f3b4416fd0e	|tools: install user-requested packages		bug: 65974	change-id: i1a26de401f563fbc494ce04d21baf01b384e1f4b	|tools: install libcgi-fast-perl		bug: 68269	change-id: i16021d78b32858173af15fd05024bbcc111777d8	|tools: install pdf2svg		bug: 68092	change-id: i8fe9cc98b333bf42d68240a6836de2ceb54b4417	|tools: install xsltproc		bug: 66962	change-id: i01cfb2f72c3a7de39a5ac2b3439022122fdfbb15	|tools: install openbabel		bug: 66995	change-id: i2653e1d80ca30522c764e5da1937b2795821e6ea	|toollabs: add phantomjs package		bug: 66928	change-id: id88e9e1dc472ed5a3c291f0b82f2f4f453ddb493	|toollabs: add geoip packages		bug: 62649	change-id: i73626d17d5419611100fb7b991b20db97d7e3479	|tools: install catalan locale		bug: 62269	bug: 66721	change-id: icd6abf4572c7e3da3347b5f7b1b78b3a5b0f8f98	|tool labs: add libfcgi0ldbl for tcl fcgi		so that it works.		bug: 56995	change-id: i740118d0e45248c972752d62ea178608ef6c5b8d	|tools: install user-requested packages		bug: 61445	bug: 65354	bug: 65426	change-id: i941b9556a80d547f8456caedc330d2d2981e8f2a	|toollabs: add gdal-bin to the exec environment		bug: 65123	change-id: id7abcd18ee9fc8c4e43aab28d817501f2f3220d3	|tools: install jq and pdftk		bug: 65048	bug: 65049	change-id: ic4a6bb3ad4e226922603de480a6b490c213074ef	|tools: install package libxml2-utils for xmllint		bug: 62944	change-id: i68939699832b9e35e9e9d7b780b12101736bf4bd	|tool labs: install python-mwparserfromhell		bug: 63539	change-id: i85784873f6431037bf29d93f714ac31cf8d47d2f	|tools: install php5-pgsql		osm users need it to connect to dbs using php.		bug: 63383	change-id: i07e56a10d81973d87d3e1068758952bd2b968055	|tool labs: add user-requested packages		bug: 63000	change-id: icb08d33bf1cf832f8bf289f35fdba83ce703d231	|tools: install package supybot		it is an irc bot written in python and used to run meetbot.		bug: 61088	change-id: ib45ded670d4096bbe4103bc40a86d70a07d3362f	|tool labs: install tabix on exec_environ		bug: 61501	change-id: i9f33d287f381c1807a5914a63a54f73ec49b909f	|tools: add ukrainian locale and sort list		bug: 60730	change-id: ica8158acf0fc3b172394299e5bf18b4b2ed8ea0e	|tools: install python-magic		bug: 60211	change-id: ifae25cfd9ec400a27fe8b5bf7f078576d39bda4b	|tools: install requested package python-pyexiv2		bug: 59122	change-id: i7ce5c5c3ba4104cb5c6030a41f80df8d0627d32d	|tools: add requested package libjpeg-turbo-progs		bug: 59654	change-id: i497fc91482f0e73d426c19fca58f60c74cfe980b	|tools: install requested packages		bug: 54690	bug: 59083	change-id: if8d24dfc8966779f8d3d3db6c17e8015b4f7ad3a	|tool labs: package installs		bug: 58785	bug: 58744	change-id: i142d47b278131df3a7a3ac739be6e034498a6be9	|tool labs: fix he locale		replace obsolete ""iw"" with correct ""he""		bug: 58500	change-id: id14d376b4ec496a64415fc452798347779691706	|tool labs: package installation round		bug: 58649	bug: 58516	bug: 58500	change-id: ibeff54cf925ce035591636862d9a81f7f2c3fa2b	|tool labs: add a couple requested packages		bug: 58220	bug: 55652	change-id: i52717f5da7c468e6693df80a63124a6048e76738	|tool labs: install doxygen{"	"-latex}		bug: 56326	change-id: id14e1c0d4d644b47d1f0cd8c594a14983a31496a	|tool labs: install djvulibre support		bug: 56972	change-id: ib32f53d3850a2043b85cc9f636f0e4724c04b929	|tool labs: multiple dependencies installed		bug: 57000	bug: 57001	bug: 57002	bug: 57003	bug: 57118	change-id: i065482ce37fd44a0df30dc67f1007065a631414d	|tool labs: install libhtml-template-perl		bug: 57123	change-id: i3310e56fb5d32a65d7c8d65c1a1c16673374b7c8	|tool labs: install ufraw-batch		bug: 57008	change-id: i42fe9168eece31545423a9757e5daf86e31e94fd	|tool labs: install rrdtool		bug: 57004	change-id: icf5c2be75d6442aed81bfadea72be27d583cc86c	|tool labs: install socat to exec environment		bug: 57005	change-id: i0f8c1e7040bae41f9176581cf79750c14a209a71	|toollabs: install graphviz		bug: 54478	change-id: ie17f257f52a578bc82f285e5bdf376b4bf97fd23	|tool labs: dependencies for bz 56996		bug: 56996	change-id: i6fecf617555b140288127162dd5b63ccbe0d0eaa	|tool labs: import many dependencies from ts's jira		bug: 56994	bug: 56995	change-id: i7eaf60abad202d815c2cad846c92f02121d480ef	|add php5-sqlite package to toollabs instances.		bug: 54043	change-id: id0c258fc952c77a4b37787e8bd61a5582fd03d17	|tool labs: packages libdmtx0a"	" libdmtx-dev		bug: 53867	change-id: ice3ad0e09f12325b6f5399691e60ac743e4679c9	|tool labs: package libimage-exiftool-perl		bug: 53868	change-id: i2ce19423c7075128fcc098056b62dabb7e91ca65	|tool labs: package poppler-utils		bug: 53869	change-id: i194555f5ac01b2540760b3e0f225e1f88849cdb6	|tool labs: package libav-tools		bug: 53870	change-id: i5e6eefd0ce44a3ff7cf4050514a368f61aafc03d	|tool labs: package fabric		bug: 54135	change-id: i391cea6b4ed3fe581a491f524c69f311a85fd520	|tool labs: opencv (and python bindings to same)		bug: 53625	change-id: ifbfd0cbcd2c009e9989b213557d67491c27a8d99	|tool labs: user-requested perl packages		with uri::encode installed as the supported alternative to	uri::escape.		bug: 53694	change-id: if0b0ef001f3bb1efd1d3c41f2c19580bfc9183d3	|tool labs: boost for python		bug: 53627	change-id: i1e50b981867faf2751fdea173f0e400c85a2b9e6	|tool labs: package python-rsvg		bug: 53626	change-id: if43a379274a0228b0345209c4c9f4fb0f9617aa8	|tool labs: package python-scipy		bug: 53624	change-id: i68e1ea44da294bd4f6b67abff2b527d9433f5fb4	|tool labs: add ipc::run to exec environment		bug: 53532	change-id: i0be89f259eb3049c92a119301402e0aeb735b99b	|tool labs: move dev packages to dev_environ		bug: 52717	change-id: i3dbc164cda28b95a8a0d54e8589755b9b2256aea	|tools: add python-beautifulsoup to exec_environ		this resolves bug #53072.		bug: 53072	change-id: iace9084770311f408c531ee1e2ca2b057f1ea81e	|add vips / tiff packages to toollabs exec_environ		bug: 52717	change-id: i49885a989c02b7ae82ef681d5b4dbe19a29dc8f9	|tool labs: add more user requested packages to exec_environ.		bug: 48805	bug: 48862	bug: 48863	change-id: i10a5e31bb287077356931f12ab11bc59c31671cb	|tool labs: add libstring-shellquote-perl to exec_environ.		bug: 48334	change-id: ic4554b8526dbc4f29651d7f1eb4d3cb07a4505b3	|ssh keystore for toollabs class		- bugfix: toollabs::master doesn't take a gridmaster arg		change-id: i0c63cd970acf33ab26a45ee261434bc7c710aa80	|"																																																																																																																																																																																																																																																																																																																																									
"toollabs: add script to generate python package listings		because the specific packages available on different releases	differs between python 2 and 3 /and/ between releases"	" generating	the list based on the published package lists is the easiest way	to provide a 'best-effort' set of available packages.		genpp/python*.pp is generated by running genpp/python.py. the	generated files are included in git because a) puppet expects puppet	files"	" and b) this allows human review of the generated files.		report-python.html is the auto-generated report of installed packages		bug: t101646	change-id: i31b2986d9b8f910f9c03ddde13696ae58011b65d	|"																																																																																																																																																																																																																																																																																																																																																																	
"toollabs: add script to generate python package listings		because the specific packages available on different releases	differs between python 2 and 3 /and/ between releases"	" generating	the list based on the published package lists is the easiest way	to provide a 'best-effort' set of available packages.		genpp/python*.pp is generated by running genpp/python.py. the	generated files are included in git because a) puppet expects puppet	files"	" and b) this allows human review of the generated files.		report-python.html is the auto-generated report of installed packages		bug: t101646	change-id: i31b2986d9b8f910f9c03ddde13696ae58011b65d	|"																																																																																																																																																																																																																																																																																																																																																																	
"toollabs: add script to generate python package listings		because the specific packages available on different releases	differs between python 2 and 3 /and/ between releases"	" generating	the list based on the published package lists is the easiest way	to provide a 'best-effort' set of available packages.		genpp/python*.pp is generated by running genpp/python.py. the	generated files are included in git because a) puppet expects puppet	files"	" and b) this allows human review of the generated files.		report-python.html is the auto-generated report of installed packages		bug: t101646	change-id: i31b2986d9b8f910f9c03ddde13696ae58011b65d	|"																																																																																																																																																																																																																																																																																																																																																																	
"tools: add python-requests-oauthlib package		bug: t130529	change-id: i90fc08fa302969bfff3d7e921568af4debc2af00	|toollabs: install hunspell"	 python*-hunspell	" hunspell-dictionary to exec nodes		hunspell"	 hunspell-dictionary are available on {precise	 trusty	 jessie}	"	but python*-hunspell is only available on {trusty"	" jessie}.		requested on irc by reza1615 for their tool		bug: t123192	change-id: i3347bb0eddee00ea70d8f1f0509c196488c3a472	|toollabs: add python-pil		bug: 108210	change-id: i6a79b3ba357081fb36e9ebfd62c0addc6a7edc85	|toollabs: add python-enum34		bug: t111602	change-id: i70dbd78a01bccea539180acea28e6522aa0c972f	|toollabs: add python-pyicu		bug: t102165	change-id: i03b516f1401866b219ba59c71205423cf536e5bc	|toollabs: add script to generate python package listings		because the specific packages available on different releases	differs between python 2 and 3 /and/ between releases"	" generating	the list based on the published package lists is the easiest way	to provide a 'best-effort' set of available packages.		genpp/python*.pp is generated by running genpp/python.py. the	generated files are included in git because a) puppet expects puppet	files"	" and b) this allows human review of the generated files.		report-python.html is the auto-generated report of installed packages		bug: t101646	change-id: i31b2986d9b8f910f9c03ddde13696ae58011b65d	|"																																																																																																																																																																																																																																																																																																																																																										
"tools: add python-requests-oauthlib package		bug: t130529	change-id: i90fc08fa302969bfff3d7e921568af4debc2af00	|toollabs: install hunspell"	 python*-hunspell	" hunspell-dictionary to exec nodes		hunspell"	 hunspell-dictionary are available on {precise	 trusty	 jessie}	"	but python*-hunspell is only available on {trusty"	" jessie}.		requested on irc by reza1615 for their tool		bug: t123192	change-id: i3347bb0eddee00ea70d8f1f0509c196488c3a472	|toollabs: add python-pil		bug: 108210	change-id: i6a79b3ba357081fb36e9ebfd62c0addc6a7edc85	|toollabs: add python-enum34		bug: t111602	change-id: i70dbd78a01bccea539180acea28e6522aa0c972f	|toollabs: add python-pyicu		bug: t102165	change-id: i03b516f1401866b219ba59c71205423cf536e5bc	|toollabs: add script to generate python package listings		because the specific packages available on different releases	differs between python 2 and 3 /and/ between releases"	" generating	the list based on the published package lists is the easiest way	to provide a 'best-effort' set of available packages.		genpp/python*.pp is generated by running genpp/python.py. the	generated files are included in git because a) puppet expects puppet	files"	" and b) this allows human review of the generated files.		report-python.html is the auto-generated report of installed packages		bug: t101646	change-id: i31b2986d9b8f910f9c03ddde13696ae58011b65d	|"																																																																																																																																																																																																																																																																																																																																																										
"tools: add python-requests-oauthlib package		bug: t130529	change-id: i90fc08fa302969bfff3d7e921568af4debc2af00	|toollabs: install hunspell"	 python*-hunspell	" hunspell-dictionary to exec nodes		hunspell"	 hunspell-dictionary are available on {precise	 trusty	 jessie}	"	but python*-hunspell is only available on {trusty"	" jessie}.		requested on irc by reza1615 for their tool		bug: t123192	change-id: i3347bb0eddee00ea70d8f1f0509c196488c3a472	|toollabs: add python-pil		bug: 108210	change-id: i6a79b3ba357081fb36e9ebfd62c0addc6a7edc85	|toollabs: add python-enum34		bug: t111602	change-id: i70dbd78a01bccea539180acea28e6522aa0c972f	|toollabs: add python-pyicu		bug: t102165	change-id: i03b516f1401866b219ba59c71205423cf536e5bc	|toollabs: add script to generate python package listings		because the specific packages available on different releases	differs between python 2 and 3 /and/ between releases"	" generating	the list based on the published package lists is the easiest way	to provide a 'best-effort' set of available packages.		genpp/python*.pp is generated by running genpp/python.py. the	generated files are included in git because a) puppet expects puppet	files"	" and b) this allows human review of the generated files.		report-python.html is the auto-generated report of installed packages		bug: t101646	change-id: i31b2986d9b8f910f9c03ddde13696ae58011b65d	|"																																																																																																																																																																																																																																																																																																																																																										
"add a new security module with ::pam and ::access		this helps clean up security configuration mostly in labs right	now"	" but provides general-use classes and defines to customize	pam configuration cleanly (including access.conf handling)		bug: t120106	change-id: id0183e2bc677c6d4893aeb2956c3e3650b174da6	|"																																																																																																																																																																																																																																																																																																																																																																		
"add a new security module with ::pam and ::access		this helps clean up security configuration mostly in labs right	now"	" but provides general-use classes and defines to customize	pam configuration cleanly (including access.conf handling)		bug: t120106	change-id: id0183e2bc677c6d4893aeb2956c3e3650b174da6	|tools: rename references to local-admin to tools.admin		bug: 62961	change-id: i75c30a00f9e75626c1ae30accf40c4f8c145d66c	|"																																																																																																																																																																																																																																																																																																																																																																		
"toollabs: set nano as default editor		bug: t100526	change-id: i637a83ed52fcfbe1ac0f203fdaff69d5e289df5f	|tools: fix puppet error		bug: t128411	change-id: ic690c3b898c607ee3d278fb3c1c8bef3c877535b	|tools: add simple command to log tool invocations		will be called from webservice"	 jsub	" etc		bug: t123444	change-id: ib39b3f69d46b2b0b8e504df5872c99b91bcd761a	|tools: replace references to tools.wmflabs.org		bug: t87387	change-id: i6efa8ffdcf407d98a10baeca7193af1b90e53610	|tools: migrate from labsdebrepo to aptly		currently"	" project-local packages are pulled from the file system	repositories at /data/project/.system/deb-{jessie"	precise	"trusty}	declared by labsdebrepo as well as from the aptly server on	tools-services-01 declared by wikitech hiera entries.  this means that	additions and deletions of project-local packages need to be done in	two places.		this change decommissions the file system repositories. aptly is set	up via hiera in hiera:tools on wikitech"	" so that it is on all	instances in the tools project rather than just the instances in	which the toollabs base class is included.		bug: t111708	change-id: i23cf08052d2c22215336732d3b65412a6ea32627	|tools: replace reference to tools. in class toollabs		bug: t87387	change-id: i8e173a7bf6886a0b33eccd53439e1e4b28d2b957	|toollabs: allow hba login to all hosts		bug: t104613	change-id: ie510cd32c26743ee83165c097d38535d452cccd5|toollabs: add ecdsa keys to ssh_known_hosts		bug: t103999	original-change-id: i171c36f8d1ead3b664057258f5a86ab2f2d978ce	change-id: i3cfc5a406fc4bb820e7d2e5cee9cd09c850492f6|toollabs: add ecdsa keys to ssh_known_hosts		bug: t103999	change-id: i171c36f8d1ead3b664057258f5a86ab2f2d978ce	|tools: make redis failover-able		gets rid of the separate redis master / slave roles. instead"	"	just apply the redis role to a bunch of hosts and set the master	by setting toollabs::active_redis. this also sets up a host	entry on all toollabs hosts with the ip of the active host.		for failover"	"	  - switch toollabs::active_host via hiera	  - force run puppet on all redis hosts	  - force run puppet on all other toollabs hosts		bug: t99737	change-id: i00a6d4a6d6e5dd8bc9b6cd39e8ae53651ded46d4	|tools: puppetize database aliases as host resources		bug: t63897	change-id: i14b8b4a691f82d8eacfbc7cf5fee6d4d739c7a74	|tools: store verbose logrotate logs		this will hopefully help solve the logrotate error mails we receive	every other day. the logrotate log file is overwritten daily.		bug: t96007	change-id: ia0174696349e48cb030f74b1664a94464eb760d6	|tools: store verbose logrotate logs		this will hopefully help solve the logrotate error mails we receive	every other day. the logrotate log file is overwritten daily.		bug: t96007	change-id: i3087a4953f940dfd300ea8714b1ce1a097c85d18	|tools: silence sudo security e-mails		these e-mails are basically useless"	" as we don't use passwords anyway. all	e-mails will therefore just be users running sudo by accident"	" and we're not	interested in those e-mails.		bug: t95882	change-id: ieedda05687a29de56326e9c72395c89b924df1f7	|add local crontab monitoring		bug: t96472	change-id: i6758673ff611a86ed67af23e599e1945227e97fe	|tools: register only with 'active' proxy		this will stop attempting to register with all present proxies	and register only with active proxy. data will be replicated	between the proxies themselves via redis replication.		bug: t96334	change-id: i3a483e03df433ca6938e6e08b54e8b7929b93495	|tools: make list of proxies for portgrabber configurable		bug: t91954	change-id: i83c649e318105d8411630af988ad71576209ae99	|tools: split local apt repository by os release		currently instances running ubuntu precise and ubuntu trusty share the	same local apt repository.  this leads to various unresolvable	dependency conflicts.		with this change"	" each os release gets its own local apt repository	(e. g. /data/project/.system/deb-trusty) so that they can be managed	individually.		bug: t76802	change-id: i8e50efdab45aad5ecfd03a2fbf3a7ac6d8a09810	|tools: use labsdeprepo		bug: t62925	change-id: i168565f61b2af26558becfbceb0dce29b4040ee5	|tools: install at		bug: t72324	change-id: idbda0356da4e8b8a77538fc93a447e3c9074f53d	|ssh keystore for toollabs class		- bugfix: toollabs::master doesn't take a gridmaster arg		change-id: i0c63cd970acf33ab26a45ee261434bc7c710aa80	|"																																																																																																																																																																																																																																																																																																																																																								
"tools: don't set ca explicitly for kube2proxy		bug: t139461	change-id: ie0e48627318fcf45bfe147e47bff1bbd385e48a0	|tools: provision accounts for all tools		maintain-kubeusers does the following:		1. generate accounts for all tools	2. generate abac file granting appropriate access	   to all tools	3. read up infrastructure user config from a different	   file and make sure they are present in final token auth	   file list	4. restart kube-apiserver if needed		this needs to run as root since we're writing to many differnt	users' homedirs"	" so we attempt to limit the damage by whitelisting	capabilities and making most filesystem paths be readonly		bug: t133999	change-id: i7a7a3dd951db2209e820752c4d14d77eb836b929	|dynamicproxy: add support for kubernetes		bug: t111916	change-id: i9821bafc37caaeb39ec7bd751bd76d73401e7ec0	|"																																																																																																																																																																																																																																																																																																																																																																		
"k8s: verify pause container is correct on each build		since we want this to be in our docker repo and use our own	version rather than the one from gcr.io (google's docker repo).	but k8s might upgrade their pause container at some point"	"	and new versions might depend on new version of the container.	so we write in a crude check to verify that the version	has not changed.		bug:	change-id: i4d2607a1c40c388cf17fd4a6885581a6fe714696	|"																																																																																																																																																																																																																																																																																																																																																																		
"tools: remove non-precise fonts from precise hosts		bug: t132282	change-id: ia28a8df8f42c27f050d41b961d4453fa2713e410	|tools: don't track mediawiki's font list for precise		'upstream' (in this case mediawiki module) doesn't support	precise anymore"	" so we probably shouldn't either. copies	the list of fonts to a static separate legacy class so	we don't end up with weird missing fonts on new precise	instances.		bug: t132282	change-id: ice36c77a4ecdb58fd05536b8be296b5cae5e84fb	|"																																																																																																																																																																																																																																																																																																																																																																		
"tools: extended exim diamond collector for tool labs		 - forked and extended existing exim collector	 - extended queue information	 - added paniclog information	 - moved sudo configuration to collector manifest	 - updated tool labs mail relay for new collector		bug: t96898	change-id: i9010886ecac20c94a3916b908910853e26241318	original-change-id: i1d0517e41d61201e7f6c9b85c116f952658f73a3	|extend exim diamond collector for tool labs		 - forked and extended existing exim collector	 - extended queue information	 - added paniclog information	 - moved sudo configuration to collector manifest	 - updated tool labs mail relay for new collector		bug: t96898	change-id: i1d0517e41d61201e7f6c9b85c116f952658f73a3	|toollabs: send exim queue length to graphite		bug: 58871	change-id: ie853f9c279d9458431a5dcb592e169a8e3383ac9	|"																																																																																																																																																																																																																																																																																																																																																																			
"tools: use ldap servers in ha manner for maintain-kubeusers		bug: t142394	change-id: i813efa7903c9a438edc59dfaab88c6beee8df751	|tools: provision accounts for all tools		maintain-kubeusers does the following:		1. generate accounts for all tools	2. generate abac file granting appropriate access	   to all tools	3. read up infrastructure user config from a different	   file and make sure they are present in final token auth	   file list	4. restart kube-apiserver if needed		this needs to run as root since we're writing to many differnt	users' homedirs"	" so we attempt to limit the damage by whitelisting	capabilities and making most filesystem paths be readonly		bug: t133999	change-id: i7a7a3dd951db2209e820752c4d14d77eb836b929	|"																																																																																																																																																																																																																																																																																																																																																																		
"tools: puppetize gridengine complex configuration		bug: t107821	change-id: ie2c7b07efc055ddb6ccbb1c8a2b18244f2684764	|tool labs: add old-style fqdn aliases to nodes		so that gridengine does not get confused by the new instance	naming scheme.  new nodes do not need to be added to this list	since they will be configured within gridengine with the proper	(new) name.		bug: t101296	change-id: idbdc4954e6b26185f92995aef035edae15220eb7	|tools: remove tomcat node definitions from puppet		uses regular generic webservice node now.		bug: t91066	change-id: i6d13d9cc5e8dd6d48aacc246d2f65aa49d90650c	|tools: use labsdeprepo		bug: t62925	change-id: i168565f61b2af26558becfbceb0dce29b4040ee5	|tools: rename references to local-admin to tools.admin		bug: 62961	change-id: i75c30a00f9e75626c1ae30accf40c4f8c145d66c	|"																																																																																																																																																																																																																																																																																																																																																																			
"tools: make main page check in icinga		can be made paging after testing to make sure it works		also move the nfs check to a more appropriate place		bug: t116925	change-id: i35c5bfe8941a509a2c92283e82208868e19e0e87	|"																																																																																																																																																																																																																																																																																																																																																																			
"toollabs:  allow $::node_dedicated_tool to be set from hiera		bug: t101447	change-id: i61133a9c469dc98740bc81e1a866bf72cf1bad43	|toollabs: make sure /tmp and swap are large for all exec hosts		note that this also subtly changes regular exec hosts"	" which did not	include the base toollabs class before.		bug: t118419	change-id: i199bc73eab029829100cad838557e2018e449eb9	|tools: puppetize jobkill		bug: t90331	change-id: i72f165ff6a081d90f3f503eb14529ae4a5518540	|"																																																																																																																																																																																																																																																																																																																																																																		
"toollabs: make sure /tmp and swap are large for all exec hosts		note that this also subtly changes regular exec hosts"	" which did not	include the base toollabs class before.		bug: t118419	change-id: i199bc73eab029829100cad838557e2018e449eb9	|tools: create consistent 3x ram swap on all exec nodes		also introduce labs_lvm::swap define		bug: t95979	change-id: i39d7a6ddb80ce44c9129263ab6f7ae6f6329c5ef	|tools: create separate /tmp lvm volume for all exec nodes		16g /tmp for tools to use as they see fit. some tools do need	as much as this because they work with large images"	" etc. also	we are using qcow2 images so the disk space isn't used until it	is needed. also"	" these instances should all be xlarge or large	so 16g for /tmp is ok.		bug: t97445	change-id: i8c45f5572db0b65391a95b92ddaacc30d79de969	|tools: puppetize jobkill		bug: t90331	change-id: i72f165ff6a081d90f3f503eb14529ae4a5518540	|"																																																																																																																																																																																																																																																																																																																																																																
"toollabs: make sure /tmp and swap are large for all exec hosts		note that this also subtly changes regular exec hosts"	" which did not	include the base toollabs class before.		bug: t118419	change-id: i199bc73eab029829100cad838557e2018e449eb9	|tools: register only with 'active' proxy		this will stop attempting to register with all present proxies	and register only with active proxy. data will be replicated	between the proxies themselves via redis replication.		bug: t96334	change-id: i3a483e03df433ca6938e6e08b54e8b7929b93495	|tools: separate registration / unregistreation for proxylistener		- clients no longer need to keep a socket open to proxylistener	- have a separate portreleaser that should get called by	  epilog scripts for webservices.		bug: t96059	change-id: iaa85955d9da8f83b89a6eea713286799351208ea	|tools: remove remnants of portgranter code		service can be stopped via salt.		bug: t93046	change-id: i3278d974b378acd2a06e6808bc5297139606612b	|tools: make list of proxies for portgrabber configurable		bug: t91954	change-id: i83c649e318105d8411630af988ad71576209ae99	|tools: ensure that portgranter is running		bug: t93120	change-id: ice4c3b6cbf3e3c63e1ef3270d1bfdc92dd879c7c	|tools: puppetize jobkill		bug: t90331	change-id: i72f165ff6a081d90f3f503eb14529ae4a5518540	|"																																																																																																																																																																																																																																																																																																																																																																		
"tools: remove all webservice related code		is in the toollabs-webservice package now! \o/		portgrabber and friends still exist until we convert	all the older fake 'generic' webservices to the	new setup		bug: t98440	change-id: ib1d00cd5d050007599467201b74ce945ce6952ea	|tools: add uwsgi support to generic webgrid nodes		bug: t91065	change-id: i4433bde6ef99fc065d3127d6e2a89dd2f5e3ccf5	|tools: add tomcat starter & required packages to generic nodes		should be replaced with a 'generic' webservice starter at some	point		bug: t91066	change-id: i237b8f4e16670b57fdec7fefc94631378c685a6e	|tools: move tomcat tools to generic node		bug: t91066	change-id: iee6d26e6f823641b7fee29cd09cbc06cbbaef1ea	|toollabs: add generic webgrid node type		will support push-button deploys of less commonly used languages	(nodejs"	 go	" etc)		bug: t1102	change-id: i2fb17b468f066cab9862b4587c3359126ff6c4af	|"																																																																																																																																																																																																																																																																																																																																																																	
"tools: remove all webservice related code		is in the toollabs-webservice package now! \o/		portgrabber and friends still exist until we convert	all the older fake 'generic' webservices to the	new setup		bug: t98440	change-id: ib1d00cd5d050007599467201b74ce945ce6952ea	|change bz references to phabricator tickets		except in the mediawiki module		bug: t96431	change-id: i6b36e500635537e28520bf5bd61585ff00a41755	|"																																																																																																																																																																																																																																																																																																																																																																			
"tools: track per tool request stats in graphite		bug: t69880	change-id: ie7f35a8946a4ff7cce93396964d2c2042d8017b6	|toollabs: install goaccess on webproxy hosts		for in-place statistics.		bug: t121233	change-id: i00cb07ae840ca631fc71aa4fac0711c77bb7614b	|dynamicproxy: add support for kubernetes		bug: t111916	change-id: i9821bafc37caaeb39ec7bd751bd76d73401e7ec0	|tools: add k8s::webproxy to tools::proxy		just sets up flannel and kube-proxy		bug: t111916	change-id: ic595abd0f4046afa187f8e49a023c640e92b582d	|tools: replace references to tools.wmflabs.org		bug: t87387	change-id: i6efa8ffdcf407d98a10baeca7193af1b90e53610	|tools: setup replication from master to all slave proxies		bug: t96334	change-id: if782d1343a760c5e2f91a514eeb3bfa26bb4de35	|tools: allow redis access between proxies		this allows replication between the redis instances!		bug: t96335	change-id: i2807df8300819b96871c92ae2c56f79da7a8ec39	|tools: enable firewall on webproxies		bug: t96335	change-id: i118fb4871939ddb4c51d8fc99407b089f63fe6c2	|tools: explicitly open port for proxylistener		bug: t96335	change-id: i7da34ffcbb13de1597c36f7186a389ed8bc9f6b3	|tools: ensure that proxylistener service is running		bug: t93121	change-id: idd32ce298d905a79a971631fdd567a8243259de0	|"																																																																																																																																																																																																																																																																																																																																																																			
"tools: add puppetmaster/client roles		- only applied on k8s related nodes	- deny access to all non-admins	- also make gitsync configurable so it can sync the	  puppet repositories more frequently		bug: t112005	change-id: i23e64a138a287fa1e69b4d2ce894cf95f1c22592	|"																																																																																																																																																																																																																																																																																																																																																																			
"toollabs: re-enable redis collector		bug: t142735	change-id: i22a30c33d7c9c3bba62d96a29f55d052ac11f7b8	|tools: make redis failover-able		gets rid of the separate redis master / slave roles. instead"	"	just apply the redis role to a bunch of hosts and set the master	by setting toollabs::active_redis. this also sets up a host	entry on all toollabs hosts with the ip of the active host.		for failover"	"	  - switch toollabs::active_host via hiera	  - force run puppet on all redis hosts	  - force run puppet on all other toollabs hosts		bug: t99737	change-id: i00a6d4a6d6e5dd8bc9b6cd39e8ae53651ded46d4	|tools: add redis slave role		bug: t91239	change-id: i7e0beafbcd398df98c2e73f0a9efd0525adff9bc	|"																																																																																																																																																																																																																																																																																																																																																																	
"diamond: sge stats run from the services hosts		bug: t140999		change-id: ic068c5c60c79a4b187553f65f511a38b39d74bb1	|tools: switch to newer webservice comand		yay!		bug: t98440	change-id: ie1434e592b1d539f3768b36dd56ac69671af8692	|tools: add switchover / hot standby capability to tools services		if tools-services-01 goes down"	" we can make tools-services-02	active by:	    1. setting the active_host parameter for the role via hiera	    2. forcing a puppet run		both these steps can be done by any tools admin.		bug: t95521	change-id: i58e07ceffe2ffaf5e5baf7b567f87a2c6ab43718	|tools: make toollabs::services inherit from toollabs		bug: t95210	change-id: i0d6055fcaf67ffc6121417ba1ecb837b42568329	|tools: make services host a submit host		also put webservice file on such hosts		bug: t95210	change-id: i827ce872a62dfe6d887acd90b2e91007ebc5dee0	|tools: add role / class for tools manifest services		bug: t95210	change-id: id56b57cce1247b529d3d903a3ae937a6f568c600	|"																																																																																																																																																																																																																																																																																																																																																																		
"tools: remove exec_environ from shadow		bug: t100662	change-id: i93ed9af3ae5c259fbd00af15fe6f88875341c51d	|"																																																																																																																																																																																																																																																																																																																																																																			
"toollabs: convert cdnjs pull cron command to one line		cron commands cannot span over multiple lines		bug: t143637	change-id: i70fee0ec375e3cd6207248bf518a834bb9c57789	|toollabs: remove puppet dependencies on git clone cdnjs		bug: t134896	change-id: i9f182f55db42b177e2fbadcd45a8888a603f3f6d	|toollabs: convert puppet clone of cdnjs to cron		bug: t143637	change-id: iacaac250f9f641b5981ca366c90f731802170eec	|tools: generate packages.json for cdnjs		bug: t96799	change-id: icbe92ef557c5df7afb575c5eb761ecde21694ba1	|tools: setup a cdnjs mirror		bug: t96799	change-id: i2bf7babe86ad5c2bec62310f1a1593858cfd86af	|toollabs: add class and role for static file server		bug: t84982	change-id: i189e488eb98987f4394884dd01ab57709b032345	|"																																																																																																																																																																																																																																																																																																																																																																			
"toollabs: move updatetools to run on services host		bug: t123873	change-id: if61dab96f84edc78839ff3deff22b6082163538f	|"																																																																																																																																																																																																																																																																																																																																																																			
"toolserver: add wiki. and stable. le certs		'wiki' has been requested for t62220 and on t134798.		i added the apache server alias in ic4b78967545de0f14.		to make it match the server aliases i'm adding stable.	as well"	 it existed before	" but only in the *:80 vhost.		bug:t62220	bug:t134798		change-id: i4fcdb516f3af3714033b5fc49e9d5d41fab1ba4b	|toolserver.org: break puppet dependency cycle		error: could not apply complete catalog: found 1 dependency cycle:		(exec[acme-setup-acme-toolserver] => letsencrypt::cert::integrated[toolserver]	=> apache::site[www.toolserver.org] => apache::conf[www.toolserver.org] =>	file[/etc/apache2/sites-available/50-www-toolserver-org.conf] =>	service[apache2] => exec[acme-setup-acme-toolserver])		bug:t134798	change-id: iafd0da512b2bee7a70b128b3da459e91e5673d12	|toolserver.org: adjust puppet dependencies for cert change		after i7d18024b7f1470:		could not find dependency sslcert::certificate[toolserver.org]		bug:t134798	change-id: ieb532940a37f587f712d6977bd621ae078e124c7	|add letsencrypt cert/config for (www.)toolserver.org		the current toolserver.org cert will expire soon.	we would like to use letsencrypt for this instead	of spending money on a new cert.		this is modeled after the setup in the rt role and module	which was used as the initial test case.		bug:t134798	change-id: i7d18024b7f1470dfd256aade4ec7caf8e8e9f782	|create toolserver_legacy module		this is used for relic.toolserver_legacy.eqiad.wmflabs		also fixes relay issues that were squished by the new default	mail configuration.		bug: t114102	change-id: i7e02223191a31a0c39f5d63824fc7d8ecd1c3652	|"																																																																																																																																																																																																																																																																																																																																																																	
"torrus: add protocol redirect		now that torrus moved behind misc-web"	" add the snippet	for http->https proto redirect when being a backend.		also need to load mod_headers for this.		bug:t119582	change-id: i3d3318ebc03b157515dd6f893c62a35c3596fa82	|torrus: move to apache::site		bug: t118786	change-id: i50c5fea5e3fe502459cfc9deeee1f2eac68ec523	|"																																																																																																																																																																																																																																																																																																																																																																		
rm cp1043	cp1044 from site	" installserver & torrus		these servers were already marked for decom for a while.		this removes them from puppet"	" installserver and also	the torrus config which still had them for a test cdn setup.		bug:t133614	change-id: i71c398ee2595321bef392a45cbc03f81db2513be	|"																																																																																																																																																																																																																																																																																																																																																																
"role::deployment: make it possible to switch between different servers		bug: t124024	change-id: i33311b76728a6aa9df7d87500b6b3fc90a11a033	|"																																																																																																																																																																																																																																																																																																																																																																			
add udp2log module	" make role::logging::mediawiki use it		bug: t122058	change-id: ie736c25c84fe66e0005a27a93b15c79c8c6ea1c5	|"																																																																																																																																																																																																																																																																																																																																																																		
"use hiera for udp2log-mw logrotate count		for the deployment-prep project"	" there isn't enough diskspace to keep	1000 compressed logfiles.		this creates a hiera variable so that a rotate count can be set on a	per-project basis.		bug: t140313	change-id: i292936c91d539d6791fa63a1d87e282b0350594f	|add udp2log module"	" make role::logging::mediawiki use it		bug: t122058	change-id: ie736c25c84fe66e0005a27a93b15c79c8c6ea1c5	|"																																																																																																																																																																																																																																																																																																																																																																	
add udp2log module	" make role::logging::mediawiki use it		bug: t122058	change-id: ie736c25c84fe66e0005a27a93b15c79c8c6ea1c5	|"																																																																																																																																																																																																																																																																																																																																																																		
add udp2log module	" make role::logging::mediawiki use it		bug: t122058	change-id: ie736c25c84fe66e0005a27a93b15c79c8c6ea1c5	|"																																																																																																																																																																																																																																																																																																																																																																		
add udp2log module	" make role::logging::mediawiki use it		bug: t122058	change-id: ie736c25c84fe66e0005a27a93b15c79c8c6ea1c5	|"																																																																																																																																																																																																																																																																																																																																																																		
"uwsgi: restart daemon when config changes properly		the subscribe was on a symlink earlier"	" which prevented it	from actally restarting when the real config changed.		bug: t123438	change-id: i45818969a35d3683951d441ddce038ce04692dd3	|"																																																																																																																																																																																																																																																																																																																																																																		
"uwsgi: stop the distro provided service properly		bug: t124621	change-id: i648266785adb2e49187fb5c66115fe15bf57c7e4	|uwsgi: don't declare uwsgi-startup service		base::service_unit by default turns ensure => 'present' into ensure =>	'running' for the underlying service. the magic incantation to use is	declare_service => false.		bug: t127684	change-id: ia50b7d08a4e8e533166bc7b1a067beface07bef6	|"																																																																																																																																																																																																																																																																																																																																																																			
"vagrant-lxc: update sudoer rules for v1.2.0+		the vagrant-lxc plugin changed behavior in version 1.2.0 to use	/usr/bin/env to locate binaries rather than hard coding full paths in	the sudo commands needed to setup and maintain the lxc container. add	a duplicate set of sudoer rules that work for this newer version of the	plugin.		bug: t115080	change-id: i0fe2616288845d2d4ba1b859fef5a9647725f1d4	|vagrant-lxc: fix sudo rule for finding lcx command paths		bug: t115080	change-id: id5212f5837835bd7332f6913ad60b5463843258d	|"																																																																																																																																																																																																																																																																																																																																																																			
"vagrant: add upstart script to start container on boot		add an upstart script that will look for an existing mediawiki-vagrant	lxc container and start it if found.		bug: t127129	change-id: icf4cad56770cb992a1c6937c60c8976d5d9328b9	|vagrant: set umask 0002 for wikidev users		make shared ownership and management of files in /srv/mediawiki-vagrant	easier by setting the default umask for wikidev users to 0002.		bug: t120472	change-id: i1fec88f5dca2312213b40995ebc7aebf67e22d63	|vagarnt::mediawiki: ensure clone before adding config		ensure that the full clone of mediawiki-vagrant into	/srv/mediawiki-vagrant is done before provisioning the .settings.yaml	file into it. if puppet is not explicitly told this ordering it could	provision the .settings.yaml file after creating the directory but	before calling git-clone. when that ordering happens git-clone will fail	due to the directory being non-empty.		bug: t115229	change-id: i0555585c000b261b4ee3e282414b9c57f2c4276c	|"																																																																																																																																																																																																																																																																																																																																																																			
"move varnishkafka apt pinning to role definition		we want to make sure the pinning file for varnishkafka on varnish 3	instances is present before the package is installed.		bug: t122880	change-id: ia9a5a334dad27a9cd915139b477adcc3fe403546	|apt_preferences for v3/v4 varnish packages		we are going to use 'experimental' as the apt component for varnish 4	and v4-compatible varnishkafka"	" and we want to make sure that on v3	machines v4 packages are not pulled in because of an apt-upgrade.		this patch installs two apt preferences fragments for varnish and	varnishkafka giving higher priority to v3 versions on hosts where the	varnish_version4 hiera attribute is not set. the fragments are removed	if varnish_version4 is set.		bug: t122880	change-id: iadc942017a6e7f3b4f956e30298bc58b29bb80a9	|"																																																																																																																																																																																																																																																																																																																																																																		
"port varnishprocessor to new vsl api		bug: t131353	change-id: ife9d80c67ed91b6c247b438ab04a4eff2d773973	|port varnishlog to new vsl api		varnishlog4 allows to register a callback to be invoked for every vsl	entry matching certain filters"	" using the same api as varnishlog.		the module uses python-varnishapi:	https://github.com/xcir/python-varnishapi		bug: t128788	change-id: iaf6655754e16181d2bf42a949d87fd82fbf15ad2	|base: move mysterious_sysctl from webserver		also webserver module is dead!		bug: t118786	bug: t118812	change-id: i53743262fd1413fae79cd6e2b3d7cc1f3d4e3628	|"																																																																																																																																																																																																																																																																																																																																																																		
"varnish: add generation of the dynamic list of directors		for all 2-layer cache frontends"	 and for the tier-2 backends as well	" we	need to be able to depool backends syncronously with depooling happening	in pybal"	" so that any maintenance activity can proceed.		for now"	 we just add a confd::file define (which is opt-in	" with a hiera	variable) that allows doing that.		bug: t97975	change-id: i78f0a2afb319712c150c0d5c69b32e1b6c2905fe	|"																																																																																																																																																																																																																																																																																																																																																														
"v::c::directors: fix select compat for ruby 1.8 here as well...		bug: t127481	change-id: ie437b06af960b6a0a9f2fdd0b0b27ee0976e5b06	|v::c::directors: filter keyspaces on dynamic==yes		currently"	" dynamic directors are only used at all when all	directors are dynamic"	" so this bug wasn't apparent.  with future	changes"	" there will be varnish instances with mixed dynamic and	non-dynamic directors"	" so we need this filter to avoid configuring	invalid keyspaces for the non-dynamic ones.  note that the	directors template already filtered on this"	" too.		bug: t127481	change-id: i4d82a0e175a3e590ee5e82c4cbd997cc6ec19aa4	|bugfix: missing } in d37a3550		bug: t127481	change-id: ie0bda64eb9d8395190a7c5ce1bcd452caab69034	|update varnish directors for full instance names		bug: t119396	change-id: i5f7b095e309c7e49c0f8950a88827363e63696cd	|varnish: actually use the dynamic directors list		bug: t97975	change-id: ib0a363bfbe44ae526fb1bd2bba12b4e41830a68d	|varnish: add generation of the dynamic list of directors		for all 2-layer cache frontends"	 and for the tier-2 backends as well	" we	need to be able to depool backends syncronously with depooling happening	in pybal"	" so that any maintenance activity can proceed.		for now"	 we just add a confd::file define (which is opt-in	" with a hiera	variable) that allows doing that.		bug: t97975	change-id: i78f0a2afb319712c150c0d5c69b32e1b6c2905fe	|"																																																																																																																																																																																																																																																																																																																																																									
"cache_upload vtc tests		vtc test cases for cache_upload"	" compatible with both varnish v3 and v4.		this commit also introduces a new executable called varnishtest-runner"	"	which passes varnish-version-specific macros to varnishtest.		bug: t128188	change-id: i653502c2b7ce0e370754ff8acfeaec81a13842f4	|fix ownership of vtc tests directory		bug: t128188	change-id: i22afe7cce21ec98018ad23c09f9c04a525ce2753	|maps vcl forward-port to varnish 4		this patch uses a boolean hiera attribute"	 varnish_version4	" to	distinguish between varnish 3 and varnish 4 vcl syntax.		with these changes applied"	" varnish 4 starts properly on machines	deployed with role cache::maps.		bug: t124279	change-id: iee05d5f712093c0a1d939e74a340627982979404	|add basic support for varnishtest		add wikimedia-common_${vcl}.vcl and wikimedia_${vcl}.vcl under	/usr/share/varnish/tests to allow running vtc tests.		bug: t128188	change-id: i76c38e3b47817388dab67ff6370f7c8eaa9ba862	|move all x-analytics code to analytics.inc"	" include in common vcl		all clusters should now emit the same x-analytics data (all of the	fields currently defined"	 previously only for text and/or mobile)	"	which is lumped together in analytics.inc.vcl.erb and included	from the primary common vcl file.		bug: t89177	bug: t96847	bug: t109286	change-id: i1a9534a663304ff69e2368234fbe746c55fb7a42	|replace static-hash with hostname normalization		this gets rid of the vcl_hash hack to ignore hostnames in requests	for /static paths"	" and replaces it with hostname-normalization to	""www.wikimedia.org"" in vcl_recv (before hashing occurs).	critically"	" this must be after redirect-rewrites such as	mobile_redirect.		bug: t104532	change-id: ie3ef27739edc7471e77b58364d50ee36c49b7543	|de-dupe /static hashing for text/mobile		bug: t95448		change-id: ie7b742cd8aa3722f61be97bd29e023590b4264d2	|adding a last-access cookie to text and mobile requests		please take a look for details as to what we want to accomplish here:	https://wikitech.wikimedia.org/wiki/analytics/unique_clients/last_visit_solution		bug: t88813	bug: t92435	change-id: iea4ceb2fb06929ced5b27b1d9c7d8951a87fca8b	|"																																																																																																																																																																																																																																																																																																																																																									
"vhtcpd: use port 3127 for fe		bug: t107236	change-id: i554f4fdead813c29b1495e4594e85c4ef45e216b	|cache_mobile decom: 2/2 remove most cache config		after this we can manually stop various daemons on these hosts and	leave them idle (but still configured with ""standard"") for a few	days until they're re-purposed.		bug: t109286	change-id: i51354c8abc76c480146f61210cb4f8f55e889a7d	|vhtcpd: refac args template"	" allow multiple mc addrs		bug: t116752	change-id: icc0497e2fe8330ed5a451ecc384bd78e719816e0	|varnish_instances: qualify var		bug: t97251	change-id: ie7156c7519ecdd2fb92f2ef8627ccd45bfca5e5a	|"																																																																																																																																																																																																																																																																																																																																																																		
"cache_upload vcl forward port to varnish 4		bug: t131502	change-id: i72627d1015099b8f59a05e23b14ee095be7e65e4	|support optional keepalives and websockets for v4 only		the websockets part requires the request buffering disable in the	earlier commit"	" i think.		bug: t134870	change-id: id31596760ee24b14ba93289b489f4529ad1853fa	|varnish: jemalloc tuning for frontend caches		this should reduce the virtual and resident waste/overhead when	configuring frontend malloc storage with large fractions of total	memory.  note that the chunk size could probably use further	tuning per-cluster"	" but the values in this patch are reasonable	conservative estimates from some basic experimentation/research.		bug: t135384	change-id: ie0bdcbf6a0290b76131a6a43c3013d72b653100f	|maps vcl forward-port to varnish 4		this patch uses a boolean hiera attribute"	 varnish_version4	" to	distinguish between varnish 3 and varnish 4 vcl syntax.		with these changes applied"	" varnish 4 starts properly on machines	deployed with role cache::maps.		bug: t124279	change-id: iee05d5f712093c0a1d939e74a340627982979404	|do not use dynamic directors in test vcl code		bug: t128188	change-id: ic9501637db341d8ca03aa56ea02ff85eda2d432d	|add basic support for varnishtest		add wikimedia-common_${vcl}.vcl and wikimedia_${vcl}.vcl under	/usr/share/varnish/tests to allow running vtc tests.		bug: t128188	change-id: i76c38e3b47817388dab67ff6370f7c8eaa9ba862	|vcl: move layer from vcl_config to instance param		bug: t127481	change-id: ic4baa6640aa11bd4aed5b15fd676bd6c24761c89	|eventlogging"	" varnish: fix last 2 quoting warnings		these are the last 2 lint warnings of the type	""double quoted string containing no variable""	across the entire repo (except submodule cassandra).		for eventlogging i actually replace the quotes"	" for varnish	i just make lint ignore it.		after fixing these we can re-enable that particular lint check.		bug:t93645	change-id: ic834d12574d5d5eb04c9701c83c8250451f7d693	|varnish: refactor instance parameters (no-op)		switches ""port"" scalar to ""ports"" array"	" and then removes the	""varnish_"" prefixes on related variables that have been fixme for	a while.		bug: t119396	change-id: i9bd3cfdf9a0834f5ce1a1085c9b867349487bf2a	|varnish: add lint:ignore:quoted_booleans around a boolean that needs quoting.		bug: t113783	change-id: icbe2be0235038b40c2584f221ae23a90c1a2ecb6	|varnish: default dynamic_directors true (changes eqiad)		bug: t97029	change-id: i3bfd4bc89f97d3a8604121eeae5b403a9a96a3ef	|varnish: actually use the dynamic directors list		bug: t97975	change-id: ib0a363bfbe44ae526fb1bd2bba12b4e41830a68d	|varnish: add generation of the dynamic list of directors		for all 2-layer cache frontends"	 and for the tier-2 backends as well	" we	need to be able to depool backends syncronously with depooling happening	in pybal"	" so that any maintenance activity can proceed.		for now"	 we just add a confd::file define (which is opt-in	" with a hiera	variable) that allows doing that.		bug: t97975	change-id: i78f0a2afb319712c150c0d5c69b32e1b6c2905fe	|typo bugfix for 1299cf4f		change-id: ie794a4deb28a9511ebfea387b5b19bdb9b5a1e36	|varnish: make varnish::instance not depend on ganglia		we may have situations where we don't have either ganglia or gmond"	" so	we don't want to have varnish::instance depend on it; also"	" the new	syntax using the spaceship operator and tags should be easier to read	and maintain. this is a prerequisite to fix bug #73263		change-id: i6ebf100e64cb432bb073831131c6be62dfac5695	signed-off-by: giuseppe lavagetto <glavagetto@wikimedia.org>	|"																																																																																																																																																																																																																																																																																																																																																				
"port varnishmedia to new vsl api		bug: t131353	change-id: i7c502f6f1919353a8a6695acf16f5c58eb444ead	|add icinga monitoring for varnish statistics daemons		this patch doesn't register a check for the ""varnish"" process	itself as it there are already http probes defined.		bug: t131760	change-id: i3e97dee81ef304578e1abfec5180bfa1f64a70fd	|send image varnish frontend data from logs to statsd		this is a modified version of varnishrls for varnish thumbnail access stats		bug: t105681	change-id: iae36f1916f28d568c5a9c76f07c55699a092b63c	|"																																																																																																																																																																																																																																																																																																																																																																			
"add icinga monitoring for varnish statistics daemons		this patch doesn't register a check for the ""varnish"" process	itself as it there are already http probes defined.		bug: t131760	change-id: i3e97dee81ef304578e1abfec5180bfa1f64a70fd	|port varnishreqstats and varnishstatsd to new vsl api		bug: t128788	change-id: i1b3bd3e21413ee633f7ee113d641ed8a9d407603	|the varnish reqstats diamond collector does not work"	" emit to statsd directly instead		this also adds a main statsd hiera variable for general use.		bug: t83580	change-id: ife12f04c2b12f582a2338cc5791de1e75ef9114a	|"																																																																																																																																																																																																																																																																																																																																																																		
"add icinga monitoring for varnish statistics daemons		this patch doesn't register a check for the ""varnish"" process	itself as it there are already http probes defined.		bug: t131760	change-id: i3e97dee81ef304578e1abfec5180bfa1f64a70fd	|"																																																																																																																																																																																																																																																																																																																																																																			
"add icinga monitoring for varnish statistics daemons		this patch doesn't register a check for the ""varnish"" process	itself as it there are already http probes defined.		bug: t131760	change-id: i3e97dee81ef304578e1abfec5180bfa1f64a70fd	|port varnishreqstats and varnishstatsd to new vsl api		bug: t128788	change-id: i1b3bd3e21413ee633f7ee113d641ed8a9d407603	|"																																																																																																																																																																																																																																																																																																																																																																			
"port varnishxcps to new vsl api		bug: t131353	change-id: i157ec0bcaf77625526410170a5a56a41c3317d42	|add icinga monitoring for varnish statistics daemons		this patch doesn't register a check for the ""varnish"" process	itself as it there are already http probes defined.		bug: t131760	change-id: i3e97dee81ef304578e1abfec5180bfa1f64a70fd	|"																																																																																																																																																																																																																																																																																																																																																																			
"varnish: make varnish::instance not depend on ganglia		we may have situations where we don't have either ganglia or gmond"	" so	we don't want to have varnish::instance depend on it; also"	" the new	syntax using the spaceship operator and tags should be easier to read	and maintain. this is a prerequisite to fix bug #73263		change-id: i6ebf100e64cb432bb073831131c6be62dfac5695	signed-off-by: giuseppe lavagetto <glavagetto@wikimedia.org>	|"																																																																																																																																																																																																																																																																																																																																																																	
"add ganglia monitoring for vhtcpd.		monitor vhtcpd's internal statistics to help spot trends and possible issues	with cache purge requests. see [[bugzilla:43449#c14]].		- gmond monitoring script that reads from /tmp/vhtcpd.stats	- vhtcpd.pyconf	- new puppet class varnish::monitoring::ganglia::vhtcpd	- apply puppet class wherever varnish::htcppurger is used		bug: 43449	change-id: i1f581a94dae5e16353060d3b49f5fe411854e77a	|"																																																																																																																																																																																																																																																																																																																																																																			
"varnish: refactor instance parameters (no-op)		switches ""port"" scalar to ""ports"" array"	" and then removes the	""varnish_"" prefixes on related variables that have been fixme for	a while.		bug: t119396	change-id: i9bd3cfdf9a0834f5ce1a1085c9b867349487bf2a	|"																																																																																																																																																																																																																																																																																																																																																																		
"install package varnish-modules on v4 hosts		install libvmod_xkey"	 provided by the varnish-modules package	" for	preliminary xkey testing on varnish 4 cache nodes.		note that libvmod_header is also part of varnish-modules. no need to	install it as a separate package any longer.		bug: t122881	change-id: iac357c301ecc75a001438724707d611b66728117	|apt_preferences for v3/v4 varnish packages		we are going to use 'experimental' as the apt component for varnish 4	and v4-compatible varnishkafka"	" and we want to make sure that on v3	machines v4 packages are not pulled in because of an apt-upgrade.		this patch installs two apt preferences fragments for varnish and	varnishkafka giving higher priority to v3 versions on hosts where the	varnish_version4 hiera attribute is not set. the fragments are removed	if varnish_version4 is set.		bug: t122880	change-id: iadc942017a6e7f3b4f956e30298bc58b29bb80a9	|"																																																																																																																																																																																																																																																																																																																																																																
"varnish: ability to remove a named instance		bug: t119396	change-id: i48102ab771202319a8b8622eb688bd1220bdf003	|"																																																																																																																																																																																																																																																																																																																																																																			
"support eqiad labs secondary disk		use the labs_lvm::volume class to mount varnish cache disk for labs	instances. mount it as xfs to solve bug 46359		bug: 46359	change-id: i52403cd1e32770d3c41c930dd6c836b0637e7a08	|"																																																																																																																																																																																																																																																																																																																																																																			
"zerofetch icinga check		generate an icinga alert if zerofetch has not been running successfully.	warn after 4 hours"	" critical after one day.		bug: t132835	change-id: ifa1b5605b5b6aba916ce1407438cc852bcecb82b	|fix minutes for zero cron		bugfix for 61643b83		change-id: ib266a008fbceeb1487e6b05b60cb69545beb132b	|zero_update: randomize cron every 15 minutes		previously the zero updater cron ran every 5 minutes per cache	node"	" on exact 5-minute clock boundaries.  with 12-16 hosts	running it"	 this never presented a huge problem	" but when we	attempted earlier this month to expand the set of cache hosts	running this script to ~60+ machines"	" it resulted in lots of login	failures due to throttling.  this is probably due to greatly	increased odds of several caches being partially-complete with the	two-phase login process in parallel.  hopefully by randomizing the	timing and spreading it over 15 minutes"	" the odds of several	parallel logins will be reduced to a reasonable level (worst case	we'll be averaging one login every 9 seconds or so"	" between all of	the involved cache clusters globally).		bug: t111045	change-id: i1443fb46596bff6855fc7b1cf1c2c124f76414d9	|"																																																																																																																																																																																																																																																																																																																																																												
"wdqs - move data to /srv		this is preliminary work to move blazegraph data to /srv. it removes the	management of wikidata.jnl symlink and creates the variables needed to	configure blazegraph data file location.		see also: https://gerrit.wikimedia.org/r/#/c/308003/		bug: t144536	bug: t144537	change-id: i67cf2d7e417d295f26a6470402fdea0631b7f47d	|move updater logs config to /etc/wdqs		change-id: ia2460828a04901b9f08d6343dae3ee7ec8ed26dc	bug: t139434	|prepare scap3 deployment for wdqs		bug: t129144	change-id: i590ad695be51753d2b10baef9a1c6255753fb80a	|"																																																																																																																																																																																																																																																																																																																																																																			
wdqs - fix icinga graphite check	" metric has been renamed		metrics published by varnish have been renamed. check needs to be updated.		bug: t138546	change-id: i58108005bd2145a4b09d78c4605424d63d430f62	|add response time checks to wdqs		raise a warning / critical alert if response time was over 2 minutes / 5	minutes more than 5% of the time during the last minute		bug: t119915	change-id: i08fa7dee2e21599756145b20fb89ebd8f2337e5d	|wdqs also use querystartcount counter		bug: t119178	change-id: if40438d278fbb9d7aad29a1b5639144d1d9b9071	|"																																																																																																																																																																																																																																																																																																																																																																		
"add icinga monitoring for wdqs services		bug: t103911	change-id: ifff8ed2009d159a2be0a69296dc46e9c692dad6b	|"																																																																																																																																																																																																																																																																																																																																																																			
"enable the wdqs service per default		no point in not having that.		bug: t116673	change-id: i6b82a5f0b057a77f7ff031d112d442e3af43a8fb	|"																																																																																																																																																																																																																																																																																																																																																																			
"make updater proper service		add dependency on blazegraph and data being loaded.		bug: t116754	change-id: i455434deaf21fc494d27c84ab09deebb71f9f939	|move updater logs config to /etc/wdqs		change-id: ia2460828a04901b9f08d6343dae3ee7ec8ed26dc	bug: t139434	|"																																																																																																																																																																																																																																																																																																																																																																			
"webperf: remove misleading references to ganglia		bug: 60193	change-id: i379d4a23217e20dd79334d95222ec7fcf0bac501	|asset-check: report to graphite rather than ganglia		ganglia was always a poor fit for this sort of metric data"	" but the graphite	setup on professor was moribund and i did not want to encumber it with	additional dependencies. but now that graphite is on tungsten"	" metric data	should be reported to graphite instead.		bug: 60193	change-id: i1b6771b807215840d54424dee24957962e16ebef	|"																																																																																																																																																																																																																																																																																																																																																																	
"add monitoring for statsv process		bug: t117994	change-id: i7d676c623b8a81b74cab796cc9ac1047748ed099	|"																																																																																																																																																																																																																																																																																																																																																																			
"navtiming: improve parse_ua and add unit tests		bug fixes:	* msie didn't match (matched underscore instead of space).	* ios_other broke metric (joined with dot instead of underscore).	* safari version was wrong (used arbitrary first digit of webkit build).	* opera version was wrong (uses ""version/"" as of opera 10+).	* mobile safari didn't match (matched ios webview) instead.	* firefox os sometimes matched as ie 11 (due to ""rv:11"").		new:	* add match for firefox mobile.		other:	* make browser version a sub metric of family.	* add unit tests.	* default to ""other"".		bug: t112594	change-id: iba24db816276a53bb68d82688007f3d002437dce	|"																																																																																																																																																																																																																																																																																																																																																																			
"apt: enable backports on debian systems		this enables backports across the fleet and relies on the default debian	policy for the apt priority for the repository (i.e.	notautomatic/butautomaticupgrades).		suffice to say"	 packages from jessie-backports should be used with care	"	as they may change to a newer version at any point.		bug: t107507	change-id: i8dceea1e42f33056133d3a1315bc32dd8b78dcb8	|"																																																																																																																																																																																																																																																																																																																																																																	
"update wikidatabuildresources git source (github -> gerrit)		bug: t111173	change-id: iff725deaa0d2d5c64d3a80ff6402e07a3ff71ee9	|wikidata builder		this registers a cron script that regularly builds the mediawiki wikidata	extension and submits the result to gerrit.		this is adapted from code that is:	author: addshore <addshorewiki@gmail.com>		bug: t90567	change-id: i1a326fd6fc5126465179b35e3bef42d7508397d8	|"																																																																																																																																																																																																																																																																																																																																																																			
"wikilabels: puppetize wikilabels infrastructure		 - add session class that uses memcached (for now)	 - add web class that sets up uwsgi and wsgi config	 - add hosts entry for wikilabels-database	 - add role for staging and deploy	 - set up roles to use the central postgres server		wikilabels code: https://github.com/wiki-ai/wikilabels	wikilabels config: https://github.com/wiki-ai/wikilabels-wikimedia-config	bug: t106218		change-id: i49ea516b0ee177f706be289a7b73be07995e73c7	|"																																																																																																																																																																																																																																																																																																																																																																			
"wikilabels: puppetize wikilabels infrastructure		 - add session class that uses memcached (for now)	 - add web class that sets up uwsgi and wsgi config	 - add hosts entry for wikilabels-database	 - add role for staging and deploy	 - set up roles to use the central postgres server		wikilabels code: https://github.com/wiki-ai/wikilabels	wikilabels config: https://github.com/wiki-ai/wikilabels-wikimedia-config	bug: t106218		change-id: i49ea516b0ee177f706be289a7b73be07995e73c7	|"																																																																																																																																																																																																																																																																																																																																																																			
"wikilabels: puppetize wikilabels infrastructure		 - add session class that uses memcached (for now)	 - add web class that sets up uwsgi and wsgi config	 - add hosts entry for wikilabels-database	 - add role for staging and deploy	 - set up roles to use the central postgres server		wikilabels code: https://github.com/wiki-ai/wikilabels	wikilabels config: https://github.com/wiki-ai/wikilabels-wikimedia-config	bug: t106218		change-id: i49ea516b0ee177f706be289a7b73be07995e73c7	|"																																																																																																																																																																																																																																																																																																																																																																			
"wikimania_scolarships: stop using webserver::php5		note that this is an almost exact replica except for the	lack of the sysctl stuff"	" which will be determined to be necessary	or not later on.		bug: t118786	change-id: ic11ef8d94f64d389174d544ecf626d6be4ef3f86	|wikimania scholarships: remove namevirtualhost file		there is no need for this to listen on 443 anymore"	" it is behind misc-web	and it only causes errors when applied on a host with apache 2.4 anyways	since there is no more ""conf.d"" directory.		bug:t105920	change-id: ia1819e013f126f0322065696128d59d16268f2fa	|wm scholarships: fix puppet fail"	" missing deploy dir		""error: cannot create /srv/deployment/scholarships/scholarships;	parent directory /srv/deployment/scholarships does not exist""		bug:t105920	change-id: id543177ac83dfe34be858a78168e256a62b7e62f	|wikimania_scholarships: don't manage open/close dates		open/close dates are now controlled in the database		bug: t92358	change-id: i38cc9f819990400f076e733b1f6a2e3fa8dc1c0a	|wikimania_scholarships: resource attributes quoting and minor lint		bug: t91908	change-id: i6fbabebb0eda9fd7c028dd9c42662c9dd402ca90	|update scholarships configuration for deploy		sean suggested using db1048.eqiad.wmnet instead of db1001.eqiad.wmnet	for the database. ellie set start/end dates for the 2014 application	cycle. security review is complete so vhost can be enabled.		this changeset requires new variables in the private repo:	* passwords::mysql::wikimania_scholarships::app_user	* passwords::mysql::wikimania_scholarships::app_password	see ibbd1bfd for related update in labs.		bug: 57870	change-id: i8064c49f42c46b9ef953480fb7838d2540a7fdd1	|add configuration for wikimania scholarships		add configuration for the wikimania scholarships application. this is	a stand-alone php application hosted in an apache vhost with code	deployed via trebuchet. data will be stored in the misc mysql shard. ssl	termination and caching will be provided by the misc varnish cluster.	logs will be forwarded to fluorine via the udp2log protocol.		needs dns update.		bug: 57870		change-id: ie568f268b1df21bd3bd6681436f6bac444f82132	|"																																																																																																																																																																																																																																																																																																																																																																
"wikimetrics: puppet module for wikimetrics		- deleted old submodule entry from .gitmodules	- added base.pp for new module"	" sets up user and config repo	- old role class is being replaced	- add web"	 queue	" and scheduler service classes		bug: t101763	change-id: ibe7d751b4a1a3b2339af55dcbfba2fb3cde10f0f	|"																																																																																																																																																																																																																																																																																																																																																																
"wikimetrics: puppet module for wikimetrics		- deleted old submodule entry from .gitmodules	- added base.pp for new module"	" sets up user and config repo	- old role class is being replaced	- add web"	 queue	" and scheduler service classes		bug: t101763	change-id: ibe7d751b4a1a3b2339af55dcbfba2fb3cde10f0f	|"																																																																																																																																																																																																																																																																																																																																																																
"wikimetrics: puppet module for wikimetrics		- deleted old submodule entry from .gitmodules	- added base.pp for new module"	" sets up user and config repo	- old role class is being replaced	- add web"	 queue	" and scheduler service classes		bug: t101763	change-id: ibe7d751b4a1a3b2339af55dcbfba2fb3cde10f0f	|"																																																																																																																																																																																																																																																																																																																																																																
"wikimetrics: puppet module for wikimetrics		- deleted old submodule entry from .gitmodules	- added base.pp for new module"	" sets up user and config repo	- old role class is being replaced	- add web"	 queue	" and scheduler service classes		bug: t101763	change-id: ibe7d751b4a1a3b2339af55dcbfba2fb3cde10f0f	|"																																																																																																																																																																																																																																																																																																																																																																
"wikimetrics: puppet module for wikimetrics		- deleted old submodule entry from .gitmodules	- added base.pp for new module"	" sets up user and config repo	- old role class is being replaced	- add web"	 queue	" and scheduler service classes		bug: t101763	change-id: ibe7d751b4a1a3b2339af55dcbfba2fb3cde10f0f	|"																																																																																																																																																																																																																																																																																																																																																																
"wikistats: lint		bug: t91908	change-id: i6c453fcbefad930f2a0e0455469c51a6d0a58f70	|"																																																																																																																																																																																																																																																																																																																																																																			
"wikistats: lint		bug: t91908	change-id: i6c453fcbefad930f2a0e0455469c51a6d0a58f70	|"																																																																																																																																																																																																																																																																																																																																																																			
"wikistats: lint		bug: t91908	change-id: i6c453fcbefad930f2a0e0455469c51a6d0a58f70	|"																																																																																																																																																																																																																																																																																																																																																																			
"wikistats: remove orain and pardus updates		pardus and orain wiki farms have both been discontinued.	remove the cron / updates.		bug:t136460	change-id: i4dc161d8ca8051d5569bc9b9b0a918652b7d12ca	|wikistats: add cronjob for miraheze updates		bug:t107398	change-id: i5c2b94f5ec565ab67ddc6791ecdbc4b14dd91dee	|wikistats: lint		bug: t91908	change-id: i6c453fcbefad930f2a0e0455469c51a6d0a58f70	|wikistats: add cron to enable wikia updates		bug: t61943	change-id: i26991a6dcec3c255b88a4eb5034621ab8900d176	|wikistats - add update cron for wikivoyage		bug: 44194	change-id: i296ab031883827d4e9457ae63c9b0602a831f94c	|add update cronjobs for wikisite/editthis		add update crons for those 2 big sites again	after they now have a delay added in	i905050a1463172f96f		bug: 59742	change-id: i0dac16e3807fd63412ada7dc209c6c7189afdd67	|wikistats-crons for updates of sourceforge"	" orain		bug: 70309	bug: 58396	change-id: icec9229670c891957424c2ae03f63ccac8704a55	|wikistats - add cron for gamepedia updates		bug: 60472	change-id: i1004ef532b754af42a5b26fb616e354d0503ab16	|wikistats - fix typo in cronjob name		it's called ""w3"" not ""wc"""	" or ""unkown table. exiting""		bug: 41023		change-id: if79dc02c0ca86016a66e421a74feca5facb69e52	|"																																																																																																																																																																																																																																																																																																																																																																	
"wikistats: doc fix to not refer to webserver::php5		bug: t118786	change-id: i332aab11cdf75481e9639287aadc4317ed24d957	|wikistats: lint		bug: t91908	change-id: i6c453fcbefad930f2a0e0455469c51a6d0a58f70	|"																																																																																																																																																																																																																																																																																																																																																																			
"xvfb: start service at boot time		base::service_unit does not install a systemd by default. one has to	pass 'enable => true' to the service stanza for puppet to trigger the	installation (via systemctl enable <service>).		will ensure xvfb is available"	" specially for nodepool instances that do	not run puppet on boot.		bug: t129345	change-id: i1057b02987279c109cf06b7177f6e9b25ac35fbf	|xvfb: systemd support for debian		bug: t95003	change-id: i2c521868b546f26b0c15b33c41c3b83dab9a78ad	|xvfb: switch to base::service_unit		xvfb is used on ubuntu ci slaves which rely on upstart to manage	service. we will need to use systemd for jessie hosts"	" a preliminary	task is to use base::service_unit to let us "																																																																																																																																																																																																																																																																																																																																																																	